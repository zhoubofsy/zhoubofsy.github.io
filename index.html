<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="博">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/26/blockchain/ethereum/erc20-openzeppelin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/26/blockchain/ethereum/erc20-openzeppelin/" class="post-title-link" itemprop="url">OpenZeppelin ERC-20 详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-26 11:08:25" itemprop="dateCreated datePublished" datetime="2024-11-26T11:08:25+08:00">2024-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-28 11:04:23" itemprop="dateModified" datetime="2024-11-28T11:04:23+08:00">2024-11-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是一段<code>openzeppelin</code>官方生成的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// Compatible with OpenZeppelin Contracts ^5.0.0</span><br><span class="line">pragma solidity ^0.8.22;</span><br><span class="line"></span><br><span class="line">import &#123;AccessManaged&#125; from &quot;@openzeppelin/contracts/access/manager/AccessManaged.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &#123;ERC20Pausable&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Pausable.sol&quot;;</span><br><span class="line">import &#123;ERC20Permit&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit &#123;</span><br><span class="line">    constructor(address initialAuthority)</span><br><span class="line">        ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">        AccessManaged(initialAuthority)</span><br><span class="line">        ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function pause() public restricted &#123;</span><br><span class="line">        _pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unpause() public restricted &#123;</span><br><span class="line">        _unpause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) public restricted &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The following functions are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _update(address from, address to, uint256 value)</span><br><span class="line">         internal</span><br><span class="line">         override(ERC20, ERC20Pausable)</span><br><span class="line">    &#123;</span><br><span class="line">         super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个名为<code>BobToken</code>的智能合约，它继承了多个标准接口和合约，用于创建一个可暂停、可授权管理、可使用EIP-2612标准的许可（Permit）功能的代币。下面是对代码的详细解释：</p>
<h3 id="继承的合约和接口"><a href="#继承的合约和接口" class="headerlink" title="继承的合约和接口"></a>继承的合约和接口</h3><ol>
<li><strong>ERC20</strong>: ERC20是一个标准接口，定义了代币的基本功能，如总供应量、余额查询、转账等。</li>
<li><strong>ERC20Pausable</strong>: 这个接口允许代币的转账操作被暂停，从而防止在特定情况下（如紧急情况）的代币转移。</li>
<li><strong>AccessManaged</strong>: 这个接口可能定义了访问控制功能，比如只有特定地址（如管理员）才能执行某些操作。</li>
<li><strong>ERC20Permit</strong>: 这个接口允许代币持有者通过签名授权来批准第三方转移代币，而不需要直接调用转账函数。</li>
</ol>
<h4 id="继承顺序"><a href="#继承顺序" class="headerlink" title="继承顺序"></a>继承顺序</h4><p>在Solidity中，合约的继承顺序是从左到右的，即最左边的合约是基类，最右边的合约是派生类。例如，在contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit {}中，BobToken继承了ERC20、ERC20Pausable、AccessManaged和ERC20Permit。</p>
<h4 id="继承原则"><a href="#继承原则" class="headerlink" title="继承原则"></a>继承原则</h4><ol>
<li><strong>从左到右的继承顺序</strong>：如上所述，继承顺序是从左到右的，这意味着基类在派生类之前被继承。</li>
<li><strong>构造函数的调用</strong>：在派生类的构造函数中，必须显式地调用所有基类的构造函数。调用顺序必须遵循继承顺序，即从左到右。</li>
<li><strong>函数覆盖</strong>：如果基类和派生类中有同名的函数，那么派生类的函数会覆盖基类的函数。在调用这些函数时，会优先调用派生类的函数。</li>
<li><strong>库的使用</strong>：如果合约继承了一个库，那么库的函数会被覆盖。这是因为库的函数是内部函数，不能被覆盖。</li>
</ol>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">constructor(address initialAuthority)</span><br><span class="line">    ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">    AccessManaged(initialAuthority)</span><br><span class="line">    ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>initialAuthority</code>: 初始化合约的管理权限地址。</li>
<li>构造函数中调用了多个基类的构造函数，传递了必要的参数，如代币名称、符号、初始权限地址等。ERC20、AccessManaged和ERC20Permit的构造函数被显式地调用，并且按照继承顺序从左到右调用。</li>
</ul>
<h3 id="主要函数"><a href="#主要函数" class="headerlink" title="主要函数"></a>主要函数</h3><ol>
<li><strong>pause()</strong>: 暂停代币的转账操作。只有通过<code>AccessManaged</code>接口授权的地址才能调用。</li>
<li><strong>unpause()</strong>: 恢复代币的转账操作。同样，只有授权的地址才能调用。</li>
<li><strong>mint(address to, uint256 amount)</strong>: 允许授权地址铸造新的代币，并将其发送给指定的地址。这通常用于代币发行。</li>
</ol>
<h3 id="内部函数"><a href="#内部函数" class="headerlink" title="内部函数"></a>内部函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _update(address from, address to, uint256 value)</span><br><span class="line">    internal</span><br><span class="line">    override(ERC20, ERC20Pausable)</span><br><span class="line">&#123;</span><br><span class="line">    super._update(from, to, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_update</code>函数是一个内部函数，用于更新代币的余额。它重写了<code>ERC20</code>和<code>ERC20Pausable</code>中的同名函数，并在内部调用了<code>super._update</code>，确保了在更新余额时考虑了暂停状态。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>访问控制</strong>: <code>AccessManaged</code>接口确保了只有授权的地址才能执行关键操作，如暂停、铸造等。</li>
<li><strong>暂停功能</strong>: <code>ERC20Pausable</code>接口提供了暂停和恢复转账操作的功能，这在处理紧急情况时非常有用。</li>
<li><strong>EIP-2612 Permit标准</strong>: 通过实现<code>ERC20Permit</code>接口，用户可以授权第三方代币转移，而无需直接调用转账函数，这提高了安全性。</li>
</ul>
<p>总的来说，这段代码实现了一个功能丰富的代币合约，结合了多种安全性和管理功能，适用于需要严格控制访问和操作的场景。接下来，我们按照继承顺序逐个来介绍一下。</p>
<h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.0.1) (utils/Context.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">abstract contract Context &#123;</span><br><span class="line">    function _msgSender() internal view virtual returns (address) &#123;</span><br><span class="line">        return msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _msgData() internal view virtual returns (bytes calldata) &#123;</span><br><span class="line">        return msg.data;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _contextSuffixLength() internal view virtual returns (uint256) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个名为<code>Context</code>的抽象合约。这个合约主要用于提供关于当前执行上下文的信息，包括交易的发送者和数据。在处理元交易（meta-transactions）时，发送和支付执行费用的账户可能不是实际的应用程序发送者。</p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong><code>_msgSender()</code>函数</strong>：这个函数返回当前交易的发送者地址。在大多数情况下，这可以通过<code>msg.sender</code>直接获取，但在处理元交易时，这个值可能不是实际的发送者。因此，这个函数提供了一个抽象层，允许子合约重写它以提供正确的发送者地址。</p>
</li>
<li><p><strong><code>_msgData()</code>函数</strong>：这个函数返回当前交易的输入数据。同样，在大多数情况下，这可以通过<code>msg.data</code>直接获取，但在处理元交易时，这个值可能不是实际的输入数据。因此，这个函数提供了一个抽象层，允许子合约重写它以提供正确的输入数据。</p>
</li>
<li><p><strong><code>_contextSuffixLength()</code>函数</strong>：这个函数返回一个长度值，表示上下文后缀的长度。这个函数在处理元交易时可能有用，但在这个合约中默认返回0，表示没有上下文后缀。</p>
</li>
</ol>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p><code>Context</code>合约的主要用途是为那些需要访问当前执行上下文信息的合约提供基础。例如，如果一个合约需要知道是谁发送了交易，或者交易中包含了哪些数据，它可以继承<code>Context</code>合约并使用<code>_msgSender()</code>和<code>_msgData()</code>函数。</p>
<h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>继承</strong>：任何需要使用<code>Context</code>合约功能的合约都应该继承它。如果子合约需要提供不同的发送者或数据，它应该重写<code>_msgSender()</code>和<code>_msgData()</code>函数。</li>
<li><strong>元交易</strong>：处理元交易时，发送和支付执行费用的账户可能不是实际的发送者。因此，任何依赖于<code>msg.sender</code>或<code>msg.data</code>的合约都需要能够处理这种情况。</li>
<li><strong>安全性</strong>：在重写<code>_msgSender()</code>和<code>_msgData()</code>函数时，需要确保提供的信息是安全的，以防止潜在的安全漏洞。</li>
</ul>
<h1 id="ERC20"><a href="#ERC20" class="headerlink" title="ERC20"></a>ERC20</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/ERC20.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IERC20&#125; from &quot;./IERC20.sol&quot;;</span><br><span class="line">import &#123;IERC20Metadata&#125; from &quot;./extensions/IERC20Metadata.sol&quot;;</span><br><span class="line">import &#123;Context&#125; from &quot;../../utils/Context.sol&quot;;</span><br><span class="line">import &#123;IERC20Errors&#125; from &quot;../../interfaces/draft-IERC6093.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract ERC20 is Context, IERC20, IERC20Metadata, IERC20Errors &#123;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>定义了一个名为 ERC20 的抽象合约，它继承了四个接口：Context、IERC20、IERC20Metadata 和 IERC20Errors。</p>
<ol>
<li>abstract contract ERC20</li>
</ol>
<ul>
<li>abstract contract 表示这是一个抽象合约，不能直接实例化。它通常用于定义接口和共享逻辑，其他合约可以继承它。</li>
<li>ERC20 是合约的名称。</li>
</ul>
<ol start="2">
<li>is Context, IERC20, IERC20Metadata, IERC20Errors</li>
</ol>
<ul>
<li>Context 是一个包含上下文相关函数（如 msg.sender）的接口，通常用于简化合约编写。</li>
<li>IERC20 是 ERC20 标准的接口，定义了 ERC20 代币的基本功能，如 totalSupply、balanceOf、transfer 等。</li>
<li>IERC20Metadata 是 ERC20 标准的扩展接口，定义了代币的元数据，如 name、symbol 和 decimals。</li>
<li>IERC20Errors 是一个自定义的接口，通常用于定义合约中可能出现的错误，如 TransferFailedError、InsufficientBalanceError 等。</li>
</ul>
<h3 id="合约成员"><a href="#合约成员" class="headerlink" title="合约成员"></a>合约成员</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mapping(address account =&gt; uint256) private _balances;</span><br><span class="line"></span><br><span class="line">mapping(address account =&gt; mapping(address spender =&gt; uint256)) private _allowances;</span><br><span class="line"></span><br><span class="line">uint256 private _totalSupply;</span><br><span class="line"></span><br><span class="line">string private _name;</span><br><span class="line">string private _symbol;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>_balances</strong>:</p>
<ul>
<li>这是一个映射（mapping），用于存储每个账户的代币余额。</li>
<li><code>address account</code> 是账户地址，<code>uint256</code> 是该地址对应的代币数量。</li>
<li><code>private</code> 关键字表示这个映射只能在合约内部访问，外部无法直接访问。</li>
<li>这个映射用于跟踪每个账户的代币余额。</li>
</ul>
</li>
<li><p><strong>_allowances</strong>:</p>
<ul>
<li>这是一个嵌套的映射，用于存储每个账户授权给其他账户的代币数量。</li>
<li><code>address account</code> 是账户地址，<code>mapping(address spender =&gt; uint256)</code> 是一个映射，表示该账户授权给其他账户的代币数量。</li>
<li><code>address spender</code> 是被授权的账户地址，<code>uint256</code> 是被授权的代币数量。</li>
<li><code>private</code> 关键字表示这个映射只能在合约内部访问，外部无法直接访问。</li>
<li>这个映射用于跟踪每个账户授权给其他账户的代币数量，通常用于实现代币的转账授权功能。<br>  -</li>
</ul>
</li>
<li><p><strong>_totalSupply</strong>:</p>
<ul>
<li>这是一个无符号整数（uint256），用于存储代币的总供应量。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于跟踪代币的总供应量。<br>  -</li>
</ul>
</li>
<li><p><strong>_name</strong>:</p>
<ul>
<li>这是一个字符串变量，用于存储代币的名称。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于存储代币的名称，例如 “MyToken”。</li>
</ul>
</li>
<li><p><strong>_symbol</strong>:</p>
<ul>
<li>这是一个字符串变量，用于存储代币的符号。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于存储代币的符号，例如 “MTK”。</li>
</ul>
</li>
</ol>
<h3 id="transfer-transferFrom"><a href="#transfer-transferFrom" class="headerlink" title="transfer &amp; transferFrom"></a>transfer &amp; transferFrom</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">function transfer(address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address owner = _msgSender();</span><br><span class="line">    _transfer(owner, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address spender = _msgSender();</span><br><span class="line">    _spendAllowance(from, spender, value);</span><br><span class="line">    _transfer(from, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _transfer(address from, address to, uint256 value) internal &#123;</span><br><span class="line">    if (from == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    if (to == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidReceiver(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(from, to, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _update(address from, address to, uint256 value) internal virtual &#123;</span><br><span class="line">    if (from == address(0)) &#123;</span><br><span class="line">        // Overflow check required: The rest of the code assumes that totalSupply never overflows</span><br><span class="line">        _totalSupply += value;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        uint256 fromBalance = _balances[from];</span><br><span class="line">        if (fromBalance &lt; value) &#123;</span><br><span class="line">            revert ERC20InsufficientBalance(from, fromBalance, value);</span><br><span class="line">        &#125;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: value &lt;= fromBalance &lt;= totalSupply.</span><br><span class="line">            _balances[from] = fromBalance - value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (to == address(0)) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: value &lt;= totalSupply or value &lt;= fromBalance &lt;= totalSupply.</span><br><span class="line">            _totalSupply -= value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: balance + value is at most totalSupply, which we know fits into a uint256.</span><br><span class="line">            _balances[to] += value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    emit Transfer(from, to, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>所有的转让动作最终都由<code>_transfer</code>方法来完成。</li>
<li><code>_transfer</code>方法中统一判断地址的有效性，使用<code>revert</code>比<code>require</code>更节省gas。</li>
<li><code>ERC20InvalidSender</code>和<code>ERC20InvalidReceiver</code>都来自<code>IERC20Errors</code>接口。</li>
</ul>
<p><strong>_update</strong></p>
<p><code>_update</code> 为内部虚函数，用于更新代币合约中的余额和总供应量。它主要用于处理代币的转移操作，确保在转移过程中不会发生溢出或不足的情况。</p>
<ol>
<li><p><strong>参数说明</strong>：</p>
<ul>
<li><code>from</code>：代币的发送者地址。</li>
<li><code>to</code>：代币的接收者地址。</li>
<li><code>value</code>：转移的代币数量。</li>
</ul>
</li>
<li><p><strong>更新总供应量</strong>：</p>
<ul>
<li>如果 <code>from</code> 是 <code>address(0)</code>，表示这是一个铸造操作（minting），那么 <code>_totalSupply</code> 将增加 <code>value</code>。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _mint(address account, uint256 value) internal &#123;</span><br><span class="line">    if (account == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidReceiver(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(address(0), account, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果 <code>from</code> 不是 <code>address(0)</code>，表示这是一个转移操作（transfer），那么首先检查 <code>from</code> 的余额是否足够，如果足够，则从 <code>from</code> 的余额中减去 <code>value</code>。</li>
</ul>
</li>
<li><p><strong>更新接收者的余额</strong>：</p>
<ul>
<li>如果 <code>to</code> 是 <code>address(0)</code>，表示这是一个销毁操作（burning），那么 <code>_totalSupply</code> 将减少 <code>value</code>。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _burn(address account, uint256 value) internal &#123;</span><br><span class="line">    if (account == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(account, address(0), value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果 <code>to</code> 不是 <code>address(0)</code>，表示这是一个转移操作，那么将 <code>value</code> 加到 <code>to</code> 的余额中。</li>
</ul>
</li>
<li><p><strong>防止溢出</strong>：</p>
<ul>
<li>使用 <code>unchecked</code> 关键字来处理可能的溢出情况，因为代码逻辑已经确保了不会发生溢出。</li>
<li>使用 <code>unchecked</code> 可以节省gas</li>
</ul>
</li>
<li><p><strong>触发事件</strong>：</p>
<ul>
<li>最后，通过 <code>emit Transfer(from, to, value);</code> 触发一个 <code>Transfer</code> 事件，记录这次转移操作。</li>
</ul>
</li>
</ol>
<h3 id="approve"><a href="#approve" class="headerlink" title="approve"></a>approve</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address spender = _msgSender();</span><br><span class="line">    _spendAllowance(from, spender, value);</span><br><span class="line">    _transfer(from, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _approve(address owner, address spender, uint256 value) internal &#123;</span><br><span class="line">    _approve(owner, spender, value, true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _approve(address owner, address spender, uint256 value, bool emitEvent) internal virtual &#123;</span><br><span class="line">    if (owner == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidApprover(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    if (spender == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSpender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _allowances[owner][spender] = value;</span><br><span class="line">    if (emitEvent) &#123;</span><br><span class="line">        emit Approval(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _spendAllowance(address owner, address spender, uint256 value) internal virtual &#123;</span><br><span class="line">    uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">    if (currentAllowance != type(uint256).max) &#123;</span><br><span class="line">        if (currentAllowance &lt; value) &#123;</span><br><span class="line">            revert ERC20InsufficientAllowance(spender, currentAllowance, value);</span><br><span class="line">        &#125;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _approve(owner, spender, currentAllowance - value, false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>_approve</code>函数</strong></p>
<p><code>_approve</code>函数用于更新一个账户对另一个账户的授权额度。如果<code>emitEvent</code>参数为<code>true</code>，还会触发一个<code>Approval</code>事件。</p>
<pre><code>- `owner`：授权额度所有者的地址。
- `spender`：被授权的账户地址。
- `value`：授权的额度。
- `emitEvent`：一个布尔值，决定是否触发`Approval`事件。
</code></pre>
<p><strong>流程</strong></p>
<ol>
<li>首先检查<code>owner</code>和<code>spender</code>是否为<code>address(0)</code>，如果是，则抛出异常<code>ERC20InvalidApprover</code>或<code>ERC20InvalidSpender</code>。</li>
<li>更新<code>_allowances</code>映射，将<code>owner</code>对<code>spender</code>的授权额度设置为<code>value</code>。</li>
<li>如果<code>emitEvent</code>为<code>true</code>，则触发<code>Approval</code>事件。</li>
</ol>
<p><strong><code>_spendAllowance</code>函数</strong></p>
<p><code>_spendAllowance</code>函数用于消耗<code>owner</code>对<code>spender</code>的授权额度。它不会更新授权额度，除非授权额度是有限的。如果授权额度不足，则会抛出异常。</p>
<pre><code>- `owner`：授权额度所有者的地址。
- `spender`：被授权的账户地址。
- `value`：要消费的额度。
</code></pre>
<p><strong>流程</strong></p>
<ol>
<li>获取<code>owner</code>对<code>spender</code>的当前授权额度。</li>
<li>如果当前授权额度不是无限（即不等于<code>type(uint256).max</code>），则检查当前授权额度是否足够消费<code>value</code>。</li>
<li>如果足够，则更新<code>owner</code>对<code>spender</code>的授权额度，减去<code>value</code>，并触发<code>Approval</code>事件（如果<code>emitEvent</code>为<code>true</code>）。</li>
</ol>
<h3 id="decimals"><a href="#decimals" class="headerlink" title="decimals"></a>decimals</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function decimals() public view virtual returns (uint8) &#123;</span><br><span class="line">    return 18;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认值是18， 如果想改变，只能重写<code>decimals()</code>这个方法。这种方法直接返回固定值的相比于使用成员变量存储的方式更省gas。</p>
<h1 id="ERC20Pausable"><a href="#ERC20Pausable" class="headerlink" title="ERC20Pausable"></a>ERC20Pausable</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/extensions/ERC20Pausable.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;ERC20&#125; from &quot;../ERC20.sol&quot;;</span><br><span class="line">import &#123;Pausable&#125; from &quot;../../../utils/Pausable.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract ERC20Pausable is ERC20, Pausable &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;ERC20-_update&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - the contract must not be paused.</span><br><span class="line">    */</span><br><span class="line">    function _update(address from, address to, uint256 value) internal virtual override whenNotPaused &#123;</span><br><span class="line">        super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC20Pausable</code> 是个抽象合约，它继承了 <code>ERC20</code> 和 <code>Pausable</code> 两个合约。<code>ERC20</code> 是一个标准的代币合约接口，而 <code>Pausable</code> 是一个用于暂停合约操作的合约。</p>
<h3 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong>继承关系</strong>：<code>ERC20Pausable</code> 继承了 <code>ERC20</code> 和 <code>Pausable</code> 合约，这意味着它继承了 <code>ERC20</code> 的所有功能（如代币的创建、转移、余额查询等）以及 <code>Pausable</code> 的功能（如暂停和恢复合约操作）。</p>
</li>
<li><p><strong>抽象合约</strong>：<code>ERC20Pausable</code> 是一个抽象合约，因为它包含了一个未实现的函数 <code>_update</code>。</p>
</li>
<li><p><strong>函数重写</strong>：<code>_update</code> 函数重写了 <code>ERC20</code> 合约中的 <code>_update</code> 函数。这个函数在执行代币转移操作之前，会检查合约是否处于暂停状态。如果合约处于暂停状态，则不允许执行转移操作。</p>
</li>
<li><p><strong><code>whenNotPaused</code> 修饰器</strong>：<code>whenNotPaused</code> 是 <code>Pausable</code> 合约中的一个修饰器，用于确保在调用被修饰的函数时，合约不是暂停状态。如果合约是暂停状态，调用将被 revert（回滚）。</p>
</li>
</ol>
<h3 id="用途-1"><a href="#用途-1" class="headerlink" title="用途"></a>用途</h3><p><code>ERC20Pausable</code> 合约的主要用途是提供一个可暂停的代币合约，允许合约所有者或管理员在紧急情况下暂停代币的转移操作，以防止潜在的滥用或攻击。</p>
<h3 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><p><strong>实现 <code>_update</code> 函数</strong>：任何继承 <code>ERC20Pausable</code> 的合约都必须实现 <code>_update</code> 函数，以确保在执行代币转移操作时能够正确地检查合约是否处于暂停状态。</p>
</li>
<li><p><strong>合约暂停</strong>：合约暂停后，所有与代币转移相关的操作都将被阻止，直到合约被恢复。因此，合约所有者或管理员在暂停合约时应谨慎操作，以避免造成不必要的损失。</p>
</li>
<li><p><strong>安全性</strong>：虽然 <code>ERC20Pausable</code> 合约提供了一种暂停合约的方法，但它并不能防止所有潜在的安全问题。开发者仍需确保合约的其他部分（如访问控制、逻辑错误等）是安全的。</p>
</li>
</ol>
<h1 id="AccessManaged"><a href="#AccessManaged" class="headerlink" title="AccessManaged"></a>AccessManaged</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (access/manager/AccessManaged.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IAuthority&#125; from &quot;./IAuthority.sol&quot;;</span><br><span class="line">import &#123;AuthorityUtils&#125; from &quot;./AuthorityUtils.sol&quot;;</span><br><span class="line">import &#123;IAccessManager&#125; from &quot;./IAccessManager.sol&quot;;</span><br><span class="line">import &#123;IAccessManaged&#125; from &quot;./IAccessManaged.sol&quot;;</span><br><span class="line">import &#123;Context&#125; from &quot;../../utils/Context.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract AccessManaged is Context, IAccessManaged &#123;</span><br><span class="line">    address private _authority;</span><br><span class="line"></span><br><span class="line">    bool private _consumingSchedule;</span><br><span class="line">    constructor(address initialAuthority) &#123;</span><br><span class="line">        _setAuthority(initialAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier restricted() &#123;</span><br><span class="line">        _checkCanCall(_msgSender(), _msgData());</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function authority() public view virtual returns (address) &#123;</span><br><span class="line">        return _authority;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function setAuthority(address newAuthority) public virtual &#123;</span><br><span class="line">        address caller = _msgSender();</span><br><span class="line">        if (caller != authority()) &#123;</span><br><span class="line">            revert AccessManagedUnauthorized(caller);</span><br><span class="line">        &#125;</span><br><span class="line">        if (newAuthority.code.length == 0) &#123;</span><br><span class="line">            revert AccessManagedInvalidAuthority(newAuthority);</span><br><span class="line">        &#125;</span><br><span class="line">        _setAuthority(newAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function isConsumingScheduledOp() public view returns (bytes4) &#123;</span><br><span class="line">        return _consumingSchedule ? this.isConsumingScheduledOp.selector : bytes4(0);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _setAuthority(address newAuthority) internal virtual &#123;</span><br><span class="line">        _authority = newAuthority;</span><br><span class="line">        emit AuthorityUpdated(newAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _checkCanCall(address caller, bytes calldata data) internal virtual &#123;</span><br><span class="line">        (bool immediate, uint32 delay) = AuthorityUtils.canCallWithDelay(</span><br><span class="line">            authority(),</span><br><span class="line">            caller,</span><br><span class="line">            address(this),</span><br><span class="line">            bytes4(data[0:4])</span><br><span class="line">        );</span><br><span class="line">        if (!immediate) &#123;</span><br><span class="line">            if (delay &gt; 0) &#123;</span><br><span class="line">                _consumingSchedule = true;</span><br><span class="line">                IAccessManager(authority()).consumeScheduledOp(caller, data);</span><br><span class="line">                _consumingSchedule = false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                revert AccessManagedUnauthorized(caller);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AccessManaged</code> 是个抽象合约，它继承了 <code>Context</code> 和 <code>IAccessManaged</code> 接口。这个合约的主要目的是管理合约的访问权限，确保只有授权的地址才能调用特定的函数。下面是对代码的详细解释：</p>
<h3 id="合约结构"><a href="#合约结构" class="headerlink" title="合约结构"></a>合约结构</h3><ol>
<li><p><strong>状态变量</strong>：</p>
<ul>
<li><code>_authority</code>：存储当前合约的授权地址。</li>
<li><code>_consumingSchedule</code>：一个布尔值，用于指示是否正在执行预定的操作。</li>
</ul>
</li>
<li><p><strong>构造函数</strong>：</p>
<ul>
<li><code>constructor(address initialAuthority)</code>：初始化合约，设置初始的授权地址。</li>
</ul>
</li>
<li><p><strong>修饰器</strong>：</p>
<ul>
<li><code>modifier restricted()</code>：限制函数的访问，确保只有授权的地址才能调用。这个修饰器通过调用 <code>_checkCanCall</code> 函数来检查调用者是否有权限。</li>
</ul>
</li>
<li><p><strong>接口实现</strong>：</p>
<ul>
<li><code>function authority() public view virtual returns (address)</code>：返回当前的授权地址。</li>
<li><code>function setAuthority(address newAuthority) public virtual</code>：设置新的授权地址。只有当前的授权地址才能调用这个函数。</li>
<li><code>function isConsumingScheduledOp() public view returns (bytes4)</code>：检查合约是否正在执行预定的操作。</li>
</ul>
</li>
<li><p><strong>内部函数</strong>：</p>
<ul>
<li><code>function _setAuthority(address newAuthority) internal virtual</code>：设置新的授权地址。这个函数没有访问限制，允许直接设置新的授权地址。</li>
<li><code>function _checkCanCall(address caller, bytes calldata data) internal virtual</code>：检查调用者是否有权限调用当前函数。如果调用者没有权限，则抛出异常。</li>
</ul>
</li>
</ol>
<h3 id="实现原理-2"><a href="#实现原理-2" class="headerlink" title="实现原理"></a>实现原理</h3><ul>
<li><strong>权限管理</strong>：通过 <code>_authority</code> 状态变量和 <code>restricted</code> 修饰器实现。只有 <code>_authority</code> 指定的地址才能调用被 <code>restricted</code> 修饰的函数。</li>
<li><strong>授权地址的设置</strong>：通过 <code>setAuthority</code> 函数设置新的授权地址，只有当前的授权地址才能调用这个函数。</li>
<li><strong>预定操作</strong>：通过 <code>_consumingSchedule</code> 和 <code>isConsumingScheduledOp</code> 函数管理预定的操作。如果合约正在执行预定的操作，<code>isConsumingScheduledOp</code> 函数会返回一个特定的函数选择器。</li>
</ul>
<h3 id="用途-2"><a href="#用途-2" class="headerlink" title="用途"></a>用途</h3><p>这个合约的主要用途是提供一个框架，用于管理合约的访问权限。通过设置授权地址，可以确保只有授权的地址才能调用合约的特定函数。这对于需要严格控制访问权限的合约非常有用，例如智能合约钱包或权限管理合约。</p>
<h3 id="注意事项-3"><a href="#注意事项-3" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>安全性</strong>：在实现权限管理时，需要特别注意不要在 <code>receive()</code> 或 <code>fallback()</code> 函数上使用 <code>restricted</code> 修饰器，因为这些函数的调用方式可能导致权限检查失败。</li>
<li><strong>权限转移</strong>：通过 <code>setAuthority</code> 函数可以转移合约的权限，但只有当前的授权地址才能执行这个操作，这确保了权限的转移是可控的。</li>
<li><strong>预定操作</strong>：通过 <code>isConsumingScheduledOp</code> 函数可以检查合约是否正在执行预定的操作，这对于需要同步执行多个操作的合约非常有用。</li>
</ul>
<h1 id="ERC20Permit"><a href="#ERC20Permit" class="headerlink" title="ERC20Permit"></a>ERC20Permit</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/extensions/ERC20Permit.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IERC20Permit&#125; from &quot;./IERC20Permit.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;../ERC20.sol&quot;;</span><br><span class="line">import &#123;ECDSA&#125; from &quot;../../../utils/cryptography/ECDSA.sol&quot;;</span><br><span class="line">import &#123;EIP712&#125; from &quot;../../../utils/cryptography/EIP712.sol&quot;;</span><br><span class="line">import &#123;Nonces&#125; from &quot;../../../utils/Nonces.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> @dev Implementation of the ERC-20 Permit extension allowing approvals to be made via signatures, as defined in</span><br><span class="line"> * https://eips.ethereum.org/EIPS/eip-2612[ERC-2612].</span><br><span class="line"> *</span><br><span class="line"> * Adds the &#123;permit&#125; method, which can be used to change an account&#x27;s ERC-20 allowance (see &#123;IERC20-allowance&#125;) by</span><br><span class="line"> * presenting a message signed by the account. By not relying on `&#123;IERC20-approve&#125;`, the token holder account doesn&#x27;t</span><br><span class="line"> * need to send a transaction, and thus is not required to hold Ether at all.</span><br><span class="line"> */</span><br><span class="line">abstract contract ERC20Permit is ERC20, IERC20Permit, EIP712, Nonces &#123;</span><br><span class="line">    bytes32 private constant PERMIT_TYPEHASH =</span><br><span class="line">    keccak256(&quot;Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Permit deadline has expired.</span><br><span class="line">     */</span><br><span class="line">    error ERC2612ExpiredSignature(uint256 deadline);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Mismatched signature.</span><br><span class="line">     */</span><br><span class="line">    error ERC2612InvalidSigner(address signer, address owner);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Initializes the &#123;EIP712&#125; domain separator using the `name` parameter, and setting `version` to `&quot;1&quot;`.</span><br><span class="line">     *</span><br><span class="line">     * It&#x27;s a good idea to use the same `name` that is defined as the ERC-20 token name.</span><br><span class="line">     */</span><br><span class="line">    constructor(string memory name) EIP712(name, &quot;1&quot;) &#123;&#125;</span><br><span class="line">       </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    function permit(</span><br><span class="line">        address owner,</span><br><span class="line">        address spender,</span><br><span class="line">        uint256 value,</span><br><span class="line">        uint256 deadline,</span><br><span class="line">        uint8 v,</span><br><span class="line">        bytes32 r,</span><br><span class="line">        bytes32 s</span><br><span class="line">    ) public virtual &#123;</span><br><span class="line">        if (block.timestamp &gt; deadline) &#123;</span><br><span class="line">            revert ERC2612ExpiredSignature(deadline);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         bytes32 structHash = keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, _useNonce(owner), deadline));</span><br><span class="line"> </span><br><span class="line">         bytes32 hash = _hashTypedDataV4(structHash);</span><br><span class="line"> </span><br><span class="line">         address signer = ECDSA.recover(hash, v, r, s);</span><br><span class="line">         if (signer != owner) &#123;</span><br><span class="line">             revert ERC2612InvalidSigner(signer, owner);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         _approve(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    function nonces(address owner) public view virtual override(IERC20Permit, Nonces) returns (uint256) &#123;</span><br><span class="line">        return super.nonces(owner);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    // solhint-disable-next-line func-name-mixedcase</span><br><span class="line">    function DOMAIN_SEPARATOR() external view virtual returns (bytes32) &#123;</span><br><span class="line">        return _domainSeparatorV4();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC20Permit</code> 是一个抽象合约，它结合了 ERC-20 标准和 ERC-2612 标准的功能。ERC-2612 标准允许使用签名来批准代币转移，而无需直接调用 <code>approve</code> 函数。下面是对代码的详细解释：</p>
<h3 id="实现原理-3"><a href="#实现原理-3" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong>继承关系</strong>：</p>
<ul>
<li><code>ERC20Permit</code> 继承了 <code>ERC20</code>、<code>IERC20Permit</code>、<code>EIP712</code> 和 <code>Nonces</code> 四个合约。</li>
<li><code>ERC20</code> 实现了 ERC-20 标准的代币功能。</li>
<li><code>IERC20Permit</code> 定义了 ERC-2612 标准的接口。</li>
<li><code>EIP712</code> 用于生成和验证 EIP-712 签名。</li>
<li><code>Nonces</code> 用于管理每个账户的签名计数器。</li>
</ul>
</li>
<li><p><strong>常量</strong>：</p>
<ul>
<li><code>PERMIT_TYPEHASH</code> 是一个哈希值，用于在 EIP-712 签名中标识 <code>Permit</code> 结构。</li>
</ul>
</li>
<li><p><strong>错误</strong>：</p>
<ul>
<li><code>ERC2612ExpiredSignature</code>：当签名过期时抛出。</li>
<li><code>ERC2612InvalidSigner</code>：当签名者与账户不匹配时抛出。</li>
</ul>
</li>
<li><p><strong>构造函数</strong>：</p>
<ul>
<li>初始化 <code>EIP712</code> 的域分隔符，使用传入的 <code>name</code> 参数，并设置版本号为 <code>&quot;1&quot;</code>。</li>
</ul>
</li>
<li><p><strong>permit 函数</strong>：</p>
<ul>
<li>验证签名是否过期。</li>
<li>生成 <code>Permit</code> 结构的哈希值。</li>
<li>使用 EIP-712 签名验证机制恢复签名者地址。</li>
<li>检查签名者是否与 <code>owner</code> 匹配。</li>
<li>调用 <code>_approve</code> 函数批准代币转移。</li>
</ul>
</li>
<li><p><strong>nonces 函数</strong>：</p>
<ul>
<li>返回指定账户的签名计数器值。</li>
</ul>
</li>
<li><p><strong>DOMAIN_SEPARATOR 函数</strong>：</p>
<ul>
<li>返回 EIP-712 的域分隔符。</li>
</ul>
</li>
</ol>
<h3 id="用途-3"><a href="#用途-3" class="headerlink" title="用途"></a>用途</h3><p><code>ERC20Permit</code> 合约允许用户通过签名来批准代币转移，而无需直接调用 <code>approve</code> 函数。这对于提高安全性（避免重放攻击）和用户体验（无需每次都手动批准）非常有用。</p>
<h3 id="注意事项-4"><a href="#注意事项-4" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><strong>安全性</strong>：确保正确实现 EIP-712 签名验证，以防止签名被滥用。</li>
<li><strong>时间戳</strong>：使用 <code>block.timestamp</code> 来检查签名是否过期，确保安全性。</li>
<li><strong>nonce</strong>：使用 <code>nonce</code> 来防止重放攻击，确保每个签名只被使用一次。</li>
<li><strong>兼容性</strong>：确保合约与所有相关接口和标准兼容，以避免潜在的问题。</li>
</ol>
<h3 id="ERC-2612标准"><a href="#ERC-2612标准" class="headerlink" title="ERC-2612标准"></a>ERC-2612标准</h3><p>ERC-2612 标准提供了一种安全、高效的方式来授权代币转移，是 ERC-20 标准的一个扩展。它允许代币持有者通过签名授权第三方转移代币，而不需要直接调用 <code>approve</code> 函数。这个标准基于 EIP-712，它提供了一种使用签名来验证和执行操作的方法。</p>
<h4 id="ERC-2612-标准的主要功能"><a href="#ERC-2612-标准的主要功能" class="headerlink" title="ERC-2612 标准的主要功能"></a>ERC-2612 标准的主要功能</h4><ol>
<li><p><strong>Permit 函数</strong>：允许代币持有者通过签名授权第三方转移代币。这个函数需要三个参数：<code>owner</code>（代币持有者的地址）、<code>spender</code>（被授权的地址）和 <code>value</code>（被授权的代币数量）。</p>
</li>
<li><p><strong>EIP-712 签名</strong>：使用 EIP-712 签名来验证 <code>Permit</code> 函数的调用。EIP-712 是一种用于生成和验证签名的标准，它允许在签名中包含额外的元数据，如链 ID 和域分隔符。</p>
</li>
<li><p><strong>Nonce</strong>：每个账户都有一个关联的 <code>nonce</code> 值，用于防止重放攻击。在 <code>Permit</code> 函数中，<code>nonce</code> 值会自动增加，确保每个签名只被使用一次。</p>
</li>
</ol>
<h4 id="ERC-2612-标准的实现"><a href="#ERC-2612-标准的实现" class="headerlink" title="ERC-2612 标准的实现"></a>ERC-2612 标准的实现</h4><p>要实现 ERC-2612 标准，代币合约需要包含以下部分：</p>
<ol>
<li><p><strong>Permit 函数</strong>：实现 <code>Permit</code> 函数，用于处理签名授权。</p>
</li>
<li><p><strong>EIP-712 签名</strong>：实现 EIP-712 签名生成和验证机制。</p>
</li>
<li><p><strong>Nonce</strong>：管理每个账户的 <code>nonce</code> 值。</p>
</li>
<li><p><strong>DOMAIN_SEPARATOR</strong>：生成 EIP-712 签名的域分隔符。</p>
</li>
</ol>
<h4 id="ERC-2612-标准的用途"><a href="#ERC-2612-标准的用途" class="headerlink" title="ERC-2612 标准的用途"></a>ERC-2612 标准的用途</h4><p>ERC-2612 标准的主要用途是提高代币的安全性。通过使用签名来授权代币转移，可以防止重放攻击，并简化用户界面。此外，它还可以提高交易效率，因为用户不需要每次都手动批准代币转移。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/25/blockchain/ethereum/erc-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/25/blockchain/ethereum/erc-20/" class="post-title-link" itemprop="url">ERC-20</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-25 10:32:32 / Modified: 10:55:47" itemprop="dateCreated datePublished" datetime="2024-11-25T10:32:32+08:00">2024-11-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是-ERC-20？"><a href="#什么是-ERC-20？" class="headerlink" title="什么是 ERC-20？"></a>什么是 ERC-20？</h1><p>ERC-20 提出了一个同质化代币的标准，换句话说，它们具有一种属性，使得每个代币都与另一个代币（在类型和价值上）完全相同。 例如，一个 ERC-20 代币就像以太币一样，意味着一个代币会并永远会与其他代币一样。(From: 《<a target="_blank" rel="noopener" href="https://ethereum.org/zh/developers/docs/standards/tokens/erc-20/">ERC-20 代币标准</a>》)</p>
<h2 id="方法（Method）"><a href="#方法（Method）" class="headerlink" title="方法（Method）"></a>方法（Method）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function name() public view returns (string)</span><br><span class="line">// 返回令牌的名称 - 例如 &quot;MyToken&quot;</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function symbol() public view returns (string)</span><br><span class="line">// 返回令牌的 symbol。例如“HIX”。</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function decimals() public view returns (uint8)</span><br><span class="line">// 返回代币使用的小数位数 - 例如 8，表示将代币数量除以 100000000 以获得其用户表示。</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function totalSupply() public view returns (uint256)</span><br><span class="line">// 返回总代币供应量。</span><br><span class="line"></span><br><span class="line">function balanceOf(address _owner) public view returns (uint256 balance)</span><br><span class="line">// 返回地址为 _owner 的另一个账户的账户余额。</span><br><span class="line"></span><br><span class="line">function transfer(address _to, uint256 _value) public returns (bool success)</span><br><span class="line">// 将 _value 数量的代币转移到 _to，并且必须触发 Transfer 事件。如果消息调用者的账户余额没有足够的代币可供花费，则函数应该throw。</span><br><span class="line">// 注意值为 0 的传输必须被视为正常传输，并触发 Transfer 事件。</span><br><span class="line"></span><br><span class="line">function transferFrom(address _from, address _to, uint256 _value) public returns (bool success)</span><br><span class="line">// 将 _value数量的代币从地址 _from 转移到地址 _to，并且必须触发 Transfer 事件。</span><br><span class="line">// transferFrom 方法用于提现工作流程，允许合约代表您转移代币。例如，这可用于允许合约代表您转移代币和/或以子货币收取费用。除非 _from 账户通过某种机制故意授权了消息的发送者，否则该函数应该throw。</span><br><span class="line"></span><br><span class="line">function approve(address _spender, uint256 _value) public returns (bool success)</span><br><span class="line">// 允许_spender多次从您的账户提款，最高可达_value金额。如果再次调用此函数，它将用 _value 覆盖当前限额。</span><br><span class="line">// 注意：客户端应该确保在创建用户界面时，先将限额设置为 0，然后再为同一花费者将其设置为另一个值。尽管 Contract 本身不应该强制执行它，以允许向后兼容之前部署的 Contract</span><br><span class="line"></span><br><span class="line">function allowance(address _owner, address _spender) public view returns (uint256 remaining)</span><br><span class="line">// 返回 _spender 仍允许从 _owner 中提取的金额。</span><br></pre></td></tr></table></figure>

<h2 id="事件（Event）"><a href="#事件（Event）" class="headerlink" title="事件（Event）"></a>事件（Event）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">event Transfer(address indexed _from, address indexed _to, uint256 _value)</span><br><span class="line">// 必须在代币转移时触发，包括零价值转移。</span><br><span class="line">// 创建新代币的代币合约应该在创建代币时触发 Transfer 事件，并将 _from 地址设置为 0x0。</span><br><span class="line"></span><br><span class="line">event Approval(address indexed _owner, address indexed _spender, uint256 _value)</span><br><span class="line">// 必须在成功调用 approve(address _spender, uint256 _value) 时触发。</span><br></pre></td></tr></table></figure>

<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MyToken &#123;</span><br><span class="line">    string public constant name = &quot;Bob&#x27;s Token&quot;;</span><br><span class="line">    string public constant symbol = &quot;BBK&quot;;</span><br><span class="line">    uint8 public constant decimals = 18;</span><br><span class="line">    uint16 private constant increase = 1000;</span><br><span class="line">    uint256 public constant totalLimit = 27000000 * (10 ** decimals);</span><br><span class="line">    uint256 public totalSupply = 0;</span><br><span class="line">    address private owner;</span><br><span class="line">    mapping(address =&gt; uint256) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed _from, address indexed _to, uint256 _value);</span><br><span class="line">    event Approval(address indexed _owner, address indexed _spender, uint256 _value);</span><br><span class="line"></span><br><span class="line">    modifier checkAddress(address _addr) &#123;</span><br><span class="line">        require(address(_addr) != address(0), &quot;Invalid address.&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier checkBalanceOf(address _addr, uint256 _value) &#123;</span><br><span class="line">        require(balanceOf[_addr] &gt;= _value, &quot;Insufficient balance&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier checkOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Not owner.&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address _to) public checkOwner returns (uint256) &#123;</span><br><span class="line">        uint256 mintValue = increase * (10  ** decimals);</span><br><span class="line">        require(totalLimit &gt;= (totalSupply + mintValue), &quot;Out of limit.&quot;);</span><br><span class="line">        totalSupply += mintValue;</span><br><span class="line">        balanceOf[_to] += mintValue;</span><br><span class="line">        return balanceOf[_to];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public checkAddress(_to) checkBalanceOf(msg.sender, _value) returns (bool success)&#123;</span><br><span class="line">        balanceOf[msg.sender] -= _value;</span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line">        emit Transfer(msg.sender, _to, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address _from, address _to, uint256 _value) public checkAddress(_to) checkBalanceOf(_from, _value) returns (bool success) &#123;</span><br><span class="line">        require(allowance[_from][msg.sender] &gt;= _value, &quot;No enough approve value.&quot;);</span><br><span class="line">        allowance[_from][msg.sender] -= _value;</span><br><span class="line">        balanceOf[_from] -= _value;</span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line">        emit Transfer(_from, _to, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address _spender, uint256 _value) public returns (bool success)&#123;</span><br><span class="line">        allowance[msg.sender][_spender] = _value;</span><br><span class="line">        emit Approval(msg.sender, _spender, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong></p>
<ul>
<li>由于本合约的编译版本为0.8.0，此版本具备整数溢出检查，所以可以不使用safeMath。</li>
</ul>
<h2 id="快速示例"><a href="#快速示例" class="headerlink" title="快速示例"></a>快速示例</h2><p>使用<a target="_blank" rel="noopener" href="https://docs.openzeppelin.com/contracts/5.x/wizard">OpenZeppelin</a>快速创建ERC-20合约</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// Compatible with OpenZeppelin Contracts ^5.0.0</span><br><span class="line">pragma solidity ^0.8.22;</span><br><span class="line"></span><br><span class="line">import &#123;AccessManaged&#125; from &quot;@openzeppelin/contracts/access/manager/AccessManaged.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &#123;ERC20Pausable&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Pausable.sol&quot;;</span><br><span class="line">import &#123;ERC20Permit&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit &#123;</span><br><span class="line">    constructor(address initialAuthority)</span><br><span class="line">         ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">         AccessManaged(initialAuthority)</span><br><span class="line">         ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function pause() public restricted &#123;</span><br><span class="line">         _pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unpause() public restricted &#123;</span><br><span class="line">         _unpause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) public restricted &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The following functions are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _update(address from, address to, uint256 value)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Pausable)</span><br><span class="line">    &#123;</span><br><span class="line">        super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的合约通常通过<a target="_blank" rel="noopener" href="https://solidity.readthedocs.io/en/latest/contracts.html#inheritance">继承</a>来使用，在这里我们将 <code>ERC20</code> 重新用于基本标准实现以及 <code>name</code>、<code>symbol</code> 和 <code>decimals</code> 可选扩展。此外，我们正在创建一个代币的 <code>initialSupply</code>，该代币将被分配给部署合约的地址。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/21/blockchain/ethereum/usage-of-call-staticcall-delegatecall/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/21/blockchain/ethereum/usage-of-call-staticcall-delegatecall/" class="post-title-link" itemprop="url">call、staticcall、delegatecall使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-21 10:58:29" itemprop="dateCreated datePublished" datetime="2024-11-21T10:58:29+08:00">2024-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-25 12:05:10" itemprop="dateModified" datetime="2024-11-25T12:05:10+08:00">2024-11-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在 Solidity 中，<code>call</code>、<code>staticcall</code>和<code>delegatecall</code>是强大的低级操作，用于与其他合约交互或在当前上下文中执行外部合约的逻辑。掌握它们的用法和区别对于智能合约开发非常重要。</p>
<p>本文将详细介绍它们的功能、适用场景、代码示例，以及使用时需要注意的潜在问题。</p>
<h1 id="call"><a href="#call" class="headerlink" title="call"></a>call</h1><p><strong>功能</strong></p>
<p><code>call</code> 是一种通用方法，用于调用另一个合约的函数或发送 ETH。它可以调用目标合约的任意函数，包括不存在的函数（在这种情况下不会抛出错误）。</p>
<p><strong>特点</strong></p>
<ul>
<li>可读写目标合约的状态。</li>
<li>支持附带 ETH 发送。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>调用外部合约的任意函数。</li>
<li>向合约或外部账户发送 ETH。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CallExample &#123;</span><br><span class="line">    function callFunction(address target, uint256 value) external returns (bool, bytes memory) &#123;</span><br><span class="line">        // 通过 call 调用目标合约的 setValue(uint)</span><br><span class="line">        (bool success, bytes memory data) = target.call(</span><br><span class="line">            abi.encodeWithSignature(&quot;setValue(uint256)&quot;, value)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Call failed&quot;);</span><br><span class="line">        return (success, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendEth(address payable target) external payable &#123;</span><br><span class="line">        // 使用 call 发送 ETH</span><br><span class="line">        (bool success, ) = target.call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Send ETH failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="staticcall"><a href="#staticcall" class="headerlink" title="staticcall"></a>staticcall</h1><p><strong>功能</strong></p>
<p><code>staticcall</code>是一种只读调用方法，用于调用目标合约的视图或纯函数。它不允许改变状态，因此更安全且节省 Gas</p>
<p><strong>特点</strong></p>
<ul>
<li>只能调用 view 或 pure 修饰的函数。</li>
<li>无法修改状态或发送 ETH。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>查询目标合约的状态。</li>
<li>调用只读逻辑以避免状态改变。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract StaticCallExample &#123;</span><br><span class="line">    function staticCallFunction(address target) external view returns (uint256) &#123;</span><br><span class="line">        // 使用 staticcall 调用目标合约的 storedValue()</span><br><span class="line">        (bool success, bytes memory data) = target.staticcall(</span><br><span class="line">            abi.encodeWithSignature(&quot;storedValue()&quot;)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Staticcall failed&quot;);</span><br><span class="line">        return abi.decode(data, (uint256));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="delegatecall"><a href="#delegatecall" class="headerlink" title="delegatecall"></a>delegatecall</h1><p><strong>功能</strong></p>
<p><code>delegatecall</code> 是一种在当前合约上下文中执行目标合约逻辑的方法。它会以调用合约的存储布局为准，执行目标合约中的代码。</p>
<p><strong>特点</strong></p>
<ul>
<li>使用调用合约的存储。</li>
<li>使用调用合约的 msg.sender 和 msg.value。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>实现合约代理（如升级逻辑）。</li>
<li>在共享存储布局的上下文中执行外部逻辑。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract DelegateCallExample &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function delegateCallFunction(address target, uint256 value) external &#123;</span><br><span class="line">        // 使用 delegatecall 调用目标合约的 setValue(uint)</span><br><span class="line">        (bool success, ) = target.delegatecall(</span><br><span class="line">            abi.encodeWithSignature(&quot;setValue(uint256)&quot;, value)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 被调用合约 (Library)</span><br><span class="line">contract Target &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 value) external &#123;</span><br><span class="line">        storedValue = value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="call-VS-staticcall-VS-delegatecall"><a href="#call-VS-staticcall-VS-delegatecall" class="headerlink" title="call VS staticcall VS delegatecall"></a><code>call</code> VS <code>staticcall</code> VS <code>delegatecall</code></h1><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="center">call</th>
<th align="center">staticcall</th>
<th align="center">delegatecall</th>
</tr>
</thead>
<tbody><tr>
<td align="center">可读写状态</td>
<td align="center">✅</td>
<td align="center">❌（只读）</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">使用调用合约存储</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">使用调用合约<code>msg.sender</code></td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">支持发送ETH</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">调用不存在的函数</td>
<td align="center">支持，返回失败</td>
<td align="center">支持，返回失败</td>
<td align="center">支持，返回失败</td>
</tr>
</tbody></table>
<h1 id="使用注意事项"><a href="#使用注意事项" class="headerlink" title="使用注意事项"></a>使用注意事项</h1><p><strong>call 的安全性</strong></p>
<ul>
<li>使用 call 调用外部合约时，目标合约可能会执行恶意代码。需要额外检查返回值并限制权限。</li>
<li>不要轻易使用 call 调用不可信的合约。</li>
</ul>
<p><strong>delegatecall 的存储风险</strong></p>
<ul>
<li>调用目标合约时，目标合约必须与调用合约共享相同的存储布局，否则可能导致存储冲突。</li>
<li>使用 delegatecall 需要确保调用的是受信任的逻辑。</li>
</ul>
<p><strong>Gas 消耗与返回值处理</strong></p>
<ul>
<li>注意低级调用的 Gas 使用，避免由于 Gas 不足导致调用失败。</li>
<li>低级调用（call、staticcall 和 delegatecall）不会自动抛出异常，需要手动处理返回值。</li>
</ul>
<p><strong>不要使用简写类型</strong></p>
<p>无论是使用abi.encodeWithSelect 还是 abi.encodeWithSignature ，参数中方法名后的参数一定不要使用简写类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 错误写法</span><br><span class="line">(bool success, ) = target.call(abi.encodeWithSignature(&quot;setValue(uint)&quot;, value));</span><br></pre></td></tr></table></figure>

<p>因为在编译的过程中，编译器会将简写类型（如：uint）转换成uint256，这将导致，你的签名或选择器不匹配，导致执行失败。</p>
<h1 id="实践案例：实现代理合约"><a href="#实践案例：实现代理合约" class="headerlink" title="实践案例：实现代理合约"></a>实践案例：实现代理合约</h1><p>以下是使用 <code>delegatecall</code> 的代理合约的示例，用于实现合约逻辑的动态升级</p>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">// 逻辑合约</span><br><span class="line">contract LogicContract &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 value) external &#123;</span><br><span class="line">        storedValue = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 代理合约</span><br><span class="line">contract ProxyContract &#123;</span><br><span class="line">    address public logicContract;</span><br><span class="line"></span><br><span class="line">    constructor(address _logicContract) &#123;</span><br><span class="line">        logicContract = _logicContract;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        (bool success, ) = logicContract.delegatecall(msg.data);</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行过程</strong></p>
<ul>
<li>部署 LogicContract。</li>
<li>部署 ProxyContract，将 LogicContract 的地址传递给其构造函数。</li>
<li>通过代理合约调用 setValue 方法，storedValue 实际存储在 ProxyContract 中</li>
</ul>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p><code>call</code>、<code>staticcall</code> 和 <code>delegatecall</code> 是 Solidity 中的基础工具，可以用来实现灵活的合约交互和逻辑扩展。在使用这些低级调用时，需要仔细处理返回值、安全性以及存储一致性问题。</p>
<p>通过合理使用这些工具，您可以设计功能强大且可扩展的智能合约体系，同时避免潜在的安全漏洞。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/05/24/linux/ebpf-deploy-sample/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/24/linux/ebpf-deploy-sample/" class="post-title-link" itemprop="url">eBPF开发环境搭建及示例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-24 14:10:59" itemprop="dateCreated datePublished" datetime="2024-05-24T14:10:59+08:00">2024-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lsb_release -a</span></span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:	Ubuntu</span><br><span class="line">Description:	Ubuntu 22.04.4 LTS</span><br><span class="line">Release:	22.04</span><br><span class="line">Codename:	jammy</span><br><span class="line"><span class="comment"># uname -a</span></span><br><span class="line">Linux ubu22 5.15.0-100-generic <span class="comment">#110-Ubuntu SMP Wed Feb 7 13:28:04 UTC 2024 aarch64 aarch64 aarch64 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<h1 id="包安装"><a href="#包安装" class="headerlink" title="包安装"></a>包安装</h1><p><em>安装软件包</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y bison flex build-essential git cmake make libelf-dev strace tar libfl-dev libssl-dev libedit-dev zlib1g-dev  python  python3-distutils libcap-dev llvm clang</span><br></pre></td></tr></table></figure>

<h2 id="安装-bcc"><a href="#安装-bcc" class="headerlink" title="安装 bcc"></a>安装 bcc</h2><p><code>bcc</code> 是一组用于 <code>eBPF</code> 开发的工具，它包括了一组用于编写和调试 <code>eBPF</code> 程序的库和命令行工具。使用 <code>bcc</code>，可以更加方便地开发和调试 <code>eBPF</code> 程序，提高开发效率和代码质量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install bpfcc-tools</span><br></pre></td></tr></table></figure>

<h2 id="安装-bpftool"><a href="#安装-bpftool" class="headerlink" title="安装 bpftool"></a>安装 bpftool</h2><p><code>bpftool</code> 是一个用于管理和调试 <code>eBPF</code> 代码的命令行工具。它允许你查看和分析系统中运行的 <code>eBPF</code> 程序和映射，以及与内核中的 <code>eBPF</code> 子系统进行交互。更多内容可以查看 <a target="_blank" rel="noopener" href="https://github.com/libbpf/bpftool">bpftool Github</a></p>
<p>使用 <code>bpftool</code>，你可以执行以下操作：</p>
<ul>
<li>列出当前系统中所有加载的 <code>eBPF</code> 程序和映射</li>
<li>查看指定 <code>eBPF</code> 程序或映射的详细信息，例如指令集、内存布局等</li>
<li>修改 <code>eBPF</code> 程序或映射的属性，例如禁用一个程序或清空一个映射</li>
<li>将一个 <code>eBPF</code> 程序或映射导出到文件中，以便在其他系统上重新导入</li>
<li>调试 <code>eBPF</code> 程序，例如跟踪程序的控制流、访问内存等</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y linux-tools-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>

<p>默认情况下 <code>bpftool</code> 命令会安装到&#x2F;<code>usr/local/sbin/</code> 下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bpftool version -p</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;5.15.143&quot;</span>,</span><br><span class="line">    <span class="string">&quot;features&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;libbfd&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;skeletons&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="安装linux源码"><a href="#安装linux源码" class="headerlink" title="安装linux源码"></a>安装linux源码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install linux-source-5.15.0</span><br></pre></td></tr></table></figure>

<h1 id="编译bpf-sample"><a href="#编译bpf-sample" class="headerlink" title="编译bpf sample"></a>编译bpf sample</h1><p><em>解压缩</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/src/linux-source-5.15.0/debian</span><br><span class="line">tar -jxvf linux-source-5.15.0.tar.bz2</span><br></pre></td></tr></table></figure>

<p><em>Copy config文件</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> linux-source-5.15.0</span><br><span class="line"><span class="built_in">cp</span> -v /boot/config-$(<span class="built_in">uname</span> -r) .config</span><br><span class="line">make oldconfig &amp;&amp; make prepare</span><br></pre></td></tr></table></figure>


<p><em>编译Samples</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C samples/bpf</span><br></pre></td></tr></table></figure>

<p>若遇到如下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">  CC      /usr/src/linux-source-5.15.0/samples/bpf/bpftool/prog.o</span><br><span class="line">  LINK    /usr/src/linux-source-5.15.0/samples/bpf/bpftool/bpftool</span><br><span class="line">/usr/src/linux-source-5.15.0/samples/bpf/Makefile:369: *** Cannot find a vmlinux <span class="keyword">for</span> VMLINUX_BTF at any of <span class="string">&quot;  /usr/src/linux-source-5.15.0/vmlinux&quot;</span>, build the kernel or <span class="built_in">set</span> VMLINUX_BTF or VMLINUX_H variable.  Stop.</span><br><span class="line">make[1]: *** [Makefile:1911: /usr/src/linux-source-5.15.0/samples/bpf] Error 2</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/usr/src/linux-source-5.15.0&#x27;</span></span><br><span class="line">make: *** [Makefile:275: all] Error 2</span><br><span class="line">make: Leaving directory <span class="string">&#x27;/usr/src/linux-source-5.15.0/samples/bpf&#x27;</span></span><br></pre></td></tr></table></figure>

<p>说明需要 vmlinux，可以指定vmlinux再进行编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make VMLINUX_BTF=/sys/kernel/btf/vmlinux -C samples/bpf</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make VMLINUX_BTF=/sys/kernel/btf/vmlinux M=samples/bpf</span><br></pre></td></tr></table></figure>

<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>示例需要在 <code>usr/src/linux-source-5.15.0/samples/bpf</code>目录下进行编译。<code>samples/bpf</code> 下的程序一般组成方式是 xxx_user.c 和 xxx_kern.c</p>
<ul>
<li>xxx_user.c：为用户空间的程序用于设置 BPF 程序的相关配置、加载 BPF 程序至内核、设置 BPF 程序中的 map 值和读取 BPF 程序运行过程中发送至用户空间的消息等。</li>
<li>xxx_kern.c：为 BPF 程序代码，通过 clang 编译成字节码加载至内核中，在对应事件触发的时候运行，可以接受用户空间程序发送的各种数据，并将运行时产生的数据发送至用户空间程序。</li>
</ul>
<p>新建两个文件：<code>bob_user.c</code>和<code>bob_kern.c</code></p>
<p><em>bob_kern.c</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uapi/linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_tracing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_enter_execve&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_prog</span><span class="params">(<span class="keyword">struct</span> pt_regs *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> fmt[] = <span class="string">&quot;bob %s !\n&quot;</span>;</span><br><span class="line">	<span class="type">char</span> comm[<span class="number">16</span>];</span><br><span class="line">	bpf_get_current_comm(&amp;comm, <span class="keyword">sizeof</span>(comm));</span><br><span class="line">	bpf_trace_printk(fmt, <span class="keyword">sizeof</span>(fmt), comm);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br><span class="line">u32 _version <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;version&quot;</span>)</span> = LINUX_VERSION_CODE;</span><br></pre></td></tr></table></figure>

<p><em>bob_user.c</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;trace_helpers.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> ac, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_link</span> *<span class="title">link</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_program</span> *<span class="title">prog</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_object</span> *<span class="title">obj</span>;</span></span><br><span class="line">	<span class="type">char</span> filename[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">&quot;%s_kern.o&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	obj = bpf_object__open_file(filename, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (libbpf_get_error(obj)) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: opening BPF object file failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	prog = bpf_object__find_program_by_name(obj, <span class="string">&quot;bpf_prog&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!prog) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: finding a prog in obj file failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> cleanup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* load BPF program */</span></span><br><span class="line">	<span class="keyword">if</span> (bpf_object__load(obj)) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: loading BPF object file failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> cleanup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	link = bpf_program__attach(prog);</span><br><span class="line">	<span class="keyword">if</span> (libbpf_get_error(link)) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: bpf_program__attach failed\n&quot;</span>);</span><br><span class="line">		link = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">goto</span> cleanup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	read_trace_pipe();</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">	bpf_link__destroy(link);</span><br><span class="line">	bpf_object__close(obj);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 <code>samples/bpf/Makefile</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">tprogs-y += xdp_sample_pkts</span><br><span class="line">tprogs-y += ibumad</span><br><span class="line">tprogs-y += hbm</span><br><span class="line"><span class="comment"># 增加 user programs</span></span><br><span class="line">tprogs-y += bob</span><br><span class="line">...</span><br><span class="line">ibumad-objs := ibumad_user.o</span><br><span class="line">hbm-objs := hbm.o <span class="variable">$(CGROUP_HELPERS)</span></span><br><span class="line"><span class="comment"># 增加 objs</span></span><br><span class="line">bob-objs := bob_user.o <span class="variable">$(TRACE_HELPERS)</span></span><br><span class="line">...</span><br><span class="line">always-y += hbm_edt_kern.o</span><br><span class="line">always-y += xdpsock_kern.o</span><br><span class="line"><span class="comment"># 增加 kernel programs</span></span><br><span class="line">always-y += bob_kern.o</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make VMLINUX_BTF=/sys/kernel/btf/vmlinux M=samples/bpf</span><br></pre></td></tr></table></figure>


<p>运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd samples/bpf</span></span><br><span class="line"><span class="comment"># ./bob</span></span><br><span class="line">libbpf: elf: skipping unrecognized data section(4) .rodata.str1.1</span><br><span class="line">           &lt;...&gt;-3622529 [001] d...1 1751426.283602: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            sshd-3622530 [001] d...1 1751426.288591: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            sshd-3622531 [001] d...1 1751430.924951: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &lt;...&gt;-3622532 [000] d...1 1751430.929273: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            bash-3622532 [000] d...1 1751430.930114: bpf_trace_printk: bob bash !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &lt;...&gt;-3622533 [001] d...1 1751430.934470: bpf_trace_printk: bob sshd !</span><br></pre></td></tr></table></figure>


<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/lizhijun_buaa/article/details/131644323">eBPF开发环境搭建</a></li>
<li><a target="_blank" rel="noopener" href="https://yaoyao.io/posts/how-to-setup-ebpf-env-on-ubuntu#linux-tools">如何在 Ubuntu 上配置 eBPF 开发环境</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/baidu_29900103/article/details/131188347">基于ubuntu22.04-深入浅出 eBPF</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2023/02/16/storage/linux-drbd-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/16/storage/linux-drbd-usage/" class="post-title-link" itemprop="url">DRBD</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-16 15:52:32" itemprop="dateCreated datePublished" datetime="2023-02-16T15:52:32+08:00">2023-02-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>DRBD（Distributed Replicated Block Device，分布式复制块设备)是一个用软件实现的、无共享的、服务器之间镜像块设备内容的存储复制解决方案。DRBD是镜像块设备，是按数据位镜像成一样的数据块。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="ubuntu环境"><a href="#ubuntu环境" class="headerlink" title="ubuntu环境"></a>ubuntu环境</h2><p>准备两个ubuntu系统，一个作为源端ubu1，一个作为目的端ubu2。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04.5 LTS</span><br><span class="line">Release:    20.04</span><br><span class="line">Codename:   focal</span><br><span class="line">bob@ubu1:~$ uname -a</span><br><span class="line">Linux ubu1 5.4.0-139-generic #156-Ubuntu SMP Sat Jan 21 13:46:46 UTC 2023 aarch64 aarch64 aarch64 GNU/Linux</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04.5 LTS</span><br><span class="line">Release:    20.04</span><br><span class="line">Codename:   focal</span><br><span class="line">bob@ubu2:~$ uname -a</span><br><span class="line">Linux ubu2 5.4.0-139-generic #156-Ubuntu SMP Sat Jan 21 13:46:46 UTC 2023 aarch64 aarch64 aarch64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p><code>brbd.ko</code>为linux内核自带，不需要另行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsmod | grep drbd</span><br><span class="line">drbd                  434176  3</span><br><span class="line">lru_cache              20480  1 drbd</span><br><span class="line">libcrc32c              16384  4 btrfs,xfs,drbd,raid456</span><br><span class="line">bob@ubu1:~$ modinfo drbd</span><br><span class="line">filename:       /lib/modules/5.4.0-139-generic/kernel/drivers/block/drbd/drbd.ko</span><br><span class="line">alias:          block-major-147-*</span><br><span class="line">license:        GPL</span><br><span class="line">version:        8.4.11</span><br><span class="line">description:    drbd - Distributed Replicated Block Device v8.4.11</span><br><span class="line">author:         Philipp Reisner &lt;phil@linbit.com&gt;, Lars Ellenberg &lt;lars@linbit.com&gt;</span><br><span class="line">srcversion:     B438804C5AE8C84C95D0411</span><br><span class="line">depends:        lru_cache,libcrc32c</span><br><span class="line">intree:         Y</span><br><span class="line">name:           drbd</span><br><span class="line">vermagic:       5.4.0-139-generic SMP mod_unload modversions aarch64</span><br><span class="line">sig_id:         PKCS#7</span><br><span class="line">signer:         Build time autogenerated kernel key</span><br><span class="line">sig_key:        43:64:51:B8:71:C1:53:C3:AE:29:64:EC:5F:B2:A3:30:54:25:F9:B5</span><br><span class="line">sig_hashalgo:   sha512</span><br><span class="line">signature:      0F:16:6D:12:54:0F:95:51:A5:18:4A:0A:A9:7C:72:F6:2D:31:21:39:</span><br><span class="line">                44:D9:71:C8:1B:7C:3F:1B:4B:66:53:08:1A:63:92:C3:CE:19:19:F0:</span><br><span class="line">                13:9F:9D:D6:7B:0B:27:F8:54:19:D3:44:F9:CC:8F:6E:E1:82:07:7A:</span><br><span class="line">                30:B1:37:28:5E:60:92:5B:C9:26:B0:25:DD:50:9D:A5:2E:76:96:A8:</span><br><span class="line">                E2:58:A1:36:DC:AA:84:D2:40:EF:66:F1:82:E5:2B:51:D7:F8:49:62:</span><br><span class="line">                9A:62:22:DC:42:A9:01:EC:6B:DC:9F:C6:8E:DD:9D:4A:CD:93:9B:F9:</span><br><span class="line">                3B:E4:4A:B4:34:BD:12:1A:89:C0:2C:2B:96:4D:86:27:D5:93:3A:51:</span><br><span class="line">                D4:DD:C7:34:9D:2D:A0:6C:BC:57:D1:9F:54:C2:55:56:B2:60:4D:FB:</span><br><span class="line">                86:55:18:09:9C:A5:C1:80:54:F5:F5:35:97:7E:32:36:A9:9B:F9:B2:</span><br><span class="line">                69:5B:BD:83:A3:41:89:9B:4F:7D:BA:A9:F1:E2:28:6A:FD:D4:7A:94:</span><br><span class="line">                67:34:D1:3C:8D:39:18:F7:43:A7:5F:67:71:B6:3B:63:3C:10:16:B7:</span><br><span class="line">                44:EA:D2:D4:52:19:28:F3:60:31:35:69:6B:EA:25:3B:35:FC:32:05:</span><br><span class="line">                B9:5A:99:7E:61:27:59:52:A8:55:8C:B6:15:8E:77:26:0F:DC:61:93:</span><br><span class="line">                F9:10:EA:8F:FD:E1:E0:DF:60:2D:83:92:9E:33:D7:99:10:93:AF:03:</span><br><span class="line">                44:8B:A0:6A:E8:E7:08:71:77:1C:CC:35:96:8C:94:DB:62:CA:ED:64:</span><br><span class="line">                B8:17:43:24:FD:BF:FC:3B:D7:D7:03:1C:83:06:0E:B5:D3:82:2A:4B:</span><br><span class="line">                E4:A7:F9:C4:07:9C:0F:2B:3E:D4:EA:48:FF:6E:BD:79:2E:85:FB:EE:</span><br><span class="line">                2D:A2:70:96:38:77:9C:29:58:5C:45:B1:8A:29:D2:7A:87:55:A6:A3:</span><br><span class="line">                32:A2:FC:F5:A2:4F:9C:20:85:F0:55:E6:A6:01:D2:76:EE:27:2F:A0:</span><br><span class="line">                BC:67:F2:B9:9B:A4:5D:2D:3D:6F:E9:46:C0:EF:4A:0C:01:15:19:E7:</span><br><span class="line">                9C:61:A9:00:E8:1A:D3:7D:2E:86:81:FD:BA:53:44:85:17:19:D9:B3:</span><br><span class="line">                B8:E2:7B:39:01:28:3E:F3:DF:87:3C:C5:E4:37:89:C1:67:16:B0:2C:</span><br><span class="line">                C7:4D:C8:6F:71:97:55:19:24:63:7B:D6:08:A2:EC:EB:C3:AA:71:91:</span><br><span class="line">                35:B4:C6:47:B5:EA:2B:DF:E4:AC:9C:06:77:73:1B:33:F5:AF:EE:58:</span><br><span class="line">                AC:F2:C4:A0:C9:00:58:AB:3F:62:1B:E5:E5:C3:E1:39:98:5B:2A:C9:</span><br><span class="line">                BD:10:6B:AF:FC:44:B0:7D:57:07:B0:5B</span><br><span class="line">parm:           allow_oos:DONT USE! (bool)</span><br><span class="line">parm:           disable_sendpage:bool</span><br><span class="line">parm:           proc_details:int</span><br><span class="line">parm:           minor_count:Approximate number of drbd devices (1-255) (uint)</span><br><span class="line">parm:           usermode_helper:string</span><br></pre></td></tr></table></figure>

<p>至于使用drbd的工具还是要安装的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo apt-cache show drbd-utils</span><br><span class="line">Package: drbd-utils</span><br><span class="line">Architecture: arm64</span><br><span class="line">Version: 9.11.0-1build1</span><br><span class="line">Priority: extra</span><br><span class="line">Section: admin</span><br><span class="line">Origin: Ubuntu</span><br><span class="line">Maintainer: Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;</span><br><span class="line">Original-Maintainer: Debian DRBD Maintainers &lt;debian-ha-maintainers@lists.alioth.debian.org&gt;</span><br><span class="line">Bugs: https://bugs.launchpad.net/ubuntu/+filebug</span><br><span class="line">Installed-Size: 2062</span><br><span class="line">Depends: lsb-base (&gt;= 3.0-6), libc6 (&gt;= 2.28), libgcc-s1 (&gt;= 3.0), libstdc++6 (&gt;= 5.2), init-system-helpers (&gt;= 1.51)</span><br><span class="line">Recommends: heirloom-mailx | mailx</span><br><span class="line">Suggests: heartbeat</span><br><span class="line">Breaks: drbd8-utils (&lt;&lt; 2:8.9.0)</span><br><span class="line">Replaces: drbd8-utils (&lt;&lt; 2:8.9.0)</span><br><span class="line">Filename: pool/main/d/drbd-utils/drbd-utils_9.11.0-1build1_arm64.deb</span><br><span class="line">Size: 654128</span><br><span class="line">MD5sum: 45a8962e941c9a87c7de423de34f616b</span><br><span class="line">SHA1: 3734ee6c0611348c5b8c080feb713c05f9d84c4c</span><br><span class="line">SHA256: ae63aa90d145faab00551f151c10588bafebe2673e64b137c980cce7c299bccf</span><br><span class="line">Homepage: https://www.drbd.org/</span><br><span class="line">Description-en: RAID 1 over TCP/IP for Linux (user utilities)</span><br><span class="line"> Drbd is a block device which is designed to build high availability</span><br><span class="line"> clusters by providing a virtual shared device which keeps disks in</span><br><span class="line"> nodes synchronised using TCP/IP. This simulates RAID 1 but avoiding</span><br><span class="line"> the use of uncommon hardware (shared SCSI buses or Fibre Channel).</span><br><span class="line"> It is currently limited to fail-over HA clusters.</span><br><span class="line"> .</span><br><span class="line"> This package contains the programs that will control the drbd kernel</span><br><span class="line"> module provided in the Linux kernel.</span><br><span class="line">Description-md5: 7da3dade742b03d1a9c08b339123f93b</span><br><span class="line"></span><br><span class="line">bob@ubu1:~$ apt install drbd-utils</span><br></pre></td></tr></table></figure>

<p>两个节点ubu1和ubu2都需要安装这个<code>drbd-utils</code>包</p>
<h1 id="常规用法"><a href="#常规用法" class="headerlink" title="常规用法"></a>常规用法</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="配置-etc-drbd-d-global-common-conf"><a href="#配置-etc-drbd-d-global-common-conf" class="headerlink" title="配置/etc/drbd.d/global_common.conf"></a>配置<code>/etc/drbd.d/global_common.conf</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">global &#123;</span><br><span class="line">    usage-count yes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">common &#123;</span><br><span class="line">    net &#123;</span><br><span class="line">        protocol C;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DRBD系统向虚拟块的镜像中写入数据时，支持三种协议</p>
<ul>
<li><code>protocol A</code> 数据一旦写入磁盘并发送到网络中就认为完成了写入操作</li>
<li><code>protocol B</code> 收到接收确认就认为完成了写入操作</li>
<li><code>protocol C</code> 收到写入确认就认为完成了写入操作</li>
</ul>
<p>基于安全考虑我们一般选择<code>protocol C</code></p>
<h3 id="配置DRBD资源-etc-drbd-d-r0-res"><a href="#配置DRBD资源-etc-drbd-d-r0-res" class="headerlink" title="配置DRBD资源/etc/drbd.d/r0.res"></a>配置DRBD资源<code>/etc/drbd.d/r0.res</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">resource r0 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">      device    /dev/drbd1;</span><br><span class="line">      disk  /dev/sda;</span><br><span class="line">      address   192.168.64.2:7789;</span><br><span class="line">      meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">      device    /dev/drbd1;</span><br><span class="line">      disk  /dev/sda;</span><br><span class="line">      address   192.168.64.4:7789;</span><br><span class="line">      meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>device</code>指drbd映射出来的快设备名称，<code>disk</code>指用于存放数据的硬盘。</p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>分别在<code>ubu1</code>和<code>ubu2</code>上创建DRBD资源元数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm create-md r0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo drbdadm create-md r0</span><br></pre></td></tr></table></figure>

<p>然后再启动<code>ubu1</code>和<code>ubu2</code>上的DRBD服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo systemctl start drbd</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo systemctl start drbd</span><br></pre></td></tr></table></figure>

<p>启动<code>r0</code>资源，并设置<code>ubu1</code>为主设备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm up r0</span><br><span class="line">bob@ubu1:~$ sudo drbdadm primary --force r0</span><br></pre></td></tr></table></figure>

<p>可以使用<code>drbdadm status r0</code>查看状态，也可以用<code>cat /proc/drbd</code>查看同步进度。<br>当<code>peer-disk</code>状态为<code>UpToDate</code>表示数据已经同步到最新状态。</p>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm status r0</span><br><span class="line">r0 role:Primary</span><br><span class="line">  disk:UpToDate</span><br><span class="line">  peer role:Secondary</span><br><span class="line">    replication:Established peer-disk:UpToDate</span><br></pre></td></tr></table></figure>

<p>如需查询服务状态详细信息可以通过命令<code>drbdsetup status r0 --verbose --statistics</code>查询</p>
<h2 id="文件系统常规使用"><a href="#文件系统常规使用" class="headerlink" title="文件系统常规使用"></a>文件系统常规使用</h2><p>首先通过<code>lsblk</code>查看<code>drbd1</code>快设备是否存在，然后格式化成xfs文件系统，并挂载到<code>/mnt</code>目录上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop2                       7:2    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop3                       7:3    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop5                       7:5    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop6                       7:6    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop7                       7:7    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop8                       7:8    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~$ mkfs.xfs /dev/drbd1</span><br><span class="line">...</span><br><span class="line">bob@ubu1:~$ mount /dev/drbd1 /mnt</span><br><span class="line">bob@ubu1:~$ touch /mnt/hello</span><br></pre></td></tr></table></figure>

<h2 id="切换"><a href="#切换" class="headerlink" title="切换"></a>切换</h2><p>切换操作，可以认为是切换primary节点操作。需要先将ubu1(primary节点)设置成<code>secondary</code>，再将ubu2(secondary节点)设置成<code>primary</code>，然后ubu2节点就可以挂载<code>drbd1</code>快设备了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm secondary r0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo drbdadm primary r0</span><br><span class="line">bob@ubu2:~$ sudo mount /dev/drbd1 /mnt/</span><br><span class="line">bob@ubu2:~$ df -h</span><br><span class="line">Filesystem                         Size  Used Avail Use% Mounted on</span><br><span class="line">udev                               1.9G     0  1.9G   0% /dev</span><br><span class="line">tmpfs                              392M  1.4M  391M   1% /run</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv   49G  7.3G   39G  16% /</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /dev/shm</span><br><span class="line">tmpfs                              5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">/dev/vda2                          974M  206M  701M  23% /boot</span><br><span class="line">/dev/vda1                          511M  5.3M  506M   2% /boot/efi</span><br><span class="line">/dev/loop3                          60M   60M     0 100% /snap/core20/1826</span><br><span class="line">/dev/loop1                          50M   50M     0 100% /snap/core18/2681</span><br><span class="line">/dev/loop2                          58M   58M     0 100% /snap/core20/1332</span><br><span class="line">/dev/loop5                          92M   92M     0 100% /snap/lxd/24065</span><br><span class="line">/dev/loop4                          61M   61M     0 100% /snap/lxd/21843</span><br><span class="line">/dev/loop6                          44M   44M     0 100% /snap/snapd/17954</span><br><span class="line">tmpfs                              392M     0  392M   0% /run/user/1000</span><br><span class="line">/dev/drbd1                          20G  175M   20G   1% /mnt</span><br></pre></td></tr></table></figure>

<p>在将ubu1节点从primary状态设置成secondary状态时可能会遇到如下错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm secondary r0</span><br><span class="line">1: State change failed: (-12) Device is held open by someone</span><br><span class="line">env: python: No such file or directory</span><br></pre></td></tr></table></figure>
<p>这说明当前块设备<code>brbd1</code>正在被挂载或者被其他应用使用，可以使用<code>lsof</code>命令查看改设备的使用情况，并终止使用后再设置节点状态为<code>secondary</code>。</p>
<h1 id="硬盘容量大小不一致情况"><a href="#硬盘容量大小不一致情况" class="headerlink" title="硬盘容量大小不一致情况"></a>硬盘容量大小不一致情况</h1><p>当源和备硬盘容量大小不一致时，取最小容量做为drbd块设备对外提供的存储空间大小。</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   21G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   22G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~$ cat /etc/drbd.d/r1.res</span><br><span class="line">resource r1 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.2:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.4:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bob@ubu1:~$ cat /etc/drbd.d/r2.res</span><br><span class="line">resource r2 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdc;</span><br><span class="line">    address   192.168.64.2:7793;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdc;</span><br><span class="line">    address   192.168.64.4:7793;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bob@ubu1:~$ cat /proc/drbd</span><br><span class="line">version: 8.4.11 (api:1/proto:86-101)</span><br><span class="line">srcversion: B438804C5AE8C84C95D0411</span><br><span class="line"></span><br><span class="line"> 1: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"> 2: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:22019388 nr:0 dw:0 dr:22021500 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"> 3: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:23067932 nr:0 dw:0 dr:23070036 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop3                       7:3    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop4                       7:4    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop5                       7:5    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop6                       7:6    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop7                       7:7    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   32G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   21G  1 disk</span><br><span class="line">sdc                         8:32   0   22G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   22G  1 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<h1 id="硬盘扩容情况"><a href="#硬盘扩容情况" class="headerlink" title="硬盘扩容情况"></a>硬盘扩容情况</h1><p>在ubu1上使用lvm构建底层硬盘存储数据，方便后续进行扩容操作。先创建一个20G的lv，然后创建drbd块设备，待同步完数据后对lv进行扩容10G操作，最后再对drbd进行扩容操作。(此间省略lvm相关操作)</p>
<p>ubu2上使用一个30G的scsi设备，不配置lvm，与ubu1上的lvm块设备构成一个异构环境。</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ cat /etc/drbd.d/r1.res</span><br><span class="line">resource r1 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/drbd-vg/drbdlv1;</span><br><span class="line">    address   192.168.64.2:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.4:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm create-md r1</span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (640 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   20G  0 lvm</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm up r1</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm primary --force r1</span><br><span class="line">bob@ubu1:~/drbd_res$ cat /proc/drbd</span><br><span class="line">version: 8.4.11 (api:1/proto:86-101)</span><br><span class="line">srcversion: B438804C5AE8C84C95D0411</span><br><span class="line"></span><br><span class="line"> 1: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"> 2: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----</span><br><span class="line">    ns:14496 nr:0 dw:0 dr:16616 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:20956348</span><br><span class="line">        [&gt;....................] sync&#x27;ed:  0.1% (20464/20476)M</span><br><span class="line">        finish: 2:21:35 speed: 2,416 (2,416) K/sec</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop3                       7:3    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop4                       7:4    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop5                       7:5    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop6                       7:6    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop7                       7:7    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   32G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   20G  1 disk</span><br><span class="line">sdc                         8:32   0   22G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<p>目前drbd2对外提供的是一个20G的硬盘，接下来在不停drbd复制链接的情况下对其扩容10G（同样，省略lvm相关操作）</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   20G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   20G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm status r1</span><br><span class="line">r1 role:Primary</span><br><span class="line">  disk:UpToDate</span><br><span class="line">  peer role:Secondary</span><br><span class="line">    replication:SyncSource peer-disk:Inconsistent done:88.51</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm resize r1</span><br><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   30G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   30G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop3                       7:3    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop4                       7:4    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop5                       7:5    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop6                       7:6    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop7                       7:7    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   32G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   30G  1 disk</span><br><span class="line">sdc                         8:32   0   22G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<p>使用<code>drbdadm resize r1</code>完成对<code>r1</code>资源的扩容操作。</p>
<h1 id="硬盘存在有效数据情况"><a href="#硬盘存在有效数据情况" class="headerlink" title="硬盘存在有效数据情况"></a>硬盘存在有效数据情况</h1><p>ubu1和ubu2上分别创建了两个硬盘，一个20G存drbd的meta-data，一个30G用于存drbd的数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ cat r2.res</span><br><span class="line">resource r2 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdc;</span><br><span class="line">    address   192.168.64.2:7793;</span><br><span class="line">    meta-disk /dev/sdb;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.4:7793;</span><br><span class="line">    meta-disk /dev/sdc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先对ubu1上的数据盘<code>sdc</code>创建文件系统，并写入数据。然后再做drbd pair。</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ sudo mkfs.ext4 /dev/sdc</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Discarding device blocks: done</span><br><span class="line">Creating filesystem with 8126464 4k blocks and 2031616 inodes</span><br><span class="line">Filesystem UUID: 656f1b08-77a2-4488-acb1-f25ff616b257</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span><br><span class="line">    4096000, 7962624</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Creating journal (32768 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line"></span><br><span class="line">bob@ubu1:~/drbd_res$ sudo mount /dev/sdc /mnt/</span><br><span class="line">bob@ubu1:~/drbd_res$ echo &quot;Hi, bob&quot; &gt; /mnt/bob.txt</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo umount /mnt</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm create-md r2</span><br><span class="line">md_offset 0</span><br><span class="line">al_offset 4096</span><br><span class="line">bm_offset 36864</span><br><span class="line"></span><br><span class="line">Found some data</span><br><span class="line"></span><br><span class="line"> ==&gt; This might destroy existing data! &lt;==</span><br><span class="line"></span><br><span class="line">Do you want to proceed?</span><br><span class="line">[need to type &#x27;yes&#x27; to confirm] yes</span><br><span class="line"></span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (672 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm up r2</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm primary --force r2</span><br><span class="line">bob@ubu1:~/drbd_res$ cat /proc/drbd</span><br><span class="line">version: 8.4.11 (api:1/proto:86-101)</span><br><span class="line">srcversion: B438804C5AE8C84C95D0411</span><br><span class="line"></span><br><span class="line"> 1: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"></span><br><span class="line"> 3: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----</span><br><span class="line">    ns:130656 nr:0 dw:0 dr:131328 al:8 bm:0 lo:0 pe:4 ua:0 ap:0 ep:1 wo:f oos:32376640</span><br><span class="line">        [&gt;....................] sync&#x27;ed:  0.5% (31616/31744)M</span><br><span class="line">        finish: 1:14:56 speed: 7,176 (7,176) K/sec</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo drbdadm create-md r2</span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (704 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<p>此时drbd pair已经创建好了，<code>drbd3</code>也已经创建完成，直接挂载<code>drbd3</code>查看数据是否依然还在</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   31G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   31G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo mount /dev/drbd3 /mnt/</span><br><span class="line">bob@ubu1:~/drbd_res$ ls /mnt/</span><br><span class="line">bob.txt  lost+found</span><br><span class="line">bob@ubu1:~/drbd_res$ cat /mnt/bob.txt</span><br><span class="line">Hi, Bob</span><br></pre></td></tr></table></figure>

<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>DRBD（Distributed Replicated Block Device）是一个基于内核模块的高可用性（HA）软件，它在两个或多个节点之间复制块设备数据，使得在其中一个节点发生故障时，其他节点可以接管工作并保持服务可用性。</p>
<p><img src="/images/drbd/drbd-in-kernel.png" alt="drbd-in-kernel.png"></p>
<p>DRBD的工作原理：</p>
<ol>
<li>DRBD将每个块设备划分为数据和元数据两个区域。元数据包含块设备的状态信息和同步状态，而数据包含实际的用户数据。</li>
<li>DRBD使用一个专用的网络通信通道（通常是TCP &#x2F; IP）来在节点之间传输数据。当发生写操作时，数据被写入本地节点的数据区域，并通过网络传输到远程节点，然后在远程节点上写入远程节点的数据区域。</li>
<li>DRBD还使用一种名为“生成标识符”（Generation Identifiers）的机制来检测节点间的数据同步状态。每个生成标识符对应一个生成版本，节点在进行数据同步时，使用生成标识符来判断版本是否相同。</li>
<li>DRBD提供了多种数据同步策略，例如全同步，增量同步和快速同步，以便在不同的应用场景下获得最佳的性能和数据完整性。</li>
<li>DRBD支持不同的工作模式，如协议A和协议C，用于适应不同的应用需求。协议A用于异步复制，适用于数据传输速度较慢的场景，而协议C则用于同步复制，适用于对数据完整性有较高要求的场景。</li>
</ol>
<h2 id="DRBD-Metadata"><a href="#DRBD-Metadata" class="headerlink" title="DRBD Metadata"></a>DRBD Metadata</h2><p>DRBD元数据包括：</p>
<ul>
<li>DRBD容量</li>
<li>GI(Generation Identifiers)</li>
<li>Activity Log</li>
<li>Quick-sync Bitmap</li>
</ul>
<h3 id="Internal-meta-data"><a href="#Internal-meta-data" class="headerlink" title="Internal meta data"></a>Internal meta data</h3><p>资源配置成<code>internal</code>方式存储元数据，这意味着元数据将与底层实际存储的数据放在一起。它通过在设备末尾设置一个区域来专门存储元数据。</p>
<ul>
<li><p>优点<br>  由于元数据与实际数据密不可分，因此在硬盘发生故障时，管理员不需要采取任何特殊措施。元数据将随着实际数据丢失，并与实际数据一起恢复。</p>
</li>
<li><p>缺点<br>  如果底层设备是单个物理硬盘（而不是 RAID 集），则内部元数据可能会对写入吞吐量产生负面影响。应用程序发起的写请求的性能可能会触发 DRBD 中元数据的更新。如果元数据存储在同一磁盘上，则写操作可能会导致硬盘的写入&#x2F;读取头产生两次额外的移动。</p>
</li>
</ul>
<p>如果您计划将内部元数据与已经有需要保留的数据的现有底层设备一起使用，您必须考虑 DRBD 元数据所需的空间。另外，在创建 DRBD 资源时，新创建的元数据可能会覆盖底层设备末尾的数据，从而可能破坏现有的文件。<br>为了避免这种情况发生，有三种解决方法：</p>
<ol>
<li>扩容底层硬盘，保证其有足够的容量存储元数据。</li>
<li>缩小已存在于底层硬盘的数据的大小，这需要文件系统的支持。</li>
<li>使用external meta data 替代。</li>
</ol>
<h3 id="External-meta-data"><a href="#External-meta-data" class="headerlink" title="External meta data"></a>External meta data</h3><p>External meta data 只是简单地存储在一个与包含生产数据的设备不同的、专用的块设备中。</p>
<ul>
<li><p>优势<br>  对于某些写操作，使用外部元数据可以产生略微改善的延迟行为。</p>
</li>
<li><p>缺点<br>  元数据与实际生产数据并不密不可分。这意味着，在硬件故障仅破坏生产数据（但不破坏 DRBD 元数据）的情况下，需要手动干预，以实现从存活的节点对新替换磁盘的全面数据同步。</p>
</li>
</ul>
<p>如果满足以下所有条件，使用外部元数据也是唯一可行的选择，您正在使用 DRBD 复制一个已经包含您希望保留的数据的现有设备，且该现有设备不支持扩大容量，且该设备上的现有文件系统不支持缩小容量。</p>
<h2 id="Generation-Identifiers"><a href="#Generation-Identifiers" class="headerlink" title="Generation Identifiers"></a>Generation Identifiers</h2><p>DRBD 使用Generation Identifiers（GIs）来标识“复制数据代”。数据同步是基于GI实现的。GI是一个递增的整数，每个DRBD设备都有自己的GI计数器，用于记录本地和远程节点上最新的GI。当DRBD设备从远程节点读取数据时，它会比较本地和远程节点上的GI值。如果本地GI值低于远程节点上的GI值，那么DRBD设备会自动启动数据同步，将远程节点上的数据复制到本地节点上。</p>
<p>该GI在DRBD的内部机制如下：</p>
<ul>
<li>确定这两个节点是否实际上是同一集群的成员（而不是意外连接的两个节点）</li>
<li>确定后台重新同步的方向（如果有必要）</li>
<li>确定是否需要进行完全重新同步或是否仅需要进行部分重新同步</li>
<li>标识脑裂</li>
</ul>
<p>分裂大脑是指当DRBD设备与另一个节点失去联系时发生的问题。在这种情况下，每个节点都可能认为自己是唯一的“活动”节点，并开始独立地写入数据。当两个节点再次连接时，它们可能会发现它们的数据不同步。GI用于解决这个问题。当两个节点重新连接时，它们比较彼此的GI值。如果GI值相同，则两个节点处于相同的“代”，可以继续同步数据。如果GI值不同，则两个节点处于不同的“代”，需要手动解决分裂大脑问题，通常需要将其中一个节点上的数据进行回滚。</p>
<h3 id="数据代-Data-generations"><a href="#数据代-Data-generations" class="headerlink" title="数据代(Data generations)"></a>数据代(Data generations)</h3><p>以下情况下标记新的数据生成开始：</p>
<ol>
<li>初始设备全量同步时</li>
<li>断开的资源切换到主要角色时</li>
<li>资源在主要角色下线时</li>
</ol>
<p>因此，我们可以总结出，每当资源处于已连接的连接状态，并且两个节点的磁盘状态都为UpToDate时，两个节点上的当前数据生成相同。<br>反之亦然。请注意，当前实现使用最低位来编码节点的角色（主&#x2F;辅）。因此，即使被认为具有相同的数据生成，不同节点上的最低位也可能不同。</p>
<p>每个新的数据生成由8字节的通用唯一标识符（UUID）标识。</p>
<h3 id="GI元组-The-generation-identifier-tuple"><a href="#GI元组-The-generation-identifier-tuple" class="headerlink" title="GI元组(The generation identifier tuple)"></a>GI元组(The generation identifier tuple)</h3><p>BD在本地资源元数据中保存了有关当前和历史数据生成的四个信息：</p>
<ol>
<li>当前UUID (Current UUID)<br> 这是从本地节点的视角看到的当前数据生成的生成标识符。当资源已连接并且同步完成时，当前UUID在节点之间是相同的。</li>
<li>位图UUID (Bitmap UUID)<br> 这是用于跟踪在断开连接模式下磁盘同步位图中的更改的生成的UUID。与磁盘同步位图本身一样，该标识符仅在断开连接模式下才相关。如果资源已连接，则此UUID始终为空（零）。</li>
<li>两个历史UUID (Historical UUIDs)<br> 它们是当前数据生成之前的两个数据生成的标识符。</li>
</ol>
<h3 id="GI如何变化"><a href="#GI如何变化" class="headerlink" title="GI如何变化"></a>GI如何变化</h3><h4 id="Start-of-a-new-data-generation"><a href="#Start-of-a-new-data-generation" class="headerlink" title="Start of a new data generation"></a>Start of a new data generation</h4><p><img src="/images/drbd/gi-changes-newgen.png" alt="gi-changes-newgen.png"></p>
<p>当一个节点（无论是由于网络故障还是手动干预）失去与其对等节点的连接时，DRBD 以下方式修改其本地生成GI：</p>
<ol>
<li>为新的数据生成创建一个新的 UUID。这成为主节点的新的 current UUID。</li>
<li>用之前的current UUID替换现在的Bitmap UUID，因此它成为主节点的新的Bitmap UUID。</li>
<li>在次要节点上，GI元组保持不变</li>
</ol>
<h4 id="Start-of-re-synchronization"><a href="#Start-of-re-synchronization" class="headerlink" title="Start of re-synchronization"></a>Start of re-synchronization</h4><p><img src="/images/drbd/gi-changes-syncstart.png" alt="gi-changes-syncstart.png"></p>
<p>在重新同步初始化时，DRBD在本地GI执行这些修改：</p>
<ol>
<li>同步源上的Current UUID保持不变。</li>
<li>同步源上的Bitmap UUID轮换到第一个历史UUID。</li>
<li>在同步源上生成一个新的Bitmap UUID。</li>
<li>此UUID成为同步目标上的新Current UUID。</li>
<li>同步目标上的Bitmap UUID和历史UUID保持不变。</li>
</ol>
<h4 id="Completion-of-re-synchronization"><a href="#Completion-of-re-synchronization" class="headerlink" title="Completion of re-synchronization"></a>Completion of re-synchronization</h4><p><img src="/images/drbd/gi-changes-synccomplete.png" alt="gi-changes-synccomplete.png"></p>
<p>当重新同步完成，需要执行如下步骤：</p>
<ol>
<li>同步源上的Current UUID保持不变</li>
<li>同步源上的Bitmap UUID轮转到第一个历史UUID，第一历史UUID替换第二历史UUID（任何已存在的第二历史UUID将被丢弃）</li>
<li>同步源上的Bitmap UUID将被清空（清零）</li>
<li>同步目标采用来自同步源的整个GI元组</li>
</ol>
<h3 id="DRBD如何使用GI"><a href="#DRBD如何使用GI" class="headerlink" title="DRBD如何使用GI"></a>DRBD如何使用GI</h3><p>当两个节点之间建立连接时，它们会交换当前可用的生成标识符，并相应地进行操作。可能有许多可能的结果：</p>
<ul>
<li>两个节点的Current UUID都为空<br>  本地节点检测到它自己和对等节点的当前UUID都为空。这是刚刚配置好的资源的正常情况，尚未启动初始完全同步。不会进行同步，必须手动启动。</li>
<li>一个节点的Current UUID为空<br>  本地节点检测到对等节点的Current UUID为空，而自己的不为空。这是刚刚配置好的资源的正常情况，初始全同步刚刚启动，本地节点被选为初始同步源。DRBD现在设置磁盘上同步位图中的所有位（意味着它认为整个设备不同步），并作为同步源开始同步。在相反的情况下（本地Current UUID为空，对等节点不为空），DRBD执行相同的步骤，只是本地节点变成同步目标。</li>
<li>Current UUID相等<br>  本地节点检测到其Current UUID和对等节点的Current UUID都不为空且相等。这是在资源处于从属角色时进入断开连接模式的资源的正常情况，且在断开连接期间没有在任一节点上进行晋升。不会进行同步，因为不需要同步。</li>
<li>Bitmap UUID与对等节点的Current UUID匹配<br>  本地节点检测到它的Bitmap UUID与对等节点的Current UUID匹配，而对等节点的Bitmap UUID为空。这是从属节点故障后的正常预期情况，本地节点处于主角色。这意味着对等节点在此期间从未变为主节点，并一直使用相同的数据生成基础。现在，DRBD会启动正常的后台重新同步，本地节点成为同步源。反之，如果本地节点检测到它的Bitmap UUID为空，并且对等节点的位图与本地节点的Current UUID匹配，那么这是本地节点故障后的正常预期情况。同样，DRBD现在启动正常的后台重新同步，本地节点成为同步目标。</li>
<li>Current UUID与对等节点的历史UUID匹配<br>  本地节点检测到它的Current UUID与对等节点的历史UUID之一匹配。这意味着尽管两个数据集共享一个共同的祖先，并且对等节点具有最新的数据，但在对等节点的位图中保留的信息已经过时且无法使用。因此，正常同步是不足够的。DRBD现在将整个设备标记为不同步，并启动完全后台重新同步，本地节点成为同步目标。在相反的情况（本地节点的历史 UUID 与对等节点的Current UUID匹配），DRBD 执行相同的步骤，只是本地节点成为同步源。</li>
<li>Bitmap UUID匹配，但Current UUID不匹配<br>  本地节点检测到其Current UUID与对等节点的Current UUID不同，但Bitmap UUID匹配。这是脑裂的情况，但数据生成具有相同的父级。这意味着如果已配置，DRBD 将调用脑裂自动恢复策略。否则，DRBD将断开连接并等待手动脑裂解决。</li>
<li>Current UUID 和Bitmap UUID 都不匹配<br>  本地节点检测到其Current UUID与对等节点的Current UUID不同，且Bitmap UUID也不匹配。这是不相关祖先代的脑裂，因此即使配置了自动恢复策略，也是无用的。DRBD断开连接并等待手动脑裂解决。</li>
<li>没有 UUID 匹配<br>  如果DRBD未能在两个节点的GI元组中检测到任何匹配的元素，它会记录关于不相关数据的警告并断开连接。这是DRBD防止意外连接两个之前从未听说过对方的集群节点的安全保障。</li>
</ul>
<h2 id="Activity-Log"><a href="#Activity-Log" class="headerlink" title="Activity Log"></a>Activity Log</h2><p>在一个写操作期间，DRBD将写操作转发到本地后备块设备，但也通过网络发送数据块。这两个操作实际上都是同时进行的。随机的时序行为可能会导致这样一种情况：写操作已经完成，但网络传输尚未完成。如果此时活动节点失败并启动故障转移，则这个数据块在节点之间是不同步的——在崩溃之前已在失败的节点上写入，但复制尚未完成。因此，当节点最终恢复时，这个块必须在随后的同步期间从数据集中删除。否则，崩溃的节点将“领先于”存活的节点，这将违反复制存储的“全部或无”的原则。这不仅是DRBD所特有的问题，在实际上所有的复制存储配置中都存在这个问题。许多其他存储解决方案（就像DRBD本身在0.7版本之前）要求在活动节点失败后，该节点必须在恢复后进行完全同步。</p>
<p>DRBD自0.7版本之后。在元数据区域存储活动日志（Activity Log）跟踪了“最近”已经写入的那些块。俗称，这些区域被称为热区段。如果一个临时失败的处于活动模式的节点进行同步，只有在AL中突出显示的那些热区段需要进行同步，而不需要同步整个设备。这大大减少了在活动节点崩溃后进行同步所需的时间。</p>
<h3 id="Activity-extents"><a href="#Activity-extents" class="headerlink" title="Activity extents"></a>Activity extents</h3><p>Activity Log由多个Activity extents组成。可通过资源配置文件中的<code>activity-log-size</code>参数进行配置，该参数表示Active extents数量，必须是2的幂，且范围通常在16到4096之间。每个Activity extents大小为4MiB。</p>
<p>保持大的活动日志可以提高写入吞吐量。每次激活新的扩展时，一个旧的扩展将被重置为非活动状态。这种转换需要向元数据区域写入一个操作。如果活动扩展数很高，旧的活动扩展很少被交换出，从而减少了元数据写操作，从而提高了性能。</p>
<p>保持小的活动日志可以缩短在主节点失败和随后的恢复后的同步时间。</p>
<h3 id="选择一个合适Activity-Log-Size"><a href="#选择一个合适Activity-Log-Size" class="headerlink" title="选择一个合适Activity Log Size"></a>选择一个合适Activity Log Size</h3><p><img src="/images/drbd/al-extents.png" alt="al-extents.png"></p>
<ul>
<li><code>R</code>是同步速度（单位：MB&#x2F;s）</li>
<li><code>tsync</code>是同步时间（单位：s）</li>
<li><code>E</code>是Active extents数量</li>
</ul>
<p>DRBD是可以控制同步带宽的，使用<code>net</code>配置选项来控制DRBD在网络上使用的带宽。这个选项可以在DRBD配置文件中的全局段中设置，也可以在资源段中设置。</p>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">global &#123;</span><br><span class="line">    ...</span><br><span class="line">    net &#123;</span><br><span class="line">        max-rate 1G;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>max-rate</code>选项将同步带宽限制为1Gbit&#x2F;s。您可以将该选项设置为所需的速率，以控制DRBD在网络上使用的带宽。</p>
<h2 id="Quick-sync-Bitmap"><a href="#Quick-sync-Bitmap" class="headerlink" title="Quick-sync Bitmap"></a>Quick-sync Bitmap</h2><p>Quick-sync Bitmap是 DRBD 在每个资源上使用的内部数据结构，用于跟踪块是否同步（在两个节点上相同）或不同步。它仅在资源处于断开模式时才相关。在Quick-sync Bitmap中，一个比特表示一个 4KiB 的磁盘数据块。如果该位被清除，则意味着相应的块仍与对等节点同步。这意味着该块自断开连接以来尚未被写入。相反，如果该位被设置，则意味着该块已被修改，并且在连接再次可用时需要重新同步。</p>
<p>当 DRBD 检测到断开的设备上的写 I&#x2F;O 时，因此开始在Quick-sync Bitmap中设置位，它在 RAM 中执行此操作，从而避免了昂贵的同步元数据 I&#x2F;O 操作。只有当相应的块变得“冷”（从活动日志中过期）时，DRBD 才会在Quick-sync Bitmap的磁盘表示中进行适当的修改。同样，如果在断开连接的同时手动关闭了剩余节点上的资源，则 DRBD 将完整的Quick-sync Bitmap刷新到持久存储中。当对等节点恢复或重新建立连接时，DRBD 将结合两个节点的位图信息，确定必须重新同步的总数据集。同时，DRBD 检查生成标识符以确定同步方向。</p>
<p>充当同步源的节点然后将协商好的块传输到对等节点，在同步目标确认修改时清除同步位。如果重新同步现在被中断（例如，由于另一个网络故障），然后继续恢复，它将在离开时继续进行 - 当然，同时修改的任何其他块都将添加到重新同步数据集中。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxprobe/p/5381538.html">一张图让你学会LVM</a></li>
<li><a target="_blank" rel="noopener" href="https://linbit.com/drbd-user-guide/users-guide-drbd-8-4/#ch-internals">linbit</a></li>
<li><a target="_blank" rel="noopener" href="https://chat.openai.com/">chatgpt</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2022/11/07/blockchain/ethereum/eth-helloworld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/07/blockchain/ethereum/eth-helloworld/" class="post-title-link" itemprop="url">Hello Ethereum</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-07 16:00:21" itemprop="dateCreated datePublished" datetime="2022-11-07T16:00:21+08:00">2022-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-25 10:59:23" itemprop="dateModified" datetime="2024-11-25T10:59:23+08:00">2024-11-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>问：写一个以太坊智能合约helloworld总共分几步？<br>答：三步，第一步创建以太坊服务环境；第二步撰写、编译、部署helloworld智能合约；第三步运行智能合约</p>
<h1 id="部署Ethereum环境"><a href="#部署Ethereum环境" class="headerlink" title="部署Ethereum环境"></a>部署Ethereum环境</h1><p>本人使用docker搭建Ethereum环境，拉取<code>ubuntu:20.04</code>镜像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull --platform linux/amd64 ubuntu:20.04</span><br></pre></td></tr></table></figure>

<p>然后，创建容器并开始安装Ethereum</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name eth_server --net host ubuntu:20.04 /bin/bash</span><br><span class="line">docker run -it --net bridge -p 8545:8545 -p 8551:8551 --name eth_server ubuntu:20.04 /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="安装Ethereum"><a href="#安装Ethereum" class="headerlink" title="安装Ethereum"></a>安装Ethereum</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt update -y</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install -y software-properties-common</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">add-apt-repository -y ppa:ethereum/ethereum</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt update -y</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install -y ethereum</span></span><br></pre></td></tr></table></figure>

<p>安装成功后，确认一下eth版本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth version</span></span><br><span class="line">Geth</span><br><span class="line">Version: 1.10.26-stable</span><br><span class="line">Git Commit: e5eb32acee19cc9fca6a03b10283b7484246b15a</span><br><span class="line">Architecture: amd64</span><br><span class="line">Go Version: go1.18.5</span><br><span class="line">Operating System: linux</span><br><span class="line">GOPATH=</span><br><span class="line">GOROOT=go</span><br></pre></td></tr></table></figure>

<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h3><p>创建一个<code>genesis.json</code>的文件，填充如下内容。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;chainId&quot;</span><span class="punctuation">:</span> <span class="number">110</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;homesteadBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;byzantiumBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;constantinopleBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;eip150Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;eip155Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;eip158Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;difficulty&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gasLimit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2100000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;alloc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化Ethereum数据"><a href="#初始化Ethereum数据" class="headerlink" title="初始化Ethereum数据"></a>初始化Ethereum数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth --datadir ./eth-data --allow-insecure-unlock --http --http.addr 172.17.0.2 --http.api <span class="string">&quot;admin,debug,web3,eth,txpool,personal,ethash,miner,net&quot;</span> --http.corsdomain <span class="string">&quot;*&quot;</span> --dev init genesis.json</span></span><br><span class="line">INFO [11-07|16:04:14.139] Maximum peer count                       ETH=50 LES=0 total=50</span><br><span class="line">INFO [11-07|16:04:14.151] Smartcard socket not found, disabling    err=&quot;stat /run/pcscd/pcscd.comm: no such file or directory&quot;</span><br><span class="line">INFO [11-07|16:04:14.179] Set global gas cap                       cap=50,000,000</span><br><span class="line">INFO [11-07|16:04:14.190] Allocated cache and file handles         database=/root/eth-data/geth/chaindata cache=16.00MiB handles=16</span><br><span class="line">INFO [11-07|16:04:14.224] Opened ancient database                  database=/root/eth-data/geth/chaindata/ancient/chain readonly=false</span><br><span class="line">INFO [11-07|16:04:14.226] Writing custom genesis block</span><br><span class="line">INFO [11-07|16:04:14.230] Persisted trie from memory database      nodes=0 size=0.00B time=&quot;347µs&quot; gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B</span><br><span class="line">INFO [11-07|16:04:14.238] Successfully wrote genesis state         database=chaindata                     hash=a697c6..9bf39b</span><br><span class="line">INFO [11-07|16:04:14.238] Allocated cache and file handles         database=/root/eth-data/geth/lightchaindata cache=16.00MiB handles=16</span><br><span class="line">INFO [11-07|16:04:14.259] Opened ancient database                  database=/root/eth-data/geth/lightchaindata/ancient/chain readonly=false</span><br><span class="line">INFO [11-07|16:04:14.259] Writing custom genesis block</span><br><span class="line">INFO [11-07|16:04:14.261] Persisted trie from memory database      nodes=0 size=0.00B time=&quot;21.917µs&quot; gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B</span><br><span class="line">INFO [11-07|16:04:14.262] Successfully wrote genesis state         database=lightchaindata                     hash=a697c6..9bf39b</span><br></pre></td></tr></table></figure>

<h2 id="启动节点"><a href="#启动节点" class="headerlink" title="启动节点"></a>启动节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth --datadir ./eth-data --networkid 110 --allow-insecure-unlock --http --http.addr 172.17.0.2 --http.api <span class="string">&quot;admin,debug,web3,eth,txpool,personal,ethash,miner,net&quot;</span> --http.corsdomain <span class="string">&quot;*&quot;</span> --dev</span></span><br><span class="line">INFO [11-07|16:14:23.231] Starting Geth in ephemeral dev mode...</span><br><span class="line">WARN [11-07|16:14:23.234] You are running Geth in --dev mode. Please note the following:</span><br><span class="line"></span><br><span class="line">  1. This mode is only intended for fast, iterative development without assumptions on</span><br><span class="line">     security or persistence.</span><br><span class="line">  2. The database is created in memory unless specified otherwise. Therefore, shutting down</span><br><span class="line">     your computer or losing power will wipe your entire block data and chain state for</span><br><span class="line">     your dev environment.</span><br><span class="line">  3. A random, pre-allocated developer account will be available and unlocked as</span><br><span class="line">     eth.coinbase, which can be used for testing. The random dev account is temporary,</span><br><span class="line">     stored on a ramdisk, and will be lost if your machine is restarted.</span><br><span class="line">  4. Mining is enabled by default. However, the client will only seal blocks if transactions</span><br><span class="line">     are pending in the mempool. The miner&#x27;s minimum accepted gas price is 1.</span><br><span class="line">  5. Networking is disabled; there is no listen-address, the maximum number of peers is set</span><br><span class="line">     to 0, and discovery is disabled.</span><br><span class="line">INFO [11-07|16:14:23.251] Maximum peer count                       ETH=50 LES=0 total=50</span><br><span class="line">INFO [11-07|16:14:23.261] Smartcard socket not found, disabling    err=&quot;stat /run/pcscd/pcscd.comm: no such file or directory&quot;</span><br><span class="line">INFO [11-07|16:14:23.291] Set global gas cap                       cap=50,000,000</span><br><span class="line">INFO [11-07|16:14:23.649] Using developer account                  address=0xA9CB6DB62D6673ae5CD79D0d29796Dd9DF1d1A5e</span><br><span class="line">INFO [11-07|16:14:23.652] Allocated cache and file handles         database=/root/eth-data/geth/chaindata cache=512.00MiB handles=524,288 readonly=true</span><br><span class="line">INFO [11-07|16:14:23.675] Opened ancient database                  database=/root/eth-data/geth/chaindata/ancient/chain readonly=true</span><br><span class="line">INFO [11-07|16:14:23.691] Allocated trie memory caches             clean=154.00MiB dirty=256.00MiB</span><br><span class="line">INFO [11-07|16:14:23.691] Allocated cache and file handles         database=/root/eth-data/geth/chaindata cache=512.00MiB handles=524,288</span><br><span class="line">INFO [11-07|16:14:23.756] Opened ancient database                  database=/root/eth-data/geth/chaindata/ancient/chain readonly=false</span><br><span class="line">INFO [11-07|16:14:23.763]</span><br><span class="line">INFO [11-07|16:14:23.764] ---------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">INFO [11-07|16:14:23.764] Chain ID:  110 (unknown)</span><br><span class="line">INFO [11-07|16:14:23.764] Consensus: unknown</span><br><span class="line">INFO [11-07|16:14:23.764]</span><br><span class="line">INFO [11-07|16:14:23.765] Pre-Merge hard forks:</span><br><span class="line">INFO [11-07|16:14:23.765]  - Homestead:                   0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/homestead.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Tangerine Whistle (EIP 150): 0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/tangerine-whistle.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Spurious Dragon/1 (EIP 155): 0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/spurious-dragon.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Spurious Dragon/2 (EIP 158): 0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/spurious-dragon.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Byzantium:                   &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/byzantium.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Constantinople:              &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/constantinople.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Petersburg:                  &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/petersburg.md)</span><br><span class="line">INFO [11-07|16:14:23.766]  - Istanbul:                    &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/istanbul.md)</span><br><span class="line">INFO [11-07|16:14:23.766]  - Berlin:                      &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/berlin.md)</span><br><span class="line">INFO [11-07|16:14:23.766]  - London:                      &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/london.md)</span><br><span class="line">INFO [11-07|16:14:23.766]</span><br><span class="line">INFO [11-07|16:14:23.766] The Merge is not yet available for this network!</span><br><span class="line">INFO [11-07|16:14:23.766]  - Hard-fork specification: https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/paris.md</span><br><span class="line">INFO [11-07|16:14:23.766] ---------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">INFO [11-07|16:14:23.766]</span><br><span class="line">INFO [11-07|16:14:23.768] Disk storage enabled for ethash caches   dir=/root/eth-data/geth/ethash count=3</span><br><span class="line">INFO [11-07|16:14:23.768] Disk storage enabled for ethash DAGs     dir=/root/.ethash              count=2</span><br><span class="line">INFO [11-07|16:14:23.769] Initialising Ethereum protocol           network=1337 dbversion=8</span><br><span class="line">INFO [11-07|16:14:23.779] Loaded most recent local header          number=0 hash=a697c6..9bf39b td=0 age=53y7mo1w</span><br><span class="line">INFO [11-07|16:14:23.780] Loaded most recent local full block      number=0 hash=a697c6..9bf39b td=0 age=53y7mo1w</span><br><span class="line">INFO [11-07|16:14:23.780] Loaded most recent local fast block      number=0 hash=a697c6..9bf39b td=0 age=53y7mo1w</span><br><span class="line">INFO [11-07|16:14:23.786] Loaded local transaction journal         transactions=0 dropped=0</span><br><span class="line">INFO [11-07|16:14:23.786] Regenerated local transaction journal    transactions=0 accounts=0</span><br><span class="line">INFO [11-07|16:14:23.791] Gasprice oracle is ignoring threshold set threshold=2</span><br><span class="line">WARN [11-07|16:14:23.798] Engine API enabled                       protocol=eth</span><br><span class="line">WARN [11-07|16:14:23.798] Engine API started but chain not configured for merge yet</span><br><span class="line">INFO [11-07|16:14:23.802] Starting peer-to-peer node               instance=Geth/v1.10.26-stable-e5eb32ac/linux-amd64/go1.18.5</span><br><span class="line">WARN [11-07|16:14:23.802] P2P server will be useless, neither dialing nor listening</span><br><span class="line">INFO [11-07|16:14:23.843] New local node record                    seq=1,667,808,816,313 id=321fce2047223769 ip=127.0.0.1 udp=0 tcp=0</span><br><span class="line">INFO [11-07|16:14:23.844] Started P2P networking                   self=enode://2d0246c1dd51623d6d8a8581095c033542366037b1e20ff815ad045af396de50df60f4aa9556148c2f4a89673bad5cab5c2ab22f3075d5bacba1b2fbebaf72e5@127.0.0.1:0</span><br><span class="line">INFO [11-07|16:14:23.848] IPC endpoint opened                      url=/root/eth-data/geth.ipc</span><br><span class="line">INFO [11-07|16:14:23.852] Loaded JWT secret file                   path=/root/eth-data/geth/jwtsecret crc32=0xef39c4cb</span><br><span class="line">INFO [11-07|16:14:23.856] HTTP server started                      endpoint=172.17.0.2:8545 auth=false prefix= cors= vhosts=localhost</span><br><span class="line">INFO [11-07|16:14:23.862] WebSocket enabled                        url=ws://127.0.0.1:8551</span><br><span class="line">INFO [11-07|16:14:23.862] HTTP server started                      endpoint=127.0.0.1:8551    auth=true  prefix= cors=localhost vhosts=localhost</span><br><span class="line">INFO [11-07|16:14:23.868] Transaction pool price threshold updated price=0</span><br><span class="line">INFO [11-07|16:14:23.868] Updated mining threads                   threads=0</span><br><span class="line">INFO [11-07|16:14:23.868] Transaction pool price threshold updated price=1</span><br><span class="line">INFO [11-07|16:14:23.868] Etherbase automatically configured       address=0xA9CB6DB62D6673ae5CD79D0d29796Dd9DF1d1A5e</span><br><span class="line">INFO [11-07|16:14:23.875] Commit new sealing work                  number=1 sealhash=6ca53b..19dc17 uncles=0 txs=0 gas=0 fees=0 elapsed=6.285ms</span><br><span class="line">INFO [11-07|16:14:23.877] Commit new sealing work                  number=1 sealhash=6ca53b..19dc17 uncles=0 txs=0 gas=0 fees=0 elapsed=8.056ms</span><br></pre></td></tr></table></figure>

<h3 id="networkid"><a href="#networkid" class="headerlink" title="networkid"></a>networkid</h3><p><code>--networkid</code>参数需要与<code>genesis.json</code>配置文件中的<code>chainId</code>值一致。</p>
<h3 id="http-api"><a href="#http-api" class="headerlink" title="http.api"></a>http.api</h3><p>若<code>--http.api</code>设置错误会出现如下错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR[11-07|16:13:36.346] Unavailable modules in HTTP API list     unavailable=[db] available=&quot;[admin debug web3 eth txpool personal ethash miner net]&quot;</span><br></pre></td></tr></table></figure>
<p>需要按照<code>available</code>中规定的内容进行配置<code>--http.api</code>参数。</p>
<h2 id="attach交互"><a href="#attach交互" class="headerlink" title="attach交互"></a>attach交互</h2><p>接下来需要attach到以太坊节点，在geth节点启动过程中有这样一条日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO [11-07|16:14:23.848] IPC endpoint opened                      url=/root/eth-data/geth.ipc</span><br></pre></td></tr></table></figure>
<p>没错，你猜对了，就是要用这个endpoint进行attach</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth attach ipc:/root/eth-data/geth.ipc</span></span><br><span class="line">Welcome to the Geth JavaScript console!</span><br><span class="line"></span><br><span class="line">instance: Geth/v1.10.26-stable-e5eb32ac/linux-amd64/go1.18.5</span><br><span class="line">coinbase: 0xa9cb6db62d6673ae5cd79d0d29796dd9df1d1a5e</span><br><span class="line">at block: 0 (Thu Jan 01 1970 08:00:00 GMT+0800 (CST))</span><br><span class="line"> datadir: /root/eth-data</span><br><span class="line"> modules: admin:1.0 debug:1.0 engine:1.0 eth:1.0 ethash:1.0 miner:1.0 net:1.0 personal:1.0 rpc:1.0 txpool:1.0 web3:1.0</span><br><span class="line"></span><br><span class="line">To exit, press ctrl-d or type exit</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来的<code>创建用户</code>、<code>挖矿</code>等操作都需要在attach状态下进行。</p>
<h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><p>使用<code>personal.newAccout</code>创建用户，然后可以使用<code>eth.accounts</code>查看用户列表。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.accounts</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">[<span class="string">&quot;0xa9cb6db62d6673ae5cd79d0d29796dd9df1d1a5e&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">personal.newAccount()</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Passphrase:</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Repeat passphrase:</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="string">&quot;0x00e70f2bd5a644cdf4432f886bf25473cbe620ac&quot;</span></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.accounts</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">[<span class="string">&quot;0xa9cb6db62d6673ae5cd79d0d29796dd9df1d1a5e&quot;</span>, <span class="string">&quot;0x00e70f2bd5a644cdf4432f886bf25473cbe620ac&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>若不解锁用户，部署会提示错误<code>creation of HelloWorld errored: authentication needed: password or unlock</code>。解锁用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">personal.unlockAccount(eth.accounts[1])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Unlock account 0x00e70f2bd5a644cdf4432f886bf25473cbe620ac</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Passphrase:</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="literal">true</span></span></span><br></pre></td></tr></table></figure>

<h2 id="挖矿"><a href="#挖矿" class="headerlink" title="挖矿"></a>挖矿</h2><p>使用<code>miner.start()</code>开始挖矿；使用<code>miner.stop()</code>停止挖矿。</p>
<p>开始挖矿后，当出现如下日志信息时，说明挖到了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INFO [11-07|17:59:54.021] Successfully sealed new block            number=1 sealhash=84eaaa..f4d2c5 hash=925c9a..d8cb75 elapsed=1h30m51.894s</span><br><span class="line">INFO [11-07|17:59:54.022] 🔨 mined potential block                  number=1 hash=925c9a..d8cb75</span><br><span class="line">INFO [11-07|17:59:54.026] Commit new sealing work                  number=2 sealhash=865003..0e32da uncles=0 txs=0 gas=0 fees=0 elapsed=1.991ms</span><br><span class="line">INFO [11-07|17:59:54.027] Commit new sealing work                  number=2 sealhash=865003..0e32da uncles=0 txs=0 gas=0 fees=0 elapsed=3.070ms</span><br><span class="line">INFO [11-07|17:59:54.428] Generating DAG in progress               epoch=1 percentage=0  elapsed=3.563s</span><br><span class="line">INFO [11-07|17:59:56.581] Successfully sealed new block            number=2 sealhash=865003..0e32da hash=f1224d..9dc4b8 elapsed=2.554s</span><br><span class="line">INFO [11-07|17:59:56.582] 🔨 mined potential block                  number=2 hash=f1224d..9dc4b8</span><br><span class="line">INFO [11-07|17:59:56.584] Commit new sealing work                  number=3 sealhash=8de6d6..c8886e uncles=0 txs=0 gas=0 fees=0 elapsed=&quot;906.417µs&quot;</span><br><span class="line">INFO [11-07|17:59:56.585] Commit new sealing work                  number=3 sealhash=8de6d6..c8886e uncles=0 txs=0 gas=0 fees=0 elapsed=2.271ms</span><br><span class="line">INFO [11-07|17:59:57.730] Successfully sealed new block            number=3 sealhash=8de6d6..c8886e hash=42a018..4e7ef3 elapsed=1.146s</span><br><span class="line">INFO [11-07|17:59:57.731] 🔨 mined potential block                  number=3 hash=42a018..4e7ef3</span><br><span class="line">INFO [11-07|17:59:57.733] Commit new sealing work                  number=4 sealhash=26af07..609e57 uncles=0 txs=0 gas=0 fees=0 elapsed=1.165ms</span><br></pre></td></tr></table></figure>

<p>此时使用<code>eth.blockNumber</code>可以查看到当前区块数量，使用<code>eth.getBalance(eth.accounts[0])</code>查看默认用户余额，同理使用<code>eth.getBalance(eth.accounts[1])</code>查看我们创建的用户的余额。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.getBalance(eth.accounts[0])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">25000000000000000000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.getBalance(eth.accounts[1])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">0</span></span><br></pre></td></tr></table></figure>

<p>挖到的奖励都进了默认账户了，我们新建的账户里木有哦。来给我转账吧，嘿嘿嘿….</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.sendTransaction(&#123;from:eth.accounts[0],to:eth.accounts[1],value:web3.toWei(10,<span class="string">&#x27;ether&#x27;</span>)&#125;)</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="string">&quot;0x244da771baf2bd65e5e040c33ee3047b57a2492b85d271564bc90ccd7cb4fa46&quot;</span></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.getBalance(eth.accounts[1])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">5000000000000000000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">&gt; eth.getBalance(eth.accounts[0])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">1.535e+21</span></span><br></pre></td></tr></table></figure>

<p>哇哦，又挖到矿了。</p>
<h1 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h1><p>环境搭建好了，现在开始编写智能合约。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// compiler version must be greater than or equal to 0.8.13 and less than 0.9.0</span><br><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity 0.8.13;</span><br><span class="line">contract HelloWorld &#123;</span><br><span class="line">    function sayHelloWorld() public returns (string memory) &#123;</span><br><span class="line">        return &quot;Hello World&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Remix"><a href="#Remix" class="headerlink" title="Remix"></a>Remix</h2><p>在这里获<a target="_blank" rel="noopener" href="https://remix-project.org/">Remix</a></p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p><img src="/images/blockchain/solidity_remix_compile.jpg" alt="solidity_remix_compile"></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>点击部署，然后选择外部http provider，并配置我们搭建好的ethereum服务。</p>
<p><img src="/images/blockchain/solidity_remix_deploy_setting_1.jpg" alt="solidity_remix_deploy_setting_1.jpg"></p>
<p><img src="/images/blockchain/solidity_remix_deploy_setting_2.jpg" alt="solidity_remix_deploy_setting_2.jpg"></p>
<p>接下中，选择我们创建好的账户，然后进行部署。</p>
<p><img src="/images/blockchain/solidity_remix_deploy.jpg" alt="solidity_remix_deploy.jpg"></p>
<p><img src="/images/blockchain/solidity_remix_deploy_log.jpg" alt="solidity_remix_deploy_log.jpg"></p>
<h2 id="执行智能合约"><a href="#执行智能合约" class="headerlink" title="执行智能合约"></a>执行智能合约</h2><p>执行智能合约可以选择在Remix中执行，也可选择attach到eth_server控制台执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">abi =[&#123;<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;sayHelloWorld&quot;</span>,<span class="string">&quot;outputs&quot;</span>:[&#123;<span class="string">&quot;internalType&quot;</span>:<span class="string">&quot;string&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;string&quot;</span>&#125;],<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;function&quot;</span>&#125;]</span></span><br><span class="line">[&#123;</span><br><span class="line">    inputs: [],</span><br><span class="line">    name: &quot;sayHelloWorld&quot;,</span><br><span class="line">    outputs: [&#123;</span><br><span class="line">        internalType: &quot;string&quot;,</span><br><span class="line">        name: &quot;&quot;,</span><br><span class="line">        type: &quot;string&quot;</span><br><span class="line">    &#125;],</span><br><span class="line">    stateMutability: &quot;nonpayable&quot;,</span><br><span class="line">    type: &quot;function&quot;</span><br><span class="line">&#125;]</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">hello=eth.contract(abi).at(<span class="string">&#x27;0xCB1B01B40CD752F5d42f5b8dCeE4BE2A637CaAf2&#x27;</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  abi: [&#123;</span><br><span class="line">      inputs: [],</span><br><span class="line">      name: &quot;sayHelloWorld&quot;,</span><br><span class="line">      outputs: [&#123;...&#125;],</span><br><span class="line">      stateMutability: &quot;nonpayable&quot;,</span><br><span class="line">      type: &quot;function&quot;</span><br><span class="line">  &#125;],</span><br><span class="line">  address: &quot;0xCB1B01B40CD752F5d42f5b8dCeE4BE2A637CaAf2&quot;,</span><br><span class="line">  transactionHash: null,</span><br><span class="line">  allEvents: function bound(),</span><br><span class="line">  sayHelloWorld: function bound()</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">hello.sayHelloWorld.call()</span></span><br><span class="line">&quot;Hello World&quot;</span><br></pre></td></tr></table></figure>

<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6e739550a349">智能合约 hello world</a></li>
<li><a target="_blank" rel="noopener" href="https://haofly.net/geth/">Geth 搭建私链 private blockchain</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42822207/article/details/120620731">【geth】Go语言调用智能合约 | 一起来学区块链</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/12/18/storage/ceph/ceph-encode-decode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/18/storage/ceph/ceph-encode-decode/" class="post-title-link" itemprop="url">encode和decode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-18 15:12:12" itemprop="dateCreated datePublished" datetime="2021-12-18T15:12:12+08:00">2021-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">object_t</span> &#123;</span><br><span class="line">  std::string name;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">encode</span><span class="params">(ceph::buffer::list &amp;bl)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ceph::encode;</span><br><span class="line">    <span class="built_in">encode</span>(name, bl);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">decode</span><span class="params">(ceph::buffer::list::const_iterator &amp;bl)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ceph::decode;</span><br><span class="line">    <span class="built_in">decode</span>(name, bl);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">WRITE_CLASS_ENCODER</span>(<span class="type">object_t</span>)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;object.h ***</p>
<p>对于Ceph中的每一种需要存储的资源在进行存储前都要进行<code>encode</code>操作，然后再将其写入硬盘。对于读取同样，在从硬盘获取到数据后需要进行<code>decode</code>操作。而每种需要存储资源如何<code>encode</code>和<code>decode</code>当然要由资源自己来决定。所以在资源的<code>class</code>或<code>struct</code>中要实现<code>encode</code>和<code>decode</code>方法。</p>
<p><code>WRITE_CLASS_ENCODER(object_t)</code>干了些啥呢。。。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// see denc.h for ENCODE_DUMP_PATH discussion and definition.</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ENCODE_DUMP_PATH</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_PRE()                      \</span></span><br><span class="line"><span class="meta">  unsigned pre_off = bl.length()</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_POST(cl)                                           \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                  \</span></span><br><span class="line"><span class="meta">    static int i = 0;                                                   \</span></span><br><span class="line"><span class="meta">    i++;                                                                \</span></span><br><span class="line"><span class="meta">    int bits = 0;                                                       \</span></span><br><span class="line"><span class="meta">    for (unsigned t = i; t; bits++)                                     \</span></span><br><span class="line"><span class="meta">      t &amp;= t - 1;                                                       \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (bits &gt; 2)                                                       \</span></span><br><span class="line"><span class="meta">      break;                                                            \</span></span><br><span class="line"><span class="meta">    char fn[PATH_MAX];                                                  \</span></span><br><span class="line"><span class="meta">    snprintf(fn, sizeof(fn), ENCODE_STRINGIFY(ENCODE_DUMP_PATH) <span class="string">&quot;/%s__%d.%x&quot;</span>, #cl, getpid(), i++); \</span></span><br><span class="line"><span class="meta">    int fd = ::open(fn, O_WRONLY|O_TRUNC|O_CREAT|O_CLOEXEC|O_BINARY, 0644);             \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (fd &gt;= 0) &#123;                                                      \</span></span><br><span class="line"><span class="meta">      ::ceph::bufferlist sub;                                           \</span></span><br><span class="line"><span class="meta">      sub.substr_of(bl, pre_off, bl.length() - pre_off);                \</span></span><br><span class="line"><span class="meta">      sub.write_fd(fd);                                                 \</span></span><br><span class="line"><span class="meta">      ::close(fd);                                                      \</span></span><br><span class="line"><span class="meta">    &#125;                                                                   \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_PRE()</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_POST(cl)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_CLASS_ENCODER(cl)                                         \</span></span><br><span class="line"><span class="meta">  inline void encode(const cl&amp; c, ::ceph::buffer::list &amp;bl, uint64_t features=0) &#123; \</span></span><br><span class="line"><span class="meta">    ENCODE_DUMP_PRE(); c.encode(bl); ENCODE_DUMP_POST(cl); &#125;            \</span></span><br><span class="line"><span class="meta">  inline void decode(cl &amp;c, ::ceph::bufferlist::const_iterator &amp;p) &#123; c.decode(p); &#125;</span></span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>看了上面的代码应该能了解到<code>WRITE_CLASS_ENCODER(object_t)</code>是对<code>encode</code>和<code>decode</code>函数的重载。这是入口，然后再调用其资源自身<code>encode</code>或<code>decode</code>方法。</p>
<p>那么对于一些基础类型（如：int、string等）是如果<code>encode</code>和<code>decode</code>的呢？</p>
<h3 id="int类型"><a href="#int类型" class="headerlink" title="int类型"></a>int类型</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// int types</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_INTTYPE_ENCODER(type, etype)                              \</span></span><br><span class="line"><span class="meta">  inline void encode(type v, ::ceph::bufferlist&amp; bl, uint64_t features=0) &#123; \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    e = v;                                                              \</span></span><br><span class="line"><span class="meta">    ::ceph::encode_raw(e, bl);                                          \</span></span><br><span class="line"><span class="meta">  &#125;                                                                     \</span></span><br><span class="line"><span class="meta">  inline void decode(type &amp;v, ::ceph::bufferlist::const_iterator&amp; p) &#123;  \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    ::ceph::decode_raw(e, p);                                           \</span></span><br><span class="line"><span class="meta">    v = e;                                                              \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">uint64_t</span>, le64)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">int64_t</span>, le64)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">uint32_t</span>, le32)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">int32_t</span>, le32)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">uint16_t</span>, le16)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">int16_t</span>, le16)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>int类型的<code>encode</code>和<code>decode</code>又调用了<code>encode_raw</code>和<code>decode_raw</code>。真是一层套一层啊～（俄罗斯套娃嘛）～</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// base types</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode_raw</span><span class="params">(<span class="type">const</span> T&amp; t, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  bl.<span class="built_in">append</span>((<span class="type">char</span>*)&amp;t, <span class="built_in">sizeof</span>(t));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">decode_raw</span><span class="params">(T&amp; t, bufferlist::const_iterator &amp;p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  p.<span class="built_in">copy</span>(<span class="built_in">sizeof</span>(t), (<span class="type">char</span>*)&amp;t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_RAW_ENCODER(type)                                         \</span></span><br><span class="line"><span class="meta">  inline void encode(const type &amp;v, ::ceph::bufferlist&amp; bl, uint64_t features=0) &#123; ::ceph::encode_raw(v, bl); &#125; \</span></span><br><span class="line"><span class="meta">  inline void decode(type &amp;v, ::ceph::bufferlist::const_iterator&amp; p) &#123; ::ceph::decode_raw(v, p); &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(__u8)</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CHAR_IS_SIGNED</span></span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(__s8)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(<span class="type">char</span>)</span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(ceph_le64)</span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(ceph_le32)</span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(ceph_le16)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>base比较简单，就是无论int几个字节，都是从低到高一个字节一个字节的写下去，再一个字节一个字节的读出来。。。</p>
<h3 id="float类型"><a href="#float类型" class="headerlink" title="float类型"></a>float类型</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_FLTTYPE_ENCODER(type, itype, etype)                       \</span></span><br><span class="line"><span class="meta">  static_assert(sizeof(type) == sizeof(itype));                         \</span></span><br><span class="line"><span class="meta">  static_assert(std::numeric_limits<span class="string">&lt;type&gt;</span>::is_iec559,                   \</span></span><br><span class="line"><span class="meta">              <span class="string">&quot;floating-point type not using IEEE754 format&quot;</span>);          \</span></span><br><span class="line"><span class="meta">  inline void encode(type v, ::ceph::bufferlist&amp; bl, uint64_t features=0) &#123; \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    e = *reinterpret_cast<span class="string">&lt;itype *&gt;</span>(&amp;v);                                 \</span></span><br><span class="line"><span class="meta">    ::ceph::encode_raw(e, bl);                                          \</span></span><br><span class="line"><span class="meta">  &#125;                                                                     \</span></span><br><span class="line"><span class="meta">  inline void decode(type &amp;v, ::ceph::bufferlist::const_iterator&amp; p) &#123;  \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    ::ceph::decode_raw(e, p);                                           \</span></span><br><span class="line"><span class="meta">    *reinterpret_cast<span class="string">&lt;itype *&gt;</span>(&amp;v) = e;                                 \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">WRITE_FLTTYPE_ENCODER</span>(<span class="type">float</span>, <span class="type">uint32_t</span>, le32)</span><br><span class="line"><span class="built_in">WRITE_FLTTYPE_ENCODER</span>(<span class="type">double</span>, <span class="type">uint64_t</span>, le64)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>float类型关键在于<code>reinterpret_cast</code>将一个浮点数转换为整数。<a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/language/reinterpret_cast">更多关于<code>reinterpret_cast</code>的内容</a></p>
<h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// string</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode</span><span class="params">(std::string_view s, bufferlist&amp; bl, <span class="type">uint64_t</span> features=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __u32 len = s.<span class="built_in">length</span>();</span><br><span class="line">  <span class="built_in">encode</span>(len, bl);</span><br><span class="line">  <span class="keyword">if</span> (len)</span><br><span class="line">    bl.<span class="built_in">append</span>(s.<span class="built_in">data</span>(), len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode</span><span class="params">(<span class="type">const</span> std::string&amp; s, bufferlist&amp; bl, <span class="type">uint64_t</span> features=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">encode</span>(std::<span class="built_in">string_view</span>(s), bl, features);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">decode</span><span class="params">(std::string&amp; s, bufferlist::const_iterator&amp; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __u32 len;</span><br><span class="line">  <span class="built_in">decode</span>(len, p);</span><br><span class="line">  s.<span class="built_in">clear</span>();</span><br><span class="line">  p.<span class="built_in">copy</span>(len, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode_nohead</span><span class="params">(std::string_view s, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  bl.<span class="built_in">append</span>(s.<span class="built_in">data</span>(), s.<span class="built_in">length</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode_nohead</span><span class="params">(<span class="type">const</span> std::string&amp; s, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">encode_nohead</span>(std::<span class="built_in">string_view</span>(s), bl);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">decode_nohead</span><span class="params">(<span class="type">int</span> len, std::string&amp; s, bufferlist::const_iterator&amp; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  s.<span class="built_in">clear</span>();</span><br><span class="line">  p.<span class="built_in">copy</span>(len, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// const char* (encode only, string compatible)</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">encode</span>(std::<span class="built_in">string_view</span>(s, <span class="built_in">strlen</span>(s)), bl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>string的<code>encode</code>和<code>decode</code>分两种，一种是有“害的”(head)，一种是无“害的”。有“害的”需要先记录string的长度，再记录string的内容；无“害的”直接记录内容，单再<code>decode</code>过程中需要制定长度。总之这个长度总要有个人来记。好鸡肋！</p>
<hr>
<p>整个的<code>encode</code>和<code>decode</code>的过程用到了一个<code>bufferlist</code>类型，那么这个<code>bufferlist</code>又是个什么结构呢，详细请见<a href="">ceph中的buffer</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/28/language/cpp/stl-container/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/28/language/cpp/stl-container/" class="post-title-link" itemprop="url">STL容器们</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-28 17:03:31" itemprop="dateCreated datePublished" datetime="2021-09-28T17:03:31+08:00">2021-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>c++中stl涉及到的容器类（或struct）有很多，具体都是什么原理呢？</p>
<h2 id="std-array"><a href="#std-array" class="headerlink" title="std::array"></a>std::array</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, std::<span class="type">size_t</span> _Nm&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">__array_traits</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">typedef</span> _Tp _Type[_Nm];</span><br><span class="line">        <span class="keyword">typedef</span> __is_swappable&lt;_Tp&gt; _Is_swappable;</span><br><span class="line">        <span class="keyword">typedef</span> __is_nothrow_swappable&lt;_Tp&gt; _Is_nothrow_swappable;</span><br><span class="line"></span><br><span class="line">        <span class="type">static</span> <span class="keyword">constexpr</span> _Tp&amp;</span><br><span class="line">        _S_ref(<span class="type">const</span> _Type&amp; <span class="type">__t</span>, std::<span class="type">size_t</span> __n) <span class="keyword">noexcept</span></span><br><span class="line">        &#123; <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;_Tp&amp;&gt;(<span class="type">__t</span>[__n]); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">static</span> <span class="keyword">constexpr</span> _Tp*</span><br><span class="line">        _S_ptr(<span class="type">const</span> _Type&amp; <span class="type">__t</span>) <span class="keyword">noexcept</span></span><br><span class="line">        &#123; <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;_Tp*&gt;(<span class="type">__t</span>); &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">......</span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, std::<span class="type">size_t</span> _Nm&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">array</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">typedef</span> _Tp                                     value_type;</span><br><span class="line">        <span class="keyword">typedef</span> value_type*                             pointer;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">const</span> value_type*                       const_pointer;</span><br><span class="line">        <span class="keyword">typedef</span> value_type&amp;                             reference;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">const</span> value_type&amp;                       const_reference;</span><br><span class="line">        <span class="keyword">typedef</span> value_type*                             iterator;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">const</span> value_type*                       const_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::<span class="type">size_t</span>                             size_type;</span><br><span class="line">        <span class="keyword">typedef</span> std::<span class="type">ptrdiff_t</span>                          difference_type;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;iterator&gt;         reverse_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;const_iterator&gt;   const_reverse_iterator;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Support for zero-sized arrays mandatory.</span></span><br><span class="line">        <span class="keyword">typedef</span> _GLIBCXX_STD_C::__array_traits&lt;_Tp, _Nm&gt; _AT_Type;</span><br><span class="line">        <span class="keyword">typename</span> _AT_Type::_Type                         _M_elems;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// No explicit construct/copy/destroy for aggregate type.</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>看这里<code>typename _AT_Type::_Type _M_elems;</code>再看这里<code>typedef _Tp _Type[_Nm];</code>。懂了吗，就是在栈上分配一个大小固定的数组。</p>
<h2 id="std-vector"><a href="#std-vector" class="headerlink" title="std::vector"></a>std::vector</h2><p><code>vector</code>也是一个数组，只是不是分配在栈上的，而是分配在堆上的。</p>
<p>看这里有一个<code>_Alloc</code>默认使用的是<code>std::allocator&lt;_Tp&gt;</code>，这就是在堆上分配内存用的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  @brief A standard container which offers fixed time access to</span></span><br><span class="line"><span class="comment">     *  individual elements in any order.</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  @ingroup sequences</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  @tparam _Tp  Type of element.</span></span><br><span class="line"><span class="comment">     *  @tparam _Alloc  Allocator type, defaults to allocator&lt;_Tp&gt;.</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  Meets the requirements of a &lt;a href=&quot;tables.html#65&quot;&gt;container&lt;/a&gt;, a</span></span><br><span class="line"><span class="comment">     *  &lt;a href=&quot;tables.html#66&quot;&gt;reversible container&lt;/a&gt;, and a</span></span><br><span class="line"><span class="comment">     *  &lt;a href=&quot;tables.html#67&quot;&gt;sequence&lt;/a&gt;, including the</span></span><br><span class="line"><span class="comment">     *  &lt;a href=&quot;tables.html#68&quot;&gt;optional sequence requirements&lt;/a&gt; with the</span></span><br><span class="line"><span class="comment">     *  %exception of @c push_front and @c pop_front.</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  In some terminology a %vector can be described as a dynamic</span></span><br><span class="line"><span class="comment">     *  C-style array, it offers fast and efficient access to individual</span></span><br><span class="line"><span class="comment">     *  elements in any order and saves the user from worrying about</span></span><br><span class="line"><span class="comment">     *  memory and size allocation.  Subscripting ( @c [] ) access is</span></span><br><span class="line"><span class="comment">     *  also provided as with C-style arrays.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc = std::allocator&lt;_Tp&gt; &gt;</span><br><span class="line">  <span class="keyword">class</span> vector : <span class="keyword">protected</span> _Vector_base&lt;_Tp, _Alloc&gt;</span><br><span class="line">  &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _GLIBCXX_CONCEPT_CHECKS</span></span><br><span class="line">    <span class="comment">// Concept requirements.</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc::value_type               _Alloc_value_type;</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __cplusplus &lt; 201103L</span></span><br><span class="line">    __glibcxx_class_requires(_Tp, _SGIAssignableConcept)</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">    __glibcxx_class_requires2(_Tp, _Alloc_value_type, _SameTypeConcept)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201103L</span></span><br><span class="line">    <span class="built_in">static_assert</span>(is_same&lt;<span class="keyword">typename</span> remove_cv&lt;_Tp&gt;::type, _Tp&gt;::value,</span><br><span class="line">        <span class="string">&quot;std::vector must have a non-const, non-volatile value_type&quot;</span>);</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __cplusplus &gt; 201703L || defined __STRICT_ANSI__</span></span><br><span class="line">    <span class="built_in">static_assert</span>(is_same&lt;<span class="keyword">typename</span> _Alloc::value_type, _Tp&gt;::value,</span><br><span class="line">        <span class="string">&quot;std::vector must have the same value_type as its allocator&quot;</span>);</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">typedef</span> _Vector_base&lt;_Tp, _Alloc&gt;                 _Base;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Base::_Tp_alloc_type            _Tp_alloc_type;</span><br><span class="line">    <span class="keyword">typedef</span> __gnu_cxx::__alloc_traits&lt;_Tp_alloc_type&gt; _Alloc_traits;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">typedef</span> _Tp                                       value_type;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Base::pointer                   pointer;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc_traits::const_pointer     const_pointer;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc_traits::reference         reference;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc_traits::const_reference   const_reference;</span><br><span class="line">        <span class="keyword">typedef</span> __gnu_cxx::__normal_iterator&lt;pointer, vector&gt; iterator;</span><br><span class="line">        <span class="keyword">typedef</span> __gnu_cxx::__normal_iterator&lt;const_pointer, vector&gt;</span><br><span class="line">        const_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;const_iterator&gt;     const_reverse_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;iterator&gt;           reverse_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">size_t</span>                                    size_type;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">ptrdiff_t</span>                                 difference_type;</span><br><span class="line">        <span class="keyword">typedef</span> _Alloc                                    allocator_type;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>再看这里定义了三个指针，用的是<code>typedef typename _Base::pointer pointer;</code>类型。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">&#123;</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_CONTAINER</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// See bits/stl_deque.h&#x27;s _Deque_base for an explanation.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_Vector_base</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> __gnu_cxx::__alloc_traits&lt;_Alloc&gt;::<span class="keyword">template</span></span><br><span class="line">      rebind&lt;_Tp&gt;::other _Tp_alloc_type;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> __gnu_cxx::__alloc_traits&lt;_Tp_alloc_type&gt;::pointer</span><br><span class="line">      pointer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Vector_impl_data</span></span><br><span class="line">    &#123;</span><br><span class="line">      pointer _M_start;</span><br><span class="line">      pointer _M_finish;</span><br><span class="line">      pointer _M_end_of_storage;</span><br><span class="line"></span><br><span class="line">      _Vector_impl_data() _GLIBCXX_NOEXCEPT</span><br><span class="line">      : _M_start(), _M_finish(), _M_end_of_storage()</span><br><span class="line">      &#123; &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>指针分别叫：<code>pointer _M_start;</code>、<code>pointer _M_finish;</code>、<code>pointer _M_end_of_storage;</code> 之前不叫这个的，现在都改了。。。无所谓了，含义没变。。。</p>
<p><code>vector</code>在堆上申请了一块内存，用于存放数组元素。用<code>_M_start</code>表示数组开始的位置，用<code>_M_finish</code>数据结束的位置，用<code>_M_end_of_storage</code> 表示这块内存容量结束的位置。</p>
<ul>
<li>当<code>vector</code>容量不足时，需要进行扩容，扩容会引发内存拷贝。</li>
<li>当向<code>vector</code>插入、删除某些元素时，由于采用连续存储方式，也会引发内存拷贝。</li>
</ul>
<h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><p>刚刚提到了扩容，如果一个<code>vector</code>容量不足了需要扩容，应该扩多少呢？这个根据<code>reserve()</code>的值来决定。如果你没有设置的话，按你存入的数据量进行扩容。如果你设置了这个值，那么每次扩<code>reserve()</code>个。</p>
<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>To be countinue…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/27/language/cpp/variable-in-elf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/27/language/cpp/variable-in-elf/" class="post-title-link" itemprop="url">变量及函数在内存中的位置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-27 15:50:26" itemprop="dateCreated datePublished" datetime="2021-09-27T15:50:26+08:00">2021-09-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>从一个CPP文件编译成ELF可执行文件过程中会把不同的变量和函数映射到不同的内存区域。这些不同的区域具有不同的访问权限，有的是只读的，有的是读写的，有的是可执行的。让我们举个简单的例子来了解一下。</p>
<p>示例代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> dst_type,<span class="keyword">typename</span> src_type&gt;</span></span><br><span class="line"><span class="function">dst_type <span class="title">pointer_cast</span><span class="params">(src_type src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="built_in">static_cast</span>&lt;dst_type*&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">void</span>*&gt;(&amp;src));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_uninit_var;</span><br><span class="line"><span class="type">int</span> global_init_var = <span class="number">255</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> const_global_int = <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Just a function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">static_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">inline_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="type">pfunc_t</span>)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="type">main_func_t</span>)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="type">static_func_t</span>)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;I am Show...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">localshow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;I am localshow...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var = <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> local_uninit_var;</span><br><span class="line">    <span class="type">int</span> local_init_var = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> const_local_int = <span class="number">127</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>* heap_int = <span class="keyword">new</span> <span class="built_in">int</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">pfunc_t</span> pf = func;</span><br><span class="line">    <span class="type">main_func_t</span> mf = main;</span><br><span class="line">    <span class="type">static_func_t</span> sf = static_func;</span><br><span class="line">    <span class="type">static_func_t</span> csf = Simple::Show;</span><br><span class="line">    <span class="type">void</span>* cpf = <span class="built_in">pointer_cast</span>&lt;<span class="type">void</span>*&gt;(&amp;Simple::localshow);</span><br><span class="line">    <span class="type">pfunc_t</span> ipf = inline_func;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;global_uninit_var: 0x%x\n&quot;</span>, &amp;global_uninit_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;global_init_var: 0x%x\n&quot;</span>, &amp;global_init_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;static_var: 0x%x\n&quot;</span>, &amp;static_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;const_global_int: 0x%x\n&quot;</span>, &amp;const_global_int);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;local_uninit_var: 0x%x\n&quot;</span>, &amp;local_uninit_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;local_init_var: 0x%x\n&quot;</span>, &amp;local_init_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;const_local_int: 0x%x\n&quot;</span>, &amp;const_local_int);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;heap_int: 0x%x, 0x%x\n&quot;</span>, &amp;heap_int, heap_int);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;point_func: 0x%x, 0x%x\n&quot;</span>, &amp;pf, pf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;point_main_func: 0x%x, 0x%x\n&quot;</span>, &amp;mf, mf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;static_func: 0x%x, 0x%x\n&quot;</span>, &amp;sf, sf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;class_static_func: 0x%x, 0x%x\n&quot;</span>, &amp;csf, csf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;class_local_func: 0x%x, 0x%x\n&quot;</span>, &amp;cpf, cpf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;inline_func: 0x%x, 0x%x\n&quot;</span>, &amp;ipf, ipf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于ELF格式中有很多信息，我们只取<code>readelf --sections</code>相关信息<br>ELF结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[Nr] Name              Type             Address           Offset       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">[ 0]                   NULL             0000000000000000  00000000       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">[ 1] .interp           PROGBITS         00000000004002a8  000002a8       000000000000001c  0000000000000000   A       0     0     1</span><br><span class="line">[ 2] .note.gnu.bu[...] NOTE             00000000004002c4  000002c4       0000000000000024  0000000000000000   A       0     0     4</span><br><span class="line">[ 3] .note.ABI-tag     NOTE             00000000004002e8  000002e8       0000000000000020  0000000000000000   A       0     0     4</span><br><span class="line">[ 4] .gnu.hash         GNU_HASH         0000000000400308  00000308       000000000000001c  0000000000000000   A       5     0     8</span><br><span class="line">[ 5] .dynsym           DYNSYM           0000000000400328  00000328       0000000000000090  0000000000000018   A       6     1     8</span><br><span class="line">[ 6] .dynstr           STRTAB           00000000004003b8  000003b8       000000000000007d  0000000000000000   A       0     0     1</span><br><span class="line">[ 7] .gnu.version      VERSYM           0000000000400436  00000436       000000000000000c  0000000000000002   A       5     0     2</span><br><span class="line">[ 8] .gnu.version_r    VERNEED          0000000000400448  00000448       0000000000000040  0000000000000000   A       6     2     8</span><br><span class="line">[ 9] .rela.dyn         RELA             0000000000400488  00000488       0000000000000018  0000000000000018   A       5     0     8</span><br><span class="line">[10] .rela.plt         RELA             00000000004004a0  000004a0       0000000000000078  0000000000000018  AI       5    22     8</span><br><span class="line">[11] .init             PROGBITS         0000000000401000  00001000       000000000000001a  0000000000000000  AX       0     0     4</span><br><span class="line">[12] .plt              PROGBITS         0000000000401020  00001020       0000000000000060  0000000000000010  AX       0     0     16</span><br><span class="line">[13] .text             PROGBITS         0000000000401080  00001080       0000000000000392  0000000000000000  AX       0     0     16</span><br><span class="line">[14] .fini             PROGBITS         0000000000401414  00001414       0000000000000009  0000000000000000  AX       0     0     4</span><br><span class="line">[15] .rodata           PROGBITS         0000000000402000  00002000       000000000000019e  0000000000000000   A       0     0     8</span><br><span class="line">[16] .eh_frame_hdr     PROGBITS         00000000004021a0  000021a0       0000000000000064  0000000000000000   A       0     0     4</span><br><span class="line">[17] .eh_frame         PROGBITS         0000000000402208  00002208       00000000000001b8  0000000000000000   A       0     0     8</span><br><span class="line">[18] .init_array       INIT_ARRAY       0000000000403de8  00002de8       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">[19] .fini_array       FINI_ARRAY       0000000000403df0  00002df0       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">[20] .dynamic          DYNAMIC          0000000000403df8  00002df8       0000000000000200  0000000000000010  WA       6     0     8</span><br><span class="line">[21] .got              PROGBITS         0000000000403ff8  00002ff8       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">[22] .got.plt          PROGBITS         0000000000404000  00003000       0000000000000040  0000000000000008  WA       0     0     8</span><br><span class="line">[23] .data             PROGBITS         0000000000404040  00003040       000000000000000c  0000000000000000  WA       0     0     4</span><br><span class="line">[24] .bss              NOBITS           000000000040404c  0000304c       000000000000000c  0000000000000000  WA       0     0     4</span><br><span class="line">[25] .comment          PROGBITS         0000000000000000  0000304c       000000000000005c  0000000000000001  MS       0     0     1</span><br><span class="line">[26] .debug_aranges    PROGBITS         0000000000000000  000030a8       0000000000000070  0000000000000000           0     0     1</span><br><span class="line">[27] .debug_info       PROGBITS         0000000000000000  00003118       000000000000031a  0000000000000000           0     0     1</span><br><span class="line">[28] .debug_abbrev     PROGBITS         0000000000000000  00003432       00000000000001d9  0000000000000000           0     0     1</span><br><span class="line">[29] .debug_line       PROGBITS         0000000000000000  0000360b       0000000000000114  0000000000000000           0     0     1</span><br><span class="line">[30] .debug_str        PROGBITS         0000000000000000  0000371f       0000000000000235  0000000000000001  MS       0     0     1</span><br><span class="line">[31] .debug_ranges     PROGBITS         0000000000000000  00003954       0000000000000060  0000000000000000           0     0     1</span><br><span class="line">[32] .symtab           SYMTAB           0000000000000000  000039b8       0000000000000750  0000000000000018          33    52     8</span><br><span class="line">[33] .strtab           STRTAB           0000000000000000  00004108       0000000000000298  0000000000000000           0     0     1</span><br><span class="line">[34] .shstrtab         STRTAB           0000000000000000  000043a0       0000000000000151  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure>

<p>将上述代码编译运行打印出的结果对应到elf格式中相应的区域如下：</p>
<p><img src="/images/cpp/variable.png" alt="variable"></p>
<ul>
<li>所有代码无聊作何标记全部存储在<code>.text</code>段，换句话说从汇编的角度可以调用任何函数都可以被调用</li>
<li>全局的<code>const</code>常量存放在<code>.rodata</code>段</li>
<li>局部的<code>const</code>常量则存储在栈空间内，而常量的右值<code>127</code>则存放在<code>.text</code>段</li>
<li>已经初始化的全局变量或<code>static</code>变量存放在<code>.data</code>段</li>
<li>未初始化的全局变量存放在<code>bss</code>段</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/23/language/cpp/smart-pointers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/23/language/cpp/smart-pointers/" class="post-title-link" itemprop="url">C++智能指针</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-23 14:54:21" itemprop="dateCreated datePublished" datetime="2021-09-23T14:54:21+08:00">2021-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>智能指针，从其本质上说，就是要控制对象的销毁时机。换句话讲就是何时调用对象的析构函数。从C++11开始引入三个智能指针（<code>unique_ptr</code>,<code>shared_ptr</code>,<code>weak_ptr</code>），准确的说是四种（还有<code>auto_ptr</code>），但从C++17开始<code>auto_ptr</code>被移除了。所以就剩下上述三种了。所有的智能指针都包含在<code>memory</code>头文件中。</p>
<p>首先，很久以前的C++是没有智能指针的，用户创建在堆上的内存，智能自己显示的释放，如果没有释放就会造成内存泄漏。这种特点导致C++的使用成本很高，为了降低成本，引入了智能指针<code>unique_ptr</code>和<code>shared_ptr</code>。</p>
<h2 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h2><p><code>unique_ptr</code>采用的是传递所有权的方式来控制对象的销毁时机。如其名字所示，其对象是独享的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m_a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple %d\n&quot;</span>, m_a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">showfunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple func \n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">            m_a = n;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">const</span> Simple&amp; p) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Copy Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Simple</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">unique_test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// unique ptr</span></span><br><span class="line">    <span class="keyword">auto</span> s_ptr = std::<span class="built_in">make_unique</span>&lt;Simple&gt;(<span class="number">1</span>);</span><br><span class="line">    s_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    std::unique_ptr&lt;Simple&gt; s_copy_ptr = std::<span class="built_in">move</span>(s_ptr);</span><br><span class="line">    s_copy_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    <span class="comment">//std::unique_ptr&lt;Simple&gt; s_ptr_2(s_ptr);   // 无法编译通过</span></span><br><span class="line">    <span class="comment">//std::unique_ptr&lt;Simple&gt; s_ptr_2 = s_ptr;  // 无法编译通过</span></span><br><span class="line">    s_ptr-&gt;<span class="built_in">showfunc</span>();</span><br><span class="line">    <span class="comment">//s_ptr-&gt;Show();    // 当所有权变更后就不该再用之前的指针访问对象资源。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>unique_ptr</code>禁用拷贝构造<br>  由于<code>unique_ptr</code>禁用了拷贝构造函数<code>unique_ptr(const unique_ptr&amp;) = delete;</code>，所以一切试图触发拷贝构造函数的操作都会引发编译错误。</li>
<li><code>unique_ptr</code>所有权一旦变更就不能使用原指针访问对象资源<br>  上述代码中有两处使用了原指针访问对象资源，第一处<code>s_ptr-&gt;showfunc();</code>没有报错，可以正常打印；<code>s_ptr-&gt;Show();</code>中使用到了成员变量<code>m_a</code>所以会导致报错“<code>this</code>空指针”。这是由于<code>std::move</code>的赋值操作触发了<code>unique_ptr</code>中的Move构造函数(<code>unique_ptr(unique_ptr&amp;&amp;) = default;</code>)，从而将<code>s_ptr</code>中的成员清空。所以再次访问原对象指针，就会出错。</li>
</ul>
<h2 id="shared-ptr"><a href="#shared-ptr" class="headerlink" title="shared_ptr"></a>shared_ptr</h2><p><img src="/images/cpp/shared_ptr.png" alt="shared_ptr"></p>
<p><code>shared_ptr</code>采用的是引用计数的机制来控制对象的销毁时机。如其名字所示，其对象是共享的。当计数器等于0是，调用对象的析构函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test_inner</span><span class="params">(std::shared_ptr&lt;Simple&gt; *steal_ptr)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// share ptr</span></span><br><span class="line">    <span class="keyword">auto</span> s_ptr = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">1</span>);</span><br><span class="line">    s_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    <span class="function">std::shared_ptr&lt;Simple&gt; <span class="title">s_copy_ptr</span><span class="params">(s_ptr)</span></span>;</span><br><span class="line">    s_copy_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    std::shared_ptr&lt;Simple&gt; s_ptr_2 = s_ptr;</span><br><span class="line">    s_ptr_2-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    <span class="comment">// try steal</span></span><br><span class="line">    *steal_ptr = s_ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">shared_test_leak</span>();</span><br><span class="line">    std::shared_ptr&lt;Simple&gt; s_ptr;</span><br><span class="line">    <span class="built_in">shared_test_inner</span>(&amp;s_ptr);</span><br><span class="line">    s_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽可能使用<code>make_shared</code>创建<code>shared_ptr</code>，如果使用<code>std::shared_ptr&lt;Simple&gt; s_ptr(new Simple(1))</code>创建<code>shared_ptr</code>，需要分配两次内存，一次是<code>new Simple(1)</code>；另一次是<code>shared_ptr</code>的引用计数。<code>make_shared</code>只分配一次。</p>
<p>现在创建一个<code>SimpleBack</code>类，然后再让<code>Simple</code>和<code>SimpleBack</code>循环引用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m_a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple %d\n&quot;</span>, m_a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">showfunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple func \n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">            m_a = n;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">const</span> Simple&amp; p) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Copy Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Simple</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        std::shared_ptr&lt;SimpleBack&gt; m_sb;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        std::shared_ptr&lt;Simple&gt; m_s;</span><br><span class="line">        ~<span class="built_in">SimpleBack</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;SimpleBack Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> s = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">auto</span> sb = std::<span class="built_in">make_shared</span>&lt;SimpleBack&gt;();</span><br><span class="line"></span><br><span class="line">    s-&gt;m_sb = sb;</span><br><span class="line">    sb-&gt;m_s = s;</span><br><span class="line">    <span class="comment">// 通过打印语句可以看到 s和sb的析构函数并没有调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过析构函数函数的打印语句可以看出<code>s</code>和<code>sb</code>并没有被析构，这说明<code>s</code>和<code>sb</code>泄漏了。</p>
<p>为了解决<code>shared_ptr</code>在循环依赖中内存泄漏的问题，推出了<code>weak_ptr</code>。</p>
<h2 id="weak-ptr"><a href="#weak-ptr" class="headerlink" title="weak_ptr"></a>weak_ptr</h2><p><code>weak_ptr</code>不会增加引用计数，不能直接操作对象的内存（需要先调用<code>lock</code>接口），需要和<code>shared_ptr</code>配套使用。</p>
<p>将上述代码改成这样：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m_a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple %d\n&quot;</span>, m_a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">showfunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple func \n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">            m_a = n;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">const</span> Simple&amp; p) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Copy Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Simple</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        std::shared_ptr&lt;SimpleBack&gt; m_sb;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// 将循环引用的其中一个改成weak_ptr</span></span><br><span class="line">        std::weak_ptr&lt;Simple&gt; m_s;</span><br><span class="line">        ~<span class="built_in">SimpleBack</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;SimpleBack Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> s = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">auto</span> sb = std::<span class="built_in">make_shared</span>&lt;SimpleBack&gt;();</span><br><span class="line"></span><br><span class="line">    s-&gt;m_sb = sb;</span><br><span class="line">    sb-&gt;m_s = s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过析构函数的打印语句可以看出，<code>s</code>和<code>sb</code>的析构函数在<code>shared_test_lead()</code>调用结束后被调用。</p>
<p>那么，<code>weak_ptr</code>的使用是不是也像<code>shared_ptr</code>一样呢？不是的。<code>weak_ptr</code>需要与<code>shared_ptr</code>配合使用，看一个例子。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">weak_test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::weak_ptr&lt;Simple&gt; w;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> s = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">3</span>);</span><br><span class="line">        w = s;</span><br><span class="line">        <span class="keyword">auto</span> s2 = w.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">if</span>(s2 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            s2-&gt;<span class="built_in">Show</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(w.<span class="built_in">expired</span>()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;object &#x27;s&#x27; is destroied. \n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>lock</code><br>  若对象已被析构，则返回一个空的<code>shared_ptr</code>；否则返回实际的<code>shared_ptr</code>。</li>
<li><code>expired</code><br>  若对象已被析构，则返回<code>true</code>；否则返回<code>false</code></li>
</ul>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://senlinzhan.github.io/2015/04/24/%E6%B7%B1%E5%85%A5shared-ptr/">谈谈 shared_ptr 的那些坑</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cb3e574eee5f">智能指针的线程安全</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qingdujun/article/details/74858071">C++14 智能指针unique_ptr、shared_ptr、weak_ptr</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Solstice/archive/2013/01/28/2879366.html">为什么多线程读写 shared_ptr 要加锁？</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">博</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">141</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
