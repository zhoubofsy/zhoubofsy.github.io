<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="博">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/13/blockchain/ethereum/abi-principle-apply/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/13/blockchain/ethereum/abi-principle-apply/" class="post-title-link" itemprop="url">ABI格式和使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-12-13 17:55:44 / Modified: 17:58:29" itemprop="dateCreated datePublished" datetime="2024-12-13T17:55:44+08:00">2024-12-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是-ABI-Application-Binary-Interface"><a href="#什么是-ABI-Application-Binary-Interface" class="headerlink" title="什么是 ABI (Application Binary Interface)?"></a>什么是 ABI (Application Binary Interface)?</h2><p>在 Solidity 中，ABI（应用二进制接口）是智能合约与外界（包括其他合约和用户界面）交互的桥梁。它定义了智能合约中函数的编码方式、输入参数和返回值的格式，以便在区块链中进行数据的传输和解析。</p>
<h3 id="ABI-的作用"><a href="#ABI-的作用" class="headerlink" title="ABI 的作用"></a>ABI 的作用</h3><ol>
<li><strong>数据编码与解码</strong>：在区块链中，所有的数据都以二进制形式存储和传输。ABI 提供了标准化的编码规则，使得智能合约的函数调用可以正确地解释输入和输出数据。</li>
<li><strong>合约交互</strong>：外部程序（如 DApp）需要 ABI 文件来与合约交互，了解合约的函数和参数。</li>
<li><strong>兼容性</strong>：通过 ABI，智能合约之间可以互操作，即使它们是由不同的开发人员编写的。</li>
</ol>
<h3 id="ABI-的重要性"><a href="#ABI-的重要性" class="headerlink" title="ABI 的重要性"></a>ABI 的重要性</h3><ul>
<li><strong>统一性</strong>：ABI 使得智能合约与外部交互的过程标准化，避免了自定义协议带来的复杂性。</li>
<li><strong>跨语言支持</strong>：无论是前端、后端，还是区块链中的其他合约，都可以基于 ABI 与合约进行交互。</li>
</ul>
<h2 id="ABI的原理"><a href="#ABI的原理" class="headerlink" title="ABI的原理"></a>ABI的原理</h2><h3 id="ABI-的结构"><a href="#ABI-的结构" class="headerlink" title="ABI 的结构"></a>ABI 的结构</h3><p>ABI 通常是以 JSON 格式生成的文件，描述了智能合约的函数、事件及其参数。</p>
<p><strong>示例合约</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Example &#123;</span><br><span class="line">    uint256 public value;</span><br><span class="line"></span><br><span class="line">    event ValueChanged(uint256 newValue);</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 _value) public &#123;</span><br><span class="line">        value = _value;</span><br><span class="line">        emit ValueChanged(_value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getValue() public view returns (uint256) &#123;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ABI 的 JSON 表示</strong></p>
<p>运行 <code>solc --abi Example.sol</code> 会生成以下 ABI 文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;anonymous&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;indexed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;internalType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;newValue&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ValueChanged&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;event&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getValue&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;internalType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;stateMutability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;view&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;function&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;internalType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_value&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;setValue&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;stateMutability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nonpayable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;function&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;internalType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uint256&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;stateMutability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;view&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;function&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="ABI-的关键字段"><a href="#ABI-的关键字段" class="headerlink" title="ABI 的关键字段"></a>ABI 的关键字段</h3><ol>
<li><strong><code>type</code></strong><br> 定义元素的类型：<ul>
<li><code>function</code>：表示合约函数。</li>
<li><code>event</code>：表示事件。</li>
<li><code>constructor</code>：表示构造函数。</li>
<li><code>fallback</code>：表示回退函数。</li>
<li><code>receive</code>：表示接收以太币的特殊函数。</li>
</ul>
</li>
<li><strong><code>name</code></strong><br> 函数或事件的名称（不适用于匿名函数）。</li>
<li><strong><code>inputs</code></strong><br> 表示函数或事件的输入参数列表。每个参数包含：<ul>
<li><code>internalType</code>：Solidity 内部类型。</li>
<li><code>name</code>：参数名称。</li>
<li><code>type</code>：外部使用的类型（如 <code>uint256</code>）。</li>
</ul>
</li>
<li><strong><code>outputs</code></strong><br> 表示函数的返回值列表，格式与 <code>inputs</code> 相同。</li>
<li><strong><code>stateMutability</code></strong><br> 表示函数的状态：<ul>
<li><code>view</code>：只读，不修改状态。</li>
<li><code>pure</code>：不读写状态。</li>
<li><code>nonpayable</code>：不允许发送以太币。</li>
<li><code>payable</code>：允许发送以太币。</li>
</ul>
</li>
<li><strong><code>anonymous</code></strong><br> 仅适用于事件，表示事件是否匿名。</li>
</ol>
<h3 id="ABI-编码规则"><a href="#ABI-编码规则" class="headerlink" title="ABI 编码规则"></a>ABI 编码规则</h3><p>ABI 定义了调用合约函数时参数的编码方式。以下是编码的关键点：</p>
<h4 id="编码示例"><a href="#编码示例" class="headerlink" title="编码示例"></a>编码示例</h4><p>调用 <code>setValue(42)</code> 的编码过程如下：</p>
<ol>
<li>函数签名的 Keccak 哈希： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setValue(uint256) -&gt; 0x55241077</span><br></pre></td></tr></table></figure></li>
<li>参数的编码： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">42 -&gt; 000000000000000000000000000000000000000000000000000000000000002a</span><br></pre></td></tr></table></figure></li>
<li>完整的编码： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x55241077000000000000000000000000000000000000000000000000000000000000002a</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="ABI-解码规则"><a href="#ABI-解码规则" class="headerlink" title="ABI 解码规则"></a><strong>ABI 解码规则</strong></h3><p>返回值的解码也遵循 ABI 的规则。<br>例如，<code>getValue()</code> 返回 <code>42</code> 时：</p>
<ol>
<li>返回数据： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x000000000000000000000000000000000000000000000000000000000000002a</span><br></pre></td></tr></table></figure></li>
<li>解码为 <code>42</code></li>
</ol>
<h2 id="ABI-的使用"><a href="#ABI-的使用" class="headerlink" title="ABI 的使用"></a>ABI 的使用</h2><h3 id="使用场景-1-智能合约调用"><a href="#使用场景-1-智能合约调用" class="headerlink" title="使用场景 1: 智能合约调用"></a>使用场景 1: 智能合约调用</h3><p><strong>场景描述：</strong></p>
<p>通过 Golang 使用 ABI 文件调用智能合约上的函数，例如调用只读函数或发送交易调用状态变更函数。</p>
<p><strong>代码示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;math/big&quot;</span><br><span class="line"></span><br><span class="line">	&quot;github.com/ethereum/go-ethereum/accounts/abi&quot;</span><br><span class="line">	&quot;github.com/ethereum/go-ethereum/accounts/abi/bind&quot;</span><br><span class="line">	&quot;github.com/ethereum/go-ethereum/ethclient&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	// 1. 连接到 Ethereum 节点</span><br><span class="line">	client, err := ethclient.Dial(&quot;https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID&quot;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to connect to Ethereum node: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 2. 合约地址和 ABI 定义</span><br><span class="line">	contractAddress := &quot;0xYourContractAddress&quot;</span><br><span class="line">	contractABI := `[&#123;&quot;constant&quot;:true,&quot;inputs&quot;:[],&quot;name&quot;:&quot;getValue&quot;,&quot;outputs&quot;:[&#123;&quot;name&quot;:&quot;&quot;,&quot;type&quot;:&quot;uint256&quot;&#125;],&quot;payable&quot;:false,&quot;stateMutability&quot;:&quot;view&quot;,&quot;type&quot;:&quot;function&quot;&#125;]`</span><br><span class="line"></span><br><span class="line">	// 3. 解析 ABI</span><br><span class="line">	parsedABI, err := abi.JSON(strings.NewReader(contractABI))</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to parse ABI: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 4. 构造合约调用</span><br><span class="line">	callOpts := &amp;bind.CallOpts&#123;Context: context.Background()&#125;</span><br><span class="line">	data, err := parsedABI.Pack(&quot;getValue&quot;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to pack data: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 5. 调用合约</span><br><span class="line">	msg := ethereum.CallMsg&#123;</span><br><span class="line">		To:   &amp;contractAddress,</span><br><span class="line">		Data: data,</span><br><span class="line">	&#125;</span><br><span class="line">	result, err := client.CallContract(context.Background(), msg, nil)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to call contract: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 6. 解析返回值</span><br><span class="line">	var value *big.Int</span><br><span class="line">	err = parsedABI.UnpackIntoInterface(&amp;value, &quot;getValue&quot;, result)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to unpack result: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&quot;Value: %s\n&quot;, value.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关键点："><a href="#关键点：" class="headerlink" title="关键点："></a>关键点：</h4><ol>
<li>使用 <code>abi.JSON</code> 解析 ABI。</li>
<li>使用 <code>Pack</code> 将函数调用和参数编码。</li>
<li>通过 <code>CallContract</code> 调用合约。</li>
<li>使用 <code>UnpackIntoInterface</code> 解码返回值。</li>
</ol>
<h3 id="使用场景-2-监听合约事件"><a href="#使用场景-2-监听合约事件" class="headerlink" title="使用场景 2: 监听合约事件"></a>使用场景 2: 监听合约事件</h3><p><strong>场景描述：</strong></p>
<p>通过 Golang 和 ABI 监听合约事件的发生。</p>
<p><strong>代码示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line"></span><br><span class="line">	&quot;github.com/ethereum/go-ethereum&quot;</span><br><span class="line">	&quot;github.com/ethereum/go-ethereum/accounts/abi&quot;</span><br><span class="line">	&quot;github.com/ethereum/go-ethereum/ethclient&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	// 1. 连接到 Ethereum 节点</span><br><span class="line">	client, err := ethclient.Dial(&quot;wss://mainnet.infura.io/ws/v3/YOUR_INFURA_PROJECT_ID&quot;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to connect to Ethereum node: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 2. 合约地址和事件的 ABI 定义</span><br><span class="line">	contractAddress := &quot;0xYourContractAddress&quot;</span><br><span class="line">	eventABI := `[&#123;&quot;anonymous&quot;:false,&quot;inputs&quot;:[&#123;&quot;indexed&quot;:false,&quot;name&quot;:&quot;newValue&quot;,&quot;type&quot;:&quot;uint256&quot;&#125;],&quot;name&quot;:&quot;ValueChanged&quot;,&quot;type&quot;:&quot;event&quot;&#125;]`</span><br><span class="line"></span><br><span class="line">	// 3. 解析事件 ABI</span><br><span class="line">	parsedABI, err := abi.JSON(strings.NewReader(eventABI))</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to parse ABI: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 4. 设置日志查询过滤器</span><br><span class="line">	query := ethereum.FilterQuery&#123;</span><br><span class="line">		Addresses: []common.Address&#123;common.HexToAddress(contractAddress)&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	logs := make(chan types.Log)</span><br><span class="line">	sub, err := client.SubscribeFilterLogs(context.Background(), query, logs)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;Failed to subscribe to logs: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 5. 监听事件</span><br><span class="line">	for logEvent := range logs &#123;</span><br><span class="line">		var event struct &#123;</span><br><span class="line">			NewValue *big.Int</span><br><span class="line">		&#125;</span><br><span class="line">		err := parsedABI.UnpackIntoInterface(&amp;event, &quot;ValueChanged&quot;, logEvent.Data)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			log.Printf(&quot;Failed to unpack event: %v&quot;, err)</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			log.Printf(&quot;New Value: %s&quot;, event.NewValue.String())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_ = sub // Handle subscription lifecycle as needed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关键点：-1"><a href="#关键点：-1" class="headerlink" title="关键点："></a>关键点：</h4><ol>
<li>使用 <code>FilterQuery</code> 设置日志过滤器。</li>
<li>通过 <code>SubscribeFilterLogs</code> 监听事件。</li>
<li>使用 ABI 的 <code>UnpackIntoInterface</code> 解码事件数据。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/11/blockchain/ethereum/kurtosis-deploy-ethereum/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/11/blockchain/ethereum/kurtosis-deploy-ethereum/" class="post-title-link" itemprop="url">Kurtosis 部署 Ethereum 测试网</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-11 16:36:00" itemprop="dateCreated datePublished" datetime="2024-12-11T16:36:00+08:00">2024-12-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-13 16:22:54" itemprop="dateModified" datetime="2024-12-13T16:22:54+08:00">2024-12-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><h2 id="安装Kurtosis"><a href="#安装Kurtosis" class="headerlink" title="安装Kurtosis"></a>安装Kurtosis</h2><p>以macos为例，安装Kurtosis</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install kurtosis-tech/tap/kurtosis-cli</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kurtosis version</span></span><br><span class="line">CLI Version:   1.4.3</span><br><span class="line"></span><br><span class="line">To see the engine version (provided it is running): kurtosis engine status</span><br></pre></td></tr></table></figure>

<h2 id="部署Ethereum测试网"><a href="#部署Ethereum测试网" class="headerlink" title="部署Ethereum测试网"></a>部署Ethereum测试网</h2><p>使用下面命令部署Ethereum测试网络</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kurtosis --enclave local-eth-testnet run github.com/ethpandaops/ethereum-package</span></span><br></pre></td></tr></table></figure>

<p>以下是部署过程的输出信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line">INFO[2024-12-11T15:08:23+08:00] Creating a new enclave for Starlark to run inside...</span><br><span class="line">INFO[2024-12-11T15:08:25+08:00] Enclave &#x27;local-eth-testnet&#x27; created successfully</span><br><span class="line"></span><br><span class="line">Container images used in this run:</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ethpandaops/lighthouse:stable - remotely downloaded</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ethpandaops/ethereum-genesis-generator:3.4.2 - remotely downloaded</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ethereum/client-go:latest - remotely downloaded</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">python:3.11-alpine - remotely downloaded</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">protolambda/eth2-val-tools:latest - remotely downloaded</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">badouralix/curl-jq - remotely downloaded</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Starlark code successfully run. Output was:</span><br><span class="line">&#123;</span><br><span class="line">	&quot;all_participants&quot;: [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;cl_context&quot;: &#123;</span><br><span class="line">				&quot;beacon_grpc_url&quot;: &quot;&quot;,</span><br><span class="line">				&quot;beacon_http_url&quot;: &quot;http://172.16.4.11:4000&quot;,</span><br><span class="line">				&quot;beacon_service_name&quot;: &quot;cl-1-lighthouse-geth&quot;,</span><br><span class="line">				&quot;cl_nodes_metrics_info&quot;: [</span><br><span class="line">					&#123;</span><br><span class="line">						&quot;config&quot;: &#123;</span><br><span class="line">							&quot;labels&quot;: null,</span><br><span class="line">							&quot;scrape_interval&quot;: &quot;15s&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&quot;name&quot;: &quot;cl-1-lighthouse-geth&quot;,</span><br><span class="line">						&quot;path&quot;: &quot;/metrics&quot;,</span><br><span class="line">						&quot;url&quot;: &quot;172.16.4.11:5054&quot;</span><br><span class="line">					&#125;</span><br><span class="line">				],</span><br><span class="line">				&quot;client_name&quot;: &quot;lighthouse&quot;,</span><br><span class="line">				&quot;enr&quot;: &quot;enr:-Mm4QGoJFz_8BxhUo1_qcU99AlMtQg08SE_lrbH0B3cVOdoiFyHNA12IrI2DwAsZG7AvSeocDB9TcFad33Om5sd9Gc0Dh2F0dG5ldHOIAAAAAMAAAACDY3NjBIRldGgykE-3JeFgAAA4AOH1BQAAAACCaWSCdjSCaXCErBAEC4RxdWljgiMpiXNlY3AyNTZrMaEDwNCUN06NbFU4oqKnXHkTMdcdNTlr_xwC33QSFfCdcL6Ic3luY25ldHMAg3RjcIIjKIN1ZHCCIyg&quot;,</span><br><span class="line">				&quot;http_port&quot;: 4000,</span><br><span class="line">				&quot;ip_addr&quot;: &quot;172.16.4.11&quot;,</span><br><span class="line">				&quot;multiaddr&quot;: &quot;/ip4/172.16.4.11/tcp/9000/p2p/16Uiu2HAmRdf6aDAhx764sqQkD9BYQxFmyAXoCaGETKCwb49MTLgm&quot;,</span><br><span class="line">				&quot;peer_id&quot;: &quot;16Uiu2HAmRdf6aDAhx764sqQkD9BYQxFmyAXoCaGETKCwb49MTLgm&quot;,</span><br><span class="line">				&quot;snooper_enabled&quot;: false,</span><br><span class="line">				&quot;snooper_engine_context&quot;: null,</span><br><span class="line">				&quot;supernode&quot;: false,</span><br><span class="line">				&quot;validator_keystore_files_artifact_uuid&quot;: &quot;1-lighthouse-geth-0-63&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;cl_type&quot;: &quot;lighthouse&quot;,</span><br><span class="line">			&quot;el_context&quot;: &#123;</span><br><span class="line">				&quot;client_name&quot;: &quot;geth&quot;,</span><br><span class="line">				&quot;el_metrics_info&quot;: [</span><br><span class="line">					&#123;</span><br><span class="line">						&quot;config&quot;: &#123;</span><br><span class="line">							&quot;labels&quot;: null,</span><br><span class="line">							&quot;scrape_interval&quot;: &quot;15s&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&quot;name&quot;: &quot;el-1-geth-lighthouse&quot;,</span><br><span class="line">						&quot;path&quot;: &quot;/debug/metrics/prometheus&quot;,</span><br><span class="line">						&quot;url&quot;: &quot;172.16.4.10:9001&quot;</span><br><span class="line">					&#125;</span><br><span class="line">				],</span><br><span class="line">				&quot;engine_rpc_port_num&quot;: 8551,</span><br><span class="line">				&quot;enode&quot;: &quot;enode://e273007e4a0cc96fb52d02e132643dcdc7dabee68bdf65e7a538f01e33682ae137c0f25ca51301f99e9ac2ba2ca625af9caa6c692246597872f9d0bac4d6c3ab@172.16.4.10:30303&quot;,</span><br><span class="line">				&quot;enr&quot;: &quot;enr:-Ki4QEtrZL_kOZOzlrm5bzYHqXuAExc82OpFTVlzlWpvfkbAThI2xjDaR44kByHuwzs0Lg4QpasiuBLWFzvq0Tuk7cuGAZO0jpf1g2V0aMzLhKMFvEuFCVgqux6CaWSCdjSCaXCErBAEColzZWNwMjU2azGhA-JzAH5KDMlvtS0C4TJkPc3H2r7mi99l56U48B4zaCrhhHNuYXDAg3RjcIJ2X4N1ZHCCdl8&quot;,</span><br><span class="line">				&quot;ip_addr&quot;: &quot;172.16.4.10&quot;,</span><br><span class="line">				&quot;rpc_http_url&quot;: &quot;http://172.16.4.10:8545&quot;,</span><br><span class="line">				&quot;rpc_port_num&quot;: 8545,</span><br><span class="line">				&quot;service_name&quot;: &quot;el-1-geth-lighthouse&quot;,</span><br><span class="line">				&quot;ws_port_num&quot;: 8546,</span><br><span class="line">				&quot;ws_url&quot;: &quot;ws://172.16.4.10:8546&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;el_type&quot;: &quot;geth&quot;,</span><br><span class="line">			&quot;ethereum_metrics_exporter_context&quot;: null,</span><br><span class="line">			&quot;remote_signer_context&quot;: null,</span><br><span class="line">			&quot;remote_signer_type&quot;: &quot;web3signer&quot;,</span><br><span class="line">			&quot;snooper_beacon_context&quot;: null,</span><br><span class="line">			&quot;snooper_engine_context&quot;: null,</span><br><span class="line">			&quot;vc_context&quot;: &#123;</span><br><span class="line">				&quot;client_name&quot;: &quot;lighthouse&quot;,</span><br><span class="line">				&quot;metrics_info&quot;: &#123;</span><br><span class="line">					&quot;config&quot;: &#123;</span><br><span class="line">						&quot;labels&quot;: null,</span><br><span class="line">						&quot;scrape_interval&quot;: &quot;15s&quot;</span><br><span class="line">					&#125;,</span><br><span class="line">					&quot;name&quot;: &quot;vc-1-geth-lighthouse&quot;,</span><br><span class="line">					&quot;path&quot;: &quot;/metrics&quot;,</span><br><span class="line">					&quot;url&quot;: &quot;172.16.4.12:8080&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;service_name&quot;: &quot;vc-1-geth-lighthouse&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;vc_type&quot;: &quot;lighthouse&quot;,</span><br><span class="line">			&quot;xatu_sentry_context&quot;: null</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;final_genesis_timestamp&quot;: &quot;1733901086&quot;,</span><br><span class="line">	&quot;genesis_validators_root&quot;: &quot;0xd61ea484febacfae5298d52a2b581f3e305a51f3112a9241b968dccf019f7b11&quot;,</span><br><span class="line">	&quot;network_id&quot;: &quot;3151908&quot;,</span><br><span class="line">	&quot;network_params&quot;: &#123;</span><br><span class="line">		&quot;additional_preloaded_contracts&quot;: &#123;&#125;,</span><br><span class="line">		&quot;altair_fork_epoch&quot;: 0,</span><br><span class="line">		&quot;bellatrix_fork_epoch&quot;: 0,</span><br><span class="line">		&quot;capella_fork_epoch&quot;: 0,</span><br><span class="line">		&quot;churn_limit_quotient&quot;: 65536,</span><br><span class="line">		&quot;custody_requirement&quot;: 4,</span><br><span class="line">		&quot;data_column_sidecar_subnet_count&quot;: 128,</span><br><span class="line">		&quot;deneb_fork_epoch&quot;: 0,</span><br><span class="line">		&quot;deposit_contract_address&quot;: &quot;0x4242424242424242424242424242424242424242&quot;,</span><br><span class="line">		&quot;devnet_repo&quot;: &quot;ethpandaops&quot;,</span><br><span class="line">		&quot;eip7594_fork_epoch&quot;: 100000002,</span><br><span class="line">		&quot;eip7594_fork_version&quot;: &quot;0x60000038&quot;,</span><br><span class="line">		&quot;ejection_balance&quot;: 16000000000,</span><br><span class="line">		&quot;electra_fork_epoch&quot;: 100000000,</span><br><span class="line">		&quot;eth1_follow_distance&quot;: 2048,</span><br><span class="line">		&quot;fulu_fork_epoch&quot;: 100000001,</span><br><span class="line">		&quot;genesis_delay&quot;: 20,</span><br><span class="line">		&quot;genesis_gaslimit&quot;: 30000000,</span><br><span class="line">		&quot;max_blobs_per_block&quot;: 6,</span><br><span class="line">		&quot;max_per_epoch_activation_churn_limit&quot;: 8,</span><br><span class="line">		&quot;min_validator_withdrawability_delay&quot;: 256,</span><br><span class="line">		&quot;network&quot;: &quot;kurtosis&quot;,</span><br><span class="line">		&quot;network_id&quot;: &quot;3151908&quot;,</span><br><span class="line">		&quot;network_sync_base_url&quot;: &quot;https://snapshots.ethpandaops.io/&quot;,</span><br><span class="line">		&quot;num_validator_keys_per_node&quot;: 64,</span><br><span class="line">		&quot;prefunded_accounts&quot;: &#123;&#125;,</span><br><span class="line">		&quot;preregistered_validator_count&quot;: 0,</span><br><span class="line">		&quot;preregistered_validator_keys_mnemonic&quot;: &quot;giant issue aisle success illegal bike spike question tent bar rely arctic volcano long crawl hungry vocal artwork sniff fantasy very lucky have athlete&quot;,</span><br><span class="line">		&quot;preset&quot;: &quot;mainnet&quot;,</span><br><span class="line">		&quot;samples_per_slot&quot;: 8,</span><br><span class="line">		&quot;seconds_per_slot&quot;: 12,</span><br><span class="line">		&quot;shard_committee_period&quot;: 256</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;pre_funded_accounts&quot;: [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x8943545177806ED17B9F23F0a21ee5948eCaa776&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;bcdf20249abf0ed6d944c0288fad489e33f66b3960d9e6229c1cd214ed3bbe31&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xE25583099BA105D9ec0A67f5Ae86D90e50036425&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;39725efee3fb28614de3bacaffe4cc4bd8c436257e2c8bb887c4b5c4be45e76d&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x614561D2d143621E126e87831AEF287678B442b8&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;53321db7c1e331d93a11a41d16f004d7ff63972ec8ec7c25db329728ceeb1710&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xf93Ee4Cf8c6c40b329b0c0626F28333c132CF241&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;ab63b23eb7941c1251757e24b3d2350d2bc05c3c388d06f8fe6feafefb1e8c70&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x802dCbE1B1A97554B4F50DB5119E37E8e7336417&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;5d2344259f42259f82d2c140aa66102ba89b57b4883ee441a8b312622bd42491&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xAe95d8DA9244C37CaC0a3e16BA966a8e852Bb6D6&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;27515f805127bebad2fb9b183508bdacb8c763da16f54e0678b16e8f28ef3fff&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x2c57d1CFC6d5f8E4182a56b4cf75421472eBAEa4&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;7ff1a4c1d57e5e784d327c4c7651e952350bc271f156afb3d00d20f5ef924856&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x741bFE4802cE1C4b5b00F9Df2F5f179A1C89171A&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;3a91003acaf4c21b3953d94fa4a6db694fa69e5242b2e37be05dd82761058899&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xc3913d4D8bAb4914328651C2EAE817C8b78E1f4c&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;bb1d0f125b4fb2bb173c318cdead45468474ca71474e2247776b2b4c0fa2d3f5&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x65D08a056c17Ae13370565B04cF77D2AfA1cB9FA&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;850643a0224065ecce3882673c21f56bcf6eef86274cc21cadff15930b59fc8c&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x3e95dFbBaF6B348396E6674C7871546dCC568e56&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;94eb3102993b41ec55c241060f47daa0f6372e2e3ad7e91612ae36c364042e44&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x5918b2e647464d4743601a865753e64C8059Dc4F&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;daf15504c22a352648a71ef2926334fe040ac1d5005019e09f6c979808024dc7&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x589A698b7b7dA0Bec545177D3963A2741105C7C9&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;eaba42282ad33c8ef2524f07277c03a776d98ae19f581990ce75becb7cfa1c23&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0x4d1CB4eB7969f8806E2CaAc0cbbB71f88C8ec413&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;3fd98b5187bf6526734efaa644ffbb4e3670d66f5d0268ce0323ec09124bff61&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xF5504cE2BcC52614F121aff9b93b2001d92715CA&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;5288e2f440c7f0cb61a9be8afdeb4295f786383f96f5e35eb0c94ef103996b64&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xF61E98E7D47aB884C244E39E031978E33162ff4b&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;f296c7802555da2a5a662be70e078cbd38b44f96f8615ae529da41122ce8db05&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xf1424826861ffbbD25405F5145B5E50d0F1bFc90&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;bf3beef3bd999ba9f2451e06936f0423cd62b815c9233dd3bc90f7e02a1e8673&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xfDCe42116f541fc8f7b0776e2B30832bD5621C85&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;6ecadc396415970e91293726c3f5775225440ea0844ae5616135fd10d66b5954&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xD9211042f35968820A3407ac3d80C725f8F75c14&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;a492823c3e193d6c595f37a18e3c06650cf4c74558cc818b16130b293716106f&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xD8F3183DEF51A987222D845be228e0Bbb932C222&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;c5114526e042343c6d1899cad05e1c00ba588314de9b96929914ee0df18d46b2&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;address&quot;: &quot;0xafF0CA253b97e54440965855cec0A8a2E2399896&quot;,</span><br><span class="line">			&quot;private_key&quot;: &quot;4b9f63ecf84210c5366c66d68fa1f5da1fa4f634fad6dfc86178e4d79ff9e59&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">⭐ us on GitHub - https://github.com/kurtosis-tech/kurtosis</span><br><span class="line">INFO[2024-12-11T15:11:10+08:00] ==========================================================</span><br><span class="line">INFO[2024-12-11T15:11:10+08:00] ||          Created enclave: local-eth-testnet          ||</span><br><span class="line">INFO[2024-12-11T15:11:10+08:00] ==========================================================</span><br><span class="line">Name:            local-eth-testnet</span><br><span class="line">UUID:            b134e2cd4ffa</span><br><span class="line">Status:          RUNNING</span><br><span class="line">Creation Time:   Wed, 11 Dec 2024 15:08:23 CST</span><br><span class="line">Flags:</span><br><span class="line"></span><br><span class="line">========================================= Files Artifacts =========================================</span><br><span class="line">UUID           Name</span><br><span class="line">eeac0b67fe11   1-lighthouse-geth-0-63</span><br><span class="line">0ca90fbaddae   el_cl_genesis_data</span><br><span class="line">02724177f009   final-genesis-timestamp</span><br><span class="line">6579d6313c44   genesis-el-cl-env-file</span><br><span class="line">6236b016ccf1   genesis_validators_root</span><br><span class="line">d65d356d27a3   jwt_file</span><br><span class="line">77d5e8aa3bf1   keymanager_file</span><br><span class="line">f873ac882893   prysm-password</span><br><span class="line">7f0f603a0154   validator-ranges</span><br><span class="line"></span><br><span class="line">========================================== User Services ==========================================</span><br><span class="line">UUID           Name                                             Ports                                         Status</span><br><span class="line">38a34f4ff219   cl-1-lighthouse-geth                             http: 4000/tcp -&gt; http://127.0.0.1:54095      RUNNING</span><br><span class="line">                                                                metrics: 5054/tcp -&gt; http://127.0.0.1:54096</span><br><span class="line">                                                                tcp-discovery: 9000/tcp -&gt; 127.0.0.1:54097</span><br><span class="line">                                                                udp-discovery: 9000/udp -&gt; 127.0.0.1:60155</span><br><span class="line">714c863fd14f   el-1-geth-lighthouse                             engine-rpc: 8551/tcp -&gt; 127.0.0.1:54056       RUNNING</span><br><span class="line">                                                                metrics: 9001/tcp -&gt; http://127.0.0.1:54057</span><br><span class="line">                                                                rpc: 8545/tcp -&gt; 127.0.0.1:54059</span><br><span class="line">                                                                tcp-discovery: 30303/tcp -&gt; 127.0.0.1:54058</span><br><span class="line">                                                                udp-discovery: 30303/udp -&gt; 127.0.0.1:54093</span><br><span class="line">                                                                ws: 8546/tcp -&gt; 127.0.0.1:54055</span><br><span class="line">ef18a854d243   validator-key-generation-cl-validator-keystore   &lt;none&gt;                                        RUNNING</span><br><span class="line">0f4da064ec7f   vc-1-geth-lighthouse                             metrics: 8080/tcp -&gt; http://127.0.0.1:54168   RUNNING</span><br></pre></td></tr></table></figure>

<ul>
<li>cl-1-lighthouse-geth<br>  以太坊 2.0 的 Beacon Chain 节点（共识层）。负责管理 PoS 共识机制、验证区块、协调验证者任务、维护 Beacon Chain 状态。</li>
<li>el-1-geth-lighthouse<br>  以太坊 1.x 的执行层客户端。它负责处理智能合约、账户状态更新、交易验证等功能。它的主要职责是提供执行层的支持，与以太坊 2.0 的共识层（如 Lighthouse）协作。</li>
<li>validator-key-generation-cl-validator-keystore<br>  以太坊 2.0（即 Ethereum 2.0 或 Eth2）验证者（validator）管理的工具集。这个工具集为以太坊 2.0 的验证者提供了多种支持功能，帮助他们更加高效、安全地参与以太坊的 权益证明（Proof of Stake, PoS） 共识机制。通过这些工具，验证者可以生成必要的密钥、管理其验证者身份、监控验证者的状态以及优化验证过程。</li>
<li>vc-1-geth-lighthouse<br>  验证者客户端（Validator Client）。验证者客户端专门管理验证者账户、执行验证签名职责。</li>
</ul>
<h2 id="操作ethereum"><a href="#操作ethereum" class="headerlink" title="操作ethereum"></a>操作ethereum</h2><p>使用命令<code>kurtosis service shell local-eth-testnet el-1-geth-lighthouse</code>登录<code>el-1-geth-lighthouse</code>的容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kurtosis service shell local-eth-testnet el-1-geth-lighthouse</span></span><br><span class="line">No bash found on container; dropping down to sh shell...</span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>

<p>然后就可以使用<code>geth</code>这个命令了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/ # geth --datadir /data/geth/execution-data/ attach</span><br><span class="line">Welcome to the Geth JavaScript console!</span><br><span class="line"></span><br><span class="line">instance: Geth/v1.14.13-unstable-330190e4-20241210/linux-arm64/go1.23.4</span><br><span class="line">at block: 1293 (Thu Dec 12 2024 02:22:26 GMT+0000 (UTC))</span><br><span class="line"> datadir: /data/geth/execution-data</span><br><span class="line"> modules: admin:1.0 debug:1.0 engine:1.0 eth:1.0 miner:1.0 net:1.0 rpc:1.0 txpool:1.0 web3:1.0</span><br><span class="line"></span><br><span class="line">To exit, press ctrl-d or type exit</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来就可以输入JS代码</p>
<h2 id="Metamask添加网络"><a href="#Metamask添加网络" class="headerlink" title="Metamask添加网络"></a>Metamask添加网络</h2><p><img src="/images/blockchain/ethereum/kurtosis_metamask_add_network.jpg" alt="kurtosis_metamask_add_network"></p>
<p>根据Kurtosis部署过程中输出的信息添加Metamask网络</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/09/blockchain/ethereum/solidity-state-layout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/09/blockchain/ethereum/solidity-state-layout/" class="post-title-link" itemprop="url">Solidity中的存储布局和内存布局</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-09 14:42:13" itemprop="dateCreated datePublished" datetime="2024-12-09T14:42:13+08:00">2024-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-10 13:18:06" itemprop="dateModified" datetime="2024-12-10T13:18:06+08:00">2024-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>EVM 的整个空间被逻辑上划分为不同的区域，分别为栈（Stack）、内存（Memory）、存储（Storage）、代码（Code）和常量区域。</p>
<p><strong>栈区域（Stack）区域</strong></p>
<ul>
<li>特点:<ul>
<li>栈是一个 固定大小 的数据区域，最大为 1024 个字（每个字 32 字节）。</li>
<li>用于存储操作数、临时值，以及函数调用的返回地址。</li>
<li>数据只能通过 push 和 pop 操作访问。</li>
</ul>
</li>
<li>作用: 函数内部的临时变量和操作数首先存储在栈中。</li>
</ul>
<p><strong>内存 (Memory)区域</strong></p>
<ul>
<li>功能: 用于临时存储数据，生命周期仅在交易或调用期间有效。</li>
<li>地址范围: 逻辑地址从<code>0</code>开始，可以按需扩展，理论上可以扩展到 <code>2^256 - 1</code>。</li>
<li>特点:<ul>
<li>按 32 字节（256 位）对齐。</li>
<li>初始化时为空（零值）。</li>
<li>按需分配时会增加 gas 消耗。</li>
</ul>
</li>
<li>作用: 用于存储函数的局部变量、动态数组、字符串、函数参数等。</li>
</ul>
<p><strong>数据调用区域（Calldata）</strong></p>
<ul>
<li>特点:<ul>
<li>是不可修改的只读区域，用于传递外部函数调用的输入数据。</li>
<li>效率高，Gas 消耗低。</li>
</ul>
</li>
<li>作用：效率高，Gas 消耗低。</li>
</ul>
<p><strong>存储 (Storage)区域</strong></p>
<ul>
<li>地址范围：存储区域的地址范围是从 0 到 2^256 - 1。</li>
<li>存储单元：每个存储槽（storage slot）大小为 32 字节（256 位）。</li>
<li>访问方式：存储按照 键值对的形式 存储，每个键为 256 位的存储槽地址，每个值为 256 位的存储内容。</li>
<li>作用：存储合约的全局状态。</li>
</ul>
<h1 id="Storage-Layout-存储布局"><a href="#Storage-Layout-存储布局" class="headerlink" title="Storage Layout (存储布局)"></a>Storage Layout (存储布局)</h1><p>存储状态布局涉及 合约的存储变量如何映射到 EVM 的存储空间。EVM 的存储空间是一个巨大的 256 位地址空间，采用键值对形式。每个存储槽（slot）存储 32 字节数据。</p>
<p>EVM 的存储区域采用 哈希映射结构 存储数据：</p>
<ul>
<li>简单变量：直接按照顺序存储，每个变量占用一个或部分存储槽。</li>
<li>复杂数据结构：<ul>
<li>数组：第一个槽存储长度，数据存储在 <code>keccak256(slot)</code> 地址开始的连续存储槽中。</li>
<li>映射：数据存储在 <code>keccak256(key, slot)</code> 地址处，key 是映射键，slot 是映射变量在合约中的存储槽编号。</li>
<li>结构体：将结构体的成员顺序存储，每个成员分配单独的存储槽。</li>
</ul>
</li>
</ul>
<h2 id="存储分配规则"><a href="#存储分配规则" class="headerlink" title="存储分配规则"></a>存储分配规则</h2><ol>
<li><p>基础规则</p>
<ul>
<li>变量顺序存储: 每个状态变量按声明顺序分配存储槽，优先填充当前槽剩余空间。</li>
<li>一个槽的大小为 32 字节。</li>
<li>如果变量类型大小超过槽大小（如 uint256），则占据一个完整槽。</li>
<li>较小变量（如 uint8、bool）在同一槽中紧密打包，但不能跨槽。</li>
</ul>
</li>
<li><p>映射（Mapping）</p>
<ul>
<li>映射的键值对（key-value）不会紧密打包在槽中。</li>
<li>每个键（key）对应的值（value）存储在一个唯一的槽中，其地址由<code>keccak256(key, slot)</code> 计算</li>
<li>键（key）不会存储在存储区域中，键值（key-value）对中的“键（key）”并没有单独存储的槽。所以无法直接遍历Mapping</li>
</ul>
</li>
<li><p>动态数组与字符串</p>
<ul>
<li>元数据存储：动态数组的主槽（主存储槽）中存储的是数组的长度。</li>
<li>数据存储：数组的实际数据存储在与主槽分开的连续存储槽中。<ul>
<li>数据槽的起始地址由 keccak256(slot) 计算得出，slot 是动态数组的主槽编号。</li>
<li>数组中的每个元素按照顺序依次存储在数据槽中。</li>
</ul>
</li>
<li>字符串与动态数组处理相似。</li>
</ul>
</li>
<li><p>结构体（Struct）</p>
<ul>
<li>结构体的变量按顺序存储。</li>
<li>结构体变量紧密打包（类似单个槽中存储的变量）。</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract StateLayoutExample &#123;</span><br><span class="line">    uint256 public number;         // Slot 0</span><br><span class="line">    bool public flag;              // Slot 1 (packed with `smallValue` if space allows)</span><br><span class="line">    uint16 public smallValue;      // Slot 1</span><br><span class="line">    mapping(uint256 =&gt; uint256) public map; // Data stored at keccak256(key, 2)</span><br><span class="line">    uint256[] public dynamicArray; // Slot 3: array length; data starts at keccak256(3)</span><br><span class="line">    struct MyStruct &#123;</span><br><span class="line">        uint256 largeValue;        // Slot 4</span><br><span class="line">        uint8 smallPart;           // Slot 4 (packed with other struct fields)</span><br><span class="line">    &#125;</span><br><span class="line">    MyStruct public myStruct;      // Struct occupies its own slots</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行命令 <code>solc --storage-layout --transient-storage-layout StateLayoutExample.sol</code> 查看合约存储布局 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;storage&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;number&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">5</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;flag&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_bool&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">7</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;smallValue&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint16&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">11</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;map&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_mapping(t_uint256,t_uint256)&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">14</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;dynamicArray&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;3&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_array(t_uint256)dyn_storage&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;myStruct&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;4&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_struct(MyStruct)19_storage&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;t_array(t_uint256)dyn_storage&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;base&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">,</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;dynamic_array&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint256[]&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;32&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_bool&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;bool&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_mapping(t_uint256,t_uint256)&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;mapping&quot;</span><span class="punctuation">,</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;mapping(uint256 =&gt; uint256)&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;32&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_struct(MyStruct)19_storage&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;struct StateLayoutExample.MyStruct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;members&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">16</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;largeValue&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint256&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#123;</span><span class="attr">&quot;astId&quot;</span><span class="punctuation">:</span><span class="number">18</span><span class="punctuation">,</span><span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span><span class="string">&quot;StateLayoutExample.sol:StateLayoutExample&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;smallPart&quot;</span><span class="punctuation">,</span><span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;slot&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;t_uint8&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;64&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_uint16&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint16&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_uint256&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint256&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;32&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;t_uint8&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;inplace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;label&quot;</span><span class="punctuation">:</span><span class="string">&quot;uint8&quot;</span><span class="punctuation">,</span><span class="attr">&quot;numberOfBytes&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>storage</strong></p>
<p>描述每个状态变量的存储位置：<br>    - <code>slot</code>: 存储槽号。<br>    - <code>offset</code>: 偏移量，表示变量在槽内的起始位置。<br>    - <code>type</code>: 变量的类型标识，与 types 部分中的描述对应。</p>
<p><strong>types</strong></p>
<p>定义每种数据类型的详细信息：<br>    - <code>encoding</code>: 数据的存储方式（如 inplace 或 dynamic_array）。<br>    - <code>numberOfBytes</code>: 占用的字节数。<br>    - <code>members</code>: 如果是结构体，列出所有成员及其存储位置。<br>    - <code>base</code>: 如果是数组，表示基础类型。</p>
<h1 id="Memory-Layout-内存布局"><a href="#Memory-Layout-内存布局" class="headerlink" title="Memory Layout (内存布局)"></a>Memory Layout (内存布局)</h1><p>在 Solidity 中，内存（Memory） 是 EVM 提供的一种线性存储结构，主要用于在函数调用过程中存储临时变量、局部变量和中间计算结果。内存是按需分配的，不同于存储（Storage），内存是 瞬时的，在调用结束后会被释放，且读写成本较低。</p>
<p>内存是一个 按字节寻址的线性空间，地址范围从 0x00 到无限大（理论上为 2^256 - 1）。但在实际操作中，内存的分配是动态增长的，EVM 会根据需要分配内存，并且以 32 字节（一个字）为单位扩展。</p>
<pre><code>- 每个内存地址存储一个字节。
- 每 32 个字节组成一个字（word），这是 EVM 操作的基本单位。
</code></pre>
<p>内存布局的设计遵循以下原则：</p>
<ol>
<li>按需动态分配:<ul>
<li>Solidity 会在需要时从内存中分配新的空间。</li>
<li>起始空闲内存地址存储在 0x40，可通过 mload(0x40) 获取。</li>
</ul>
</li>
<li>按 32 字节对齐:<ul>
<li>内存分配是以 32 字节为单位对齐的，即使是 bool 等小数据类型也会占用 32 字节。</li>
</ul>
</li>
<li>变量存储位置:<ul>
<li>固定大小类型直接存储其值。</li>
<li>动态类型存储一个指针，指向实际数据的内存地址。</li>
</ul>
</li>
</ol>
<h2 id="固定分配区域"><a href="#固定分配区域" class="headerlink" title="固定分配区域"></a>固定分配区域</h2><p>Solidity保留了四个32字节的插槽，具体的字节范围（包括端点）使用如下：</p>
<ul>
<li>0x00 ~ 0x3f（64Byte）<ul>
<li>用于哈希方法的临时空间</li>
<li>临时空间可以在语句之间使用（即在内联汇编之中）。</li>
</ul>
</li>
<li>0x40 ~ 0x5f (Free memory pointer 32Byte):<ul>
<li>mstore(0x40, …) 用于指向当前空闲内存的起始地址。</li>
<li>Solidity 使用内存时，会从该地址开始分配。</li>
<li>开发者不需要手动管理，但在使用汇编时，需要注意维护 0x40 的正确值。</li>
</ul>
</li>
<li>0x60 ~ 0x7f（Zero pointer 32Byte):<ul>
<li>保留一块全零的内存区域，通常用于返回零值。</li>
<li>0值插槽则用来对动态内存数组进行初始化，且永远不会写入数据 （因而可用的初始内存指针为 0x80）。</li>
</ul>
</li>
</ul>
<p>Solidity 总会把新对象保存在空闲内存指针的位置， 所以这段内存实际上从来不会空闲（在未来可能会修改这个机制）。</p>
<h2 id="动态分配区域"><a href="#动态分配区域" class="headerlink" title="动态分配区域"></a>动态分配区域</h2><p>Solidity 的局部变量、动态数组和字符串都从 0x80 开始动态分配，并按照实际需要扩展。</p>
<p>分配规则：<br>    - 内存分配以 32 字节为单位对齐。<br>    - 临时变量直接写入内存对应的位置。<br>    - 动态类型需要额外存储元数据（如长度和起始地址）。</p>
<h2 id="内存中的数据类型布局"><a href="#内存中的数据类型布局" class="headerlink" title="内存中的数据类型布局"></a>内存中的数据类型布局</h2><h3 id="固定大小的类型"><a href="#固定大小的类型" class="headerlink" title="固定大小的类型"></a>固定大小的类型</h3><ul>
<li>包括 uint256、address、bool 等。</li>
<li>直接按 32 字节对齐存储，例如：<ul>
<li>uint256 占用 32 字节。</li>
<li>bool 也占用 32 字节（尽管实际值只需 1 字节）。</li>
</ul>
</li>
</ul>
<h3 id="动态类型"><a href="#动态类型" class="headerlink" title="动态类型"></a>动态类型</h3><p>动态类型（如 string、bytes 和动态数组）会分为两个部分：</p>
<ol>
<li>指针部分：主变量存储的是指向实际数据的偏移量（相对于起始地址 0x80 的偏移量）。</li>
<li>数据部分：存储动态类型的元数据（如长度）和实际数据。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MemoryExample &#123;</span><br><span class="line">    function demo() public pure returns (bytes memory, string memory) &#123;</span><br><span class="line">        bytes memory byteArray = new bytes(10); // 动态字节数组</span><br><span class="line">        string memory str = &quot;Hello, Memory!&quot;;</span><br><span class="line">        return (byteArray, str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>byteArray</code>:<ul>
<li>主变量存储数据偏移量，例如 0x80。</li>
<li>数据存储从 0x80 开始：<ul>
<li>长度（10 字节）：存储在 0x80。</li>
<li>实际内容（10 字节）：从 0xA0 开始。</li>
</ul>
</li>
</ul>
</li>
<li><code>str</code>:<ul>
<li>主变量存储数据偏移量，例如 0xE0。</li>
<li>数据存储从 0xE0 开始：<ul>
<li>长度（14 字节）：存储在 0xE0。</li>
<li>实际内容（”Hello, Memory!”）：从 0x100 开始。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="State-Layout-和-Memory-Layout-的区别"><a href="#State-Layout-和-Memory-Layout-的区别" class="headerlink" title="State Layout 和 Memory Layout 的区别"></a>State Layout 和 Memory Layout 的区别</h1><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="left">状态布局 (State Layout)</th>
<th align="left">内存布局 (Memory Layout)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">存储位置</td>
<td align="left">持久化存储在 EVM 存储 (Storage) 中</td>
<td align="left">函数调用时临时存储在 EVM 内存 (Memory) 中</td>
</tr>
<tr>
<td align="center">生命周期</td>
<td align="left">持久化，合约销毁之前一直存在</td>
<td align="left">临时，函数执行结束即释放</td>
</tr>
<tr>
<td align="center">成本</td>
<td align="left">写入存储需要高 Gas 成本</td>
<td align="left">使用内存成本较低</td>
</tr>
<tr>
<td align="center">用途</td>
<td align="left">存储合约的持久化数据</td>
<td align="left">处理临时计算或函数的中间结果</td>
</tr>
</tbody></table>
<p><strong>Gas 优化建议</strong></p>
<ul>
<li>状态变量优化<ul>
<li>紧密打包变量，减少存储槽的使用。</li>
<li>避免在循环中频繁读写存储。</li>
</ul>
</li>
<li>内存优化<ul>
<li>使用临时变量代替状态变量进行中间计算。</li>
<li>适时释放不再使用的内存。</li>
</ul>
</li>
</ul>
<p> 了解 Solidity 的状态与内存布局，能帮助开发者高效设计合约，同时优化 Gas 成本。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/05/blockchain/ethereum/solidity-reduce-gas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/05/blockchain/ethereum/solidity-reduce-gas/" class="post-title-link" itemprop="url">solidity合约中如何减少gas消耗</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-12-05 17:02:46" itemprop="dateCreated datePublished" datetime="2024-12-05T17:02:46+08:00">2024-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-06 10:32:27" itemprop="dateModified" datetime="2024-12-06T10:32:27+08:00">2024-12-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>从设计原则、编码技巧、数据存储优化和具体示例四个方面，系统地讲解如何在 Solidity 合约中节省 Gas 费用。</p>
<h1 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h1><p><strong>减少合约调用次数</strong></p>
<ul>
<li>将多个逻辑步骤合并到单一函数中，避免多次外部调用。</li>
<li>尽量减少合约之间的交互，因为每次外部调用都涉及高 Gas 消耗。</li>
</ul>
<p><strong>避免频繁修改状态变量</strong></p>
<ul>
<li>修改状态变量（如 storage）比操作本地变量（如 memory）耗费更多 Gas。</li>
<li>在逻辑中优先使用本地变量，计算完后一次性更新状态变量。</li>
</ul>
<p><strong>简化复杂计算</strong></p>
<ul>
<li>将复杂计算移到链下处理，通过链上存储结果代替。</li>
<li>在链下生成哈希值等，只存储结果以减少链上计算开销。</li>
</ul>
<h1 id="编码技巧"><a href="#编码技巧" class="headerlink" title="编码技巧"></a>编码技巧</h1><h2 id="使用-view-和-pure-函数"><a href="#使用-view-和-pure-函数" class="headerlink" title="使用 view 和 pure 函数"></a>使用 view 和 pure 函数</h2><p>view 函数不修改状态，pure 函数不依赖链上状态，调用它们不消耗 Gas。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function add(uint a, uint b) public pure returns (uint) &#123;</span><br><span class="line">    return a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="精简数据类型"><a href="#精简数据类型" class="headerlink" title="精简数据类型"></a>精简数据类型</h2><ul>
<li>使用适合的数据类型，比如 uint8 而非 uint256（仅当值范围确定小于 256）。</li>
<li>避免布尔值，因为布尔操作实际存储在 256 位。</li>
</ul>
<h2 id="利用-calldata-代替-memory"><a href="#利用-calldata-代替-memory" class="headerlink" title="利用 calldata 代替 memory"></a>利用 calldata 代替 memory</h2><p>函数的外部输入参数可用 calldata，节省内存分配成本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function processData(uint[] calldata data) external &#123;</span><br><span class="line">    // calldata 参数直接使用，无需复制</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="事件替代状态变量"><a href="#事件替代状态变量" class="headerlink" title="事件替代状态变量"></a>事件替代状态变量</h2><p>使用 emit 事件记录某些数据，而非存储状态变量。事件存储在日志中，成本低于 storage。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event DataProcessed(address indexed user, uint amount);</span><br></pre></td></tr></table></figure>

<h2 id="合理使用-immutable-和-constant"><a href="#合理使用-immutable-和-constant" class="headerlink" title="合理使用 immutable 和 constant"></a>合理使用 immutable 和 constant</h2><ul>
<li>immutable：部署后值不可更改，但比普通变量读取快。</li>
<li>constant：在编译时决定值，不占用存储空间。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint256 public immutable deployTime = block.timestamp;</span><br><span class="line">uint256 public constant FEE_RATE = 100;</span><br></pre></td></tr></table></figure>

<h1 id="数据存储优化"><a href="#数据存储优化" class="headerlink" title="数据存储优化"></a>数据存储优化</h1><h2 id="批量更新状态变量"><a href="#批量更新状态变量" class="headerlink" title="批量更新状态变量"></a>批量更新状态变量</h2><p>将多次状态变量更新合并为一次。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 不推荐</span><br><span class="line">balance = balance + 10;</span><br><span class="line">counter = counter + 1;</span><br><span class="line"></span><br><span class="line">// 推荐</span><br><span class="line">balance += 10;</span><br><span class="line">counter += 1;</span><br></pre></td></tr></table></figure>

<h2 id="使用结构体或映射存储数据"><a href="#使用结构体或映射存储数据" class="headerlink" title="使用结构体或映射存储数据"></a>使用结构体或映射存储数据</h2><p>将多个相关变量合并到一个 struct 或映射中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct User &#123;</span><br><span class="line">    uint256 balance;</span><br><span class="line">    uint256 lastUpdated;</span><br><span class="line">&#125;</span><br><span class="line">mapping(address =&gt; User) users;</span><br></pre></td></tr></table></figure>

<h2 id="减少存储变量数量"><a href="#减少存储变量数量" class="headerlink" title="减少存储变量数量"></a>减少存储变量数量</h2><p>优化存储布局，减少存储槽的使用（每个槽 32 字节）。多个变量可以合并到一个存储槽中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 不推荐</span><br><span class="line">uint128 public var1;</span><br><span class="line">uint128 public var2;</span><br><span class="line"></span><br><span class="line">// 推荐</span><br><span class="line">struct Combined &#123;</span><br><span class="line">    uint128 var1;</span><br><span class="line">    uint128 var2;</span><br><span class="line">&#125;</span><br><span class="line">Combined public data;</span><br></pre></td></tr></table></figure>

<h2 id="删除不必要的状态变量"><a href="#删除不必要的状态变量" class="headerlink" title="删除不必要的状态变量"></a>删除不必要的状态变量</h2><p>使用 delete 删除已用完的存储变量，释放存储空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete users[userAddress];</span><br></pre></td></tr></table></figure>

<h1 id="其他优化建议"><a href="#其他优化建议" class="headerlink" title="其他优化建议"></a>其他优化建议</h1><ol>
<li>代码复用</li>
</ol>
<ul>
<li>将重复逻辑封装为内部函数，减少代码重复和部署大小。</li>
<li>使用库（library）减少代码复制。</li>
</ul>
<ol start="2">
<li>优化循环</li>
</ol>
<ul>
<li>避免大规模循环操作，因为每次迭代都会增加 Gas。</li>
<li>可以分阶段处理数据，减少单次调用的负载。</li>
</ul>
<ol start="3">
<li>Gas 预言机</li>
</ol>
<ul>
<li>部署前使用工具（如 Remix、Hardhat）模拟和估算 Gas。</li>
<li>优化部署的 Gas 成本。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/12/05/blockchain/ethereum/solidity-contract-creation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/05/blockchain/ethereum/solidity-contract-creation/" class="post-title-link" itemprop="url">创建管理合约</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-12-05 10:55:39 / Modified: 13:18:30" itemprop="dateCreated datePublished" datetime="2024-12-05T10:55:39+08:00">2024-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在 Solidity 中，一个合约可以通过多种方式在另一个合约中创建和管理另一个合约。</p>
<h1 id="合约内部部署（创建一个新合约"><a href="#合约内部部署（创建一个新合约" class="headerlink" title="合约内部部署（创建一个新合约"></a>合约内部部署（创建一个新合约</h1><p>Solidity 允许你在一个合约内部部署另一个合约。这通常是通过在合约中创建一个新的合约实例来实现的。你可以在构造函数或其他函数中动态部署一个新合约。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">        </span><br><span class="line">    constructor(address _owner) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">                            </span><br><span class="line">    function getOwner() public view returns (address) &#123;</span><br><span class="line">        return owner;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract CreatorContract &#123;</span><br><span class="line">    address public lastCreatedContract;</span><br><span class="line">    </span><br><span class="line">    function createNewContract() public &#123;</span><br><span class="line">        NewContract newContract = new NewContract(msg.sender);</span><br><span class="line">        lastCreatedContract = address(newContract);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>CreatorContract 中有一个 createNewContract 函数，它使用 new 关键字创建了一个 NewContract 实例。NewContract 合约的构造函数接收 msg.sender 作为参数，意味着新合约的 owner 将是调用 createNewContract 函数的账户。</li>
<li>创建的新合约地址会存储在 lastCreatedContract 中。</li>
</ul>
<h1 id="合约工厂模式（Factory-Pattern）"><a href="#合约工厂模式（Factory-Pattern）" class="headerlink" title="合约工厂模式（Factory Pattern）"></a>合约工厂模式（Factory Pattern）</h1><p>另一种常见的做法是使用工厂模式，即一个合约作为工厂来部署多个合约实例。工厂合约允许你根据需要创建新合约，并管理这些合约实例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Item &#123;</span><br><span class="line">    uint public id;</span><br><span class="line">    address public creator;</span><br><span class="line">        </span><br><span class="line">    constructor(uint _id, address _creator) &#123;</span><br><span class="line">        id = _id;</span><br><span class="line">        creator = _creator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ItemFactory &#123;</span><br><span class="line">    Item[] public items;</span><br><span class="line">    </span><br><span class="line">    function createItem(uint _id) public &#123;</span><br><span class="line">        Item newItem = new Item(_id, msg.sender);</span><br><span class="line">        items.push(newItem);</span><br><span class="line">    &#125;</span><br><span class="line">                                                                    </span><br><span class="line">    function getItems() public view returns (Item[] memory) &#123;</span><br><span class="line">        return items;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>ItemFactory 是一个工厂合约，它可以创建多个 Item 合约的实例，每个 Item 合约的创建者是调用工厂合约的账户。</li>
<li>createItem 函数部署了一个新的 Item 合约，并将它存储在 items 数组中。</li>
</ul>
<h1 id="调用外部合约（外部合约部署后实例化）"><a href="#调用外部合约（外部合约部署后实例化）" class="headerlink" title="调用外部合约（外部合约部署后实例化）"></a>调用外部合约（外部合约部署后实例化）</h1><p>有时，合约不需要在自己内部部署其他合约，而是可以通过调用已经部署的外部合约的地址来与其交互。这不是“创建”合约，但却是一种与其他合约交互的方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface IExternalContract &#123;</span><br><span class="line">    function getOwner() external view returns (address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ContractInteraction &#123;</span><br><span class="line">    IExternalContract public externalContract;</span><br><span class="line">            </span><br><span class="line">    constructor(address _externalContractAddress) &#123;</span><br><span class="line">        externalContract = IExternalContract(_externalContractAddress);</span><br><span class="line">    &#125;</span><br><span class="line">                                </span><br><span class="line">    function getExternalOwner() public view returns (address) &#123;</span><br><span class="line">        return externalContract.getOwner();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>ContractInteraction 合约通过接口与外部合约交互，调用了 IExternalContract 中的 getOwner 函数。</li>
<li>外部合约已经部署并被传入构造函数，ContractInteraction 合约与它交互。</li>
</ul>
<h1 id="使用-create2-来部署合约（指定地址部署）"><a href="#使用-create2-来部署合约（指定地址部署）" class="headerlink" title="使用 create2 来部署合约（指定地址部署）"></a>使用 create2 来部署合约（指定地址部署）</h1><p>create2 是一种更高级的部署方法，它允许你通过指定合约地址来部署合约。使用 create2 可以确保合约在指定的地址上部署，前提是你知道合约的字节码和盐值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract FactoryWithCreate2 &#123;</span><br><span class="line">    event ContractCreated(address contractAddress);</span><br><span class="line"></span><br><span class="line">    function createNewContract(bytes32 salt) public &#123;</span><br><span class="line">        address newContractAddress;</span><br><span class="line">        bytes memory bytecode = type(NewContract).creationCode;</span><br><span class="line">                                        </span><br><span class="line">        assembly &#123;</span><br><span class="line">            newContractAddress := create2(0, add(bytecode, 0x20), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">                                                                            </span><br><span class="line">        emit ContractCreated(newContractAddress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    address public creator;</span><br><span class="line">    </span><br><span class="line">    constructor() &#123;</span><br><span class="line">        creator = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>解释：</strong></p>
<ul>
<li>createNewContract 函数使用 create2 来部署一个新的 NewContract 合约。</li>
<li>create2 允许你在部署时指定一个 salt，确保你可以预测到部署合约的地址，前提是知道合约的字节码。</li>
</ul>
<h2 id="扩展信息"><a href="#扩展信息" class="headerlink" title="扩展信息"></a>扩展信息</h2><p>在 Solidity 中，type(NewContract).creationCode 是一种用于获取合约字节码的方法，它表示合约的创建代码。合约的字节码（bytecode）是它部署到区块链上的机器代码，其中包含了合约的逻辑和部署时所需的初始化数据。</p>
<p><strong>合约字节码的组成部分</strong></p>
<p>合约字节码可以分为以下几个主要部分：</p>
<ol>
<li>合约构造函数的初始化字节码</li>
<li>部署过程中的合约代码</li>
<li>合约的状态变量初始值</li>
</ol>
<h3 id="合约构造函数的初始化字节码"><a href="#合约构造函数的初始化字节码" class="headerlink" title="合约构造函数的初始化字节码"></a>合约构造函数的初始化字节码</h3><ul>
<li>构造函数的字节码：每个合约在部署时都会执行其构造函数。creationCode 中包含了构造函数的代码部分，它负责初始化合约的状态，通常包括合约的状态变量赋值、事件初始化等操作。</li>
<li>初始化参数：如果构造函数带有参数（例如合约需要初始化的状态变量），这些参数也会包含在 creationCode 中。部署合约时需要传递这些参数。</li>
</ul>
<p>creationCode：合约的“创建代码”，是用于部署合约的字节码，包含了构造函数的执行内容以及初始化步骤。在合约部署时，链上会执行这段创建代码，初始化合约，并且部署合约的 runtimeCode</p>
<p>type(NewContract).creationCode 提供了一个方法来获取合约的 创建代码（即部署合约时使用的字节码），这段代码由合约的构造函数（constructor）以及合约的初始化部分组成，执行时会将合约的运行时代码存储在区块链上。</p>
<p>creationCode 是合约创建时所需的字节码，包括构造函数的初始化部分、合约的部署逻辑等。</p>
<h3 id="部署过程中的合约代码"><a href="#部署过程中的合约代码" class="headerlink" title="部署过程中的合约代码"></a>部署过程中的合约代码</h3><ul>
<li>字节码本体：合约部署的代码（通常是 runtime code）会在合约创建时存储在链上。这个字节码本体包括了所有的业务逻辑和函数实现。它包含了所有合约的行为和功能，例如状态修改、函数调用等。</li>
</ul>
<p>runtimeCode：合约部署后剩余的代码，包含了合约的所有业务逻辑。合约一旦部署完成，它的 runtimeCode 就是唯一存在于区块链上的代码，而 creationCode 则只在合约创建时有作用。</p>
<h3 id="合约的状态变量初始值"><a href="#合约的状态变量初始值" class="headerlink" title="合约的状态变量初始值"></a>合约的状态变量初始值</h3><ul>
<li>初始化存储：合约在部署时，通常会有一些状态变量。它们的初始值会作为部署合约时的一部分被编码到创建代码中（如果有默认值）。这些值将在合约部署后存储到合约的状态中。</li>
</ul>
<h2 id="create-和-create2"><a href="#create-和-create2" class="headerlink" title="create 和 create2"></a>create 和 create2</h2><p>在 Solidity 中，create 和 create2 是用于部署合约的两种不同方法。二者的主要区别在于如何计算合约地址及其对地址预测的能力。理解这两者的原理及其差异对于优化合约部署和管理合约地址是非常重要的。</p>
<h3 id="create-的原理"><a href="#create-的原理" class="headerlink" title="create 的原理"></a>create 的原理</h3><p>create 是最常见的合约部署方式，它通过在 Ethereum 网络上发送一笔交易来部署一个新的合约。</p>
<ul>
<li>部署过程：合约的字节码通过交易提交到区块链网络，然后在区块链中分配一个新的地址。</li>
<li>地址计算：create 部署的合约的地址由 创建者的地址（msg.sender） 和 创建交易的nonce 决定。</li>
</ul>
<p><strong>合约地址计算公式：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address = keccak256(rlp_encode(sender, nonce))[12:]</span><br></pre></td></tr></table></figure>

<ul>
<li>sender：部署合约的账户地址（msg.sender）。</li>
<li>nonce：msg.sender 的交易计数，即发送交易的次数。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address create(uint256 value, bytes memory bytecode, uint256 bytecodeSize)</span><br></pre></td></tr></table></figure>

<ol>
<li>value（uint256）：该参数表示向新合约发送的以太币数量。在合约部署时，你可以指定一个 value，这部分以太币将转移到新部署的合约中。若不想发送以太币，value 为 0。<br> value 是一个 uint256 类型，表示你要发送到新合约的以太币金额。</li>
<li>bytecode（bytes memory）：即合约的字节码，它是合约代码的二进制形式。这是通过 type(Contract).creationCode 或其他类似的方法获取的合约字节码。<br> 这段字节码包含了合约的构造函数以及合约的逻辑代码。可以通过 type(MyContract).creationCode 获取。add(bytecode, 0x20) 字节码的存储位置，跳过前 32 字节，指向字节码的实际数据。</li>
<li>bytecodeSize(uint256) : 它表示合约字节码的长度（通常是 32 字节）。</li>
</ol>
<h4 id="使用create"><a href="#使用create" class="headerlink" title="使用create"></a>使用create</h4><p>create 是标准的合约部署方式，适用于常规场景。通常情况下，您无需关心合约的地址，只需让合约被部署到区块链即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    uint256 public value;</span><br><span class="line">    </span><br><span class="line">    constructor(uint256 _value) &#123;</span><br><span class="line">        value = _value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Factory &#123;</span><br><span class="line">    address public deployedContract;</span><br><span class="line">    </span><br><span class="line">    function deploy(uint256 _value, bytes32 _salt) external &#123;</span><br><span class="line">        bytes memory bytecode = type(NewContract).creationCode;  // 获取合约字节码</span><br><span class="line">        address contractAddress;</span><br><span class="line">        </span><br><span class="line">        assembly &#123;</span><br><span class="line">            contractAddress := create(0, add(bytecode, 0x20), mload(bytecode))</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        deployedContract = contractAddress;  // 记录新合约地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，Factory 合约会通过 create 部署一个新的 NewContract 合约。NewContract 的地址由 msg.sender 和 nonce 决定，因此无法在部署前预测。</p>
<h3 id="create2-的原理"><a href="#create2-的原理" class="headerlink" title="create2 的原理"></a>create2 的原理</h3><p>create2 是 Solidity 0.5.0 引入的一种新的合约部署方式，它为部署合约提供了额外的控制能力，特别是在可预测的合约地址生成方面。与 create 不同，create2 的合约地址不仅由部署者的地址和交易 nonce 决定，还由以下额外的内容决定：</p>
<ul>
<li>部署者的地址 (msg.sender)</li>
<li>salt：一个额外的任意字节值</li>
<li>合约字节码的哈希：即部署的合约的字节码。</li>
</ul>
<p><strong>合约地址计算公式：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address = keccak256(0xff ++ sender ++ salt ++ keccak256(bytecode))[12:]</span><br></pre></td></tr></table></figure>

<ul>
<li>0xff 是一个常量，用于确保合约地址计算的唯一性。</li>
<li>sender 是合约创建者的地址。</li>
<li>salt 是一个提供给 create2 的自定义值，可以是任意字节。</li>
<li>bytecode 是合约的字节码。</li>
</ul>
<p>create2 使得合约的地址可以在合约部署之前预先计算出来，因此我们可以在部署合约之前预测合约的地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address create2(uint256 value, bytes memory bytecode, uint256 bytecodeSize, bytes32 salt)</span><br></pre></td></tr></table></figure>

<ol>
<li>value（uint256）：该参数表示向新合约发送的以太币数量。在合约部署时，你可以指定一个 value，这部分以太币将转移到新部署的合约中。若不想发送以太币，value 为 0。<br> value 是一个 uint256 类型，表示你要发送到新合约的以太币金额。</li>
<li>bytecode（bytes memory）：即合约的字节码，它是合约代码的二进制形式。这是通过 type(Contract).creationCode 或其他类似的方法获取的合约字节码。<br> 这段字节码包含了合约的构造函数以及合约的逻辑代码。可以通过 type(MyContract).creationCode 获取。add(bytecode, 0x20) 字节码的存储位置，跳过前 32 字节，指向字节码的实际数据。</li>
<li>bytecodeSize(uint256) : 它表示合约字节码的长度（通常是 32 字节）。</li>
<li>salt（bytes32）：salt 是一个自定义的 bytes32 类型值，它为合约的创建地址提供一个“随机数”。salt 用于确保合约地址计算的唯一性。通过修改 salt 的值，可以控制生成的合约地址，从而为每个合约生成一个独特的地址。<br> salt 是唯一标识合约部署的一部分。你可以通过传入不同的 salt 值来生成不同的合约地址，即使合约字节码完全相同。</li>
</ol>
<h4 id="使用create2"><a href="#使用create2" class="headerlink" title="使用create2"></a>使用create2</h4><p>create2 则允许你指定一个 salt 值，进而可以提前计算出部署后的合约地址。这对于某些应用非常有用，例如需要在合约创建之前就知道合约的地址，或者在某些情境下需要复用相同地址的合约。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract NewContract &#123;</span><br><span class="line">    uint256 public value;</span><br><span class="line">    </span><br><span class="line">    constructor(uint256 _value) &#123;</span><br><span class="line">        value = _value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Factory &#123;</span><br><span class="line">    address public deployedContract;</span><br><span class="line">    </span><br><span class="line">    function deploy(uint256 _value, bytes32 _salt) external &#123;</span><br><span class="line">        bytes memory bytecode = type(NewContract).creationCode;  // 获取合约字节码</span><br><span class="line">        bytes32 salt = _salt;  // 使用用户传入的 salt 值</span><br><span class="line">        address contractAddress;</span><br><span class="line">        </span><br><span class="line">        assembly &#123;</span><br><span class="line">            contractAddress := create2(0, add(bytecode, 0x20), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        deployedContract = contractAddress;  // 记录新合约地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，Factory 合约使用 create2 部署一个 NewContract 合约。通过传入 salt 值，create2 会计算出一个特定的合约地址。这样，你可以在合约部署之前预测合约的地址。合约地址的计算基于 bytecode 和 salt 的哈希，因此只要 salt 和 bytecode 不变，生成的地址也将是固定的。</p>
<h3 id="create-和-create2-的主要区别"><a href="#create-和-create2-的主要区别" class="headerlink" title="create 和 create2 的主要区别"></a>create 和 create2 的主要区别</h3><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="left">create</th>
<th align="left">create2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">地址生成</td>
<td align="left">由 msg.sender 地址和交易 nonce 决定</td>
<td align="left">由 msg.sender 地址、salt 和合约字节码的哈希决定</td>
</tr>
<tr>
<td align="center">预测地址</td>
<td align="left">无法预测合约地址（取决于交易 nonce 和区块时间）</td>
<td align="left">可以在合约部署前预测合约地址</td>
</tr>
<tr>
<td align="center">灵活性</td>
<td align="left">地址不可控制，无法提前决定</td>
<td align="left">可以通过不同的 salt 值控制地址并预先计算</td>
</tr>
<tr>
<td align="center">安全性</td>
<td align="left">地址依赖于交易 nonce，可能会有一定的不确定性</td>
<td align="left">地址可由部署者提前确定，减少了竞争条件</td>
</tr>
<tr>
<td align="center">适用场景</td>
<td align="left">普通合约部署</td>
<td align="left">需要提前知道合约地址的场景</td>
</tr>
<tr>
<td align="center">使用复杂度</td>
<td align="left">简单</td>
<td align="left">需要手动计算字节码和 salt</td>
</tr>
</tbody></table>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://learnblockchain.cn/article/7656">使用Create2操作码在相同的地址部署不同的代码的合约</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/" class="post-title-link" itemprop="url">重入攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-28 15:03:13 / Modified: 16:09:46" itemprop="dateCreated datePublished" datetime="2024-11-28T15:03:13+08:00">2024-11-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="重入攻击（Reentrancy-Attack）"><a href="#重入攻击（Reentrancy-Attack）" class="headerlink" title="重入攻击（Reentrancy Attack）"></a>重入攻击（Reentrancy Attack）</h1><p>重入攻击是指攻击者通过调用目标合约的某个函数，利用该函数在完成关键状态变量更新前调用外部合约的能力，从而反复调用目标合约的函数，最终实现非法的资金提取或状态操作。</p>
<h2 id="漏洞合约"><a href="#漏洞合约" class="headerlink" title="漏洞合约"></a>漏洞合约</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vulnerable &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // 存款函数</span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 提款函数，存在重入攻击漏洞</span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        // 向用户发送资金</span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line"></span><br><span class="line">        // 更新用户余额</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 合约余额</span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个容易受到重入攻击的合约，它允许用户存款并提款。</p>
<p><strong>问题:</strong></p>
<ul>
<li>在发送资金后，余额更新在后。</li>
<li>攻击者可以通过调用自己的回调函数，在 withdraw 执行完成前再次调用 withdraw，从而重复提款。</li>
</ul>
<h2 id="攻击合约"><a href="#攻击合约" class="headerlink" title="攻击合约"></a>攻击合约</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Vulnerable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    Vulnerable public vulnerable;</span><br><span class="line"></span><br><span class="line">    constructor(address _vulnerableAddress) &#123;</span><br><span class="line">        vulnerable = Vulnerable(_vulnerableAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 回退函数：用于重入攻击</span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        if (address(vulnerable).balance &gt;= 1 ether) &#123;</span><br><span class="line">            vulnerable.withdraw(1 ether); // 重复调用</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 攻击函数</span><br><span class="line">    function attack() public payable &#123;</span><br><span class="line">        require(msg.value &gt;= 1 ether, &quot;Need at least 1 ether&quot;);</span><br><span class="line">        vulnerable.deposit&#123;value: 1 ether&#125;(); // 存款</span><br><span class="line">        vulnerable.withdraw(1 ether);        // 首次提款</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 查看攻击合约余额</span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>攻击步骤：</strong></p>
<ol>
<li>攻击者部署 Attack 合约并调用 attack。</li>
<li>调用 vulnerable.withdraw(1 ether) 时触发回退函数 fallback。</li>
<li>回退函数再次调用 withdraw，在余额未更新之前反复提款。</li>
</ol>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><ul>
<li><strong>状态变量优先更新</strong>：在执行外部调用前，先更新合约的状态。</li>
<li><strong>通过加锁来限制重入</strong>：通过给<code>function</code>加锁，来限制重入，以达到防止攻击的目的。</li>
</ul>
<h2 id="状态变量优先更新"><a href="#状态变量优先更新" class="headerlink" title="状态变量优先更新"></a>状态变量优先更新</h2><p>将状态变量的更新移到外部调用之前。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vulnerable &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        // 先更新余额，后转账</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line"></span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过加锁来限制重入"><a href="#通过加锁来限制重入" class="headerlink" title="通过加锁来限制重入"></a>通过加锁来限制重入</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vulnerable &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // 通过加锁来限制重入</span><br><span class="line">    bool private locker = false;</span><br><span class="line">    modifier locked() &#123;</span><br><span class="line">        require(!locker, &quot;reentrant call&quot;);</span><br><span class="line">        locker = true;</span><br><span class="line">        _;</span><br><span class="line">        locker = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public locked &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可通过使用OpenZeppelin中提供的<code>ReentrancyGuard</code>工具来防止攻击，<code>ReentrancyGuard</code>机制与锁机制相同。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Vulnerable is ReentrancyGuard &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 amount) public nonReentrant &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Transfer failed&quot;);</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/28/blockchain/ethereum/solidity-security/" class="post-title-link" itemprop="url">solidity编程安全</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-28 14:20:13" itemprop="dateCreated datePublished" datetime="2024-11-28T14:20:13+08:00">2024-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-04 15:00:42" itemprop="dateModified" datetime="2024-12-04T15:00:42+08:00">2024-12-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在编写 Solidity 智能合约时，安全性是最重要的考虑因素之一。以下是开发中常见的安全问题及其解决方法：</p>
<h1 id="重入攻击（Reentrancy-Attack）"><a href="#重入攻击（Reentrancy-Attack）" class="headerlink" title="重入攻击（Reentrancy Attack）"></a>重入攻击（Reentrancy Attack）</h1><p><a href="https://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/">https://zhoubofsy.github.io/2024/11/28/blockchain/ethereum/solidity-security-reentrancy-attack/</a></p>
<h1 id="溢出与下溢（Overflow-and-Underflow）"><a href="#溢出与下溢（Overflow-and-Underflow）" class="headerlink" title="溢出与下溢（Overflow and Underflow）"></a>溢出与下溢（Overflow and Underflow）</h1><p><strong>溢出（Overflow）和下溢（Underflow）</strong>是指在处理整数运算时，当结果超出数据类型表示范围时，值会“环绕”到另一端。例如，对于 uint8 类型：</p>
<ul>
<li>溢出： uint8 的最大值是 255，如果执行 255 + 1，值会变为 0。</li>
<li>下溢： uint8 的最小值是 0，如果执行 0 - 1，值会变为 255。</li>
</ul>
<p>在早期的 Solidity 版本中，这种现象常导致严重漏洞，攻击者可以利用这种行为达到意想不到的目的。自 Solidity 0.8 开始，溢出和下溢会触发异常，但了解它们的历史以及如何防范仍然很重要。虽然Solidity 0.8开始增加了溢出检查，这也会导致Gas费用的增加。</p>
<p>在 Solidity 0.8+ 中，每次整数加减运算都会隐式包含溢出检查逻辑，而这种检查需要额外的操作指令，因此会增加运行时消耗的 gas。</p>
<p><strong>Solidity 0.8+</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract OverflowCheck &#123;</span><br><span class="line">    function add(uint256 a, uint256 b) public pure returns (uint256) &#123;</span><br><span class="line">        return a + b; // 含溢出检查</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0x00    PUSH1  0x60</span><br><span class="line">0x02    MSTORE</span><br><span class="line">0x03    CALLDATALOAD</span><br><span class="line">0x04    CALLDATALOAD</span><br><span class="line">0x05    ADD         // 加法</span><br><span class="line">0x06    JUMPI       // 检查溢出</span><br><span class="line">0x07    REVERT      // 如果溢出，回滚</span><br><span class="line">0x08    RETURN</span><br></pre></td></tr></table></figure>

<p><strong>Solidity 0.7</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.7.0;</span><br><span class="line"></span><br><span class="line">contract NoOverflowCheck &#123;</span><br><span class="line">    function add(uint256 a, uint256 b) public pure returns (uint256) &#123;</span><br><span class="line">        return a + b; // 无溢出检查</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x00    PUSH1  0x60</span><br><span class="line">0x02    MSTORE</span><br><span class="line">0x03    CALLDATALOAD</span><br><span class="line">0x04    CALLDATALOAD</span><br><span class="line">0x05    ADD         // 直接加法</span><br><span class="line">0x06    RETURN</span><br></pre></td></tr></table></figure>

<ol>
<li>Solidity 0.8 的溢出检查增加了 ~50 gas 的开销。</li>
<li>增加的开销源于额外的汇编指令（JUMPI 和 REVERT）。</li>
<li>如果对 gas 成本敏感，可以使用 unchecked 块绕过检查，但需确保逻辑安全。</li>
</ol>
<h1 id="未检查的外部调用（Unchecked-External-Call）"><a href="#未检查的外部调用（Unchecked-External-Call）" class="headerlink" title="未检查的外部调用（Unchecked External Call）"></a>未检查的外部调用（Unchecked External Call）</h1><p>“未检查的外部调用”漏洞（Unchecked External Call）是 Solidity 智能合约中的一种常见安全问题。如果智能合约与外部地址交互（比如转账或调用另一个合约的函数）时未检查调用的结果，可能会引发意外的后果和漏洞利用。</p>
<h2 id="潜在问题"><a href="#潜在问题" class="headerlink" title="潜在问题"></a>潜在问题</h2><ol>
<li>失败的调用未被检测<br> 如果调用失败但未进行检查，合约可能会继续执行后续逻辑，从而导致不一致状态或意外行为。<br> 示例问题：转账操作失败，但余额已经从发送方扣除。</li>
<li>错误处理被忽略<br> 外部合约调用可能由于异常（例如合约不存在或代码逻辑错误）而失败。如果不检查返回值，调用方将无法正确处理这些失败。</li>
<li>逻辑漏洞导致资金损失<br> 如果未检查调用结果的返回值，攻击者可以通过故意设计失败的合约逻辑，扰乱调用方合约的资金或状态管理。</li>
<li>影响合约的可组合性<br> 在 DeFi 等应用场景中，不同合约之间通常会进行复杂交互。如果未正确检查外部调用的结果，会影响合约间的协作，甚至破坏整个生态系统的安全性。</li>
</ol>
<p><strong>漏洞示例代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract UncheckedExternalCall &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // 存款功能</span><br><span class="line">    function deposit() public payable &#123;</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 提现功能，发送资金给用户</span><br><span class="line">    function withdraw(uint256 amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">        // 发送资金，但未检查返回值</span><br><span class="line">        payable(msg.sender).call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line"></span><br><span class="line">        // 更新余额</span><br><span class="line">        balances[msg.sender] -= amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>恶意示例代码</strong><br>攻击者可以部署一个恶意合约，故意使 call 失败（例如，使用耗尽 gas 的回退函数），从而导致 balances 状态不一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Malicious &#123;</span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">    // 消耗所有 gas，故意让调用失败</span><br><span class="line">        while (true) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>显式检查 call 返回的布尔值，以确保调用成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function withdraw(uint256 amount) public &#123;</span><br><span class="line">    require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);</span><br><span class="line"></span><br><span class="line">    // 检查调用结果</span><br><span class="line">    (bool success, ) = payable(msg.sender).call&#123;value: amount&#125;(&quot;&quot;);</span><br><span class="line">    require(success, &quot;Transfer failed&quot;);</span><br><span class="line"></span><br><span class="line">    balances[msg.sender] -= amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="随机数生成不安全"><a href="#随机数生成不安全" class="headerlink" title="随机数生成不安全"></a>随机数生成不安全</h1><h2 id="为什么Solidity-中随机数生成不安全？"><a href="#为什么Solidity-中随机数生成不安全？" class="headerlink" title="为什么Solidity 中随机数生成不安全？"></a>为什么Solidity 中随机数生成不安全？</h2><p>在 Solidity 中，常见的随机数生成方式（如依赖区块哈希、时间戳等）容易被攻击者预测或操控：</p>
<ol>
<li>区块哈希依赖（blockhash）： 区块哈希是公开信息，矿工可以选择不挖某些区块，进而影响生成的随机数。</li>
<li>时间戳依赖（block.timestamp）： 矿工可以小幅调整时间戳，使得随机数变为对其有利的值。</li>
<li>合约状态依赖（msg.sender, block.difficulty 等）： 合约状态和交易上下文的信息可以被预测和操控。</li>
</ol>
<p>这些方式在确定性（公开信息和上下文）和可操控性（矿工或攻击者干预）方面不安全。</p>
<h2 id="如何安全生成随机数？"><a href="#如何安全生成随机数？" class="headerlink" title="如何安全生成随机数？"></a>如何安全生成随机数？</h2><ol>
<li>Chainlink VRF:<ul>
<li>可证明公平且可验证的随机数生成器（RNG），它使智能合约能够在不影响安全性或可用性的情况下访问随机值。</li>
<li>建立区块链游戏和NFT</li>
<li>随机分配职责和资源。例如，随机分配法官到案件。</li>
<li>为共识机制选择一个具有代表性的样本。<br> 用法：<a target="_blank" rel="noopener" href="https://docs.chain.link/vrf/v2-5/getting-started">https://docs.chain.link/vrf/v2-5/getting-started</a></li>
</ul>
</li>
<li>Off-chain Randomness (链下随机数)：<ul>
<li>使用链下生成随机数（如通过服务器或 API），然后将结果提交到链上。</li>
<li>缺点：需要信任链下服务，可能会被操控。</li>
<li>改进：通过多方签名或可信执行环境（如 Intel SGX）生成。</li>
</ul>
</li>
<li>Threshold Signature Schemes (TSS)：<ul>
<li>多方合作生成随机数，每方只持有部分秘密信息。</li>
<li>优势：随机数完全由多方参与生成，无法单点操控。</li>
<li>使用场景：像 Chainlink 的去中心化预言机网络。</li>
</ul>
</li>
<li>VDF（Verifiable Delay Function）：<ul>
<li>一种不可预测的随机数生成方式，需要一定时间来计算结果。</li>
<li>优势：矿工无法提前操控随机数。</li>
<li>实现：Ethereum 2.0 的随机数生成设计中引入了 VDF。</li>
</ul>
</li>
</ol>
<h1 id="智能合约升级问题"><a href="#智能合约升级问题" class="headerlink" title="智能合约升级问题"></a>智能合约升级问题</h1><p>智能合约在部署后通常无法直接修改，这可能导致升级和维护困难。如果设计不当，可能需要完全重启项目，从而浪费资源并导致用户信任危机。</p>
<h2 id="解决方案-1：代理合约（Proxy-Pattern）"><a href="#解决方案-1：代理合约（Proxy-Pattern）" class="headerlink" title="解决方案 1：代理合约（Proxy Pattern）"></a>解决方案 1：代理合约（Proxy Pattern）</h2><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>通过代理模式将合约分为两部分：</p>
<ol>
<li>代理合约（Proxy）： 存储状态变量，负责将用户请求委托给逻辑合约。</li>
<li>逻辑合约（Logic&#x2F;Implementation）： 包含实际的业务逻辑，可以升级和替换。</li>
</ol>
<p>用户总是与代理合约交互，代理通过 delegatecall 将调用转发到逻辑合约，使用代理合约的存储保持状态一致。</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><ol>
<li>UUPS Proxy<ul>
<li>使用 upgradeTo 方法直接升级逻辑合约。</li>
<li>更加轻量，但需要实现升级逻辑。</li>
</ul>
</li>
<li>Transparent Proxy<ul>
<li>避免管理员调用代理时出现冲突。</li>
<li>管理员可升级逻辑合约，用户调用时自动转发。</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Proxy &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    address public implementation;</span><br><span class="line">    address public admin;</span><br><span class="line"></span><br><span class="line">    constructor(address _implementation) &#123;</span><br><span class="line">        admin = msg.sender;</span><br><span class="line">        implementation = _implementation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        (bool success, ) = implementation.delegatecall(msg.data);</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgrade(address newImplementation) external &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Only admin can upgrade&quot;);</span><br><span class="line">        implementation = newImplementation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getData(uint256 _num) public pure returns (bytes memory) &#123;</span><br><span class="line">        return abi.encodeWithSignature(&quot;setNumber(uint256)&quot;, _num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v1)</span><br><span class="line">contract LogicV1 &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    address public implementation;</span><br><span class="line">    address public admin;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public &#123;</span><br><span class="line">        number = _number;</span><br><span class="line">        privateNum = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v2)</span><br><span class="line">contract LogicV2 &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    address public implementation;</span><br><span class="line">    address public admin;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public &#123;</span><br><span class="line">        number = _number * 2; // Updated logic</span><br><span class="line">        privateNum = _number * 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong></p>
<ul>
<li>无需重新部署存储状态，升级逻辑灵活。</li>
<li>用户无感知升级操作。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>增加代码复杂度。</li>
</ul>
<h2 id="解决方案2：模块化合约（Modular-Contract）"><a href="#解决方案2：模块化合约（Modular-Contract）" class="headerlink" title="解决方案2：模块化合约（Modular Contract）"></a>解决方案2：模块化合约（Modular Contract）</h2><h3 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h3><p>将合约分解为多个独立模块，所有模块通过核心合约（Registry 或 Router）进行管理。每个模块可单独替换而不影响整体功能。</p>
<h3 id="具体实现-1"><a href="#具体实现-1" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface ILOGIC &#123;</span><br><span class="line">    function setNumber(uint256 _number) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Router &#123;</span><br><span class="line">    mapping(string =&gt; address) public modules;</span><br><span class="line">    address public admin;</span><br><span class="line">    </span><br><span class="line">    constructor() &#123;</span><br><span class="line">        admin = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function updateModule(string memory moduleName, address moduleAddress) external &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Only admin can update&quot;);</span><br><span class="line">        modules[moduleName] = moduleAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function setNumber(string memory moduleName, uint256 _num) external &#123;</span><br><span class="line">        address module = modules[moduleName];</span><br><span class="line">        require(module != address(0), &quot;Module not found&quot;);</span><br><span class="line">        ILOGIC(module).setNumber(_num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v1)</span><br><span class="line">contract LogicV1 is ILOGIC &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public  &#123;</span><br><span class="line">        number = _number;</span><br><span class="line">        privateNum = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v2)</span><br><span class="line">contract LogicV2 is ILOGIC &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number) public &#123;</span><br><span class="line">        number = _number * 2; // Updated logic</span><br><span class="line">        privateNum = _number * 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong></p>
<ul>
<li>便于扩展新功能或模块。</li>
<li>每个模块的更新不会影响其他部分。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>初始设计复杂度较高。</li>
<li>需要额外存储模块地址。</li>
</ul>
<h2 id="解决方案-3：数据分离（Storage-Contract）"><a href="#解决方案-3：数据分离（Storage-Contract）" class="headerlink" title="解决方案 3：数据分离（Storage Contract）"></a>解决方案 3：数据分离（Storage Contract）</h2><h3 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h3><p>将状态数据和业务逻辑分离为两个独立合约：</p>
<ol>
<li>存储合约（Storage Contract）： 负责存储状态变量。</li>
<li>逻辑合约（Logic Contract）： 包含具体逻辑，可单独升级。</li>
</ol>
<h3 id="具体实现-2"><a href="#具体实现-2" class="headerlink" title="具体实现"></a>具体实现</h3><p><em>在上一个实现示例的基础上，进行存储合约和逻辑合约的分离。</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface ISTORE &#123;</span><br><span class="line">    function setNumber(uint256 _number) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Store is ISTORE &#123;</span><br><span class="line">    uint256 public number;</span><br><span class="line"></span><br><span class="line">    function setNumber(uint256 _number) external &#123;</span><br><span class="line">        number = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface ILOGIC &#123;</span><br><span class="line">    function setNumber(uint256 _number, ISTORE store) external ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Router &#123;</span><br><span class="line">    mapping(string =&gt; address) public modules;</span><br><span class="line">    address public admin;</span><br><span class="line">    ISTORE public store;</span><br><span class="line">    </span><br><span class="line">    constructor() &#123;</span><br><span class="line">        admin = msg.sender;</span><br><span class="line">        store = new Store();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function updateModule(string memory moduleName, address moduleAddress) external &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Only admin can update&quot;);</span><br><span class="line">        modules[moduleName] = moduleAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function setNumber(string memory moduleName, uint256 _num) external &#123;</span><br><span class="line">        address module = modules[moduleName];</span><br><span class="line">        require(module != address(0), &quot;Module not found&quot;);</span><br><span class="line">        ILOGIC(module).setNumber(_num, store);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v1)</span><br><span class="line">contract LogicV1 &#123;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number, ISTORE store) public  &#123;</span><br><span class="line">        store.setNumber(_number);</span><br><span class="line">        privateNum = _number;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Logic contract (v2)</span><br><span class="line">contract LogicV2 is ILOGIC &#123;</span><br><span class="line">    uint256 public privateNum;</span><br><span class="line">    </span><br><span class="line">    function setNumber(uint256 _number, ISTORE store) public  &#123;</span><br><span class="line">        store.setNumber(_number * 2);</span><br><span class="line">        privateNum = _number * 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>优点</strong></p>
<ul>
<li>清晰的数据和逻辑分离。</li>
<li>升级逻辑时不会影响存储。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>初次部署复杂。</li>
<li>存储和逻辑合约间的交互增加调用成本。</li>
</ul>
<h1 id="ERC20中“approve”无限授权的问题"><a href="#ERC20中“approve”无限授权的问题" class="headerlink" title="ERC20中“approve”无限授权的问题"></a>ERC20中“approve”无限授权的问题</h1><h2 id="竞争环境"><a href="#竞争环境" class="headerlink" title="竞争环境"></a>竞争环境</h2><h3 id="ERC20-的授权与竞争"><a href="#ERC20-的授权与竞争" class="headerlink" title="ERC20 的授权与竞争"></a>ERC20 的授权与竞争</h3><p><strong>假设场景</strong></p>
<p>假设有一个用户 Alice 和一个智能合约 Token，以及一个攻击者 Mallory。Alice 想通过 approve 函数授权 Mallory 代她消费代币。</p>
<p>初始状态：</p>
<p>Alice 的账户余额为 1000 个 Token。<br>Mallory 尚未获得任何授权。<br>Token 合约中的 approve 函数允许 Alice 授权 Mallory一定额度的代币。<br>Alice 执行以下两个交易：</p>
<p>approve(Mallory, 100); —— 授权 100 个代币。<br>想撤销授权后重新授权：approve(Mallory, 200); —— 授权 200 个代币。</p>
<p><strong>第一种竞争：在授权更新中被抢占</strong></p>
<p>在区块链网络中，交易可能存在提交和打包的时间差。</p>
<ol>
<li>交易流程：<ul>
<li>Alice 提交第一笔交易 approve(Mallory, 100)。</li>
<li>此时 Mallory 知道 Alice 即将授权 100，便迅速构造一个调用 transferFrom 的交易，试图转移代币。</li>
<li>在 Alice 提交第二笔交易 approve(Mallory, 200) 之前，Mallory 的交易被矿工打包处理。</li>
</ul>
</li>
<li>结果：<ul>
<li>Mallory 调用了 transferFrom，并转移了 100 个代币。</li>
<li>Alice 的第二笔交易（授权 200）覆盖了第一笔交易。</li>
<li>最终，Mallory不仅得到了 100，还能再次调用 transferFrom 转移额外的 200 个代币。</li>
</ul>
</li>
</ol>
<p><strong>第二种竞争：替代攻击</strong></p>
<p>以太坊允许用户在一笔交易未被确认前，用新的交易替换原交易（这被称为“交易替代”）。攻击者可以利用这种特性引发意外行为。</p>
<ol>
<li>交易流程：<ul>
<li>Alice 提交 approve(Mallory, 100)。</li>
<li>在这笔交易确认前，Alice 提交了一笔新的高 gas 交易 approve(Mallory, 0)。</li>
<li>Mallory发送了一笔高优先级 transferFrom 交易，与 Alice 的两笔交易竞争。</li>
</ul>
</li>
<li>结果：<ul>
<li>如果矿工按照特定顺序处理，Mallory 的 transferFrom 会先于 Alice 的 approve(Mallory, 0)。</li>
<li>最终，Mallory 成功提取了授权的 100 个代币，尽管 Alice 试图撤销授权。</li>
</ul>
</li>
</ol>
<p>尽管区块链中交易的执行是严格顺序的，但“竞争”主要源于交易在网络中传播和排序的行为。以下是两个核心原因：</p>
<ol>
<li>交易的传播和未确认状态：<ul>
<li>在用户提交交易后，交易需要传播到网络中，并等待矿工打包。</li>
<li>在交易被打包前的这段时间，其他用户或智能合约可以通过观察未确认交易，针对交易中暴露的状态进行恶意操作。</li>
</ul>
</li>
<li>矿工的交易排序权：<ul>
<li>矿工可以根据 gas 费优先级或其他策略排序交易。</li>
<li>攻击者可以支付更高的 gas，让他们的交易先执行，从而“抢占”状态更新。</li>
</ul>
</li>
</ol>
<h3 id="解决竞争"><a href="#解决竞争" class="headerlink" title="解决竞争"></a>解决竞争</h3><ol>
<li>增加原子性操作：<ul>
<li><p>将 approve 和 transferFrom 的逻辑合并为一个原子操作，避免多笔交易间的时间窗口。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function safeTransfer(address to, uint256 amount) public &#123;</span><br><span class="line">    approve(to, amount);</span><br><span class="line">    transferFrom(msg.sender, to, amount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>使用 increaseAllowance 和 decreaseAllowance：<ul>
<li>避免覆盖现有授权额度，消除修改竞态。</li>
</ul>
</li>
<li>限时授权：<ul>
<li>设置一个时间锁，授权只能在一段时间后生效。</li>
</ul>
</li>
</ol>
<h2 id="“approve”无限授权"><a href="#“approve”无限授权" class="headerlink" title="“approve”无限授权"></a>“approve”无限授权</h2><p>ERC20中“approve”无限授权的问题，其本质并不是单纯由于区块链上的竞争，而是 ERC20标准的设计缺陷与区块链环境特性结合 导致的。这种问题由两个关键因素共同作用引发：</p>
<ol>
<li><p>ERC20 标准中的设计缺陷</p>
<ul>
<li>在 ERC20 的 approve 方法中，没有提供一种明确的原子操作机制来更新授权额度。</li>
<li>在用户更改授权额度的过程中（如从 100 改为 200），攻击者可以利用时间窗口，通过 transferFrom 操作，在授权额度发生变化的过渡阶段恶意提取代币。</li>
</ul>
<p> <em>这个问题根源在于 approve 和 transferFrom 的设计缺乏配合机制，允许在两个操作之间发生不一致的状态。</em></p>
</li>
<li><p>区块链上的竞争特性</p>
<ul>
<li>交易传播时间差：当用户试图提交新授权（如 approve(Mallory, 200)），旧授权（如 approve(Mallory, 100)）仍然有效，且存在被利用的时间窗口。</li>
<li>矿工排序自由：攻击者可以观察到用户提交的 approve 交易，通过支付更高的 gas 优先让他们的交易 transferFrom 被打包，抢在用户的状态更新之前执行。</li>
</ul>
<p> <em>这两点特性导致 approve 无法原子更新的问题被放大，从而使攻击成为可能。</em></p>
</li>
</ol>
<h3 id="解决“approve”无限授权问题"><a href="#解决“approve”无限授权问题" class="headerlink" title="解决“approve”无限授权问题"></a>解决“approve”无限授权问题</h3><ol>
<li>增加 increaseAllowance 和 decreaseAllowance 方法</li>
</ol>
<p>通过调整现有额度而不是直接覆盖额度，可以避免授权被覆盖的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function increaseAllowance(address spender, uint256 addedValue) public returns (bool) &#123;</span><br><span class="line">    allowance[msg.sender][spender] += addedValue;</span><br><span class="line">    emit Approval(msg.sender, spender, allowance[msg.sender][spender]);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function decreaseAllowance(address spender, uint256 subtractedValue) public returns (bool) &#123;</span><br><span class="line">    require(allowance[msg.sender][spender] &gt;= subtractedValue, &quot;Decreased allowance below zero&quot;);</span><br><span class="line">    allowance[msg.sender][spender] -= subtractedValue;</span><br><span class="line">    emit Approval(msg.sender, spender, allowance[msg.sender][spender]);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>原子操作结合转账</li>
</ol>
<p>通过单一交易完成授权和转账，避免分离操作引入的时间窗口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function safeTransferFrom(address from, address to, uint256 amount) public &#123;</span><br><span class="line">    require(allowance[from][msg.sender] &gt;= amount, &quot;Allowance exceeded&quot;);</span><br><span class="line">    allowance[from][msg.sender] -= amount;</span><br><span class="line">    balanceOf[from] -= amount;</span><br><span class="line">    balanceOf[to] += amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ERC20 中“approve”无限授权的问题，并不完全是由于区块链竞争特性，而是由 授权更新的非原子性设计 和 区块链上交易排序特性 共同导致的。优化方法可以从改进 ERC20 的逻辑（如 increaseAllowance），有效解决这一问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/26/blockchain/ethereum/erc20-openzeppelin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/26/blockchain/ethereum/erc20-openzeppelin/" class="post-title-link" itemprop="url">OpenZeppelin ERC-20 详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-26 11:08:25" itemprop="dateCreated datePublished" datetime="2024-11-26T11:08:25+08:00">2024-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-28 11:04:23" itemprop="dateModified" datetime="2024-11-28T11:04:23+08:00">2024-11-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是一段<code>openzeppelin</code>官方生成的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// Compatible with OpenZeppelin Contracts ^5.0.0</span><br><span class="line">pragma solidity ^0.8.22;</span><br><span class="line"></span><br><span class="line">import &#123;AccessManaged&#125; from &quot;@openzeppelin/contracts/access/manager/AccessManaged.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &#123;ERC20Pausable&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Pausable.sol&quot;;</span><br><span class="line">import &#123;ERC20Permit&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit &#123;</span><br><span class="line">    constructor(address initialAuthority)</span><br><span class="line">        ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">        AccessManaged(initialAuthority)</span><br><span class="line">        ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function pause() public restricted &#123;</span><br><span class="line">        _pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unpause() public restricted &#123;</span><br><span class="line">        _unpause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) public restricted &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The following functions are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _update(address from, address to, uint256 value)</span><br><span class="line">         internal</span><br><span class="line">         override(ERC20, ERC20Pausable)</span><br><span class="line">    &#123;</span><br><span class="line">         super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个名为<code>BobToken</code>的智能合约，它继承了多个标准接口和合约，用于创建一个可暂停、可授权管理、可使用EIP-2612标准的许可（Permit）功能的代币。下面是对代码的详细解释：</p>
<h3 id="继承的合约和接口"><a href="#继承的合约和接口" class="headerlink" title="继承的合约和接口"></a>继承的合约和接口</h3><ol>
<li><strong>ERC20</strong>: ERC20是一个标准接口，定义了代币的基本功能，如总供应量、余额查询、转账等。</li>
<li><strong>ERC20Pausable</strong>: 这个接口允许代币的转账操作被暂停，从而防止在特定情况下（如紧急情况）的代币转移。</li>
<li><strong>AccessManaged</strong>: 这个接口可能定义了访问控制功能，比如只有特定地址（如管理员）才能执行某些操作。</li>
<li><strong>ERC20Permit</strong>: 这个接口允许代币持有者通过签名授权来批准第三方转移代币，而不需要直接调用转账函数。</li>
</ol>
<h4 id="继承顺序"><a href="#继承顺序" class="headerlink" title="继承顺序"></a>继承顺序</h4><p>在Solidity中，合约的继承顺序是从左到右的，即最左边的合约是基类，最右边的合约是派生类。例如，在contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit {}中，BobToken继承了ERC20、ERC20Pausable、AccessManaged和ERC20Permit。</p>
<h4 id="继承原则"><a href="#继承原则" class="headerlink" title="继承原则"></a>继承原则</h4><ol>
<li><strong>从左到右的继承顺序</strong>：如上所述，继承顺序是从左到右的，这意味着基类在派生类之前被继承。</li>
<li><strong>构造函数的调用</strong>：在派生类的构造函数中，必须显式地调用所有基类的构造函数。调用顺序必须遵循继承顺序，即从左到右。</li>
<li><strong>函数覆盖</strong>：如果基类和派生类中有同名的函数，那么派生类的函数会覆盖基类的函数。在调用这些函数时，会优先调用派生类的函数。</li>
<li><strong>库的使用</strong>：如果合约继承了一个库，那么库的函数会被覆盖。这是因为库的函数是内部函数，不能被覆盖。</li>
</ol>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">constructor(address initialAuthority)</span><br><span class="line">    ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">    AccessManaged(initialAuthority)</span><br><span class="line">    ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>initialAuthority</code>: 初始化合约的管理权限地址。</li>
<li>构造函数中调用了多个基类的构造函数，传递了必要的参数，如代币名称、符号、初始权限地址等。ERC20、AccessManaged和ERC20Permit的构造函数被显式地调用，并且按照继承顺序从左到右调用。</li>
</ul>
<h3 id="主要函数"><a href="#主要函数" class="headerlink" title="主要函数"></a>主要函数</h3><ol>
<li><strong>pause()</strong>: 暂停代币的转账操作。只有通过<code>AccessManaged</code>接口授权的地址才能调用。</li>
<li><strong>unpause()</strong>: 恢复代币的转账操作。同样，只有授权的地址才能调用。</li>
<li><strong>mint(address to, uint256 amount)</strong>: 允许授权地址铸造新的代币，并将其发送给指定的地址。这通常用于代币发行。</li>
</ol>
<h3 id="内部函数"><a href="#内部函数" class="headerlink" title="内部函数"></a>内部函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _update(address from, address to, uint256 value)</span><br><span class="line">    internal</span><br><span class="line">    override(ERC20, ERC20Pausable)</span><br><span class="line">&#123;</span><br><span class="line">    super._update(from, to, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_update</code>函数是一个内部函数，用于更新代币的余额。它重写了<code>ERC20</code>和<code>ERC20Pausable</code>中的同名函数，并在内部调用了<code>super._update</code>，确保了在更新余额时考虑了暂停状态。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>访问控制</strong>: <code>AccessManaged</code>接口确保了只有授权的地址才能执行关键操作，如暂停、铸造等。</li>
<li><strong>暂停功能</strong>: <code>ERC20Pausable</code>接口提供了暂停和恢复转账操作的功能，这在处理紧急情况时非常有用。</li>
<li><strong>EIP-2612 Permit标准</strong>: 通过实现<code>ERC20Permit</code>接口，用户可以授权第三方代币转移，而无需直接调用转账函数，这提高了安全性。</li>
</ul>
<p>总的来说，这段代码实现了一个功能丰富的代币合约，结合了多种安全性和管理功能，适用于需要严格控制访问和操作的场景。接下来，我们按照继承顺序逐个来介绍一下。</p>
<h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.0.1) (utils/Context.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">abstract contract Context &#123;</span><br><span class="line">    function _msgSender() internal view virtual returns (address) &#123;</span><br><span class="line">        return msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _msgData() internal view virtual returns (bytes calldata) &#123;</span><br><span class="line">        return msg.data;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _contextSuffixLength() internal view virtual returns (uint256) &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个名为<code>Context</code>的抽象合约。这个合约主要用于提供关于当前执行上下文的信息，包括交易的发送者和数据。在处理元交易（meta-transactions）时，发送和支付执行费用的账户可能不是实际的应用程序发送者。</p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong><code>_msgSender()</code>函数</strong>：这个函数返回当前交易的发送者地址。在大多数情况下，这可以通过<code>msg.sender</code>直接获取，但在处理元交易时，这个值可能不是实际的发送者。因此，这个函数提供了一个抽象层，允许子合约重写它以提供正确的发送者地址。</p>
</li>
<li><p><strong><code>_msgData()</code>函数</strong>：这个函数返回当前交易的输入数据。同样，在大多数情况下，这可以通过<code>msg.data</code>直接获取，但在处理元交易时，这个值可能不是实际的输入数据。因此，这个函数提供了一个抽象层，允许子合约重写它以提供正确的输入数据。</p>
</li>
<li><p><strong><code>_contextSuffixLength()</code>函数</strong>：这个函数返回一个长度值，表示上下文后缀的长度。这个函数在处理元交易时可能有用，但在这个合约中默认返回0，表示没有上下文后缀。</p>
</li>
</ol>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p><code>Context</code>合约的主要用途是为那些需要访问当前执行上下文信息的合约提供基础。例如，如果一个合约需要知道是谁发送了交易，或者交易中包含了哪些数据，它可以继承<code>Context</code>合约并使用<code>_msgSender()</code>和<code>_msgData()</code>函数。</p>
<h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>继承</strong>：任何需要使用<code>Context</code>合约功能的合约都应该继承它。如果子合约需要提供不同的发送者或数据，它应该重写<code>_msgSender()</code>和<code>_msgData()</code>函数。</li>
<li><strong>元交易</strong>：处理元交易时，发送和支付执行费用的账户可能不是实际的发送者。因此，任何依赖于<code>msg.sender</code>或<code>msg.data</code>的合约都需要能够处理这种情况。</li>
<li><strong>安全性</strong>：在重写<code>_msgSender()</code>和<code>_msgData()</code>函数时，需要确保提供的信息是安全的，以防止潜在的安全漏洞。</li>
</ul>
<h1 id="ERC20"><a href="#ERC20" class="headerlink" title="ERC20"></a>ERC20</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/ERC20.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IERC20&#125; from &quot;./IERC20.sol&quot;;</span><br><span class="line">import &#123;IERC20Metadata&#125; from &quot;./extensions/IERC20Metadata.sol&quot;;</span><br><span class="line">import &#123;Context&#125; from &quot;../../utils/Context.sol&quot;;</span><br><span class="line">import &#123;IERC20Errors&#125; from &quot;../../interfaces/draft-IERC6093.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract ERC20 is Context, IERC20, IERC20Metadata, IERC20Errors &#123;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>定义了一个名为 ERC20 的抽象合约，它继承了四个接口：Context、IERC20、IERC20Metadata 和 IERC20Errors。</p>
<ol>
<li>abstract contract ERC20</li>
</ol>
<ul>
<li>abstract contract 表示这是一个抽象合约，不能直接实例化。它通常用于定义接口和共享逻辑，其他合约可以继承它。</li>
<li>ERC20 是合约的名称。</li>
</ul>
<ol start="2">
<li>is Context, IERC20, IERC20Metadata, IERC20Errors</li>
</ol>
<ul>
<li>Context 是一个包含上下文相关函数（如 msg.sender）的接口，通常用于简化合约编写。</li>
<li>IERC20 是 ERC20 标准的接口，定义了 ERC20 代币的基本功能，如 totalSupply、balanceOf、transfer 等。</li>
<li>IERC20Metadata 是 ERC20 标准的扩展接口，定义了代币的元数据，如 name、symbol 和 decimals。</li>
<li>IERC20Errors 是一个自定义的接口，通常用于定义合约中可能出现的错误，如 TransferFailedError、InsufficientBalanceError 等。</li>
</ul>
<h3 id="合约成员"><a href="#合约成员" class="headerlink" title="合约成员"></a>合约成员</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mapping(address account =&gt; uint256) private _balances;</span><br><span class="line"></span><br><span class="line">mapping(address account =&gt; mapping(address spender =&gt; uint256)) private _allowances;</span><br><span class="line"></span><br><span class="line">uint256 private _totalSupply;</span><br><span class="line"></span><br><span class="line">string private _name;</span><br><span class="line">string private _symbol;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>_balances</strong>:</p>
<ul>
<li>这是一个映射（mapping），用于存储每个账户的代币余额。</li>
<li><code>address account</code> 是账户地址，<code>uint256</code> 是该地址对应的代币数量。</li>
<li><code>private</code> 关键字表示这个映射只能在合约内部访问，外部无法直接访问。</li>
<li>这个映射用于跟踪每个账户的代币余额。</li>
</ul>
</li>
<li><p><strong>_allowances</strong>:</p>
<ul>
<li>这是一个嵌套的映射，用于存储每个账户授权给其他账户的代币数量。</li>
<li><code>address account</code> 是账户地址，<code>mapping(address spender =&gt; uint256)</code> 是一个映射，表示该账户授权给其他账户的代币数量。</li>
<li><code>address spender</code> 是被授权的账户地址，<code>uint256</code> 是被授权的代币数量。</li>
<li><code>private</code> 关键字表示这个映射只能在合约内部访问，外部无法直接访问。</li>
<li>这个映射用于跟踪每个账户授权给其他账户的代币数量，通常用于实现代币的转账授权功能。<br>  -</li>
</ul>
</li>
<li><p><strong>_totalSupply</strong>:</p>
<ul>
<li>这是一个无符号整数（uint256），用于存储代币的总供应量。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于跟踪代币的总供应量。<br>  -</li>
</ul>
</li>
<li><p><strong>_name</strong>:</p>
<ul>
<li>这是一个字符串变量，用于存储代币的名称。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于存储代币的名称，例如 “MyToken”。</li>
</ul>
</li>
<li><p><strong>_symbol</strong>:</p>
<ul>
<li>这是一个字符串变量，用于存储代币的符号。</li>
<li><code>private</code> 关键字表示这个变量只能在合约内部访问，外部无法直接访问。</li>
<li>这个变量用于存储代币的符号，例如 “MTK”。</li>
</ul>
</li>
</ol>
<h3 id="transfer-transferFrom"><a href="#transfer-transferFrom" class="headerlink" title="transfer &amp; transferFrom"></a>transfer &amp; transferFrom</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">function transfer(address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address owner = _msgSender();</span><br><span class="line">    _transfer(owner, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address spender = _msgSender();</span><br><span class="line">    _spendAllowance(from, spender, value);</span><br><span class="line">    _transfer(from, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _transfer(address from, address to, uint256 value) internal &#123;</span><br><span class="line">    if (from == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    if (to == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidReceiver(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(from, to, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _update(address from, address to, uint256 value) internal virtual &#123;</span><br><span class="line">    if (from == address(0)) &#123;</span><br><span class="line">        // Overflow check required: The rest of the code assumes that totalSupply never overflows</span><br><span class="line">        _totalSupply += value;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        uint256 fromBalance = _balances[from];</span><br><span class="line">        if (fromBalance &lt; value) &#123;</span><br><span class="line">            revert ERC20InsufficientBalance(from, fromBalance, value);</span><br><span class="line">        &#125;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: value &lt;= fromBalance &lt;= totalSupply.</span><br><span class="line">            _balances[from] = fromBalance - value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (to == address(0)) &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: value &lt;= totalSupply or value &lt;= fromBalance &lt;= totalSupply.</span><br><span class="line">            _totalSupply -= value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            // Overflow not possible: balance + value is at most totalSupply, which we know fits into a uint256.</span><br><span class="line">            _balances[to] += value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    emit Transfer(from, to, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>所有的转让动作最终都由<code>_transfer</code>方法来完成。</li>
<li><code>_transfer</code>方法中统一判断地址的有效性，使用<code>revert</code>比<code>require</code>更节省gas。</li>
<li><code>ERC20InvalidSender</code>和<code>ERC20InvalidReceiver</code>都来自<code>IERC20Errors</code>接口。</li>
</ul>
<p><strong>_update</strong></p>
<p><code>_update</code> 为内部虚函数，用于更新代币合约中的余额和总供应量。它主要用于处理代币的转移操作，确保在转移过程中不会发生溢出或不足的情况。</p>
<ol>
<li><p><strong>参数说明</strong>：</p>
<ul>
<li><code>from</code>：代币的发送者地址。</li>
<li><code>to</code>：代币的接收者地址。</li>
<li><code>value</code>：转移的代币数量。</li>
</ul>
</li>
<li><p><strong>更新总供应量</strong>：</p>
<ul>
<li>如果 <code>from</code> 是 <code>address(0)</code>，表示这是一个铸造操作（minting），那么 <code>_totalSupply</code> 将增加 <code>value</code>。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _mint(address account, uint256 value) internal &#123;</span><br><span class="line">    if (account == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidReceiver(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(address(0), account, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果 <code>from</code> 不是 <code>address(0)</code>，表示这是一个转移操作（transfer），那么首先检查 <code>from</code> 的余额是否足够，如果足够，则从 <code>from</code> 的余额中减去 <code>value</code>。</li>
</ul>
</li>
<li><p><strong>更新接收者的余额</strong>：</p>
<ul>
<li>如果 <code>to</code> 是 <code>address(0)</code>，表示这是一个销毁操作（burning），那么 <code>_totalSupply</code> 将减少 <code>value</code>。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function _burn(address account, uint256 value) internal &#123;</span><br><span class="line">    if (account == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _update(account, address(0), value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果 <code>to</code> 不是 <code>address(0)</code>，表示这是一个转移操作，那么将 <code>value</code> 加到 <code>to</code> 的余额中。</li>
</ul>
</li>
<li><p><strong>防止溢出</strong>：</p>
<ul>
<li>使用 <code>unchecked</code> 关键字来处理可能的溢出情况，因为代码逻辑已经确保了不会发生溢出。</li>
<li>使用 <code>unchecked</code> 可以节省gas</li>
</ul>
</li>
<li><p><strong>触发事件</strong>：</p>
<ul>
<li>最后，通过 <code>emit Transfer(from, to, value);</code> 触发一个 <code>Transfer</code> 事件，记录这次转移操作。</li>
</ul>
</li>
</ol>
<h3 id="approve"><a href="#approve" class="headerlink" title="approve"></a>approve</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">function transferFrom(address from, address to, uint256 value) public virtual returns (bool) &#123;</span><br><span class="line">    address spender = _msgSender();</span><br><span class="line">    _spendAllowance(from, spender, value);</span><br><span class="line">    _transfer(from, to, value);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _approve(address owner, address spender, uint256 value) internal &#123;</span><br><span class="line">    _approve(owner, spender, value, true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _approve(address owner, address spender, uint256 value, bool emitEvent) internal virtual &#123;</span><br><span class="line">    if (owner == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidApprover(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    if (spender == address(0)) &#123;</span><br><span class="line">        revert ERC20InvalidSpender(address(0));</span><br><span class="line">    &#125;</span><br><span class="line">    _allowances[owner][spender] = value;</span><br><span class="line">    if (emitEvent) &#123;</span><br><span class="line">        emit Approval(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _spendAllowance(address owner, address spender, uint256 value) internal virtual &#123;</span><br><span class="line">    uint256 currentAllowance = allowance(owner, spender);</span><br><span class="line">    if (currentAllowance != type(uint256).max) &#123;</span><br><span class="line">        if (currentAllowance &lt; value) &#123;</span><br><span class="line">            revert ERC20InsufficientAllowance(spender, currentAllowance, value);</span><br><span class="line">        &#125;</span><br><span class="line">        unchecked &#123;</span><br><span class="line">            _approve(owner, spender, currentAllowance - value, false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>_approve</code>函数</strong></p>
<p><code>_approve</code>函数用于更新一个账户对另一个账户的授权额度。如果<code>emitEvent</code>参数为<code>true</code>，还会触发一个<code>Approval</code>事件。</p>
<pre><code>- `owner`：授权额度所有者的地址。
- `spender`：被授权的账户地址。
- `value`：授权的额度。
- `emitEvent`：一个布尔值，决定是否触发`Approval`事件。
</code></pre>
<p><strong>流程</strong></p>
<ol>
<li>首先检查<code>owner</code>和<code>spender</code>是否为<code>address(0)</code>，如果是，则抛出异常<code>ERC20InvalidApprover</code>或<code>ERC20InvalidSpender</code>。</li>
<li>更新<code>_allowances</code>映射，将<code>owner</code>对<code>spender</code>的授权额度设置为<code>value</code>。</li>
<li>如果<code>emitEvent</code>为<code>true</code>，则触发<code>Approval</code>事件。</li>
</ol>
<p><strong><code>_spendAllowance</code>函数</strong></p>
<p><code>_spendAllowance</code>函数用于消耗<code>owner</code>对<code>spender</code>的授权额度。它不会更新授权额度，除非授权额度是有限的。如果授权额度不足，则会抛出异常。</p>
<pre><code>- `owner`：授权额度所有者的地址。
- `spender`：被授权的账户地址。
- `value`：要消费的额度。
</code></pre>
<p><strong>流程</strong></p>
<ol>
<li>获取<code>owner</code>对<code>spender</code>的当前授权额度。</li>
<li>如果当前授权额度不是无限（即不等于<code>type(uint256).max</code>），则检查当前授权额度是否足够消费<code>value</code>。</li>
<li>如果足够，则更新<code>owner</code>对<code>spender</code>的授权额度，减去<code>value</code>，并触发<code>Approval</code>事件（如果<code>emitEvent</code>为<code>true</code>）。</li>
</ol>
<h3 id="decimals"><a href="#decimals" class="headerlink" title="decimals"></a>decimals</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function decimals() public view virtual returns (uint8) &#123;</span><br><span class="line">    return 18;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认值是18， 如果想改变，只能重写<code>decimals()</code>这个方法。这种方法直接返回固定值的相比于使用成员变量存储的方式更省gas。</p>
<h1 id="ERC20Pausable"><a href="#ERC20Pausable" class="headerlink" title="ERC20Pausable"></a>ERC20Pausable</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/extensions/ERC20Pausable.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;ERC20&#125; from &quot;../ERC20.sol&quot;;</span><br><span class="line">import &#123;Pausable&#125; from &quot;../../../utils/Pausable.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract ERC20Pausable is ERC20, Pausable &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @dev See &#123;ERC20-_update&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Requirements:</span><br><span class="line">     *</span><br><span class="line">     * - the contract must not be paused.</span><br><span class="line">    */</span><br><span class="line">    function _update(address from, address to, uint256 value) internal virtual override whenNotPaused &#123;</span><br><span class="line">        super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC20Pausable</code> 是个抽象合约，它继承了 <code>ERC20</code> 和 <code>Pausable</code> 两个合约。<code>ERC20</code> 是一个标准的代币合约接口，而 <code>Pausable</code> 是一个用于暂停合约操作的合约。</p>
<h3 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong>继承关系</strong>：<code>ERC20Pausable</code> 继承了 <code>ERC20</code> 和 <code>Pausable</code> 合约，这意味着它继承了 <code>ERC20</code> 的所有功能（如代币的创建、转移、余额查询等）以及 <code>Pausable</code> 的功能（如暂停和恢复合约操作）。</p>
</li>
<li><p><strong>抽象合约</strong>：<code>ERC20Pausable</code> 是一个抽象合约，因为它包含了一个未实现的函数 <code>_update</code>。</p>
</li>
<li><p><strong>函数重写</strong>：<code>_update</code> 函数重写了 <code>ERC20</code> 合约中的 <code>_update</code> 函数。这个函数在执行代币转移操作之前，会检查合约是否处于暂停状态。如果合约处于暂停状态，则不允许执行转移操作。</p>
</li>
<li><p><strong><code>whenNotPaused</code> 修饰器</strong>：<code>whenNotPaused</code> 是 <code>Pausable</code> 合约中的一个修饰器，用于确保在调用被修饰的函数时，合约不是暂停状态。如果合约是暂停状态，调用将被 revert（回滚）。</p>
</li>
</ol>
<h3 id="用途-1"><a href="#用途-1" class="headerlink" title="用途"></a>用途</h3><p><code>ERC20Pausable</code> 合约的主要用途是提供一个可暂停的代币合约，允许合约所有者或管理员在紧急情况下暂停代币的转移操作，以防止潜在的滥用或攻击。</p>
<h3 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><p><strong>实现 <code>_update</code> 函数</strong>：任何继承 <code>ERC20Pausable</code> 的合约都必须实现 <code>_update</code> 函数，以确保在执行代币转移操作时能够正确地检查合约是否处于暂停状态。</p>
</li>
<li><p><strong>合约暂停</strong>：合约暂停后，所有与代币转移相关的操作都将被阻止，直到合约被恢复。因此，合约所有者或管理员在暂停合约时应谨慎操作，以避免造成不必要的损失。</p>
</li>
<li><p><strong>安全性</strong>：虽然 <code>ERC20Pausable</code> 合约提供了一种暂停合约的方法，但它并不能防止所有潜在的安全问题。开发者仍需确保合约的其他部分（如访问控制、逻辑错误等）是安全的。</p>
</li>
</ol>
<h1 id="AccessManaged"><a href="#AccessManaged" class="headerlink" title="AccessManaged"></a>AccessManaged</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (access/manager/AccessManaged.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IAuthority&#125; from &quot;./IAuthority.sol&quot;;</span><br><span class="line">import &#123;AuthorityUtils&#125; from &quot;./AuthorityUtils.sol&quot;;</span><br><span class="line">import &#123;IAccessManager&#125; from &quot;./IAccessManager.sol&quot;;</span><br><span class="line">import &#123;IAccessManaged&#125; from &quot;./IAccessManaged.sol&quot;;</span><br><span class="line">import &#123;Context&#125; from &quot;../../utils/Context.sol&quot;;</span><br><span class="line"></span><br><span class="line">abstract contract AccessManaged is Context, IAccessManaged &#123;</span><br><span class="line">    address private _authority;</span><br><span class="line"></span><br><span class="line">    bool private _consumingSchedule;</span><br><span class="line">    constructor(address initialAuthority) &#123;</span><br><span class="line">        _setAuthority(initialAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier restricted() &#123;</span><br><span class="line">        _checkCanCall(_msgSender(), _msgData());</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function authority() public view virtual returns (address) &#123;</span><br><span class="line">        return _authority;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function setAuthority(address newAuthority) public virtual &#123;</span><br><span class="line">        address caller = _msgSender();</span><br><span class="line">        if (caller != authority()) &#123;</span><br><span class="line">            revert AccessManagedUnauthorized(caller);</span><br><span class="line">        &#125;</span><br><span class="line">        if (newAuthority.code.length == 0) &#123;</span><br><span class="line">            revert AccessManagedInvalidAuthority(newAuthority);</span><br><span class="line">        &#125;</span><br><span class="line">        _setAuthority(newAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /// @inheritdoc IAccessManaged</span><br><span class="line">    function isConsumingScheduledOp() public view returns (bytes4) &#123;</span><br><span class="line">        return _consumingSchedule ? this.isConsumingScheduledOp.selector : bytes4(0);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _setAuthority(address newAuthority) internal virtual &#123;</span><br><span class="line">        _authority = newAuthority;</span><br><span class="line">        emit AuthorityUpdated(newAuthority);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function _checkCanCall(address caller, bytes calldata data) internal virtual &#123;</span><br><span class="line">        (bool immediate, uint32 delay) = AuthorityUtils.canCallWithDelay(</span><br><span class="line">            authority(),</span><br><span class="line">            caller,</span><br><span class="line">            address(this),</span><br><span class="line">            bytes4(data[0:4])</span><br><span class="line">        );</span><br><span class="line">        if (!immediate) &#123;</span><br><span class="line">            if (delay &gt; 0) &#123;</span><br><span class="line">                _consumingSchedule = true;</span><br><span class="line">                IAccessManager(authority()).consumeScheduledOp(caller, data);</span><br><span class="line">                _consumingSchedule = false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                revert AccessManagedUnauthorized(caller);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AccessManaged</code> 是个抽象合约，它继承了 <code>Context</code> 和 <code>IAccessManaged</code> 接口。这个合约的主要目的是管理合约的访问权限，确保只有授权的地址才能调用特定的函数。下面是对代码的详细解释：</p>
<h3 id="合约结构"><a href="#合约结构" class="headerlink" title="合约结构"></a>合约结构</h3><ol>
<li><p><strong>状态变量</strong>：</p>
<ul>
<li><code>_authority</code>：存储当前合约的授权地址。</li>
<li><code>_consumingSchedule</code>：一个布尔值，用于指示是否正在执行预定的操作。</li>
</ul>
</li>
<li><p><strong>构造函数</strong>：</p>
<ul>
<li><code>constructor(address initialAuthority)</code>：初始化合约，设置初始的授权地址。</li>
</ul>
</li>
<li><p><strong>修饰器</strong>：</p>
<ul>
<li><code>modifier restricted()</code>：限制函数的访问，确保只有授权的地址才能调用。这个修饰器通过调用 <code>_checkCanCall</code> 函数来检查调用者是否有权限。</li>
</ul>
</li>
<li><p><strong>接口实现</strong>：</p>
<ul>
<li><code>function authority() public view virtual returns (address)</code>：返回当前的授权地址。</li>
<li><code>function setAuthority(address newAuthority) public virtual</code>：设置新的授权地址。只有当前的授权地址才能调用这个函数。</li>
<li><code>function isConsumingScheduledOp() public view returns (bytes4)</code>：检查合约是否正在执行预定的操作。</li>
</ul>
</li>
<li><p><strong>内部函数</strong>：</p>
<ul>
<li><code>function _setAuthority(address newAuthority) internal virtual</code>：设置新的授权地址。这个函数没有访问限制，允许直接设置新的授权地址。</li>
<li><code>function _checkCanCall(address caller, bytes calldata data) internal virtual</code>：检查调用者是否有权限调用当前函数。如果调用者没有权限，则抛出异常。</li>
</ul>
</li>
</ol>
<h3 id="实现原理-2"><a href="#实现原理-2" class="headerlink" title="实现原理"></a>实现原理</h3><ul>
<li><strong>权限管理</strong>：通过 <code>_authority</code> 状态变量和 <code>restricted</code> 修饰器实现。只有 <code>_authority</code> 指定的地址才能调用被 <code>restricted</code> 修饰的函数。</li>
<li><strong>授权地址的设置</strong>：通过 <code>setAuthority</code> 函数设置新的授权地址，只有当前的授权地址才能调用这个函数。</li>
<li><strong>预定操作</strong>：通过 <code>_consumingSchedule</code> 和 <code>isConsumingScheduledOp</code> 函数管理预定的操作。如果合约正在执行预定的操作，<code>isConsumingScheduledOp</code> 函数会返回一个特定的函数选择器。</li>
</ul>
<h3 id="用途-2"><a href="#用途-2" class="headerlink" title="用途"></a>用途</h3><p>这个合约的主要用途是提供一个框架，用于管理合约的访问权限。通过设置授权地址，可以确保只有授权的地址才能调用合约的特定函数。这对于需要严格控制访问权限的合约非常有用，例如智能合约钱包或权限管理合约。</p>
<h3 id="注意事项-3"><a href="#注意事项-3" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li><strong>安全性</strong>：在实现权限管理时，需要特别注意不要在 <code>receive()</code> 或 <code>fallback()</code> 函数上使用 <code>restricted</code> 修饰器，因为这些函数的调用方式可能导致权限检查失败。</li>
<li><strong>权限转移</strong>：通过 <code>setAuthority</code> 函数可以转移合约的权限，但只有当前的授权地址才能执行这个操作，这确保了权限的转移是可控的。</li>
<li><strong>预定操作</strong>：通过 <code>isConsumingScheduledOp</code> 函数可以检查合约是否正在执行预定的操作，这对于需要同步执行多个操作的合约非常有用。</li>
</ul>
<h1 id="ERC20Permit"><a href="#ERC20Permit" class="headerlink" title="ERC20Permit"></a>ERC20Permit</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts (last updated v5.1.0) (token/ERC20/extensions/ERC20Permit.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">import &#123;IERC20Permit&#125; from &quot;./IERC20Permit.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;../ERC20.sol&quot;;</span><br><span class="line">import &#123;ECDSA&#125; from &quot;../../../utils/cryptography/ECDSA.sol&quot;;</span><br><span class="line">import &#123;EIP712&#125; from &quot;../../../utils/cryptography/EIP712.sol&quot;;</span><br><span class="line">import &#123;Nonces&#125; from &quot;../../../utils/Nonces.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> @dev Implementation of the ERC-20 Permit extension allowing approvals to be made via signatures, as defined in</span><br><span class="line"> * https://eips.ethereum.org/EIPS/eip-2612[ERC-2612].</span><br><span class="line"> *</span><br><span class="line"> * Adds the &#123;permit&#125; method, which can be used to change an account&#x27;s ERC-20 allowance (see &#123;IERC20-allowance&#125;) by</span><br><span class="line"> * presenting a message signed by the account. By not relying on `&#123;IERC20-approve&#125;`, the token holder account doesn&#x27;t</span><br><span class="line"> * need to send a transaction, and thus is not required to hold Ether at all.</span><br><span class="line"> */</span><br><span class="line">abstract contract ERC20Permit is ERC20, IERC20Permit, EIP712, Nonces &#123;</span><br><span class="line">    bytes32 private constant PERMIT_TYPEHASH =</span><br><span class="line">    keccak256(&quot;Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Permit deadline has expired.</span><br><span class="line">     */</span><br><span class="line">    error ERC2612ExpiredSignature(uint256 deadline);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Mismatched signature.</span><br><span class="line">     */</span><br><span class="line">    error ERC2612InvalidSigner(address signer, address owner);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @dev Initializes the &#123;EIP712&#125; domain separator using the `name` parameter, and setting `version` to `&quot;1&quot;`.</span><br><span class="line">     *</span><br><span class="line">     * It&#x27;s a good idea to use the same `name` that is defined as the ERC-20 token name.</span><br><span class="line">     */</span><br><span class="line">    constructor(string memory name) EIP712(name, &quot;1&quot;) &#123;&#125;</span><br><span class="line">       </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    function permit(</span><br><span class="line">        address owner,</span><br><span class="line">        address spender,</span><br><span class="line">        uint256 value,</span><br><span class="line">        uint256 deadline,</span><br><span class="line">        uint8 v,</span><br><span class="line">        bytes32 r,</span><br><span class="line">        bytes32 s</span><br><span class="line">    ) public virtual &#123;</span><br><span class="line">        if (block.timestamp &gt; deadline) &#123;</span><br><span class="line">            revert ERC2612ExpiredSignature(deadline);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         bytes32 structHash = keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, _useNonce(owner), deadline));</span><br><span class="line"> </span><br><span class="line">         bytes32 hash = _hashTypedDataV4(structHash);</span><br><span class="line"> </span><br><span class="line">         address signer = ECDSA.recover(hash, v, r, s);</span><br><span class="line">         if (signer != owner) &#123;</span><br><span class="line">             revert ERC2612InvalidSigner(signer, owner);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         _approve(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    function nonces(address owner) public view virtual override(IERC20Permit, Nonces) returns (uint256) &#123;</span><br><span class="line">        return super.nonces(owner);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * @inheritdoc IERC20Permit</span><br><span class="line">     */</span><br><span class="line">    // solhint-disable-next-line func-name-mixedcase</span><br><span class="line">    function DOMAIN_SEPARATOR() external view virtual returns (bytes32) &#123;</span><br><span class="line">        return _domainSeparatorV4();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ERC20Permit</code> 是一个抽象合约，它结合了 ERC-20 标准和 ERC-2612 标准的功能。ERC-2612 标准允许使用签名来批准代币转移，而无需直接调用 <code>approve</code> 函数。下面是对代码的详细解释：</p>
<h3 id="实现原理-3"><a href="#实现原理-3" class="headerlink" title="实现原理"></a>实现原理</h3><ol>
<li><p><strong>继承关系</strong>：</p>
<ul>
<li><code>ERC20Permit</code> 继承了 <code>ERC20</code>、<code>IERC20Permit</code>、<code>EIP712</code> 和 <code>Nonces</code> 四个合约。</li>
<li><code>ERC20</code> 实现了 ERC-20 标准的代币功能。</li>
<li><code>IERC20Permit</code> 定义了 ERC-2612 标准的接口。</li>
<li><code>EIP712</code> 用于生成和验证 EIP-712 签名。</li>
<li><code>Nonces</code> 用于管理每个账户的签名计数器。</li>
</ul>
</li>
<li><p><strong>常量</strong>：</p>
<ul>
<li><code>PERMIT_TYPEHASH</code> 是一个哈希值，用于在 EIP-712 签名中标识 <code>Permit</code> 结构。</li>
</ul>
</li>
<li><p><strong>错误</strong>：</p>
<ul>
<li><code>ERC2612ExpiredSignature</code>：当签名过期时抛出。</li>
<li><code>ERC2612InvalidSigner</code>：当签名者与账户不匹配时抛出。</li>
</ul>
</li>
<li><p><strong>构造函数</strong>：</p>
<ul>
<li>初始化 <code>EIP712</code> 的域分隔符，使用传入的 <code>name</code> 参数，并设置版本号为 <code>&quot;1&quot;</code>。</li>
</ul>
</li>
<li><p><strong>permit 函数</strong>：</p>
<ul>
<li>验证签名是否过期。</li>
<li>生成 <code>Permit</code> 结构的哈希值。</li>
<li>使用 EIP-712 签名验证机制恢复签名者地址。</li>
<li>检查签名者是否与 <code>owner</code> 匹配。</li>
<li>调用 <code>_approve</code> 函数批准代币转移。</li>
</ul>
</li>
<li><p><strong>nonces 函数</strong>：</p>
<ul>
<li>返回指定账户的签名计数器值。</li>
</ul>
</li>
<li><p><strong>DOMAIN_SEPARATOR 函数</strong>：</p>
<ul>
<li>返回 EIP-712 的域分隔符。</li>
</ul>
</li>
</ol>
<h3 id="用途-3"><a href="#用途-3" class="headerlink" title="用途"></a>用途</h3><p><code>ERC20Permit</code> 合约允许用户通过签名来批准代币转移，而无需直接调用 <code>approve</code> 函数。这对于提高安全性（避免重放攻击）和用户体验（无需每次都手动批准）非常有用。</p>
<h3 id="注意事项-4"><a href="#注意事项-4" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li><strong>安全性</strong>：确保正确实现 EIP-712 签名验证，以防止签名被滥用。</li>
<li><strong>时间戳</strong>：使用 <code>block.timestamp</code> 来检查签名是否过期，确保安全性。</li>
<li><strong>nonce</strong>：使用 <code>nonce</code> 来防止重放攻击，确保每个签名只被使用一次。</li>
<li><strong>兼容性</strong>：确保合约与所有相关接口和标准兼容，以避免潜在的问题。</li>
</ol>
<h3 id="ERC-2612标准"><a href="#ERC-2612标准" class="headerlink" title="ERC-2612标准"></a>ERC-2612标准</h3><p>ERC-2612 标准提供了一种安全、高效的方式来授权代币转移，是 ERC-20 标准的一个扩展。它允许代币持有者通过签名授权第三方转移代币，而不需要直接调用 <code>approve</code> 函数。这个标准基于 EIP-712，它提供了一种使用签名来验证和执行操作的方法。</p>
<h4 id="ERC-2612-标准的主要功能"><a href="#ERC-2612-标准的主要功能" class="headerlink" title="ERC-2612 标准的主要功能"></a>ERC-2612 标准的主要功能</h4><ol>
<li><p><strong>Permit 函数</strong>：允许代币持有者通过签名授权第三方转移代币。这个函数需要三个参数：<code>owner</code>（代币持有者的地址）、<code>spender</code>（被授权的地址）和 <code>value</code>（被授权的代币数量）。</p>
</li>
<li><p><strong>EIP-712 签名</strong>：使用 EIP-712 签名来验证 <code>Permit</code> 函数的调用。EIP-712 是一种用于生成和验证签名的标准，它允许在签名中包含额外的元数据，如链 ID 和域分隔符。</p>
</li>
<li><p><strong>Nonce</strong>：每个账户都有一个关联的 <code>nonce</code> 值，用于防止重放攻击。在 <code>Permit</code> 函数中，<code>nonce</code> 值会自动增加，确保每个签名只被使用一次。</p>
</li>
</ol>
<h4 id="ERC-2612-标准的实现"><a href="#ERC-2612-标准的实现" class="headerlink" title="ERC-2612 标准的实现"></a>ERC-2612 标准的实现</h4><p>要实现 ERC-2612 标准，代币合约需要包含以下部分：</p>
<ol>
<li><p><strong>Permit 函数</strong>：实现 <code>Permit</code> 函数，用于处理签名授权。</p>
</li>
<li><p><strong>EIP-712 签名</strong>：实现 EIP-712 签名生成和验证机制。</p>
</li>
<li><p><strong>Nonce</strong>：管理每个账户的 <code>nonce</code> 值。</p>
</li>
<li><p><strong>DOMAIN_SEPARATOR</strong>：生成 EIP-712 签名的域分隔符。</p>
</li>
</ol>
<h4 id="ERC-2612-标准的用途"><a href="#ERC-2612-标准的用途" class="headerlink" title="ERC-2612 标准的用途"></a>ERC-2612 标准的用途</h4><p>ERC-2612 标准的主要用途是提高代币的安全性。通过使用签名来授权代币转移，可以防止重放攻击，并简化用户界面。此外，它还可以提高交易效率，因为用户不需要每次都手动批准代币转移。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/25/blockchain/ethereum/erc-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/25/blockchain/ethereum/erc-20/" class="post-title-link" itemprop="url">ERC-20</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-25 10:32:32 / Modified: 10:55:47" itemprop="dateCreated datePublished" datetime="2024-11-25T10:32:32+08:00">2024-11-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是-ERC-20？"><a href="#什么是-ERC-20？" class="headerlink" title="什么是 ERC-20？"></a>什么是 ERC-20？</h1><p>ERC-20 提出了一个同质化代币的标准，换句话说，它们具有一种属性，使得每个代币都与另一个代币（在类型和价值上）完全相同。 例如，一个 ERC-20 代币就像以太币一样，意味着一个代币会并永远会与其他代币一样。(From: 《<a target="_blank" rel="noopener" href="https://ethereum.org/zh/developers/docs/standards/tokens/erc-20/">ERC-20 代币标准</a>》)</p>
<h2 id="方法（Method）"><a href="#方法（Method）" class="headerlink" title="方法（Method）"></a>方法（Method）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function name() public view returns (string)</span><br><span class="line">// 返回令牌的名称 - 例如 &quot;MyToken&quot;</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function symbol() public view returns (string)</span><br><span class="line">// 返回令牌的 symbol。例如“HIX”。</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function decimals() public view returns (uint8)</span><br><span class="line">// 返回代币使用的小数位数 - 例如 8，表示将代币数量除以 100000000 以获得其用户表示。</span><br><span class="line">// 可选 - 此方法可用于提高可用性，但接口和其他协定不得期望存在这些值。</span><br><span class="line"></span><br><span class="line">function totalSupply() public view returns (uint256)</span><br><span class="line">// 返回总代币供应量。</span><br><span class="line"></span><br><span class="line">function balanceOf(address _owner) public view returns (uint256 balance)</span><br><span class="line">// 返回地址为 _owner 的另一个账户的账户余额。</span><br><span class="line"></span><br><span class="line">function transfer(address _to, uint256 _value) public returns (bool success)</span><br><span class="line">// 将 _value 数量的代币转移到 _to，并且必须触发 Transfer 事件。如果消息调用者的账户余额没有足够的代币可供花费，则函数应该throw。</span><br><span class="line">// 注意值为 0 的传输必须被视为正常传输，并触发 Transfer 事件。</span><br><span class="line"></span><br><span class="line">function transferFrom(address _from, address _to, uint256 _value) public returns (bool success)</span><br><span class="line">// 将 _value数量的代币从地址 _from 转移到地址 _to，并且必须触发 Transfer 事件。</span><br><span class="line">// transferFrom 方法用于提现工作流程，允许合约代表您转移代币。例如，这可用于允许合约代表您转移代币和/或以子货币收取费用。除非 _from 账户通过某种机制故意授权了消息的发送者，否则该函数应该throw。</span><br><span class="line"></span><br><span class="line">function approve(address _spender, uint256 _value) public returns (bool success)</span><br><span class="line">// 允许_spender多次从您的账户提款，最高可达_value金额。如果再次调用此函数，它将用 _value 覆盖当前限额。</span><br><span class="line">// 注意：客户端应该确保在创建用户界面时，先将限额设置为 0，然后再为同一花费者将其设置为另一个值。尽管 Contract 本身不应该强制执行它，以允许向后兼容之前部署的 Contract</span><br><span class="line"></span><br><span class="line">function allowance(address _owner, address _spender) public view returns (uint256 remaining)</span><br><span class="line">// 返回 _spender 仍允许从 _owner 中提取的金额。</span><br></pre></td></tr></table></figure>

<h2 id="事件（Event）"><a href="#事件（Event）" class="headerlink" title="事件（Event）"></a>事件（Event）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">event Transfer(address indexed _from, address indexed _to, uint256 _value)</span><br><span class="line">// 必须在代币转移时触发，包括零价值转移。</span><br><span class="line">// 创建新代币的代币合约应该在创建代币时触发 Transfer 事件，并将 _from 地址设置为 0x0。</span><br><span class="line"></span><br><span class="line">event Approval(address indexed _owner, address indexed _spender, uint256 _value)</span><br><span class="line">// 必须在成功调用 approve(address _spender, uint256 _value) 时触发。</span><br></pre></td></tr></table></figure>

<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MyToken &#123;</span><br><span class="line">    string public constant name = &quot;Bob&#x27;s Token&quot;;</span><br><span class="line">    string public constant symbol = &quot;BBK&quot;;</span><br><span class="line">    uint8 public constant decimals = 18;</span><br><span class="line">    uint16 private constant increase = 1000;</span><br><span class="line">    uint256 public constant totalLimit = 27000000 * (10 ** decimals);</span><br><span class="line">    uint256 public totalSupply = 0;</span><br><span class="line">    address private owner;</span><br><span class="line">    mapping(address =&gt; uint256) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed _from, address indexed _to, uint256 _value);</span><br><span class="line">    event Approval(address indexed _owner, address indexed _spender, uint256 _value);</span><br><span class="line"></span><br><span class="line">    modifier checkAddress(address _addr) &#123;</span><br><span class="line">        require(address(_addr) != address(0), &quot;Invalid address.&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier checkBalanceOf(address _addr, uint256 _value) &#123;</span><br><span class="line">        require(balanceOf[_addr] &gt;= _value, &quot;Insufficient balance&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier checkOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Not owner.&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address _to) public checkOwner returns (uint256) &#123;</span><br><span class="line">        uint256 mintValue = increase * (10  ** decimals);</span><br><span class="line">        require(totalLimit &gt;= (totalSupply + mintValue), &quot;Out of limit.&quot;);</span><br><span class="line">        totalSupply += mintValue;</span><br><span class="line">        balanceOf[_to] += mintValue;</span><br><span class="line">        return balanceOf[_to];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public checkAddress(_to) checkBalanceOf(msg.sender, _value) returns (bool success)&#123;</span><br><span class="line">        balanceOf[msg.sender] -= _value;</span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line">        emit Transfer(msg.sender, _to, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address _from, address _to, uint256 _value) public checkAddress(_to) checkBalanceOf(_from, _value) returns (bool success) &#123;</span><br><span class="line">        require(allowance[_from][msg.sender] &gt;= _value, &quot;No enough approve value.&quot;);</span><br><span class="line">        allowance[_from][msg.sender] -= _value;</span><br><span class="line">        balanceOf[_from] -= _value;</span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line">        emit Transfer(_from, _to, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address _spender, uint256 _value) public returns (bool success)&#123;</span><br><span class="line">        allowance[msg.sender][_spender] = _value;</span><br><span class="line">        emit Approval(msg.sender, _spender, _value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意事项</strong></p>
<ul>
<li>由于本合约的编译版本为0.8.0，此版本具备整数溢出检查，所以可以不使用safeMath。</li>
</ul>
<h2 id="快速示例"><a href="#快速示例" class="headerlink" title="快速示例"></a>快速示例</h2><p>使用<a target="_blank" rel="noopener" href="https://docs.openzeppelin.com/contracts/5.x/wizard">OpenZeppelin</a>快速创建ERC-20合约</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// Compatible with OpenZeppelin Contracts ^5.0.0</span><br><span class="line">pragma solidity ^0.8.22;</span><br><span class="line"></span><br><span class="line">import &#123;AccessManaged&#125; from &quot;@openzeppelin/contracts/access/manager/AccessManaged.sol&quot;;</span><br><span class="line">import &#123;ERC20&#125; from &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &#123;ERC20Pausable&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Pausable.sol&quot;;</span><br><span class="line">import &#123;ERC20Permit&#125; from &quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract BobToken is ERC20, ERC20Pausable, AccessManaged, ERC20Permit &#123;</span><br><span class="line">    constructor(address initialAuthority)</span><br><span class="line">         ERC20(&quot;BobToken&quot;, &quot;BBK&quot;)</span><br><span class="line">         AccessManaged(initialAuthority)</span><br><span class="line">         ERC20Permit(&quot;BobToken&quot;)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function pause() public restricted &#123;</span><br><span class="line">         _pause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unpause() public restricted &#123;</span><br><span class="line">         _unpause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(address to, uint256 amount) public restricted &#123;</span><br><span class="line">        _mint(to, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The following functions are overrides required by Solidity.</span><br><span class="line"></span><br><span class="line">    function _update(address from, address to, uint256 value)</span><br><span class="line">        internal</span><br><span class="line">        override(ERC20, ERC20Pausable)</span><br><span class="line">    &#123;</span><br><span class="line">        super._update(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的合约通常通过<a target="_blank" rel="noopener" href="https://solidity.readthedocs.io/en/latest/contracts.html#inheritance">继承</a>来使用，在这里我们将 <code>ERC20</code> 重新用于基本标准实现以及 <code>name</code>、<code>symbol</code> 和 <code>decimals</code> 可选扩展。此外，我们正在创建一个代币的 <code>initialSupply</code>，该代币将被分配给部署合约的地址。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2024/11/21/blockchain/ethereum/usage-of-call-staticcall-delegatecall/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/21/blockchain/ethereum/usage-of-call-staticcall-delegatecall/" class="post-title-link" itemprop="url">call、staticcall、delegatecall使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-21 10:58:29" itemprop="dateCreated datePublished" datetime="2024-11-21T10:58:29+08:00">2024-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-25 12:05:10" itemprop="dateModified" datetime="2024-11-25T12:05:10+08:00">2024-11-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在 Solidity 中，<code>call</code>、<code>staticcall</code>和<code>delegatecall</code>是强大的低级操作，用于与其他合约交互或在当前上下文中执行外部合约的逻辑。掌握它们的用法和区别对于智能合约开发非常重要。</p>
<p>本文将详细介绍它们的功能、适用场景、代码示例，以及使用时需要注意的潜在问题。</p>
<h1 id="call"><a href="#call" class="headerlink" title="call"></a>call</h1><p><strong>功能</strong></p>
<p><code>call</code> 是一种通用方法，用于调用另一个合约的函数或发送 ETH。它可以调用目标合约的任意函数，包括不存在的函数（在这种情况下不会抛出错误）。</p>
<p><strong>特点</strong></p>
<ul>
<li>可读写目标合约的状态。</li>
<li>支持附带 ETH 发送。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>调用外部合约的任意函数。</li>
<li>向合约或外部账户发送 ETH。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CallExample &#123;</span><br><span class="line">    function callFunction(address target, uint256 value) external returns (bool, bytes memory) &#123;</span><br><span class="line">        // 通过 call 调用目标合约的 setValue(uint)</span><br><span class="line">        (bool success, bytes memory data) = target.call(</span><br><span class="line">            abi.encodeWithSignature(&quot;setValue(uint256)&quot;, value)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Call failed&quot;);</span><br><span class="line">        return (success, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendEth(address payable target) external payable &#123;</span><br><span class="line">        // 使用 call 发送 ETH</span><br><span class="line">        (bool success, ) = target.call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class="line">        require(success, &quot;Send ETH failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="staticcall"><a href="#staticcall" class="headerlink" title="staticcall"></a>staticcall</h1><p><strong>功能</strong></p>
<p><code>staticcall</code>是一种只读调用方法，用于调用目标合约的视图或纯函数。它不允许改变状态，因此更安全且节省 Gas</p>
<p><strong>特点</strong></p>
<ul>
<li>只能调用 view 或 pure 修饰的函数。</li>
<li>无法修改状态或发送 ETH。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>查询目标合约的状态。</li>
<li>调用只读逻辑以避免状态改变。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract StaticCallExample &#123;</span><br><span class="line">    function staticCallFunction(address target) external view returns (uint256) &#123;</span><br><span class="line">        // 使用 staticcall 调用目标合约的 storedValue()</span><br><span class="line">        (bool success, bytes memory data) = target.staticcall(</span><br><span class="line">            abi.encodeWithSignature(&quot;storedValue()&quot;)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Staticcall failed&quot;);</span><br><span class="line">        return abi.decode(data, (uint256));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="delegatecall"><a href="#delegatecall" class="headerlink" title="delegatecall"></a>delegatecall</h1><p><strong>功能</strong></p>
<p><code>delegatecall</code> 是一种在当前合约上下文中执行目标合约逻辑的方法。它会以调用合约的存储布局为准，执行目标合约中的代码。</p>
<p><strong>特点</strong></p>
<ul>
<li>使用调用合约的存储。</li>
<li>使用调用合约的 msg.sender 和 msg.value。</li>
<li>返回两个值：<ul>
<li>调用是否成功 (bool)。</li>
<li>调用返回的数据 (bytes memory)。</li>
</ul>
</li>
</ul>
<p><strong>使用场景</strong></p>
<ul>
<li>实现合约代理（如升级逻辑）。</li>
<li>在共享存储布局的上下文中执行外部逻辑。</li>
</ul>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract DelegateCallExample &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function delegateCallFunction(address target, uint256 value) external &#123;</span><br><span class="line">        // 使用 delegatecall 调用目标合约的 setValue(uint)</span><br><span class="line">        (bool success, ) = target.delegatecall(</span><br><span class="line">            abi.encodeWithSignature(&quot;setValue(uint256)&quot;, value)</span><br><span class="line">        );</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 被调用合约 (Library)</span><br><span class="line">contract Target &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 value) external &#123;</span><br><span class="line">        storedValue = value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="call-VS-staticcall-VS-delegatecall"><a href="#call-VS-staticcall-VS-delegatecall" class="headerlink" title="call VS staticcall VS delegatecall"></a><code>call</code> VS <code>staticcall</code> VS <code>delegatecall</code></h1><table>
<thead>
<tr>
<th align="center">特性</th>
<th align="center">call</th>
<th align="center">staticcall</th>
<th align="center">delegatecall</th>
</tr>
</thead>
<tbody><tr>
<td align="center">可读写状态</td>
<td align="center">✅</td>
<td align="center">❌（只读）</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">使用调用合约存储</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">使用调用合约<code>msg.sender</code></td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr>
<td align="center">支持发送ETH</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr>
<td align="center">调用不存在的函数</td>
<td align="center">支持，返回失败</td>
<td align="center">支持，返回失败</td>
<td align="center">支持，返回失败</td>
</tr>
</tbody></table>
<h1 id="使用注意事项"><a href="#使用注意事项" class="headerlink" title="使用注意事项"></a>使用注意事项</h1><p><strong>call 的安全性</strong></p>
<ul>
<li>使用 call 调用外部合约时，目标合约可能会执行恶意代码。需要额外检查返回值并限制权限。</li>
<li>不要轻易使用 call 调用不可信的合约。</li>
</ul>
<p><strong>delegatecall 的存储风险</strong></p>
<ul>
<li>调用目标合约时，目标合约必须与调用合约共享相同的存储布局，否则可能导致存储冲突。</li>
<li>使用 delegatecall 需要确保调用的是受信任的逻辑。</li>
</ul>
<p><strong>Gas 消耗与返回值处理</strong></p>
<ul>
<li>注意低级调用的 Gas 使用，避免由于 Gas 不足导致调用失败。</li>
<li>低级调用（call、staticcall 和 delegatecall）不会自动抛出异常，需要手动处理返回值。</li>
</ul>
<p><strong>不要使用简写类型</strong></p>
<p>无论是使用abi.encodeWithSelect 还是 abi.encodeWithSignature ，参数中方法名后的参数一定不要使用简写类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 错误写法</span><br><span class="line">(bool success, ) = target.call(abi.encodeWithSignature(&quot;setValue(uint)&quot;, value));</span><br></pre></td></tr></table></figure>

<p>因为在编译的过程中，编译器会将简写类型（如：uint）转换成uint256，这将导致，你的签名或选择器不匹配，导致执行失败。</p>
<h1 id="实践案例：实现代理合约"><a href="#实践案例：实现代理合约" class="headerlink" title="实践案例：实现代理合约"></a>实践案例：实现代理合约</h1><p>以下是使用 <code>delegatecall</code> 的代理合约的示例，用于实现合约逻辑的动态升级</p>
<p><strong>代码示例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">// 逻辑合约</span><br><span class="line">contract LogicContract &#123;</span><br><span class="line">    uint256 public storedValue;</span><br><span class="line"></span><br><span class="line">    function setValue(uint256 value) external &#123;</span><br><span class="line">        storedValue = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 代理合约</span><br><span class="line">contract ProxyContract &#123;</span><br><span class="line">    address public logicContract;</span><br><span class="line"></span><br><span class="line">    constructor(address _logicContract) &#123;</span><br><span class="line">        logicContract = _logicContract;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        (bool success, ) = logicContract.delegatecall(msg.data);</span><br><span class="line">        require(success, &quot;Delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>运行过程</strong></p>
<ul>
<li>部署 LogicContract。</li>
<li>部署 ProxyContract，将 LogicContract 的地址传递给其构造函数。</li>
<li>通过代理合约调用 setValue 方法，storedValue 实际存储在 ProxyContract 中</li>
</ul>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p><code>call</code>、<code>staticcall</code> 和 <code>delegatecall</code> 是 Solidity 中的基础工具，可以用来实现灵活的合约交互和逻辑扩展。在使用这些低级调用时，需要仔细处理返回值、安全性以及存储一致性问题。</p>
<p>通过合理使用这些工具，您可以设计功能强大且可扩展的智能合约体系，同时避免潜在的安全漏洞。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">博</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">148</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">123</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
