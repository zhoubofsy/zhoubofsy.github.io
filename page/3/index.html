<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/page/3/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="博">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/10/16/storage/ceph/rgw-placement-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/16/storage/ceph/rgw-placement-usage/" class="post-title-link" itemprop="url">RGW zongroup/zone placement 和 compression 用法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-16 18:17:58" itemprop="dateCreated datePublished" datetime="2019-10-16T18:17:58+08:00">2019-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>书接上文，上回书咱们了解了multisite的配置，最重要的是知道了zonegroup、zone是个什么东西，该怎么用。</p>
<p>那么今天我们来看看zonegroup和zone中的placement，顾名思义，用于告诉zone使用这个placement会将bucket、object要放到哪个里。</p>
<p>关于single rgw的模式，可以参考官网的<a target="_blank" rel="noopener" href="https://docs.ceph.com/docs/mimic/radosgw/placement/">使用配置</a>，这里不做赘述了。下面介绍一下Multisite上的配置方法。</p>
<h2 id="Placement"><a href="#Placement" class="headerlink" title="Placement"></a>Placement</h2><ol>
<li>在master zone和非master zone上分别创建同名placement</li>
<li>使用的时候可以在用户信息中指定placement，也可以在创建bucket的s3请求中指定placement。</li>
</ol>
<h3 id="master-zone"><a href="#master-zone" class="headerlink" title="master zone"></a>master zone</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin zonegroup placement add \</span></span><br><span class="line"><span class="language-bash">        --rgw-zonegroup default \</span></span><br><span class="line"><span class="language-bash">        --placement-id cold-placement</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin zone placement add \</span></span><br><span class="line"><span class="language-bash">        --rgw-zone exter \</span></span><br><span class="line"><span class="language-bash">        --placement-id cold-placement \</span></span><br><span class="line"><span class="language-bash">        --data-pool exter.rgw.cold.data \</span></span><br><span class="line"><span class="language-bash">        --index-pool exter.rgw.cold.index \</span></span><br><span class="line"><span class="language-bash">        --data-extra-pool exter.rgw.cold.non-ec \</span></span><br><span class="line"><span class="language-bash">        --compression zlib</span></span><br></pre></td></tr></table></figure>

<p>看一下配置完的zone（此处忽略zonegroup配置完的接口）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin zone get</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;69234f1d-8f48-4431-b45f-912087431a47&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;exter&quot;,</span><br><span class="line">    &quot;domain_root&quot;: &quot;exter.rgw.meta:root&quot;,</span><br><span class="line">    &quot;control_pool&quot;: &quot;exter.rgw.control&quot;,</span><br><span class="line">    &quot;gc_pool&quot;: &quot;exter.rgw.log:gc&quot;,</span><br><span class="line">    &quot;lc_pool&quot;: &quot;exter.rgw.log:lc&quot;,</span><br><span class="line">    &quot;log_pool&quot;: &quot;exter.rgw.log&quot;,</span><br><span class="line">    &quot;intent_log_pool&quot;: &quot;exter.rgw.log:intent&quot;,</span><br><span class="line">    &quot;usage_log_pool&quot;: &quot;exter.rgw.log:usage&quot;,</span><br><span class="line">    &quot;reshard_pool&quot;: &quot;exter.rgw.log:reshard&quot;,</span><br><span class="line">    &quot;user_keys_pool&quot;: &quot;exter.rgw.meta:users.keys&quot;,</span><br><span class="line">    &quot;user_email_pool&quot;: &quot;exter.rgw.meta:users.email&quot;,</span><br><span class="line">    &quot;user_swift_pool&quot;: &quot;exter.rgw.meta:users.swift&quot;,</span><br><span class="line">    &quot;user_uid_pool&quot;: &quot;exter.rgw.meta:users.uid&quot;,</span><br><span class="line">    &quot;otp_pool&quot;: &quot;exter.rgw.otp&quot;,</span><br><span class="line">    &quot;system_key&quot;: &#123;</span><br><span class="line">        &quot;access_key&quot;: &quot;85ZFW53VCKBZR7DQ7GS8&quot;,</span><br><span class="line">        &quot;secret_key&quot;: &quot;MfyuJECq3Et2kktmf3T077rYwXQMEiIGYRlwKBnq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;placement_pools&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;key&quot;: &quot;cold-placement&quot;,</span><br><span class="line">            &quot;val&quot;: &#123;</span><br><span class="line">                &quot;index_pool&quot;: &quot;exter.rgw.cold.index&quot;,</span><br><span class="line">                &quot;data_pool&quot;: &quot;exter.rgw.cold.data&quot;,</span><br><span class="line">                &quot;data_extra_pool&quot;: &quot;exter.rgw.cold.non-ec&quot;,</span><br><span class="line">                &quot;index_type&quot;: 0,</span><br><span class="line">                &quot;compression&quot;: &quot;zlib&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;key&quot;: &quot;default-placement&quot;,</span><br><span class="line">            &quot;val&quot;: &#123;</span><br><span class="line">                &quot;index_pool&quot;: &quot;exter.rgw.buckets.index&quot;,</span><br><span class="line">                &quot;data_pool&quot;: &quot;exter.rgw.buckets.data&quot;,</span><br><span class="line">                &quot;data_extra_pool&quot;: &quot;exter.rgw.buckets.non-ec&quot;,</span><br><span class="line">                &quot;index_type&quot;: 0,</span><br><span class="line">                &quot;compression&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;metadata_heap&quot;: &quot;&quot;,</span><br><span class="line">    &quot;realm_id&quot;: &quot;&quot;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>让上述配置生效需要<code>radosgw-admin period update --commit</code>一下。</p>
<h3 id="非master-zone"><a href="#非master-zone" class="headerlink" title="非master zone"></a>非master zone</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin zonegroup placement add \</span></span><br><span class="line"><span class="language-bash">        --rgw-zonegroup default \</span></span><br><span class="line"><span class="language-bash">        --placement-id cold-placement</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin zone placement add \</span></span><br><span class="line"><span class="language-bash">        --rgw-zone backup \</span></span><br><span class="line"><span class="language-bash">        --placement-id cold-placement \</span></span><br><span class="line"><span class="language-bash">        --data-pool backup.rgw.cold.data \</span></span><br><span class="line"><span class="language-bash">        --index-pool backup.rgw.cold.index \</span></span><br><span class="line"><span class="language-bash">        --data-extra-pool backup.rgw.cold.non-ec \</span></span><br><span class="line"><span class="language-bash">        --compression lz4</span></span><br></pre></td></tr></table></figure>
<p>*** 此处用的压缩算法与之前master zone使用的不一致，不影响使用。放心。***rgw会在每个对象上记录一个压缩类型，所以即使你这一刻使用的压缩算法和之前使用的不一致也不影响解压工作。</p>
<p>看一下配置完的zone（此处忽略zonegroup配置完的接口）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin zone get</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;a6621518-6f80-41f5-a736-fb5d1814e036&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;backup&quot;,</span><br><span class="line">    &quot;domain_root&quot;: &quot;backup.rgw.meta:root&quot;,</span><br><span class="line">    &quot;control_pool&quot;: &quot;backup.rgw.control&quot;,</span><br><span class="line">    &quot;gc_pool&quot;: &quot;backup.rgw.log:gc&quot;,</span><br><span class="line">    &quot;lc_pool&quot;: &quot;backup.rgw.log:lc&quot;,</span><br><span class="line">    &quot;log_pool&quot;: &quot;backup.rgw.log&quot;,</span><br><span class="line">    &quot;intent_log_pool&quot;: &quot;backup.rgw.log:intent&quot;,</span><br><span class="line">    &quot;usage_log_pool&quot;: &quot;backup.rgw.log:usage&quot;,</span><br><span class="line">    &quot;reshard_pool&quot;: &quot;backup.rgw.log:reshard&quot;,</span><br><span class="line">    &quot;user_keys_pool&quot;: &quot;backup.rgw.meta:users.keys&quot;,</span><br><span class="line">    &quot;user_email_pool&quot;: &quot;backup.rgw.meta:users.email&quot;,</span><br><span class="line">    &quot;user_swift_pool&quot;: &quot;backup.rgw.meta:users.swift&quot;,</span><br><span class="line">    &quot;user_uid_pool&quot;: &quot;backup.rgw.meta:users.uid&quot;,</span><br><span class="line">    &quot;otp_pool&quot;: &quot;backup.rgw.otp&quot;,</span><br><span class="line">    &quot;system_key&quot;: &#123;</span><br><span class="line">        &quot;access_key&quot;: &quot;85ZFW53VCKBZR7DQ7GS8&quot;,</span><br><span class="line">        &quot;secret_key&quot;: &quot;MfyuJECq3Et2kktmf3T077rYwXQMEiIGYRlwKBnq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;placement_pools&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;key&quot;: &quot;cold-placement&quot;,</span><br><span class="line">            &quot;val&quot;: &#123;</span><br><span class="line">                &quot;index_pool&quot;: &quot;backup.rgw.cold.index&quot;,</span><br><span class="line">                &quot;data_pool&quot;: &quot;backup.rgw.cold.data&quot;,</span><br><span class="line">                &quot;data_extra_pool&quot;: &quot;backkup.rgw.cold.non-ec&quot;,</span><br><span class="line">                &quot;index_type&quot;: 0,</span><br><span class="line">                &quot;compression&quot;: &quot;lz4&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;key&quot;: &quot;default-placement&quot;,</span><br><span class="line">            &quot;val&quot;: &#123;</span><br><span class="line">                &quot;index_pool&quot;: &quot;backup.rgw.buckets.index&quot;,</span><br><span class="line">                &quot;data_pool&quot;: &quot;backup.rgw.buckets.data&quot;,</span><br><span class="line">                &quot;data_extra_pool&quot;: &quot;backup.rgw.buckets.non-ec&quot;,</span><br><span class="line">                &quot;index_type&quot;: 0,</span><br><span class="line">                &quot;compression&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;metadata_heap&quot;: &quot;&quot;,</span><br><span class="line">    &quot;realm_id&quot;: &quot;f334e6c2-c2b4-4c04-b541-f64d96c10c07&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样为了上诉修改生效也需要执行一下<code>radosgw-admin period update --commit</code></p>
<h2 id="User中使用Placement"><a href="#User中使用Placement" class="headerlink" title="User中使用Placement"></a>User中使用Placement</h2><p>要想在User中配置Placement，首先得创建一个User。由于我们是在Multisite模式中创建的User，所以创建的动作必须在master zone上操作，如果在非master zone上操作用户不能同步到master zone上。具体原因请见<a href="https://zhoubofsy.github.io/2019/10/14/storage/ceph/multi-site-in-a-cluster-md/">Deploy multisite in 同一个集群</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin user create --uid colder --display-name colder</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin user info --uid colder</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;user_id&quot;: &quot;colder&quot;,</span><br><span class="line">    &quot;display_name&quot;: &quot;colder&quot;,</span><br><span class="line">    &quot;email&quot;: &quot;&quot;,</span><br><span class="line">    &quot;suspended&quot;: 0,</span><br><span class="line">    &quot;max_buckets&quot;: 1000,</span><br><span class="line">    &quot;auid&quot;: 0,</span><br><span class="line">    &quot;subusers&quot;: [],</span><br><span class="line">    &quot;keys&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;user&quot;: &quot;colder&quot;,</span><br><span class="line">            &quot;access_key&quot;: &quot;WGCQOD46GA92J7CIGXIY&quot;,</span><br><span class="line">            &quot;secret_key&quot;: &quot;8yZw0FkYojiLdebWEF61HHTGhUvBrCel6ZzvGQRu&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;swift_keys&quot;: [],</span><br><span class="line">    &quot;caps&quot;: [],</span><br><span class="line">    &quot;op_mask&quot;: &quot;read, write, delete&quot;,</span><br><span class="line">    &quot;default_placement&quot;: &quot;&quot;,</span><br><span class="line">    &quot;placement_tags&quot;: [],</span><br><span class="line">    &quot;bucket_quota&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false,</span><br><span class="line">        &quot;check_on_raw&quot;: false,</span><br><span class="line">        &quot;max_size&quot;: -1,</span><br><span class="line">        &quot;max_size_kb&quot;: 0,</span><br><span class="line">        &quot;max_objects&quot;: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;user_quota&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false,</span><br><span class="line">        &quot;check_on_raw&quot;: false,</span><br><span class="line">        &quot;max_size&quot;: -1,</span><br><span class="line">        &quot;max_size_kb&quot;: 0,</span><br><span class="line">        &quot;max_objects&quot;: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;temp_url_keys&quot;: [],</span><br><span class="line">    &quot;type&quot;: &quot;rgw&quot;,</span><br><span class="line">    &quot;mfa_ids&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>default_placement</code>为空，此时会使用默认的placement也就是<code>default-placement</code>。所以需要配置这个选项。但是<code>radosgw-admin</code>中没有直接配置这个项目的参数，所以需要采用导出导入metadata的方式来修改该项目。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin metadata get user:colder &gt; colder.json</span></span><br></pre></td></tr></table></figure>
<p>将user <code>colder</code>的配置导出到<code>coder.json</code>中，然后编辑其中的<code>&quot;default_placement&quot;: &quot;cold-placement&quot;,</code>，然后再将<code>colder.json</code>导入回去。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">radosgw-admin metadata put user:colder &lt; colder.json</span></span><br></pre></td></tr></table></figure>
<p>接下来可以使用该用户的access-key和secret-key去创建bucket并上传对象了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/10/14/storage/ceph/multi-site-in-a-cluster-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/14/storage/ceph/multi-site-in-a-cluster-md/" class="post-title-link" itemprop="url">Deploy multisite in 同一个集群</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-14 18:17:55" itemprop="dateCreated datePublished" datetime="2019-10-14T18:17:55+08:00">2019-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在一个Ceph集群里部署一个multisite RGW环境。有什么意义吗？没有，存属个人折腾。由于资源有限，所以只能在一个集群里委屈了。</p>
<p>限盐少许，直接开整。</p>
<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><p>14.2.3 (0f776cf838a1ae3130b2b73dc26be9c95c6ccc39) nautilus (stable)</p>
<h1 id="RGW配置部署"><a href="#RGW配置部署" class="headerlink" title="RGW配置部署"></a>RGW配置部署</h1><h2 id="一个Site的部署"><a href="#一个Site的部署" class="headerlink" title="一个Site的部署"></a>一个Site的部署</h2><h3 id="修改-rgw-rootPool"><a href="#修改-rgw-rootPool" class="headerlink" title="修改.rgw.rootPool"></a>修改<code>.rgw.root</code>Pool</h3><p>修改<code>/etc/ceph/ceph.conf</code>中使用到<code>.rgw.root</code>pool的所有配置项，将其改为<code>exter.rgw.root</code>。<code>ceph.conf</code>中没有显示的配置，所以建议查找一下源代码中的配置<code>options.cc</code>。<br>之后再创建<code>realm</code>、<code>zonegroup</code>、<code>zone</code>等信息都会记录到<code>exter.rgw.root</code>中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rgw_zone_root_pool = exter.rgw.root</span><br><span class="line">rgw_region_root_pool = exter.rgw.root</span><br><span class="line">rgw_zonegroup_root_pool = exter.rgw.root</span><br><span class="line">rgw_realm_root_pool = exter.rgw.root</span><br><span class="line">rgw_period_root_pool = exter.rgw.root</span><br></pre></td></tr></table></figure>

<p>配置完成后，启动RGW。本人将RGW安装到了容器中，所以下面给出容器的启动命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net=host --name rgw -v /etc/ceph/:/etc/ceph/ -v /var/lib/ceph/:/var/lib/ceph/ ceph/daemon:latest-nautilus rgw</span><br></pre></td></tr></table></figure>
<p>运行后记得用<code>docker logs -f rgw</code>看一下rgw日志，确保其正常运行。</p>
<p>然后使用<code>ceph df</code>看一下，当前RGW创建了哪些Pools</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ceph <span class="built_in">df</span></span></span><br><span class="line">GLOBAL:</span><br><span class="line">    SIZE       AVAIL      RAW USED     %RAW USED</span><br><span class="line">    57 GiB     56 GiB      654 MiB          1.12</span><br><span class="line">POOLS:</span><br><span class="line">    NAME                        ID     USED        %USED     MAX AVAIL     OBJECTS</span><br><span class="line">    exter.rgw.root              18     1.2 KiB         0        27 GiB           4</span><br><span class="line">    default.rgw.control         19         0 B         0        27 GiB           8</span><br><span class="line">    default.rgw.meta            20         0 B         0        27 GiB           0</span><br><span class="line">    default.rgw.log             21         0 B         0        27 GiB          33</span><br></pre></td></tr></table></figure>

<h3 id="创建Realm"><a href="#创建Realm" class="headerlink" title="创建Realm"></a>创建Realm</h3><p>创建一个 realm ，若不创建，后续在设置自定义的zone为default时会报无效参数的错误。此问题，可以看<code>rgw_admin.cc</code>的源码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4438</span>     <span class="keyword">case</span> OPT_ZONE_DEFAULT:</span><br><span class="line"><span class="number">4439</span>       &#123;</span><br><span class="line"><span class="number">4440</span>         RGWZoneGroup <span class="title function_">zonegroup</span><span class="params">(zonegroup_id,zonegroup_name)</span>;</span><br><span class="line"><span class="number">4441</span>         <span class="type">int</span> ret = zonegroup.init(g_ceph_context, store-&gt;svc()-&gt;sysobj);</span><br><span class="line"><span class="number">4442</span>         <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">4443</span>           <span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;WARNING: failed to initialize zonegroup &quot;</span> &lt;&lt; zonegroup_name &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="number">4444</span>         &#125;</span><br><span class="line"><span class="number">4445</span>         <span class="keyword">if</span> (zone_id.empty() &amp;&amp; zone_name.empty()) &#123;</span><br><span class="line"><span class="number">4446</span>           <span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;no zone name or id provided&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="number">4447</span>           <span class="keyword">return</span> EINVAL;</span><br><span class="line"><span class="number">4448</span>         &#125;</span><br><span class="line"><span class="number">4449</span>         RGWZoneParams <span class="title function_">zone</span><span class="params">(zone_id, zone_name)</span>;</span><br><span class="line"><span class="number">4450</span>         ret = zone.init(g_ceph_context, store-&gt;svc()-&gt;sysobj);</span><br><span class="line"><span class="number">4451</span>         <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">4452</span>           <span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;unable to initialize zone: &quot;</span> &lt;&lt; cpp_strerror(-ret) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="number">4453</span>           <span class="keyword">return</span> -ret;</span><br><span class="line"><span class="number">4454</span>         &#125;</span><br><span class="line"><span class="number">4455</span>         ret = zone.set_as_default();</span><br><span class="line"><span class="number">4456</span>         <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">4457</span>           <span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;failed to set zone as default: &quot;</span> &lt;&lt; cpp_strerror(-ret) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="number">4458</span>           <span class="keyword">return</span> -ret;</span><br><span class="line"><span class="number">4459</span>         &#125;</span><br><span class="line"><span class="number">4460</span>       &#125;</span><br><span class="line"><span class="number">4461</span>       <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>在<code>failed to set zone as default</code>这个位置报错。</p>
<p>所以先配置一个realm吧</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# radosgw-admin realm list</span><br><span class="line">&#123;</span><br><span class="line">    &quot;default_info&quot;: &quot;&quot;,</span><br><span class="line">    &quot;realms&quot;: []</span><br><span class="line">&#125;</span><br><span class="line">[root@master ~]# radosgw-admin realm create --rgw-realm=default --default</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;f334e6c2-c2b4-4c04-b541-f64d96c10c07&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;default&quot;,</span><br><span class="line">    &quot;current_period&quot;: &quot;40775bd3-d592-46c0-98c7-33171915825b&quot;,</span><br><span class="line">    &quot;epoch&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="设置zonegroup的default-info"><a href="#设置zonegroup的default-info" class="headerlink" title="设置zonegroup的default info"></a>设置zonegroup的default info</h3><p>此时zonegroup的default info缺失了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# radosgw-admin zonegroup list</span><br><span class="line">&#123;</span><br><span class="line">    &quot;default_info&quot;: &quot;&quot;,</span><br><span class="line">    &quot;zonegroups&quot;: [</span><br><span class="line">        &quot;default&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[root@master ~]# radosgw-admin zonegroup get</span><br><span class="line">failed to init zonegroup: (2) No such file or directory</span><br></pre></td></tr></table></figure>
<p>使用 <code>zonegroup default</code>重新设置default info</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# radosgw-admin zonegroup default --rgw-zonegroup=default</span><br><span class="line">[root@master ~]# radosgw-admin zonegroup list</span><br><span class="line">&#123;</span><br><span class="line">    &quot;default_info&quot;: &quot;57b6eaac-63da-42dd-b69d-f7e871ce74c9&quot;,</span><br><span class="line">    &quot;zonegroups&quot;: [</span><br><span class="line">        &quot;default&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建Zone"><a href="#创建Zone" class="headerlink" title="创建Zone"></a>创建Zone</h3><p>接下来，创建我们需要的zone, 并设置其为default</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# radosgw-admin zone list</span><br><span class="line">&#123;</span><br><span class="line">    &quot;default_info&quot;: &quot;&quot;,</span><br><span class="line">    &quot;zones&quot;: [</span><br><span class="line">        &quot;default&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[root@master ~]# radosgw-admin zone create --rgw-zonegroup=default --rgw-zone=exter --master --default</span><br><span class="line">2019-10-14 19:00:50.322 7f3698ef7240  0 NOTICE: overriding master zone: f2a55476-fb68-4ea7-af97-251b91e94747</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;69234f1d-8f48-4431-b45f-912087431a47&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;exter&quot;,</span><br><span class="line">    &quot;domain_root&quot;: &quot;exter.rgw.meta:root&quot;,</span><br><span class="line">    &quot;control_pool&quot;: &quot;exter.rgw.control&quot;,</span><br><span class="line">    &quot;gc_pool&quot;: &quot;exter.rgw.log:gc&quot;,</span><br><span class="line">    &quot;lc_pool&quot;: &quot;exter.rgw.log:lc&quot;,</span><br><span class="line">    &quot;log_pool&quot;: &quot;exter.rgw.log&quot;,</span><br><span class="line">    &quot;intent_log_pool&quot;: &quot;exter.rgw.log:intent&quot;,</span><br><span class="line">    &quot;usage_log_pool&quot;: &quot;exter.rgw.log:usage&quot;,</span><br><span class="line">    &quot;reshard_pool&quot;: &quot;exter.rgw.log:reshard&quot;,</span><br><span class="line">    &quot;user_keys_pool&quot;: &quot;exter.rgw.meta:users.keys&quot;,</span><br><span class="line">    &quot;user_email_pool&quot;: &quot;exter.rgw.meta:users.email&quot;,</span><br><span class="line">    &quot;user_swift_pool&quot;: &quot;exter.rgw.meta:users.swift&quot;,</span><br><span class="line">    &quot;user_uid_pool&quot;: &quot;exter.rgw.meta:users.uid&quot;,</span><br><span class="line">    &quot;otp_pool&quot;: &quot;exter.rgw.otp&quot;,</span><br><span class="line">    &quot;system_key&quot;: &#123;</span><br><span class="line">        &quot;access_key&quot;: &quot;&quot;,</span><br><span class="line">        &quot;secret_key&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;placement_pools&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;key&quot;: &quot;default-placement&quot;,</span><br><span class="line">            &quot;val&quot;: &#123;</span><br><span class="line">                &quot;index_pool&quot;: &quot;exter.rgw.buckets.index&quot;,</span><br><span class="line">                &quot;data_pool&quot;: &quot;exter.rgw.buckets.data&quot;,</span><br><span class="line">                &quot;data_extra_pool&quot;: &quot;exter.rgw.buckets.non-ec&quot;,</span><br><span class="line">                &quot;index_type&quot;: 0,</span><br><span class="line">                &quot;compression&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;metadata_heap&quot;: &quot;&quot;,</span><br><span class="line">    &quot;realm_id&quot;: &quot;f334e6c2-c2b4-4c04-b541-f64d96c10c07&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@master ~]# radosgw-admin zone list</span><br><span class="line">&#123;</span><br><span class="line">    &quot;default_info&quot;: &quot;69234f1d-8f48-4431-b45f-912087431a47&quot;,</span><br><span class="line">    &quot;zones&quot;: [</span><br><span class="line">        &quot;exter&quot;,</span><br><span class="line">        &quot;default&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除default-zone"><a href="#删除default-zone" class="headerlink" title="删除default zone"></a>删除default zone</h3><p>现在你会发现有两个zone了，一个是我们新建的，另一个是default，这个default没用了，我们把它删掉。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">radosgw-admin zone delete --rgw-zone=default --default</span><br></pre></td></tr></table></figure>

<p>细心的朋友可能会发现radosgw-admin命令中没有<code>zone delete</code>这个命令啊，<code>-h</code>中显示的是<code>zone rm</code>啊。这是Bug，嘿嘿嘿～～～</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# radosgw-admin -h | grep -i zone | grep -i rm</span><br><span class="line">  zonegroup rm               remove a zone group info</span><br><span class="line">  zonegroup rm               remove a zone from a zonegroup</span><br><span class="line">  zonegroup placement rm     remove a placement target from a zonegroup</span><br><span class="line">  zone rm                    remove a zone</span><br><span class="line">  zone placement rm          remove a zone placement target</span><br><span class="line">   --tags-rm=&lt;list&gt;          list of tags to remove for zonegroup placement modify command</span><br><span class="line">   --sync-from-rm=[zone-name][,...]</span><br><span class="line">[root@master ~]# radosgw-admin -h | grep -i delete</span><br><span class="line">                               replica mdlog get/delete</span><br><span class="line">                               replica datalog get/delete</span><br><span class="line">                             (NOTE: required to delete a non-empty bucket)</span><br></pre></td></tr></table></figure>

<h3 id="重启RGW服务"><a href="#重启RGW服务" class="headerlink" title="重启RGW服务"></a>重启RGW服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# docker stop rgw</span><br><span class="line">[root@master ~]# docker start rgw</span><br></pre></td></tr></table></figure>

<h3 id="删除default相关的Pools"><a href="#删除default相关的Pools" class="headerlink" title="删除default相关的Pools"></a>删除default相关的Pools</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ceph df</span><br><span class="line">GLOBAL:</span><br><span class="line">    SIZE       AVAIL      RAW USED     %RAW USED</span><br><span class="line">    57 GiB     56 GiB      657 MiB          1.13</span><br><span class="line">POOLS:</span><br><span class="line">    NAME                        ID     USED        %USED     MAX AVAIL     OBJECTS</span><br><span class="line">    exter.rgw.root              18     1.7 KiB         0        27 GiB          13</span><br><span class="line">    default.rgw.control         19         0 B         0        27 GiB           8</span><br><span class="line">    default.rgw.meta            20         0 B         0        27 GiB           0</span><br><span class="line">    default.rgw.log             21         0 B         0        27 GiB         175</span><br><span class="line">    exter.rgw.control           22         0 B         0        27 GiB           8</span><br><span class="line">    exter.rgw.meta              23         0 B         0        27 GiB           0</span><br><span class="line">    exter.rgw.log               24         0 B         0        27 GiB         159</span><br></pre></td></tr></table></figure>
<p>重启RGW服务后，发现多了三个Pool <code>exter.rgw.control</code>、<code>exter.rgw.meta</code>、<code>exter.rgw.log</code>。而default开头的pool就没用了，可以删除了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it</span><br><span class="line">pool &#x27;default.rgw.control&#x27; removed</span><br><span class="line">[root@master ~]# ceph osd pool rm default.rgw.meta default.rgw.meta --yes-i-really-really-mean-it</span><br><span class="line">pool &#x27;default.rgw.meta&#x27; removed</span><br><span class="line">[root@master ~]# ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it</span><br><span class="line">pool &#x27;default.rgw.log&#x27; removed</span><br></pre></td></tr></table></figure>

<h2 id="另一个Site的部署"><a href="#另一个Site的部署" class="headerlink" title="另一个Site的部署"></a>另一个Site的部署</h2><p>*** 参考<code>一个Site的部署方法</code>吧 ***</p>
<h2 id="Zone之间的数据同步"><a href="#Zone之间的数据同步" class="headerlink" title="Zone之间的数据同步"></a>Zone之间的数据同步</h2><p>如果上述的部署方法你都清楚了，相信配置一个Zone之间同步数据的Multisite应该不在话下了。下面说说数据同步的几点注意事项吧。</p>
<ol>
<li>数据同步必须是在不同zone之间进行的，但zone必须在同一zonegroup之下。</li>
<li>每一个zonegroup内都有一个master zone；一个realm中有多个zonegroup，但master zonegroup只有一个，realm命名空间全局唯一；</li>
<li>数据分为 period 数据、user数据、bucket数据、object数据。<br> period数据需要用户手动配置，不能自动同步；<br> user数据只能从master zone写入，然后非master zone同步；<br> bucket数据可以从任意一个zone写入，但最后都会转发给master zone，待master 写入成功后，其它zone同步数据，若master失败，其它zone亦失败；<br> object数据可以从任意一个zone写入，若master zone写入失败，不影响其它zone写入情况。</li>
<li>每个zone的<code>endpoints</code>需要配置，否则zone之间无法正常访问</li>
<li>zone上配置的<code>access key</code>和<code>secret</code>要与master zone一致</li>
</ol>
<p>补个图吧：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                                          +--- master zone</span><br><span class="line">                                          |</span><br><span class="line">                                          +--- secondary zone 1</span><br><span class="line">                                          |</span><br><span class="line">         +---------- master zonegroup ----+--- ......</span><br><span class="line">         |                                |</span><br><span class="line">         |                                +--- secondary zone n</span><br><span class="line">         |</span><br><span class="line">realm ---+---------- secondary zonegroup 1 --+--- master zone</span><br><span class="line">         |                                   |</span><br><span class="line">         |                                   +--- secondary zone 1</span><br><span class="line">         +---------- ......                  |</span><br><span class="line">         |                                   +--- ......</span><br><span class="line">         |</span><br><span class="line">         +---------- secondary zonegropu n</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/09/28/storage/ceph/ceph-ansible-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/28/storage/ceph/ceph-ansible-usage/" class="post-title-link" itemprop="url">ceph-ansible 使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-28 08:52:30" itemprop="dateCreated datePublished" datetime="2019-09-28T08:52:30+08:00">2019-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Ceph的部署有很多种，从最早的手动部署，到后来的Ceph-deploy，再到目前比较火的容器部署等等。但能作为生产环境部署的却不多，其中Ceph-ansible算是生产环境部署的方法之一。Ceph-ansible是基于ansible工具完成Ceph部署的。对于生产环境中动则几十、成百上千的节点数量如果一台一台安装配置效率太低。引入ansible工具可以快速完成Ceph集群的安装配置，大大提高效率。让运维人员从机械重复的工作中解脱出来。</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>三个节点，其中一个节点用作ansible和Ceph节点的复用节点。</p>
<table>
<thead>
<tr>
<th align="center">节点IP</th>
<th align="center">节点角色</th>
<th align="center">OS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">172.30.12.137</td>
<td align="center">ansible节点、ceph节点</td>
<td align="center">CentOS Linux release 7.7.1908</td>
</tr>
<tr>
<td align="center">172.30.12.197</td>
<td align="center">ceph节点</td>
<td align="center">CentOS Linux release 7.7.1908</td>
</tr>
<tr>
<td align="center">172.30.12.227</td>
<td align="center">ceph节点</td>
<td align="center">CentOS Linux release 7.7.1908</td>
</tr>
</tbody></table>
<p>本文中使用的ansible工具运行在一个 CentOS7.6.1810 的容器内。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>ceph-ansible是基于ansible工作的，所以要先安装ansible。既然要安装ansible，首先要先搞清楚安装哪个版本？</p>
<p>本文部署的Ceph版本为<code>mimic</code>，官方推荐可以使用<code>stable-3.1</code>和<code>stable-3.2</code>，我选择了较新的<code>stable-3.2</code>，<code>stable-3.2</code>对应的ansible版本为2.6。（更多关于版本对应关系请见<a target="_blank" rel="noopener" href="https://docs.ceph.com/ceph-ansible/master/#releases">官网</a>）</p>
<p>选择完了ansible版本接下来就可以安装了，安装分为两种方式</p>
<ul>
<li>pip 安装</li>
<li>yum&#x2F;apt 安装</li>
</ul>
<p>由于 yum&#x2F;apt 安装版本选择范围比较狭窄，所以本人推荐使用 pip 安装。(关于pip安装请见<a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/installing/">pypa官网</a>)</p>
<p>首先clone ceph-ansible project</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git <span class="built_in">clone</span> git@github.com:ceph/ceph-ansible.git</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git checkout -b 3.2.0 v3.2.0</span></span><br></pre></td></tr></table></figure>
<p>然后使用ceph-ansible中推荐的<code>requirements.txt</code>安装对应版本的ansible</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r ./ceph-ansible/requirements.txt</span><br></pre></td></tr></table></figure>
<p>待安装完成后，查看确认ansible版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible --version</span></span><br><span class="line">ansible 2.6.19</span><br><span class="line">  config file = /root/ceph-ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u&#x27;/root/.ansible/plugins/modules&#x27;, u&#x27;/usr/share/ansible/plugins/modules&#x27;]</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="ansible-配置"><a href="#ansible-配置" class="headerlink" title="ansible 配置"></a>ansible 配置</h3><p>ansible inventory 自定义的配置可以放置在任何位置，只是在运行ansible时增加<code>-i &#123;inventory host path&#125;</code>指定其路径即可。若不指定inventory文件，ansible将去<code>/etc/ansible/hosts</code>这个路径去找。</p>
<p>inventory配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[mons]</span><br><span class="line">172.30.12.197 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br><span class="line"></span><br><span class="line">[osds]</span><br><span class="line">172.30.12.137 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br><span class="line">172.30.12.197 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br><span class="line"></span><br><span class="line">[mgrs]</span><br><span class="line">172.30.12.137 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br></pre></td></tr></table></figure>
<p>密码中若存在特殊字符<code>$</code>,<code>#</code>等，需要使用<code>\\</code>进行转义。<br>配置完成后，可使用<code>ansible all -i &#123;inventory host&#125; -m ping</code>测试节点连通情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i dummy-ansible-hosts -m ping</span></span><br><span class="line">172.30.12.197 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">172.30.12.227 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">172.30.12.137 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ceph-ansible-配置"><a href="#ceph-ansible-配置" class="headerlink" title="ceph-ansible 配置"></a>ceph-ansible 配置</h3><p>ceph-ansible的配置，主要是对group变量的配置，一般场景中我们不需要修改role。</p>
<h4 id="配置-all-yml"><a href="#配置-all-yml" class="headerlink" title="配置 all.yml"></a>配置 all.yml</h4><p>首先：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./gourp_vars/all.yml.sample ./gourp_vars/all.yml</span><br></pre></td></tr></table></figure>

<p>然后，修改<code>all.yml</code>中的配置，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inventory host group variables</span></span><br><span class="line"><span class="attr">mon_group_name:</span> <span class="string">mons</span></span><br><span class="line"><span class="attr">osd_group_name:</span> <span class="string">osds</span></span><br><span class="line"><span class="comment">#rgw_group_name: rgws</span></span><br><span class="line"><span class="comment">#mds_group_name: mdss</span></span><br><span class="line"><span class="comment">#nfs_group_name: nfss</span></span><br><span class="line"><span class="comment">#restapi_group_name: restapis</span></span><br><span class="line"><span class="comment">#rbdmirror_group_name: rbdmirrors</span></span><br><span class="line"><span class="comment">#client_group_name: clients</span></span><br><span class="line"><span class="comment">#iscsi_gw_group_name: iscsigws</span></span><br><span class="line"><span class="comment">#mgr_group_name: mgrs</span></span><br><span class="line"><span class="comment"># 上述 Inventory host 相关变量的默认值与 Inventory配置中的标签名一致，也就是说这里注释打开与否没有影响</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment"># If configure_firewall is true, then ansible will try to configure the</span></span><br><span class="line"><span class="comment"># appropriate firewalling rules so that Ceph daemons can communicate</span></span><br><span class="line"><span class="comment"># with each others.</span></span><br><span class="line"><span class="comment">#configure_firewall: True</span></span><br><span class="line"><span class="attr">configure_firewall:</span> <span class="literal">False</span></span><br><span class="line"><span class="comment"># 建议Firewall配不明白的同学将Firewall关闭，免得找麻烦。</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment"># Set type of NTP client daemon to use, valid entries are chronyd, ntpd or timesyncd</span></span><br><span class="line"><span class="comment"># Note that this selection is currently ignored on containerized deployments</span></span><br><span class="line"><span class="comment">#ntp_daemon_type: timesyncd</span></span><br><span class="line"><span class="attr">ntp_daemon_type:</span> <span class="string">chronyd</span></span><br><span class="line"><span class="comment"># Ceph需要做时间同步，具体用什么做可根据自己环境来选择。目前提供支持的有三种 chronyd, ntpd, timesyncd</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment"># ORIGIN SOURCE</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Choose between:</span></span><br><span class="line"><span class="comment"># - &#x27;repository&#x27; means that you will get ceph installed through a new repository. Later below choose between &#x27;community&#x27;, &#x27;rhcs&#x27;, &#x27;dev&#x27; or &#x27;obs&#x27;</span></span><br><span class="line"><span class="comment"># - &#x27;distro&#x27; means that no separate repo file will be added</span></span><br><span class="line"><span class="comment">#  you will get whatever version of Ceph is included in your Linux distro.</span></span><br><span class="line"><span class="comment"># &#x27;local&#x27; means that the ceph binaries will be copied over from the local machine</span></span><br><span class="line"><span class="comment">#ceph_origin: dummy</span></span><br><span class="line"><span class="attr">ceph_origin:</span> <span class="string">repository</span></span><br><span class="line"><span class="comment">#valid_ceph_origins:</span></span><br><span class="line"><span class="comment">#  - repository</span></span><br><span class="line"><span class="comment">#  - distro</span></span><br><span class="line"><span class="comment">#  - local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ceph_repository:</span> <span class="string">community</span></span><br><span class="line"><span class="comment">#valid_ceph_repository:</span></span><br><span class="line"><span class="comment">#  - community</span></span><br><span class="line"><span class="comment">#  - rhcs</span></span><br><span class="line"><span class="comment">#  - dev</span></span><br><span class="line"><span class="comment">#  - uca</span></span><br><span class="line"><span class="comment">#  - custom</span></span><br><span class="line"><span class="comment">#  - obs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># REPOSITORY: COMMUNITY VERSION</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Enabled when ceph_repository == &#x27;community&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#ceph_mirror: http://download.ceph.com</span></span><br><span class="line"><span class="comment">#ceph_stable_key: https://download.ceph.com/keys/release.asc</span></span><br><span class="line"><span class="comment">#ceph_stable_release: dummy</span></span><br><span class="line"><span class="comment">#ceph_stable_repo: &quot;&#123;&#123; ceph_mirror &#125;&#125;/debian-&#123;&#123; ceph_stable_release &#125;&#125;&quot;</span></span><br><span class="line"><span class="attr">ceph_mirror:</span> <span class="string">http://mirrors.163.com/ceph</span></span><br><span class="line"><span class="attr">ceph_stable_key:</span> <span class="string">https://mirrors.163.com/ceph/keys/release.asc</span></span><br><span class="line"><span class="attr">ceph_stable_release:</span> <span class="string">mimic</span></span><br><span class="line"><span class="attr">ceph_stable_repo:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ceph_mirror &#125;&#125;</span>/rpm-<span class="template-variable">&#123;&#123; ceph_stable_release &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># Ceph 软件包的安装方式，有三种，repository使用一个新的源进行安装；distro使用linux发行版自带的源进行安装；local使用本地安装包的形式进行安装。</span></span><br><span class="line"><span class="comment"># 具体情况根据自身要求而定吧。</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment">## Monitor options</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You must define either monitor_interface, monitor_address or monitor_address_block.</span></span><br><span class="line"><span class="comment"># These variables must be defined at least in all.yml and overrided if needed (inventory host file or group_vars/*.yml).</span></span><br><span class="line"><span class="comment"># Eg. If you want to specify for each monitor which address the monitor will bind to you can set it in your **inventory host file** by using &#x27;monitor_address&#x27; variable.</span></span><br><span class="line"><span class="comment"># Preference will go to monitor_address if both monitor_address and monitor_interface are defined.</span></span><br><span class="line"><span class="comment">#monitor_interface: interface</span></span><br><span class="line"><span class="attr">monitor_interface:</span> <span class="string">ens33</span></span><br><span class="line"><span class="comment">#monitor_address: 0.0.0.0</span></span><br><span class="line"><span class="comment">#monitor_address_block: subnet</span></span><br><span class="line"><span class="comment"># set to either ipv4 or ipv6, whichever your network is using</span></span><br><span class="line"><span class="comment">#ip_version: ipv4</span></span><br><span class="line"><span class="comment">#mon_use_fqdn: false # if set to true, the MON name used will be the fqdn in the ceph.conf</span></span><br><span class="line"><span class="comment"># Monitor的配置，必须要在 interface, address, address_block 中选择一个定义。（更多使用方法，请仔细阅读上面的英文吧。）</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment">## OSD options</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#is_hci: false</span></span><br><span class="line"><span class="comment">#hci_safety_factor: 0.2</span></span><br><span class="line"><span class="comment">#non_hci_safety_factor: 0.7</span></span><br><span class="line"><span class="comment">#osd_memory_target: 4294967296</span></span><br><span class="line"><span class="comment">#journal_size: 5120 # OSD journal size in MB</span></span><br><span class="line"><span class="attr">journal_size:</span> <span class="number">1024</span> <span class="comment"># OSD journal size in MB</span></span><br><span class="line"><span class="comment">#block_db_size: -1 # block db size in bytes for the ceph-volume lvm batch. -1 means use the default of &#x27;as big as possible&#x27;.</span></span><br><span class="line"><span class="comment">#public_network: 0.0.0.0/0</span></span><br><span class="line"><span class="attr">public_network:</span> <span class="number">172.30</span><span class="number">.12</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="attr">cluster_network:</span> <span class="number">172.30</span><span class="number">.12</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="comment">#cluster_network: &quot;&#123;&#123; public_network | regex_replace(&#x27; &#x27;, &#x27;&#x27;) &#125;&#125;&quot;</span></span><br><span class="line"><span class="comment">#osd_mkfs_type: xfs</span></span><br><span class="line"><span class="comment">#osd_mkfs_options_xfs: -f -i size=2048</span></span><br><span class="line"><span class="comment">#osd_mount_options_xfs: noatime,largeio,inode64,swalloc</span></span><br><span class="line"><span class="comment">#osd_objectstore: bluestore</span></span><br><span class="line"><span class="attr">osd_objectstore:</span> <span class="string">filestore</span></span><br><span class="line"><span class="comment"># 根据硬盘的存储介质与速度决定Journal size的大小；配置public,cluster newtwork；选择objectstore filestore or bluestore</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h4 id="配置-osds-yml"><a href="#配置-osds-yml" class="headerlink" title="配置 osds.yml"></a>配置 osds.yml</h4><p>首先</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./gourp_vars/osds.yml.sample ./gourp_vars/osds.yml</span><br></pre></td></tr></table></figure>
<p>然后，修改<code>osds.yml</code>配置，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment"># Even though OSD nodes should not have the admin key</span></span><br><span class="line"><span class="comment"># at their disposal, some people might want to have it</span></span><br><span class="line"><span class="comment"># distributed on OSD nodes. Setting &#x27;copy_admin_key&#x27; to &#x27;true&#x27;</span></span><br><span class="line"><span class="comment"># will copy the admin key to the /etc/ceph/ directory</span></span><br><span class="line"><span class="comment">#copy_admin_key: false</span></span><br><span class="line"><span class="attr">copy_admin_key:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 根据个人喜好来吧，我喜欢各个OSD节点都有admin key</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment"># Declare devices to be used as OSDs</span></span><br><span class="line"><span class="comment"># All scenario(except 3rd) inherit from the following device declaration</span></span><br><span class="line"><span class="comment"># <span class="doctag">Note:</span> This scenario uses the ceph-disk tool to provision OSDs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">devices:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/dev/sdb</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/dev/sdc</span></span><br><span class="line">  <span class="comment">#  - /dev/sdd</span></span><br><span class="line">  <span class="comment">#  - /dev/sde</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#devices: []</span></span><br><span class="line"><span class="comment"># 根据主机情况配置硬盘路径相关信息</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">osd_scenario:</span> <span class="string">collocated</span></span><br><span class="line"><span class="comment">#valid_osd_scenarios:</span></span><br><span class="line"><span class="comment">#  - collocated</span></span><br><span class="line"><span class="comment">#  - non-collocated</span></span><br><span class="line"><span class="comment">#  - lvm</span></span><br><span class="line"><span class="comment"># collocated是将日志和数据部署到同一个硬盘上；non-collocated是分硬盘部署日志和数据；这两个选项都是使用ceph-disk创建的。</span></span><br><span class="line"><span class="comment"># lvm使用ceph-volume创建osd，需要指定vg、lvm等信息。</span></span><br><span class="line"><span class="comment"># 此处具体信息，请见`osds.yml.sample`里面有很详细的注解。</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h4 id="配置-mgrs-yml"><a href="#配置-mgrs-yml" class="headerlink" title="配置 mgrs.yml"></a>配置 mgrs.yml</h4><p>首先</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./gourp_vars/mgrs.yml.sample ./gourp_vars/mgrs.yml</span><br></pre></td></tr></table></figure>
<p>然后，修改<code>mgrs.yml</code>配置，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="comment">###########</span></span><br><span class="line"><span class="comment"># MODULES #</span></span><br><span class="line"><span class="comment">###########</span></span><br><span class="line"><span class="comment"># Ceph mgr modules to enable, current modules available are: status,dashboard,localpool,restful,zabbix,prometheus,influx</span></span><br><span class="line"><span class="attr">ceph_mgr_modules:</span> [<span class="string">status</span>]</span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><h3 id="集群初始化部署"><a href="#集群初始化部署" class="headerlink" title="集群初始化部署"></a>集群初始化部署</h3><p>首先</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./site.yml.sample ./site.yml</span><br></pre></td></tr></table></figure>
<p>然后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i &#123;inventory host&#125; site.yml</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>部署过程需要下载RPM包安装，所以网速对部署速度的影响很大。请耐心等待。</p>
<h3 id="增加OSD节点部署"><a href="#增加OSD节点部署" class="headerlink" title="增加OSD节点部署"></a>增加OSD节点部署</h3><p>首先</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./infrastructure-playbooks/add-osd.yml ./add-osd.yml</span><br></pre></td></tr></table></figure>
<p>然后，修改inventory host文件，在<code>[osds]</code>中增加<code>172.30.12.227</code>这条记录，相当于增加一个osd节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[mons]</span><br><span class="line">172.30.12.197 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br><span class="line"></span><br><span class="line">[osds]</span><br><span class="line">172.30.12.137 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br><span class="line">172.30.12.197 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br><span class="line">172.30.12.227 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br><span class="line"></span><br><span class="line">[mgrs]</span><br><span class="line">172.30.12.137 ansible_ssh_user=root ansible_ssh_pass=1234\$\#</span><br></pre></td></tr></table></figure>
<p>最后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i &#123;inventory host&#125; add-osd.yml</span><br></pre></td></tr></table></figure>

<h3 id="清除集群部署"><a href="#清除集群部署" class="headerlink" title="清除集群部署"></a>清除集群部署</h3><p>首先</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp ./infrastructure-playbooks/purge-cluster.yml ./purge-cluster.yml</span><br></pre></td></tr></table></figure>
<p>然后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i &#123;inventory host&#125; purge-cluster.yml</span><br></pre></td></tr></table></figure>

<h3 id="Ceph配置文件分发"><a href="#Ceph配置文件分发" class="headerlink" title="Ceph配置文件分发"></a>Ceph配置文件分发</h3><p>配置文件分发各个节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i dummy-ansible-hosts -m copy -a &quot;src=/root/ceph.conf dest=/etc/ceph/&quot;</span><br></pre></td></tr></table></figure>

<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://lnsyyj.github.io/2018/08/29/ceph-ansible-project/">ceph-ansible project</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/09/24/storage/ceph/rgw-auth-ldap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/24/storage/ceph/rgw-auth-ldap/" class="post-title-link" itemprop="url">RGW使用外部认证验证</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-24 18:35:24" itemprop="dateCreated datePublished" datetime="2019-09-24T18:35:24+08:00">2019-09-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>RGW支持很多种认证AWS标准的V2、V4；还有开放的LDAP，MFA，keystone，barbican等。太多了就不一一列举了。</p>
<h1 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h1><p>要想使用LDAP认证，首先你的有个LDAP Server。然后将RGW的LDAP开关打开，LDAP相关配置项配置好。重启RGW，你就可以使用LDAP认证了，简单不！</p>
<p>关于LDAP的搭建请见<code>参考&amp;鸣谢</code>中的<code>2</code>和<code>3</code>。</p>
<h2 id="RGW配置"><a href="#RGW配置" class="headerlink" title="RGW配置"></a>RGW配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">rgw_ldap_uri = ldap://10.100.13.111:389</span><br><span class="line">rgw_ldap_binddn = &quot;cn=Manager,dc=my-domain,dc=com&quot;</span><br><span class="line">rgw_ldap_secret = &quot;/etc/ceph/bindpass&quot;</span><br><span class="line">rgw_ldap_searchdn = &quot;dc=my-domain,dc=com&quot;</span><br><span class="line">rgw_ldap_dnattr = &quot;cn&quot;</span><br><span class="line">rgw_s3_auth_use_ldap = true</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>rgw_ldap_binddn<br>  RGW访问LDAP Server使用的账户名</li>
<li>rgw_ldap_secret<br>  访问LDAP Server账户名对应的密码，必须放到文件中，这里指定一个访问文件的路径（明文存储文件就行）</li>
<li>rgw_ldap_searchdn<br>  验证是检索的范围</li>
<li>rgw_ldap_dnattr<br>  构建检索filter的属性名，RGW在程序中会将需要验证的账户名与之组对儿 eg: <code>cn=ldapuser1</code></li>
</ul>
<p>其它别的参数就不用解释了，看不懂可以先测一下智商。</p>
<p><img src="/images/security/LDAP_Server.png" alt="LDAP_Server"></p>
<p>截止目前未知，我都依然没有搞清楚什么事 <code>cn</code>,<code>ou</code>,<code>dn</code>,<code>dc</code>。嗯～～～～一头雾水啊！不管了，LDAP相关的自己问度娘去吧。</p>
<h2 id="验证流程"><a href="#验证流程" class="headerlink" title="验证流程"></a>验证流程</h2><p>Todo…</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ol>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_ceph_storage/2/html/ceph_object_gateway_with_ldapad_guide/index">CEPH OBJECT GATEWAY WITH LDAP&#x2F;AD GUIDE</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linuxidc.com/Linux/2019-05/158733.htm">CentOS 7下安装部署OpenLDAP+phpLDAPadmin</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/37Y37/p/9315945.html">LDAP落地实战（一）：OpenLDAP部署及管理维护</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/09/24/linux/gdb-in-docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/24/linux/gdb-in-docker/" class="post-title-link" itemprop="url">Docker中使用GDB调试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-24 08:47:18" itemprop="dateCreated datePublished" datetime="2019-09-24T08:47:18+08:00">2019-09-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>** 背景 **</p>
<p>容器是一个很老的技术，但这几年却很火热。好多应用都已经容器化了，只要是在用户空间运行的，几乎都可以被容器化。就是放到docker里运行。</p>
<p>面对着容器里运行的应用程序它与外界隔离了，这种隔离有优点，也有缺点。今天我们不讲优点，说一说它的一个缺点。。。</p>
<p>如果你是在linux上写C&#x2F;C++的朋友，你肯定会用到gdb这个神一样的调试工具。在当下这么火爆的容器面前，你的APP可能早就被扔到容器里了。</p>
<p>有一天，除了一个问题，需要你用gdb去调试一下，我靠，ns完全是隔离的，根本无法调试，火大了吧，别急！我来帮你～v～</p>
<h1 id="调试方法"><a href="#调试方法" class="headerlink" title="调试方法"></a>调试方法</h1><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>其实gdb调试容器内app也不难，只要做到两点就可以成功调试了。</p>
<ol>
<li>你所使用的镜像里必须得有gdb工具，没有怎么调试啊。要么做镜像的时候将gdb安装进去，要么使你的gdb与被调试app的容器处于同一命名空间。</li>
<li>使用一些工具(nsenter)侵入到容器命名空间后再运行gdb调试。eg: <code>sudo nsenter -t &#123;容器的PID&#125; -m -p gdb -p &#123;容器内被调试app的PID&#125;</code></li>
</ol>
<h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>方法二也需要在被调试的容器上先装有gdb，然后在启动容器的时候通过增加一些特权参数。待需要调试的时候直接登录到容器内就可以调试了。</p>
<ol>
<li>在启动docker容器的时候需要增加<code>--privileged</code>参数</li>
<li>由于gdb调试需要的<code>SYS_PTRACE</code>属性被禁止掉了，所以在启动容器时候需要增加这个属性<code>--cap-add sys_ptrace</code></li>
<li>gdb调试时，需要关闭linux虚拟地址随机化（虚拟地址随机化是为了安全考虑而出现的，gdb调试只是暂时关闭）。关闭有两种方法，一是通过gdb的命令<code>set disable-randomization off</code>关闭。二是通过设置docker的参数<code>--security-opt seccomp=unconfined</code>。</li>
</ol>
<p>有此三步，可保gdb无告警，并正常使用。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1c4476c3d0ee?from=groupmessage">如何在docker中进行gdb调试</a></li>
<li><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/674757">为什么在Docker里使用gdb调试器会报错</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/09/23/storage/ceph/ceph-deploy-indocker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/23/storage/ceph/ceph-deploy-indocker/" class="post-title-link" itemprop="url">Ceph容器部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-23 16:23:53" itemprop="dateCreated datePublished" datetime="2019-09-23T16:23:53+08:00">2019-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>容器化、容器化、容器化。。。都说重要的事情说三遍，那么Ceph部署有必要容器化吗？</p>
<p>有必要，非常有必要。容器化以后，不仅不会损失性能，而且对以后更新、回退都很方便。而且一个物理机（或虚拟机）上可以跑多个Ceph集群。对于一个开发人员，修改调试都实在是太方便了～～～～～！</p>
<p>闲言碎语不要讲，先拉个集群起来看看吧。</p>
<h1 id="mimic"><a href="#mimic" class="headerlink" title="mimic"></a>mimic</h1><h2 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h2><p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/ceph/daemon"><code>ceph/daemon:latest-mimic</code></a></p>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>使用docker bridge网络，每个容器指定静态IP。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet 192.168.44.0/24 cephnet</span><br></pre></td></tr></table></figure>

<h2 id="拉起Ceph集群"><a href="#拉起Ceph集群" class="headerlink" title="拉起Ceph集群"></a>拉起Ceph集群</h2><h3 id="MON"><a href="#MON" class="headerlink" title="MON"></a>MON</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net cephnet --ip 192.168.44.11 -v /Users/zhoub/temp/etc_ceph/:/etc/ceph -v /Users/zhoub/temp/var_lib_ceph/:/var/lib/ceph -e MON_IP=192.168.44.11 -e CEPH_PUBLIC_NETWORK=192.168.44.0/24 --name mon --hostname mon  ceph/daemon:latest-mimic mon</span><br></pre></td></tr></table></figure>

<h3 id="MGR"><a href="#MGR" class="headerlink" title="MGR"></a>MGR</h3><p>MGR节点很重要，如果没有MGR节点，你就看不到OSD的使用量了。现在的MON真是翻身农奴把歌唱啊，一心只做心跳了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net cephnet --ip 192.168.44.12 -v /Users/zhoub/temp/etc_ceph/:/etc/ceph -v /Users/zhoub/temp/var_lib_ceph/:/var/lib/ceph --name mgr --hostname mgr ceph/daemon:latest-mimic mgr</span><br></pre></td></tr></table></figure>

<h3 id="OSD"><a href="#OSD" class="headerlink" title="OSD"></a>OSD</h3><p>OSD有两种部署方式，一种是将硬盘部署；另一种是目录部署。由于本人使用mac版本docker，所以在映射硬盘过程不太方便，所以使用目录部署。后面会给出硬盘部署的方式。</p>
<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net cephnet --ip 192.168.44.13 -v /Users/zhoub/temp/etc_ceph/:/etc/ceph -v /Users/zhoub/temp/var_lib_ceph/:/var/lib/ceph --name osd --hostname osd -e OSD_TYPE=directory ceph/daemon:latest-mimic osd</span><br></pre></td></tr></table></figure>

<p>由于mac上的docker是运行在一个虚拟机中的，目前不太清楚该虚拟机使用的文件系统是什么，所以osd会暴如下错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker logs -f osd</span></span><br><span class="line">2019-09-23 10:59:14  /opt/ceph-container/bin/entrypoint.sh: static: does not generate config</span><br><span class="line">2019-09-23 10:59:14  /opt/ceph-container/bin/entrypoint.sh: Creating osd</span><br><span class="line">2019-09-23 10:59:14  /opt/ceph-container/bin/entrypoint.sh: OSD created with ID: 0</span><br><span class="line">2019-09-23 10:59:14  /opt/ceph-container/bin/entrypoint.sh: created folder /var/lib/ceph/osd/ceph-0/</span><br><span class="line">creating /var/lib/ceph/osd/ceph-0//keyring</span><br><span class="line">added entity osd.0 auth auth(auid = 18446744073709551615 key=AQCCpYhdbE1EGxAAxX2Av3Gzez/5j8sijQg1jQ== with 0 caps)</span><br><span class="line">2019-09-23 10:59:15.014 7f255136fd80 -1 filestore(/var/lib/ceph/osd/ceph-0) WARNING: max attr value size (1024) is smaller than osd_max_object_name_len (2048).  Your backend filesystem appears to not support attrs large enough to handle the configured max rados name size.  You may get unexpected ENAMETOOLONG errors on rados operations or buggy behavior</span><br><span class="line">2019-09-23 10:59:15.084 7f255136fd80 -1 filestore(/var/lib/ceph/osd/ceph-0) mkjournal(1101): error creating journal on /var/lib/ceph/osd/ceph-0//journal: (22) Invalid argument</span><br><span class="line">2019-09-23 10:59:15.084 7f255136fd80 -1 OSD::mkfs: ObjectStore::mkfs failed with error (22) Invalid argument</span><br><span class="line">2019-09-23 10:59:15.084 7f255136fd80 -1  ** ERROR: error creating empty object store in /var/lib/ceph/osd/ceph-0: (22) Invalid argument</span><br></pre></td></tr></table></figure>

<h4 id="硬盘"><a href="#硬盘" class="headerlink" title="硬盘"></a>硬盘</h4><p>在硬盘部署以前，需要先对硬盘进行格式化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --privileged=true --rm -v /dev/:/dev/ -e OSD_DEVICE=/dev/sdb ceph/daemon:latest-mimic zap_device</span><br></pre></td></tr></table></figure>

<p>格式化后再启动容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net cephnet --ip 192.168.44.13 --hostname osd --name=osd --privileged  -v /Users/zhoub/temp/etc_ceph/:/etc/ceph -v /Users/zhoub/temp/var_lib_ceph/:/var/lib/ceph -v /dev/:/dev/ -e OSD_DEVICE=/dev/sdb ceph/daemon:latest-mimic osd</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>集群除OSD服务外其它服务均可以正常容器化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@mon /]# ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     61a4f9d8-fdc7-4883-8b71-7f93c2017f86</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"></span><br><span class="line">  services:</span><br><span class="line">    mon: 1 daemons, quorum mon</span><br><span class="line">    mgr: mgr(active)</span><br><span class="line">    osd: 1 osds: 0 up, 0 in</span><br><span class="line"></span><br><span class="line">  data:</span><br><span class="line">    pools:   0 pools, 0 pgs</span><br><span class="line">    objects: 0  objects, 0 B</span><br><span class="line">    usage:   0 B used, 0 B / 0 B avail</span><br><span class="line">    pgs:</span><br></pre></td></tr></table></figure>
<p>OSD目录部署不能正常提供服务主要是因为宿主机的文件系统类型未知，若宿主机可正常登录操作，此问题可解；<br>OSD硬盘部署不能正常提供服务主要是因为宿主机不能增加硬盘设备，若宿主机可以添加硬盘，此问题可解。</p>
<p>综上所述，问题根本在于对宿主机的操作了解不够清晰。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ff3be28a1015">使用Docker快速部署Ceph集群</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/ceph/daemon">ceph&#x2F;daemon</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/09/20/linux/linux-env-variable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/20/linux/linux-env-variable/" class="post-title-link" itemprop="url">Linux环境变量</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-20 14:08:09" itemprop="dateCreated datePublished" datetime="2019-09-20T14:08:09+08:00">2019-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>说起环境变量，可能首先想到的是shell中敲入<code>env</code>所看到的这些。没错，这些的确是环境变量。</p>
<p>还有吗。。。<br>有！你再试试<code>set</code>命令，看看是不是比<code>env</code>的多啊。是不是有点儿小懵逼。怎么还不一样呢！<code>set</code>看到的是shell变量，那shell变量是环境变量吗？是。</p>
<p>还有吗。。。<br>有！在你输入<code>set</code>的时候你看到<code>$@</code>、<code>$?</code>这些了吗？貌似没有吧。据说这些属于系统变量。(听说而已。。。)</p>
<p>还有吗。。。<br>目前为止，我只知道这么多，如果我了解到更多的再补充吧。</p>
<p>说了这么多，上一张图，就一目了然了。</p>
<p><img src="/images/linux/linux_env_variable.jpg" alt="linux_env_variable"></p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/fec33aed017b">Linux:环境变量 - set、env、export</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/09/11/storage/ceph/rgw-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/11/storage/ceph/rgw-cluster/" class="post-title-link" itemprop="url">RGW Cluster</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-11 15:15:22" itemprop="dateCreated datePublished" datetime="2019-09-11T15:15:22+08:00">2019-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>RGW &#x3D;&#x3D; Rados Gateway 中文名字叫对象存储网关。</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><ul>
<li>一个RGW能承载的访问量是有限的，若出现故障或性能瓶颈怎么办？若是部署成多个，业务低谷时造成资源浪费</li>
<li>一个集群与单节点有何区别，若整个集群崩溃宕机是小，丢数据为大</li>
<li>客户端的访问协议千奇百怪若只支持S3不足以服众</li>
<li>单纯的V2认证安全性差</li>
<li>客户端压缩、加密数据代价太大，而且难以实现</li>
<li>所有用户、bucket在一个命名空间内安全性太差</li>
</ul>
<p>为解决上述问题，提出如下方案</p>
<h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><p><img src="/images/ceph/RGWCluster.png" alt="rgwcluster.png"></p>
<ul>
<li>管理控制I&#x2F;O与数据读写I&#x2F;O分开处理<br>  管理控制I&#x2F;O负责设置获取RGW集群信息；<br>  数据读写I&#x2F;O负责上传下载对象或上传下载文件。</li>
<li>不同Ceph集群之间互为主备关系<br>  主集群采用副本集数据保护机制;<br>  备份集群采用EraseCode数据保护机制。</li>
<li>RGW实例由K8s对外发布并提供服务<br>  利用K8s的Autoscaling可以根据负载情况动态调整RGW实例数量；<br>  利用K8s的分布式LB可以有效的分散RGW上访问压力。</li>
</ul>
<h2 id="涉及到的模块"><a href="#涉及到的模块" class="headerlink" title="涉及到的模块"></a>涉及到的模块</h2><ul>
<li>RGW Cluster Manager</li>
<li>S3 API</li>
<li>NFS</li>
<li>Admin API</li>
<li>RGW</li>
</ul>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><h2 id="资源管理功能"><a href="#资源管理功能" class="headerlink" title="资源管理功能"></a>资源管理功能</h2><h3 id="存储资源管理"><a href="#存储资源管理" class="headerlink" title="存储资源管理"></a>存储资源管理</h3><ul>
<li>存储资源分配<br>  按容量(初始容量)优先分配<br>  按性能优先分配</li>
<li>存储资源回收</li>
<li>存储资源使用情况查询<br>  可以为计费模块统计提供资源使用情况</li>
</ul>
<h3 id="用户及权限管理"><a href="#用户及权限管理" class="headerlink" title="用户及权限管理"></a>用户及权限管理</h3><ul>
<li>用户管理<br>  用户的增加、删除、属性修改</li>
<li>用户权限管理<br>  用户权限的授权、回收</li>
</ul>
<h3 id="配额管理"><a href="#配额管理" class="headerlink" title="配额管理"></a>配额管理</h3><ul>
<li>user 配额设置<br>  针对用户名下的对象数量、可使用容量(byte)进行配额设置</li>
<li>bucket 配额设置<br>  针对bucket下的对象数量、可使用容量(byte)进行配额设置</li>
</ul>
<h3 id="RGW节点网络控制管理"><a href="#RGW节点网络控制管理" class="headerlink" title="RGW节点网络控制管理"></a>RGW节点网络控制管理</h3><ul>
<li>访问RGW节点客户端黑、白名单机制</li>
<li>RGW节点接收请求的流量配额管理</li>
<li>RGW节点读写Ceph集群的流量配额管理</li>
</ul>
<h3 id="数据压缩、加密"><a href="#数据压缩、加密" class="headerlink" title="数据压缩、加密"></a>数据压缩、加密</h3><ul>
<li>RGW节点接收数据后在Server端完成对数据的压缩，压缩算法需要由用户或运维人员指定</li>
<li>RGW节点接收数据后在Server端完成对数据的加密，加密使用的密钥可人为指定</li>
</ul>
<h3 id="多种认证支持"><a href="#多种认证支持" class="headerlink" title="多种认证支持"></a>多种认证支持</h3><ul>
<li>MFA(Multi-Factor Authentication)认证</li>
<li>keystone认证</li>
<li>LDAP认证</li>
<li>V4认证</li>
</ul>
<h3 id="多租户管理"><a href="#多租户管理" class="headerlink" title="多租户管理"></a>多租户管理</h3><p>对多租户的支持可以允许不同的租户使用相同的用户名、bucket名。更友好的隔离数据，防止对用户和bucket的嗅探。</p>
<h2 id="接口功能"><a href="#接口功能" class="headerlink" title="接口功能"></a>接口功能</h2><p>支持Compatible-S3、Swift、NFS等多种接口。</p>
<h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p>支持将S3接口导出为NFS接口，方便符合POSIX标准的请求使用。</p>
<h2 id="故障切换"><a href="#故障切换" class="headerlink" title="故障切换"></a>故障切换</h2><h3 id="RGW故障"><a href="#RGW故障" class="headerlink" title="RGW故障"></a>RGW故障</h3><p>由于RGW采用分布式部署方式，单个RGW的故障不影响整体使用。RGW由K8s发布提供服务，即使出现性能不足或多点故障，也都由K8s调度恢复。</p>
<h3 id="Ceph集群故障"><a href="#Ceph集群故障" class="headerlink" title="Ceph集群故障"></a>Ceph集群故障</h3><p>由于集群之间采用主备方式存储数据，即使主集群停止服务，也可通过备集群继续提供服务。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/08/20/storage/ceph/changcun-ceph-deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/20/storage/ceph/changcun-ceph-deployment/" class="post-title-link" itemprop="url">Ceph环境部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-20 09:21:47" itemprop="dateCreated datePublished" datetime="2019-08-20T09:21:47+08:00">2019-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><h2 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a>硬件环境</h2><ul>
<li>CPU</li>
<li>内存</li>
<li>硬盘<br>  SAS 300G x 2<br>  SATA 6T x 4<br>  SSD 480G x 6</li>
</ul>
<h2 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h2><ul>
<li>操作系统<br>  Centos 7.6.1810</li>
<li>Ceph软件版本<br>  14.2.2</li>
</ul>
<h1 id="部署方案"><a href="#部署方案" class="headerlink" title="部署方案"></a>部署方案</h1><p><img src="/images/ceph/changcun_ceph_solution.png" alt="changcun_ceph_solution.png"></p>
<h3 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h3><p>两个SAS盘（300G）做成RAID1，用于存储操作系统。</p>
<h3 id="SATA-Pool"><a href="#SATA-Pool" class="headerlink" title="SATA Pool"></a>SATA Pool</h3><ul>
<li>OSD Data<br>  每个SATA（6T）做成RAID0，用于存储每个OSD数据</li>
<li>OSD Journal<br>  两个SSD（480G）做成RAID1，再分成4个分区给每台主机中的4个OSD提供Journal数据存储服务</li>
<li>ObjectStore<br>  OSD后端存储引擎使用Filestore</li>
<li>Replication<br>  副本数：3<br>  最小允许副本数：1</li>
</ul>
<h3 id="SSD-Pool"><a href="#SSD-Pool" class="headerlink" title="SSD Pool"></a>SSD Pool</h3><ul>
<li>OSD<br>  每个SSD（480G）做成RAID0，用于存储每个OSD的数据</li>
<li>ObjectStore<br>  OSD后端存储引擎使用Bluestore</li>
<li>Replication<br>  副本数：3<br>  最小允许副本数：1</li>
</ul>
<h1 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h1><h2 id="Ceph集群部署"><a href="#Ceph集群部署" class="headerlink" title="Ceph集群部署"></a>Ceph集群部署</h2><p>Ceph集群的节点分为管理节点、MON节点、OSD节点</p>
<table>
<thead>
<tr>
<th align="center">节点</th>
<th align="left">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">MON节点</td>
<td align="left">用于监控集群、为客户端提供ClusterMap等服务</td>
</tr>
<tr>
<td align="center">OSD节点</td>
<td align="left">数据存储节点，用于完成数据的持久化工作</td>
</tr>
<tr>
<td align="center">ADMIN节点</td>
<td align="left">集群维护管理节点，提供管理员权限</td>
</tr>
<tr>
<td align="center">MDS节点</td>
<td align="left">提供Cephfs服务</td>
</tr>
<tr>
<td align="center">RGW节点</td>
<td align="left">提供对象存储服务</td>
</tr>
<tr>
<td align="center">MGR节点</td>
<td align="left">提供监控（zabbix、prometheus等）、dashboard等服务</td>
</tr>
<tr>
<td align="center">iSCSI-GW节点</td>
<td align="left">提供iSCSI Target 服务</td>
</tr>
</tbody></table>
<p>更多Ceph内容，请见<a target="_blank" rel="noopener" href="https://docs.ceph.com/docs/nautilus/">此链接</a></p>
<ul>
<li>需要在部署集群前，做通管理节点与集群节点（包括：MON节点、OSD节点）之间的ssh无密码访问。</li>
<li>将各个节点的hostname和ip地址对应后，写入<code>/etc/hosts</code>文件，并将此文件同步到各个节点上<br>  以ceph13为例：  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ceph13 cluster]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">10.53.2.13      ceph13  ceph13</span><br><span class="line">10.53.2.16      ceph16  ceph16</span><br><span class="line">10.53.2.19      ceph19  ceph19</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Ceph-deploy-安装"><a href="#Ceph-deploy-安装" class="headerlink" title="Ceph-deploy 安装"></a>Ceph-deploy 安装</h3><p>在管理节点上安装Ceph-deploy工具。</p>
<p>安装EPEL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br></pre></td></tr></table></figure>

<p>修改&#x2F;增加ceph.repo，并安装ceph-deploy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ceph-noarch]</span><br><span class="line">name=Ceph noarch packages</span><br><span class="line">baseurl=https://download.ceph.com/rpm-nautilus/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://download.ceph.com/keys/release.asc</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br><span class="line">yum install -y ceph-deploy</span><br></pre></td></tr></table></figure>

<h3 id="Create-the-cluster"><a href="#Create-the-cluster" class="headerlink" title="Create the cluster"></a>Create the cluster</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#123;my-cluster&#125;</span><br><span class="line">cd &#123;my-cluster&#125;</span><br><span class="line">ceph-deploy new &#123;initial-monitor-node(s)&#125;</span><br></pre></td></tr></table></figure>

<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ceph13 ~]# mkdir cluster</span><br><span class="line">[root@ceph13 ~]# cd cluster</span><br><span class="line">[root@ceph13 cluster]# ceph-deploy new ceph13 ceph16 ceph19</span><br></pre></td></tr></table></figure>

<h3 id="修改集群初始化配置"><a href="#修改集群初始化配置" class="headerlink" title="修改集群初始化配置"></a>修改集群初始化配置</h3><p>修改<code>&#123;my-cluster&#125;</code>目录中的<code>ceph.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ceph13 cluster]# ls -al</span><br><span class="line">总用量 600</span><br><span class="line">drwxr-xr-x. 2 root root    244 8月  21 15:51 .</span><br><span class="line">dr-xr-x---. 8 root root   4096 8月  11 16:27 ..</span><br><span class="line">-rw-------. 1 root root    113 8月  10 16:17 ceph.bootstrap-mds.keyring</span><br><span class="line">-rw-------. 1 root root    113 8月  10 16:17 ceph.bootstrap-mgr.keyring</span><br><span class="line">-rw-------. 1 root root    113 8月  10 16:17 ceph.bootstrap-osd.keyring</span><br><span class="line">-rw-------. 1 root root    113 8月  10 16:17 ceph.bootstrap-rgw.keyring</span><br><span class="line">-rw-------. 1 root root    151 8月  10 16:17 ceph.client.admin.keyring</span><br><span class="line">-rw-r--r--. 1 root root    293 8月  10 15:15 ceph.conf</span><br><span class="line">-rw-r--r--. 1 root root 580431 8月  10 17:13 ceph-deploy-ceph.log</span><br><span class="line">-rw-------. 1 root root     73 8月  10 15:12 ceph.mon.keyring</span><br></pre></td></tr></table></figure>

<ul>
<li>配置public、cluster网络</li>
<li>配置osd rebalance</li>
<li>配置scrub和deep-scrub</li>
<li>关闭crushmap 启动更新配置<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line"></span><br><span class="line">public network = &#123;ip-address&#125;/&#123;bits&#125;</span><br><span class="line">cluster network = &#123;ip-address&#125;/&#123;bits&#125;</span><br><span class="line"></span><br><span class="line">osd crush update on start = false</span><br><span class="line"></span><br><span class="line">[osd]</span><br><span class="line">osd max backfills = 1</span><br><span class="line">osd recovery op priority = 1</span><br><span class="line">osd recovery max active = 1</span><br><span class="line">osd client op priority = 63</span><br><span class="line">osd recovery delay start = 0.5</span><br><span class="line"></span><br><span class="line">osd scrub chunk min = 1</span><br><span class="line">osd scrub chunk max = 5</span><br><span class="line">osd scrub sleep = 5</span><br><span class="line">osd deep scrub interval = 2592000 # 60(秒)*60(分)*24(时)*30(天)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ceph13 cluster]# cat /etc/ceph/ceph.conf </span><br><span class="line">[global]</span><br><span class="line">fsid = 20192dd5-3228-4135-9831-c9d7de74a890</span><br><span class="line">mon_initial_members = ceph13, ceph16, ceph19</span><br><span class="line">mon_host = 10.53.2.13,10.53.2.16,10.53.2.19</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line">osd crush update on start = false</span><br><span class="line"></span><br><span class="line">public network = 10.53.2.0/24</span><br><span class="line">cluster network = 10.53.1.0/24</span><br><span class="line"></span><br><span class="line">[osd]</span><br><span class="line">osd max backfills = 1</span><br><span class="line">osd recovery op priority = 1</span><br><span class="line">osd recovery max active = 1</span><br><span class="line">osd client op priority = 63</span><br><span class="line">osd recovery delay start = 0.5</span><br><span class="line"></span><br><span class="line">osd scrub chunk min = 1</span><br><span class="line">osd scrub chunk max = 5</span><br><span class="line">osd scrub sleep = 5</span><br><span class="line">osd deep scrub interval = 2592000</span><br></pre></td></tr></table></figure>

<h3 id="ceph软件安装"><a href="#ceph软件安装" class="headerlink" title="ceph软件安装"></a>ceph软件安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install --stable nautilus &#123;ceph-node(s)&#125;</span><br></pre></td></tr></table></figure>

<p>eg: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install --stable nautilus ceph13 ceph16 ceph19</span><br></pre></td></tr></table></figure>

<p>*** 此处安装过程比较慢，失败的话建议重试几次。***</p>
<h3 id="MON节点创建初始化"><a href="#MON节点创建初始化" class="headerlink" title="MON节点创建初始化"></a>MON节点创建初始化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mon create-initial</span><br></pre></td></tr></table></figure>
<p>此命令会根据<code>ceph.conf</code>进行MON节点的创建及初始化工作</p>
<h3 id="部署管理节点"><a href="#部署管理节点" class="headerlink" title="部署管理节点"></a>部署管理节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy admin &#123;ceph-node(s)&#125;</span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy admin ceph13 ceph16 ceph19</span><br></pre></td></tr></table></figure>

<h3 id="部署mgr节点（可选）"><a href="#部署mgr节点（可选）" class="headerlink" title="部署mgr节点（可选）"></a>部署mgr节点（可选）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mgr create &#123;ceph-node(s)&#125;</span><br></pre></td></tr></table></figure>

<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mgr create ceph13 ceph16 ceph19</span><br></pre></td></tr></table></figure>

<p>*** 若不部署mgr服务，集群会有告警，但不影响使用。***</p>
<h3 id="部署OSD节点（Filestore）"><a href="#部署OSD节点（Filestore）" class="headerlink" title="部署OSD节点（Filestore）"></a>部署OSD节点（Filestore）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy osd create --filestore --data &#123;device path&#125; --journal &#123;device path&#125; &#123;ceph-node&#125; </span><br></pre></td></tr></table></figure>

<ul>
<li><code>--filestore</code><br>  指定数据存储引擎</li>
<li><code>--data</code><br>  指定osd数据存储设备(SATA盘)</li>
<li><code>--journal</code><br>  指定osd journal存储设备(SSD Journal盘)</li>
<li><code>ceph-node</code><br>  指定osd所在主机的hostname</li>
</ul>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy osd create ceph13 --filestore --data /dev/sdb --journal /dev/sdf1</span><br><span class="line">ceph-deploy osd create ceph13 --filestore --data /dev/sdb --journal /dev/sdf1</span><br><span class="line">ceph-deploy osd create ceph13 --filestore --data /dev/sdc --journal /dev/sdf2</span><br><span class="line">ceph-deploy osd create ceph13 --filestore --data /dev/sdd --journal /dev/sdf3</span><br><span class="line">ceph-deploy osd create ceph13 --filestore --data /dev/sde --journal /dev/sdf4</span><br><span class="line">ceph-deploy osd create ceph16 --filestore --data /dev/sdb --journal /dev/sdf1</span><br><span class="line">ceph-deploy osd create ceph16 --filestore --data /dev/sdc --journal /dev/sdf2</span><br><span class="line">ceph-deploy osd create ceph16 --filestore --data /dev/sdd --journal /dev/sdf3</span><br><span class="line">ceph-deploy osd create ceph16 --filestore --data /dev/sde --journal /dev/sdf4</span><br><span class="line">ceph-deploy osd create ceph19 --filestore --data /dev/sdb --journal /dev/sdf1</span><br><span class="line">ceph-deploy osd create ceph19 --filestore --data /dev/sdc --journal /dev/sdf2</span><br><span class="line">ceph-deploy osd create ceph19 --filestore --data /dev/sdd --journal /dev/sdf3</span><br><span class="line">ceph-deploy osd create ceph19 --filestore --data /dev/sde --journal /dev/sdf4</span><br></pre></td></tr></table></figure>

<h3 id="部署OSD节点（Bluestore）"><a href="#部署OSD节点（Bluestore）" class="headerlink" title="部署OSD节点（Bluestore）"></a>部署OSD节点（Bluestore）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy osd create --data &#123;device path&#125; &#123;ceph-node&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--data</code><br>  指定osd数据存储设备(SSD盘)</li>
<li><code>ceph-node</code><br>  指定osd所在主机的hostname</li>
</ul>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy osd create ceph13 --data /dev/sdg</span><br><span class="line">ceph-deploy osd create ceph13 --data /dev/sdh</span><br><span class="line">ceph-deploy osd create ceph13 --data /dev/sdi</span><br><span class="line">ceph-deploy osd create ceph13 --data /dev/sdj</span><br><span class="line">ceph-deploy osd create ceph16 --data /dev/sdg</span><br><span class="line">ceph-deploy osd create ceph16 --data /dev/sdh</span><br><span class="line">ceph-deploy osd create ceph16 --data /dev/sdi</span><br><span class="line">ceph-deploy osd create ceph16 --data /dev/sdj</span><br><span class="line">ceph-deploy osd create ceph19 --data /dev/sdg</span><br><span class="line">ceph-deploy osd create ceph19 --data /dev/sdh</span><br><span class="line">ceph-deploy osd create ceph19 --data /dev/sdi</span><br><span class="line">ceph-deploy osd create ceph19 --data /dev/sdj</span><br></pre></td></tr></table></figure>

<p>部署完所有OSD节点后，此集群部署完成可以通过<code>ceph -s</code>查看集群状态。</p>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@ceph13 cluster]# ceph -s</span><br><span class="line">  cluster:</span><br><span class="line">    id:     20192dd5-3228-4135-9831-c9d7de74a890</span><br><span class="line">    health: HEALTH_OK</span><br><span class="line"></span><br><span class="line">  services:</span><br><span class="line">    mon: 3 daemons, quorum ceph13,ceph16,ceph19 (age 10d)</span><br><span class="line">    mgr: ceph13(active, since 10d), standbys: ceph16, ceph19</span><br><span class="line">    osd: 24 osds: 24 up (since 9d), 24 in (since 10d)</span><br><span class="line"></span><br><span class="line">  data:</span><br><span class="line">    pools:   3 pools, 1536 pgs</span><br><span class="line">    objects: 20.80k objects, 81 GiB</span><br><span class="line">    usage:   244 GiB used, 70 TiB / 71 TiB avail</span><br><span class="line">    pgs:     1536 active+clean</span><br><span class="line"></span><br><span class="line">  io:</span><br><span class="line">    client:   309 KiB/s rd, 145 KiB/s wr, 41 op/s rd, 12 op/s wr</span><br><span class="line"></span><br><span class="line">[root@ceph13 cluster]# ceph osd tree</span><br><span class="line">ID  CLASS WEIGHT   TYPE NAME            STATUS REWEIGHT PRI-AFF </span><br><span class="line">-15        5.21997 root ssd                                     </span><br><span class="line"> -9        1.73999     host ceph13_ssd                          </span><br><span class="line"> 12   ssd  0.43500         osd.12           up  1.00000 1.00000 </span><br><span class="line"> 13   ssd  0.43500         osd.13           up  1.00000 1.00000 </span><br><span class="line"> 14   ssd  0.43500         osd.14           up  1.00000 1.00000 </span><br><span class="line"> 15   ssd  0.43500         osd.15           up  1.00000 1.00000 </span><br><span class="line">-11        1.73999     host ceph16_ssd                          </span><br><span class="line"> 16   ssd  0.43500         osd.16           up  1.00000 1.00000 </span><br><span class="line"> 17   ssd  0.43500         osd.17           up  1.00000 1.00000 </span><br><span class="line"> 18   ssd  0.43500         osd.18           up  1.00000 1.00000 </span><br><span class="line"> 19   ssd  0.43500         osd.19           up  1.00000 1.00000 </span><br><span class="line">-13        1.73999     host ceph19_ssd                          </span><br><span class="line"> 20   ssd  0.43500         osd.20           up  1.00000 1.00000 </span><br><span class="line"> 21   ssd  0.43500         osd.21           up  1.00000 1.00000 </span><br><span class="line"> 22   ssd  0.43500         osd.22           up  1.00000 1.00000 </span><br><span class="line"> 23   ssd  0.43500         osd.23           up  1.00000 1.00000 </span><br><span class="line"> -1       65.41200 root default                                 </span><br><span class="line"> -3       21.80400     host ceph13_sata                         </span><br><span class="line">  0   hdd  5.45099         osd.0            up  1.00000 1.00000 </span><br><span class="line">  1   hdd  5.45099         osd.1            up  1.00000 1.00000 </span><br><span class="line">  2   hdd  5.45099         osd.2            up  1.00000 1.00000 </span><br><span class="line">  3   hdd  5.45099         osd.3            up  1.00000 1.00000 </span><br><span class="line"> -5       21.80400     host ceph16_sata                         </span><br><span class="line">  4   hdd  5.45099         osd.4            up  1.00000 1.00000 </span><br><span class="line">  5   hdd  5.45099         osd.5            up  1.00000 1.00000 </span><br><span class="line">  6   hdd  5.45099         osd.6            up  1.00000 1.00000 </span><br><span class="line">  7   hdd  5.45099         osd.7            up  1.00000 1.00000 </span><br><span class="line"> -7       21.80400     host ceph19_sata                         </span><br><span class="line">  8   hdd  5.45099         osd.8            up  1.00000 1.00000 </span><br><span class="line">  9   hdd  5.45099         osd.9            up  1.00000 1.00000 </span><br><span class="line"> 10   hdd  5.45099         osd.10           up  1.00000 1.00000 </span><br><span class="line"> 11   hdd  5.45099         osd.11           up  1.00000 1.00000 </span><br></pre></td></tr></table></figure>

<h2 id="iscsi-gw部署"><a href="#iscsi-gw部署" class="headerlink" title="iscsi-gw部署"></a>iscsi-gw部署</h2><h3 id="依赖软件安装"><a href="#依赖软件安装" class="headerlink" title="依赖软件安装"></a>依赖软件安装</h3><p>iscsi-gw软件在<code>192.168.1.70</code>的<code>/home/zhoub/rpms</code>目录下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[zhoub@CentOS ceph-iscsi-rpms]$ ls -al</span><br><span class="line">总用量 588</span><br><span class="line">drwxr-xr-x.  9 zhoub zhoub   4096 6月  19 16:31 .</span><br><span class="line">drwxrwxr-x.  3 zhoub zhoub     53 8月   8 13:42 ..</span><br><span class="line">drwxrwxr-x. 10 zhoub zhoub   4096 6月  19 16:10 ceph-iscsi</span><br><span class="line">drwxrwxr-x.  9 zhoub zhoub    213 6月  19 16:10 configshell-fb</span><br><span class="line">-rw-r--r--.  1 root  root  284340 8月  11 2017 libnl3-3.2.28-4.el7.x86_64.rpm</span><br><span class="line">drwxrwxr-x.  2 zhoub zhoub    240 6月  19 15:51 pip</span><br><span class="line">drwxr-xr-x.  2 zhoub zhoub   4096 6月  19 16:10 pip_packages</span><br><span class="line">-rw-r--r--.  1 root  root  137912 11月 12 2018 pyOpenSSL-0.13.1-4.el7.x86_64.rpm</span><br><span class="line">-rw-r--r--.  1 root  root   96088 7月   4 2014 pyparsing-1.5.6-9.el7.noarch.rpm</span><br><span class="line">-rw-r--r--.  1 root  root   58008 7月   4 2014 python-kmod-0.9-4.el7.x86_64.rpm</span><br><span class="line">-rw-r--r--.  1 zhoub zhoub     76 6月  19 16:10 requirement.txt</span><br><span class="line">drwxrwxr-x. 11 zhoub zhoub    223 6月  19 16:10 rtslib-fb</span><br><span class="line">drwxrwxr-x. 10 zhoub zhoub    248 6月  19 16:10 targetcli-fb</span><br><span class="line">drwxr-xr-x.  2 root  root     112 6月  19 16:28 tcmu-runner</span><br></pre></td></tr></table></figure>

<h4 id="pip安装"><a href="#pip安装" class="headerlink" title="pip安装"></a>pip安装</h4><p>在<code>rpms/ceph-iscsi-rpms/pip</code>目录下。</p>
<p>pip 安装依赖的软件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[zhoub@CentOS pip]$ ls -al</span><br><span class="line">总用量 4080</span><br><span class="line">drwxrwxr-x. 2 zhoub zhoub     240 6月  19 15:51 .</span><br><span class="line">drwxr-xr-x. 9 zhoub zhoub    4096 6月  19 16:31 ..</span><br><span class="line">-rw-rw-r--. 1 zhoub zhoub 3700178 6月  19 15:31 pip_19.1.1.tar.gz</span><br><span class="line">-rw-r--r--. 1 root  root     5932 3月  14 2015 python-backports-1.0-8.el7.x86_64.rpm</span><br><span class="line">-rw-r--r--. 1 root  root    12896 4月  25 2018 python-backports-ssl_match_hostname-3.5.0.1-1.el7.noarch.rpm</span><br><span class="line">-rw-r--r--. 1 root  root    35176 11月 21 2016 python-ipaddress-1.0.16-2.el7.noarch.rpm</span><br><span class="line">-rw-r--r--. 1 root  root   406404 8月  11 2017 python-setuptools-0.9.8-7.el7.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>安装pip及其依赖的软件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd pip</span><br><span class="line">yum localinstall *.rpm</span><br><span class="line">tar -xzvf ./pip_19.1.1.tar.gz</span><br><span class="line">cd pip_19.1.1</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<h4 id="安装pip-package"><a href="#安装pip-package" class="headerlink" title="安装pip package"></a>安装pip package</h4><p>在线安装使用<code>rpms/ceph-iscsi-rpms/requirement.txt</code>文件进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[zhoub@CentOS ceph-iscsi-rpms]$  cat requirement.txt</span><br><span class="line"><span class="meta prompt_">pyudev&gt;</span><span class="language-bash">=0.16.1</span></span><br><span class="line">Flask</span><br><span class="line">requests</span><br><span class="line">crypto</span><br><span class="line">netifaces</span><br><span class="line">urwid</span><br><span class="line">pyparsing</span><br><span class="line">cryptography</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r ./requirement.txt</span><br></pre></td></tr></table></figure>

<p>离线安装包在<code>rpms/ceph-iscsi-rpms/pip_packages</code>中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[zhoub@CentOS pip_packages]$ ls -al</span><br><span class="line">总用量 5828</span><br><span class="line">drwxr-xr-x. 2 zhoub zhoub    4096 6月  19 16:10 .</span><br><span class="line">drwxr-xr-x. 9 zhoub zhoub    4096 6月  19 16:31 ..</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  101571 6月  19 16:10 asn1crypto-0.24.0-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  157119 6月  19 16:10 certifi-2019.6.16-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  415091 6月  19 16:10 cffi-1.12.3-cp27-cp27mu-manylinux1_x86_64.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  133356 6月  19 16:10 chardet-3.0.4-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   81299 6月  19 16:10 Click-7.0-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   18019 6月  19 16:10 crypto-1.4.1-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub 2288455 6月  19 16:10 cryptography-2.7-cp27-cp27mu-manylinux1_x86_64.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   12427 6月  19 16:10 enum34-1.1.6-py2-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   92053 6月  19 16:10 Flask-1.0.3-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   58594 6月  19 16:10 idna-2.8-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   18155 6月  19 16:10 ipaddress-1.0.22-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   16743 6月  19 16:10 itsdangerous-1.1.0-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  124883 6月  19 16:10 Jinja2-2.10.1-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   24348 6月  19 16:10 MarkupSafe-1.1.1-cp27-cp27mu-manylinux1_x86_64.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  590559 6月  19 16:10 Naked-0.1.31-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   31249 6月  19 16:10 netifaces-0.10.9-cp27-cp27mu-manylinux1_x86_64.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  158295 6月  19 16:10 pycparser-2.19.tar.gz</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   62288 6月  19 16:10 pyparsing-2.4.0-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   89469 6月  19 16:10 pyudev-0.21.0.tar.gz</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  274442 6月  19 16:10 PyYAML-5.1.1.tar.gz</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   57952 6月  19 16:10 requests-2.22.0-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub    4933 6月  19 16:10 shellescape-3.4.1-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub   10586 6月  19 16:10 six-1.12.0-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  150942 6月  19 16:10 urllib3-1.25.3-py2.py3-none-any.whl</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  604167 6月  19 16:10 urwid-2.0.1.tar.gz</span><br><span class="line">-rw-r--r--. 1 zhoub zhoub  327611 6月  19 16:10 Werkzeug-0.15.4-py2.py3-none-any.whl</span><br></pre></td></tr></table></figure>

<h4 id="安装依赖rpms"><a href="#安装依赖rpms" class="headerlink" title="安装依赖rpms"></a>安装依赖rpms</h4><p>rpm包在<code>rpms/ceph-iscsi-rpms/</code>目录下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall libnl3-3.2.28-4.el7.x86_64.rpm</span><br><span class="line">yum localinstall pyOpenSSL-0.13.1-4.el7.x86_64.rpm</span><br><span class="line">yum localinstall pyparsing-1.5.6-9.el7.noarch.rpm</span><br><span class="line">yum localinstall python-kmod-0.9-4.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<h4 id="安装TCMU-RUNNER"><a href="#安装TCMU-RUNNER" class="headerlink" title="安装TCMU-RUNNER"></a>安装TCMU-RUNNER</h4><p>rpm包在<code>rpms/ceph-iscsi-rpms/tcmu-runner</code>目录下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd tcmu-runner</span><br><span class="line">yum localinstall *.rpm</span><br></pre></td></tr></table></figure>

<p>启动<code>tcmu-runner</code>服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable tcmu-runner</span><br><span class="line">systemctl start tcmu-runner</span><br></pre></td></tr></table></figure>

<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/open-iscsi/tcmu-runner">https://github.com/open-iscsi/tcmu-runner</a><br>commit：8d8e612e50b7787c57f32f59bba7def9bb06954b</p>
<h4 id="安装RTSLIB-FB"><a href="#安装RTSLIB-FB" class="headerlink" title="安装RTSLIB-FB"></a>安装RTSLIB-FB</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd rtslib-fb</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/open-iscsi/rtslib-fb">https://github.com/open-iscsi/rtslib-fb</a><br>commit: 03d6c7813187cd141a3a08f4b7978190187d56c1</p>
<h4 id="安装CONFIGSHELL-FB"><a href="#安装CONFIGSHELL-FB" class="headerlink" title="安装CONFIGSHELL-FB"></a>安装CONFIGSHELL-FB</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd configshell-fb</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/open-iscsi/configshell-fb">https://github.com/open-iscsi/configshell-fb</a><br>commit: 166ba97e36d7b53e7fa53d7853a8b9f5a509503c</p>
<h4 id="安装TARGETCLI-FB"><a href="#安装TARGETCLI-FB" class="headerlink" title="安装TARGETCLI-FB"></a>安装TARGETCLI-FB</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd targetcli-fb</span><br><span class="line">python setup.py install</span><br><span class="line">mkdir /etc/target</span><br><span class="line">mkdir /var/target</span><br></pre></td></tr></table></figure>

<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/open-iscsi/targetcli-fb">https://github.com/open-iscsi/targetcli-fb</a><br>commit: 85031ad48b011f5626cd0a287749abcaa145277b</p>
<h4 id="安装CEPH-ISCSI"><a href="#安装CEPH-ISCSI" class="headerlink" title="安装CEPH-ISCSI"></a>安装CEPH-ISCSI</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ceph-iscsi</span><br><span class="line">python setup.py install --install-scripts=/usr/bin</span><br><span class="line">cp ./usr/lib/systemd/system/rbd-target-gw.service /lib/systemd/system/</span><br><span class="line">cp ./usr/lib/systemd/system/rbd-target-api.service /lib/systemd/system/</span><br></pre></td></tr></table></figure>

<p>启动<code>rbd-target-gw</code>和<code>rbd-target-api</code>服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable rbd-target-gw</span><br><span class="line">systemctl enable rbd-target-api</span><br><span class="line">systemctl start rbd-target-gw</span><br><span class="line">systemctl start rbd-target-api</span><br></pre></td></tr></table></figure>

<p>源码地址：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-iscsi">https://github.com/ceph/ceph-iscsi</a><br>commit: c5ebf29e1a0caa2e4bef44370b40fe940b66aaad</p>
<h3 id="配置iscsi-gateway-cfg"><a href="#配置iscsi-gateway-cfg" class="headerlink" title="配置iscsi-gateway.cfg"></a>配置iscsi-gateway.cfg</h3><p>创建一个<code>/etc/ceph/iscsi-gateway.cfg</code>文件，在文件中增加如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[config]</span><br><span class="line"># Name of the Ceph storage cluster. A suitable Ceph configuration file allowing</span><br><span class="line"># access to the Ceph storage cluster from the gateway node is required, if not</span><br><span class="line"># colocated on an OSD node.</span><br><span class="line">cluster_name = ceph</span><br><span class="line"></span><br><span class="line"># Place a copy of the ceph cluster&#x27;s admin keyring in the gateway&#x27;s /etc/ceph</span><br><span class="line"># drectory and reference the filename here</span><br><span class="line">gateway_keyring = ceph.client.admin.keyring</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># API settings.</span><br><span class="line"># The API supports a number of options that allow you to tailor it to your</span><br><span class="line"># local environment. If you want to run the API under https, you will need to</span><br><span class="line"># create cert/key files that are compatible for each iSCSI gateway node, that is</span><br><span class="line"># not locked to a specific node. SSL cert and key files *must* be called</span><br><span class="line"># &#x27;iscsi-gateway.crt&#x27; and &#x27;iscsi-gateway.key&#x27; and placed in the &#x27;/etc/ceph/&#x27; directory</span><br><span class="line"># on *each* gateway node. With the SSL files in place, you can use &#x27;api_secure = true&#x27;</span><br><span class="line"># to switch to https mode.</span><br><span class="line"></span><br><span class="line"># To support the API, the bear minimum settings are:</span><br><span class="line">api_secure = false</span><br><span class="line"></span><br><span class="line"># Additional API configuration options are as follows, defaults shown.</span><br><span class="line"># api_user = admin</span><br><span class="line"># api_password = admin</span><br><span class="line"># api_port = 5001</span><br><span class="line"># iscsi-gw 最少需要部署两个服务</span><br><span class="line">trusted_ip_list = 10.53.2.13,10.53.2.16,10.53.2.19</span><br></pre></td></tr></table></figure>

<p>重启<code>rbd-target-api</code>服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl stop rbd-target-api</span><br><span class="line">systemctl start rbd-target-api</span><br></pre></td></tr></table></figure>

<p>*** rbd-target-api 需要依赖 rbd pool，若集群中没有rbd pool ，需要手动创建。 ***</p>
<h3 id="配置iscsi-target"><a href="#配置iscsi-target" class="headerlink" title="配置iscsi-target"></a>配置iscsi-target</h3><p>在iscsi-gw服务所在节点上输入<code>gwcli</code>进入gw交互模式</p>
<h4 id="创建target-iqn"><a href="#创建target-iqn" class="headerlink" title="创建target iqn"></a>创建target iqn</h4><p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">cd</span> /iscsi-target</span></span><br><span class="line"><span class="meta prompt_">/iscsi-target&gt; </span><span class="language-bash">create iqn.2019-08.com.hna.iscsi-gw:iscsi-igw</span></span><br></pre></td></tr></table></figure>

<h4 id="创建iscsi-gateway"><a href="#创建iscsi-gateway" class="headerlink" title="创建iscsi-gateway"></a>创建iscsi-gateway</h4><p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/iscsi-target&gt; </span><span class="language-bash"><span class="built_in">cd</span> iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/gateways</span></span><br><span class="line">/iscsi-target...-igw/gateways&gt;  create ceph13 10.53.2.13</span><br><span class="line">/iscsi-target...-igw/gateways&gt;  create ceph16 10.53.2.16</span><br><span class="line">/iscsi-target...-igw/gateways&gt;  create ceph19 10.53.2.19</span><br></pre></td></tr></table></figure>
<p>创建gateway时，输入的gateway名称为hostname, ip要与其对应上，并且在<code>/etc/hosts</code>文件中也要将<code>hostname</code>和<code>ip</code>对应上。</p>
<h4 id="创建rbd-image"><a href="#创建rbd-image" class="headerlink" title="创建rbd image"></a>创建rbd image</h4><p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/iscsi-target...-igw/gateways&gt; cd /disks</span><br><span class="line"><span class="meta prompt_">/disks&gt; </span><span class="language-bash">create pool=sata image=vol_sata_23t size=23T</span></span><br><span class="line"><span class="meta prompt_">/disks&gt; </span><span class="language-bash">create pool=ssd image=vol_ssd_1800g size=1800G</span></span><br></pre></td></tr></table></figure>

<h4 id="创建client-iqn"><a href="#创建client-iqn" class="headerlink" title="创建client iqn"></a>创建client iqn</h4><p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/disks&gt; </span><span class="language-bash"><span class="built_in">cd</span> /iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/hosts/</span></span><br><span class="line">/iscsi-target...csi-igw/hosts&gt;  create iqn.2019-08.com.example:2b14c50a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">/disks&gt; </span><span class="language-bash"><span class="built_in">cd</span> /iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/hosts/</span></span><br><span class="line">/iscsi-target...csi-igw/hosts&gt;  create iqn.2019-08.com.example:479172ae</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">/disks&gt; </span><span class="language-bash"><span class="built_in">cd</span> /iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/hosts/</span></span><br><span class="line">/iscsi-target...csi-igw/hosts&gt;  create iqn.2019-08.com.example:066f5c54</span><br></pre></td></tr></table></figure>

<p>设置chap用户名密码<br>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">cd</span> iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/hosts/iqn.2019-08.com.example:2b14c50a/</span></span><br><span class="line">/iscsi-target...mple:2b14c50a&gt; auth username=iqn.2019-08.com.example password=1qaz2wsx3edc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">cd</span> iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/hosts/iqn.2019-08.com.example:479172ae/</span></span><br><span class="line">/iscsi-target...mple:479172ae&gt; auth username=iqn.2019-08.com.example password=1qaz2wsx3edc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">cd</span> iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/hosts/iqn.2019-08.com.example:066f5c54/</span></span><br><span class="line">/iscsi-target...mple:066f5c54&gt; auth username=iqn.2019-08.com.example password=1qaz2wsx3edc</span><br></pre></td></tr></table></figure>

<h4 id="创建host-groups"><a href="#创建host-groups" class="headerlink" title="创建host-groups"></a>创建host-groups</h4><p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">cd</span> iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/host-groups/</span></span><br><span class="line">/iscsi-target...w/host-groups&gt; create xen</span><br></pre></td></tr></table></figure>

<h4 id="添加client-iqn"><a href="#添加client-iqn" class="headerlink" title="添加client iqn"></a>添加client iqn</h4><p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">cd</span> iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/host-groups/xen/</span></span><br><span class="line">/iscsi-target...st-groups/xen&gt; host add iqn.2019-08.com.example:066f5c54</span><br><span class="line">/iscsi-target...st-groups/xen&gt; host add iqn.2019-08.com.example:2b14c50a</span><br><span class="line">/iscsi-target...st-groups/xen&gt; host add iqn.2019-08.com.example:479172ae</span><br></pre></td></tr></table></figure>

<h4 id="添加rbd-image"><a href="#添加rbd-image" class="headerlink" title="添加rbd image"></a>添加rbd image</h4><p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">cd</span> iscsi-targets/iqn.2019-08.com.hna.iscsi-gw:iscsi-igw/host-groups/xen/</span></span><br><span class="line">/iscsi-target...st-groups/xen&gt; disk add sata/vol_sata_23t</span><br><span class="line">/iscsi-target...st-groups/xen&gt; disk add ssd/vol_ssd_1800g</span><br></pre></td></tr></table></figure>

<p>至此iscsi-gw的搭建及配置完成，客户端可以通过iscsi协议访问ceph存储了。</p>
<p>eg:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">/&gt; </span><span class="language-bash"><span class="built_in">ls</span></span></span><br><span class="line">o- / ......................................................................................................................... [...]</span><br><span class="line">  o- cluster ......................................................................................................... [Clusters: 1]</span><br><span class="line">  | o- ceph ............................................................................................................ [HEALTH_OK]</span><br><span class="line">  |   o- pools .......................................................................................................... [Pools: 3]</span><br><span class="line">  |   | o- rbd ................................................................... [(x3), Commit: 0.00Y/21703946M (0%), Used: 6823b]</span><br><span class="line">  |   | o- sata ......................................................... [(x3), Commit: 23.0T/21703946M (111%), Used: 14325219841b]</span><br><span class="line">  |   | o- ssd ........................................................ [(x3), Commit: 1800G/1744741760K (108%), Used: 27569961653b]</span><br><span class="line">  |   o- topology ............................................................................................... [OSDs: 24,MONs: 3]</span><br><span class="line">  o- disks ...................................................................................................... [25352G, Disks: 2]</span><br><span class="line">  | o- sata ......................................................................................................... [sata (23.0T)]</span><br><span class="line">  | | o- vol_sata_23t .................................................................................. [sata/vol_sata_23t (23.0T)]</span><br><span class="line">  | o- ssd ........................................................................................................... [ssd (1800G)]</span><br><span class="line">  |   o- vol_ssd_1800g ................................................................................. [ssd/vol_ssd_1800g (1800G)]</span><br><span class="line">  o- iscsi-targets ............................................................................... [DiscoveryAuth: None, Targets: 1]</span><br><span class="line">    o- iqn.2019-08.com.hna.iscsi-gw:iscsi-igw ........................................................................ [Gateways: 3]</span><br><span class="line">      o- disks .......................................................................................................... [Disks: 2]</span><br><span class="line">      | o- sata/vol_sata_23t ....................................................................................... [Owner: ceph13]</span><br><span class="line">      | o- ssd/vol_ssd_1800g ....................................................................................... [Owner: ceph19]</span><br><span class="line">      o- gateways ............................................................................................ [Up: 3/3, Portals: 3]</span><br><span class="line">      | o- ceph13 ................................................................................................ [10.53.2.13 (UP)]</span><br><span class="line">      | o- ceph16 ................................................................................................ [10.53.2.16 (UP)]</span><br><span class="line">      | o- ceph19 ................................................................................................ [10.53.2.19 (UP)]</span><br><span class="line">      o- host-groups .................................................................................................. [Groups : 1]</span><br><span class="line">      | o- xen ................................................................................................ [Hosts: 3, Disks: 2]</span><br><span class="line">      |   o- iqn.2019-08.com.example:066f5c54 ............................................................................... [host]</span><br><span class="line">      |   o- iqn.2019-08.com.example:2b14c50a ............................................................................... [host]</span><br><span class="line">      |   o- iqn.2019-08.com.example:479172ae ............................................................................... [host]</span><br><span class="line">      |   o- sata/vol_sata_23t .............................................................................................. [disk]</span><br><span class="line">      |   o- ssd/vol_ssd_1800g .............................................................................................. [disk]</span><br><span class="line">      o- hosts .............................................................................................. [Hosts: 3: Auth: CHAP]</span><br><span class="line">        o- iqn.2019-08.com.example:2b14c50a .............................................. [LOGGED-IN, Auth: CHAP, Disks: 2(25352G)]</span><br><span class="line">        | o- lun 0 ....................................................................... [sata/vol_sata_23t(23.0T), Owner: ceph13]</span><br><span class="line">        | o- lun 1 ....................................................................... [ssd/vol_ssd_1800g(1800G), Owner: ceph19]</span><br><span class="line">        o- iqn.2019-08.com.example:479172ae .............................................. [LOGGED-IN, Auth: CHAP, Disks: 2(25352G)]</span><br><span class="line">        | o- lun 0 ....................................................................... [sata/vol_sata_23t(23.0T), Owner: ceph13]</span><br><span class="line">        | o- lun 1 ....................................................................... [ssd/vol_ssd_1800g(1800G), Owner: ceph19]</span><br><span class="line">        o- iqn.2019-08.com.example:066f5c54 .............................................. [LOGGED-IN, Auth: CHAP, Disks: 2(25352G)]</span><br><span class="line">          o- lun 0 ....................................................................... [sata/vol_sata_23t(23.0T), Owner: ceph13]</span><br><span class="line">          o- lun 1 ....................................................................... [ssd/vol_ssd_1800g(1800G), Owner: ceph19]</span><br></pre></td></tr></table></figure>

<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/docs/nautilus/start/quick-ceph-deploy/">ceph installation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/docs/nautilus/rbd/iscsi-overview/">LIO iSCSI Gateway</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2019/08/13/storage/ceph/osd-journal-operation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/13/storage/ceph/osd-journal-operation/" class="post-title-link" itemprop="url">OSD Journal 运维操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-13 16:55:35" itemprop="dateCreated datePublished" datetime="2019-08-13T16:55:35+08:00">2019-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="部署创建"><a href="#部署创建" class="headerlink" title="部署创建"></a>部署创建</h1><p>可以使用<code>ceph-osd</code>命令单独创建初始化OSD日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-osd -i &#123;osd-id&#125; --mkjournal</span><br></pre></td></tr></table></figure>
<p>默认在<code>/var/lib/ceph/osd/ceph-&#123;osd.id&#125;</code>目录下的<code>journal</code>文件中初始化日志数据；也可以通过<code>-c</code>制定配置文件<code>ceph.conf</code>，再在配置文件中制定OSD日志所在路径。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h3 id="osd-journal"><a href="#osd-journal" class="headerlink" title="osd journal"></a>osd journal</h3><p>journal所在的位置，默认为<code>/var/lib/ceph/osd/&#123;cluster&#125;-&#123;osd.id&#125;/jouranl</code>。可以是一个文件也可以是一个块设备。</p>
<h3 id="osd-jouranl-size"><a href="#osd-jouranl-size" class="headerlink" title="osd jouranl size"></a>osd jouranl size</h3><p>日志的大小，不同版本其默认值也不一样。通常根据OSD盘的性能来设置其大小。<br><code>osd journal size = 2 * 写入带宽 * filestore max sync interval</code> 写入带宽一般是固定的，所以可以根据<code>filestore max sync interval</code>来计算journal的大小。或者根据journal大小来设置<code>filestore max sync interval</code>。</p>
<h1 id="更换迁移"><a href="#更换迁移" class="headerlink" title="更换迁移"></a>更换迁移</h1><p>更换Journal盘有2种情况</p>
<h3 id="Journal盘挂了"><a href="#Journal盘挂了" class="headerlink" title="Journal盘挂了"></a>Journal盘挂了</h3><p>只能删除对应的OSD重新创建</p>
<h3 id="Journal还在运行"><a href="#Journal还在运行" class="headerlink" title="Journal还在运行"></a>Journal还在运行</h3><ol>
<li>设置<code>noout</code>标记</li>
<li>停止关联的OSD</li>
<li>下刷 journal 到 osd <code>ceph-osd -i &#123;osd.io&#125; --flush-journal</code></li>
<li>删除旧的 journal 链接</li>
<li>重建journal 链接</li>
<li>重建 journal <code>ceph-osd -i &#123;osd.id&#125; --mkjournal</code></li>
<li>启动关联的OSD</li>
<li>去除<code>noout</code>标记</li>
</ol>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/ceph-handbook/Advance_usage-change_osd_journal.md">更换OSD Journal</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">博</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">138</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">119</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
