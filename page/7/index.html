<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/page/7/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="博">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/page/7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/10/19/bigdata/hadoop/Phoenix-index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/19/bigdata/hadoop/Phoenix-index/" class="post-title-link" itemprop="url">Phoenix 二级索引</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-10-19 14:10:36" itemprop="dateCreated datePublished" datetime="2017-10-19T14:10:36+08:00">2017-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Big-Data/" itemprop="url" rel="index"><span itemprop="name">Big-Data</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在Hbase中，只有一个单一的按照字典序排序的rowKey索引，当使用rowKey来进行数据查询的时候速度较快，但是如果不使用rowKey来查询的话就会使用filter来对全表进行扫描，很大程度上降低了检索性能。而Phoenix提供了二级索引技术来应对这种使用rowKey之外的条件进行检索的场景。</p>
<h1 id="Global-Index"><a href="#Global-Index" class="headerlink" title="Global Index"></a>Global Index</h1><p>Global indexing适用于多读少写的业务场景。使用Global indexing的话在写数据的时候会消耗大量开销，因为所有对数据表的更新操作（DELETE, UPSERT VALUES and UPSERT SELECT）,会引起索引表的更新，而索引表是分布在不同的数据节点上的，跨节点的数据传输带来了较大的性能消耗。在读数据的时候Phoenix会选择索引表来降低查询消耗的时间。*** 在默认情况下如果想查询的字段不是索引字段的话索引表不会被使用，也就是说不会带来查询速度的提升。 ***</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>HBase集群的每个regionserver节点的hbase-site.xml中加入配置，并重启HBase集群</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.regionserver.wal.codec<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hbase.regionserver.wal.IndexedWALEditCodec<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注: phoenix有两种链接方式JDBC和phoenix-client，phoenix-client可以正常创建索引；zeppelin使用jdbc连接不能正常创建索引，提示如下错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">java.sql.SQLException: ERROR 1029 (42Y88): Mutable secondary indexes must have the hbase.regionserver.wal.codec property set to org.apache.hadoop.hbase.regionserver.wal.IndexedWALEditCodec in the hbase-sites.xml of every region server. tableName=CMP_IDX</span><br><span class="line">    at org.apache.phoenix.exception.SQLExceptionCode$Factory$1.newException(SQLExceptionCode.java:464)</span><br><span class="line">    at org.apache.phoenix.exception.SQLExceptionInfo.buildException(SQLExceptionInfo.java:150)</span><br><span class="line">    at org.apache.phoenix.schema.MetaDataClient.createIndex(MetaDataClient.java:1293)</span><br><span class="line">    at org.apache.phoenix.compile.CreateIndexCompiler$1.execute(CreateIndexCompiler.java:85)</span><br><span class="line">    at org.apache.phoenix.jdbc.PhoenixStatement$2.call(PhoenixStatement.java:358)</span><br><span class="line">    at org.apache.phoenix.jdbc.PhoenixStatement$2.call(PhoenixStatement.java:341)</span><br><span class="line">    at org.apache.phoenix.call.CallRunner.run(CallRunner.java:53)</span><br><span class="line">    at org.apache.phoenix.jdbc.PhoenixStatement.executeMutation(PhoenixStatement.java:340)</span><br><span class="line">    at org.apache.phoenix.jdbc.PhoenixStatement.execute(PhoenixStatement.java:1511)</span><br><span class="line">    at org.apache.commons.dbcp2.DelegatingStatement.execute(DelegatingStatement.java:291)</span><br><span class="line">    at org.apache.commons.dbcp2.DelegatingStatement.execute(DelegatingStatement.java:291)</span><br><span class="line">    at org.apache.zeppelin.jdbc.JDBCInterpreter.executeSql(JDBCInterpreter.java:581)</span><br><span class="line">    at org.apache.zeppelin.jdbc.JDBCInterpreter.interpret(JDBCInterpreter.java:692)</span><br><span class="line">    at org.apache.zeppelin.interpreter.LazyOpenInterpreter.interpret(LazyOpenInterpreter.java:97)</span><br><span class="line">    at org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer$InterpretJob.jobRun(RemoteInterpreterServer.java:498)</span><br><span class="line">    at org.apache.zeppelin.scheduler.Job.run(Job.java:175)</span><br><span class="line">    at org.apache.zeppelin.scheduler.ParallelScheduler$JobRunner.run(ParallelScheduler.java:162)</span><br><span class="line">    at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source)</span><br><span class="line">    at java.util.concurrent.FutureTask.run(Unknown Source)</span><br><span class="line">    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(Unknown Source)</span><br><span class="line">    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(Unknown Source)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)</span><br><span class="line">    at java.lang.Thread.run(Unknown Source)</span><br></pre></td></tr></table></figure>

<h2 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h2><p>在开始创建索引以前先创建一个表，并向其中填充测试数据（此处填充的数据仅用于功能测试）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> usertable (id <span class="type">varchar</span> <span class="keyword">primary</span> key,firstname <span class="type">varchar</span>, lastname <span class="type">varchar</span>);</span><br><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> <span class="operator">!</span>tables</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------------------+---------------+----------+------------+----------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> TABLE_CAT  <span class="operator">|</span> TABLE_SCHEM  <span class="operator">|</span>       TABLE_NAME        <span class="operator">|</span>  TABLE_TYPE   <span class="operator">|</span> REMARKS  <span class="operator">|</span> TYPE_NAME  <span class="operator">|</span> SELF_REFERENCING_COL_NAME  <span class="operator">|</span> REF_GENERAT <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------------------+---------------+----------+------------+----------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> CATALOG                 <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> <span class="keyword">FUNCTION</span>                <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> SEQUENCE                <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> STATS                   <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span>              <span class="operator">|</span> USERTABLE               <span class="operator">|</span> <span class="keyword">TABLE</span>         <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------------------+---------------+----------+------------+----------------------------+-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> upsert <span class="keyword">into</span> usertable(id, firstname, lastname) <span class="keyword">values</span>(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>);</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> upsert <span class="keyword">into</span> usertable(id, firstname, lastname) <span class="keyword">values</span>(<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;phoenix&#x27;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">base(main):019:0&gt; scan &#x27;USERTABLE&#x27;</span><br><span class="line">ROW                                 COLUMN+CELL</span><br><span class="line"> 1                                  column=0:FIRSTNAME, timestamp=1508397473229, value=Hello</span><br><span class="line"> 1                                  column=0:LASTNAME, timestamp=1508397473229, value=world</span><br><span class="line"> 1                                  column=0:_0, timestamp=1508397473229, value=x</span><br><span class="line"> 2                                  column=0:FIRSTNAME, timestamp=1508397529852, value=Hello</span><br><span class="line"> 2                                  column=0:LASTNAME, timestamp=1508397529852, value=world</span><br><span class="line"> 2                                  column=0:_0, timestamp=1508397529852, value=x</span><br><span class="line"> 3                                  column=0:FIRSTNAME, timestamp=1508397535836, value=Hello</span><br><span class="line"> 3                                  column=0:LASTNAME, timestamp=1508397535836, value=world</span><br><span class="line"> 3                                  column=0:_0, timestamp=1508397535836, value=x</span><br><span class="line"> 4                                  column=0:FIRSTNAME, timestamp=1508397643594, value=Hello</span><br><span class="line"> 4                                  column=0:LASTNAME, timestamp=1508397643594, value=phoenix</span><br><span class="line"> 4                                  column=0:_0, timestamp=1508397643594, value=x</span><br><span class="line"> 5                                  column=0:FIRSTNAME, timestamp=1508397648938, value=Hello</span><br><span class="line"> 5                                  column=0:LASTNAME, timestamp=1508397648938, value=phoenix</span><br><span class="line"> 5                                  column=0:_0, timestamp=1508397648938, value=x</span><br><span class="line">5 row(s) in 0.3220 seconds</span><br></pre></td></tr></table></figure>

<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> <span class="keyword">create</span> index idx_name <span class="keyword">on</span> usertable (lastname) include(firstname);</span><br><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> <span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> <span class="operator">!</span>tables</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------------------+---------------+----------+------------+----------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> TABLE_CAT  <span class="operator">|</span> TABLE_SCHEM  <span class="operator">|</span>       TABLE_NAME        <span class="operator">|</span>  TABLE_TYPE   <span class="operator">|</span> REMARKS  <span class="operator">|</span> TYPE_NAME  <span class="operator">|</span> SELF_REFERENCING_COL_NAME  <span class="operator">|</span> REF_GENERAT <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------------------+---------------+----------+------------+----------------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span>              <span class="operator">|</span> IDX_NAME                <span class="operator">|</span> INDEX         <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> CATALOG                 <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> <span class="keyword">FUNCTION</span>                <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> SEQUENCE                <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span> <span class="keyword">SYSTEM</span>       <span class="operator">|</span> STATS                   <span class="operator">|</span> <span class="keyword">SYSTEM</span> <span class="keyword">TABLE</span>  <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span>              <span class="operator">|</span> USERTABLE               <span class="operator">|</span> <span class="keyword">TABLE</span>         <span class="operator">|</span>          <span class="operator">|</span>            <span class="operator">|</span>                            <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------------------+---------------+----------+------------+----------------------------+-------------+</span></span><br><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> <span class="operator">!</span>index usertable</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------+-------------+------------------+-------------+-------+-------------------+--------------+----+</span></span><br><span class="line"><span class="operator">|</span> TABLE_CAT  <span class="operator">|</span> TABLE_SCHEM  <span class="operator">|</span> TABLE_NAME  <span class="operator">|</span> NON_UNIQUE  <span class="operator">|</span> INDEX_QUALIFIER  <span class="operator">|</span> INDEX_NAME  <span class="operator">|</span> TYPE  <span class="operator">|</span> ORDINAL_POSITION  <span class="operator">|</span> COLUMN_NAME  <span class="operator">|</span> <span class="keyword">AS</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------+-------------+------------------+-------------+-------+-------------------+--------------+----+</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span>              <span class="operator">|</span> USERTABLE   <span class="operator">|</span> <span class="literal">true</span>        <span class="operator">|</span>                  <span class="operator">|</span> IDX_NAME    <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span> <span class="number">1</span>                 <span class="operator">|</span> <span class="number">0</span>:LASTNAME   <span class="operator">|</span> A  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span>              <span class="operator">|</span> USERTABLE   <span class="operator">|</span> <span class="literal">true</span>        <span class="operator">|</span>                  <span class="operator">|</span> IDX_NAME    <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span> <span class="number">2</span>                 <span class="operator">|</span> :ID          <span class="operator">|</span> A  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="operator">|</span>              <span class="operator">|</span> USERTABLE   <span class="operator">|</span> <span class="literal">true</span>        <span class="operator">|</span>                  <span class="operator">|</span> IDX_NAME    <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span> <span class="number">3</span>                 <span class="operator">|</span> <span class="number">0</span>:FIRSTNAME  <span class="operator">|</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+--------------+-------------+-------------+------------------+-------------+-------+-------------------+--------------+----+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):020:0&gt; scan &#x27;IDX_NAME&#x27;</span><br><span class="line">ROW                                 COLUMN+CELL</span><br><span class="line"> phoenix\x004                       column=0:0:FIRSTNAME, timestamp=1508397686228, value=Hello</span><br><span class="line"> phoenix\x004                       column=0:_0, timestamp=1508397686228, value=x</span><br><span class="line"> phoenix\x005                       column=0:0:FIRSTNAME, timestamp=1508397686228, value=Hello</span><br><span class="line"> phoenix\x005                       column=0:_0, timestamp=1508397686228, value=x</span><br><span class="line"> world\x001                         column=0:0:FIRSTNAME, timestamp=1508397686228, value=Hello</span><br><span class="line"> world\x001                         column=0:_0, timestamp=1508397686228, value=x</span><br><span class="line"> world\x002                         column=0:0:FIRSTNAME, timestamp=1508397686228, value=Hello</span><br><span class="line"> world\x002                         column=0:_0, timestamp=1508397686228, value=x</span><br><span class="line"> world\x003                         column=0:0:FIRSTNAME, timestamp=1508397686228, value=Hello</span><br><span class="line"> world\x003                         column=0:_0, timestamp=1508397686228, value=x</span><br><span class="line">5 row(s) in 0.3180 seconds</span><br></pre></td></tr></table></figure>

<h3 id="使用索引"><a href="#使用索引" class="headerlink" title="使用索引"></a>使用索引</h3><p>正常的select … where … 是不会用到索引表的，要想用到索引表，必须查询出的字段也是索引字段。(此处的结论需要在后续的性能测试中进行验证)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:phoenix:<span class="operator">&gt;</span> <span class="keyword">select</span> firstname <span class="keyword">from</span> usertable <span class="keyword">where</span> lastname <span class="operator">=</span> <span class="string">&#x27;phoenix&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> FIRSTNAME  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> Hello      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Hello      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br></pre></td></tr></table></figure>

<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><h3 id="读"><a href="#读" class="headerlink" title="读"></a>读</h3><p>Todo…</p>
<h3 id="写"><a href="#写" class="headerlink" title="写"></a>写</h3><p>Todo…</p>
<h1 id="Local-Index"><a href="#Local-Index" class="headerlink" title="Local Index"></a>Local Index</h1><p>Todo…</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/mario-nb/p/6350266.html?utm_source=itdadao&utm_medium=referral">Phoenix的二级索引</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/MOBIN/p/5467284.html">Phoenix二级索引(Secondary Indexing)的使用</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/lifuxiangcaohui/article/details/55518390">HBase phoenix二级索引</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/10/17/storage/fs-ext2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/17/storage/fs-ext2/" class="post-title-link" itemprop="url">Ext2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-10-17 11:20:22" itemprop="dateCreated datePublished" datetime="2017-10-17T11:20:22+08:00">2017-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一个磁盘可以划分成多个分区，每个分区必须先用格式化工具（例如某种mkfs命令）格式化成某种格式的文件系统，然后才能存储文件，格式化的过程会在磁盘上写一些管理存储布局的信息。</p>
<h1 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h1><p>文件系统中存储的最小单位是块（Block），一个块究竟多大是在格式化时确定的，例如mke2fs的-b选项可以设定块大小为1024、2048或4096字节。而上图中启动块（Boot Block）的大小是确定的，就是1KB，启动块是由PC标准规定的，用来存储磁盘分区信息和启动信息，任何文件系统都不能使用启动块。启动块之后才是ext2文件系统的开始，ext2文件系统将整个分区划成若干个同样大小的块组（Block Group）</p>
<p><img src="/images/ext2/fs-ext2layout.png" alt="fs-ext2layout.png"></p>
<h2 id="做一个EXT2看看"><a href="#做一个EXT2看看" class="headerlink" title="做一个EXT2看看"></a>做一个EXT2看看</h2><p>做一个EXT2的文件系统，然后将其挂载，看看其文件格式。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=./img.1m count=256 bs=4K</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mke2fs fs</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> mount -o loop ./img.1m /mnt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> umount /mnt</span></span><br></pre></td></tr></table></figure>

<p>使用<code>od</code>查看<code>img.1m</code>镜像文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">od -tx1 -Ax ./img.1m</span><br></pre></td></tr></table></figure>

<h2 id="Super-Block"><a href="#Super-Block" class="headerlink" title="Super Block"></a>Super Block</h2><p>描述整个分区的文件系统信息，例如块大小、文件系统版本号、上次mount的时间等等。超级块在每个块组的开头都有一份拷贝。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext2_super_block</span> &#123;</span></span><br><span class="line">    __le32  s_inodes_count;     <span class="comment">/* Inodes count */</span></span><br><span class="line">    __le32  s_blocks_count;     <span class="comment">/* Blocks count */</span></span><br><span class="line">    __le32  s_r_blocks_count;   <span class="comment">/* Reserved blocks count */</span></span><br><span class="line">    __le32  s_free_blocks_count;    <span class="comment">/* Free blocks count */</span></span><br><span class="line">    __le32  s_free_inodes_count;    <span class="comment">/* Free inodes count */</span></span><br><span class="line">    __le32  s_first_data_block; <span class="comment">/* First Data Block */</span></span><br><span class="line">    __le32  s_log_block_size;   <span class="comment">/* Block size */</span></span><br><span class="line">    __le32  s_log_frag_size;    <span class="comment">/* Fragment size */</span></span><br><span class="line">    __le32  s_blocks_per_group; <span class="comment">/* # Blocks per group */</span></span><br><span class="line">    __le32  s_frags_per_group;  <span class="comment">/* # Fragments per group */</span></span><br><span class="line">    __le32  s_inodes_per_group; <span class="comment">/* # Inodes per group */</span></span><br><span class="line">    __le32  s_mtime;        <span class="comment">/* Mount time */</span></span><br><span class="line">    __le32  s_wtime;        <span class="comment">/* Write time */</span></span><br><span class="line">    __le16  s_mnt_count;        <span class="comment">/* Mount count */</span></span><br><span class="line">    __le16  s_max_mnt_count;    <span class="comment">/* Maximal mount count */</span></span><br><span class="line">    __le16  s_magic;        <span class="comment">/* Magic signature */</span></span><br><span class="line">    __le16  s_state;        <span class="comment">/* File system state */</span></span><br><span class="line">    __le16  s_errors;       <span class="comment">/* Behaviour when detecting errors */</span></span><br><span class="line">    __le16  s_minor_rev_level;  <span class="comment">/* minor revision level */</span></span><br><span class="line">    __le32  s_lastcheck;        <span class="comment">/* time of last check */</span></span><br><span class="line">    __le32  s_checkinterval;    <span class="comment">/* max. time between checks */</span></span><br><span class="line">    __le32  s_creator_os;       <span class="comment">/* OS */</span></span><br><span class="line">    __le32  s_rev_level;        <span class="comment">/* Revision level */</span></span><br><span class="line">    __le16  s_def_resuid;       <span class="comment">/* Default uid for reserved blocks */</span></span><br><span class="line">    __le16  s_def_resgid;       <span class="comment">/* Default gid for reserved blocks */</span></span><br><span class="line">    __le32  s_first_ino;        <span class="comment">/* First non-reserved inode */</span></span><br><span class="line">    __le16   s_inode_size;      <span class="comment">/* size of inode structure */</span></span><br><span class="line">    __le16  s_block_group_nr;   <span class="comment">/* block group # of this superblock */</span></span><br><span class="line">    __le32  s_feature_compat;   <span class="comment">/* compatible feature set */</span></span><br><span class="line">    __le32  s_feature_incompat;     <span class="comment">/* incompatible feature set */</span></span><br><span class="line">    __le32  s_feature_ro_compat;    <span class="comment">/* readonly-compatible feature set */</span></span><br><span class="line">    __u8    s_uuid[<span class="number">16</span>];     <span class="comment">/* 128-bit uuid for volume */</span></span><br><span class="line">    <span class="type">char</span>    s_volume_name[<span class="number">16</span>];  <span class="comment">/* volume name */</span></span><br><span class="line">    <span class="type">char</span>    s_last_mounted[<span class="number">64</span>];     <span class="comment">/* directory where last mounted */</span></span><br><span class="line">    __le32  s_algorithm_usage_bitmap; <span class="comment">/* For compression */</span></span><br><span class="line">    __u8    s_prealloc_blocks;  <span class="comment">/* Nr of blocks to try to preallocate*/</span></span><br><span class="line">    __u8    s_prealloc_dir_blocks;  <span class="comment">/* Nr to preallocate for dirs */</span></span><br><span class="line">    __u16   s_padding1;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Journaling support valid if EXT3_FEATURE_COMPAT_HAS_JOURNAL set.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    __u8    s_journal_uuid[<span class="number">16</span>]; <span class="comment">/* uuid of journal superblock */</span></span><br><span class="line">    __u32   s_journal_inum;     <span class="comment">/* inode number of journal file */</span></span><br><span class="line">    __u32   s_journal_dev;      <span class="comment">/* device number of journal file */</span></span><br><span class="line">    __u32   s_last_orphan;      <span class="comment">/* start of list of inodes to delete */</span></span><br><span class="line">    __u32   s_hash_seed[<span class="number">4</span>];     <span class="comment">/* HTREE hash seed */</span></span><br><span class="line">    __u8    s_def_hash_version; <span class="comment">/* Default hash version to use */</span></span><br><span class="line">    __u8    s_reserved_char_pad;</span><br><span class="line">    __u16   s_reserved_word_pad;</span><br><span class="line">    __le32  s_default_mount_opts;</span><br><span class="line">    __le32  s_first_meta_bg;    <span class="comment">/* First metablock block group */</span></span><br><span class="line">    __u32   s_reserved[<span class="number">190</span>];    <span class="comment">/* Padding to the end of the block */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/images/ext2/fs.sb.png" alt="fs.sb.png"></p>
<p>从000000开始的1KB是启动块，由于这不是一个真正的磁盘分区，启动块的内容全部为零。从000400到0007ff的1KB是超级块，可以对照着<code>dumpe2fs</code>分析。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dumpe2fs ./img.1m                                                                                                                 1</span> </span><br><span class="line">dumpe2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          2b8250d9-29fa-459e-9e2d-8b9c887b860b</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision #:    1 (dynamic)</span><br><span class="line">Filesystem features:      ext_attr resize_inode dir_index filetype sparse_super</span><br><span class="line">Filesystem flags:         signed_directory_hash</span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">Filesystem state:         not clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS type:       Linux</span><br><span class="line">Inode count:              128</span><br><span class="line">Block count:              1024</span><br><span class="line">Reserved block count:     51</span><br><span class="line">Free blocks:              986</span><br><span class="line">Free inodes:              117</span><br><span class="line">First block:              1</span><br><span class="line">Block size:               1024</span><br><span class="line">Fragment size:            1024</span><br><span class="line">Reserved GDT blocks:      3</span><br><span class="line">Blocks per group:         8192</span><br><span class="line">Fragments per group:      8192</span><br><span class="line">Inodes per group:         128</span><br><span class="line">Inode blocks per group:   16</span><br><span class="line">Filesystem created:       Wed Oct 25 09:56:05 2017</span><br><span class="line">Last mount time:          Wed Oct 25 09:56:48 2017</span><br><span class="line">Last write time:          Wed Oct 25 09:56:48 2017</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      -1</span><br><span class="line">Last checked:             Wed Oct 25 09:56:05 2017</span><br><span class="line">Check interval:           0 (&lt;none&gt;)</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:               128</span><br><span class="line">Default directory hash:   half_md4</span><br><span class="line">Directory Hash Seed:      2feeee23-e3de-4126-a60d-1d05a11b0ab3</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>块大小是1024字节，1MB的分区共有1024个块，第0个块是启动块，启动块之后才算ext2文件系统的开始，因此Group 0占据第1个到第1023个块，共1023个块。块位图占一个块，共有1024×8&#x3D;8192个bit，足够表示这1023个块了，因此只要一个块组就够了。默认是每8KB分配一个inode，因此1MB的分区对应128个inode，这些数据都和dumpe2fs的输出吻合。</p>
<h2 id="GDT-Group-Descriptor-Table"><a href="#GDT-Group-Descriptor-Table" class="headerlink" title="GDT(Group Descriptor Table)"></a>GDT(Group Descriptor Table)</h2><p>由很多块组描述符组成，整个分区分成多少个块组就对应有多少个块组描述符。每个块组描述符（Group Descriptor）存储一个块组的描述信息，例如在这个块组中从哪里开始是inode表，从哪里开始是数据块，空闲的inode和数据块还有多少个等等。和超级块类似，块组描述符表在每个块组的开头也都有一份拷贝，这些信息是非常重要的，一旦超级块意外损坏就会丢失整个分区的数据，一旦块组描述符意外损坏就会丢失整个块组的数据，因此它们都有多份拷贝。通常内核只用到第0个块组中的拷贝，当执行e2fsck检查文件系统一致性时，第0个块组中的超级块和块组描述符表就会拷贝到其它块组，这样当第0个块组的开头意外损坏时就可以用其它拷贝来恢复，从而减少损失。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Structure of a blocks group descriptor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext2_group_desc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __le32  bg_block_bitmap;        <span class="comment">/* Blocks bitmap block */</span></span><br><span class="line">    __le32  bg_inode_bitmap;        <span class="comment">/* Inodes bitmap block */</span></span><br><span class="line">    __le32  bg_inode_table;     <span class="comment">/* Inodes table block */</span></span><br><span class="line">    __le16  bg_free_blocks_count;   <span class="comment">/* Free blocks count */</span></span><br><span class="line">    __le16  bg_free_inodes_count;   <span class="comment">/* Free inodes count */</span></span><br><span class="line">    __le16  bg_used_dirs_count; <span class="comment">/* Directories count */</span></span><br><span class="line">    __le16  bg_pad;</span><br><span class="line">    __le32  bg_reserved[<span class="number">3</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/images/ext2/fs.gd.png" alt="fs.gd.png"></p>
<p>从000800开始是块组描述符表，这个文件系统较小，只有一个块组描述符，对照着dumpe2fs的输出信息分析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">dumpe2fs ./img.1m                                                                                                                 1</span> </span><br><span class="line">...</span><br><span class="line">Group 0: (Blocks 1-1023)</span><br><span class="line">  主 superblock at 1, Group descriptors at 2-2</span><br><span class="line">  保留的GDT块位于 3-5</span><br><span class="line">  Block bitmap at 6 (+5), Inode bitmap at 7 (+6)</span><br><span class="line">  Inode表位于 8-23 (+7)</span><br><span class="line">  986 free blocks, 117 free inodes, 2 directories</span><br><span class="line">  可用块数: 38-1023</span><br><span class="line">  可用inode数: 12-128k</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>整个文件系统是1MB，每个块是1KB，应该有1024个块，除去启动块还有1023个块，分别编号为1-1023，它们全都属于Group 0。其中，Block 1是超级块，接下来的块组描述符指出，块位图是Block 6，因此中间的Block 2-5是块组描述符表，其中Block 3-5保留未用。块组描述符还指出，inode位图是Block 7，inode表是从Block 8开始的，那么inode表到哪个块结束呢？由于超级块中指出每个块组有128个inode，每个inode的大小是128字节，因此共占16个块，inode表的范围是Block 8-23。从Block 24开始就是数据块了。块组描述符中指出，空闲的数据块有986个，由于文件系统是新创建的，空闲块是连续的Block 38-1023，用掉了前面的Block 24-37</p>
<h2 id="Block-Bitmap"><a href="#Block-Bitmap" class="headerlink" title="Block Bitmap"></a>Block Bitmap</h2><p>一个块组中的块是这样利用的：数据块（Data Block）存储所有文件的数据，比如某个分区的块大小是1024字节，某个文件是2049字节，那么就需要三个数据块来存，即使第三个块只存了一个字节也需要占用一个整块；超级块、块组描述符表、块位图、inode位图、inode表这几部分存储该块组的描述信息。那么如何知道哪些块已经用来存储文件数据或其它描述信息，哪些块仍然空闲可用呢？块位图就是用来描述整个块组中哪些块已用哪些块空闲的，它本身占一个块，其中的每个bit代表本块组中的一个块，这个bit为1表示该块已用，这个bit为0表示该块空闲可用。<br>为什么用df命令统计整个磁盘的已用空间非常快呢？因为只需要查看每个块组的块位图即可，而不需要搜遍整个分区。相反，用du命令查看一个较大目录的已用空间就非常慢，因为不可避免地要搜遍整个目录的所有文件。<br>与此相联系的另一个问题是：在格式化一个分区时究竟会划出多少个块组呢？主要的限制在于块位图本身必须只占一个块。用mke2fs格式化时默认块大小是1024字节，可以用-b参数指定块大小，现在设块大小指定为b字节，那么一个块可以有8b个bit，这样大小的一个块位图就可以表示8b个块的占用情况，因此一个块组最多可以有8b个块，如果整个分区有s个块，那么就可以有s&#x2F;(8b)个块组。格式化时可以用-g参数指定一个块组有多少个块，但是通常不需要手动指定，mke2fs工具会计算出最优的数值。</p>
<p><img src="/images/ext2/fs_blk_bmp.png" alt="fs_blk_bmp.png"></p>
<p>从块位图中可以看出，前37位（前4个字节加最后一个字节的低5位）都是1，，就表示Block 1-37已用。在块位图中，Block 38-1023对应的位都是0（一直到001870那一行最后一个字节的低7位），接下来的位已经超出了文件系统的空间，不管是0还是1都没有意义。可见，块位图每个字节中的位应该按从低位到高位的顺序来看。以后随着文件系统的使用和添加删除文件，块位图中的1就变得不连续了。</p>
<h2 id="Inode-Bitmap"><a href="#Inode-Bitmap" class="headerlink" title="Inode Bitmap"></a>Inode Bitmap</h2><p>和块位图类似，本身占一个块，其中每个bit表示一个inode是否空闲可用。</p>
<p><img src="/images/ext2/fs_inode_bmp.png" alt="fs_inode_bmp.png"></p>
<p>块组描述符指出，空闲的inode有117个，由于文件系统是新创建的，空闲的inode也是连续的，inode编号从1到128，空闲的inode编号从12到128。从inode位图可以看出，前11位都是1，表示前11个inode已用。以后随着文件系统的使用和添加删除文件，inode位图中的1就变得不连续了。001c00这一行的128位就表示了所有inode，因此下面的行不管是0还是1都没有意义。已用的11个inode中，前10个inode是被ext2文件系统保留的，其中第2个inode是根目录，第11个inode是lost+found目录，块组描述符也指出该组有两个目录，就是根目录和lost+found。</p>
<h2 id="Inode-Table"><a href="#Inode-Table" class="headerlink" title="Inode Table"></a>Inode Table</h2><p>一个文件除了数据需要存储之外，一些描述信息也需要存储，例如文件类型（常规、目录、符号链接等），权限，文件大小，创建&#x2F;修改&#x2F;访问时间等，也就是ls -l命令看到的那些信息，这些信息存在inode中而不是数据块中。每个文件都有一个inode，一个块组中的所有inode组成了inode表。<br>inode表占多少个块在格式化时就要决定并写入块组描述符中，mke2fs格式化工具的默认策略是一个块组有多少个8KB就分配多少个inode。由于数据块占了整个块组的绝大部分，也可以近似认为数据块有多少个8KB就分配多少个inode，换句话说，如果平均每个文件的大小是8KB，当分区存满的时候inode表会得到比较充分的利用，数据块也不浪费。如果这个分区存的都是很大的文件（比如电影），则数据块用完的时候inode会有一些浪费，如果这个分区存的都是很小的文件（比如源代码），则有可能数据块还没用完inode就已经用完了，数据块可能有很大的浪费。如果用户在格式化时能够对这个分区以后要存储的文件大小做一个预测，也可以用mke2fs的-i参数手动指定每多少个字节分配一个inode。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Structure of an inode on the disk</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext2_inode</span> &#123;</span></span><br><span class="line">    __le16  i_mode;     <span class="comment">/* File mode */</span></span><br><span class="line">    __le16  i_uid;      <span class="comment">/* Low 16 bits of Owner Uid */</span></span><br><span class="line">    __le32  i_size;     <span class="comment">/* Size in bytes */</span></span><br><span class="line">    __le32  i_atime;    <span class="comment">/* Access time */</span></span><br><span class="line">    __le32  i_ctime;    <span class="comment">/* Creation time */</span></span><br><span class="line">    __le32  i_mtime;    <span class="comment">/* Modification time */</span></span><br><span class="line">    __le32  i_dtime;    <span class="comment">/* Deletion Time */</span></span><br><span class="line">    __le16  i_gid;      <span class="comment">/* Low 16 bits of Group Id */</span></span><br><span class="line">    __le16  i_links_count;  <span class="comment">/* Links count */</span></span><br><span class="line">    __le32  i_blocks;   <span class="comment">/* Blocks count */</span></span><br><span class="line">    __le32  i_flags;    <span class="comment">/* File flags */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            __le32  l_i_reserved1;</span><br><span class="line">        &#125; linux1;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            __le32  h_i_translator;</span><br><span class="line">        &#125; hurd1;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            __le32  m_i_reserved1;</span><br><span class="line">        &#125; masix1;</span><br><span class="line">    &#125; osd1;             <span class="comment">/* OS dependent 1 */</span></span><br><span class="line">    __le32  i_block[EXT2_N_BLOCKS];<span class="comment">/* Pointers to blocks */</span></span><br><span class="line">    __le32  i_generation;   <span class="comment">/* File version (for NFS) */</span></span><br><span class="line">    __le32  i_file_acl; <span class="comment">/* File ACL */</span></span><br><span class="line">    __le32  i_dir_acl;  <span class="comment">/* Directory ACL */</span></span><br><span class="line">    __le32  i_faddr;    <span class="comment">/* Fragment address */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            __u8    l_i_frag;   <span class="comment">/* Fragment number */</span></span><br><span class="line">            __u8    l_i_fsize;  <span class="comment">/* Fragment size */</span></span><br><span class="line">            __u16   i_pad1;</span><br><span class="line">            __le16  l_i_uid_high;   <span class="comment">/* these 2 fields    */</span></span><br><span class="line">            __le16  l_i_gid_high;   <span class="comment">/* were reserved2[0] */</span></span><br><span class="line">            __u32   l_i_reserved2;</span><br><span class="line">        &#125; linux2;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            __u8    h_i_frag;   <span class="comment">/* Fragment number */</span></span><br><span class="line">            __u8    h_i_fsize;  <span class="comment">/* Fragment size */</span></span><br><span class="line">            __le16  h_i_mode_high;</span><br><span class="line">            __le16  h_i_uid_high;</span><br><span class="line">            __le16  h_i_gid_high;</span><br><span class="line">            __le32  h_i_author;</span><br><span class="line">        &#125; hurd2;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            __u8    m_i_frag;   <span class="comment">/* Fragment number */</span></span><br><span class="line">            __u8    m_i_fsize;  <span class="comment">/* Fragment size */</span></span><br><span class="line">            __u16   m_pad1;</span><br><span class="line">            __u32   m_i_reserved2[<span class="number">2</span>];</span><br><span class="line">        &#125; masix2;</span><br><span class="line">    &#125; osd2;             <span class="comment">/* OS dependent 2 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根目录inode信息：<br><img src="/images/ext2/fs.rootinode.png" alt="fs.rootinode.png"></p>
<p>st_mode以八进制表示，包含了文件类型和文件权限，最高位的4表示文件类型为目录（各种文件类型的编码详见stat(2)），低位的755表示权限。Size是1024，说明根目录现在只有一个数据块。Links为3表示根目录有三个硬链接，分别是根目录下的.和..，以及lost+found子目录下的..。注意，虽然我们通常用&#x2F;表示根目录，但是并没有名为&#x2F;的硬链接，事实上，&#x2F;是路径分隔符，不能在文件名中出现。这里的Blockcount是以512字节为一个块来数的，并非格式化文件系统时所指定的块大小，磁盘的最小读写单位称为扇区（Sector），通常是512字节，所以Blockcount是磁盘的物理块数量，而非分区的逻辑块数量。根目录数据块的位置由上图中的Blocks[0]指出，也就是第24个块，它在文件系统中的位置是24×0x400&#x3D;0x6000</p>
<p>探索文件系统还有一个很有用的工具debugfs，它提供一个命令行界面，可以对文件系统做各种操作，例如查看信息、恢复数据、修正文件系统中的错误。使用<code>debugfs ./img.1m</code>打开文件系统，使用<code>stat ／</code>命令查看根目录inode信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Inode: 2   Type: directory    Mode:  0755   Flags: 0x0</span><br><span class="line">Generation: 0    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 1024</span><br><span class="line">File ACL: 0    Directory ACL: 0</span><br><span class="line">Links: 3   Blockcount: 2</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x59efef35 -- Wed Oct 25 09:56:05 2017</span><br><span class="line">atime: 0x59efef63 -- Wed Oct 25 09:56:51 2017</span><br><span class="line">mtime: 0x59efef35 -- Wed Oct 25 09:56:05 2017</span><br><span class="line">BLOCKS:</span><br><span class="line">(0):24</span><br><span class="line">TOTAL: 1</span><br></pre></td></tr></table></figure>

<h3 id="数据块寻址"><a href="#数据块寻址" class="headerlink" title="数据块寻址"></a>数据块寻址</h3><p>通过<code>__le32  i_block[EXT2_N_BLOCKS]</code>来完成数据块的寻址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Constants relative to the data blocks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT2_NDIR_BLOCKS        12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT2_IND_BLOCK          EXT2_NDIR_BLOCKS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT2_DIND_BLOCK         (EXT2_IND_BLOCK + 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT2_TIND_BLOCK         (EXT2_DIND_BLOCK + 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT2_N_BLOCKS           (EXT2_TIND_BLOCK + 1)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>EXT2_NDIR_BLOCKS</code><br>  <code>i_block</code>前12项属于直接寻址，直接存储数据块的”block id”。所以总共可记录 12 笔记录，总额大小为12*1k＝12k</li>
<li><code>EXT2_IND_BLOCK</code><br>  <code>i_block</code>第13项为一级间接寻址，每笔 block 号码的记录会花去 4bytes，因此 1K 的大小能够记录 256 笔记录，因此一个间接可以记录的文件大小为(1k&#x2F;4)*1K&#x3D;256k</li>
<li><code>EXT2_DIND_BLOCK</code><br>  <code>i_block</code>第14项为二级间接寻址，第一层 block 会指定 256 个第二层，每个第二层可以指定 256 个号码，因此总额大小为256<em>256</em>1k</li>
<li><code>EXT2_TIND_BLOCK</code><br>  <code>i_block</code>第15项为三级间接寻址，第一层 block 会指定 256 个第二层，每个第二层可以指定 256 个第三层，每个第三层可以指定 256 个号码，因此总额大小为256<em>256</em>256*1k</li>
</ul>
<p>*** 总容量为直接寻址＋一级间接＋二级间接＋三级间接＝16.06GB ***</p>
<p><img src="/images/ext2/fs.datablockaddr.png" alt="fs.datablockaddr.png"></p>
<h2 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h2><ul>
<li>对于常规文件，文件的数据存储在数据块中。</li>
<li>对于目录，该目录下的所有文件名和目录名存储在数据块中，注意文件名保存在它所在目录的数据块中，除文件名之外，ls -l命令看到的其它信息都保存在该文件的inode中。注意这个概念：目录也是一种文件，是一种特殊类型的文件。</li>
<li>对于符号链接，如果目标路径名较短则直接保存在inode中以便更快地查找，如果目标路径名较长则分配一个数据块来保存。</li>
<li>设备文件、FIFO和socket等特殊文件没有数据块，设备文件的主设备号和次设备号保存在inode中。</li>
</ul>
<p>根目录的数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext2_dir_entry_2</span> &#123;</span></span><br><span class="line">    __le32  inode;          <span class="comment">/* Inode number */</span></span><br><span class="line">    __le16  rec_len;        <span class="comment">/* Directory entry length */</span></span><br><span class="line">    __u8    name_len;       <span class="comment">/* Name length */</span></span><br><span class="line">    __u8    file_type;</span><br><span class="line">    <span class="type">char</span>    name[];         <span class="comment">/* File name, up to EXT2_NAME_LEN */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>根目录的数据块<br><img src="/images/ext2/fs.datablock.png" alt="fs.datablock.png"></p>
<p>根据上文中根目录inode信息找到根目录数据块006000地址，目录的数据块由许多不定长的记录组成，每条记录描述该目录下的一个文件，在上图中用框表示。第一条记录描述inode号为2的文件，也就是根目录本身，该记录的总长度为12字节，其中文件名的长度为1字节，文件类型为2（见下表，注意此处的文件类型编码和st_mode不一致），文件名是<code>.</code>。第二条记录也是描述inode号为2的文件（根目录），该记录总长度为12字节，其中文件名的长度为2字节，文件类型为2，文件名字符串是..。第三条记录一直延续到该数据块的末尾，描述inode号为11的文件（lost+found目录），该记录的总长度为1000字节（和前面两条记录加起来是1024字节），文件类型为2，文件名字符串是lost+found，后面全是0字节。如果要在根目录下创建新的文件，可以把第三条记录截短，在原来的0字节处创建新的记录。如果该目录下的文件名太多，一个数据块不够用，则会分配新的数据块，块编号会填充到inode的Blocks[1]字段。</p>
<table>
<thead>
<tr>
<th align="center">编码</th>
<th align="left">文件类型(file type)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="left">Unknown</td>
</tr>
<tr>
<td align="center">1</td>
<td align="left">Regular File</td>
</tr>
<tr>
<td align="center">2</td>
<td align="left">Directory</td>
</tr>
<tr>
<td align="center">3</td>
<td align="left">Character device</td>
</tr>
<tr>
<td align="center">4</td>
<td align="left">Block device</td>
</tr>
<tr>
<td align="center">5</td>
<td align="left">Named pipe</td>
</tr>
<tr>
<td align="center">6</td>
<td align="left">Socket</td>
</tr>
<tr>
<td align="center">7</td>
<td align="left">Symbolic link</td>
</tr>
</tbody></table>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://docs.linuxtone.org/ebooks/C&CPP/c/ch29s02.html">ext2文件系统</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/ggjucheng/archive/2012/08/22/2651641.html#ext2_filesystem">EXT2 文件系统</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/f-ck-need-u/p/7016077.html">ext文件系统机制</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/10/02/language/python/python-exception/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/02/language/python/python-exception/" class="post-title-link" itemprop="url">Exception</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-10-02 23:41:44" itemprop="dateCreated datePublished" datetime="2017-10-02T23:41:44+08:00">2017-10-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Exception语法"><a href="#Exception语法" class="headerlink" title="Exception语法"></a>Exception语法</h1><h2 id="try-except"><a href="#try-except" class="headerlink" title="try-except"></a>try-except</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    &lt;语句&gt;</span><br><span class="line"><span class="keyword">except</span> &lt;异常名字&gt;:</span><br><span class="line">    &lt;语句&gt;</span><br><span class="line"><span class="keyword">except</span> &lt;异常名字&gt;, &lt;异常数据变量&gt;:</span><br><span class="line">    &lt;语句&gt;</span><br><span class="line"><span class="keyword">except</span> (&lt;异常名字&gt;,&lt;异常名字&gt;,...)[, &lt;异常数据变量&gt;]:</span><br><span class="line">    &lt;语句&gt;</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    &lt;语句&gt;</span><br></pre></td></tr></table></figure>

<h2 id="try-finally"><a href="#try-finally" class="headerlink" title="try-finally"></a>try-finally</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    &lt;语句&gt;</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 无论是否发生异常都将执行最后的代码</span></span><br><span class="line">    <span class="comment"># 退出try时总会执行</span></span><br><span class="line">    &lt;语句&gt;</span><br></pre></td></tr></table></figure>

<h2 id="raise"><a href="#raise" class="headerlink" title="raise"></a>raise</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">raise</span> [Exception [, args [, traceback]]]</span><br></pre></td></tr></table></figure>

<p>Exception是异常的类型（例如，NameError）参数是一个异常参数值。该参数是可选的，如果不提供，异常的参数是”None”。最后一个参数是可选的（在实践中很少使用），如果存在，是跟踪异常对象。</p>
<h1 id="标准异常"><a href="#标准异常" class="headerlink" title="标准异常"></a>标准异常</h1><table>
<thead>
<tr>
<th align="center">异常名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BaseException</td>
<td align="left">所有异常的基类</td>
</tr>
<tr>
<td align="center">SystemExit</td>
<td align="left">解释器请求退出</td>
</tr>
<tr>
<td align="center">KeyboardInterrupt</td>
<td align="left">用户中断执行(通常是输入^C)</td>
</tr>
<tr>
<td align="center">Exception</td>
<td align="left">常规错误的基类</td>
</tr>
<tr>
<td align="center">StopIteration</td>
<td align="left">迭代器没有更多的值</td>
</tr>
<tr>
<td align="center">GeneratorExit</td>
<td align="left">生成器(generator)发生异常来通知退出</td>
</tr>
<tr>
<td align="center">StandardError</td>
<td align="left">所有的内建标准异常的基类</td>
</tr>
<tr>
<td align="center">ArithmeticError</td>
<td align="left">所有数值计算错误的基类</td>
</tr>
<tr>
<td align="center">FloatingPointError</td>
<td align="left">浮点计算错误</td>
</tr>
<tr>
<td align="center">OverflowError</td>
<td align="left">数值运算超出最大限制</td>
</tr>
<tr>
<td align="center">ZeroDivisionError</td>
<td align="left">除(或取模)零 (所有数据类型)</td>
</tr>
<tr>
<td align="center">AssertionError</td>
<td align="left">断言语句失败</td>
</tr>
<tr>
<td align="center">AttributeError</td>
<td align="left">对象没有这个属性</td>
</tr>
<tr>
<td align="center">EOFError</td>
<td align="left">没有内建输入,到达EOF 标记</td>
</tr>
<tr>
<td align="center">EnvironmentError</td>
<td align="left">操作系统错误的基类</td>
</tr>
<tr>
<td align="center">IOError</td>
<td align="left">输入&#x2F;输出操作失败</td>
</tr>
<tr>
<td align="center">OSError</td>
<td align="left">操作系统错误</td>
</tr>
<tr>
<td align="center">WindowsError</td>
<td align="left">系统调用失败</td>
</tr>
<tr>
<td align="center">ImportError</td>
<td align="left">导入模块&#x2F;对象失败</td>
</tr>
<tr>
<td align="center">LookupError</td>
<td align="left">无效数据查询的基类</td>
</tr>
<tr>
<td align="center">IndexError</td>
<td align="left">序列中没有此索引(index)</td>
</tr>
<tr>
<td align="center">KeyError</td>
<td align="left">映射中没有这个键</td>
</tr>
<tr>
<td align="center">MemoryError</td>
<td align="left">内存溢出错误(对于Python 解释器不是致命的)</td>
</tr>
<tr>
<td align="center">NameError</td>
<td align="left">未声明&#x2F;初始化对象 (没有属性)</td>
</tr>
<tr>
<td align="center">UnboundLocalError</td>
<td align="left">访问未初始化的本地变量</td>
</tr>
<tr>
<td align="center">ReferenceError</td>
<td align="left">弱引用(Weak reference)试图访问已经垃圾回收了的对象</td>
</tr>
<tr>
<td align="center">RuntimeError</td>
<td align="left">一般的运行时错误</td>
</tr>
<tr>
<td align="center">NotImplementedError</td>
<td align="left">尚未实现的方法</td>
</tr>
<tr>
<td align="center">SyntaxError</td>
<td align="left">Python 语法错误</td>
</tr>
<tr>
<td align="center">IndentationError</td>
<td align="left">缩进错误</td>
</tr>
<tr>
<td align="center">TabError</td>
<td align="left">Tab 和空格混用</td>
</tr>
<tr>
<td align="center">SystemError</td>
<td align="left">一般的解释器系统错误</td>
</tr>
<tr>
<td align="center">TypeError</td>
<td align="left">对类型无效的操作</td>
</tr>
<tr>
<td align="center">ValueError</td>
<td align="left">传入无效的参数</td>
</tr>
<tr>
<td align="center">UnicodeError</td>
<td align="left">Unicode 相关的错误</td>
</tr>
<tr>
<td align="center">UnicodeDecodeError</td>
<td align="left">Unicode 解码时的错误</td>
</tr>
<tr>
<td align="center">UnicodeEncodeError</td>
<td align="left">Unicode 编码时错误</td>
</tr>
<tr>
<td align="center">UnicodeTranslateError</td>
<td align="left">Unicode 转换时错误</td>
</tr>
<tr>
<td align="center">Warning</td>
<td align="left">警告的基类</td>
</tr>
<tr>
<td align="center">DeprecationWarning</td>
<td align="left">关于被弃用的特征的警告</td>
</tr>
<tr>
<td align="center">FutureWarning</td>
<td align="left">关于构造将来语义会有改变的警告</td>
</tr>
<tr>
<td align="center">OverflowWarning</td>
<td align="left">旧的关于自动提升为长整型(long)的警告</td>
</tr>
<tr>
<td align="center">PendingDeprecationWarning</td>
<td align="left">关于特性将会被废弃的警告</td>
</tr>
<tr>
<td align="center">RuntimeWarning</td>
<td align="left">可疑的运行时行为(runtime behavior)的警告</td>
</tr>
<tr>
<td align="center">SyntaxWarning</td>
<td align="left">可疑的语法的警告</td>
</tr>
<tr>
<td align="center">UserWarning</td>
<td align="left">用户代码生成的警告</td>
</tr>
</tbody></table>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.runoob.com/python/python-exceptions.html">Python 异常处理</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/25/language/python/python-thrift-hbase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/25/language/python/python-thrift-hbase/" class="post-title-link" itemprop="url">python访问hbase方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-25 14:57:09" itemprop="dateCreated datePublished" datetime="2017-09-25T14:57:09+08:00">2017-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>python不能直接访问hbase，必须通过thrift插件才能访问hbase，下面是对<code>hbase</code>和<code>thrift</code>python插件的安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install thrift</span><br><span class="line">pip install hbase-thrift</span><br></pre></td></tr></table></figure>


<h1 id="访问hbase"><a href="#访问hbase" class="headerlink" title="访问hbase"></a>访问hbase</h1><p>hbase_client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</span><br><span class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</span><br><span class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> hbase <span class="keyword">import</span> Hbase</span><br><span class="line"><span class="keyword">from</span> hbase.ttypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HbaseClient</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host=<span class="string">&#x27;&#x27;</span>, port=<span class="number">9090</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.sock = TSocket.TSocket(host, port)</span><br><span class="line">        <span class="variable language_">self</span>.transport = TTransport.TBufferedTransport(<span class="variable language_">self</span>.sock)</span><br><span class="line">        <span class="variable language_">self</span>.proto = TBinaryProtocol.TBinaryProtocol(<span class="variable language_">self</span>.transport)</span><br><span class="line">        <span class="variable language_">self</span>.client = Hbase.Client(<span class="variable language_">self</span>.proto)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_tables</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.transport.<span class="built_in">open</span>()</span><br><span class="line">        tables = <span class="variable language_">self</span>.client.getTableNames()</span><br><span class="line">        <span class="variable language_">self</span>.transport.close()</span><br><span class="line">        <span class="keyword">return</span> tables</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_column_desp</span>(<span class="params">self, table_name</span>):</span><br><span class="line">        <span class="variable language_">self</span>.transport.<span class="built_in">open</span>()</span><br><span class="line">        column_desp = <span class="variable language_">self</span>.client.getColumnDescriptors(table_name)</span><br><span class="line">        <span class="variable language_">self</span>.transport.close()</span><br><span class="line">        <span class="keyword">return</span> column_desp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_hbase_client</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.client</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.transport.<span class="built_in">open</span>()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.transport.close()</span><br></pre></td></tr></table></figure>

<p>test.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hbase_client <span class="keyword">as</span> hc</span><br><span class="line"></span><br><span class="line">con = hc.HbaseClient(host=<span class="string">&#x27;x.x.x.x&#x27;</span>)</span><br><span class="line">client = con.get_hbase_client()</span><br><span class="line"></span><br><span class="line">con.<span class="built_in">open</span>()</span><br><span class="line">tbls = client.getTableNames()</span><br><span class="line"><span class="built_in">print</span> tbls</span><br><span class="line">mytbls = []</span><br><span class="line"><span class="keyword">for</span> tbl <span class="keyword">in</span> tbls:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (tbl == <span class="string">&#x27;YJDD:myApp&#x27;</span> <span class="keyword">or</span> tbl == <span class="string">&#x27;YJDD:myAppDetail&#x27;</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;ColumnDescriptors:&quot;</span></span><br><span class="line">    tbl_desp = client.getColumnDescriptors(tbl)</span><br><span class="line">    <span class="built_in">print</span> tbl_desp</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;TableRegions:&quot;</span></span><br><span class="line">    tbl_reg = client.getTableRegions(tbl)</span><br><span class="line">    <span class="built_in">print</span> tbl_reg</span><br><span class="line">    mytbls.append(tbl)</span><br><span class="line">                                            </span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;============== scannerGet ============&quot;</span></span><br><span class="line"><span class="keyword">for</span> tbl <span class="keyword">in</span> mytbls:</span><br><span class="line">    sid = client.scannerOpen(tbl, <span class="string">&#x27;&#x27;</span>, [<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;app&#x27;</span>])</span><br><span class="line">    row_result = client.scannerGet(sid)</span><br><span class="line">    <span class="built_in">print</span> row_result</span><br><span class="line">    <span class="keyword">while</span> row_result:</span><br><span class="line">        row_result = client.scannerGet(sid)</span><br><span class="line">        <span class="keyword">if</span> row_result:</span><br><span class="line">            <span class="built_in">print</span> row_result</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;--------------------------&quot;</span></span><br><span class="line"></span><br><span class="line">    client.scannerClose(sid)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;=============== scannerGetList ============&quot;</span></span><br><span class="line"><span class="keyword">for</span> tbl <span class="keyword">in</span> mytbls:</span><br><span class="line">    sid = client.scannerOpen(tbl, <span class="string">&#x27;&#x27;</span>, [<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;app&#x27;</span>])</span><br><span class="line">    row_result = client.scannerGetList(sid, <span class="number">20</span>)</span><br><span class="line">    <span class="built_in">print</span> row_result</span><br><span class="line">    client.scannerClose(sid)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;--------------------------&quot;</span></span><br><span class="line">con.close()</span><br></pre></td></tr></table></figure>

<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/e916815470f1">python 通过thrift访问hbase</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.apache.org/hadoop/Hbase/ThriftApi">ThriftAPI</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/25/language/python/python-encode-decode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/25/language/python/python-encode-decode/" class="post-title-link" itemprop="url">encode and decode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-25 10:35:14" itemprop="dateCreated datePublished" datetime="2017-09-25T10:35:14+08:00">2017-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>计算机只能处理数字，如果要处理文本，就必须先把文本转换为数字才能处理。最早的计算机在设计时采用8个比特（bit）作为一个字节（byte），所以，一个字节能表示的最大的整数就是255（二进制11111111&#x3D;十进制255），如果要表示更大的整数，就必须用更多的字节。比如两个字节可以表示的最大整数是65535，4个字节可以表示的最大整数是4294967295。</p>
<h2 id="ASCII"><a href="#ASCII" class="headerlink" title="ASCII"></a>ASCII</h2><p>规定了128个字符的编码(准确地说ASCII码是一个编码字符集),比如空格“SPACE”是32（二进制00100000），大写的字母A是65（二进制01000001）。这128个符号（包括32个不能打印出来的控制符号），只占用了一个字节的后面7位，最前面的1位统一规定为0。后128个称为扩展ASCII码，目前许多基于x86的系统都支持使用扩展ASCII码。256个ASCII码中的后128个扩展码可定制用来表示特殊字符和非英语字符，GB2312就是利用这后面的128个扩展字符来表示汉字，[161,254]共94个字符来组成双字节来表示简体汉字字符表。</p>
<h2 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h2><p>光是英语字符ASCII编码字符集是够了，但是如果算上世界上其他的语言的字符，ASCII码显然不够了，于是Unicode编码字符集应运而生。Unicode用数字0-0x10FFFF来映射这些字符，最多可以容纳1114112个字符，或者说有1114112个码位。码位就是可以分配给字符的数字。UTF-8、UTF-16、UTF-32都是将所有Unicode用到的数字转换为程序数据的编码方案。全世界的字符加起来也用不了所有的码位，Unicode 5.0版本中，才用了238605个码位。</p>
<h2 id="UTF8"><a href="#UTF8" class="headerlink" title="UTF8"></a>UTF8</h2><p>新问题的出现：如果统一成Unicode编码，乱码问题从此消失了。但是，如果你写的文本基本上全部是英文的话，用Unicode编码比ASCII编码需要多一倍的存储空间，在存储和传输上就十分不划算。因此，又出现了把Unicode编码转化为“可变长编码”的UTF-8编码。UTF-8编码把一个Unicode字符根据不同的数字大小编码成1-6个字节，常用的英文字母被编码成1个字节，汉字通常是3个字节，只有很生僻的字符才会被编码成4-6个字节。如果你要传输的文本包含大量英文字符，用UTF-8编码就能节省空间。ASCII编码实际上可以被看成是UTF-8编码的一部分，所以，大量只支持ASCII编码的历史遗留软件可以在UTF-8编码下继续工作。Unicode是字符集，UTF-8、UTF-16等是编码格式，定义“字符对应的数字”如何在以二进制的方式存储。</p>
<h2 id="GB2312"><a href="#GB2312" class="headerlink" title="GB2312"></a>GB2312</h2><p>规定: 一个小于127的字符的意义与原来相同, 但两个大于127的字符连在一起时, 就表示一个汉字, 前面的一个字节(他称之为高字节)从0xA1用到 0xF7, 后面一个字节(低字节)从0xA1到0xFE, 这样我们就可以组合出大约7000多个简体汉字了. 在这些编码里, 我们还把数学符号,罗马希腊的 字母,日文的假名们都编进去了, 连在 ASCII 里本来就有的数字,标点,字母都统统重新编了两个字节长的编码, 这就是常说的”全角”字符, 而原来在127号以下的那些就叫”半角”字符了。</p>
<h2 id="GBK"><a href="#GBK" class="headerlink" title="GBK"></a>GBK</h2><p>GBK 包括了 GB2312 的所有内容, 同时又增加了近20000个新的汉字(包括繁体字)和符号。</p>
<h1 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h1><p>unicode兼容ascii，GBK兼容GB2312，转换也就是unicode与GBK之间的事情了。字符串在Python内部的表示是unicode编码，因此，在做编码转换时，通常需要以unicode作为中间编码，即先将其他编码的字符串解码（decode）成unicode，再从unicode编码（encode）成另一种编码。</p>
<ul>
<li>decode的作用是将其他编码的字符串转换成unicode编码，如str1.decode(‘gb2312’)，表示将gb2312编码的字符串转换成unicode编码</li>
<li>encode的作用是将unicode编码转换成其他编码的字符串，如str2.encode(‘gb2312’)，表示将unicode编码的字符串转换成gb2312编码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding=utf8</span></span><br><span class="line"></span><br><span class="line">s = <span class="string">&#x27;中文&#x27;</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">type</span>(s)</span><br><span class="line"><span class="built_in">print</span> s</span><br><span class="line"></span><br><span class="line">us = s.decode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">type</span>(us)</span><br><span class="line"><span class="built_in">print</span> s</span><br><span class="line"></span><br><span class="line">gs = us.encode(<span class="string">&#x27;gb2312&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">type</span>(gs)</span><br><span class="line"><span class="built_in">print</span> gs</span><br></pre></td></tr></table></figure>

<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yuguangchuan/p/4310952.html">三种常见字符编码简介：ASCII、Unicode和UTF-8</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/nodeathphoenix/article/details/7057760">Unicode 字符集与它的编码方式</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/zhao1949/article/details/51198040">字符编码的故事：ASCII，GB2312，Unicode，UTF-8，UTF-16</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/q_l_s/article/details/51253542">Python字符串的编码与解码(encode与decode)</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/19/language/python/python-basic-grammar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/19/language/python/python-basic-grammar/" class="post-title-link" itemprop="url">Python基础语法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-19 09:44:32" itemprop="dateCreated datePublished" datetime="2017-09-19T09:44:32+08:00">2017-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Python语法概况"><a href="#Python语法概况" class="headerlink" title="Python语法概况"></a>Python语法概况</h1><p><img src="/images/python/grammar.png" alt="grammar"></p>
<h2 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2><p>and , exec , not , assert , finally , or , break , for , pass , class , from , print , countinue , global , raise , def , if , return , del , import , try , elif , in , while , else , is , with , except , lambda , yield</p>
<ul>
<li>exec<br>  用来执行储存在字符串或文件中的Python语句。eg：  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">exec</span> <span class="string">&#x27;print &quot;Hello World&quot;&#x27;</span></span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>
  注意例子中exec语句的用法和eval_r(), execfile()是不一样的. exec是一个语句(就象print或while), 而eval_r()和execfile()则是内建函数。</li>
<li>lambda<br>  在python中使用lambda来创建匿名函数，lambda会创建一个函数对象，但不会把这个函数对象赋给一个标识符，而def则会把函数对象赋值给一个变量。lambda它只是一个表达式，而def则是一个语句。eg:  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">m = <span class="keyword">lambda</span> x,y,z: (x-y)*z</span><br><span class="line"><span class="built_in">print</span> m(<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
  lambda一般只用来定义简单的函数。</li>
<li>yield<br>  它和return差不多的用法，只是最后是返回了一个生成器，当你调用yield所在的那个函数的时候，那个函数并没有运行，只会返回一个生成器的对象，第一次在for中调用生成器的的对象，它将会运行你函数中的代码从最开始一直到到碰到了yield的关键字，然后它会返回循环中的第一个值。然后每一次其他的调用将会运行你在这个函数中所写的循环多一次，并且返回下一个值，知道没有值可以返回了。eg:  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">def</span> <span class="title function_">createGenerator</span>():</span><br><span class="line"><span class="meta">... </span>   mylist = <span class="built_in">range</span>(<span class="number">3</span>)</span><br><span class="line"><span class="meta">... </span>   <span class="keyword">for</span> i <span class="keyword">in</span> mylist:</span><br><span class="line"><span class="meta">... </span>       <span class="keyword">yield</span> i*i</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>mygenerator = createGenerator() <span class="comment"># create a generator</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(mygenerator) <span class="comment"># mygenerator is an object!</span></span><br><span class="line">&lt;generator <span class="built_in">object</span> createGenerator at <span class="number">0xb7555c34</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> mygenerator:</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Python-VS-C"><a href="#Python-VS-C" class="headerlink" title="Python VS C"></a>Python VS C</h1><table>
<thead>
<tr>
<th align="center">Pytho</th>
<th align="center">C</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">字母、数字、下划线组成，不能以数字开头，区分大小写</td>
<td align="center">字母、数字、下划线组成，不能以数字开头，区分大小写</td>
<td align="left">标识符</td>
</tr>
<tr>
<td align="center">单下划线开头的代表不能直接访问的类属性，通过类提供的接口访问</td>
<td align="center"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">双下划线开头的代表类的私有成员</td>
<td align="center"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">双下划线开头和结尾的代表特殊方法专用的标识(eg:<strong>init</strong>())</td>
<td align="center"></td>
<td align="left"></td>
</tr>
<tr>
<td align="center">“&quot;</td>
<td align="center">不需要，以”;”结尾</td>
<td align="left">行继符</td>
</tr>
<tr>
<td align="center">单引号(‘),双引号(“),三引号(‘’’)</td>
<td align="center">双引号(“)</td>
<td align="left">字符串</td>
</tr>
<tr>
<td align="center">#</td>
<td align="center">&#x2F;&#x2F;</td>
<td align="left">注释</td>
</tr>
<tr>
<td align="center">:</td>
<td align="center">{}</td>
<td align="left">代码块</td>
</tr>
<tr>
<td align="center">if</td>
<td align="center">if</td>
<td align="left">条件</td>
</tr>
<tr>
<td align="center">elif</td>
<td align="center">else if</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">else</td>
<td align="center">else</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">a &#x3D; b &#x3D; 1 or a,b&#x3D;1,”Hi”</td>
<td align="center">int a&#x3D;1 , b&#x3D;2</td>
<td align="left">多变量赋值</td>
</tr>
<tr>
<td align="center">Numbers, String, List, Tuple, Dictionary</td>
<td align="center">char, int , float, double, void, point*</td>
<td align="left">基础数据类型</td>
</tr>
<tr>
<td align="center">list[item1, item2, …  itemN]</td>
<td align="center"></td>
<td align="left">列表，允许更新</td>
</tr>
<tr>
<td align="center">tuple(item1, item2, …, itemN)</td>
<td align="center"></td>
<td align="left">元组，不允许更新操作</td>
</tr>
<tr>
<td align="center">dict{key1:value1, key2:value2, …, keyN:valueN}</td>
<td align="center"></td>
<td align="left">字典，允许更新</td>
</tr>
<tr>
<td align="center">**</td>
<td align="center"></td>
<td align="left">幂，a**b a的b次幂</td>
</tr>
<tr>
<td align="center">&#x2F;&#x2F;</td>
<td align="center">mod</td>
<td align="left">整除</td>
</tr>
<tr>
<td align="center">“!&#x3D;” , “&lt;&gt;”</td>
<td align="center">“!&#x3D;”</td>
<td align="left">不等</td>
</tr>
<tr>
<td align="center">“and”</td>
<td align="center">“&amp;&amp;”</td>
<td align="left">逻辑运算</td>
</tr>
<tr>
<td align="center">“or”</td>
<td align="center">双竖线</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">“not”</td>
<td align="center">“!”</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">“in” , “not in”</td>
<td align="center"></td>
<td align="left">判断元素在不在元组或列表中</td>
</tr>
<tr>
<td align="center">“is” , “not is”</td>
<td align="center"></td>
<td align="left">判断两个标识符是不是引用自一个对象</td>
</tr>
<tr>
<td align="center">“while”, “for”</td>
<td align="center">“while”, “for”, “do..while”</td>
<td align="left">循环, python中可与”else”一起执行条件为false的情况</td>
</tr>
<tr>
<td align="center">“break”, “continue”, “pass”</td>
<td align="center">“break”, “continue”, “goto”</td>
<td align="left">循环控制</td>
</tr>
</tbody></table>
<h1 id="Python编译"><a href="#Python编译" class="headerlink" title="Python编译"></a>Python编译</h1><table>
<thead>
<tr>
<th align="left">选项</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-d</td>
<td align="left">在解析时显示调试信息</td>
</tr>
<tr>
<td align="left">-O</td>
<td align="left">生成优化代码 ( .pyo 文件 )</td>
</tr>
<tr>
<td align="left">-S</td>
<td align="left">启动时不引入查找Python路径的位置</td>
</tr>
<tr>
<td align="left">-c cmd</td>
<td align="left">执行 Python 脚本，并将运行结果作为 cmd 字符串</td>
</tr>
<tr>
<td align="left">file</td>
<td align="left">在给定的python文件执行python脚本</td>
</tr>
</tbody></table>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.w3cschool.cn/python/python-basic-syntax.html">Python 基础语法</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/edenpans/p/6524966.html">PYTHON YIELD 关键字</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/18/storage/virtual-filesystem-switch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/18/storage/virtual-filesystem-switch/" class="post-title-link" itemprop="url">virtual-filesystem-switch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-18 23:28:47" itemprop="dateCreated datePublished" datetime="2017-09-18T23:28:47+08:00">2017-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/vfs/vfs-arch.png" alt="vfs-arch"></p>
<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><p>引用代码版本：linux-3.10.104</p>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><ul>
<li>提供一个通用接口</li>
<li>提供各种cache以提高文件系统性能</li>
</ul>
<p><img src="/images/vfs/vfs.png" alt="vfs"></p>
<h1 id="VFS所处理的系统调用"><a href="#VFS所处理的系统调用" class="headerlink" title="VFS所处理的系统调用"></a>VFS所处理的系统调用</h1><table>
<thead>
<tr>
<th align="left">系统调用名</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mount umount umount2</td>
<td align="left">安装／卸载文件系统</td>
</tr>
<tr>
<td align="left">sysfs</td>
<td align="left">获取文件系统信息</td>
</tr>
<tr>
<td align="left">ustat statfs fstatfs statfs64 fstatfs64</td>
<td align="left">获取文件系统统计信息</td>
</tr>
<tr>
<td align="left">chroot pivot_root</td>
<td align="left">更改根目录</td>
</tr>
<tr>
<td align="left">chdir fchdir getcwd</td>
<td align="left">对当前目录进行操作</td>
</tr>
<tr>
<td align="left">mkdir rmdir</td>
<td align="left">创建、删除目录</td>
</tr>
<tr>
<td align="left">getdents getdents64 readdir link unlink rename lookup_dcookie</td>
<td align="left">对目录项进行操作</td>
</tr>
<tr>
<td align="left">readlink symlink</td>
<td align="left">对软连接进行操作</td>
</tr>
<tr>
<td align="left">chown fchown lchown chown16 fchown16 lchown16</td>
<td align="left">更改文件所有者</td>
</tr>
<tr>
<td align="left">chmod fchmod utime</td>
<td align="left">更改文件属性</td>
</tr>
<tr>
<td align="left">stat fstat lstat access oldstat oldfstat oldlstat</td>
<td align="left">读取文件状态</td>
</tr>
<tr>
<td align="left">stat64 lstat64 fstat64</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">open close creat umask</td>
<td align="left">打开、关闭、创建文件</td>
</tr>
<tr>
<td align="left">dup dup2 fcntl fcntl64</td>
<td align="left">对文件描述符进行操作</td>
</tr>
<tr>
<td align="left">select poll</td>
<td align="left">等待一组文件描述符上发生的事件</td>
</tr>
<tr>
<td align="left">truncate ftruncate truncate64 ftruncate64</td>
<td align="left">更改文件长度</td>
</tr>
<tr>
<td align="left">lseek</td>
<td align="left">更改文件指针</td>
</tr>
<tr>
<td align="left">read write readv writev sendfile sendfile64 readahead</td>
<td align="left">进行文件I&#x2F;O操作</td>
</tr>
<tr>
<td align="left">io_setup io_submit io_getevents io_cancel io_destroy</td>
<td align="left">异步I&#x2F;O</td>
</tr>
<tr>
<td align="left">pread64 pwrite64</td>
<td align="left">搜索并访问文件</td>
</tr>
<tr>
<td align="left">mmap mmap2 munmap madvise mincore remap_file_pages</td>
<td align="left">处理文件内存映射</td>
</tr>
<tr>
<td align="left">fdatasync fsync sync msync</td>
<td align="left">同步文件数据</td>
</tr>
<tr>
<td align="left">flock</td>
<td align="left">处理文件锁</td>
</tr>
<tr>
<td align="left">setxattr lsetxattr fsetxattr getxattr lgetxattr</td>
<td align="left">处理文件扩展属性</td>
</tr>
<tr>
<td align="left">fgetxattr listxattr llistxattr flistxattr removexattr</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">lremovexattr fremovexattr</td>
<td align="left"></td>
</tr>
</tbody></table>
<h1 id="VFS数据结构"><a href="#VFS数据结构" class="headerlink" title="VFS数据结构"></a>VFS数据结构</h1><ul>
<li>超级块对象和inode对象分别对应有物理数据，在磁盘上有静态信息。</li>
<li>目录项对象和文件对象描述的是一种关系，前者描述的文件与文件名的关系，后者描述的是进程与文件的关系，所以没有对应物理数据</li>
<li>进程每打开一个文件，就会有一个file结构与之对应。同一个进程可以多次打开同一个文件而得到多个不同的file结构，file结构描述被打开文件的属性，如文件的当前偏移量等信息</li>
<li>两个不同的file结构可以对应同一个dentry结构。进程多次打开同一个文件时，对应的只有一个dentry结构</li>
<li>在存储介质中，每个文件对应唯一的inode结点，但是每个文件又可以有多个文件名。</li>
<li>Inode中不存储文件的名字，它只存储节点号；而dentry则保存有名字和与其对应的节点号，所以就可以通过不同的dentry访问同一个inode</li>
</ul>
<p><img src="/images/vfs/vfs_3.10.104.png" alt="vfs_3.10.104.png"></p>
<h2 id="Super-Block"><a href="#Super-Block" class="headerlink" title="Super Block"></a>Super Block</h2><ul>
<li>超级块用来描述特定文件系统的信息。它存放在磁盘特定的扇区中 ,它在使用的时候将信息存在于内存中</li>
<li>当内核对一个文件系统进行初始化和注册时在内存为其分配一个超级块，这就是VFS超级块。即，VFS超级块是各种具体文件系统在安装时建立的，并在这些文件系统卸载时被自动删除</li>
</ul>
<p><img src="/images/vfs/super_block_1.jpg" alt="super_block_1.jpg"></p>
<p> 关键成员：</p>
<ul>
<li>s_list<br>  所有的超级块形成一个双联表，s_list.prev和s_list.next分别指向与当前超级块相邻的前一个元素和后一个元素</li>
<li>s_fs_info<br>  字段指向具体文件系统的超级块。<br>  例如：超级块对象指的是Ext2文件系统，该字段就指向ext2_sb_info数据结构</li>
<li>alloc_super()<br>  超级块对象是通过函数alloc_super()创建并初始化的(由<code>sget()</code>调用，在<code>fs/super.c</code>文件中)。在文件系统安装时，内核会调用该函数以便从磁盘读取文件系统超级块，并且将其信息填充到内存中的超级块对象中</li>
</ul>
<p><code>include/linux/fs.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">s_list</span>;</span>                 <span class="comment">/* 指向超级块链表的指针 */</span></span><br><span class="line">    <span class="type">dev_t</span>               s_dev;                  <span class="comment">/* 设备标示符 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>       s_blocksize_bits;       <span class="comment">/* 以位为单位的块大小 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       s_blocksize;            <span class="comment">/* 以字节为单位的块大小 */</span></span><br><span class="line">    <span class="type">loff_t</span>              s_maxbytes;             <span class="comment">/* 文件的最长长度 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span>     *<span class="title">s_type</span>;</span>        <span class="comment">/* 文件系统类型 */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span>   *<span class="title">s_op</span>;</span>      <span class="comment">/* 超级块方法 */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dquot_operations</span>   *<span class="title">dq_op</span>;</span>     <span class="comment">/* 磁盘限额处理方法*/</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">quotactl_ops</span>   *<span class="title">s_qcop</span>;</span>        <span class="comment">/* 磁盘限额管理方法 */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">export_operations</span> *<span class="title">s_export_op</span>;</span><span class="comment">/* 网络文件系统使用的输出操作 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       s_flags;                <span class="comment">/* 安装标志 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       s_magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>       *<span class="title">s_root</span>;</span>                <span class="comment">/* 文件系统根目录和目录项对象 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">s_umount</span>;</span>               <span class="comment">/* 卸载文件系统所用的信号量 */</span></span><br><span class="line">    <span class="type">int</span>         s_count;                        <span class="comment">/* 引用计数 */</span></span><br><span class="line">    <span class="type">atomic_t</span>        s_active;                   <span class="comment">/* 次级引用计数 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="type">void</span>                    *s_security;        <span class="comment">/* 指向超级块安全数据结构的指针 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xattr_handler</span> **<span class="title">s_xattr</span>;</span>       <span class="comment">/* 指向超级块扩展属性结构的指针*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">s_inodes</span>;</span>               <span class="comment">/* all inodes */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_head</span>    <span class="title">s_anon</span>;</span>             <span class="comment">/* 用于处理远程网络文件系统的匿名目录项的链表 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">s_mounts</span>;</span>               <span class="comment">/* list of mounts; _not_ for fs use */</span></span><br><span class="line">    <span class="comment">/* s_dentry_lru, s_nr_dentry_unused protected by dcache.c lru locks */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">s_dentry_lru</span>;</span>           <span class="comment">/* unused dentry lru */</span></span><br><span class="line">    <span class="type">int</span>         s_nr_dentry_unused;             <span class="comment">/* # of dentry on lru */</span></span><br><span class="line">    <span class="comment">/* s_inode_lru_lock protects s_inode_lru and s_nr_inodes_unused */</span></span><br><span class="line">    <span class="type">spinlock_t</span>      s_inode_lru_lock ____cacheline_aligned_in_smp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">s_inode_lru</span>;</span>            <span class="comment">/* unused inode lru */</span></span><br><span class="line">    <span class="type">int</span>         s_nr_inodes_unused;             <span class="comment">/* # of inodes on lru */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">s_bdev</span>;</span>                <span class="comment">/* 指向块设备驱动程序描述符的指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span> *<span class="title">s_bdi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtd_info</span>     *<span class="title">s_mtd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>   <span class="title">s_instances</span>;</span>            <span class="comment">/* 用于给定文件系统类型的超级块对象链表的指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quota_info</span>   <span class="title">s_dquot</span>;</span>                <span class="comment">/* 磁盘限额的描述符 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sb_writers</span>   <span class="title">s_writers</span>;</span></span><br><span class="line">    <span class="type">char</span> s_id[<span class="number">32</span>];                              <span class="comment">/* Informational name */</span></span><br><span class="line">    u8 s_uuid[<span class="number">16</span>];                              <span class="comment">/* UUID */</span></span><br><span class="line">    <span class="type">void</span>            *s_fs_info;                 <span class="comment">/* 指向特定文件系统的超级块信息的指针 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        s_max_links;</span><br><span class="line">    <span class="type">fmode_t</span>         s_mode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Granularity of c/m/atime in ns. Cannot be worse than a second */</span></span><br><span class="line">    u32        s_time_gran;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The next field is for VFS *only*. No filesystems have any business</span></span><br><span class="line"><span class="comment">     * even looking at it. You had been warned. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">s_vfs_rename_mutex</span>;</span>            <span class="comment">/* Kludge */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Filesystem subtype.  If non-empty the filesystem type field</span></span><br><span class="line"><span class="comment">     * in /proc/mounts will be &quot;type.subtype&quot; */</span></span><br><span class="line">    <span class="type">char</span> *s_subtype;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Saved mount options for lazy filesystems using</span></span><br><span class="line"><span class="comment">     * generic_show_options() */</span></span><br><span class="line">    <span class="type">char</span> __rcu *s_options;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">s_d_op</span>;</span> <span class="comment">/* default d_op for dentries */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Saved pool identifier for cleancache (-1 means none) */</span></span><br><span class="line">    <span class="type">int</span> cleancache_poolid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shrinker</span> <span class="title">s_shrink</span>;</span>   <span class="comment">/* per-sb shrinker handle */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of inodes with nlink == 0 but still referenced */</span></span><br><span class="line">    <span class="type">atomic_long_t</span> s_remove_count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Being remounted read-only */</span></span><br><span class="line">    <span class="type">int</span> s_readonly_remount;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="super-operation"><a href="#super-operation" class="headerlink" title="super_operation"></a>super_operation</h3><p><code>include/linux/fs.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *(*<span class="title">alloc_inode</span>)(<span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>);</span></span><br><span class="line">    <span class="comment">/* 创建和初始化一个索引节点对象 */</span></span><br><span class="line">    <span class="type">void</span> (*destroy_inode)(<span class="keyword">struct</span> inode *);</span><br><span class="line">    <span class="comment">/* 释放给定的索引节点 */</span></span><br><span class="line">    <span class="type">void</span> (*dirty_inode) (<span class="keyword">struct</span> inode *, <span class="type">int</span> flags);</span><br><span class="line">    <span class="comment">/* VFS在索引节点被修改时会调用这个函数 */</span></span><br><span class="line">    <span class="type">int</span> (*write_inode) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> writeback_control *wbc);</span><br><span class="line">    <span class="comment">/* 将指定的inode写回磁盘 */</span></span><br><span class="line">    <span class="type">int</span> (*drop_inode) (<span class="keyword">struct</span> inode *);</span><br><span class="line">    <span class="comment">/* 最后一个指向索引节点的引用被删除后，VFS会调用这个函数 */</span></span><br><span class="line">    <span class="type">void</span> (*evict_inode) (<span class="keyword">struct</span> inode *);</span><br><span class="line">    <span class="type">void</span> (*put_super) (<span class="keyword">struct</span> super_block *);</span><br><span class="line">    <span class="comment">/* 卸载文件系统时由VFS调用，用来释放超级块 */</span></span><br><span class="line">    <span class="type">int</span> (*sync_fs)(<span class="keyword">struct</span> super_block *sb, <span class="type">int</span> wait);</span><br><span class="line">    <span class="comment">/* 使文件系统中的数据与磁盘上的数据同步 */</span></span><br><span class="line">    <span class="type">int</span> (*freeze_fs) (<span class="keyword">struct</span> super_block *);</span><br><span class="line">    <span class="type">int</span> (*unfreeze_fs) (<span class="keyword">struct</span> super_block *);</span><br><span class="line">    <span class="type">int</span> (*statfs) (<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> kstatfs *);</span><br><span class="line">    <span class="comment">/* VFS调用该函数获取文件系统状态 */</span></span><br><span class="line">    <span class="type">int</span> (*remount_fs) (<span class="keyword">struct</span> super_block *, <span class="type">int</span> *, <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">/* 定新的安装选项重新安装文件系统时，VFS会调用该函数 */</span></span><br><span class="line">    <span class="type">void</span> (*umount_begin) (<span class="keyword">struct</span> super_block *);</span><br><span class="line">    <span class="comment">/* VFS调用该函数中断安装操作 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*show_options)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="comment">/* 用来显示特定文件系统的选项 */</span></span><br><span class="line">    <span class="type">int</span> (*show_devname)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="type">int</span> (*show_path)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="type">int</span> (*show_stats)(<span class="keyword">struct</span> seq_file *, <span class="keyword">struct</span> dentry *);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_QUOTA</span></span><br><span class="line">    <span class="type">ssize_t</span> (*quota_read)(<span class="keyword">struct</span> super_block *, <span class="type">int</span>, <span class="type">char</span> *, <span class="type">size_t</span>, <span class="type">loff_t</span>);</span><br><span class="line">    <span class="comment">/* 限额系统使用该方法从文件中读取数据，该文件详细说明了所在文件系统的限制 */</span></span><br><span class="line">    <span class="type">ssize_t</span> (*quota_write)(<span class="keyword">struct</span> super_block *, <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> *, <span class="type">size_t</span>, <span class="type">loff_t</span>);</span><br><span class="line">    <span class="comment">/* 限额系统使用该方法将数据写入文件中，该文件详细说明了所在文件系统的限制 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">int</span> (*bdev_try_to_free_page)(<span class="keyword">struct</span> super_block*, <span class="keyword">struct</span> page*, <span class="type">gfp_t</span>);</span><br><span class="line">    <span class="type">int</span> (*nr_cached_objects)(<span class="keyword">struct</span> super_block *);</span><br><span class="line">    <span class="type">void</span> (*free_cached_objects)(<span class="keyword">struct</span> super_block *, <span class="type">int</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Inode"><a href="#Inode" class="headerlink" title="Inode"></a>Inode</h2><p><img src="/images/vfs/inode_1.jpg" alt="inode_1.jpg"></p>
<p>索引节点，索引节点与文件一一对应，并且随文件存在而存在。内存中索引节点由一个inode结构表示。</p>
<p><code>include/linux/fs.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> &#123;</span></span><br><span class="line">    <span class="type">umode_t</span>         i_mode;             <span class="comment">/* 文件类型与访问权限 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>      i_opflags;</span><br><span class="line">    <span class="type">kuid_t</span>          i_uid;              <span class="comment">/* inode所属文件的拥有者的id，通过ls -n可查看拥有者id */</span></span><br><span class="line">    <span class="type">kgid_t</span>          i_gid;              <span class="comment">/* inode所属文件所在组的id，通过ls -n可查看组id */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        i_flags;            <span class="comment">/* 文件系统的安装标志 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_POSIX_ACL</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>    *<span class="title">i_acl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>    *<span class="title">i_default_acl</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span>   *<span class="title">i_op</span>;</span>  <span class="comment">/* 索引节点的操作 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span>  *<span class="title">i_sb</span>;</span>              <span class="comment">/* 指向超级块对象的指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>    *<span class="title">i_mapping</span>;</span>     <span class="comment">/* address space */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="type">void</span>            *i_security;            <span class="comment">/* 指向索引节点安全结构的指针 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stat data, not accessed from path walking */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       i_ino;          <span class="comment">/* 索引节点号 */</span></span><br><span class="line">    <span class="comment">/* Filesystems may only read i_nlink directly.  They shall use the</span></span><br><span class="line"><span class="comment">     * following functions for modification:</span></span><br><span class="line"><span class="comment">     *    (set|clear|inc|drop)_nlink</span></span><br><span class="line"><span class="comment">     *    inode_(inc|dec)_link_count */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> i_nlink;     <span class="comment">/* 硬链接数目，当该inode描述一个目录时，这个值至少为2，代表.和..的数目 */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> __i_nlink;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">dev_t</span>           i_rdev;             <span class="comment">/* 如果该inode描述的是一个设备文件，此值为设备号 */</span></span><br><span class="line">    <span class="type">loff_t</span>          i_size;             <span class="comment">/* 文件的字节数 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>     <span class="title">i_atime</span>;</span>        <span class="comment">/* 上次访问文件的时间 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>     <span class="title">i_mtime</span>;</span>        <span class="comment">/* 上次写文件的时间，这里的修改只文件内容被修改 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>     <span class="title">i_ctime</span>;</span>        <span class="comment">/* 上次修改索引节点的时间，这里的修改除了指文件内容被修改外，更强调的是文件的属性被修改 */</span></span><br><span class="line">    <span class="type">spinlock_t</span>          i_lock;         <span class="comment">/* i_blocks, i_bytes, maybe i_size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>      i_bytes;        <span class="comment">/* 文件中最后一个块的字节数 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        i_blkbits;      <span class="comment">/* 块的位数 */</span></span><br><span class="line">    <span class="type">blkcnt_t</span>            i_blocks;       <span class="comment">/* 文件使用块的个数，通过ls -s可以查看该某个文件的块使用数目 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __NEED_I_SIZE_ORDERED</span></span><br><span class="line">    <span class="type">seqcount_t</span>      i_size_seqcount;    <span class="comment">/* SMP系统为i_size字段获取一致值时使用的顺序计数器 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Misc */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       i_state;        <span class="comment">/* 索引节点的状态标志 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>        <span class="title">i_mutex</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       dirtied_when;   <span class="comment">/* jiffies of first dirtying */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>   <span class="title">i_hash</span>;</span>         <span class="comment">/* 用于散列链表的指针 */</span></span><br><span class="line">    <span class="comment">/* 为了提高查找inode的效率，每一个inode都会有一个hash值。该字段指向hash值相同的inode所形成的双链表该字段包含prev和next两个指针，分别指向上述链表的前一个元素和后一个元素 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_wb_list</span>;</span>      <span class="comment">/* backing dev IO list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_lru</span>;</span>          <span class="comment">/* inode LRU list 所有使用的索引结点形成的双联表 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_sb_list</span>;</span>      <span class="comment">/* 用于超级块的索引节点链表的指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>   <span class="title">i_dentry</span>;</span>   <span class="comment">/* 所有引用索引节点的目录项对象链表的头 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>     <span class="title">i_rcu</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    u64         i_version;              <span class="comment">/* 版本号（每次使用后自动递增） */</span></span><br><span class="line">    <span class="type">atomic_t</span>        i_count;            <span class="comment">/* 引用计数器 */</span></span><br><span class="line">    <span class="type">atomic_t</span>        i_dio_count;</span><br><span class="line">    <span class="type">atomic_t</span>        i_writecount;       <span class="comment">/* 用于写进程的引用计数器 */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>    *<span class="title">i_fop</span>;</span> <span class="comment">/* 缺省文件操作 former -&gt;i_op-&gt;default_file_ops */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_lock</span>    *<span class="title">i_flock</span>;</span>           <span class="comment">/* 指向文件锁链表的指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>    <span class="title">i_data</span>;</span>         <span class="comment">/* address space */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_QUOTA</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dquot</span>    *<span class="title">i_dquot</span>[<span class="title">MAXQUOTAS</span>];</span>    <span class="comment">/* 索引节点磁盘限额 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_devices</span>;</span>          <span class="comment">/* 用于具体的字符或块设备索引节点链表的指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>  *<span class="title">i_pipe</span>;</span>    <span class="comment">/* 如果文件是一个管道则使用它 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">i_bdev</span>;</span>        <span class="comment">/* 指向块设备驱动程序的指针 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>     *<span class="title">i_cdev</span>;</span>            <span class="comment">/* 指向字符设备驱动程序的指针 */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    __u32           i_generation;           <span class="comment">/* 索引节点版本号（由某些文件系统使用） */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">    __u32           i_fsnotify_mask;        <span class="comment">/* all events this inode cares about */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>   <span class="title">i_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_IMA</span></span><br><span class="line">    <span class="type">atomic_t</span>        i_readcount; <span class="comment">/* struct files open RO */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">void</span>            *i_private; <span class="comment">/* fs or device private pointer */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="i-state-成员"><a href="#i-state-成员" class="headerlink" title="i_state 成员"></a>i_state 成员</h3><ul>
<li>I_DIRTY_SYNC<br>  已被改变但不需要同步</li>
<li>I_DIRTY_DATASYNC<br>  数据部分已被改变</li>
<li>I_DIRTY_PAGES<br>  有脏的数据页</li>
<li>I_NEW<br>  索引节点对象已经分配，但还没有用从磁盘索引节点读取来的数据填充</li>
<li>I_WILL_FREE<br>  即将被释放</li>
<li>I_FREEING<br>  索引节点对象正在被释放</li>
<li>I_CLEAR<br>  索引节点对象的内容不再有意义</li>
<li>I_SYNC<br>  正在同步过程中</li>
<li>I_REFERENCED<br>  在LRU list中标记inode为最近被引用过</li>
<li>I_DIO_WAKEUP<br>  Never Set</li>
<li>I_DIRTY<br>  I_DIRTY_SYNC | I_DIRTY_DATASYNC | I_DIRTY_PAGES</li>
</ul>
<h3 id="inode-operations"><a href="#inode-operations" class="headerlink" title="inode_operations"></a>inode_operations</h3><p><code>include/linux/fs.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> * (*<span class="title">lookup</span>) (<span class="keyword">struct</span> <span class="title">inode</span> *,<span class="keyword">struct</span> <span class="title">dentry</span> *, <span class="title">unsigned</span> <span class="title">int</span>);</span></span><br><span class="line">    <span class="type">void</span> * (*follow_link) (<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> nameidata *);</span><br><span class="line">    <span class="type">int</span> (*permission) (<span class="keyword">struct</span> inode *, <span class="type">int</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span> * (*<span class="title">get_acl</span>)(<span class="keyword">struct</span> <span class="title">inode</span> *, <span class="title">int</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*readlink) (<span class="keyword">struct</span> dentry *, <span class="type">char</span> __user *,<span class="type">int</span>);</span><br><span class="line">    <span class="type">void</span> (*put_link) (<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> nameidata *, <span class="type">void</span> *);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*create) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *, <span class="type">umode_t</span>, <span class="type">bool</span>);</span><br><span class="line">    <span class="comment">/* 如果该inode描述一个目录文件，那么当在该目录下创建或打开一个文件时，内核必须为这个文件创建一个inode。VFS通过调用该inode的i_op-&gt;create()函数来完成上述新inode的创建。</span></span><br><span class="line"><span class="comment">    该函数的第一个参数为该目录的 inode，第二个参数为要打开新文件的dentry，第三个参数是对该文件的访问权限。如果该inode描述的是一个普通文件，那么该inode永远都不会调用这个create函数 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*link) (<span class="keyword">struct</span> dentry *,<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="comment">/* 用于在指定目录下创建一个硬链接。这个link函数最终会被系统调用link()调用。</span></span><br><span class="line"><span class="comment">    该函数的第一个参数是原始文件的dentry，第二个参数即为上述指定目录的inode，第三个参数是链接文件的dentry。 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*unlink) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="comment">/* 在某个目录下删除dentry指定的索引节点对象。这个unlink函数最终会被系统调用unlink()调用。 第一个参数即为上述硬链接所在目录的inode，第二个参数为要删除文件的dentry */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*symlink) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *,<span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">/* 在某个目录下新建软连接（符号链接），第一个参数是原始文件所在目录的inode，第二个参数是原始文件的dentry，第三个参数是符号链接的名字（const char *） */</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> (*mkdir) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *,<span class="type">umode_t</span>);</span><br><span class="line">    <span class="comment">/* 在指定的目录下创建一个子目录，当前目录的inode会调用i_op-&gt;mkdir()。该函数会被系统调用mkdir()调用。</span></span><br><span class="line"><span class="comment">    第一个参数即为指定目录的inode，第二个参数为子目录的dentry，第三个参数为子目录权限；</span></span><br><span class="line"><span class="comment">    （目录与子目录是通过目录inode中的dentry链相连的，而子目录的dentry又指向子目录自身的inode） */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*rmdir) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="type">int</span> (*mknod) (<span class="keyword">struct</span> inode *,<span class="keyword">struct</span> dentry *,<span class="type">umode_t</span>,<span class="type">dev_t</span>);</span><br><span class="line">    <span class="comment">/* 在指定的目录下创建一个特殊文件，比如管道、设备文件或套接字等 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*rename) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> inode *, <span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="type">int</span> (*setattr) (<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> iattr *);</span><br><span class="line">    <span class="type">int</span> (*getattr) (<span class="keyword">struct</span> vfsmount *mnt, <span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> kstat *);</span><br><span class="line">    <span class="type">int</span> (*setxattr) (<span class="keyword">struct</span> dentry *, <span class="type">const</span> <span class="type">char</span> *,<span class="type">const</span> <span class="type">void</span> *,<span class="type">size_t</span>,<span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*getxattr) (<span class="keyword">struct</span> dentry *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">void</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*listxattr) (<span class="keyword">struct</span> dentry *, <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">int</span> (*removexattr) (<span class="keyword">struct</span> dentry *, <span class="type">const</span> <span class="type">char</span> *);</span><br><span class="line">    <span class="type">int</span> (*fiemap)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> fiemap_extent_info *, u64 start,</span><br><span class="line">              u64 len);</span><br><span class="line">    <span class="type">int</span> (*update_time)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> timespec *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*<span class="type">atomic_open</span>)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> dentry *,</span><br><span class="line">               <span class="keyword">struct</span> file *, <span class="type">unsigned</span> open_flag,</span><br><span class="line">               <span class="type">umode_t</span> create_mode, <span class="type">int</span> *opened);</span><br><span class="line">&#125; ____cacheline_aligned;</span><br></pre></td></tr></table></figure>

<h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><ul>
<li>文件对象描述进程怎样与一个打开文件进行交互。</li>
<li>几个进程可以同时访问一个文件，因此文件指针必须放在文件对象而不是索引节点对象中</li>
</ul>
<p><code>include/linux/fs.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span>   <span class="title">fu_llist</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>     <span class="title">fu_rcuhead</span>;</span></span><br><span class="line">    &#125; f_u;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span>     <span class="title">f_path</span>;</span>         <span class="comment">/* 文件对象通过f_path.dentry指针指向相关的目录项对象 */</span></span><br><span class="line">    <span class="comment">/* 目录项会指向相关的索引节点，索引节点会记录文件是否是脏的 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> f_dentry    f_path.dentry</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span>        *<span class="title">f_inode</span>;</span>   <span class="comment">/* cached value */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>    *<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Protects f_ep_links, f_flags, f_pos vs i_size in lseek SEEK_CUR.</span></span><br><span class="line"><span class="comment">     * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">spinlock_t</span>      f_lock;</span><br><span class="line">    <span class="type">atomic_long_t</span>       f_count;    <span class="comment">/* 记录使用文件对象的进程数 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        f_flags;</span><br><span class="line">    <span class="type">fmode_t</span>         f_mode;</span><br><span class="line">    <span class="type">loff_t</span>          f_pos;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>  <span class="title">f_owner</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>   *<span class="title">f_cred</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>    <span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">    u64         f_version;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="type">void</span>            *f_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line">    <span class="type">void</span>            *private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line">    <span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">f_ep_links</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">f_tfile_llink</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>    *<span class="title">f_mapping</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_WRITECOUNT</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> f_mnt_write_state;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="file-operations"><a href="#file-operations" class="headerlink" title="file_operations"></a>file_operations</h3><p><code>include/linux/fs.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span> <span class="comment">/* 用于指定拥有这个文件操作结构体的模块，通常取THIS_MODULE */</span></span><br><span class="line">    <span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="comment">/* 用于设置文件的偏移量。第一个参数指明要操作的文件，第二个参数为偏移量，第三个参数为开始偏移的位置（可取SEEK_SET,SEEK_CUR和SEEK_END之一）*/</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="comment">/* 从文件中读数据。第一个参数为源文件，第二个参数为目的字符串，第三个参数指明欲读数据的总字节数，第四个参数指明从源文件的某个偏移量处开始读数据。由系统调用read()调用 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="comment">/* 往文件里写数据。第一个参数为目的文件，第二个参数源字符串，第三个参数指明欲写数据的总字节数，第四个参数指明从目的文件的某个偏移量出开始写数据。由系统调用write()调用 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">ssize_t</span> (*aio_read) (<span class="keyword">struct</span> kiocb *, <span class="type">const</span> <span class="keyword">struct</span> iovec *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">loff_t</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*aio_write) (<span class="keyword">struct</span> kiocb *, <span class="type">const</span> <span class="keyword">struct</span> iovec *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">loff_t</span>);</span><br><span class="line">    <span class="comment">/* 启动一个异步I/O操作，引入它是为了支持io_submit()系统调用 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> (*readdir) (<span class="keyword">struct</span> file *, <span class="type">void</span> *, <span class="type">filldir_t</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*poll)</span> <span class="params">(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *)</span>;</span><br><span class="line">    <span class="comment">/* 检查是否在一个文件上有操作发生，如果没有则睡眠，知道该文件上有操作发生 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line">    <span class="comment">/* 将指定文件映射到指定的地址空间上。由系统调用mmap()调用 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="comment">/* 打开指定文件，并且将这个文件和指定的索引结点关联起来。由系统调用open()调用 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line">    <span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="comment">/* 释放以打开的文件，当打开文件的引用计数（f_count）为0时，该函数被调用 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line">    <span class="comment">/* 文件在缓冲的数据写回磁盘 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*aio_fsync) (<span class="keyword">struct</span> kiocb *, <span class="type">int</span> datasync);</span><br><span class="line">    <span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line">    <span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **);</span><br><span class="line">    <span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset, <span class="type">loff_t</span> len);</span><br><span class="line">    <span class="type">int</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Dentry"><a href="#Dentry" class="headerlink" title="Dentry"></a>Dentry</h2><p>VFS把每一个目录看作由若干个目录和文件组成的一个普通文件。</p>
<p>*** 本来inode中应该包括“目录节点”的名称，但由于硬链接的存在，导致一个物理文件可能有多个文件名，因此把和“目录节点”名称相关的部分从 inode 中分开，放在一个专门的 dentry 结构（目录项）中 ***<br>描述一个文件和一个名字的对应关系，或者说dentry就是一个“文件名”</p>
<p><img src="/images/vfs/dentry_1.jpg" alt="dentry_1.jpg"></p>
<ul>
<li>在内存中, 每个文件都至少有一个dentry(目录项)和inode(索引节点)结构</li>
<li>dentry记录着文件名，上级目录等信息，正是它形成了我们所看到的树状结构</li>
<li>有关该文件的组织和管理的信息主要存放inode里面，它记录着文件在存储介质上的位置与分布</li>
</ul>
<p><img src="/images/vfs/dentry_2.png" alt="dentry_2.png"></p>
<p><code>include/linux/fs.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line">    <span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> d_flags;       <span class="comment">/* protected by d_lock */</span></span><br><span class="line">    <span class="type">seqcount_t</span> d_seq;       <span class="comment">/* per dentry seqlock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span>    <span class="comment">/* lookup hash list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span>    <span class="comment">/* parent directory */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span>      <span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment">                     * negative */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> d_iname[DNAME_INLINE_LEN];    <span class="comment">/* small names */</span></span><br><span class="line">                  </span><br><span class="line">    <span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> d_count;       <span class="comment">/* protected by d_lock */</span></span><br><span class="line">                  </span><br><span class="line">    <span class="type">spinlock_t</span> d_lock;      <span class="comment">/* per dentry lock */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span>   <span class="comment">/* The root of the dentry tree */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> d_time;       <span class="comment">/* used by d_revalidate */</span></span><br><span class="line">    <span class="type">void</span> *d_fsdata;         <span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span>     <span class="comment">/* LRU list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span>   <span class="comment">/* child of parent list */</span></span><br><span class="line">    <span class="comment">/* 如果当前目录项是一个目录，那么该目录项通过这个字段加入到父目录的d_subdirs链表当中。这个字段中的next和prev指针分别指向父目录中的另外两个子目录 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span> <span class="comment">/* our children */</span></span><br><span class="line">    <span class="comment">/* 如果当前目录项是一个目录，那么该目录下所有的子目录（一级子目录）形成一个链表。该字段是这个链表的表头 */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span>  <span class="comment">/* inode alias list */</span></span><br><span class="line">        <span class="comment">/* 索引节点中的i_dentry指向了它目录项，目录项中的d_alias，d_inode又指会了索引节点对象</span></span><br><span class="line"><span class="comment">        一个inode可能对应多个目录项，所有的目录项形成一个链表。inode结构中的i_dentry即为这个链表的头结点。当前目录项以这个字段处于i_dentry链表中。该字段中的prev和next指针分别指向与该目录项同inode的其他两个（如果有的话）目录项 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">    &#125; d_u;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="dentry的四种状态"><a href="#dentry的四种状态" class="headerlink" title="dentry的四种状态"></a>dentry的四种状态</h3><ul>
<li>空闲状态（Free）<br>  该状态的目录对象不包括有效的信息，没有被vfs使用。</li>
<li>未使用状态（unused）<br>  该状态的目录对象还没有被内核使用。引用计数器<code>d_count</code>为0，<code>d_inode</code>字段仍然指向关联的索引节点，目录对象包含有效的信息。为了在必要时回收内存，它的内容可能被丢弃。</li>
<li>正在使用状态（in use）<br>  该状态的目录对象正在被内核使用。引用计数器<code>d_count</code>大于0，<code>d_inode</code>字段指向关联的索引节点，目录对象包含有效的信息，不能被丢弃。</li>
<li>负状态（negative）<br>  与目录对象关联的索引节点不存在，相应的磁盘索引节点已被删除。<code>d_inode</code>被置为NULL，该对象仍被保存在目录项高速缓存中，以便同一文件目录名的查找能够快速完成。</li>
</ul>
<h3 id="dentry-oprations"><a href="#dentry-oprations" class="headerlink" title="dentry_oprations"></a>dentry_oprations</h3><p><code>include/linux/dcache.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> (*d_revalidate)(<span class="keyword">struct</span> dentry *, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="comment">/* 该函数判断目录对象是否有效。VFS准备从dcache中使用一个目录项时，会调用该函数 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*d_weak_revalidate)(<span class="keyword">struct</span> dentry *, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*d_hash)(<span class="type">const</span> <span class="keyword">struct</span> dentry *, <span class="type">const</span> <span class="keyword">struct</span> inode *, <span class="keyword">struct</span> qstr *);</span><br><span class="line">    <span class="comment">/* 该目录生成散列值，当目录项要加入到散列表时，VFS要调用此函数 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> (*d_compare)(<span class="type">const</span> <span class="keyword">struct</span> dentry *, <span class="type">const</span> <span class="keyword">struct</span> inode *, <span class="type">const</span> <span class="keyword">struct</span> dentry *, <span class="type">const</span> <span class="keyword">struct</span> inode *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="keyword">struct</span> qstr *);</span><br><span class="line">    <span class="type">int</span> (*d_delete)(<span class="type">const</span> <span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="comment">/* 当d_count=0时，VFS调用次函数。使用该函数要加dcache_lock锁 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> (*d_release)(<span class="keyword">struct</span> dentry *);</span><br><span class="line">    <span class="comment">/* 当该目录对象将要被释放时，VFS调用该函数 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> (*d_prune)(<span class="keyword">struct</span> dentry *);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> (*d_iput)(<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> inode *);</span><br><span class="line">    <span class="comment">/* 当一个目录项丢失了其索引节点时，VFS就掉用该函数 */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *(*d_dname)(<span class="keyword">struct</span> dentry *, <span class="type">char</span> *, <span class="type">int</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *(*<span class="title">d_automount</span>)(<span class="keyword">struct</span> <span class="title">path</span> *);</span></span><br><span class="line">    <span class="type">int</span> (*d_manage)(<span class="keyword">struct</span> dentry *, <span class="type">bool</span>);</span><br><span class="line">&#125; ____cacheline_aligned;</span><br></pre></td></tr></table></figure>

<h3 id="Dentry定位文件"><a href="#Dentry定位文件" class="headerlink" title="Dentry定位文件"></a>Dentry定位文件</h3><p>首先，通过dir对应的dentry0找到inode0节点，有了inode节点就可以读取目录中的信息。其中包含了该目录包含的下一级目录与文件文件列表，包括name与inode号。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> <span class="built_in">ls</span> -i</span></span><br><span class="line">975248 subdir0  975247 subdir1   975251 file0</span><br></pre></td></tr></table></figure>

<p>然后，根据通过根据subdir0对应的inode号重建inode2，并通过文件数据（目录也是文件）与inode2重建subdir0的dentry节点：dentry1。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"> <span class="built_in">ls</span> -i</span></span><br><span class="line">975311 file1 975312 file2</span><br></pre></td></tr></table></figure>

<p>接着，根据file1对应的inode号重建inode4，并通过文件数据与inode4重建file1的dentry节点。最后，就可以通过inode4节点访问文件了。</p>
<p><img src="/images/vfs/dentry_3.png" alt="dentry_3.png"></p>
<h3 id="Dentry-Cache"><a href="#Dentry-Cache" class="headerlink" title="Dentry Cache"></a>Dentry Cache</h3><p>由于从硬盘读入一个目录项并构造相应的目录项对象需要花费大量的时间，也为了最大限度提高目处理这些录项对象的效率，VFS采用了dentry cache的设计。当有用户用ls命令查看某一个目录或用open命令打开一个文件时，VFS会为这里用的每个目录项与文件建立dentry项与inode，即“按需创建”。然后维护一个LRU（Least Recently Used）列表，当Linux认为VFS占用太多资源时，VFS会释放掉长时间没有被使用的dentry项与inode项。</p>
<p>这里的建立于释放是从内存占用的角度看。从Linux角度看，dentry与inode是VFS中固有的东西。所不同的只是VFS是否把dentry与inode读到了内存中。对于Ext2&#x2F;3文件系统，构建dentry与inode的过程非常简单，但对于其他文件系统，则会慢得多。</p>
<h2 id="Process-File"><a href="#Process-File" class="headerlink" title="Process &amp; File"></a>Process &amp; File</h2><p><img src="/images/vfs/file_1.png" alt="file_1.png"></p>
<p>task_struct (<code>include/linux/sched.h</code>)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="comment">/* CPU-specific state of this task */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> <span class="title">thread</span>;</span></span><br><span class="line"><span class="comment">/* filesystem information */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span>;</span></span><br><span class="line"><span class="comment">/* open file information */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span>;</span></span><br><span class="line"><span class="comment">/* namespaces */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nsproxy</span> *<span class="title">nsproxy</span>;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>进程控制块<code>task_struct</code>(<code>include/linux/sched.h</code>)中有两个变量与文件有关：<code>fs</code>(<code>struct fs_struct</code>)与<code>files</code>(<code>struct files_struct</code>)。</p>
<p>fs_struct (<code>include/linux/fs_struct.h</code>)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> users;</span><br><span class="line">    <span class="type">spinlock_t</span> lock;</span><br><span class="line">    <span class="type">seqcount_t</span> seq;</span><br><span class="line">    <span class="type">int</span> umask;</span><br><span class="line">    <span class="type">int</span> in_exec;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">root</span>, <span class="title">pwd</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>path (<code>include/liinux/path.h</code>)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span> &#123;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span>;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>fs</code>中存储着<code>root</code>与<code>pwd</code>两个指向<code>dentry</code>项的指针。用户定路径时，绝对路径会通过<code>root</code>进行定位；相对路径会通过<code>pwd</code>进行定位。进程的<code>root</code>不一定是文件系统的根目录。如ftp进程的根目录不是文件系统的根目录，这样才能保证用户只能访问ftp目录下的内容。<br><code>files</code>是一个file object列表，其中每一个节点对应着一个被打开了的文件。</p>
<p>files_struct (<code>include/linux/fdtable.h</code>)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> &#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * read mostly part</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="type">atomic_t</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> __<span class="title">rcu</span> *<span class="title">fdt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> <span class="title">fdtab</span>;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * written part on a separate cache line in SMP</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="type">spinlock_t</span> file_lock ____cacheline_aligned_in_smp;</span><br><span class="line">    <span class="type">int</span> next_fd;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> close_on_exec_init[<span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> open_fds_init[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> * <span class="title">fd_array</span>[<span class="title">NR_OPEN_DEFAULT</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当进程定位到文件时，会构造一个file object，并通过<code>f_inode</code>关联到<code>inode</code>节点。文件关闭时（close），进程会释放对应对应file object。</p>
<p>fdtable (<code>include/linux/fdtable.h</code>)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> max_fds;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> **<span class="title">fd</span>;</span>      <span class="comment">/* current fd array */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *close_on_exec;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *open_fds;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/images/vfs/file_2.jpg" alt="file_2.jpg"></p>
<p>fd数组第一个元素[0]是进程的标准输入文件；第二个元素[1]是进程的标准输出文件；第三个元素[2]是进程的标准错误文件。</p>
<h1 id="文件系统类型"><a href="#文件系统类型" class="headerlink" title="文件系统类型"></a>文件系统类型</h1><h2 id="特殊文件系统"><a href="#特殊文件系统" class="headerlink" title="特殊文件系统"></a>特殊文件系统</h2><table>
<thead>
<tr>
<th align="left">文件系统</th>
<th align="left">安装点</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">bdev</td>
<td align="left">无</td>
<td align="left">块设备</td>
</tr>
<tr>
<td align="left">binfmt_misc</td>
<td align="left">任意</td>
<td align="left">其他可执行格式</td>
</tr>
<tr>
<td align="left">devpts</td>
<td align="left">&#x2F;dev&#x2F;pts</td>
<td align="left">伪终端支持</td>
</tr>
<tr>
<td align="left">eventpollfs</td>
<td align="left">无</td>
<td align="left">由事件轮询机制使用</td>
</tr>
<tr>
<td align="left">futexfs</td>
<td align="left">无</td>
<td align="left">由futex（快速用户空间加锁）机制使用</td>
</tr>
<tr>
<td align="left">pipefs</td>
<td align="left">无</td>
<td align="left">管道</td>
</tr>
<tr>
<td align="left">proc</td>
<td align="left">&#x2F;proc</td>
<td align="left">对内核数据结构的常规访问点</td>
</tr>
<tr>
<td align="left">rootfs</td>
<td align="left">无</td>
<td align="left">为启动阶段提供一个空的根目录</td>
</tr>
<tr>
<td align="left">shm</td>
<td align="left">无</td>
<td align="left">IPC共享线性区</td>
</tr>
<tr>
<td align="left">mqueue</td>
<td align="left">任意</td>
<td align="left">实现POSIX消息队列时使用</td>
</tr>
<tr>
<td align="left">sockfs</td>
<td align="left">无</td>
<td align="left">套接字</td>
</tr>
<tr>
<td align="left">sysfs</td>
<td align="left">&#x2F;sys</td>
<td align="left">对系统数据的常规访问点</td>
</tr>
<tr>
<td align="left">tmpfs</td>
<td align="left">任意</td>
<td align="left">临时文件（若不被交换出去，则常驻内存中）</td>
</tr>
<tr>
<td align="left">usbfs</td>
<td align="left">&#x2F;proc&#x2F;bus&#x2F;usb</td>
<td align="left">USB设备</td>
</tr>
</tbody></table>
<p>内核给每个安装的特殊文件系统分配一个虚拟的块设备，让其主设备号为0，次设备号有任意值（每个特殊的文件系统有不同的值）</p>
<h2 id="文件系统类型注册"><a href="#文件系统类型注册" class="headerlink" title="文件系统类型注册"></a>文件系统类型注册</h2><p>文件系统的源码要么包含在内核映像中，要么作为一个模块被动态装入。每个注册的文件系统都用一个类型为<code>file_system_type</code>的对象来表示。<br>file_system_type (<code>include/linux/fs.h</code>)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;       <span class="comment">/* 文件系统名称 */</span></span><br><span class="line">    <span class="type">int</span> fs_flags;           <span class="comment">/* 文件系统类型标志 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_REQUIRES_DEV     1   <span class="comment">/* 文件系统必须位于物理磁盘设备上 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_BINARY_MOUNTDATA 2   <span class="comment">/* 文件系统使用的二进制安装数据 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_HAS_SUBTYPE      4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_USERNS_MOUNT     8   <span class="comment">/* Can be mounted by userns root */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_USERNS_DEV_MOUNT 16 <span class="comment">/* A userns mount does not imply MNT_NODEV */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FS_RENAME_DOES_D_MOVE   32768   <span class="comment">/* FS will handle d_move() during rename() internally. */</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *(*<span class="title">mount</span>) (<span class="keyword">struct</span> <span class="title">file_system_type</span> *, <span class="title">int</span>, <span class="title">const</span> <span class="title">char</span> *, <span class="title">void</span> *);</span></span><br><span class="line">    <span class="type">void</span> (*kill_sb) (<span class="keyword">struct</span> super_block *);     <span class="comment">/* 删除超级块的方法 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>                       <span class="comment">/* 指向实现文件系统的模块指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> * <span class="title">next</span>;</span>             <span class="comment">/* 指向文件系统类型链表下一个元素的指针 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">fs_supers</span>;</span>                <span class="comment">/* 具有相同文件系统类型的超级块对象链表的头*/</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_lock_key</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_umount_key</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_vfs_rename_key</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_writers_key</span>[<span class="title">SB_FREEZE_LEVELS</span>];</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">i_lock_key</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">i_mutex_key</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">i_mutex_dir_key</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>所有文件系统类型的对象都插入道一个单向链表中，由变量<code>file_systems</code>指向链表的第一个元素，<code>file_systems-&gt;next</code>指向链表的下一个元素。</p>
<p><code>int register_filesystem(struct file_system_type * fs)</code>[fs&#x2F;filesystems.c]<br>注册一个新的文件系统，传入要注册文件系统的结构体，在<code>file_systems</code>列表中查找受否与传入<code>fs-&gt;name</code>同名的文件系统，如果存在则返回找到的fs，若不存在将传入文件系统<code>fs</code>加入<code>file_systems</code>列表</p>
<p>对比一下<code>ramfs_fs_type</code>和<code>root_fs_type</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> <span class="title">ramfs_fs_type</span> =</span> &#123;</span><br><span class="line">    .name       = <span class="string">&quot;ramfs&quot;</span>,</span><br><span class="line">    .mount      = ramfs_mount,</span><br><span class="line">    .kill_sb    = ramfs_kill_sb,</span><br><span class="line">    .fs_flags   = FS_USERNS_MOUNT,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> <span class="title">rootfs_fs_type</span> =</span> &#123;</span><br><span class="line">    .name       = <span class="string">&quot;rootfs&quot;</span>,</span><br><span class="line">    .mount      = rootfs_mount,</span><br><span class="line">    .kill_sb    = kill_litter_super,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>发现<code>fs_flags = FS_USERNS_MOUNT</code>，这个flag似乎想告诉我们，ramfs是挂载到用户命名空间的，言外之意rootfs不是挂载到用户空间的，那便是内核空间喽。</p>
<h2 id="文件系统处理"><a href="#文件系统处理" class="headerlink" title="文件系统处理"></a>文件系统处理</h2><ul>
<li>每个文件系统都有自己的根目录</li>
<li>已安装文件系统的根目录隐藏了父文件系统的安装点目录原来的内容</li>
</ul>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>通常进程共享一个命名空间，位于系统的根文件系统且被init进程使用的已安装文件系统树。如果<code>clone()</code>系统调用以<code>CLONE_NEWNS</code>标志创建一个新进程，那么新进程将获取一个新的命名空间，新进程再创建的新新进程将继承新命名空间。</p>
<ul>
<li>fork<br>  fork创造的子进程是父进程的完整副本，复制了父亲进程的资源，包括内存的内容task_struct内容</li>
<li>vfork<br>  vfork创建的子进程与父进程共享数据段,而且由vfork()创建的子进程将先于父进程运行</li>
<li>clone<br>  有选择性的继承父进程的资源，可以选择像vfork一样和父进程共享一个虚存空间，可以不和父进程共享，甚至可以选择创造出来的进程和父进程不再是父子关系，而是兄弟关系。灵活性更强。</li>
</ul>
<h1 id="KeyPoint"><a href="#KeyPoint" class="headerlink" title="KeyPoint"></a>KeyPoint</h1><h2 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h2><ol>
<li>start_kernel[init&#x2F;main.c]</li>
<li>vfs_caches_init(totalram_pages)[fs&#x2F;dcache.c]</li>
<li>dcache_init()[fs&#x2F;dcache.c]<br> 初始化<code>dentry_cache</code>和<code>dentry_hashtable</code></li>
<li>inode_init()[fs&#x2F;inode.c]<br> 初始化<code>inode_cachep</code>和<code>inode_hashtable</code></li>
<li>files_init()[fs&#x2F;file_table.c]<br> 初始化<code>file_cachep</code>、<code>files_stat.max_files</code></li>
<li>mnt_init()[fs&#x2F;namespace.c]<br> 初始化<code>mnt_cache</code>,<code>mount_hashtable</code>,<code>mountpoint_hashtable</code><ol>
<li>sysfs_init()[fs&#x2F;sysfs&#x2F;mount.c]<br> 初始化<code>sysfs_dir_cachep</code><br> sysfs_inode_init()[s&#x2F;sysfs&#x2F;inode.c] -&gt; <code>bdi_init(&amp;sysfs_backing_dev_info)</code><br> <code>register_filesystem(&amp;sysfs_fs_type)</code><br> <code>sysfs_mnt = kern_mount(&amp;sysfs_fs_type)</code></li>
<li>init_root()[fs&#x2F;ramfs&#x2F;inode.c]<br> <code>bdi_init(&amp;ramfs_backing_dev_info)</code><br> <code>register_filesystem(&amp;rootfs_fs_type)</code></li>
<li>init_mount_tree()[fs&#x2F;namespace.c]<br> 挂载rootfs到<code>/</code> <code>mnt = vfs_kern_mount(type, 0, &quot;rootfs&quot;, NULL)</code><br> 创建namespace <code>ns = create_mnt_ns(mnt)</code><br> 设置<code>init_task</code>(PID&#x3D;0)命名空间 <code>init_task.nsproxy-&gt;mnt_ns = ns</code><br> 设置当前进程的<code>pwd</code>和<code>root</code> <code>set_fs_pwd(current-&gt;fs, &amp;root); set_fs_root(current-&gt;fs, &amp;root);</code></li>
</ol>
</li>
<li>bdev_cache_init()[fs&#x2F;block_dev.c]<br> 初始化<code>bdev_cachep</code><ol>
<li>mount bdev</li>
</ol>
</li>
<li>chrdev_init()[fs&#x2F;char_dev.c]<br> 初始化<code>cdev_map</code></li>
</ol>
<h2 id="Mount文件系统"><a href="#Mount文件系统" class="headerlink" title="Mount文件系统"></a>Mount文件系统</h2><p><img src="/images/vfs/mount_1.png" alt="mount_1.png"></p>
<p>mount时，linux先找到磁盘分区的super block，然后通过解析磁盘的inode table与file data，构建出自己的dentry列表与inode列表。需要注意的是，VFS实际上是按照Ext的方式进行构建的，所以两者非常相似（毕竟Ext是Linux的原生文件系统）。比如inode节点，Ext与VFS中都把文件管理结构称为inode，但实际上它们是不一样的。Ext的inode节点在磁盘上；VFS的inode节点在内存里。Ext-inode中的一些成员变量其实是没有用的，如引用计数等。保留它们的目的是为了与vfs-node保持一致。这样在用ext-inode节点构造vfs-inode节点时，就不需要一个一个赋值，只需一次内存拷贝即可。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/gatieme/article/details/51484562">Linux下0号进程的前世(init_task进程)今生(idle进程)—-Linux进程的管理与调度（五）</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009472553#articleHeader9">vfs基础</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/xmlrpc.php?r=blog/article&uid=28541347&id=4138031">Linux文件系统（三）——进程与VFS的关系</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/xmlrpc.php?r=blog/article&uid=28541347&id=4138028">linux文件系统（二）——VFS四个主要对象的实现</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/gatieme/article/details/51417488">Linux中fork，vfork和clone详解（区别与联系）</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/13/network/ssl-tls-layer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/13/network/ssl-tls-layer/" class="post-title-link" itemprop="url">SSL/TLS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-13 16:20:19" itemprop="dateCreated datePublished" datetime="2017-09-13T16:20:19+08:00">2017-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/ssl_tls/ssl_tls_protocol.png" alt="ssl_tls"></p>
<ul>
<li>SSL<br>  Secure Socket Layer，安全套接字层，为Netscape所研发，用以保障在Internet上数据传输之安全，利用数据加密(Encryption)技术，可确保数据在网络上之传输过程中不会被截取。当前版本为3.0。它已被广泛地用于Web浏览器与服务器之间的身份认证和加密数据传输。<br>  SSL协议位于TCP&#x2F;IP协议与各种应用层协议之间，为数据通讯提供安全支持。SSL协议可分为两层： SSL记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。 SSL握手协议（SSL Handshake Protocol）：它建立在SSL记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等</li>
<li>TLS<br>  Transport Layer Security，传输层安全协议，用于两个应用程序之间提供保密性和数据完整性。<br>  TLS 1.0是IETF（Internet Engineering Task Force，Internet工程任务组）制定的一种新的协议，它建立在SSL 3.0协议规范之上，是SSL 3.0的后续版本，可以理解为SSL 3.1，它是写入了 RFC 的。该协议由两层组成： TLS 记录协议（TLS Record）和 TLS 握手协议（TLS Handshake）。较低的层为 TLS 记录协议，位于某个可靠的传输协议（例如 TCP）上面。</li>
</ul>
<h1 id="TLS握手"><a href="#TLS握手" class="headerlink" title="TLS握手"></a>TLS握手</h1><p>TLS协议分为两部分：Handshake Protocol和Record Protocol。其中Handshake Protocol用来协商密钥，协议的大部分内容就是通信双方如何利用它来安全的协商出一份密钥。 Record Protocol则定义了传输的格式。</p>
<p>由于非对称加密的速度比较慢，所以它一般用于密钥交换，双方通过公钥算法协商出一份密钥，然后通过对称加密来通信，当然，为了保证数据的完整性，在加密前要先经过HMAC的处理。</p>
<p><img src="/images/ssl_tls/handshake.svg" alt="handshake"></p>
<p>TLS缺省只进行server端的认证，客户端的认证是可选的(<code>[</code> <code>]</code>中是可选项)。只进行server端的认证叫单向认证，server端客户端同时认证的叫双向认证。</p>
<h2 id="单向认证流程"><a href="#单向认证流程" class="headerlink" title="单向认证流程"></a>单向认证流程</h2><p><img src="/images/ssl_tls/single_handshake.jpg" alt="single-handshake"></p>
<ol>
<li>客户端向服务端发送SSL协议版本号、加密算法种类、随机数等信息。</li>
<li>服务端给客户端返回SSL协议版本号、加密算法种类、随机数等信息，同时也返回服务器端的证书，即公钥证书</li>
<li>客户端使用服务端返回的信息验证服务器的合法性，包括：<br> 证书是否过期<br> 发型服务器证书的CA是否可靠<br> 返回的公钥是否能正确解开返回证书中的数字签名<br> 服务器证书上的域名是否和服务器的实际域名相匹配<br> 验证通过后，将继续进行通信，否则，终止通信</li>
<li>客户端向服务端发送自己所能支持的对称加密方案，供服务器端进行选择</li>
<li>服务器端在客户端提供的加密方案中选择加密程度最高的加密方式。</li>
<li>服务器将选择好的加密方案通过明文方式返回给客户端</li>
<li>客户端接收到服务端返回的加密方式后，使用该加密方式生成产生随机码，用作通信过程中对称加密的密钥，使用服务端返回的公钥进行加密，将加密后的随机码发送至服务器</li>
<li>服务器收到客户端返回的加密信息后，使用自己的私钥进行解密，获取对称加密密钥。 </li>
<li>在接下来的会话中，服务器和客户端将会使用该密码进行对称加密，保证通信过程中信息的安全。</li>
</ol>
<h2 id="双向认证流程"><a href="#双向认证流程" class="headerlink" title="双向认证流程"></a>双向认证流程</h2><p><img src="/images/ssl_tls/double_handshake.jpg" alt="double-handshake"></p>
<ol>
<li>客户端向服务端发送SSL协议版本号、加密算法种类、随机数等信息。</li>
<li>服务端给客户端返回SSL协议版本号、加密算法种类、随机数等信息，同时也返回服务器端的证书，即公钥证书</li>
<li>客户端使用服务端返回的信息验证服务器的合法性，包括：<br> 证书是否过期<br> 发型服务器证书的CA是否可靠<br> 返回的公钥是否能正确解开返回证书中的数字签名<br> 服务器证书上的域名是否和服务器的实际域名相匹配<br> 验证通过后，将继续进行通信，否则，终止通信</li>
<li>服务端要求客户端发送客户端的证书，客户端会将自己的证书发送至服务端</li>
<li>验证客户端的证书，通过验证后，会获得客户端的公钥</li>
<li>客户端向服务端发送自己所能支持的对称加密方案，供服务器端进行选择</li>
<li>服务器端在客户端提供的加密方案中选择加密程度最高的加密方式</li>
<li>将加密方案通过使用之前获取到的公钥进行加密，返回给客户端</li>
<li>客户端收到服务端返回的加密方案密文后，使用自己的私钥进行解密，获取具体加密方式，而后，产生该加密方式的随机码，用作加密过程中的密钥，使用之前从服务端证书中获取到的公钥进行加密后，发送给服务端</li>
<li>服务端收到客户端发送的消息后，使用自己的私钥进行解密，获取对称加密的密钥，在接下来的会话中，服务器和客户端将会使用该密码进行对称加密，保证通信过程中信息的安全。</li>
</ol>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/duanbokan/article/details/50847612">Https单向认证和双向认证</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000002554673">SSL&#x2F;TLS原理详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/Anker/p/6018032.html">基于openssl的单向和双向认证</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/13/security/certificate-theory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/13/security/certificate-theory/" class="post-title-link" itemprop="url">证书、签名、密钥那些事儿</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-13 14:59:55" itemprop="dateCreated datePublished" datetime="2017-09-13T14:59:55+08:00">2017-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/security/" itemprop="url" rel="index"><span itemprop="name">security</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我对这些问题的理解，一直是模模糊糊的，很多细节搞不清楚。网上看到一篇文章<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html">《数字签名是什么？》</a>，发现思路一下子就理清了。为了加深记忆，我把文字和图片都复制过来。</p>
<p><img src="/images/certificate_theory/keys_1.png" alt="keys_1"></p>
<p><img src="/images/certificate_theory/keys_2.png" alt="keys_2"></p>
<p><img src="/images/certificate_theory/keys_3.png" alt="keys_3"></p>
<p><img src="/images/certificate_theory/keys_4.png" alt="keys_4"></p>
<p>鲍勃收信后，用私钥解密，就看到了信件内容。这里要强调的是，只要鲍勃的私钥不泄露，这封信就是安全的，即使落在别人手里，也无法解密。</p>
<p><img src="/images/certificate_theory/sign_1.png" alt="sign_1"></p>
<p>鲍勃给苏珊回信，决定采用”数字签名”。他写完后先用Hash函数，生成信件的摘要（digest）。</p>
<p><img src="/images/certificate_theory/sign_2.png" alt="sign_2"></p>
<p><img src="/images/certificate_theory/sign_3.png" alt="sign_3"></p>
<p><img src="/images/certificate_theory/sign_4.png" alt="sign_4"></p>
<p><img src="/images/certificate_theory/sign_5.png" alt="sign_5"></p>
<p>苏珊再对信件本身使用Hash函数，将得到的结果，与上一步得到的摘要进行对比。如果两者一致，就证明这封信未被修改过。</p>
<p><img src="/images/certificate_theory/cert_1.png" alt="cert_1"></p>
<p>复杂的情况出现了。道格想欺骗苏珊，他偷偷使用了苏珊的电脑，用自己的公钥换走了鲍勃的公钥。此时，苏珊实际拥有的是道格的公钥，但是还以为这是鲍勃的公钥。因此，道格就可以冒充鲍勃，用自己的私钥做成”数字签名”，写信给苏珊，让苏珊用假的鲍勃公钥进行解密。</p>
<p><img src="/images/certificate_theory/cert_2.png" alt="cert_2"></p>
<p>后来，苏珊感觉不对劲，发现自己无法确定公钥是否真的属于鲍勃。她想到了一个办法，要求鲍勃去找”证书中心”（certificate authority，简称CA），为公钥做认证。证书中心用自己的私钥，对鲍勃的公钥和一些相关信息一起加密，生成”数字证书”（Digital Certificate）。</p>
<p><img src="/images/certificate_theory/cert_3.png" alt="cert_3"></p>
<p>鲍勃拿到数字证书以后，就可以放心了。以后再给苏珊写信，只要在签名的同时，再附上数字证书就行了。</p>
<p><img src="/images/certificate_theory/cert_4.png" alt="cert_4"></p>
<p>苏珊收信后，用CA的公钥解开数字证书，就可以拿到鲍勃真实的公钥了，然后就能证明”数字签名”是否真的是鲍勃签的。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html">数字签名是什么？</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/08/network/tcpdump-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/08/network/tcpdump-usage/" class="post-title-link" itemprop="url">tcpdump用法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-08 09:17:38" itemprop="dateCreated datePublished" datetime="2017-09-08T09:17:38+08:00">2017-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/tcpdump/logo.png" alt="tcpdump"></p>
<p><a target="_blank" rel="noopener" href="http://www.tcpdump.org/">TcpDump</a>可以将网络中传送的数据包完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供and、or、not等逻辑语句来帮助你去掉无用的信息。</p>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><p><code>tcpdump &lt;参数s&gt; &lt;包过滤表达式&gt;</code></p>
<ul>
<li>参数<br>  详细请见<code>man tcpdump</code></li>
<li>包过滤表达式<br>  详细请见<code>man pcap-filter</code></li>
</ul>
<h2 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h2><ul>
<li><code>-A</code> 以ASCII格式打印出所有分组，并将链路层的头最小化。 </li>
<li><code>-c</code> 在收到指定的数量的分组后，tcpdump就会停止。 </li>
<li><code>-C</code> 在将一个原始分组写入文件之前，检查文件当前的大小是否超过了参数file_size 中指定的大小。如果超过了指定大小，则关闭当前文件，然后在打开一个新的文件。参数 file_size 的单位是兆字节（是1,000,000字节，而不是1,048,576字节）。 </li>
<li><code>-d</code> 将匹配信息包的代码以人们能够理解的汇编格式给出。 </li>
<li><code>-dd</code> 将匹配信息包的代码以C语言程序段的格式给出。 </li>
<li><code>-ddd</code> 将匹配信息包的代码以十进制的形式给出。 </li>
<li><code>-D</code> 打印出系统中所有可以用tcpdump截包的网络接口。 </li>
<li><code>-e</code> 在输出行打印出数据链路层的头部信息。 </li>
<li><code>-E</code> 用spi@ipaddr algo:secret解密那些以addr作为地址，并且包含了安全参数索引值spi的IPsec ESP分组。 </li>
<li><code>-f</code> 将外部的Internet地址以数字的形式打印出来。 </li>
<li><code>-F</code> 从指定的文件中读取表达式，忽略命令行中给出的表达式。 </li>
<li><code>-i</code> 指定监听的网络接口。 </li>
<li><code>-l</code> 使标准输出变为缓冲行形式，可以把数据导出到文件。 </li>
<li><code>-L</code> 列出网络接口的已知数据链路。 </li>
<li><code>-m</code> 从文件module中导入SMI MIB模块定义。该参数可以被使用多次，以导入多个MIB模块。 </li>
<li><code>-M</code> 如果tcp报文中存在TCP-MD5选项，则需要用secret作为共享的验证码用于验证TCP-MD5选选项摘要（详情可参考RFC 2385）。 </li>
<li><code>-b</code> 在数据-链路层上选择协议，包括ip、arp、rarp、ipx都是这一层的。</li>
<li><code>-n</code> 不把网络地址转换成名字。</li>
<li><code>-nn</code> 不进行端口名称的转换。</li>
<li><code>-N</code> 不输出主机名中的域名部分。例如，‘nic.ddn.mil‘只输出’nic‘。 </li>
<li><code>-t</code> 在输出的每一行不打印时间戳。 </li>
<li><code>-O</code> 不运行分组分组匹配（packet-matching）代码优化程序。 </li>
<li><code>-P</code> 不将网络接口设置成混杂模式。 </li>
<li><code>-q</code> 快速输出。只输出较少的协议信息。 </li>
<li><code>-r</code> 从指定的文件中读取包(这些包一般通过-w选项产生)。 </li>
<li><code>-S</code> 将tcp的序列号以绝对值形式输出，而不是相对值。 </li>
<li><code>-s</code> 从每个分组中读取最开始的snaplen个字节，而不是默认的68个字节，一般设置为0，即65535字节。(抓包长度)</li>
<li><code>-T</code> 将监听到的包直接解释为指定的类型的报文，常见的类型有rpc远程过程调用）和snmp（简单网络管理协议；）。 </li>
<li><code>-t</code> 不在每一行中输出时间戳。 </li>
<li><code>-tt</code> 在每一行中输出非格式化的时间戳。 </li>
<li><code>-ttt</code> 输出本行和前面一行之间的时间差。 </li>
<li><code>-tttt</code> 在每一行中输出由date处理的默认格式的时间戳。 </li>
<li><code>-u</code> 输出未解码的NFS句柄。 </li>
<li><code>-v</code> 输出一个稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息。 </li>
<li><code>-vv</code> 输出详细的报文信息。 </li>
<li><code>-w</code> 直接将分组写入文件中，而不是不分析并打印出来。</li>
</ul>
<h2 id="包过滤表达式"><a href="#包过滤表达式" class="headerlink" title="包过滤表达式"></a>包过滤表达式</h2><p>tcpdump利用它作为过滤报文的条件，如果一个报文满足表 达式的条件，则这个报文将会被捕获。如果没有给出任何条件，则网络上所有的信息包 将会被截获。</p>
<p>表达式类型关键字：</p>
<ul>
<li>type<br>  主要包括host，net，port，例如 host 210.27.48.2， 指明 210.27.48.2是一台主机，net 202.0.0.0指明202.0.0.0是一个网络地址，port 23 指明端口号是23。如果没有指定类型，缺省的类型是host。</li>
<li>dir<br>  主要包括src，dst，dst or src，dst and src， 这些关键字指明了传输的方向。举例说明，src 210.27.48.2 ，指明ip包中源地址是 210.27.48.2 ， dst net 202.0.0.0 指明目的网络地址是202.0.0.0。如果没有指明 方向关键字，则缺省是src or dst关键字。</li>
<li>proto<br>  主要包括fddi，ip，arp，rarp，tcp，udp等类型。Fddi指明是在FDDI (分布式光纤数据接口网络)上的特定的网络协议，实际上它是”ether”的别名，fddi和ether 具有类似的源地址和目的地址，所以可以将fddi协议包当作ether的包进行处理和分析。 其他的几个关键字就是指明了监听的包的协议内容。如果没有指定任何协议，则tcpdump 将会 监听所有协议的信息包。</li>
</ul>
<p>除了这三种类型的关键字之外，其他重要的关键字如下：gateway， broadcast，less， greater， 还有三种逻辑运算，取非运算是<code>not</code> <code>!</code>，与运算是<code>and</code>，<code>&amp;&amp;</code>，或运算是<code>or</code>，这些关键字可以组合起来构成强大的组合条件来满足人们的需要。</p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><h4 id="查看HTTP请求响应头以及数据"><a href="#查看HTTP请求响应头以及数据" class="headerlink" title="查看HTTP请求响应头以及数据"></a>查看HTTP请求响应头以及数据</h4><p><code>sudo tcpdump -A -s 0 &#39;tcp port 80 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)&#39;</code></p>
<p>proto [ expr : size ]<br>Proto 是 ether, fddi, tr, ip, arp, rarp, tcp, udp, icmp or ip6中的一个，它为索引操作指明了协议层。注意，tcp,udp和其他较高层的协议类型只能应用于IPv4，而不能用于IPv6(这个问题可能在将来能得到解决)。被指定的协议层的字节偏移量由expr给出。Size是可选的，它指明了数据域中，我们所感兴趣的字节数。它可以是1，2，或4，默认为1。运算符的长度，由关键字len给出，指明了数据包的长度。<br>例如，<code>ether[0] &amp; 1 != 0</code>会捕捉所有的多播数据流。表达式<code>ip[0] &amp; 0xf != 5</code>能捕捉所有带可选域的IP数据包。表达式<code>ip[6:2] &amp; 0x1fff = 0</code>仅捕捉未分段的数据报和段偏移量是0的数据报。这个检查隐含在tcp和udp的下标操作中。例如，tcp[0]通常指第一个字节的TCP首部，而不是指第一个字节的分段。<br>有些偏移量和域值可以以名字来表示，而不是数值。以下协议首部域的偏移量是正确的：icmptype (ICMP 类型域), icmpcode (ICMP 代码域), and tcpflags (TCP 标志域)。<br>ICMP 类型域有以下这些： icmp-echoreply, icmp-unreach, icmp-sourcequench, icmp-redirect, icmp-echo, icmp-routeradvert, icmp-routersolicit, icmp-timxceed, icmp-paramprob, icmp-tstamp, icmp-tstampreply, icmp-ireq, icmp-ireqreply, icmp-maskreq, icmp-maskreply.<br>TCP 标志域有以下这些： tcp-fin, tcp-syn, tcp-rst, tcp-push, tcp-push, tcp-ack, tcp-urg.</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/s_k_yliu/article/details/6665673/">TCPdump抓包命令详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/3cca9a74927c">使用tcpdump查看HTTP请求响应</a></li>
<li><a target="_blank" rel="noopener" href="http://www.360doc.com/content/17/0908/11/47158879_685473123.shtml">PCAP数据包过滤器设置 及 过滤表达式语法</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/achejq/article/details/7040687">IP头结构详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP协议详解</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">博</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">147</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">123</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
