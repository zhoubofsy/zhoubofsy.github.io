<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/page/8/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="博">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/page/8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/08/network/tcpdump-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/08/network/tcpdump-usage/" class="post-title-link" itemprop="url">tcpdump用法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-08 09:17:38" itemprop="dateCreated datePublished" datetime="2017-09-08T09:17:38+08:00">2017-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/tcpdump/logo.png" alt="tcpdump"></p>
<p><a target="_blank" rel="noopener" href="http://www.tcpdump.org/">TcpDump</a>可以将网络中传送的数据包完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供and、or、not等逻辑语句来帮助你去掉无用的信息。</p>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><p><code>tcpdump &lt;参数s&gt; &lt;包过滤表达式&gt;</code></p>
<ul>
<li>参数<br>  详细请见<code>man tcpdump</code></li>
<li>包过滤表达式<br>  详细请见<code>man pcap-filter</code></li>
</ul>
<h2 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h2><ul>
<li><code>-A</code> 以ASCII格式打印出所有分组，并将链路层的头最小化。 </li>
<li><code>-c</code> 在收到指定的数量的分组后，tcpdump就会停止。 </li>
<li><code>-C</code> 在将一个原始分组写入文件之前，检查文件当前的大小是否超过了参数file_size 中指定的大小。如果超过了指定大小，则关闭当前文件，然后在打开一个新的文件。参数 file_size 的单位是兆字节（是1,000,000字节，而不是1,048,576字节）。 </li>
<li><code>-d</code> 将匹配信息包的代码以人们能够理解的汇编格式给出。 </li>
<li><code>-dd</code> 将匹配信息包的代码以C语言程序段的格式给出。 </li>
<li><code>-ddd</code> 将匹配信息包的代码以十进制的形式给出。 </li>
<li><code>-D</code> 打印出系统中所有可以用tcpdump截包的网络接口。 </li>
<li><code>-e</code> 在输出行打印出数据链路层的头部信息。 </li>
<li><code>-E</code> 用spi@ipaddr algo:secret解密那些以addr作为地址，并且包含了安全参数索引值spi的IPsec ESP分组。 </li>
<li><code>-f</code> 将外部的Internet地址以数字的形式打印出来。 </li>
<li><code>-F</code> 从指定的文件中读取表达式，忽略命令行中给出的表达式。 </li>
<li><code>-i</code> 指定监听的网络接口。 </li>
<li><code>-l</code> 使标准输出变为缓冲行形式，可以把数据导出到文件。 </li>
<li><code>-L</code> 列出网络接口的已知数据链路。 </li>
<li><code>-m</code> 从文件module中导入SMI MIB模块定义。该参数可以被使用多次，以导入多个MIB模块。 </li>
<li><code>-M</code> 如果tcp报文中存在TCP-MD5选项，则需要用secret作为共享的验证码用于验证TCP-MD5选选项摘要（详情可参考RFC 2385）。 </li>
<li><code>-b</code> 在数据-链路层上选择协议，包括ip、arp、rarp、ipx都是这一层的。</li>
<li><code>-n</code> 不把网络地址转换成名字。</li>
<li><code>-nn</code> 不进行端口名称的转换。</li>
<li><code>-N</code> 不输出主机名中的域名部分。例如，‘nic.ddn.mil‘只输出’nic‘。 </li>
<li><code>-t</code> 在输出的每一行不打印时间戳。 </li>
<li><code>-O</code> 不运行分组分组匹配（packet-matching）代码优化程序。 </li>
<li><code>-P</code> 不将网络接口设置成混杂模式。 </li>
<li><code>-q</code> 快速输出。只输出较少的协议信息。 </li>
<li><code>-r</code> 从指定的文件中读取包(这些包一般通过-w选项产生)。 </li>
<li><code>-S</code> 将tcp的序列号以绝对值形式输出，而不是相对值。 </li>
<li><code>-s</code> 从每个分组中读取最开始的snaplen个字节，而不是默认的68个字节，一般设置为0，即65535字节。(抓包长度)</li>
<li><code>-T</code> 将监听到的包直接解释为指定的类型的报文，常见的类型有rpc远程过程调用）和snmp（简单网络管理协议；）。 </li>
<li><code>-t</code> 不在每一行中输出时间戳。 </li>
<li><code>-tt</code> 在每一行中输出非格式化的时间戳。 </li>
<li><code>-ttt</code> 输出本行和前面一行之间的时间差。 </li>
<li><code>-tttt</code> 在每一行中输出由date处理的默认格式的时间戳。 </li>
<li><code>-u</code> 输出未解码的NFS句柄。 </li>
<li><code>-v</code> 输出一个稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息。 </li>
<li><code>-vv</code> 输出详细的报文信息。 </li>
<li><code>-w</code> 直接将分组写入文件中，而不是不分析并打印出来。</li>
</ul>
<h2 id="包过滤表达式"><a href="#包过滤表达式" class="headerlink" title="包过滤表达式"></a>包过滤表达式</h2><p>tcpdump利用它作为过滤报文的条件，如果一个报文满足表 达式的条件，则这个报文将会被捕获。如果没有给出任何条件，则网络上所有的信息包 将会被截获。</p>
<p>表达式类型关键字：</p>
<ul>
<li>type<br>  主要包括host，net，port，例如 host 210.27.48.2， 指明 210.27.48.2是一台主机，net 202.0.0.0指明202.0.0.0是一个网络地址，port 23 指明端口号是23。如果没有指定类型，缺省的类型是host。</li>
<li>dir<br>  主要包括src，dst，dst or src，dst and src， 这些关键字指明了传输的方向。举例说明，src 210.27.48.2 ，指明ip包中源地址是 210.27.48.2 ， dst net 202.0.0.0 指明目的网络地址是202.0.0.0。如果没有指明 方向关键字，则缺省是src or dst关键字。</li>
<li>proto<br>  主要包括fddi，ip，arp，rarp，tcp，udp等类型。Fddi指明是在FDDI (分布式光纤数据接口网络)上的特定的网络协议，实际上它是”ether”的别名，fddi和ether 具有类似的源地址和目的地址，所以可以将fddi协议包当作ether的包进行处理和分析。 其他的几个关键字就是指明了监听的包的协议内容。如果没有指定任何协议，则tcpdump 将会 监听所有协议的信息包。</li>
</ul>
<p>除了这三种类型的关键字之外，其他重要的关键字如下：gateway， broadcast，less， greater， 还有三种逻辑运算，取非运算是<code>not</code> <code>!</code>，与运算是<code>and</code>，<code>&amp;&amp;</code>，或运算是<code>or</code>，这些关键字可以组合起来构成强大的组合条件来满足人们的需要。</p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><h4 id="查看HTTP请求响应头以及数据"><a href="#查看HTTP请求响应头以及数据" class="headerlink" title="查看HTTP请求响应头以及数据"></a>查看HTTP请求响应头以及数据</h4><p><code>sudo tcpdump -A -s 0 &#39;tcp port 80 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)&#39;</code></p>
<p>proto [ expr : size ]<br>Proto 是 ether, fddi, tr, ip, arp, rarp, tcp, udp, icmp or ip6中的一个，它为索引操作指明了协议层。注意，tcp,udp和其他较高层的协议类型只能应用于IPv4，而不能用于IPv6(这个问题可能在将来能得到解决)。被指定的协议层的字节偏移量由expr给出。Size是可选的，它指明了数据域中，我们所感兴趣的字节数。它可以是1，2，或4，默认为1。运算符的长度，由关键字len给出，指明了数据包的长度。<br>例如，<code>ether[0] &amp; 1 != 0</code>会捕捉所有的多播数据流。表达式<code>ip[0] &amp; 0xf != 5</code>能捕捉所有带可选域的IP数据包。表达式<code>ip[6:2] &amp; 0x1fff = 0</code>仅捕捉未分段的数据报和段偏移量是0的数据报。这个检查隐含在tcp和udp的下标操作中。例如，tcp[0]通常指第一个字节的TCP首部，而不是指第一个字节的分段。<br>有些偏移量和域值可以以名字来表示，而不是数值。以下协议首部域的偏移量是正确的：icmptype (ICMP 类型域), icmpcode (ICMP 代码域), and tcpflags (TCP 标志域)。<br>ICMP 类型域有以下这些： icmp-echoreply, icmp-unreach, icmp-sourcequench, icmp-redirect, icmp-echo, icmp-routeradvert, icmp-routersolicit, icmp-timxceed, icmp-paramprob, icmp-tstamp, icmp-tstampreply, icmp-ireq, icmp-ireqreply, icmp-maskreq, icmp-maskreply.<br>TCP 标志域有以下这些： tcp-fin, tcp-syn, tcp-rst, tcp-push, tcp-push, tcp-ack, tcp-urg.</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/s_k_yliu/article/details/6665673/">TCPdump抓包命令详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/3cca9a74927c">使用tcpdump查看HTTP请求响应</a></li>
<li><a target="_blank" rel="noopener" href="http://www.360doc.com/content/17/0908/11/47158879_685473123.shtml">PCAP数据包过滤器设置 及 过滤表达式语法</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/achejq/article/details/7040687">IP头结构详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/ef892323e68f">TCP协议详解</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/09/04/bigdata/hadoop/hive-load-from-hbase/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/09/04/bigdata/hadoop/hive-load-from-hbase/" class="post-title-link" itemprop="url">从hbase向hive导入数据</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-09-04 09:51:00" itemprop="dateCreated datePublished" datetime="2017-09-04T09:51:00+08:00">2017-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Big-Data/" itemprop="url" rel="index"><span itemprop="name">Big-Data</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>** 纯转载 **</p>
<p>当我们用HBase 存储实时数据的时候， 如果要做一些数据分析方面的操作， 就比较困难了， 要写MapReduce Job。 Hive 主要是用来做数据分析的数据仓库，支持标准SQL 查询， 做数据分析很是方便，于是便很自然地想到用Hive来载入HBase的数据做分析， 但是很奇怪地是， 上网查了一下， 只看到以下两种情况：</p>
<ol>
<li>如何用Hive 往HBase里面插入大量的数据。</li>
<li>Hive 与HBase集成， 直接从Hive里面连HBase的数据库进行查询。参考链接： <a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/HBaseIntegration">https://cwiki.apache.org/confluence/display/Hive/HBaseIntegration</a></li>
</ol>
<p>选项1是我们需求的逆操作， 直接忽略， 选项2,  虽然没有做专门的Benchmark, 但总感觉直接对HBase进行查询操作不怎么靠谱， 如果我们要频繁做很多类型的数据分析， 那HBase的压力一定会倍增。<br>难道没有把HBase里面的数据直接导入到Hive当中的工具或者方法吗？<br>找了一会， 似乎没找到， 那么只好自己想一个解决方案了。</p>
<p>思路：<br>利用选项2,  先打通Hive对HBase指定表的全表访问， 再建立一个新的空表， 把查询出来的数据全部导入到新表当中， 以后的所有数据分析操作在新表中完成。<br>说干就干， 让我们试一个简单的例子。</p>
<ul>
<li>首先在HBase里面建一个表， 名为 student， 包含 id 和 name 两个column  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hbase shell</span><br><span class="line">create &#x27;student&#x27;, &#x27;id&#x27;, &#x27;name&#x27;</span><br></pre></td></tr></table></figure></li>
<li>向表中插入两行数据  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">put &#x27;student&#x27;, &#x27;row1&#x27;, &#x27;id:val&#x27;, &#x27;1&#x27;</span><br><span class="line">put &#x27;student&#x27;, &#x27;row1&#x27;, &#x27;name:val&#x27;, &#x27;Tony&#x27;</span><br><span class="line">put &#x27;student&#x27;, &#x27;row2&#x27;, &#x27;id:val&#x27;, &#x27;2&#x27;</span><br><span class="line">put &#x27;student&#x27;, &#x27;row2&#x27;, &#x27;name:val&#x27;, &#x27;Mike&#x27;</span><br></pre></td></tr></table></figure>
  注意：在插入数据的时候一定要指定column (如id:val, name:val) 直接使用column family (如 id, name) 去存数据会导致后面Hive 建表的时候有问题。</li>
<li>扫描此表， 确定数据已经插入  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scan &#x27;student&#x27;</span><br><span class="line">ROW                               COLUMN+CELL                                                                                     </span><br><span class="line"> row1                             column=id:val, timestamp=1384939342989, value=1                                                 </span><br><span class="line"> row1                             column=name:val, timestamp=1384939365511, value=Tony                                            </span><br><span class="line"> row2                             column=id:val, timestamp=1384939351444, value=2                                                 </span><br><span class="line"> row2                             column=name:val, timestamp=1384939379245, value=Mike</span><br></pre></td></tr></table></figure></li>
<li>从Hive建立可以访问HBase的外部表  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTERNAL TABLE student(key string, id int, name string) </span><br><span class="line">STORED BY &#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span><br><span class="line">WITH SERDEPROPERTIES (&quot;hbase.columns.mapping&quot; = &quot;id:val,name:val&quot;)</span><br><span class="line">TBLPROPERTIES(&quot;hbase.table.name&quot; = &quot;student&quot;);</span><br></pre></td></tr></table></figure></li>
<li>Hive中建立一个新的空表  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">hive&gt; </span><span class="language-bash"><span class="keyword">select</span> * from student;</span></span><br><span class="line">OK</span><br><span class="line">row1    1    Tony</span><br><span class="line">row2    2    Mike</span><br></pre></td></tr></table></figure>
  但是此时这个表实际上是一个虚拟表， 实际的数据还在HBase中。 下面需要在Hive中另建一个结构一样的空表， 再把数据导出来。</li>
<li>Hive中建立一个新的空表  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE new_student (</span><br><span class="line">  key string,</span><br><span class="line">  id INT,</span><br><span class="line">  name STRING)</span><br><span class="line">ROW FORMAT DELIMITED</span><br><span class="line">FIELDS TERMINATED BY &#x27;\t&#x27;</span><br><span class="line">STORED AS TEXTFILE;</span><br></pre></td></tr></table></figure></li>
<li>将数据从HBase中导入到新的Hive表中  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">hive&gt; </span><span class="language-bash">INSERT OVERWRITE TABLE new_student SELECT * FROM student;</span></span><br><span class="line"><span class="meta prompt_">hive&gt; </span><span class="language-bash"><span class="keyword">select</span> * from new_student;</span></span><br><span class="line">OK</span><br><span class="line">row1    1    Tony</span><br><span class="line">row2    2    Mike</span><br></pre></td></tr></table></figure>
至此大功告成！<br>以后所有复杂的数据查询和数据分析都可以在new_student表中完成。</li>
</ul>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/npumenglei/p/how_to_use_hive_load_data_from_hbase.html">Hive如何加载和导入HBase的数据</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/lifuxiangcaohui/article/details/40588929">Hive总结（七）Hive四种数据导入方式</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/08/31/apple/xhyve-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/08/31/apple/xhyve-usage/" class="post-title-link" itemprop="url">xhyve使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-08-31 10:38:30" itemprop="dateCreated datePublished" datetime="2017-08-31T10:38:30+08:00">2017-08-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/apple/" itemprop="url" rel="index"><span itemprop="name">apple</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/xhyve/xhyve_logo.png" alt="xhyve_logo"></p>
<p>FreeBSD 下的虚拟技术 bhyve (The BSD Hypervisor) 是去年1月份正式发布的，包含在了 FreeBSD 10.0 发行版中。今天要玩的这个 xhyve 是基于 bhyve 的 Mac OS X 移植版本，也就是说我们想在 Mac 上运行 Linux 的话除了 VirtualBox, VMware Fusion 外，现在有了第三种选择。</p>
<p>xhyve is a lightweight virtualization solution for OS X that is capable of running Linux. It is a port of FreeBSD’s bhyve, a KVM+QEMU alternative written by Peter Grehan and Neel Natu.</p>
<p>特点：</p>
<ul>
<li>super lightweight, only 230 KB in size</li>
<li>completely standalone, no dependencies</li>
<li>the only BSD-licensed virtualizer on OS X</li>
<li>does not require a kernel extension (bhyve’s kernel code was ported to user mode code calling into Hypervisor.framework)</li>
<li>multi-CPU support</li>
<li>networking support</li>
<li>can run off-the-shelf Linux distributions (and could be extended to run other operating systems)</li>
</ul>
<p>xhyve may make a good solution for running Docker on your Mac, for instance.</p>
<h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><p>search xhyver:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew info xhyve</span></span><br><span class="line">xhyve: stable 0.2.0 (bottled), HEAD</span><br><span class="line">xhyve, lightweight macOS virtualization solution based on FreeBSD&#x27;s bhyve</span><br><span class="line">https://github.com/mist64/xhyve</span><br><span class="line">/usr/local/Cellar/xhyve/HEAD-1f1dbe3 (11 files, 11.2MB) *</span><br><span class="line">  Built from source on 2017-08-24 at 12:12:21</span><br><span class="line">From: https://github.com/Homebrew/homebrew-core/blob/master/Formula/xhyve.rb</span><br><span class="line">==&gt; Requirements</span><br><span class="line">Required: macOS &gt;= 10.10 ✔</span><br></pre></td></tr></table></figure>

<p>install:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install xhyve</span></span><br></pre></td></tr></table></figure>

<h1 id="Ubuntu-16-04-VM"><a href="#Ubuntu-16-04-VM" class="headerlink" title="Ubuntu 16.04 VM"></a>Ubuntu 16.04 VM</h1><p>下载<code>ubuntu-16.04.1-server-amd64.iso</code>，装载该iso，然后将其中的<code>vmlinuz</code>和<code>initrd.gz</code>复制出来，以供xhyve使用。</p>
<p>在mac系统下直接装载ubuntu的iso会出错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hdiutil attach ./ubuntu-16.04.1-server-amd64.iso</span></span><br><span class="line">hdiutil: attach failed - 无可装载的文件系统</span><br></pre></td></tr></table></figure>
<p>所以需要制作一个新的iso，新的iso文件前预留<code>2KB</code>的空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero bs=2k count=1 of=./tmp.iso</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">dd</span> <span class="keyword">if</span>=./ubuntu-16.04.1-server-amd64.iso bs=2k skip=1 &gt;&gt; ./tmp.iso</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">hdiutil attach ./tmp.iso</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cp</span> /Volumes/Ubuntu-Server\ 16/install/vmlinuz .</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cp</span> /Volumes/Ubuntu-Server\ 16/install/initrd.gz .</span></span><br></pre></td></tr></table></figure>

<p>创建一个磁盘映像文件<code>hdd.img</code>，当作虚拟机的虚拟硬盘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=hdd.img bs=1g count=8</span></span><br></pre></td></tr></table></figure>

<p>编写VM创建脚本<code>mk_xhyve.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">KERNEL=&quot;vmlinuz&quot;</span><br><span class="line">INITRD=&quot;initrd.gz&quot;</span><br><span class="line">CMDLINE=&quot;earlyprintk=serial console=ttyS0 acpi=off&quot;</span><br><span class="line"></span><br><span class="line">MEM=&quot;-m 1G&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">SMP=<span class="string">&quot;-c 2&quot;</span></span></span><br><span class="line">NET=&quot;-s 2:0,virtio-net&quot;</span><br><span class="line">IMG_CD=&quot;-s 3,ahci-cd,./ubuntu-16.04.1-server-amd64.iso&quot;</span><br><span class="line">IMG_HDD=&quot;-s 4,virtio-blk,./hdd.img&quot;</span><br><span class="line">PCI_DEV=&quot;-s 0:0,hostbridge -s 31,lpc&quot;</span><br><span class="line">LPC_DEV=&quot;-l com1,stdio&quot;</span><br><span class="line"></span><br><span class="line">xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&quot;$CMDLINE&quot;</span><br></pre></td></tr></table></figure>

<p>运行VM创建脚本<code>sudo sh ./mk_xhyve.sh</code>创建ubuntu虚拟机</p>
<p><img src="/images/xhyve/xhyve_vm_run.png" alt="xhyve_vm_run"></p>
<p>按正常系统安装方法安装。。。<br>待成功安装完成后选择<code>&lt;Go Back&gt;</code> &#x3D;&gt; <code>Execute a shell</code>，进入iso的shell界面，然后需要将已经安装好的<code>hdd.img</code>也就是系统中的<code>/dev/vda</code>中的boot目录copy出来，因为要用里面的<code>vmlinuz-4.4.0-31-generic</code>和<code>initrd.img-4.4.0-31-generic</code></p>
<p>进入shell后先查看一下ip地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BusyBox v1.22.1 (Ubuntu 1:1.22.0-15ubuntu1) built-in shell (ash)</span><br><span class="line">Enter &#x27;help&#x27; for a list of built-in commands.</span><br><span class="line"></span><br><span class="line">~ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">2: enp0s2: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop qlen 1000</span><br><span class="line">    link/ether 82:62:9e:40:cf:32 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">~ #</span><br></pre></td></tr></table></figure>
<p>发现没有获取到ip地址，此时shell用的是busybox，是没有<code>dhclient</code>的，不过busybox提供<code>udhcpc -i &lt;interface&gt;</code>。<br>获取到ip地址后，vm可以通过<code>tar c ./boot | nc -l -p 1234</code>将boot目录发送给宿主机，宿主机用<code>nc &lt;vm ip&gt; 1234 | tar x</code>接受boot目录。</p>
<p>获得到boot目录后取出其中的<code>vmlinuz-4.4.0-31-generic</code>和<code>initrd.img-4.4.0-31-generic</code>，然后修改VM创建脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">KERNEL=&quot;vmlinuz-4.4.0-31-generic&quot;</span><br><span class="line">INITRD=&quot;initrd.img-4.4.0-31-generic&quot;</span><br><span class="line">CMDLINE=&quot;earlyprintk=serial console=ttyS0 acpi=off root=/dev/vda1&quot;</span><br><span class="line"></span><br><span class="line">MEM=&quot;-m 1G&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">SMP=<span class="string">&quot;-c 2&quot;</span></span></span><br><span class="line">NET=&quot;-s 2:0,virtio-net&quot;</span><br><span class="line">IMG_CD=&quot;-s 3,ahci-cd,./ubuntu-16.04.1-server-amd64.iso&quot;</span><br><span class="line">IMG_HDD=&quot;-s 4,virtio-blk,./hdd.img&quot;</span><br><span class="line">PCI_DEV=&quot;-s 0:0,hostbridge -s 31,lpc&quot;</span><br><span class="line">LPC_DEV=&quot;-l com1,stdio&quot;</span><br><span class="line"></span><br><span class="line">xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&quot;$CMDLINE&quot;</span><br></pre></td></tr></table></figure>
<p>并执行<code>sudo sh ./mk_xhyve.sh</code></p>
<p><img src="/images/xhyve/xhyve_vm_run2.png" alt="xhyve_vm_run2"></p>
<p>ubuntu 16.04 正常启动了，over！</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mist64/xhyve">xhyve.org</a></li>
<li><a target="_blank" rel="noopener" href="http://www.pagetable.com/?p=831">xhyve – Lightweight Virtualization on OS X Based on bhyve</a></li>
<li><a target="_blank" rel="noopener" href="http://www.vpsee.com/2015/06/mac-os-x-hypervisor-xhyve-based-on-bhyve/">Mac OS X 上基于 FreeBSD&#x2F;bhyve 的虚拟技术 xhyve</a></li>
<li><a target="_blank" rel="noopener" href="https://www.v2ex.com/t/359038">在 Mac OS 的 Xhyve 引擎之上启动 LinuxKit 的玩法</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/08/29/bigdata/zeppelin-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/08/29/bigdata/zeppelin-usage/" class="post-title-link" itemprop="url">Zeppelin 搭建配置及使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-08-29 09:43:05" itemprop="dateCreated datePublished" datetime="2017-08-29T09:43:05+08:00">2017-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Big-Data/" itemprop="url" rel="index"><span itemprop="name">Big-Data</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/zeppelin/zeppelin_logo.png" alt="zeppelin_logo"></p>
<p>Apache Zeppelin是一个让交互式数据分析变得可行的基于网页的开源框架。Zeppelin提供了数据分析、数据可视化等功能。Zeppelin 是一个提供交互数据分析且基于Web的笔记本。方便你做出可数据驱动的、可交互且可协作的精美文档，并且支持多种语言，包括 Scala(使用 Apache Spark)、Python(Apache Spark)、SparkSQL、 Hive、 Markdown、Shell等等。</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>采用docker环境部署zeppelin</p>
<p>OS：CentOS 7.3.1611<br>JAVA：OpenJDK 1.8<br>zeppelin: 0.7.2</p>
<p>dockerfile:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.3</span>.<span class="number">1611</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> zhoub</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y java-1.8.0-openjdk.x86_64</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.141-1.b16.el7_3.x86_64/jre&quot;</span> | <span class="built_in">tee</span> -a /etc/bashrc</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;export JAVA_HOME&quot;</span> | <span class="built_in">tee</span> -a /etc/bashrc</span></span><br></pre></td></tr></table></figure>


<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><p>从<a target="_blank" rel="noopener" href="http://zeppelin.apache.org/download.html">zeppelin官网</a>或github上下载，推荐下载最新版。解压tar包，然后在准备好的环境中运行<code>zeppelin/bin/zeppelin-daemon.sh start</code></p>
<p>docker:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">cmd=&quot;/root/run/entry.sh&quot;</span><br><span class="line">image=&quot;centos7.3:java1.8&quot;</span><br><span class="line">net=&quot;hadoop_net&quot;</span><br><span class="line"></span><br><span class="line">docker run -d --rm -w /root/ -v $&#123;PWD&#125;/run:/root/run -v $&#123;PWD&#125;/zeppelin:/root/zeppelin -v $&#123;PWD&#125;/hbase:/root/hbase -p 8080 --network $&#123;net&#125; -h zeppelin --name zeppelin $&#123;image&#125; $&#123;cmd&#125;</span><br></pre></td></tr></table></figure>

<p>entry.sh:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/root/zeppelin/bin/zeppelin-daemon.sh start</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">    sleep 10s</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="/images/zeppelin/zeppelin_arch.jpg" alt="zeppelin_arch"><br>Zeppelin具有客户端&#x2F;服务器架构，客户端一般就是指浏览器。服务器接收客户端的请求，并将请求通过Thrift协议发送给翻译器组。翻译器组物理表现为JVM进程，负责实际处理客户端的请求并与服务器进行通信。</p>
<p><img src="/images/zeppelin/zeppelin_interpreter_arch.jpg" alt="zeppelin_interpreter_arch"><br>翻译器是一个插件式的体系结构，允许任何语言&#x2F;后端数据处理程序以插件的形式添加到Zeppelin中。当前的Zeppelin已经支持<a target="_blank" rel="noopener" href="http://zeppelin.apache.org/docs/0.7.2/manual/interpreters.html">很多翻译器</a>。插件式架构允许用户在Zeppelin中使用自己熟悉的特定程序语言或数据处理方式。例如，通过使用%spark翻译器，可以在Zeppelin中使用Scala语言代码。</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>zeppelin的配置主要指interpreter的设置，然后note通过配置好的interpreter进行解释执行。</p>
<h2 id="JDBC-hive配置"><a href="#JDBC-hive配置" class="headerlink" title="JDBC-hive配置"></a>JDBC-hive配置</h2><p>zeppelin想要通过jdbc连接hive需要对hive、hdfs、zeppelin三者进行配置</p>
<h3 id="hive"><a href="#hive" class="headerlink" title="hive"></a>hive</h3><p>需要在hive节点上启动<code>hiveserver2</code>服务<code>nohup /shared-disk/apache-hive-2.1.1-bin/bin/hive --service hiveserver2&amp;</code></p>
<h3 id="zeepelin"><a href="#zeepelin" class="headerlink" title="zeepelin"></a>zeepelin</h3><h4 id="拷贝连接hive-jdbc需要用到的jar包"><a href="#拷贝连接hive-jdbc需要用到的jar包" class="headerlink" title="拷贝连接hive-jdbc需要用到的jar包"></a>拷贝连接hive-jdbc需要用到的jar包</h4><p>将包<code>hive-jdbc-1.1.0+cdh5.9.1+795-1.cdh5.9.1.p0.4.el7.noarch.rpm</code>解开后的jar文件拷贝到<code>zeppelin/lib/interpreter/</code>目录下<br><code>hive-jdbc-1.1.0+cdh5.9.1+795-1.cdh5.9.1.p0.4.el7.noarch.rpm</code>包内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">total 51448</span><br><span class="line">-rw-r--r-- 1 root root    62050 Aug 25 10:18 commons-logging-1.1.3.jar</span><br><span class="line">-rw-r--r-- 1 root root 19386631 Aug 25 10:18 hive-exec-1.1.0-cdh5.9.1.jar</span><br><span class="line">lrwxrwxrwx 1 root root       28 Aug 25 10:18 hive-exec.jar -&gt; hive-exec-1.1.0-cdh5.9.1.jar</span><br><span class="line">-rw-r--r-- 1 root root    96598 Aug 25 10:19 hive-jdbc-1.1.0-cdh5.9.1.jar</span><br><span class="line">-rw-r--r-- 1 root root 23635048 Aug 25 10:19 hive-jdbc-1.1.0-cdh5.9.1-standalone.jar</span><br><span class="line">lrwxrwxrwx 1 root root       28 Aug 25 10:19 hive-jdbc.jar -&gt; hive-jdbc-1.1.0-cdh5.9.1.jar</span><br><span class="line">lrwxrwxrwx 1 root root       39 Aug 25 10:19 hive-jdbc-standalone.jar -&gt; hive-jdbc-1.1.0-cdh5.9.1-standalone.jar</span><br><span class="line">-rw-r--r-- 1 root root  5558969 Aug 25 10:19 hive-metastore-1.1.0-cdh5.9.1.jar</span><br><span class="line">lrwxrwxrwx 1 root root       33 Aug 25 10:19 hive-metastore.jar -&gt; hive-metastore-1.1.0-cdh5.9.1.jar</span><br><span class="line">-rw-r--r-- 1 root root   827980 Aug 25 10:19 hive-serde-1.1.0-cdh5.9.1.jar</span><br><span class="line">lrwxrwxrwx 1 root root       29 Aug 25 10:19 hive-serde.jar -&gt; hive-serde-1.1.0-cdh5.9.1.jar</span><br><span class="line">-rw-r--r-- 1 root root  2058121 Aug 25 10:19 hive-service-1.1.0-cdh5.9.1.jar</span><br><span class="line">lrwxrwxrwx 1 root root       31 Aug 25 10:19 hive-service.jar -&gt; hive-service-1.1.0-cdh5.9.1.jar</span><br><span class="line">-rw-r--r-- 1 root root   313702 Aug 25 10:19 libfb303-0.9.3.jar</span><br><span class="line">-rw-r--r-- 1 root root   234201 Aug 25 10:19 libthrift-0.9.3.jar</span><br><span class="line">-rw-r--r-- 1 root root   481535 Aug 25 10:19 log4j-1.2.16.jar</span><br></pre></td></tr></table></figure>

<h4 id="配置jdbc-interpreter"><a href="#配置jdbc-interpreter" class="headerlink" title="配置jdbc interpreter"></a>配置jdbc interpreter</h4><ul>
<li>default.driver: org.apache.hive.jdbc.HiveDriver</li>
<li>default.url: jdbc:hive2:&#x2F;&#x2F;172.26.1.177:10000&#x2F;default<br>  hiveserver2的默认端口为10000</li>
<li>default.user: root<br>  此处我使用root用户，后文中的hdfs的proxy设置也要用root</li>
</ul>
<p><img src="/images/zeppelin/zeppelin_hive_jdbc_setting.png" alt="zeppelin_hive_jdbc_setting"></p>
<h3 id="hdfs"><a href="#hdfs" class="headerlink" title="hdfs"></a>hdfs</h3><p>若zeppelin使用jdbc连接hive出错，报如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Could not establish connection to jdbc:hive2://192.168.0.51:10000: Required field &#x27;serverProtocolVersion&#x27; is unset! Struct:TOpenSessionResp(status:TStatus(statusCode:ERROR_STATUS, infoMessages:[*org.apache.hive.service.cli.HiveSQLException:Failed to open new session: java.lang.RuntimeException:</span><br><span class="line">java.lang.RuntimeException:</span><br><span class="line">    org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.security.authorize.AuthorizationException): User: hive is not allowed to impersonate hive:13:12,</span><br><span class="line">    org.apache.hive.service.cli.session.SessionManager:openSession:SessionManager.java:266, </span><br><span class="line">    org.apache.hive.service.cli.CLIService:openSessionWithImpersonation:CLIService.java:202, </span><br><span class="line">    org.apache.hive.service.cli.thrift.ThriftCLIService:getSessionHandle:ThriftCLIService.java:402, </span><br><span class="line">    org.apache.hive.service.cli.thrift.ThriftCLIService:OpenSession:ThriftCLIService.java:297, </span><br><span class="line">    org.apache.hive.service.cli.thrift.TCLIService$Processor$OpenSession:getResult:TCLIService.java:1253, </span><br><span class="line">    org.apache.hive.service.cli.thrift.TCLIService$Processor$OpenSession:getResult:TCLIService.java:1238, </span><br><span class="line">    org.apache.thrift.ProcessFunction:process:ProcessFunction.java:39, </span><br><span class="line">    org.apache.thrift.TBaseProcessor:process:TBaseProcessor.java:39, </span><br><span class="line">    org.apache.hive.service.auth.TSetIpAddressProcessor:process:TSetIpAddressProcessor.java:56, </span><br><span class="line">    org.apache.thrift.server.TThreadPoolServer$WorkerProcess:run:TThreadPoolServer.java:285, </span><br><span class="line">    java.util.concurrent.ThreadPoolExecutor:runWorker:ThreadPoolExecutor.java:1145, </span><br><span class="line">    java.util.concurrent.ThreadPoolExecutor$Worker:run:ThreadPoolExecutor.java:615, </span><br><span class="line">    java.lang.Thread:run:Thread.java:745,</span><br><span class="line">*java.lang.RuntimeException:java.lang.RuntimeException: </span><br><span class="line">    org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.security.authorize.AuthorizationException): User: hive is not allowed to impersonate hive:21:8,</span><br><span class="line">    org.apache.hive.service.cli.session.HiveSessionProxy:invoke:HiveSessionProxy.java:83, </span><br><span class="line">    org.apache.hive.service.cli.session.HiveSessionProxy:access$000:HiveSessionProxy.java:36, </span><br><span class="line">    org.apache.hive.service.cli.session.HiveSessionProxy$1:run:HiveSessionProxy.java:63, </span><br><span class="line">    java.security.AccessController:doPrivileged:AccessController.java:-2, </span><br><span class="line">    javax.security.auth.Subject:doAs:Subject.java:415, </span><br><span class="line">    org.apache.hadoop.security.UserGroupInformation:doAs:UserGroupInformation.java:1657, </span><br><span class="line">    org.apache.hive.service.cli.session.HiveSessionProxy:invoke:HiveSessionProxy.java:59, </span><br><span class="line">    com.sun.proxy.$Proxy19:open::-1, </span><br><span class="line">    org.apache.hive.service.cli.session.SessionManager:openSession:SessionManager.java:258, </span><br><span class="line">*java.lang.RuntimeException:</span><br><span class="line">    org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.security.authorize.AuthorizationException): User: hive is not allowed to impersonate hive:26:5, </span><br><span class="line">    org.apache.hadoop.hive.ql.session.SessionState:start:SessionState.java:494, </span><br><span class="line">    org.apache.hive.service.cli.session.HiveSessionImpl:open:HiveSessionImpl.java:137, </span><br><span class="line">    sun.reflect.GeneratedMethodAccessor11:invoke::-1, </span><br><span class="line">    sun.reflect.DelegatingMethodAccessorImpl:invoke:DelegatingMethodAccessorImpl.java:43, </span><br><span class="line">    java.lang.reflect.Method:invoke:Method.java:606, </span><br><span class="line">    org.apache.hive.service.cli.session.HiveSessionProxy:invoke:HiveSessionProxy.java:78, </span><br><span class="line">    *org.apache.hadoop.ipc.RemoteException:User: hive is not allowed to impersonate hive:45:19, </span><br><span class="line">    org.apache.hadoop.ipc.Client:call:Client.java:1427, </span><br><span class="line">    org.apache.hadoop.ipc.Client:call:Client.java:1358, </span><br><span class="line">    org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker:invoke:ProtobufRpcEngine.java:229, </span><br><span class="line">    com.sun.proxy.$Proxy14:getFileInfo::-1, </span><br><span class="line">    org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB:getFileInfo:ClientNamenodeProtocolTranslatorPB.java:771, </span><br><span class="line">    sun.reflect.GeneratedMethodAccessor7:invoke::-1, </span><br><span class="line">    sun.reflect.DelegatingMethodAccessorImpl:invoke:DelegatingMethodAccessorImpl.java:43, </span><br><span class="line">    java.lang.reflect.Method:invoke:Method.java:606, </span><br><span class="line">    org.apache.hadoop.io.retry.RetryInvocationHandler:invokeMethod:RetryInvocationHandler.java:252, </span><br><span class="line">    org.apache.hadoop.io.retry.RetryInvocationHandler:invoke:RetryInvocationHandler.java:104, </span><br><span class="line">    com.sun.proxy.$Proxy15:getFileInfo::-1, </span><br><span class="line">    org.apache.hadoop.hdfs.DFSClient:getFileInfo:DFSClient.java:2116, </span><br><span class="line">    org.apache.hadoop.hdfs.DistributedFileSystem$22:doCall:DistributedFileSystem.java:1315, </span><br><span class="line">    org.apache.hadoop.hdfs.DistributedFileSystem$22:doCall:DistributedFileSystem.java:1311, </span><br><span class="line">    org.apache.hadoop.fs.FileSystemLinkResolver:resolve:FileSystemLinkResolver.java:81, </span><br><span class="line">    org.apache.hadoop.hdfs.DistributedFileSystem:getFileStatus:DistributedFileSystem.java:1311, </span><br><span class="line">    org.apache.hadoop.fs.FileSystem:exists:FileSystem.java:1424, </span><br><span class="line">    org.apache.hadoop.hive.ql.session.SessionState:createRootHDFSDir:SessionState.java:568, </span><br><span class="line">    org.apache.hadoop.hive.ql.session.SessionState:createSessionDirs:SessionState.java:526, </span><br><span class="line">    org.apache.hadoop.hive.ql.session.SessionState:start:SessionState.java:480], </span><br><span class="line">errorCode:0, errorMessage:Failed to open new session: java.lang.RuntimeException: java.lang.RuntimeException: org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.security.authorize.AuthorizationException): User: hive is not allowed to impersonate hive), serverProtocolVersion:null)</span><br></pre></td></tr></table></figure>

<p>需要在hdfs <code>core-site.xml</code>中增加配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.proxyuser.hive.groups<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.proxyuser.hive.hosts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>然后重启<code>hdfs namenode</code></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p><img src="/images/zeppelin/zeppelin_main_ui.png" alt="zeppelin_main_ui"></p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://zeppelin.apache.org/docs/0.7.2/">zeppelin</a></li>
<li><a target="_blank" rel="noopener" href="http://www.2cto.com/database/201608/543466.html">基于hadoop生态圈的数据仓库实践——OLAP与数据可视化（五）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.aboutyun.com/thread-12278-1-1.html">Hive学习之HiveServer2服务端配置与启动</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/niityzu/article/details/42639369">Hive用户接口（二）—使用Hive JDBC驱动连接Hive操作实例</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/zeppelin/p/6184077.html">Zeppelin 用jdbc连接hive报错</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/08/28/linux/dist-linux-codename/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/08/28/linux/dist-linux-codename/" class="post-title-link" itemprop="url">dist-linux-codename</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-08-28 14:33:00" itemprop="dateCreated datePublished" datetime="2017-08-28T14:33:00+08:00">2017-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h1><h3 id="Xenial-Xerus-好客的非洲地松鼠"><a href="#Xenial-Xerus-好客的非洲地松鼠" class="headerlink" title="Xenial Xerus (好客的非洲地松鼠)"></a>Xenial Xerus (好客的非洲地松鼠)</h3><p>Ubuntu 16.04 的发布代号，简称XX。Canonical和Ubuntu的创始人马克·沙特尔沃思(Mark Shuttleworth) 在他的个人博文中写道：“这是如此的巧合幸运，我们的下个LTS应该为X，因为‘xenial’代表着主人和客人之间融洽的友好关系，而且对于推进Ubuntu OpenStack的LXD和KVM工作起到了非常积极的作用。Xerus则是非洲地松鼠，是我的祖国最为常见的动物。他们在沙漠环境中繁殖，并且以小型团体的方式生活，能够和邻居和谐生活的社会群体。”</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/08/03/storage/gluster/gluster-hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/08/03/storage/gluster/gluster-hello-world/" class="post-title-link" itemprop="url">初尝GlusterFS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-08-03 14:02:36" itemprop="dateCreated datePublished" datetime="2017-08-03T14:02:36+08:00">2017-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/gluster/glusterfs-antmascot.png" alt="glusterfs-antmascot"></p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>GlusterFS (Gluster File System) 是一个开源的分布式文件系统，主要由 Z RESEARCH 公司负责开发。GlusterFS 是 Scale-Out 存储解决方案 Gluster 的核心，具有强大的横向扩展能力，通过扩展能够支持数PB存储容量和处理数千客户端。GlusterFS 借助 TCP&#x2F;IP 或 InfiniBand RDMA 网络将物理分布的存储资源聚集在一起，使用单一全局命名空间来管理数据。GlusterFS 基于可堆叠的用户空间设计，可为各种不同的数据负载提供优异的性能。</p>
<p><img src="/images/gluster/glusterfs-frame.png" alt="glusterfs-frame"></p>
<p>GlusterFS 总体架构与组成，它主要由存储服务器（Brick Server）、客户端以及 NFS&#x2F;Samba 存储网关组成。不难发现，GlusterFS 架构中没有元数据服务器组件，这是其最大的设计这点，对于提升整个系统的性能、可靠性和稳定性都有着决定性的意义。</p>
<ul>
<li>GlusterFS 支持 TCP&#x2F;IP 和 InfiniBand RDMA 高速网络互联。</li>
<li>客户端可通过原生 GlusterFS 协议访问数据，其他没有运行 GlusterFS 客户端的终端可通过 NFS&#x2F;CIFS 标准协议通过存储网关访问数据（存储网关提供弹性卷管理和访问代理功能）。</li>
<li>存储服务器主要提供基本的数据存储功能，客户端弥补了没有元数据服务器的问题，承担了更多的功能，包括数据卷管理、I&#x2F;O 调度、文件定位、数据缓存等功能，利用 FUSE（File system in User Space）模块将 GlusterFS 挂载到本地文件系统之上，实现 POSIX 兼容的方式来访问系统数据。</li>
</ul>
<h2 id="卷类型"><a href="#卷类型" class="headerlink" title="卷类型"></a>卷类型</h2><h3 id="Distribute卷"><a href="#Distribute卷" class="headerlink" title="Distribute卷"></a>Distribute卷</h3><p>分布式卷，基于 Hash 算法将文件分布到所有 brick server，只是扩大了磁盘空间，不具备容错能力。由于distribute volume 使用本地文件系统，因此存取效率并没有提高，相反会因为网络通信的原因使用效率有所降低，另外本地存储设备的容量有限制，因此支持超大型文件会有一定难度。</p>
<p><img src="/images/gluster/glusterfs-volume-distribute.jpg" alt="glusterfs-volume-distribute"></p>
<h3 id="Stripe卷"><a href="#Stripe卷" class="headerlink" title="Stripe卷"></a>Stripe卷</h3><p>条带卷，类似 RAID0，文件分成数据块以 Round Robin 方式分布到 brick server 上，并发粒度是数据块，支持超大文件，大文件的读写性能高。</p>
<p><img src="/images/gluster/glusterfs-volume-stripe.jpg" alt="glusterfs-volume-stripe"></p>
<h3 id="Replica卷"><a href="#Replica卷" class="headerlink" title="Replica卷"></a>Replica卷</h3><p>复制卷，文件同步复制到多个 brick 上，文件级 RAID1，具有容错能力，写性能下降，读性能提升。Replicated 模式，也称作 AFR（Auto File Replication），相当于 RAID1，即同一文件在多个镜像存储节点上保存多份，每个 replicated 子节点有着相同的目录结构和文件，replica volume 也是在容器存储中较为推崇的一种。</p>
<p><img src="/images/gluster/glusterfs-volume-replica.jpg" alt="glusterfs-volume-replica"></p>
<h3 id="Distribute-Stripe卷"><a href="#Distribute-Stripe卷" class="headerlink" title="Distribute Stripe卷"></a>Distribute Stripe卷</h3><p>分布式条带卷，Brick server 数量是条带数的倍数，兼具 distribute 和 stripe 卷的特点。分布式的条带卷，volume 中 brick 所包含的存储服务器数必须是 stripe 的倍数(&gt;&#x3D;2倍)，兼顾分布式和条带式的功能。每个文件分布在四台共享服务器上，通常用于大文件访问处理，最少需要 4 台服务器才能创建分布条带卷。</p>
<p><img src="/images/gluster/glusterfs-volume-distribute-stripe.jpg" alt="glusterfs-volume-distribute-stripe"></p>
<h3 id="Distribute-Replica卷"><a href="#Distribute-Replica卷" class="headerlink" title="Distribute Replica卷"></a>Distribute Replica卷</h3><p>分布式复制卷，Brick server 数量是镜像数的倍数，兼具 distribute 和 replica 卷的特点,可以在 2 个或多个节点之间复制数据。分布式的复制卷，volume 中 brick 所包含的存储服务器数必须是 replica 的倍数(&gt;&#x3D;2倍)，兼顾分布式和复制式的功能。</p>
<p><img src="/images/gluster/glusterfs-volume-distribute-replica.jpg" alt="glusterfs-volume-distribute-replica"></p>
<h3 id="Stripe-Replica卷"><a href="#Stripe-Replica卷" class="headerlink" title="Stripe Replica卷"></a>Stripe Replica卷</h3><p>条带复制卷，类似 RAID 10，同时具有条带卷和复制卷的特点。</p>
<p><img src="/images/gluster/glusterfs-volume-stripe-replica.png" alt="glusterfs-volume-stripe-replica"></p>
<h3 id="Distribute-Stripe-Replica卷"><a href="#Distribute-Stripe-Replica卷" class="headerlink" title="Distribute Stripe Replica卷"></a>Distribute Stripe Replica卷</h3><p>分布式条带复制卷，三种基本卷的复合卷，通常用于类 Map Reduce 应用。</p>
<p><img src="/images/gluster/glusterfs-volume-distribute-stripe-replica.png" alt="glusterfs-volume-distribute-stripe-replica"></p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>使用docker部署GlusterFS，dockerfile如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.3</span>.<span class="number">1611</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> zhoub</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y centos-release-gluster310.noarch</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update -y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum clean all</span></span><br></pre></td></tr></table></figure>

<p>创建GlusterFS镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker build -t glusterfs:3.10 -f ./dockerfile .</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>创建docker容器脚本<code>mkgfs.sh</code>，创建两个容器，用来组件gluster集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">count=2</span><br><span class="line">image=glusterfs:3.10</span><br><span class="line"></span><br><span class="line">for((i=1;i&lt;=$count;i++))</span><br><span class="line">do</span><br><span class="line">    docker run -d -e &quot;container=docker&quot; --privileged=true -v /sys/fs/cgroup:/sys/fs/cgroup -h glf-client-$i --name glf_client_$i $&#123;image&#125; /usr/sbin/init</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="部署-使用"><a href="#部署-使用" class="headerlink" title="部署&amp;使用"></a>部署&amp;使用</h1><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>安装<code>glusterfs-server</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install -y glusterfs-server</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>准备数据目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span> -p /brks/brk1/gv0</span></span><br></pre></td></tr></table></figure>
<p>(此处不进行数据盘挂载，直接使用系统硬盘)</p>
<p>启动<code>glusterd</code>服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl <span class="built_in">enable</span> glusterd</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl start glusterd</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl status glusterd</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在容器<code>glf-client-1</code>上添加<code>glf-client-2</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster peer probe glf-client-2</span><br></pre></td></tr></table></figure>
<p>(此处省去向<code>/etc/hosts</code>增加ip、域名的映射修改)</p>
<p>在容器<code>glf-client-2</code>上添加<code>glf-client-1</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluster peer probe glf-client-1</span><br></pre></td></tr></table></figure>
<p>(此处省去向<code>/etc/hosts</code>增加ip、域名的映射修改)</p>
<p>在任意一个容器上创建、启动volume</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gluster volume create gv0 replica 2 glf-client-1:/brks/brk1/gv0 glf-client-2:/brks/brk1/gv0 force</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gluster volume start gv0</span></span><br></pre></td></tr></table></figure>
<p>(由于gv0使用的是系统盘，所以在volume创建时，需要指定<code>force</code>参数)<br>创建、启动完volume后可通过<code>gluster volume info</code>和<code>gluster volume status gv0</code>查看状态。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t glusterfs glf-client-1:gv0 /mnt/</span><br></pre></td></tr></table></figure>

<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.centos.org/SpecialInterestGroup/Storage/gluster-Quickstart">gluster-Quickstart</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/luckytanggu/article/details/71514798">容器中使用systemctl命令重启服务</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/opensource/os-cn-glusterfs-docker-volume/index.html?lnk=hm">基于 GlusterFS 实现 Docker 集群的分布式存储</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/07/21/devstack-deploy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/21/devstack-deploy/" class="post-title-link" itemprop="url">devstack部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-21 15:56:02" itemprop="dateCreated datePublished" datetime="2017-07-21T15:56:02+08:00">2017-07-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>OpenStack（以下简称OPS）是一个很庞大的系统，想要部署一个OPS需要部署很多组件。想必部署之路也是坑坑奇多。所以为了方便使用OPS，需要部署一个“all-in-one”环境的OPS</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>CPU<br>  2U X86_64</li>
<li>Memory<br>  4G及以上，如果内存过小，会出现各种问题。（整个devstack-Openstack-Ocata + CentOS7.3 1611需要占用3.4G内存）</li>
<li>OS<br>  CentOS 7.3 1611</li>
<li>NET<br>  建议创建两个网络，一个用于连接外网用于做管理性工作；一个供neutron使用</li>
<li>OpenStack版本<br>  Ocata</li>
</ul>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><h4 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a>关闭selinux</h4><p>编辑<code>/etc/selinux/config</code>将<code>SELINUX=enforcing</code>改为<code>SELINUX=disabled</code></p>
<h4 id="关闭iptables"><a href="#关闭iptables" class="headerlink" title="关闭iptables"></a>关闭iptables</h4><p>执行命令<code>sudo systemctl disable iptables</code>，关闭iptables服务</p>
<p>上诉两处修改若想生效需要重启系统。</p>
<h3 id="安装依赖软件"><a href="#安装依赖软件" class="headerlink" title="安装依赖软件"></a>安装依赖软件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y epel-release git net-tools</span><br></pre></td></tr></table></figure>

<h3 id="下载Devstack"><a href="#下载Devstack" class="headerlink" title="下载Devstack"></a>下载Devstack</h3><p>从github上下载devstack<code>git clone https://github.com/openstack-dev/devstack.git</code>，然后切换版本到Ocata <code>git checkout stable/ocata</code>，可使用<code>git branch -av</code>查看devstack所处分支</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="创建stack用户"><a href="#创建stack用户" class="headerlink" title="创建stack用户"></a>创建stack用户</h3><ol>
<li>进入devstack目录 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd devstack</span><br></pre></td></tr></table></figure></li>
<li>创建stack用户 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./tools/create-stack-user.sh</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="切换用户"><a href="#切换用户" class="headerlink" title="切换用户"></a>切换用户</h3><ol>
<li>修改目录owner <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R stack:stack ./devstack</span><br></pre></td></tr></table></figure></li>
<li>修改<code>/opt/stack</code>目录访问权限 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 /opt/stack -R</span><br><span class="line">sudo mv ./devstack /opt/stack/</span><br></pre></td></tr></table></figure></li>
<li>切换用户 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su - stack</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="撰写local-conf"><a href="#撰写local-conf" class="headerlink" title="撰写local.conf"></a>撰写local.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[[local|localrc]]</span><br><span class="line"></span><br><span class="line">DEST=/opt/stack/ocata</span><br><span class="line"># use TryStack git mirror</span><br><span class="line">GIT_BASE=http://git.trystack.cn</span><br><span class="line">NOVNC_REPO=http://git.trystack.cn/kanaka/noVNC.git</span><br><span class="line">SPICE_REPO=http://git.trystack.cn/git/spice/spice-html5.git</span><br><span class="line"></span><br><span class="line">#OFFLINE=True</span><br><span class="line">RECLONE=False</span><br><span class="line"></span><br><span class="line"># Define images to be automatically downloaded during the DevStack built process.</span><br><span class="line">DOWNLOAD_DEFAULT_IMAGES=False</span><br><span class="line">IMAGE_URLS=&quot;,https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img&quot;</span><br><span class="line"></span><br><span class="line">HOST_IP=127.0.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Credentials</span><br><span class="line">DATABASE_PASSWORD=pass</span><br><span class="line">ADMIN_PASSWORD=pass</span><br><span class="line">SERVICE_PASSWORD=pass</span><br><span class="line">SERVICE_TOKEN=pass</span><br><span class="line">RABBIT_PASSWORD=pass</span><br><span class="line"></span><br><span class="line">HORIZON_BRANCH=stable/ocata</span><br><span class="line">KEYSTONE_BRANCH=stable/ocata</span><br><span class="line">NOVA_BRANCH=stable/ocata</span><br><span class="line">NEUTRON_BRANCH=stable/ocata</span><br><span class="line">GLANCE_BRANCH=stable/ocata</span><br><span class="line">CINDER_BRANCH=stable/ocata</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#keystone</span><br><span class="line">KEYSTONE_TOKEN_FORMAT=UUID</span><br><span class="line"></span><br><span class="line">##Heat</span><br><span class="line">HEAT_BRANCH=stable/ocata</span><br><span class="line">enable_service h-eng h-api h-api-cfn h-api-cw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Swift</span><br><span class="line">SWIFT_BRANCH=stable/ocata</span><br><span class="line">ENABLED_SERVICES+=,s-proxy,s-object,s-container,s-account</span><br><span class="line">SWIFT_REPLICAS=1</span><br><span class="line">SWIFT_HASH=011688b44136573e209e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Enabling Neutron (network) Service</span><br><span class="line">disable_service n-net</span><br><span class="line">enable_service q-svc</span><br><span class="line">enable_service q-agt</span><br><span class="line">enable_service q-dhcp</span><br><span class="line">enable_service q-l3</span><br><span class="line">enable_service q-meta</span><br><span class="line">enable_service q-metering</span><br><span class="line">enable_service neutron</span><br><span class="line"></span><br><span class="line">## Neutron options</span><br><span class="line">Q_USE_SECGROUP=True</span><br><span class="line">FLOATING_RANGE=&quot;192.168.36.0/24&quot;</span><br><span class="line">FIXED_RANGE=&quot;10.0.0.0/24&quot;</span><br><span class="line">Q_FLOATING_ALLOCATION_POOL=start=192.168.36.55,end=192.168.36.100</span><br><span class="line">PUBLIC_NETWORK_GATEWAY=&quot;192.168.36.1&quot;</span><br><span class="line">Q_L3_ENABLED=True</span><br><span class="line">PUBLIC_INTERFACE=eth1</span><br><span class="line">Q_USE_PROVIDERNET_FOR_PUBLIC=True</span><br><span class="line">OVS_PHYSICAL_BRIDGE=br-ex</span><br><span class="line">PUBLIC_BRIDGE=br-ex</span><br><span class="line">OVS_BRIDGE_MAPPINGS=public:br-ex</span><br><span class="line"></span><br><span class="line"># #VLAN configuration.</span><br><span class="line">Q_PLUGIN=ml2</span><br><span class="line">ENABLE_TENANT_VLANS=True</span><br><span class="line"></span><br><span class="line"># Logging</span><br><span class="line">LOGFILE=/opt/stack/logs/stack.sh.log</span><br><span class="line">VERBOSE=True</span><br><span class="line">LOG_COLOR=True</span><br><span class="line">SCREEN_LOGDIR=/opt/stack/logs</span><br></pre></td></tr></table></figure>
<h3 id="安装OPS（all-in-one）"><a href="#安装OPS（all-in-one）" class="headerlink" title="安装OPS（all-in-one）"></a>安装OPS（all-in-one）</h3><p>安装使用<code>stack.sh</code>脚本，卸载使用<code>unstack.sh</code>脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./stack.sh</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">=========================</span><br><span class="line">DevStack Component Timing</span><br><span class="line">=========================</span><br><span class="line">Total runtime         1254</span><br><span class="line"></span><br><span class="line">run_process            83</span><br><span class="line">test_with_retry         4</span><br><span class="line">pip_install           127</span><br><span class="line">restart_apache_server  29</span><br><span class="line">wait_for_service       19</span><br><span class="line">yum_install            50</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This is your host IP address: 127.0.0.1</span><br><span class="line">This is your host IPv6 address: ::1</span><br><span class="line">Horizon is now available at http://127.0.0.1/dashboard</span><br><span class="line">Keystone is serving at http://127.0.0.1/identity/</span><br><span class="line">The default users are: admin and demo</span><br><span class="line">The password: pass</span><br></pre></td></tr></table></figure>
<p>安装时遇到问题可从两个角度考虑，一个网络不通，一个内存不足。这里再次重申，内存一定要&gt;&#x3D;4G，如果网络不通或延时太大，建议使用国内镜像。</p>
<p>例如<code>/opt/stack/.pip/pip.conf</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line"></span><br><span class="line">timeout = 6000</span><br><span class="line">index-url = http://pypi.douban.com/simple</span><br><span class="line">trusted-host = pypi.douban.com</span><br></pre></td></tr></table></figure>

<h2 id="horizon"><a href="#horizon" class="headerlink" title="horizon"></a>horizon</h2><p>安装成功后，访问<code>http://x.x.x.x/dashboard</code>, 用户民密码见<code>local.conf</code></p>
<p><img src="/images/devstack/horizon_login.png" alt="horizon_login"></p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/lyjshen/article/details/69467444">Virtuabox中Centos 7.3安装devstack后记</a></li>
<li><a target="_blank" rel="noopener" href="http://www.fx114.net/qa-7-155510.aspx">Centos7下搭建带有Ceilometer的devstack（mitaka版本）</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/scucscheng/article/details/51884613">centos 7 devstack 安装 openstack Mitaka</a></li>
<li><a target="_blank" rel="noopener" href="http://www.chenshake.com/devstack-installation-and-testing/">devstack安装和测试</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/07/12/storage/cosbench-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/12/storage/cosbench-usage/" class="post-title-link" itemprop="url">COSBench搭建及使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-07-12 10:31:31" itemprop="dateCreated datePublished" datetime="2017-07-12T10:31:31+08:00">2017-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/cosbench/cosbench-usage.png" alt="cosbench-usage.png"></p>
<p>COSBench是Intel团队基于java开发，对云存储的测试工具，全称是Cloud object Storage Bench。COSBench也分控制台和发起请求的driver，且driver可以分布式部署。可以支持swift、s3、Openstack等接口</p>
<h1 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h1><p>从github上下载release版本（<code>https://github.com/intel-cloud/cosbench</code>）。解压后可以获取<code>COSBenchUserGuide.pdf</code>（只有英文版）和<code>workload</code>配置文件（<code>./conf/*.xml</code>）。</p>
<h1 id="部署-启动"><a href="#部署-启动" class="headerlink" title="部署&amp;启动"></a>部署&amp;启动</h1><p>COSBench的运行依赖于java和curl这两个包，并且调用linux的nc来做数据分析，如果没有安装nc，请手动安装。<br>本人将COSBench部署到docker中，为的是方便以后运行，不要将有限的生命耗费到无限的折腾当中。</p>
<p>docker镜像使用的是<code>centos:7.3.1611</code>，具体dockerfile如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.3</span>.<span class="number">1611</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update -y</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y java-1.8.0-openjdk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum clean all</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">19088</span> <span class="number">18088</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./cosbench.tar.gz /root/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./entry.sh /root/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/root/entry.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p><code>entry.sh</code>是容器的启动脚本，脚本中主要用于启动COSBench服务，具体实现如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">./start-all.sh</span><br><span class="line"></span><br><span class="line">while true; do</span><br><span class="line">    sleep 10s</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>完成docker镜像的生成后，使用<code>docker run -d -w /root/cosbench/ --rm -P s3test:performance</code>命令运行容器。然后通过<code>docker ps</code>查看可访问的端口。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                COMMAND             CREATED             STATUS              PORTS                                                NAMES</span><br><span class="line">ed37db78178a        s3test:performance   &quot;/root/entry.sh&quot;    19 hours ago        Up 19 hours         0.0.0.0:32771-&gt;18088/tcp, 0.0.0.0:32770-&gt;19088/tcp   unruffled_mahavira</span><br></pre></td></tr></table></figure>

<p>在浏览器中输入<code>http://x.x.x.x:32770/controller/index.html</code>访问COSBench首页。COSBench是以”master-slave”模式运行的，19088端口对应的是master端口，18088对应的是driver端口，任务的运行是有master下发给driver，然后由driver执行的（driver可配置多个）。</p>
<p>关于<code>workload</code>配置文件的撰写请见<code>COSBenchUserGuide.pdf</code>，此处给出一个测试S3接口的例子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">workload</span> <span class="attr">name</span>=<span class="string">&quot;S3Test&quot;</span> <span class="attr">description</span>=<span class="string">&quot;Performance&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">storage</span> <span class="attr">type</span>=<span class="string">&quot;s3&quot;</span> <span class="attr">config</span>=<span class="string">&quot;accesskey=Ltiakby8pAAbHMjpUr3L;secretkey=qMTe5ibLW49iFDEHNKqspdnJ8pwaawA9GYrBXUYc;endpoint=http://los-cn-north-2.lecloudapis.com&quot;</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">workflow</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;init&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;init&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,4)&quot;</span> /&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;prepare&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;prepare&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,2);objects=r(1,800);sizes=c(4)MB&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;sequential_RO_8W_4MB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;sequential_RO_8W_4MB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;8&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;read&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(1);objects=s(1,800);size=c(4)MB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;random_RO_8W_4MB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;random_RO_8W_4MB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;8&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;read&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(2);objects=u(1,800);size=c(4)MB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;sequential_WO_8W_4MB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;sequential_WO_8W_4MB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;8&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;write&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(3);objects=s(1,800);sizes=c(4)MB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;random_WO_8W_4MB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;random_WO_8W_4MB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;8&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;write&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(4);objects=u(1,800);sizes=c(4)MB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;cleanup&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;cleanup&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,4);objects=r(1,800)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;dispose&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;dispose&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,4)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;init&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;init&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,4)&quot;</span> /&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;prepare&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;prepare&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,2);objects=r(1,800);sizes=c(64)KB&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;sequential_RO_32W_64KB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;sequential_RO_32W_64KB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;32&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;read&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(1);objects=s(1,800);size=c(64)KB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;random_RO_32W_64KB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;random_RO_32W_64KB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;32&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;read&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(2);objects=u(1,800);size=c(64)KB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;sequential_WO_32w_64KB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;sequential_WO_32w_64KB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;32&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;write&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(3);objects=s(1,800);sizes=c(64)KB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;random_WO_32W_64KB&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">name</span>=<span class="string">&quot;random_WO_32W_64KB&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;32&quot;</span> <span class="attr">totalOps</span>=<span class="string">&quot;1600&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">operation</span> <span class="attr">type</span>=<span class="string">&quot;write&quot;</span> <span class="attr">ratio</span>=<span class="string">&quot;100&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=c(4);objects=u(1,800);sizes=c(64)KB&quot;</span> /&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">work</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;cleanup&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;cleanup&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,4);objects=r(1,800)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">workstage</span> <span class="attr">name</span>=<span class="string">&quot;dispose&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">work</span> <span class="attr">type</span>=<span class="string">&quot;dispose&quot;</span> <span class="attr">workers</span>=<span class="string">&quot;1&quot;</span> <span class="attr">config</span>=<span class="string">&quot;cprefix=testp;containers=r(1,4)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">workstage</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">workflow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">workload</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="问题及解决"><a href="#问题及解决" class="headerlink" title="问题及解决"></a>问题及解决</h1><ol>
<li>COSBench首页时间显示没有按东八区显示<br>  在<code>cosbench-start.sh</code>中找到<code>/usr/bin/nohup java</code>这一行，增加<code>-Duser.timezone=Asia/Shanghai</code>参数</li>
<li>COSBench在测试过程中MD5校验失败问题<br>  在测试过程中GET操作失败，而且错误日志如下：  <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">2017-07-11 07:26:42,297 [INFO] [Log4jLogManager] - will append log to file /root/cosbench/log/mission/MA308B012AE.log</span><br><span class="line">2017-07-11 07:26:42,574 [INFO] [NoneStorage] - performing GET at /testp2/myobjects38</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects43</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects43</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects31</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects7</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects26</span><br><span class="line">2017-07-11 07:26:42,574 [INFO] [NoneStorage] - performing GET at /testp1/myobjects34</span><br><span class="line">2017-07-11 07:26:42,574 [INFO] [NoneStorage] - performing GET at /testp2/myobjects25</span><br><span class="line">2017-07-11 07:26:42,574 [INFO] [NoneStorage] - performing GET at /testp2/myobjects45</span><br><span class="line">2017-07-11 07:26:42,574 [INFO] [NoneStorage] - performing GET at /testp1/myobjects7</span><br><span class="line">2017-07-11 07:26:42,574 [INFO] [NoneStorage] - performing GET at /testp2/myobjects43</span><br><span class="line">2017-07-11 07:26:42,576 [INFO] [NoneStorage] - performing GET at /testp2/myobjects16</span><br><span class="line">2017-07-11 07:26:42,576 [INFO] [NoneStorage] - performing GET at /testp2/myobjects23</span><br><span class="line">2017-07-11 07:26:42,576 [INFO] [NoneStorage] - performing GET at /testp1/myobjects15</span><br><span class="line">2017-07-11 07:26:42,576 [INFO] [NoneStorage] - performing GET at /testp1/myobjects36</span><br><span class="line">2017-07-11 07:26:42,576 [INFO] [NoneStorage] - performing GET at /testp2/myobjects34</span><br><span class="line">2017-07-11 07:26:42,576 [INFO] [NoneStorage] - performing GET at /testp1/myobjects34</span><br><span class="line">2017-07-11 07:26:42,576 [INFO] [NoneStorage] - performing GET at /testp2/myobjects27</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects49</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects27</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects24</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects35</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects2</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects47</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects39</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects50</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects8</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects21</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects24</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects15</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp1/myobjects4</span><br><span class="line">2017-07-11 07:26:42,575 [INFO] [NoneStorage] - performing GET at /testp2/myobjects1</span><br><span class="line">2017-07-11 07:26:45,476 [ERROR] [AbstractOperator] - worker 8 fail to perform operation testp1/myobjects7</span><br><span class="line">com.amazonaws.AmazonClientException: Unable to verify integrity of data download.  Client calculated content hash didn&#x27;t match hash calculated by Amazon S3.  The data may be corrupt.</span><br><span class="line">   at com.amazonaws.services.s3.internal.DigestValidationInputStream.validateMD5Digest(DigestValidationInputStream.java:79)</span><br><span class="line">   at com.amazonaws.services.s3.internal.DigestValidationInputStream.read(DigestValidationInputStream.java:61)</span><br><span class="line">   at com.amazonaws.internal.SdkFilterInputStream.read(SdkFilterInputStream.java:72)</span><br><span class="line">   at com.amazonaws.services.s3.model.S3ObjectInputStream.read(S3ObjectInputStream.java:155)</span><br><span class="line">   at com.amazonaws.services.s3.model.S3ObjectInputStream.read(S3ObjectInputStream.java:147)</span><br><span class="line">   at com.intel.cosbench.driver.operator.Reader.copyLarge(Reader.java:120)</span><br><span class="line">   at com.intel.cosbench.driver.operator.Reader.doRead(Reader.java:92)</span><br><span class="line">   at com.intel.cosbench.driver.operator.Reader.operate(Reader.java:69)</span><br><span class="line">   at com.intel.cosbench.driver.operator.AbstractOperator.operate(AbstractOperator.java:76)</span><br><span class="line">   at com.intel.cosbench.driver.agent.WorkAgent.performOperation(WorkAgent.java:197)</span><br><span class="line">   at com.intel.cosbench.driver.agent.WorkAgent.doWork(WorkAgent.java:177)</span><br><span class="line">   at com.intel.cosbench.driver.agent.WorkAgent.execute(WorkAgent.java:134)</span><br><span class="line">   at com.intel.cosbench.driver.agent.AbstractAgent.call(AbstractAgent.java:44)</span><br><span class="line">   at com.intel.cosbench.driver.agent.AbstractAgent.call(AbstractAgent.java:1)</span><br><span class="line">   at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">   at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><br><span class="line">   at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><br><span class="line">   at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">2017-07-11 07:26:45,476 [INFO] [NoneStorage] - performing GET at /testp1/myobjects14</span><br><span class="line">2017-07-11 07:26:46,880 [INFO] [NoneStorage] - performing GET at /testp2/myobjects14</span><br><span class="line">2017-07-11 07:26:49,806 [INFO] [NoneStorage] - performing GET at /testp1/myobjects43</span><br><span class="line">2017-07-11 07:26:51,514 [INFO] [NoneStorage] - performing GET at /testp2/myobjects31</span><br><span class="line">2017-07-11 07:26:54,021 [INFO] [NoneStorage] - performing GET at /testp1/myobjects5</span><br></pre></td></tr></table></figure>
  你可以通过增加<code>-Dcom.amazonaws.services.s3.disableGetObjectMD5Validation=true</code>参数来关闭MD5校验，<a target="_blank" rel="noopener" href="https://github.com/intel-cloud/cosbench/issues/346">据说</a>此bug只在<code>0.4.3.c4</code>版本出现，我没验证过其它版本。</li>
</ol>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/landhu/p/5843282.html">使用COSBench工具对ceph s3接口进行压力测试</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/zhoubofsy/s3test">s3test</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/06/09/container/docker/docker-compile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/09/container/docker/docker-compile/" class="post-title-link" itemprop="url">Moby（Docker）编译趟坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-09 16:06:52" itemprop="dateCreated datePublished" datetime="2017-06-09T16:06:52+08:00">2017-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天是2017年6月12日，在此之前Docker就已经更名为moby了，就moby的的编译与之前docker的编译无异，为什么呢，因为无论是docker还是moby，都将自己的编译放在了容器中，编译所依赖的包也在容器中完成安装，目前moby（以下都以此替代docker）能直接编译出rpm、deb两种安装包，具体支持哪些平台，哪些操作系统，请见<code>./contrib/builder/</code>。</p>
<p>本文主要以编译<code>centos7</code>能用的rpm包为例，对moby的编译配置文件进行了修改，从而使moby快速完成编译。</p>
<h1 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> Debian:jessie</span><br><span class="line">+-------------+                              golang 1.7.5-alpine</span><br><span class="line">|             |                          +------------------------+ </span><br><span class="line">|  Moby       | ----- docker run -----&gt;  | docker manpage compile |</span><br><span class="line">|  Compile    |                          +------------------------+             centos:7</span><br><span class="line">|  Container  |                                                         +--------------------+</span><br><span class="line">|             | -------------- docker run ----------------------------&gt; |  build centos rpm  |                           </span><br><span class="line">+-------------+                                                         +--------------------+</span><br></pre></td></tr></table></figure>

<p>Moby先创建一个Debian的容器，编译Moby，然后该容器根据用户输入的参数决定使用哪些容器编译哪些安装包，在编译目标安装包之前会使用golang容器编译manpage。总之moby的所有编译工作都是在容器中进行的。</p>
<h1 id="编译方法"><a href="#编译方法" class="headerlink" title="编译方法"></a>编译方法</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>宿主机<br>  RHEL7.2</li>
<li>docker<br>  17.04.0-ce</li>
</ul>
<h2 id="RPM-Only-CentOS"><a href="#RPM-Only-CentOS" class="headerlink" title="RPM (Only CentOS)"></a>RPM (Only CentOS)</h2><ul>
<li>获取 moby 代码  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">clone</span> moby</span></span><br><span class="line">git clone https://github.com/moby/moby.git</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到17.04.0-ce版本</span></span><br><span class="line">git checkout -b building_v17.04.0-ce v17.04.0-ce</span><br></pre></td></tr></table></figure></li>
<li>修改Dockerfile  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/Dockerfile <span class="keyword">b</span>/Dockerfile</span><br><span class="line"><span class="built_in">index</span> <span class="number">8</span>a361ce..<span class="number">3</span>d6b0bb <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/Dockerfile</span><br><span class="line">+++ <span class="keyword">b</span>/Dockerfile</span><br><span class="line">@@ -<span class="number">34</span>,<span class="number">8</span> +<span class="number">34</span>,<span class="number">12</span> @@ COPY <span class="built_in">keys</span>/launchpad-ppa-zfs.asc /<span class="keyword">go</span>/src/github.<span class="keyword">com</span>/docker/docker/<span class="built_in">keys</span>/</span><br><span class="line"> RUN apt-key <span class="built_in">add</span> /<span class="keyword">go</span>/src/github.<span class="keyword">com</span>/docker/docker/<span class="built_in">keys</span>/launchpad-ppa-zfs.asc</span><br><span class="line"> RUN <span class="keyword">echo</span> <span class="keyword">deb</span> http://ppa.launchpad.net/zfs-native/stable/ubuntu trusty main &gt; /etc/apt/sources.<span class="keyword">list</span>.d/zfs.<span class="keyword">list</span></span><br><span class="line"></span><br><span class="line">+RUN apt-<span class="built_in">get</span> clean</span><br><span class="line">+RUN apt-<span class="built_in">get</span> <span class="keyword">update</span> -<span class="keyword">o</span> Acquire::http::No-Cache=True</span><br><span class="line">+</span><br><span class="line"> # Packaged dependencies</span><br><span class="line">-RUN apt-<span class="built_in">get</span> <span class="keyword">update</span> &amp;&amp; apt-<span class="built_in">get</span> install -<span class="keyword">y</span> \</span><br><span class="line">+# RUN apt-<span class="built_in">get</span> <span class="keyword">update</span> &amp;&amp; apt-<span class="built_in">get</span> install -<span class="keyword">y</span> \</span><br><span class="line">+RUN apt-<span class="built_in">get</span> install -<span class="keyword">y</span> \</span><br><span class="line">        apparmor \</span><br><span class="line">        apt-utils \</span><br><span class="line">        aufs-tools \</span><br><span class="line">@@ -<span class="number">112</span>,<span class="number">10</span> +<span class="number">116</span>,<span class="number">12</span> @@ ENV PATH /osxcross/target/bin:$PATH</span><br><span class="line"> ENV SECCOMP_VERSION <span class="number">2.3</span>.<span class="number">2</span></span><br><span class="line"> RUN <span class="keyword">set</span> -<span class="keyword">x</span> \</span><br><span class="line">        &amp;&amp; export SECCOMP_PATH=<span class="string">&quot;$(mktemp -d)&quot;</span> \</span><br><span class="line">-       &amp;&amp; curl -fsSL <span class="string">&quot;https://github.com/seccomp/libseccomp/releases/download/v$&#123;SECCOMP_VERSION&#125;/libseccomp-$&#123;SECCOMP_VERSION&#125;.tar.gz&quot;</span> \</span><br><span class="line">+       # &amp;&amp; curl -fsSL <span class="string">&quot;https://github.com/seccomp/libseccomp/releases/download/v$&#123;SECCOMP_VERSION&#125;/libseccomp-$&#123;SECCOMP_VERSION&#125;.tar.gz&quot;</span> \</span><br><span class="line">+       &amp;&amp; curl -fsSL <span class="string">&quot;https://github.com/seccomp/libseccomp/archive/v$&#123;SECCOMP_VERSION&#125;.tar.gz&quot;</span> \</span><br><span class="line">                | tar -xzC <span class="string">&quot;$SECCOMP_PATH&quot;</span> --strip-components=<span class="number">1</span> \</span><br><span class="line">        &amp;&amp; ( \</span><br><span class="line">                <span class="keyword">cd</span> <span class="string">&quot;$SECCOMP_PATH&quot;</span> \</span><br><span class="line">+        &amp;&amp; ./autogen.<span class="keyword">sh</span> \</span><br><span class="line">                &amp;&amp; ./configure --prefix=/usr/local \</span><br><span class="line">                &amp;&amp; <span class="keyword">make</span> \</span><br><span class="line">                &amp;&amp; <span class="keyword">make</span> install \</span><br></pre></td></tr></table></figure></li>
<li>去掉DM(DeviceMapper)支持  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/hack/<span class="keyword">make</span>/.integration-daemon-start <span class="keyword">b</span>/hack/<span class="keyword">make</span>/.integration-daemon-start</span><br><span class="line"><span class="built_in">index</span> <span class="number">0</span>bc8b96..bea0d70 <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/hack/<span class="keyword">make</span>/.integration-daemon-start</span><br><span class="line">+++ <span class="keyword">b</span>/hack/<span class="keyword">make</span>/.integration-daemon-start</span><br><span class="line">@@ -<span class="number">71</span>,<span class="number">7</span> +<span class="number">71</span>,<span class="number">7</span> @@ <span class="keyword">if</span> [ -<span class="keyword">z</span> <span class="string">&quot;$DOCKER_TEST_HOST&quot;</span> ]; then</span><br><span class="line">        ( <span class="keyword">set</span> -<span class="keyword">x</span>; exec \</span><br><span class="line">                dockerd --<span class="keyword">debug</span> \</span><br><span class="line">                --host <span class="string">&quot;$DOCKER_HOST&quot;</span> \</span><br><span class="line">-               --storage-driver <span class="string">&quot;$DOCKER_GRAPHDRIVER&quot;</span> \</span><br><span class="line">+               # --storage-driver <span class="string">&quot;$DOCKER_GRAPHDRIVER&quot;</span> \</span><br><span class="line">                --pidfile <span class="string">&quot;$DEST/docker.pid&quot;</span> \</span><br><span class="line">                --userland-proxy=<span class="string">&quot;$DOCKER_USERLANDPROXY&quot;</span> \</span><br><span class="line">                $storage_params \</span><br></pre></td></tr></table></figure></li>
<li>由于GFW的原因，去掉manpage中关于<code>golang.org/x/sys</code>的安装  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/man/glide.lock <span class="keyword">b</span>/man/glide.lock</span><br><span class="line"><span class="built_in">index</span> <span class="number">5</span>ec765a..<span class="number">2</span>ecad45 <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/man/glide.lock</span><br><span class="line">+++ <span class="keyword">b</span>/man/glide.lock</span><br><span class="line">@@ -<span class="number">38</span>,<span class="number">10</span> +<span class="number">38</span>,<span class="number">6</span> @@ imports:</span><br><span class="line">   <span class="keyword">version</span>: dabebe21bf790f782ea4c7bbd2efc430de182afd</span><br><span class="line"> - name: github.<span class="keyword">com</span>/spf13/viper</span><br><span class="line">   <span class="keyword">version</span>: c1ccc378a054ea8d4e38d8c67f6938d4760b53dd</span><br><span class="line">-- name: golang.org/<span class="keyword">x</span>/sys</span><br><span class="line">-  <span class="keyword">version</span>: <span class="number">62</span>bee037599929a6e9146f29d10dd5208c43507d</span><br><span class="line">-  subpackages:</span><br><span class="line">-  - unix</span><br><span class="line"> - name: gopkg.in/yaml.v2</span><br><span class="line">   <span class="keyword">version</span>: a83829b6f1293c91addabc89d0571c246397bbf4</span><br><span class="line"> - name: github.<span class="keyword">com</span>/spf13/cobra</span><br></pre></td></tr></table></figure></li>
<li>删除<code>amd64</code>平台下的与<code>centos7</code>无关的目录  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rm -rvf contrib/builder/rpm/amd64/amazonlinux-latest/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/fedora-24/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/fedora-25/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/opensuse-13.2/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/oraclelinux-6/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/oraclelinux-7/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/photon-1.0/</span><br></pre></td></tr></table></figure></li>
<li>修改<code>contrib/builder/rpm/amd64/centos-7/Dockerfile</code><br>  由于docker 17.04.0-ce这个版本是由golang1.7.5这个版本所编译的，所以在centos容器中需要安装golang1.7.5，而golangtc.com上没有1.7.5这个版本，所以只能通过vpn去golang.org上获取  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile <span class="keyword">b</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile</span><br><span class="line"><span class="built_in">index</span> <span class="number">5986</span>dfd..b1f024d <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile</span><br><span class="line">+++ <span class="keyword">b</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile</span><br><span class="line">@@ -<span class="number">9</span>,<span class="number">7</span> +<span class="number">9</span>,<span class="number">9</span> @@ RUN yum -<span class="keyword">y</span> swap -- <span class="built_in">remove</span> systemd-container systemd-container-libs -- install <span class="keyword">sy</span></span><br><span class="line"> RUN yum install -<span class="keyword">y</span> btrfs-progs-devel device-mapper-devel glibc-static libseccomp-devel libselinux-devel libtool-ltdl-devel pkgconfig selinux-policy selinux-policy-devel systemd-devel tar git cmake <span class="keyword">vim</span>-common</span><br><span class="line"></span><br><span class="line"> ENV GO_VERSION <span class="number">1.7</span>.<span class="number">5</span></span><br><span class="line">+ENV https_proxy <span class="number">192.168</span>.<span class="number">1.230</span>:<span class="number">1080</span></span><br><span class="line"> RUN curl -fSL <span class="string">&quot;https://golang.org/dl/go$&#123;GO_VERSION&#125;.linux-amd64.tar.gz&quot;</span> | tar xzC /usr/local</span><br><span class="line">+# RUN curl -fSL <span class="string">&quot;https://www.golangtc.com/static/go/$&#123;GO_VERSION&#125;/go$&#123;GO_VERSION&#125;.linux-amd64.tar.gz&quot;</span> | tar xzC /usr/local</span><br><span class="line"> ENV PATH $PATH:/usr/local/<span class="keyword">go</span>/bin</span><br><span class="line"></span><br><span class="line"> ENV AUTO_GOPATH <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li>使用Makefile编译Moby<br>  完成了上述Dockerfile的修改以后，可以使用make进行编译，由于我们需要编译的是rpm安装包，所以可直接使用<code>make rpm</code>进行。更多编译操作，可通过<code>make help</code>查看。</li>
</ul>
<p>*** 目前，Moby的编译主要问题处在GFW对网络封锁上，如遇到其它问题，请第一时间确认该网络是否能访问，尤其是中国大陆地区。 ***</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.ybojj.com/docker%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91/">docker源代码编译</a></li>
<li>感谢同事为我提供的VPN服务</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/05/25/storage/ceph/ceph-nfs-service-by-rgw-with-nfs-ganesha/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/25/storage/ceph/ceph-nfs-service-by-rgw-with-nfs-ganesha/" class="post-title-link" itemprop="url">Ceph提供NFS服务 —— RGW＋nfs-ganesha</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-25 09:43:37" itemprop="dateCreated datePublished" datetime="2017-05-25T09:43:37+08:00">2017-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/ceph/nfs-ganesha.jpg" alt="nfs-ganesha.jpg"></p>
<p>Ceph是统一存储，包括块、文件、对象。其中块存储必须映射给linux内核，然后才能用，而内核客户端代码的更新收到了linus的限制，已经好久没更新了。librbd又不能直接用，不过道是可以用nbd映射一下使用。cephfs目前还不太适合生产环境。目前<code>*nix</code>对nfs的支持还是很全面的，而对librbd、cephfs的支持就是大不一样了。so，使ceph支持nfs协议很有意义了，but！ceph是分布式存储，被ganesha一搞，出现了单节点问题，所以只能想办法从HA角度解决了，这也是一种无奈，唉。。。</p>
<p>（～～一丝光～～）从nfs v4.1开始支持并行存储，这或许是一缕新曙光。</p>
<h1 id="NFS-Ganesha架构"><a href="#NFS-Ganesha架构" class="headerlink" title="NFS-Ganesha架构"></a>NFS-Ganesha架构</h1><p><img src="/images/ceph/ceph-nfs-service-by-rgw-with-nfs-ganesha.png" alt="ceph-nfs-service-by-rgw-with-nfs-ganesha.png"></p>
<h1 id="实施"><a href="#实施" class="headerlink" title="实施"></a>实施</h1><h2 id="RGW搭建"><a href="#RGW搭建" class="headerlink" title="RGW搭建"></a>RGW搭建</h2><p>关于RGW的安装搭建请于<a target="_blank" rel="noopener" href="http://www.ceph.com/">Ceph官网</a>查看</p>
<h4 id="用户创建"><a href="#用户创建" class="headerlink" title="用户创建"></a>用户创建</h4><p>创建一个S3用户专门服务于nfs-ganesha</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> radosgw-admin --uid=nfs_ganesha_user --display=<span class="string">&quot;User for NFS-Ganesha&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;user_id&quot;: &quot;nfs_ganesha_user&quot;,</span><br><span class="line">    &quot;display_name&quot;: &quot;User for NFS-Ganesha&quot;,</span><br><span class="line">    &quot;email&quot;: &quot;&quot;,</span><br><span class="line">    &quot;suspended&quot;: 0,</span><br><span class="line">    &quot;max_buckets&quot;: 1000,</span><br><span class="line">    &quot;auid&quot;: 0,</span><br><span class="line">    &quot;subusers&quot;: [],</span><br><span class="line">    &quot;keys&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;user&quot;: &quot;nfs_ganesha_user&quot;,</span><br><span class="line">            &quot;access_key&quot;: &quot;xxxxxxxxxxxxxxxxxxxx&quot;,</span><br><span class="line">            &quot;secret_key&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;swift_keys&quot;: [],</span><br><span class="line">    &quot;caps&quot;: [],</span><br><span class="line">    &quot;op_mask&quot;: &quot;read, write, delete&quot;,</span><br><span class="line">    &quot;default_placement&quot;: &quot;&quot;,</span><br><span class="line">    &quot;placement_tags&quot;: [],</span><br><span class="line">    &quot;bucket_quota&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false,</span><br><span class="line">        &quot;max_size_kb&quot;: -1,</span><br><span class="line">        &quot;max_objects&quot;: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;user_quota&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false,</span><br><span class="line">        &quot;max_size_kb&quot;: -1,</span><br><span class="line">        &quot;max_objects&quot;: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;temp_url_keys&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>user</code>、<code>access_key</code>、<code>secret_key</code>是后续nfs-ganesha配置是需要使用到的。</p>
<h2 id="nfs-ganesha编译部署"><a href="#nfs-ganesha编译部署" class="headerlink" title="nfs-ganesha编译部署"></a>nfs-ganesha编译部署</h2><h4 id="获取Project"><a href="#获取Project" class="headerlink" title="获取Project"></a>获取Project</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// clone nfs-ganesha project</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/nfs-ganesha/nfs-ganesha.git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./nfs-ganesha</span></span><br><span class="line"></span><br><span class="line">// 切换到v2.4 stable版本</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout V2.4-stable</span></span><br><span class="line"></span><br><span class="line">// 获取submodule libntirpc</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git submodule update --init</span></span><br></pre></td></tr></table></figure>

<p>在正式开始编译前，需要安装一些包，<code>libntirpc</code>强制使用了GSS，使用<code>-DUSE_GSS=OFF</code>是不能关闭GSS使用的。所以在编译nfs-ganesha时不需要关闭GSS。<br>本人编译使用的系统是rhel7.2，需要安装一些软件包<code>krb5-libs-1.14.1-27.el7_3.x86_64</code>、<code>krb5-devel-1.14.1-27.el7_3.x86_64</code>、<code>libgssglue-0.4-2.el7.nux.x86_64</code>、<code>libgssglue-devel-0.4-2.el7.nux.x86_64</code></p>
<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// libntirpc 编译 </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./nfs-ganesha/src/libntirpc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake ./</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// nfs-ganesha 编译</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./nfs-ganesha</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> ./build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake -DUSE_NLM=OFF -DRGW_PREFIX=/usr -DUSE_FSAL_RGW=ON -DUSE_FSAL_CEPH=OFF -DCMAKE_INSTALL_PREFIX=/home/xxxxx/.local -DUSE_GSS=ON -DUSE_FSAL_ZFS=OFF -DUSE_NFSIDMAP=OFF -DUSE_FSAL_GLUSTER=OFF ../src</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make install</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// 为了能让ganesha正常运行，需要更新一下ld.cache，保证动态库可以正常加载</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">echo</span> <span class="string">&quot;/home/xxxxx/.local/lib64/ganesha&quot;</span> &gt;&gt; /etc/ld.so.conf</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ldconfig -v</span></span><br><span class="line"></span><br><span class="line">//生成RPM包</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cpack -G RPM</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="配置启动"><a href="#配置启动" class="headerlink" title="配置启动"></a>配置启动</h3><h4 id="配置RGW的Keyring"><a href="#配置RGW的Keyring" class="headerlink" title="配置RGW的Keyring"></a>配置RGW的Keyring</h4><p>librgw 访问ceph时会用到keyring，它回去<code>/var/lib/ceph/radosgw/ceph-admin</code>这个目录下去找<code>keyring</code>，这个目录需要用户自己创建并，copy一个keyring进去，这个keyring可以是admin，也可以是rgw实用的keyring，从权限管理角度建议使用rgw的keyring</p>
<h4 id="撰写ganesha-conf-rgw"><a href="#撰写ganesha-conf-rgw" class="headerlink" title="撰写ganesha.conf.rgw"></a>撰写<code>ganesha.conf.rgw</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">###################################################</span><br><span class="line">#</span><br><span class="line"># EXPORT</span><br><span class="line">#</span><br><span class="line"># To function, all that is required is an EXPORT</span><br><span class="line">#</span><br><span class="line"># Define the absolute minimal export</span><br><span class="line">#</span><br><span class="line">###################################################</span><br><span class="line"></span><br><span class="line">EXPORT</span><br><span class="line">&#123;</span><br><span class="line">        # Export Id (mandatory, each EXPORT must have a unique Export_Id)</span><br><span class="line">        Export_Id = 1;</span><br><span class="line"></span><br><span class="line">        # Exported path (mandatory)</span><br><span class="line">        Path = &quot;nfs_bucket&quot;;</span><br><span class="line"></span><br><span class="line">        # Pseudo Path (required for NFS v4)</span><br><span class="line">        Pseudo = &quot;/nfs_bucket&quot;;</span><br><span class="line"></span><br><span class="line">        # Required for access (default is None)</span><br><span class="line">        # Could use CLIENT blocks instead</span><br><span class="line">        Access_Type = RW;</span><br><span class="line">        Protocols = 4;</span><br><span class="line">        Transports = TCP;</span><br><span class="line"></span><br><span class="line">        # Exporting FSAL</span><br><span class="line">        FSAL &#123;</span><br><span class="line">             # Name = VFS;</span><br><span class="line">             Name = RGW;</span><br><span class="line">             User_Id = &quot;xxxxxxxxxxx&quot;;</span><br><span class="line">             Access_Key_Id = &quot;xxxxxxxxxxxxxxxxxxxx&quot;;</span><br><span class="line">             Secret_Access_Key = &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RGW &#123;</span><br><span class="line">        ceph_conf = &quot;/etc/ceph/ceph.conf&quot;;</span><br><span class="line">        name = &quot;client.admin&quot;;</span><br><span class="line">        cluster = &quot;ceph&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="运行ganesha进程"><a href="#运行ganesha进程" class="headerlink" title="运行ganesha进程"></a>运行ganesha进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ganesha.nfsd -f /home/xxxxx/.local/etc/ganesha/ganesha.conf.rgw -F -L /var/log/ganesha.log</span><br></pre></td></tr></table></figure>

<h4 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs4 192.168.1.82:/nfs_bucket /mnt</span><br></pre></td></tr></table></figure>


<h2 id="docker容器部署"><a href="#docker容器部署" class="headerlink" title="docker容器部署"></a>docker容器部署</h2><h3 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h3><p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/ananace/nfs-ganesha-ceph">ananace&#x2F;nfs-ganesha-ceph</a></p>
<h3 id="gannesha配置"><a href="#gannesha配置" class="headerlink" title="gannesha配置"></a>gannesha配置</h3><p>配置上来讲与编译部署没有太大差别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># NFS protocol options</span><br><span class="line">EXPORT</span><br><span class="line">&#123;</span><br><span class="line">  # Export Id (mandatory, each EXPORT must have a unique Export_Id)</span><br><span class="line">  Export_Id = 77;</span><br><span class="line"></span><br><span class="line">  # Exported path (mandatory)</span><br><span class="line">  Path = /;</span><br><span class="line"></span><br><span class="line">  # Pseudo Path (for NFS v4)</span><br><span class="line">  Pseudo = /;</span><br><span class="line"></span><br><span class="line">  # Access control options</span><br><span class="line">  Access_Type = RW;</span><br><span class="line">  Squash = No_Root_Squash;</span><br><span class="line"></span><br><span class="line">  # NFS protocol options</span><br><span class="line">  SecType = &quot;sys&quot;;</span><br><span class="line">  Transports = TCP;</span><br><span class="line">  Protocols = 4;</span><br><span class="line"></span><br><span class="line">  # Exporting FSAL</span><br><span class="line">  FSAL &#123;</span><br><span class="line">    Name = RGW;</span><br><span class="line">    User_Id = &quot;admin&quot;;</span><br><span class="line">    Access_Key_Id = &quot;8I4K2USDV5SK3UFLQUB0&quot;;</span><br><span class="line">    Secret_Access_Key = &quot;A4JuvB468tmnDpmkZMfwesb2zmGZeSiCJlzJMALc&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RGW &#123;</span><br><span class="line">    cluster = &quot;ceph&quot;;</span><br><span class="line">    ceph_conf = &quot;/etc/ceph/ceph.conf&quot;;</span><br><span class="line">    name = &quot;client.rgw.host-10-100-13-111&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行ganesha容器"><a href="#运行ganesha容器" class="headerlink" title="运行ganesha容器"></a>运行ganesha容器</h3><p>由于Ganesha 的 FSAL 使用到了librgw，所以在镜像中会装好<code>ceph-common</code>、<code>librgw2</code>等。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net=host  -v /home/xxx/ceph/etc_ceph/:/etc/ceph:ro -v /home/xxx/ceph/ganesha/:/etc/ganesha:ro -v /home/xxx/ceph/var_lib_ceph/:/var/lib/ceph --name nfs -e GANESHA_BOOTSTRAP_CONFIG=no ananace/nfs-ganesha-ceph</span><br></pre></td></tr></table></figure>
<p>docker 启动是需要设置环境变量<code>GANESHA_BOOTSTRAP_CONFIG=no</code>，默认配置为<code>yes</code>；若为<code>yes</code>的化，nfs-ganesha在启动的时候会重置<code>/etc/ganesha/ganesha.conf</code>配置文件。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nfs-ganesha/nfs-ganesha/issues/152">Will not compile with USE_GSS&#x3D;”OFF”</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/yAV7R3N">rgw实现nfs的首测</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/JFRn2me">NFS + CephFS 构建基于 Ceph 的 NAS 服务</a></li>
<li><a target="_blank" rel="noopener" href="http://www.php230.com/1492048922.html">通过ganesha-nfs将 Ceph 导出为 NFS</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/alexyuyu/articles/3509255.html">LD_LIBRARY_PATH</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/ananace/nfs-ganesha-ceph">ananace&#x2F;nfs-ganesha-ceph</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">博</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">148</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">123</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
