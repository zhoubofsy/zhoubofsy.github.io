<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/page/9/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="博">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/06/09/container/docker/docker-compile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/09/container/docker/docker-compile/" class="post-title-link" itemprop="url">Moby（Docker）编译趟坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-09 16:06:52" itemprop="dateCreated datePublished" datetime="2017-06-09T16:06:52+08:00">2017-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天是2017年6月12日，在此之前Docker就已经更名为moby了，就moby的的编译与之前docker的编译无异，为什么呢，因为无论是docker还是moby，都将自己的编译放在了容器中，编译所依赖的包也在容器中完成安装，目前moby（以下都以此替代docker）能直接编译出rpm、deb两种安装包，具体支持哪些平台，哪些操作系统，请见<code>./contrib/builder/</code>。</p>
<p>本文主要以编译<code>centos7</code>能用的rpm包为例，对moby的编译配置文件进行了修改，从而使moby快速完成编译。</p>
<h1 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> Debian:jessie</span><br><span class="line">+-------------+                              golang 1.7.5-alpine</span><br><span class="line">|             |                          +------------------------+ </span><br><span class="line">|  Moby       | ----- docker run -----&gt;  | docker manpage compile |</span><br><span class="line">|  Compile    |                          +------------------------+             centos:7</span><br><span class="line">|  Container  |                                                         +--------------------+</span><br><span class="line">|             | -------------- docker run ----------------------------&gt; |  build centos rpm  |                           </span><br><span class="line">+-------------+                                                         +--------------------+</span><br></pre></td></tr></table></figure>

<p>Moby先创建一个Debian的容器，编译Moby，然后该容器根据用户输入的参数决定使用哪些容器编译哪些安装包，在编译目标安装包之前会使用golang容器编译manpage。总之moby的所有编译工作都是在容器中进行的。</p>
<h1 id="编译方法"><a href="#编译方法" class="headerlink" title="编译方法"></a>编译方法</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>宿主机<br>  RHEL7.2</li>
<li>docker<br>  17.04.0-ce</li>
</ul>
<h2 id="RPM-Only-CentOS"><a href="#RPM-Only-CentOS" class="headerlink" title="RPM (Only CentOS)"></a>RPM (Only CentOS)</h2><ul>
<li>获取 moby 代码  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">clone</span> moby</span></span><br><span class="line">git clone https://github.com/moby/moby.git</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到17.04.0-ce版本</span></span><br><span class="line">git checkout -b building_v17.04.0-ce v17.04.0-ce</span><br></pre></td></tr></table></figure></li>
<li>修改Dockerfile  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/Dockerfile <span class="keyword">b</span>/Dockerfile</span><br><span class="line"><span class="built_in">index</span> <span class="number">8</span>a361ce..<span class="number">3</span>d6b0bb <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/Dockerfile</span><br><span class="line">+++ <span class="keyword">b</span>/Dockerfile</span><br><span class="line">@@ -<span class="number">34</span>,<span class="number">8</span> +<span class="number">34</span>,<span class="number">12</span> @@ COPY <span class="built_in">keys</span>/launchpad-ppa-zfs.asc /<span class="keyword">go</span>/src/github.<span class="keyword">com</span>/docker/docker/<span class="built_in">keys</span>/</span><br><span class="line"> RUN apt-key <span class="built_in">add</span> /<span class="keyword">go</span>/src/github.<span class="keyword">com</span>/docker/docker/<span class="built_in">keys</span>/launchpad-ppa-zfs.asc</span><br><span class="line"> RUN <span class="keyword">echo</span> <span class="keyword">deb</span> http://ppa.launchpad.net/zfs-native/stable/ubuntu trusty main &gt; /etc/apt/sources.<span class="keyword">list</span>.d/zfs.<span class="keyword">list</span></span><br><span class="line"></span><br><span class="line">+RUN apt-<span class="built_in">get</span> clean</span><br><span class="line">+RUN apt-<span class="built_in">get</span> <span class="keyword">update</span> -<span class="keyword">o</span> Acquire::http::No-Cache=True</span><br><span class="line">+</span><br><span class="line"> # Packaged dependencies</span><br><span class="line">-RUN apt-<span class="built_in">get</span> <span class="keyword">update</span> &amp;&amp; apt-<span class="built_in">get</span> install -<span class="keyword">y</span> \</span><br><span class="line">+# RUN apt-<span class="built_in">get</span> <span class="keyword">update</span> &amp;&amp; apt-<span class="built_in">get</span> install -<span class="keyword">y</span> \</span><br><span class="line">+RUN apt-<span class="built_in">get</span> install -<span class="keyword">y</span> \</span><br><span class="line">        apparmor \</span><br><span class="line">        apt-utils \</span><br><span class="line">        aufs-tools \</span><br><span class="line">@@ -<span class="number">112</span>,<span class="number">10</span> +<span class="number">116</span>,<span class="number">12</span> @@ ENV PATH /osxcross/target/bin:$PATH</span><br><span class="line"> ENV SECCOMP_VERSION <span class="number">2.3</span>.<span class="number">2</span></span><br><span class="line"> RUN <span class="keyword">set</span> -<span class="keyword">x</span> \</span><br><span class="line">        &amp;&amp; export SECCOMP_PATH=<span class="string">&quot;$(mktemp -d)&quot;</span> \</span><br><span class="line">-       &amp;&amp; curl -fsSL <span class="string">&quot;https://github.com/seccomp/libseccomp/releases/download/v$&#123;SECCOMP_VERSION&#125;/libseccomp-$&#123;SECCOMP_VERSION&#125;.tar.gz&quot;</span> \</span><br><span class="line">+       # &amp;&amp; curl -fsSL <span class="string">&quot;https://github.com/seccomp/libseccomp/releases/download/v$&#123;SECCOMP_VERSION&#125;/libseccomp-$&#123;SECCOMP_VERSION&#125;.tar.gz&quot;</span> \</span><br><span class="line">+       &amp;&amp; curl -fsSL <span class="string">&quot;https://github.com/seccomp/libseccomp/archive/v$&#123;SECCOMP_VERSION&#125;.tar.gz&quot;</span> \</span><br><span class="line">                | tar -xzC <span class="string">&quot;$SECCOMP_PATH&quot;</span> --strip-components=<span class="number">1</span> \</span><br><span class="line">        &amp;&amp; ( \</span><br><span class="line">                <span class="keyword">cd</span> <span class="string">&quot;$SECCOMP_PATH&quot;</span> \</span><br><span class="line">+        &amp;&amp; ./autogen.<span class="keyword">sh</span> \</span><br><span class="line">                &amp;&amp; ./configure --prefix=/usr/local \</span><br><span class="line">                &amp;&amp; <span class="keyword">make</span> \</span><br><span class="line">                &amp;&amp; <span class="keyword">make</span> install \</span><br></pre></td></tr></table></figure></li>
<li>去掉DM(DeviceMapper)支持  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/hack/<span class="keyword">make</span>/.integration-daemon-start <span class="keyword">b</span>/hack/<span class="keyword">make</span>/.integration-daemon-start</span><br><span class="line"><span class="built_in">index</span> <span class="number">0</span>bc8b96..bea0d70 <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/hack/<span class="keyword">make</span>/.integration-daemon-start</span><br><span class="line">+++ <span class="keyword">b</span>/hack/<span class="keyword">make</span>/.integration-daemon-start</span><br><span class="line">@@ -<span class="number">71</span>,<span class="number">7</span> +<span class="number">71</span>,<span class="number">7</span> @@ <span class="keyword">if</span> [ -<span class="keyword">z</span> <span class="string">&quot;$DOCKER_TEST_HOST&quot;</span> ]; then</span><br><span class="line">        ( <span class="keyword">set</span> -<span class="keyword">x</span>; exec \</span><br><span class="line">                dockerd --<span class="keyword">debug</span> \</span><br><span class="line">                --host <span class="string">&quot;$DOCKER_HOST&quot;</span> \</span><br><span class="line">-               --storage-driver <span class="string">&quot;$DOCKER_GRAPHDRIVER&quot;</span> \</span><br><span class="line">+               # --storage-driver <span class="string">&quot;$DOCKER_GRAPHDRIVER&quot;</span> \</span><br><span class="line">                --pidfile <span class="string">&quot;$DEST/docker.pid&quot;</span> \</span><br><span class="line">                --userland-proxy=<span class="string">&quot;$DOCKER_USERLANDPROXY&quot;</span> \</span><br><span class="line">                $storage_params \</span><br></pre></td></tr></table></figure></li>
<li>由于GFW的原因，去掉manpage中关于<code>golang.org/x/sys</code>的安装  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/man/glide.lock <span class="keyword">b</span>/man/glide.lock</span><br><span class="line"><span class="built_in">index</span> <span class="number">5</span>ec765a..<span class="number">2</span>ecad45 <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/man/glide.lock</span><br><span class="line">+++ <span class="keyword">b</span>/man/glide.lock</span><br><span class="line">@@ -<span class="number">38</span>,<span class="number">10</span> +<span class="number">38</span>,<span class="number">6</span> @@ imports:</span><br><span class="line">   <span class="keyword">version</span>: dabebe21bf790f782ea4c7bbd2efc430de182afd</span><br><span class="line"> - name: github.<span class="keyword">com</span>/spf13/viper</span><br><span class="line">   <span class="keyword">version</span>: c1ccc378a054ea8d4e38d8c67f6938d4760b53dd</span><br><span class="line">-- name: golang.org/<span class="keyword">x</span>/sys</span><br><span class="line">-  <span class="keyword">version</span>: <span class="number">62</span>bee037599929a6e9146f29d10dd5208c43507d</span><br><span class="line">-  subpackages:</span><br><span class="line">-  - unix</span><br><span class="line"> - name: gopkg.in/yaml.v2</span><br><span class="line">   <span class="keyword">version</span>: a83829b6f1293c91addabc89d0571c246397bbf4</span><br><span class="line"> - name: github.<span class="keyword">com</span>/spf13/cobra</span><br></pre></td></tr></table></figure></li>
<li>删除<code>amd64</code>平台下的与<code>centos7</code>无关的目录  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rm -rvf contrib/builder/rpm/amd64/amazonlinux-latest/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/fedora-24/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/fedora-25/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/opensuse-13.2/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/oraclelinux-6/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/oraclelinux-7/</span><br><span class="line">rm -rvf contrib/builder/rpm/amd64/photon-1.0/</span><br></pre></td></tr></table></figure></li>
<li>修改<code>contrib/builder/rpm/amd64/centos-7/Dockerfile</code><br>  由于docker 17.04.0-ce这个版本是由golang1.7.5这个版本所编译的，所以在centos容器中需要安装golang1.7.5，而golangtc.com上没有1.7.5这个版本，所以只能通过vpn去golang.org上获取  <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git <span class="keyword">a</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile <span class="keyword">b</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile</span><br><span class="line"><span class="built_in">index</span> <span class="number">5986</span>dfd..b1f024d <span class="number">100644</span></span><br><span class="line">--- <span class="keyword">a</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile</span><br><span class="line">+++ <span class="keyword">b</span>/contrib/builder/rpm/amd64/centos-<span class="number">7</span>/Dockerfile</span><br><span class="line">@@ -<span class="number">9</span>,<span class="number">7</span> +<span class="number">9</span>,<span class="number">9</span> @@ RUN yum -<span class="keyword">y</span> swap -- <span class="built_in">remove</span> systemd-container systemd-container-libs -- install <span class="keyword">sy</span></span><br><span class="line"> RUN yum install -<span class="keyword">y</span> btrfs-progs-devel device-mapper-devel glibc-static libseccomp-devel libselinux-devel libtool-ltdl-devel pkgconfig selinux-policy selinux-policy-devel systemd-devel tar git cmake <span class="keyword">vim</span>-common</span><br><span class="line"></span><br><span class="line"> ENV GO_VERSION <span class="number">1.7</span>.<span class="number">5</span></span><br><span class="line">+ENV https_proxy <span class="number">192.168</span>.<span class="number">1.230</span>:<span class="number">1080</span></span><br><span class="line"> RUN curl -fSL <span class="string">&quot;https://golang.org/dl/go$&#123;GO_VERSION&#125;.linux-amd64.tar.gz&quot;</span> | tar xzC /usr/local</span><br><span class="line">+# RUN curl -fSL <span class="string">&quot;https://www.golangtc.com/static/go/$&#123;GO_VERSION&#125;/go$&#123;GO_VERSION&#125;.linux-amd64.tar.gz&quot;</span> | tar xzC /usr/local</span><br><span class="line"> ENV PATH $PATH:/usr/local/<span class="keyword">go</span>/bin</span><br><span class="line"></span><br><span class="line"> ENV AUTO_GOPATH <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li>使用Makefile编译Moby<br>  完成了上述Dockerfile的修改以后，可以使用make进行编译，由于我们需要编译的是rpm安装包，所以可直接使用<code>make rpm</code>进行。更多编译操作，可通过<code>make help</code>查看。</li>
</ul>
<p>*** 目前，Moby的编译主要问题处在GFW对网络封锁上，如遇到其它问题，请第一时间确认该网络是否能访问，尤其是中国大陆地区。 ***</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.ybojj.com/docker%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91/">docker源代码编译</a></li>
<li>感谢同事为我提供的VPN服务</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/05/25/storage/ceph/ceph-nfs-service-by-rgw-with-nfs-ganesha/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/25/storage/ceph/ceph-nfs-service-by-rgw-with-nfs-ganesha/" class="post-title-link" itemprop="url">Ceph提供NFS服务 —— RGW＋nfs-ganesha</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-25 09:43:37" itemprop="dateCreated datePublished" datetime="2017-05-25T09:43:37+08:00">2017-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/ceph/nfs-ganesha.jpg" alt="nfs-ganesha.jpg"></p>
<p>Ceph是统一存储，包括块、文件、对象。其中块存储必须映射给linux内核，然后才能用，而内核客户端代码的更新收到了linus的限制，已经好久没更新了。librbd又不能直接用，不过道是可以用nbd映射一下使用。cephfs目前还不太适合生产环境。目前<code>*nix</code>对nfs的支持还是很全面的，而对librbd、cephfs的支持就是大不一样了。so，使ceph支持nfs协议很有意义了，but！ceph是分布式存储，被ganesha一搞，出现了单节点问题，所以只能想办法从HA角度解决了，这也是一种无奈，唉。。。</p>
<p>（～～一丝光～～）从nfs v4.1开始支持并行存储，这或许是一缕新曙光。</p>
<h1 id="NFS-Ganesha架构"><a href="#NFS-Ganesha架构" class="headerlink" title="NFS-Ganesha架构"></a>NFS-Ganesha架构</h1><p><img src="/images/ceph/ceph-nfs-service-by-rgw-with-nfs-ganesha.png" alt="ceph-nfs-service-by-rgw-with-nfs-ganesha.png"></p>
<h1 id="实施"><a href="#实施" class="headerlink" title="实施"></a>实施</h1><h2 id="RGW搭建"><a href="#RGW搭建" class="headerlink" title="RGW搭建"></a>RGW搭建</h2><p>关于RGW的安装搭建请于<a target="_blank" rel="noopener" href="http://www.ceph.com/">Ceph官网</a>查看</p>
<h4 id="用户创建"><a href="#用户创建" class="headerlink" title="用户创建"></a>用户创建</h4><p>创建一个S3用户专门服务于nfs-ganesha</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> radosgw-admin --uid=nfs_ganesha_user --display=<span class="string">&quot;User for NFS-Ganesha&quot;</span></span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;user_id&quot;: &quot;nfs_ganesha_user&quot;,</span><br><span class="line">    &quot;display_name&quot;: &quot;User for NFS-Ganesha&quot;,</span><br><span class="line">    &quot;email&quot;: &quot;&quot;,</span><br><span class="line">    &quot;suspended&quot;: 0,</span><br><span class="line">    &quot;max_buckets&quot;: 1000,</span><br><span class="line">    &quot;auid&quot;: 0,</span><br><span class="line">    &quot;subusers&quot;: [],</span><br><span class="line">    &quot;keys&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;user&quot;: &quot;nfs_ganesha_user&quot;,</span><br><span class="line">            &quot;access_key&quot;: &quot;xxxxxxxxxxxxxxxxxxxx&quot;,</span><br><span class="line">            &quot;secret_key&quot;: &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;swift_keys&quot;: [],</span><br><span class="line">    &quot;caps&quot;: [],</span><br><span class="line">    &quot;op_mask&quot;: &quot;read, write, delete&quot;,</span><br><span class="line">    &quot;default_placement&quot;: &quot;&quot;,</span><br><span class="line">    &quot;placement_tags&quot;: [],</span><br><span class="line">    &quot;bucket_quota&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false,</span><br><span class="line">        &quot;max_size_kb&quot;: -1,</span><br><span class="line">        &quot;max_objects&quot;: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;user_quota&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false,</span><br><span class="line">        &quot;max_size_kb&quot;: -1,</span><br><span class="line">        &quot;max_objects&quot;: -1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;temp_url_keys&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>user</code>、<code>access_key</code>、<code>secret_key</code>是后续nfs-ganesha配置是需要使用到的。</p>
<h2 id="nfs-ganesha编译部署"><a href="#nfs-ganesha编译部署" class="headerlink" title="nfs-ganesha编译部署"></a>nfs-ganesha编译部署</h2><h4 id="获取Project"><a href="#获取Project" class="headerlink" title="获取Project"></a>获取Project</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// clone nfs-ganesha project</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/nfs-ganesha/nfs-ganesha.git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./nfs-ganesha</span></span><br><span class="line"></span><br><span class="line">// 切换到v2.4 stable版本</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout V2.4-stable</span></span><br><span class="line"></span><br><span class="line">// 获取submodule libntirpc</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git submodule update --init</span></span><br></pre></td></tr></table></figure>

<p>在正式开始编译前，需要安装一些包，<code>libntirpc</code>强制使用了GSS，使用<code>-DUSE_GSS=OFF</code>是不能关闭GSS使用的。所以在编译nfs-ganesha时不需要关闭GSS。<br>本人编译使用的系统是rhel7.2，需要安装一些软件包<code>krb5-libs-1.14.1-27.el7_3.x86_64</code>、<code>krb5-devel-1.14.1-27.el7_3.x86_64</code>、<code>libgssglue-0.4-2.el7.nux.x86_64</code>、<code>libgssglue-devel-0.4-2.el7.nux.x86_64</code></p>
<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// libntirpc 编译 </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./nfs-ganesha/src/libntirpc</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake ./</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// nfs-ganesha 编译</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./nfs-ganesha</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> ./build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ./build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake -DUSE_NLM=OFF -DRGW_PREFIX=/usr -DUSE_FSAL_RGW=ON -DUSE_FSAL_CEPH=OFF -DCMAKE_INSTALL_PREFIX=/home/xxxxx/.local -DUSE_GSS=ON -DUSE_FSAL_ZFS=OFF -DUSE_NFSIDMAP=OFF -DUSE_FSAL_GLUSTER=OFF ../src</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make install</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// 为了能让ganesha正常运行，需要更新一下ld.cache，保证动态库可以正常加载</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">echo</span> <span class="string">&quot;/home/xxxxx/.local/lib64/ganesha&quot;</span> &gt;&gt; /etc/ld.so.conf</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ldconfig -v</span></span><br><span class="line"></span><br><span class="line">//生成RPM包</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cpack -G RPM</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="配置启动"><a href="#配置启动" class="headerlink" title="配置启动"></a>配置启动</h3><h4 id="配置RGW的Keyring"><a href="#配置RGW的Keyring" class="headerlink" title="配置RGW的Keyring"></a>配置RGW的Keyring</h4><p>librgw 访问ceph时会用到keyring，它回去<code>/var/lib/ceph/radosgw/ceph-admin</code>这个目录下去找<code>keyring</code>，这个目录需要用户自己创建并，copy一个keyring进去，这个keyring可以是admin，也可以是rgw实用的keyring，从权限管理角度建议使用rgw的keyring</p>
<h4 id="撰写ganesha-conf-rgw"><a href="#撰写ganesha-conf-rgw" class="headerlink" title="撰写ganesha.conf.rgw"></a>撰写<code>ganesha.conf.rgw</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">###################################################</span><br><span class="line">#</span><br><span class="line"># EXPORT</span><br><span class="line">#</span><br><span class="line"># To function, all that is required is an EXPORT</span><br><span class="line">#</span><br><span class="line"># Define the absolute minimal export</span><br><span class="line">#</span><br><span class="line">###################################################</span><br><span class="line"></span><br><span class="line">EXPORT</span><br><span class="line">&#123;</span><br><span class="line">        # Export Id (mandatory, each EXPORT must have a unique Export_Id)</span><br><span class="line">        Export_Id = 1;</span><br><span class="line"></span><br><span class="line">        # Exported path (mandatory)</span><br><span class="line">        Path = &quot;nfs_bucket&quot;;</span><br><span class="line"></span><br><span class="line">        # Pseudo Path (required for NFS v4)</span><br><span class="line">        Pseudo = &quot;/nfs_bucket&quot;;</span><br><span class="line"></span><br><span class="line">        # Required for access (default is None)</span><br><span class="line">        # Could use CLIENT blocks instead</span><br><span class="line">        Access_Type = RW;</span><br><span class="line">        Protocols = 4;</span><br><span class="line">        Transports = TCP;</span><br><span class="line"></span><br><span class="line">        # Exporting FSAL</span><br><span class="line">        FSAL &#123;</span><br><span class="line">             # Name = VFS;</span><br><span class="line">             Name = RGW;</span><br><span class="line">             User_Id = &quot;xxxxxxxxxxx&quot;;</span><br><span class="line">             Access_Key_Id = &quot;xxxxxxxxxxxxxxxxxxxx&quot;;</span><br><span class="line">             Secret_Access_Key = &quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RGW &#123;</span><br><span class="line">        ceph_conf = &quot;/etc/ceph/ceph.conf&quot;;</span><br><span class="line">        name = &quot;client.admin&quot;;</span><br><span class="line">        cluster = &quot;ceph&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="运行ganesha进程"><a href="#运行ganesha进程" class="headerlink" title="运行ganesha进程"></a>运行ganesha进程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ganesha.nfsd -f /home/xxxxx/.local/etc/ganesha/ganesha.conf.rgw -F -L /var/log/ganesha.log</span><br></pre></td></tr></table></figure>

<h4 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs4 192.168.1.82:/nfs_bucket /mnt</span><br></pre></td></tr></table></figure>


<h2 id="docker容器部署"><a href="#docker容器部署" class="headerlink" title="docker容器部署"></a>docker容器部署</h2><h3 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h3><p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/ananace/nfs-ganesha-ceph">ananace&#x2F;nfs-ganesha-ceph</a></p>
<h3 id="gannesha配置"><a href="#gannesha配置" class="headerlink" title="gannesha配置"></a>gannesha配置</h3><p>配置上来讲与编译部署没有太大差别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># NFS protocol options</span><br><span class="line">EXPORT</span><br><span class="line">&#123;</span><br><span class="line">  # Export Id (mandatory, each EXPORT must have a unique Export_Id)</span><br><span class="line">  Export_Id = 77;</span><br><span class="line"></span><br><span class="line">  # Exported path (mandatory)</span><br><span class="line">  Path = /;</span><br><span class="line"></span><br><span class="line">  # Pseudo Path (for NFS v4)</span><br><span class="line">  Pseudo = /;</span><br><span class="line"></span><br><span class="line">  # Access control options</span><br><span class="line">  Access_Type = RW;</span><br><span class="line">  Squash = No_Root_Squash;</span><br><span class="line"></span><br><span class="line">  # NFS protocol options</span><br><span class="line">  SecType = &quot;sys&quot;;</span><br><span class="line">  Transports = TCP;</span><br><span class="line">  Protocols = 4;</span><br><span class="line"></span><br><span class="line">  # Exporting FSAL</span><br><span class="line">  FSAL &#123;</span><br><span class="line">    Name = RGW;</span><br><span class="line">    User_Id = &quot;admin&quot;;</span><br><span class="line">    Access_Key_Id = &quot;8I4K2USDV5SK3UFLQUB0&quot;;</span><br><span class="line">    Secret_Access_Key = &quot;A4JuvB468tmnDpmkZMfwesb2zmGZeSiCJlzJMALc&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RGW &#123;</span><br><span class="line">    cluster = &quot;ceph&quot;;</span><br><span class="line">    ceph_conf = &quot;/etc/ceph/ceph.conf&quot;;</span><br><span class="line">    name = &quot;client.rgw.host-10-100-13-111&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行ganesha容器"><a href="#运行ganesha容器" class="headerlink" title="运行ganesha容器"></a>运行ganesha容器</h3><p>由于Ganesha 的 FSAL 使用到了librgw，所以在镜像中会装好<code>ceph-common</code>、<code>librgw2</code>等。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net=host  -v /home/xxx/ceph/etc_ceph/:/etc/ceph:ro -v /home/xxx/ceph/ganesha/:/etc/ganesha:ro -v /home/xxx/ceph/var_lib_ceph/:/var/lib/ceph --name nfs -e GANESHA_BOOTSTRAP_CONFIG=no ananace/nfs-ganesha-ceph</span><br></pre></td></tr></table></figure>
<p>docker 启动是需要设置环境变量<code>GANESHA_BOOTSTRAP_CONFIG=no</code>，默认配置为<code>yes</code>；若为<code>yes</code>的化，nfs-ganesha在启动的时候会重置<code>/etc/ganesha/ganesha.conf</code>配置文件。</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nfs-ganesha/nfs-ganesha/issues/152">Will not compile with USE_GSS&#x3D;”OFF”</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/yAV7R3N">rgw实现nfs的首测</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tuicool.com/articles/JFRn2me">NFS + CephFS 构建基于 Ceph 的 NAS 服务</a></li>
<li><a target="_blank" rel="noopener" href="http://www.php230.com/1492048922.html">通过ganesha-nfs将 Ceph 导出为 NFS</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/alexyuyu/articles/3509255.html">LD_LIBRARY_PATH</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/ananace/nfs-ganesha-ceph">ananace&#x2F;nfs-ganesha-ceph</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/05/18/security/gpg-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/18/security/gpg-usage/" class="post-title-link" itemprop="url">GPG(GunPG)的使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-18 16:49:45" itemprop="dateCreated datePublished" datetime="2017-05-18T16:49:45+08:00">2017-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/security/" itemprop="url" rel="index"><span itemprop="name">security</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/security/gpg/gpg_usage.png" alt="gpg_usage.png"><br>加密的一个简单但又实用的任务就是发送加密电子邮件。多年来，为电子邮件进行加密的标准一直是PGP（Pretty Good Privacy）。程序员Phil Zimmermann特别为电子邮件的保密编写的PGP。这个软件非常好用，迅速流传开来，成了许多程序员的必备工具。但是，它是商业软件，不能自由使用。作为PGP的替代，如今已经有一个开放源代码的类似产品可供使用。GPG（Gnu Privacy Guard），它不包含专利算法，能够无限制的用于商业应用。</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>RHEL7.2<br>  默认以安装GPG</li>
<li>GPG 2.0.22<br>  libgcrypt 1.5.3</li>
</ul>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><h2 id="生成密钥"><a href="#生成密钥" class="headerlink" title="生成密钥"></a>生成密钥</h2><p>使用<code>--gen-key</code>生成一副新的密钥对</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg --gen-key</span></span><br><span class="line">gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">请选择您要使用的密钥种类：</span><br><span class="line">   (1) RSA and RSA (default)</span><br><span class="line">   (2) DSA and Elgamal</span><br><span class="line">   (3) DSA (仅用于签名)</span><br><span class="line">   (4) RSA (仅用于签名)</span><br><span class="line">您的选择？</span><br></pre></td></tr></table></figure>
<p>第一段是版权声明，然后让用户自己选择加密算法。默认选择第一个选项，表示加密和签名都使用RSA算法。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RSA 密钥长度应在 1024 位与 4096 位之间。</span><br><span class="line">您想要用多大的密钥尺寸？(2048)</span><br></pre></td></tr></table></figure>
<p>这一步要让我们输入密钥长度，长度越长越安全,默认为2048。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">您所要求的密钥尺寸是 2048 位              </span><br><span class="line">请设定这把密钥的有效期限。</span><br><span class="line">         0 = 密钥永不过期</span><br><span class="line">      &lt;n&gt;  = 密钥在 n 天后过期</span><br><span class="line">      &lt;n&gt;w = 密钥在 n 周后过期</span><br><span class="line">      &lt;n&gt;m = 密钥在 n 月后过期</span><br><span class="line">      &lt;n&gt;y = 密钥在 n 年后过期</span><br><span class="line">密钥的有效期限是？(0)</span><br></pre></td></tr></table></figure>
<p>如果密钥只是个人使用，并且你很确定可以有效保管私钥，建议选择第一个选项，即永不过期。注意，如果想设置在2年后过期，那么应该输入2y,然后回车 回答完上面三个问题以后，系统让你确认。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">密钥于 日 10/ 8 11:20:32 2017 CST 过期</span><br><span class="line">以上正确吗？(y/n)</span><br></pre></td></tr></table></figure>
<p>到这里，我们对要生成的密钥的配置已经完成了，然后我们还需要一个标识，接下来按照要求依次输入就行了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">You need a user ID to identify your key; the software constructs the user ID</span><br><span class="line">from the Real Name, Comment and Email Address in this form:</span><br><span class="line">    &quot;Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;&quot;</span><br><span class="line"></span><br><span class="line">真实姓名：Zhang San</span><br><span class="line">电子邮件地址：zhangsan@x163.com</span><br><span class="line">注释：</span><br><span class="line"></span><br><span class="line">您选定了这个用户标识：</span><br><span class="line">    “Zhang San &lt;zhangsan@163.com&gt;”</span><br><span class="line"></span><br><span class="line">更改姓名(N)、注释(C)、电子邮件地址(E)或确定(O)/退出(Q)？</span><br></pre></td></tr></table></figure>
<p>输入<code>o</code>确定，然后在弹出的窗口输入密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">我们需要生成大量的随机字节。这个时候您可以多做些琐事(像是敲打键盘、移动</span><br><span class="line">鼠标、读写硬盘之类的)，这会让随机数字发生器有更好的机会获得足够的熵数。</span><br><span class="line">.+++++</span><br><span class="line">...+++++</span><br><span class="line">我们需要生成大量的随机字节。这个时候您可以多做些琐事(像是敲打键盘、移动</span><br><span class="line">鼠标、读写硬盘之类的)，这会让随机数字发生器有更好的机会获得足够的熵数。</span><br><span class="line">....................+++++</span><br><span class="line">...........+++++</span><br><span class="line">gpg: /home/XXXX/.gnupg/trustdb.gpg：建立了信任度数据库</span><br><span class="line">gpg: 密钥 74A64469 被标记为绝对信任</span><br><span class="line">公钥和私钥已经生成并经签名。</span><br><span class="line"></span><br><span class="line">gpg: 正在检查信任度数据库</span><br><span class="line">gpg: 需要 3 份勉强信任和 1 份完全信任，PGP 信任模型</span><br><span class="line">gpg: 深度：0 有效性：  1 已签名：  0 信任度：0-，0q，0n，0m，0f，1u</span><br><span class="line">gpg: 下次信任度数据库检查将于 2017-10-08 进行</span><br><span class="line">pub   2048R/74A64469 2016-10-08 [有效至：2017-10-08]</span><br><span class="line">密钥指纹 = 2187 78CA 2E78 83C2 039C  E47B D94A 622A 74A6 5569</span><br><span class="line">uid                  Zhang San &lt;zhangsan@163.com&gt;</span><br><span class="line">sub   2048R/490E5BC8 2016-10-08 [有效至：2017-10-08]</span><br></pre></td></tr></table></figure>
<p>请注意上面的字符串”74A64469”，这是”用户ID”的Hash字符串，可以用来替代”用户ID”。到此为止，我们已经完成了生成公钥和私钥的任务了,文件在&#x2F;home&#x2F;XXXX&#x2F;.gnupg&#x2F;pubring.gpg</p>
<p>这时，最好再生成一张”撤销证书”，以备以后密钥作废时，可以请求外部的公钥服务器撤销你的公钥。使用<code>--gen-revoke 74A64469</code>进行，此处不再赘述。</p>
<h2 id="查看密钥列表"><a href="#查看密钥列表" class="headerlink" title="查看密钥列表"></a>查看密钥列表</h2><p>使用<code>--list-keys</code>列出当前用户已有的密钥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg --list-keys</span></span><br><span class="line">/home/zhoub/.gnupg/pubring.gpg</span><br><span class="line">------------------------------</span><br><span class="line">pub   2048R/6058BC49 2017-05-16</span><br><span class="line">uid                  zhou bo (for coreos build) &lt;zhoubofsy@hotmail.com&gt;</span><br><span class="line">sub   2048R/A47EF901 2017-05-16</span><br></pre></td></tr></table></figure>
<p>第一行显示公钥文件名（pubring.gpg），第二行显示公钥特征（2048位,RSA，Hash字符串和生成时间），第三行显示”用户ID”，第四行显示私钥特征(格式与公钥相同)。<br>如果你要从密钥列表中删除某个密钥，可以使用delete-key参数<code>gpg --delete-key [用户ID]</code></p>
<h2 id="输出密钥"><a href="#输出密钥" class="headerlink" title="输出密钥"></a>输出密钥</h2><p>** 公钥导出 **<br>公钥文件（.gnupg&#x2F;pubring.gpg）以二进制形式储存，armor参数可以将其转换为ASCII码显示。<code>gpg --armor --output public-key.txt --export [用户ID]</code></p>
<p>** 私钥导出 **<br>export-secret-keys参数可以转换私钥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --armor --output private-key.txt --export-secret-keys</span><br></pre></td></tr></table></figure>

<h2 id="上传公钥"><a href="#上传公钥" class="headerlink" title="上传公钥"></a>上传公钥</h2><p>公钥服务器是网络上专门储存用户公钥的服务器。send-keys参数可以将公钥上传到服务器<code>gpg --send-keys [用户ID] --keyserver hkp://subkeys.pgp.net</code>使用上面的命令，你的公钥就被传到了服务器subkeys.pgp.net，然后通过交换机制，所有的公钥服务器最终都会包含你的公钥。</p>
<p>由于公钥服务器没有检查机制，任何人都可以用你的名义上传公钥，所以没有办法保证服务器上的公钥的可靠性。通常，你可以在网站上公布一个公钥指纹，让其他人核对下载到的公钥是否为真。fingerprint参数生成公钥指纹。<code>gpg --fingerprint [用户ID]</code></p>
<h2 id="输入密钥"><a href="#输入密钥" class="headerlink" title="输入密钥"></a>输入密钥</h2><p>除了生成自己的密钥，还需要将他人的公钥或者你的其他密钥输入系统。这时可以使用import参数<code>gpg --import [密钥文件]</code></p>
<p>为了获得他人的公钥，可以让对方直接发给你，或者到公钥服务器上寻找<code>gpg --keyserver hkp://subkeys.pgp.net --search-keys [用户ID]</code><br>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg --recv-keys E82E4209</span></span><br><span class="line">gpg: 下载密钥‘E82E4209’，从 hkp 服务器 keys.gnupg.net</span><br><span class="line">gpg: 密钥 E82E4209：公钥“Vladimir &#x27;phcoder&#x27; Serbinenko &lt;phcoder@gmail.com&gt;”已导入</span><br><span class="line">gpg: 没有找到任何绝对信任的密钥</span><br><span class="line">gpg: 合计被处理的数量：1</span><br><span class="line">gpg: 已导入：1</span><br></pre></td></tr></table></figure>

<h2 id="加密和解密"><a href="#加密和解密" class="headerlink" title="加密和解密"></a>加密和解密</h2><p>使用<code>--encrypt</code>参数用于加密。假设有一个原始文件<code>test.txt</code></p>
<p>** 使用公钥(Hash字符串)加密：**</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg --recipient 74A64469 --output test_en.txt --encrypt test.txt</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>--recipient</code>参数指定接收者的公钥</li>
<li><code>--output</code>参数指定加密后的文件名</li>
<li><code>--encrypt</code>参数指定源文件</li>
</ul>
<p>** 使用私钥解密：**</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg test_en.txt</span></span><br><span class="line"></span><br><span class="line">bogon:Desktop XXXX$ gpg test_en.txt</span><br><span class="line"></span><br><span class="line">您需要输入密码，才能解开这个用户的私钥：“Zhang San &lt;zhangsan@163.com&gt;”</span><br><span class="line">2048 位的 RSA 密钥，钥匙号 490E5BC8，建立于 2016-10-08 (主钥匙号 74A64469)</span><br><span class="line"></span><br><span class="line">gpg: 由 2048 位的 RSA 密钥加密，钥匙号为 490E5BC8、生成于 2016-10-08</span><br><span class="line">      “Zhang San &lt;zhangsan@163.com&gt;”</span><br><span class="line">gpg: test_en.txt：未知的后缀名</span><br><span class="line">请输入新的文件名 [test.txt]: test2.txt</span><br></pre></td></tr></table></figure>
<h2 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h2><p>有时，我们不需要加密文件，只需要对文件签名，表示这个文件确实是我本人发出的。<code>--sign</code>参数用来签名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg --sign test.txt</span></span><br></pre></td></tr></table></figure>
<p>然后生成了一个test.txt.gpg文件，我们打开这个文件后，发现这也是一个二进制的数据，这并不是加密后的数据，与上边的二进制数据不一样。<br>如果想生成ASCII码的签名文件，可以使用<code>--clearsign</code>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg --clearsign test.txt</span></span><br></pre></td></tr></table></figure>
<p>然后生成了一个test.txt.asc文件。<br>如果想生成单独的签名文件，与文件内容分开存放，可以使用<code>--detach-sign</code>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gpg --detach-sign test.txt</span></span><br></pre></td></tr></table></figure>
<p>多产生一个<code>,sig</code>的二进制签名文件，如果想采用ASCII码形式，要加上<code>--armor</code>参数。</p>
<h2 id="签名-加密"><a href="#签名-加密" class="headerlink" title="签名+加密"></a>签名+加密</h2><p>如果想同时签名和加密，可使用这种格式<code>gpg --local-user [发信者ID] --recipient [接收者ID] --armor --sign --encrypt test.txt</code></p>
<ul>
<li><code>--local-user</code>参数指定用发信者的私钥签名</li>
<li><code>--recipient</code>参数指定用接收者的公钥加密</li>
<li><code>--armor</code>参数表示采用ASCII码形式显示</li>
<li><code>--sign</code>参数表示需要签名</li>
<li><code>--encrypt</code>参数表示指定源文件</li>
</ul>
<h2 id="验证签名"><a href="#验证签名" class="headerlink" title="验证签名"></a>验证签名</h2><p>收到别人签名后的文件，需要用对方的公钥验证签名是否为真。使用<code>--verify</code>参数用来验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gpg --verify test.txt.sig test.txt</span><br><span class="line">gpg: Signature made Wed 17 May 2017 04:12:50 PM CST using RSA key ID 74A64469</span><br><span class="line">gpg: Good signature from &quot;Zhang San &lt;zhangsan@163.com&gt;&quot;</span><br><span class="line">gpg: WARNING: This key is not certified with a trusted signature!</span><br><span class="line">gpg:          There is no indication that the signature belongs to the owner.</span><br><span class="line">Primary key fingerprint: 0B77 E327 B365 316D F112  4521 ABC0 9164 6058 BC49</span><br></pre></td></tr></table></figure>

<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/machao/p/5938744.html">GPG终极指南（加密&#x2F;签名）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/daemon369/p/3204020.html">Linux下使用.sig签名文件验证签名</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/05/18/container/coreos/coreos-build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/18/container/coreos/coreos-build/" class="post-title-link" itemprop="url">CoreOS镜像制作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-18 13:56:31" itemprop="dateCreated datePublished" datetime="2017-05-18T13:56:31+08:00">2017-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/coreos/coreos_build.jpg" alt="coreos_build.jpg"></p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>CoreOS，一个轻量的linux分布式操作系统。CoreOS中的应用都以容器形式在系统中运行。个人觉得CoreOS不能算是一个linux发行版，只能算是一种订制系统。(BTW，CoreOS的订制应该是源自Gentoo这个发行版)</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>CoreOS的编译与操作系统无关（此处使用的是RHEL7.2），硬件要求必须是X86-64系统。</li>
<li>编译系统必须安装 curl、git、python2、bzip2</li>
<li>CoreOS SDK编译有两种方法（<a target="_blank" rel="noopener" href="https://coreos.com/os/docs/latest/sdk-modifying-coreos.html">Option1 &amp; Option2</a>），Option1 需要选择和需要编译的CoreOS相匹配的golang版本。</li>
<li>使用Option2 方法安装，需要设置<code>https_proxy</code>代理（否则，无法法访问GoogleSource）</li>
</ul>
<h1 id="制作-安装"><a href="#制作-安装" class="headerlink" title="制作&amp;安装"></a>制作&amp;安装</h1><p>本人使用Option2方法完成CoreOS编译，并使用coreos-install安装CoreOS到xen vm上。</p>
<h2 id="制作"><a href="#制作" class="headerlink" title="制作"></a>制作</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><h4 id="安装Repo"><a href="#安装Repo" class="headerlink" title="安装Repo"></a>安装Repo</h4><p>下载repo，用于下载CoreOS SDK</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://storage.googleapis.com/git-repo-downloads/repo &gt; ./repo</span><br><span class="line">chmod a+x ./repo</span><br></pre></td></tr></table></figure>

<h4 id="下载SDK"><a href="#下载SDK" class="headerlink" title="下载SDK"></a>下载SDK</h4><p>创建一个目录用于存放coreos sdk</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir coreos</span><br><span class="line">cd coreos</span><br></pre></td></tr></table></figure>
<p>repo初始化目录，并同步git repos</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://github.com/coreos/manifest.git</span><br><span class="line">repo sync</span><br></pre></td></tr></table></figure>

<h4 id="Chroot到coreos-SDK"><a href="#Chroot到coreos-SDK" class="headerlink" title="Chroot到coreos SDK"></a>Chroot到coreos SDK</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./chromite/bin/cros_sdk</span><br></pre></td></tr></table></figure>

<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><h4 id="设置core用户登陆密码"><a href="#设置core用户登陆密码" class="headerlink" title="设置core用户登陆密码"></a>设置core用户登陆密码</h4><p>设置core用户密码，已被系统安装完后登陆系统使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./set_shared_user_password.sh</span><br></pre></td></tr></table></figure>

<h4 id="选择目标编译平台"><a href="#选择目标编译平台" class="headerlink" title="选择目标编译平台"></a>选择目标编译平台</h4><p>选择<code>amd64-usr</code>或<code>arm64-usr</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./setup_board --default --board=amd64-usr</span><br></pre></td></tr></table></figure>

<h4 id="编译Packages"><a href="#编译Packages" class="headerlink" title="编译Packages"></a>编译Packages</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build_packages</span><br></pre></td></tr></table></figure>

<h4 id="制作CoreOS镜像"><a href="#制作CoreOS镜像" class="headerlink" title="制作CoreOS镜像"></a>制作CoreOS镜像</h4><p>可以选择编译开发版(<code>dev</code>)还是生成版(<code>prod</code>)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build_image prod</span><br></pre></td></tr></table></figure>

<h4 id="制作可以引导CoreOS镜像"><a href="#制作可以引导CoreOS镜像" class="headerlink" title="制作可以引导CoreOS镜像"></a>制作可以引导CoreOS镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./image_to_vm.sh --board=amd64-usr --format=xen --from=/mnt/host/source/src/build/images/amd64-usr/developer-1409.0.0+2017-05-15-1456-a1/coreos_production_image.bin --disk_layout=base</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--format</code> 根据不同需要选择制作不同格式的可引导镜像</li>
<li><code>--disk_layout</code> 默认是空，建议选择<code>base</code></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>*** 经过上述步骤的操作，已经将coreos镜像制作完成，并放置在”.&#x2F;src&#x2F;build&#x2F;images&#x2F;amd64-usr”目录下。 ***</p>
<p>安装的过程需要使用liveCD启动，然后挂在需要安装的裸盘，使用<code>coreos-install</code>安装。镜像的传递是，先将镜像放置到一个webserver上，然后<code>coreos-install</code>再通过这个webserver下载、并安装。</p>
<p>*** 在将镜像放置到webserver之前，需要先将镜像压缩成bz2文件，然后再将bz2进行签名 ***（签名无法使用官方的私钥，只能自己申请，<a href="https://zhoubofsy.github.io/2017/05/18/security/gpg-usage/">详细请见</a>）。</p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>*** 本人的安装步骤，不是唯一的、方便、快捷的方法，更多安装方式建议阅者自行调研 ***</p>
<h4 id="下载coreos-install安装脚本"><a href="#下载coreos-install安装脚本" class="headerlink" title="下载coreos-install安装脚本"></a>下载coreos-install安装脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/init/master/bin/coreos-install</span><br></pre></td></tr></table></figure>

<h4 id="修改coreos-install中的公钥"><a href="#修改coreos-install中的公钥" class="headerlink" title="修改coreos-install中的公钥"></a>修改coreos-install中的公钥</h4><p>在coreos-install中有个变量<code>GPG_KEY</code>用于存储官方的公钥，需要将这个公钥换成你给镜像签名时对应的公钥。</p>
<p>** 此处略去俺公钥内容 **</p>
<p>镜像在下载到目标机后，coreos-install会对下载的镜像进行校验，这是不替换公钥，只能想办法让官方帮你签名</p>
<h4 id="使用coreos-install安装CoreOS"><a href="#使用coreos-install安装CoreOS" class="headerlink" title="使用coreos-install安装CoreOS"></a>使用coreos-install安装CoreOS</h4><p>使用liveCD启动系统后，先确认需要安装CoreOS的硬盘，然后执行<code>coreos-install</code>进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./coreos-install -d /dev/xvda -V 1409.0.0 -o xen -v -b http://192.168.1.82:8000 -c /media/configdrive/openstack/latest/user_data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-d</code> 指定安装目标设备</li>
<li><code>-V</code> 指定安装版本，一定要与URL中的路径能匹配上</li>
<li><code>-o</code> 镜像名称中需要指出是<code>xen</code>or<code>kvm</code>or…</li>
<li><code>-b</code> 镜像下载URL</li>
</ul>
<h1 id="问题-解决"><a href="#问题-解决" class="headerlink" title="问题&amp;解决"></a>问题&amp;解决</h1><h2 id="不能引导问题"><a href="#不能引导问题" class="headerlink" title="不能引导问题"></a>不能引导问题</h2><p>若成功编译安装，但不能正常引导，可以对比做bzip2之前镜像的前512字节和安装后xvda的前512字节是否一致。本人遇到不能引导问题，是因为本应使用<code>bzip2</code>压缩的镜像使用了<code>tar</code></p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li>感谢同事为我提供的VPN翻墙服务</li>
<li>感谢同事为我提供的WebService服务，方便完成网络安装CoreOS</li>
<li><a target="_blank" rel="noopener" href="https://coreos.com/os/docs/latest/sdk-modifying-coreos.html">container linux document</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/05/12/network/iptables-introduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/12/network/iptables-introduce/" class="post-title-link" itemprop="url">iptables</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-12 09:21:14" itemprop="dateCreated datePublished" datetime="2017-05-12T09:21:14+08:00">2017-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>iptables是一个配置Linux内核防火墙的命令行工具，是netfilter项目的一部分。术语iptables也经常代指该内核级防火墙。iptables用于ipv4，ip6tables用于ipv6。<br>( nftables已经包含在Linux kernel 3.13中，以后会取代iptables成为主要的Linux防火墙工具。 )</p>
<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><p>iptables v1.4.21</p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>理解 iptables 如何工作的关键是下面这张图。图中在上面的小写字母代表”表”，在下面的大写字母代表”链”。从任何网络端口进来的每一个 IP 数据包都要从上到下的穿过这张图。一种常见的困扰是认为 iptables 对从内部端口进入的数据包和从面向互联网端口进入的数据包采取不同的处理方式，相反，iptabales 对从任何端口进入的数据包都会采取相同的处理方式。可以定义规则使 iptables 采取不同的方式对待从不同端口进入的数据包。当然一些数据包是用于本地进程的，因此在图中表现为从顶端进入，到<code>Local Process</code>停止，而另一些数据包是由本地进程生成的，因此在图中表现为从<code>Local Process</code>发出，一直向下穿过该流程图。</p>
<p><img src="/images/iptables/iptables_traverse.jpg" alt="iptables_traverse.jpg"></p>
<ol>
<li>数据包到达网络接口，比如 eth0</li>
<li>进入 raw 表的 PREROUTING 链，这个链的作用是赶在连接跟踪之前处理数据包</li>
<li>如果进行了连接跟踪，在此处理</li>
<li>进入 mangle 表的 PREROUTING 链，在此可以修改数据包，比如 TOS 等</li>
<li>进入 nat 表的 PREROUTING 链，可以在此做DNAT，但不要做过滤</li>
<li>决定路由，看是交给本地主机还是转发给其它主机<br>一种情况是，数据包就是发给本地主机的:</li>
<li>进入 mangle 表的 INPUT 链，这里是在路由之后，交由本地主机之前，我们也可以进行一些相应的修改</li>
<li>进入 filter 表的 INPUT 链，在这里我们可以对流入的所有数据包进行过滤，无论它来自哪个网络接口</li>
<li>交给本地主机的应用程序进行处理</li>
<li>处理完毕后进行路由决定，看该往那里发出</li>
<li>进入 raw 表的 OUTPUT 链，这里是在连接跟踪处理本地的数据包之前</li>
<li>连接跟踪对本地的数据包进行处理</li>
<li>进入 mangle 表的 OUTPUT 链，在这里我们可以修改数据包，但不要做过滤</li>
<li>进入 nat 表的 OUTPUT 链，可以对防火墙自己发出的数据做 NAT</li>
<li>再次进行路由决定</li>
<li>进入 filter 表的 OUTPUT 链，可以对本地出去的数据包进行过滤</li>
<li>进入 mangle 表的 POSTROUTING 链，到这里已经做完了所有的路由决定，但数据包仍然在本地主机，我们还可以进行某些修改<br>注意，这里不光对经过防火墙的数据包进行处理，还对防火墙自己产生的数据包进行处理</li>
<li>进入 nat 表的 POSTROUTING 链，在这里一般都是用来做 SNAT ，不要在这里进行过滤</li>
<li>进入出去的网络接口<br>一种情况是，数据包要转发给其它主机:</li>
<li>进入 mangle 表的 FORWARD 链，这里也比较特殊，这是在第一次路由决定之后，在进行最后的路由决定之前，我们仍然可以对数据包进行某些修改</li>
<li>进入 filter 表的 FORWARD 链，在这里我们可以对所有转发的数据包进行过滤。需要注意的是：经过这里的数据包是转发的，方向是双向的</li>
<li>进入 mangle 表的 POSTROUTING 链，到这里已经做完了所有的路由决定，但数据包仍然在本地主机，我们还可以进行某些修改</li>
<li>进入 nat 表的 POSTROUTING 链，在这里一般都是用来做 SNAT ，不要在这里进行过滤</li>
<li>进入出去的网络接口</li>
</ol>
<p>该流程图描述链了在任何接口上收到的网络数据包是按照怎样的顺序穿过表的交通管制链。第一个路由策略包括决定数据包的目的地是本地主机（这种情况下，数据包穿过 INPUT 链），还是其他主机（数据包穿过 FORWARD 链）；中间的路由策略包括决定给传出的数据包使用那个源地址、分配哪个接口；最后一个路由策略存在是因为先前的 mangle 与 nat 链可能会改变数据包的路由信息。数据包通过路径上的每一条链时，链中的每一条规则按顺序匹配；无论何时匹配了一条规则，相应的 target&#x2F;jump 动作将会执行。最常用的3个 target 是 ACCEPT, DROP ,或者 jump 到用户自定义的链。内置的链有默认的策略，但是用户自定义的链没有默认的策略。在 jump 到的链中，若每一条规则都不能提供完全匹配，那么数据包像这张图片描述的一样返回到调用链。在任何时候，若 DROP target 的规则实现完全匹配，那么被匹配的数据包会被丢弃，不会进行进一步处理。如果一个数据包在链中被 ACCEPT，那么它也会被所有的父链 ACCEPT，并且不再遍历其他父链。然而，要注意的是，数据包还会以正常的方式继续遍历其他表中的其他链。</p>
<p><img src="/images/iptables/iptables_user_kernel_traverse.png" alt="iptables_user_kernel_traverse.png"></p>
<h2 id="表-Tables"><a href="#表-Tables" class="headerlink" title="表(Tables)"></a>表(Tables)</h2><ul>
<li>raw 用于配置数据包，raw 中的数据包不会被系统跟踪。<br>  作用：决定数据包是否被状态跟踪机制处理，优先级最高，设置raw时一般是为了不再让iptables做数据包的链接跟踪处理，提高性能<br>  内核模块：iptable_raw<br>  chains：OUTPUT, PREROUTING</li>
<li>filter 是用于存放所有与防火墙相关操作的默认表。<br>  作用：过滤数据包<br>  内核模块：iptables_filter<br>  chains：INPUT, FORWARD, OUTPUT</li>
<li>nat 用于网络地址转换（例如：端口转发）。<br>  作用：网络地址转换<br>  内核模块：iptables_nat<br>  chains：PREROUTING, POSTROUTING, OUTPUT</li>
<li>mangle 用于对特定数据包的修改。<br>  作用：修改数据包的服务类型、TTL、并且可以配置路由实现QOS<br>  内核模块：iptable_mangle<br>  chains：PREROUTING, POSTROUTING, INPUT, OUTPUT, FORWARD</li>
<li>security 用于强制访问控制网络规则。<br>  Todo…</li>
</ul>
<p>表之间的顺序：raw –&gt; mangle –&gt; nat –&gt; filter</p>
<h2 id="链-Chains"><a href="#链-Chains" class="headerlink" title="链(Chains)"></a>链(Chains)</h2><ul>
<li>表由链组成，链是一些按顺序排列的规则的列表。<br>  默认的<code>filter</code>表包含<code>INPUT</code>，<code>OUTPUT</code>和<code>FORWARD</code>3条内建的链，这3条链作用于数据包过滤过程中的不同时间点，<code>nat</code>表包含<code>PREROUTING</code>，<code>POSTROUTING</code>和<code>OUTPUT</code>链。</li>
<li>默认情况下，任何链中都没有规则，可以向链中添加自己想用的规则<br>  链的默认规则通常设置为<code>ACCEPT</code>，如果想确保任何包都不能通过规则集，那么可以重置为<code>DROP</code>。默认的规则总是在一条链的最后生效，所以在默认规则生效前数据包需要通过所有存在的规则。</li>
<li>用户可以加入自己定义的链，从而使规则集更有效并且易于修改。</li>
</ul>
<h2 id="规则-Rules"><a href="#规则-Rules" class="headerlink" title="规则(Rules)"></a>规则(Rules)</h2><p>数据包的过滤基于 规则。规则由一个目标（数据包包匹配所有条件后的动作）和很多匹配（导致该规则可以应用的数据包所满足的条件）指定。一个规则的典型匹配事项是数据包进入的端口（例如：eth0 或者 eth1）、数据包的类型（ICMP, TCP, 或者 UDP）和数据包的目的端口。</p>
<p>目标使用<code>-j</code>或者<code>--jump</code>选项指定。目标可以是用户定义的链（例如，如果条件匹配，跳转到之后的用户定义的链，继续处理）、一个内置的特定目标或者是一个目标扩展。内置目标是 ACCEPT， DROP， QUEUE 和 RETURN，目标扩展是 REJECT and LOG。如果目标是内置目标，数据包的命运会立刻被决定并且在当前表的数据包的处理过程会停止。如果目标是用户定义的链，并且数据包成功穿过第二条链，目标将移动到原始链中的下一个规则。目标扩展可以被终止（像内置目标一样）或者不终止（像用户定义链一样）。</p>
<h2 id="策略-police"><a href="#策略-police" class="headerlink" title="策略(police)"></a>策略(police)</h2><h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><p><img src="/images/iptables/iptables_usage_main.jpg" alt="iptables_usage_main.jpg"></p>
<p><img src="/images/iptables/iptables_usage_param.jpg" alt="iptables_usage_param.jpg"></p>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>Todo…</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Iptables_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Iptables (简体中文)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ha97.com/4093.html">iptables的基本概念和数据包流程图</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/ggjucheng/archive/2012/08/19/2646466.html">linux平台下防火墙iptables原理(转)</a></li>
<li><a target="_blank" rel="noopener" href="http://www.linuxidc.com/Linux/2012-08/67505.htm">iptables四个表与五个链间的处理关系</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/05/11/works/docker-over-xenserver-plans/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/11/works/docker-over-xenserver-plans/" class="post-title-link" itemprop="url">XenServer中Docker容器实施方案（Preview）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-11 14:51:41" itemprop="dateCreated datePublished" datetime="2017-05-11T14:51:41+08:00">2017-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/works/" itemprop="url" rel="index"><span itemprop="name">works</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概"><a href="#概" class="headerlink" title="概"></a>概</h1><p>依托现有虚拟化资源引入docker容器机制</p>
<p><img src="/images/work/xen_container_plan.png" alt="xen_container_plan.png"></p>
<ul>
<li>scheduler<br>  根据VM宿主机的负载或其他情况，决定容器运行在哪个VM上。</li>
<li>monitor<br>  监控VM宿主机和容器健康情况，当有容器或宿主机宕掉时，报告想过情况，其他模块根据monitor的报告做出相应的响应。</li>
<li>controller<br>  控制容器的启动停止、迁移、扩展等操作</li>
<li>docker engine<br>  ……</li>
<li>pipework<br>  管理容器网络，目前pipework支持手动配置容器ip，网关及路由；对DHCP支持存在问题；（考虑将pipework以plugin方式加入docker engine）</li>
<li>xe-daemon<br>  采集容器监控数据，并通过xenbus将数据发给xenserver</li>
</ul>
<h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p><img src="/images/work/xen_container_network_plan.png" alt="xen_container_network_plan.png"></p>
<ul>
<li>宿主机有两个网络，一个管理网，一个数据网，宿主机内的所有容器使用数据网络</li>
<li>利用linux自带的bridge将宿主机的数据网与容器的veth pair相连，由此二层网络联通</li>
<li>宿主机开通ip_forward，实现三层转发</li>
<li>容器通过<code>pipework</code>脚本完成ip地址、路由、网关的配置</li>
</ul>
<h3 id="网络操作流程"><a href="#网络操作流程" class="headerlink" title="网络操作流程"></a>网络操作流程</h3><ol>
<li>根据网段创建bridge<br> 使用<code>docker network create --gateway &#123;宿主机IP&#125; --subnet &#123;宿主机子网&#125; -d bridge -o com.docker.network.bridge.name=&quot;&#123;网桥设备名称&#125;&quot; &#123;DockerNetwork名称&#125;</code>创建bridge。<br> eg： <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker network create --gateway 10.37.129.4 --subnet 10.37.129.0/24 -d bridge -o com.docker.network.bridge.name=<span class="string">&quot;xennet0&quot;</span> xennet</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brctl show</span></span><br><span class="line">bridge name bridge id       STP enabled interfaces</span><br><span class="line">docker0     8000.0242df249633   no</span><br><span class="line">xennet0     8000.0242688f16c2   no </span><br></pre></td></tr></table></figure></li>
<li>桥接出口网卡<br> 使用<code>brctl addif &#123;bridge名称&#125; &#123;网卡名称&#125;</code>将出口网卡添加到指定网桥中，此处应根据xscontainer使用用户的权限决定是否需要增加<code>sudo</code>操作<br> eg: <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl addif xennet0 enp0s6</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brctl show</span></span><br><span class="line">bridge name bridge id       STP enabled interfaces</span><br><span class="line">docker0     8000.0242df249633   no</span><br><span class="line">xennet0     8000.0242688f16c2   no      enp0s6</span><br></pre></td></tr></table></figure></li>
<li>创建固定IP容器<br> 创建容器需要分配固定IP，该IP需要业务层分配，并与bridge同网段。<br> eg: <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d --name c1 --network xennet --ip 10.37.129.100 centos:7.3.1611 /usr/sbin/init</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -d --name c2 --network xennet --ip 10.37.129.200 centos:7.3.1611 /usr/sbin/init</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brctl show</span></span><br><span class="line">bridge name bridge id       STP enabled interfaces</span><br><span class="line">docker0     8000.0242df249633   no</span><br><span class="line">xennet0     8000.0242688f16c2   no      enp0s6</span><br><span class="line">                                        veth990ee82</span><br><span class="line">                                        vethf1f6fcb</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="宿主机重启流程"><a href="#宿主机重启流程" class="headerlink" title="宿主机重启流程"></a>宿主机重启流程</h3><p>*** 由于宿主机重启会导致bridge中记录的桥接出口网卡信息丢失，所以在宿主机重启后需要重新桥接出口网卡 ***</p>
<ol>
<li>桥接出口网卡<br> 同上</li>
<li>恢复原有容器<br> 使用<code>docker run</code> or <code>docker start</code>恢复容器</li>
</ol>
<h2 id="共享存储"><a href="#共享存储" class="headerlink" title="共享存储"></a>共享存储</h2><h2 id="通过虚拟机挂载共享存储"><a href="#通过虚拟机挂载共享存储" class="headerlink" title="通过虚拟机挂载共享存储"></a>通过虚拟机挂载共享存储</h2><ul>
<li>需要记录虚机挂载共享存储与容器的对应关系</li>
<li>在创建、迁移、删除容器时，需要对相关存储资源进行分配或回收</li>
</ul>
<h2 id="容器直接挂载共享存储"><a href="#容器直接挂载共享存储" class="headerlink" title="容器直接挂载共享存储"></a>容器直接挂载共享存储</h2><ul>
<li>一般容器<br>  使用RBD／NBD-RBD块设备存储，或NFS存储。对于RBD／NBD-RBD方式需要添加驱动；对于NFS方式docker原生支持。</li>
<li>Registry容<br>  使用RGW对象存储（S3&#x2F;Swift），测试中。。。</li>
</ul>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>XenContainer</p>
<h2 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h2><h1 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h1><h1 id="流"><a href="#流" class="headerlink" title="流"></a>流</h1><p>服务发现（DNS）、负载均衡、容器镜像库均已容器形式提供服务。</p>
<p><img src="/images/work/xen_container_flow.png" alt="xen_container_flow.png"></p>
<h1 id="注"><a href="#注" class="headerlink" title="注"></a>注</h1><ul>
<li>scheduler、monitor、controller 从头写吧</li>
<li>docker engine 需要修改一些api接口</li>
<li>pipework 需要从shell改成golang，以plugin方式加入docker engine</li>
<li>xe-daemon 需要增加ip地址采集</li>
<li>DNS Container 从头写吧</li>
</ul>
<p>*** 技术相关调研，请见下节“参” ***</p>
<h1 id="参"><a href="#参" class="headerlink" title="参"></a>参</h1><ul>
<li><a href="https://zhoubofsy.github.io/2017/05/08/container/docker/docker-network-pipework/">Docker网络管理——PIPEWORK</a></li>
<li><a href="https://zhoubofsy.github.io/2017/04/27/container/k8s/k8s-analyze-service-discovery/">K8s服务发现分析</a></li>
<li><a href="https://zhoubofsy.github.io/2017/03/29/container/k8s/k8s-service-expose/">k8s service expose</a></li>
<li><a href="https://zhoubofsy.github.io/2017/03/03/container/docker/docker-network/">Docker网络技术(Bridge)</a></li>
<li><a href="https://zhoubofsy.github.io/2017/03/01/container/rancher/rancher-dns-and-metadata/">Rancher服务发现分析</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/05/08/container/docker/docker-network-pipework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/08/container/docker/docker-network-pipework/" class="post-title-link" itemprop="url">Docker网络管理——PIPEWORK</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-08 09:52:15" itemprop="dateCreated datePublished" datetime="2017-05-08T09:52:15+08:00">2017-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>PIPEWORK 是一个简单易用的Docker容器网络配置工具，由Docker的工程师Jérôme Petazzoni开发。通过使用ip、brctl、ovs-vsctl等命令来为Docker容器配置自定义的网桥、网卡、路由等。</p>
<p><img src="/images/docker/docker-network-pipework-frame.png" alt="docker-network-pipework-frame.png"></p>
<ul>
<li>使用新建的br0网桥替代默认的docker0网桥</li>
<li>容器网络类型选择<code>none</code></li>
</ul>
<h1 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h1><ol>
<li>在Github上获取pipework<br> Todo</li>
<li>创建网桥 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl addbr br0</span></span><br></pre></td></tr></table></figure></li>
<li>连接宿主机网卡 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl addif eth1</span></span><br></pre></td></tr></table></figure></li>
<li>设置网桥ip，并激活网桥 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr add 192.168.6.66/24 dev br0</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> dev br0 up</span></span><br></pre></td></tr></table></figure></li>
<li>创建容器，网络类型指定为<code>none</code> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run -it --<span class="built_in">rm</span> --net none --name nonenet_1 192.168.6.109:5000/my_ubuntu:v1 /bin/bash</span></span><br></pre></td></tr></table></figure></li>
<li>使用PIPEWORK创建容器网络 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ./pipework br0 nonenet_1 192.168.6.67/24@192.168.6.1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brctl show</span></span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">br0             8000.8ef4503cf344       no              eth1</span><br><span class="line">                                                        veth1pl7289</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="鸣谢-参考"><a href="#鸣谢-参考" class="headerlink" title="鸣谢&amp;参考"></a>鸣谢&amp;参考</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/yy-cxd/p/6553624.html">一分钟看懂Docker的网络模式和跨主机通信</a></li>
<li><a target="_blank" rel="noopener" href="http://www.infoq.com/cn/articles/docker-network-and-pipework-open-source-explanation-practice/">Docker网络详解及pipework源码解读与实践</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/reedchi/article/details/51670265">使用pipework理解容器间网络</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/design321/article/details/48264825">用PIPEWORK为docker容器配置独立IP</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/04/27/container/k8s/k8s-analyze-service-discovery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/27/container/k8s/k8s-analyze-service-discovery/" class="post-title-link" itemprop="url">K8s服务发现分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-27 10:23:14" itemprop="dateCreated datePublished" datetime="2017-04-27T10:23:14+08:00">2017-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是服务发现"><a href="#什么是服务发现" class="headerlink" title="什么是服务发现"></a>什么是服务发现</h1><p>容器可以对其它容器提供服务，如mysql（数据库服务）、nginx、mangodb等等。这些服务都可以通过IP＋Port方式访问。由于容器会经常重建迁移，所以IP会发生变化，如果调用服务的程序使用IP访问就会很不方便，为此可以使用DNS、zookeeper、etcd等技术实现服务访问与IP的解耦。这种解耦方式叫做服务发现。</p>
<h1 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h1><ul>
<li>Kubernetes v1.4.0</li>
<li>kube-dns 1.9(image tag)</li>
</ul>
<h1 id="Kubernetes服务发现概述"><a href="#Kubernetes服务发现概述" class="headerlink" title="Kubernetes服务发现概述"></a>Kubernetes服务发现概述</h1><p><img src="/images/k8s/k8s-service-discovery.png" alt="k8s-service-discovery.png"></p>
<ul>
<li>Kube-dns 以容器的形式为K8s集群提供DNS服务</li>
<li>Etcd用于存储K8s中的服务、容器等信息，Kube-dns的数据也是从Etcd中获取的</li>
<li>healthz 监控DNS Pod中的Kube-dns、dnsmasq容器</li>
<li>dnsmasq以代理形式将外部访问转发给Kube-dns容器，走10053端口</li>
</ul>
<h1 id="Kube-dns"><a href="#Kube-dns" class="headerlink" title="Kube-dns"></a>Kube-dns</h1><p><img src="/images/k8s/k8s-kube-dns-analysis.png" alt="k8s-kube-dns-analysis.png"></p>
<ul>
<li>miekg监听10053端口，接收dnsmasq转发过来的DNS请求</li>
<li>KubeDNS中的Cache模块从Etcd中获取Service和Namespace信息，用户完成Service域名到Service地址的映射</li>
<li>SkyDNS Server 完成DNS协议交互逻辑<br>  该模块在KubeDNS启动时将自身注册到miekg中；并实现接口ServeDNS，当miekg收到DNS请求后，将调用该接口进行处理。</li>
<li>KubeDNS中模块实现了backend接口<br>  在ServeDNS处理DNS请求时，需要调用backend接口的Records和ReverseRecord method，backend接口会比对Cache中的内容，然后返回结果。</li>
</ul>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/542.html">Kubernetes（K8S）的服务发现和kube-dns插件</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/273.html">Kubernetes(k8s)如何使用kube-dns实现服务发现</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/03/29/container/k8s/k8s-service-expose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/03/29/container/k8s/k8s-service-expose/" class="post-title-link" itemprop="url">k8s service expose</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-03-29 11:08:40" itemprop="dateCreated datePublished" datetime="2017-03-29T11:08:40+08:00">2017-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>从<code>k8s 1.2</code>版本开始提供Ingress来实现对外暴露服务；目前k8s有三种暴露方式</p>
<ul>
<li>LoadBlancer Service</li>
<li>NodePort Service</li>
<li>Ingress</li>
</ul>
<h1 id="K8s-LBS"><a href="#K8s-LBS" class="headerlink" title="K8s-LBS"></a>K8s-LBS</h1><p>LBS是k8s与云平台深度结合的一个组件，当使用LBS暴露服务时，实际上是通过底层云平台申请创建一个负载均衡器来向外暴露服务。目前LBS支持的云平台有GCE、DigitalOcean、Aliyun、私有云Openstack等等，由于LBS与云平台深度结合，所以只能在这些平台上使用。</p>
<h1 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h1><p><img src="/images/k8s/k8s_nodeport.png" alt="k8s_nodeport"></p>
<p>k8s的端口分为：</p>
<ul>
<li>Port<br>  service上暴露出来的端口，提供给集群(集群指整个容器集群)内部客户访问的端口。</li>
<li>NodePort<br>  node上暴露的端口，提供给集群外部客户访问的端口。</li>
<li>TargetPort<br>  endpoint上暴露的端口，也可以当作Pod上暴露的端口，无论从Port或NodePort上来的数据最终都会经过kube-proxy转发到Pod的TargetPort端口上。</li>
</ul>
<p>k8s的IP分为：</p>
<ul>
<li>ClusterIP<br>  service上虚拟ip地址，它由kube-proxy使用iptables规则重新定向到本地端口，再均衡到后端的Pod上。</li>
<li>NodeIP<br>  node节点的物理ip地址，它被kube-proxy使用iptables规则重定向到本地端口。</li>
<li>ContainerIP&#x2F;PodIP<br>  K8s中以Pod为最小部署单位，一个Pod中共享一个网络资源（无论Pod中有几个容器）。每个Pod启动时，会自动创建一个镜像为gcr.io&#x2F;google_containers&#x2F;pause:0.8.0的容器，容器内部与外部的通信经由此容器代理，所以ContainerIP就是PodIP。</li>
</ul>
<h2 id="暴露方法及API"><a href="#暴露方法及API" class="headerlink" title="暴露方法及API"></a>暴露方法及API</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">svc-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2222</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30022</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rc-test</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/api-reference/v1.5/#service-v1">API操作</a></p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>ip地址及端口的暴露都是通过修改iptables规则来实现的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">iptables -t nat -L -n</span></span><br><span class="line">...</span><br><span class="line">Chain KUBE-NODEPORTS (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-lonely: */ tcp dpt:30023</span><br><span class="line">KUBE-SVC-E6FDK4HG4F4JSB77  tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-lonely: */ tcp dpt:30023</span><br><span class="line">KUBE-MARK-MASQ  tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-tmp: */ tcp dpt:30099</span><br><span class="line">KUBE-SVC-OOWDNB3NCXKPBPZE  tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-tmp: */ tcp dpt:30099</span><br><span class="line">KUBE-MARK-MASQ  tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ tcp dpt:30022</span><br><span class="line">KUBE-SVC-D25WXD2YSOVKEUTU  tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ tcp dpt:30022</span><br><span class="line">...</span><br><span class="line">Chain KUBE-SEP-2LNK4QUGPB2C5PDO (2 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  all  --  192.168.6.110        0.0.0.0/0            /* default/kubernetes:https */</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/kubernetes:https */ recent: SET name: KUBE-SEP-2LNK4QUGPB2C5PDO side: source mask: 255.255.255.255 tcp to:192.168.6.110:6443</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-5GTCHBFJM5RAI7LS (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  all  --  10.254.86.9          0.0.0.0/0            /* default/svc-lonely: */</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-lonely: */ tcp to:10.254.86.9:22</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-BCYRFQ26LZTOSSU7 (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  all  --  10.254.86.4          0.0.0.0/0            /* default/svc-1: */</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ tcp to:10.254.86.4:22</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-CLKUH4WMQ3CNBJ7K (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  all  --  10.254.86.2          0.0.0.0/0            /* default/svc-1: */</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ tcp to:10.254.86.2:22</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-D3FORTYMXA7BVSDA (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  all  --  10.254.86.8          0.0.0.0/0            /* default/svc-1: */</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ tcp to:10.254.86.8:22</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-F4EJGNTAH3JOOQC6 (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  all  --  10.254.86.3          0.0.0.0/0            /* default/svc-1: */</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ tcp to:10.254.86.3:22</span><br><span class="line"></span><br><span class="line">Chain KUBE-SEP-HO23WAVQKIB2R4KD (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-MARK-MASQ  all  --  10.254.86.10         0.0.0.0/0            /* default/svc-tmp: */</span><br><span class="line">DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-tmp: */ tcp to:10.254.86.10:99</span><br><span class="line"></span><br><span class="line">Chain KUBE-SERVICES (2 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-SVC-E6FDK4HG4F4JSB77  tcp  --  0.0.0.0/0            10.254.162.24        /* default/svc-lonely: cluster IP */ tcp dpt:2223</span><br><span class="line">KUBE-SVC-OOWDNB3NCXKPBPZE  tcp  --  0.0.0.0/0            10.254.119.86        /* default/svc-tmp: cluster IP */ tcp dpt:9999</span><br><span class="line">KUBE-SVC-NPX46M4PTMTKRN6Y  tcp  --  0.0.0.0/0            10.254.0.1           /* default/kubernetes:https cluster IP */ tcp dpt:443</span><br><span class="line">KUBE-SVC-D25WXD2YSOVKEUTU  tcp  --  0.0.0.0/0            10.254.159.12        /* default/svc-1: cluster IP */ tcp dpt:2222</span><br><span class="line">KUBE-NODEPORTS  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service nodeports; NOTE: this must be the last rule in this chain */ ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain KUBE-SVC-D25WXD2YSOVKEUTU (2 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-SEP-CLKUH4WMQ3CNBJ7K  all  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ statistic mode random probability 0.25000000000</span><br><span class="line">KUBE-SEP-F4EJGNTAH3JOOQC6  all  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ statistic mode random probability 0.33332999982</span><br><span class="line">KUBE-SEP-BCYRFQ26LZTOSSU7  all  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */ statistic mode random probability 0.50000000000</span><br><span class="line">KUBE-SEP-D3FORTYMXA7BVSDA  all  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-1: */</span><br><span class="line"></span><br><span class="line">Chain KUBE-SVC-E6FDK4HG4F4JSB77 (2 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-SEP-5GTCHBFJM5RAI7LS  all  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-lonely: */</span><br><span class="line"></span><br><span class="line">Chain KUBE-SVC-NPX46M4PTMTKRN6Y (1 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-SEP-2LNK4QUGPB2C5PDO  all  --  0.0.0.0/0            0.0.0.0/0            /* default/kubernetes:https */ recent: CHECK seconds: 180 reap name: KUBE-SEP-2LNK4QUGPB2C5PDO side: source mask: 255.255.255.255</span><br><span class="line">KUBE-SEP-2LNK4QUGPB2C5PDO  all  --  0.0.0.0/0            0.0.0.0/0            /* default/kubernetes:https */</span><br><span class="line"></span><br><span class="line">Chain KUBE-SVC-OOWDNB3NCXKPBPZE (2 references)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">KUBE-SEP-HO23WAVQKIB2R4KD  all  --  0.0.0.0/0            0.0.0.0/0            /* default/svc-tmp: */</span><br></pre></td></tr></table></figure>

<h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><p>Todo…</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.colabug.com/thread-1703745-1-1.html?pp=2">Traefik-kubernetes 初试</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.163.com/hk_bs/blog/static/245038011201611149254899/">Kubernetes 中的PodIP、ClusterIP 和外部IP</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/xinghun_4/article/details/50492041">kubernetes中port、target port、node port的对比分析，以及kube-proxy代理</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2017/03/03/container/docker/docker-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="博">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/03/03/container/docker/docker-network/" class="post-title-link" itemprop="url">Docker网络技术(Bridge)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-03-03 11:09:46" itemprop="dateCreated datePublished" datetime="2017-03-03T11:09:46+08:00">2017-03-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Docker网络技术，用来保证Container之间正常通讯的技术，作为Docker自身提供的网络分为4种，Bridge、Host、None、Container。本文重点介绍** Bridge **</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>Docker 版本<br>  Docker version 1.12.5, build 7392c3b</li>
<li>OS 版本<br>  Red Hat Enterprise Linux Server release 7.2 (Maipo)</li>
<li>kernel 版本<br>  Linux 3.10.0-327.el7.x86_64</li>
</ul>
<h1 id="Bridge介绍"><a href="#Bridge介绍" class="headerlink" title="Bridge介绍"></a>Bridge介绍</h1><h2 id="longlong-ago"><a href="#longlong-ago" class="headerlink" title="longlong ago :-)"></a>longlong ago :-)</h2><p><img src="/images/docker/docker-network-bridge-br0.png" alt="docker-network-bridge-br0"></p>
<p>早期的二层网络中，bridge可以连接不同的LAN网，当host1 发出一个数据包时，LAN1的其他主机和网桥br0都会收到该数据包。网桥再将数据包从入口端广播到其他端口上（我的理解是，多端口网桥叫交换机）。因此，LAN2上的主机也会接收到host1发出的数据包，从而实现不同LAN网上所有主机的通信。</p>
<p><img src="/images/docker/docker-network-bridge-linux.png" alt="docker-network-bridge-linux"></p>
<p>后来linux kernel借鉴桥设备的原理实现了虚拟bridge，用到了veth pair技术，实现了不同子网通讯的二层基础。</p>
<h2 id="Docker-Bridge"><a href="#Docker-Bridge" class="headerlink" title="Docker Bridge"></a>Docker Bridge</h2><p>(正题)<code>Docker Bridge</code>不同于<code>linux bridge</code>也不同于<code>桥设备</code>，但<code>Docker Bridge</code>的构建基于<code>linux bridge</code>、<code>Network Namespace</code>、<code>iptables</code>。</p>
<ul>
<li>Network Namespace<br>  实现了子网之间的隔离</li>
<li>iptables<br>  解决了NAT映射问题，使容器有(被)访问外网的能力。</li>
<li>linux bridge<br>  实现了Host内跨子网通讯</li>
</ul>
<p><img src="/images/docker/docker-network-bridge-main.png" alt="docker-network-bridge-main"></p>
<p>在桥接模式下，Docker Daemon将veth0附加到docker0网桥上，保证宿主机的报文有能力发往veth0。再将veth1添加到Docker容器所属的网络命名空间，保证宿主机的网络报文若发往veth0可以立即被veth1收到。容器如果需要联网，则需要采用NAT方式。准确的说，是NATP(网络地址端口转换)方式。NATP包含两种转换方式：SNAT和DNAT。</p>
<h3 id="下行访问流程"><a href="#下行访问流程" class="headerlink" title="下行访问流程"></a>下行访问流程</h3><p><img src="/images/docker/docker-network-bridge-downflow.png" alt="docker-network-bridge-downflow"><br>由于容器的IP与端口对外都是不可见的，所以数据包的目的地址为宿主机的ip和端口，为192.168.1.10:24。<br>数据包经过路由器发给宿主机eth0，再经eth0转发给docker0网桥。<br>由于存在DNAT(Destination NAT，修改数据包的目的地址)规则，会将数据包的目的地址转换为容器的ip和端口，为172.17.0.n:24。宿主机上的docker0网桥识别到容器ip和端口，于是将数据包发送附加到docker0网桥上的veth0接口，veth0接口再将数据包发送给容器内部的veth1接口，容器接收数据包并作出响应。<br><img src="/images/docker/docker-network-bridge-downflow-detail.png" alt="docker-network-bridge-downflow-detail"></p>
<h3 id="上行访问流程"><a href="#上行访问流程" class="headerlink" title="上行访问流程"></a>上行访问流程</h3><p>看了上面的<code>下行访问流程</code>用到了DNAT，那么上行访问一定会使用SNAT了吧。可实时却并非如此。<br>容器内的请求可以正常发送到host外，是因为host开启的<code>ip_forward</code>。如果host关闭转发功能<code>echo 0 &gt; /proc/sys/net/ipv4/ip_forward</code>，容器能的请求只能发送到于自己相同网段的节点容器内，不同网段及跨主机的网段是不通的。<br><img src="/images/docker/docker-network-bridge-upflow-detail.png" alt="docker-network-bridge-upflow-detail"></p>
<h1 id="Docker-bridge中关键技术"><a href="#Docker-bridge中关键技术" class="headerlink" title="Docker bridge中关键技术"></a>Docker bridge中关键技术</h1><p>Docker bridge充分利用了linux bridge和iptabels、namespace等技术。将其中需要很多命令做成自动化脚本以方便执行维护。如：pipework是一个shell脚本，用于完成bridge网络管理。</p>
<h2 id="veth-pair"><a href="#veth-pair" class="headerlink" title="veth pair"></a>veth pair</h2><p>veth pair是一对虚拟网卡，从一张veth网卡发出的数据包可以直接到达它的peer veth,两者之间存在着虚拟链路。veth网卡和常规的以太网区别仅在于xmit接口：将数据发送到其peer,触发peer的Rx 过程。<br><img src="/images/docker/docker-network-bridge-vethpair.png" alt="docker-network-bridge-vethpair"><br>veth pair是用于不同network namespace间进行通信的方式，veth pair将一个network namespace数据发往另一个network namespace的veth。如果多个network namespace需要进行通信，则需要借助bridge。</p>
<p>*** 属于iproute2工具包中的ip-link提供的功能 ***</p>
<p>创建veth pair，vp16与vp19是一对儿，vp26与vp29是一对儿。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> add vp16 <span class="built_in">type</span> veth peer name vp19</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> add vp26 <span class="built_in">type</span> veth peer name vp29</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> show</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">2: enp0s5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 00:1c:42:c6:de:63 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: vp19@vp16: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether b6:62:99:1e:0c:2a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: vp16@vp19: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 1e:ea:cf:86:51:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: vp29@vp26: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 4e:16:07:e6:77:2c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: vp26@vp29: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether be:98:08:90:da:7a brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p>创建namespace ns19和ns29，并设置vp19和vp29的netns</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns add ns19</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns add ns29</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns list</span></span><br><span class="line">ns19</span><br><span class="line">ns29</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> netns ns19 vp19</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> netns ns29 vp29</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> show</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">2: enp0s5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 00:1c:42:c6:de:63 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: vp16@if3: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 1e:ea:cf:86:51:ab brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">6: vp26@if5: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether be:98:08:90:da:7a brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br></pre></td></tr></table></figure>
<p>设置完netns后，在当前namespace中查看网卡信息就看不到vp19和vp29这两个网卡了，但在ns19和ns29 namespace中却能查看到对应的网卡。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ip <span class="built_in">link</span> show</span></span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">3: vp19@if4: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether b6:62:99:1e:0c:2a brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ip <span class="built_in">link</span> show</span></span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">5: vp29@if6: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 4e:16:07:e6:77:2c brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></pre></td></tr></table></figure>
<p>此时将这四个网卡激活，并配置ip，他们便可以相互通讯了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> dev vp16 up</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> dev vp26 up</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ip <span class="built_in">link</span> <span class="built_in">set</span> dev vp19 up</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ip <span class="built_in">link</span> <span class="built_in">set</span> dev vp29 up</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr add 192.168.200.16/24 dev vp16</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr add 192.168.200.26/24 dev vp26</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr show</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">2: enp0s5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:1c:42:c6:de:63 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.3.5/24 brd 192.168.3.255 scope global enp0s5</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::21c:42ff:fec6:de63/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">4: vp16@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 1e:ea:cf:86:51:ab brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 192.168.200.16/24 scope global vp16</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::1cea:cfff:fe86:51ab/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">6: vp26@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether be:98:08:90:da:7a brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet 192.168.200.26/24 scope global vp26</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::bc98:8ff:fe90:da7a/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ip addr add 192.168.200.19/24 dev vp19</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ip addr show</span></span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">3: vp19@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether b6:62:99:1e:0c:2a brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 192.168.200.19/24 scope global vp19</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::b462:99ff:fe1e:c2a/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ip addr add 192.168.200.29/24 dev vp29</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ip addr show</span></span><br><span class="line">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN group default qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">5: vp29@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 4e:16:07:e6:77:2c brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 192.168.200.29/24 scope global vp29</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4c16:7ff:fee6:772c/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<ul>
<li>ns19、ns29这两个namespace的网络不能ping通各自的<code>192.168.200.0</code>网段的ip地址<br>  将ns19、ns29中的<code>lo</code>设备激活(up)，便能ping通各自的ip地址了。</li>
<li>ns19 namespace的网络能ping同<code>192.168.200.16</code>和<code>192.168.200.26</code>，但不能ping通<code>192.168.200.29</code><br>  ns29 namespace的网络却不能ping通任何一个ip地址。</li>
<li>将ns29所对应的veth pair划分独立网段(<code>192.168.29.0</code>)，veth pair对应的两个网卡便能正常ping通</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ping 192.168.200.16</span></span><br><span class="line">ING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.16: icmp_seq=1 ttl=64 time=0.060 ms</span><br><span class="line">64 bytes from 192.168.200.16: icmp_seq=2 ttl=64 time=0.065 ms</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ping 192.168.200.26</span></span><br><span class="line">PING 192.168.200.26 (192.168.200.26) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.26: icmp_seq=1 ttl=64 time=0.041 ms</span><br><span class="line">64 bytes from 192.168.200.26: icmp_seq=2 ttl=64 time=0.063 ms</span><br><span class="line">64 bytes from 192.168.200.26: icmp_seq=3 ttl=64 time=0.057 ms</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ping 192.168.200.26 -w 5</span></span><br><span class="line">PING 192.168.200.26 (192.168.200.26) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.200.26 ping statistics --- </span><br><span class="line">6 packets transmitted, 0 received, 100% packet loss, time 4999ms</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ping 192.168.200.16 -w 5</span></span><br><span class="line">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.200.16 ping statistics ---</span><br><span class="line">6 packets transmitted, 0 received, 100% packet loss, time 4999ms</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ip addr delete 192.168.200.29/24 dev vp29</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ip addr add 192.168.29.29/24 dev vp29</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr delete 192.168.200.26/24 dev vp26</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr add 192.168.29.26/24 dev vp26</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ping 192.168.29.26</span></span><br><span class="line">PING 192.168.29.26 (192.168.29.26) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.29.26: icmp_seq=1 ttl=64 time=0.059 ms</span><br><span class="line">64 bytes from 192.168.29.26: icmp_seq=2 ttl=64 time=0.051 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="brctl"><a href="#brctl" class="headerlink" title="brctl"></a>brctl</h2><p>brctl是<code>bridge-utils</code>包中的程序，用于管理linux bridge的CLI工具。</p>
<p>创建bridge设备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl addbr vb</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl show</span></span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">vb              8000.000000000000       no</span><br></pre></td></tr></table></figure>
<p>将网卡vp16和vp26添加到bridge设备中，可实现vp19与vp29的通讯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl addif vb vp16</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl addif vb vp26</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> brctl show</span></span><br><span class="line">bridge name     bridge id               STP enabled     interfaces</span><br><span class="line">vb              8000.1eeacf8651ab       no              vp16</span><br><span class="line">                                                        vp26</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ping 192.168.200.19</span></span><br><span class="line">PING 192.168.200.19 (192.168.200.19) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.19: icmp_seq=1 ttl=64 time=0.063 ms</span><br><span class="line">64 bytes from 192.168.200.19: icmp_seq=2 ttl=64 time=0.072 ms</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ping 192.168.200.29</span></span><br><span class="line">PING 192.168.200.29 (192.168.200.29) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.29: icmp_seq=1 ttl=64 time=0.066 ms</span><br><span class="line">64 bytes from 192.168.200.29: icmp_seq=2 ttl=64 time=0.058 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>若希望namespace网络能ping通宿主机内所有网络，需要添加默认网关</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ping 192.168.3.5</span></span><br><span class="line">connect: Network is unreachable</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns29 ping 192.168.3.5</span></span><br><span class="line">connect: Network is unreachable</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 route add default gw 192.168.200.1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.200.1   0.0.0.0         UG    0      0        0 vp19</span><br><span class="line">192.168.200.0   0.0.0.0         255.255.255.0   U     0      0        0 vp19</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ping 192.168.3.5</span></span><br><span class="line">PING 192.168.3.5 (192.168.3.5) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.3.5 ping statistics ---</span><br><span class="line">4 packets transmitted, 0 received, 100% packet loss, time 2999ms</span><br></pre></td></tr></table></figure>
<p>配置完默认网关后，<code>网络不可达</code>变成了<code>访问超时</code>，此时需要将网卡<code>vp16</code>和<code>vp26</code>的IP地址删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr delete 192.168.200.16/24 dev vp16</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr delete 192.168.200.26/24 dev vp26</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip addr show</span></span><br><span class="line">...</span><br><span class="line">4: vp16@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master vb state UP group default qlen 1000</span><br><span class="line">    link/ether 1e:ea:cf:86:51:ab brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::1cea:cfff:fe86:51ab/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">6: vp26@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master vb state UP group default qlen 1000</span><br><span class="line">    link/ether be:98:08:90:da:7a brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::bc98:8ff:fe90:da7a/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">7: vb: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 1e:ea:cf:86:51:ab brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.200.1/24 scope global vb</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::1cea:cfff:fe86:51ab/64 scope link</span><br><span class="line">        valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> ip netns <span class="built_in">exec</span> ns19 ping 192.168.3.5</span></span><br><span class="line">PING 192.168.3.5 (192.168.3.5) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.3.5: icmp_seq=1 ttl=64 time=0.064 ms</span><br><span class="line">64 bytes from 192.168.3.5: icmp_seq=2 ttl=64 time=0.062 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="iptables-netfilter"><a href="#iptables-netfilter" class="headerlink" title="iptables&#x2F;netfilter"></a>iptables&#x2F;netfilter</h2><p>netfilter是Linux操作系统核心层内部的一个数据包处理模块，它具有网络地址转换(Network Address Translate)、数据包过滤、数据包处理、地址伪装、透明代理，以及基于用户及媒体访问控制(Media Access Control，MAC)地址的过滤和基于状态的过滤、包速率限制等。** netfilter工作在三层 **</p>
<p>iptables是与netfilter交互的CLI工具。</p>
<p>按照上述的配置方式，只能做到访问宿主机内的所有网络，若希望ping通宿主机所在网络的其它主机，需要开启ip_forward(<code>echo 1 &gt;&gt; /proc/sys/net/ipv4/ip_forward</code>，需要以root身份操作，仅仅使用root权限不够)，并关闭防火墙(iptables)或配置防火墙<code>POSTROUTING</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> iptables -t nat -A POSTROUTING -s 192.168.200.0/24 -p all -j MASQUERADE</span></span><br><span class="line">hain PREROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">MASQUERADE  all  --  192.168.200.0/24     0.0.0.0/0</span><br></pre></td></tr></table></figure>

<h2 id="TUN-TAP驱动"><a href="#TUN-TAP驱动" class="headerlink" title="TUN&#x2F;TAP驱动"></a>TUN&#x2F;TAP驱动</h2><p>Todo.</p>
<h1 id="参考-鸣谢"><a href="#参考-鸣谢" class="headerlink" title="参考&amp;鸣谢"></a>参考&amp;鸣谢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.tuicool.com/wx/nyQFfaZ">探索 Docker bridge 的正确姿势，亲测有效！</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-27017686-id-5057025.html">虚拟网络设备–VETH pair</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/tycoon1988/article/details/39055149">network namespace与veth pair</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000002540601">iptables防火墙原理详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/jackhub/p/3575879.html">Linux IP_FORWARD说明</a></li>
<li><a href="https://zhoubofsy.github.io/2017/05/12/network/iptables-introduce/">iptables</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">博</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">123</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">博</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  


</body>
</html>
