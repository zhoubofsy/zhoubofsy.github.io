<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhoubofsy.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Bolog">
<meta property="og:url" content="http://zhoubofsy.github.io/page/2/index.html">
<meta property="og:site_name" content="Bolog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="åš">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://zhoubofsy.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Bolog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Bolog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2022/11/07/blockchain/ethereum/eth-helloworld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/07/blockchain/ethereum/eth-helloworld/" class="post-title-link" itemprop="url">Hello Ethereum</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-07 16:00:21" itemprop="dateCreated datePublished" datetime="2022-11-07T16:00:21+08:00">2022-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-25 10:59:23" itemprop="dateModified" datetime="2024-11-25T10:59:23+08:00">2024-11-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>é—®ï¼šå†™ä¸€ä¸ªä»¥å¤ªåŠæ™ºèƒ½åˆçº¦helloworldæ€»å…±åˆ†å‡ æ­¥ï¼Ÿ<br>ç­”ï¼šä¸‰æ­¥ï¼Œç¬¬ä¸€æ­¥åˆ›å»ºä»¥å¤ªåŠæœåŠ¡ç¯å¢ƒï¼›ç¬¬äºŒæ­¥æ’°å†™ã€ç¼–è¯‘ã€éƒ¨ç½²helloworldæ™ºèƒ½åˆçº¦ï¼›ç¬¬ä¸‰æ­¥è¿è¡Œæ™ºèƒ½åˆçº¦</p>
<h1 id="éƒ¨ç½²Ethereumç¯å¢ƒ"><a href="#éƒ¨ç½²Ethereumç¯å¢ƒ" class="headerlink" title="éƒ¨ç½²Ethereumç¯å¢ƒ"></a>éƒ¨ç½²Ethereumç¯å¢ƒ</h1><p>æœ¬äººä½¿ç”¨dockeræ­å»ºEthereumç¯å¢ƒï¼Œæ‹‰å–<code>ubuntu:20.04</code>é•œåƒã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull --platform linux/amd64 ubuntu:20.04</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œåˆ›å»ºå®¹å™¨å¹¶å¼€å§‹å®‰è£…Ethereum</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name eth_server --net host ubuntu:20.04 /bin/bash</span><br><span class="line">docker run -it --net bridge -p 8545:8545 -p 8551:8551 --name eth_server ubuntu:20.04 /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="å®‰è£…Ethereum"><a href="#å®‰è£…Ethereum" class="headerlink" title="å®‰è£…Ethereum"></a>å®‰è£…Ethereum</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt update -y</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install -y software-properties-common</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">add-apt-repository -y ppa:ethereum/ethereum</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt update -y</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install -y ethereum</span></span><br></pre></td></tr></table></figure>

<p>å®‰è£…æˆåŠŸåï¼Œç¡®è®¤ä¸€ä¸‹ethç‰ˆæœ¬ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth version</span></span><br><span class="line">Geth</span><br><span class="line">Version: 1.10.26-stable</span><br><span class="line">Git Commit: e5eb32acee19cc9fca6a03b10283b7484246b15a</span><br><span class="line">Architecture: amd64</span><br><span class="line">Go Version: go1.18.5</span><br><span class="line">Operating System: linux</span><br><span class="line">GOPATH=</span><br><span class="line">GOROOT=go</span><br></pre></td></tr></table></figure>

<h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><h3 id="åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºé…ç½®æ–‡ä»¶"></a>åˆ›å»ºé…ç½®æ–‡ä»¶</h3><p>åˆ›å»ºä¸€ä¸ª<code>genesis.json</code>çš„æ–‡ä»¶ï¼Œå¡«å……å¦‚ä¸‹å†…å®¹ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;chainId&quot;</span><span class="punctuation">:</span> <span class="number">110</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;homesteadBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;byzantiumBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;constantinopleBlock&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;eip150Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;eip155Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;eip158Block&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;difficulty&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gasLimit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2100000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;alloc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="åˆå§‹åŒ–Ethereumæ•°æ®"><a href="#åˆå§‹åŒ–Ethereumæ•°æ®" class="headerlink" title="åˆå§‹åŒ–Ethereumæ•°æ®"></a>åˆå§‹åŒ–Ethereumæ•°æ®</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth --datadir ./eth-data --allow-insecure-unlock --http --http.addr 172.17.0.2 --http.api <span class="string">&quot;admin,debug,web3,eth,txpool,personal,ethash,miner,net&quot;</span> --http.corsdomain <span class="string">&quot;*&quot;</span> --dev init genesis.json</span></span><br><span class="line">INFO [11-07|16:04:14.139] Maximum peer count                       ETH=50 LES=0 total=50</span><br><span class="line">INFO [11-07|16:04:14.151] Smartcard socket not found, disabling    err=&quot;stat /run/pcscd/pcscd.comm: no such file or directory&quot;</span><br><span class="line">INFO [11-07|16:04:14.179] Set global gas cap                       cap=50,000,000</span><br><span class="line">INFO [11-07|16:04:14.190] Allocated cache and file handles         database=/root/eth-data/geth/chaindata cache=16.00MiB handles=16</span><br><span class="line">INFO [11-07|16:04:14.224] Opened ancient database                  database=/root/eth-data/geth/chaindata/ancient/chain readonly=false</span><br><span class="line">INFO [11-07|16:04:14.226] Writing custom genesis block</span><br><span class="line">INFO [11-07|16:04:14.230] Persisted trie from memory database      nodes=0 size=0.00B time=&quot;347Âµs&quot; gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B</span><br><span class="line">INFO [11-07|16:04:14.238] Successfully wrote genesis state         database=chaindata                     hash=a697c6..9bf39b</span><br><span class="line">INFO [11-07|16:04:14.238] Allocated cache and file handles         database=/root/eth-data/geth/lightchaindata cache=16.00MiB handles=16</span><br><span class="line">INFO [11-07|16:04:14.259] Opened ancient database                  database=/root/eth-data/geth/lightchaindata/ancient/chain readonly=false</span><br><span class="line">INFO [11-07|16:04:14.259] Writing custom genesis block</span><br><span class="line">INFO [11-07|16:04:14.261] Persisted trie from memory database      nodes=0 size=0.00B time=&quot;21.917Âµs&quot; gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B</span><br><span class="line">INFO [11-07|16:04:14.262] Successfully wrote genesis state         database=lightchaindata                     hash=a697c6..9bf39b</span><br></pre></td></tr></table></figure>

<h2 id="å¯åŠ¨èŠ‚ç‚¹"><a href="#å¯åŠ¨èŠ‚ç‚¹" class="headerlink" title="å¯åŠ¨èŠ‚ç‚¹"></a>å¯åŠ¨èŠ‚ç‚¹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth --datadir ./eth-data --networkid 110 --allow-insecure-unlock --http --http.addr 172.17.0.2 --http.api <span class="string">&quot;admin,debug,web3,eth,txpool,personal,ethash,miner,net&quot;</span> --http.corsdomain <span class="string">&quot;*&quot;</span> --dev</span></span><br><span class="line">INFO [11-07|16:14:23.231] Starting Geth in ephemeral dev mode...</span><br><span class="line">WARN [11-07|16:14:23.234] You are running Geth in --dev mode. Please note the following:</span><br><span class="line"></span><br><span class="line">  1. This mode is only intended for fast, iterative development without assumptions on</span><br><span class="line">     security or persistence.</span><br><span class="line">  2. The database is created in memory unless specified otherwise. Therefore, shutting down</span><br><span class="line">     your computer or losing power will wipe your entire block data and chain state for</span><br><span class="line">     your dev environment.</span><br><span class="line">  3. A random, pre-allocated developer account will be available and unlocked as</span><br><span class="line">     eth.coinbase, which can be used for testing. The random dev account is temporary,</span><br><span class="line">     stored on a ramdisk, and will be lost if your machine is restarted.</span><br><span class="line">  4. Mining is enabled by default. However, the client will only seal blocks if transactions</span><br><span class="line">     are pending in the mempool. The miner&#x27;s minimum accepted gas price is 1.</span><br><span class="line">  5. Networking is disabled; there is no listen-address, the maximum number of peers is set</span><br><span class="line">     to 0, and discovery is disabled.</span><br><span class="line">INFO [11-07|16:14:23.251] Maximum peer count                       ETH=50 LES=0 total=50</span><br><span class="line">INFO [11-07|16:14:23.261] Smartcard socket not found, disabling    err=&quot;stat /run/pcscd/pcscd.comm: no such file or directory&quot;</span><br><span class="line">INFO [11-07|16:14:23.291] Set global gas cap                       cap=50,000,000</span><br><span class="line">INFO [11-07|16:14:23.649] Using developer account                  address=0xA9CB6DB62D6673ae5CD79D0d29796Dd9DF1d1A5e</span><br><span class="line">INFO [11-07|16:14:23.652] Allocated cache and file handles         database=/root/eth-data/geth/chaindata cache=512.00MiB handles=524,288 readonly=true</span><br><span class="line">INFO [11-07|16:14:23.675] Opened ancient database                  database=/root/eth-data/geth/chaindata/ancient/chain readonly=true</span><br><span class="line">INFO [11-07|16:14:23.691] Allocated trie memory caches             clean=154.00MiB dirty=256.00MiB</span><br><span class="line">INFO [11-07|16:14:23.691] Allocated cache and file handles         database=/root/eth-data/geth/chaindata cache=512.00MiB handles=524,288</span><br><span class="line">INFO [11-07|16:14:23.756] Opened ancient database                  database=/root/eth-data/geth/chaindata/ancient/chain readonly=false</span><br><span class="line">INFO [11-07|16:14:23.763]</span><br><span class="line">INFO [11-07|16:14:23.764] ---------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">INFO [11-07|16:14:23.764] Chain ID:  110 (unknown)</span><br><span class="line">INFO [11-07|16:14:23.764] Consensus: unknown</span><br><span class="line">INFO [11-07|16:14:23.764]</span><br><span class="line">INFO [11-07|16:14:23.765] Pre-Merge hard forks:</span><br><span class="line">INFO [11-07|16:14:23.765]  - Homestead:                   0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/homestead.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Tangerine Whistle (EIP 150): 0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/tangerine-whistle.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Spurious Dragon/1 (EIP 155): 0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/spurious-dragon.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Spurious Dragon/2 (EIP 158): 0        (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/spurious-dragon.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Byzantium:                   &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/byzantium.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Constantinople:              &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/constantinople.md)</span><br><span class="line">INFO [11-07|16:14:23.765]  - Petersburg:                  &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/petersburg.md)</span><br><span class="line">INFO [11-07|16:14:23.766]  - Istanbul:                    &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/istanbul.md)</span><br><span class="line">INFO [11-07|16:14:23.766]  - Berlin:                      &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/berlin.md)</span><br><span class="line">INFO [11-07|16:14:23.766]  - London:                      &lt;nil&gt; (https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/london.md)</span><br><span class="line">INFO [11-07|16:14:23.766]</span><br><span class="line">INFO [11-07|16:14:23.766] The Merge is not yet available for this network!</span><br><span class="line">INFO [11-07|16:14:23.766]  - Hard-fork specification: https://github.com/ethereum/execution-specs/blob/master/network-upgrades/mainnet-upgrades/paris.md</span><br><span class="line">INFO [11-07|16:14:23.766] ---------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">INFO [11-07|16:14:23.766]</span><br><span class="line">INFO [11-07|16:14:23.768] Disk storage enabled for ethash caches   dir=/root/eth-data/geth/ethash count=3</span><br><span class="line">INFO [11-07|16:14:23.768] Disk storage enabled for ethash DAGs     dir=/root/.ethash              count=2</span><br><span class="line">INFO [11-07|16:14:23.769] Initialising Ethereum protocol           network=1337 dbversion=8</span><br><span class="line">INFO [11-07|16:14:23.779] Loaded most recent local header          number=0 hash=a697c6..9bf39b td=0 age=53y7mo1w</span><br><span class="line">INFO [11-07|16:14:23.780] Loaded most recent local full block      number=0 hash=a697c6..9bf39b td=0 age=53y7mo1w</span><br><span class="line">INFO [11-07|16:14:23.780] Loaded most recent local fast block      number=0 hash=a697c6..9bf39b td=0 age=53y7mo1w</span><br><span class="line">INFO [11-07|16:14:23.786] Loaded local transaction journal         transactions=0 dropped=0</span><br><span class="line">INFO [11-07|16:14:23.786] Regenerated local transaction journal    transactions=0 accounts=0</span><br><span class="line">INFO [11-07|16:14:23.791] Gasprice oracle is ignoring threshold set threshold=2</span><br><span class="line">WARN [11-07|16:14:23.798] Engine API enabled                       protocol=eth</span><br><span class="line">WARN [11-07|16:14:23.798] Engine API started but chain not configured for merge yet</span><br><span class="line">INFO [11-07|16:14:23.802] Starting peer-to-peer node               instance=Geth/v1.10.26-stable-e5eb32ac/linux-amd64/go1.18.5</span><br><span class="line">WARN [11-07|16:14:23.802] P2P server will be useless, neither dialing nor listening</span><br><span class="line">INFO [11-07|16:14:23.843] New local node record                    seq=1,667,808,816,313 id=321fce2047223769 ip=127.0.0.1 udp=0 tcp=0</span><br><span class="line">INFO [11-07|16:14:23.844] Started P2P networking                   self=enode://2d0246c1dd51623d6d8a8581095c033542366037b1e20ff815ad045af396de50df60f4aa9556148c2f4a89673bad5cab5c2ab22f3075d5bacba1b2fbebaf72e5@127.0.0.1:0</span><br><span class="line">INFO [11-07|16:14:23.848] IPC endpoint opened                      url=/root/eth-data/geth.ipc</span><br><span class="line">INFO [11-07|16:14:23.852] Loaded JWT secret file                   path=/root/eth-data/geth/jwtsecret crc32=0xef39c4cb</span><br><span class="line">INFO [11-07|16:14:23.856] HTTP server started                      endpoint=172.17.0.2:8545 auth=false prefix= cors= vhosts=localhost</span><br><span class="line">INFO [11-07|16:14:23.862] WebSocket enabled                        url=ws://127.0.0.1:8551</span><br><span class="line">INFO [11-07|16:14:23.862] HTTP server started                      endpoint=127.0.0.1:8551    auth=true  prefix= cors=localhost vhosts=localhost</span><br><span class="line">INFO [11-07|16:14:23.868] Transaction pool price threshold updated price=0</span><br><span class="line">INFO [11-07|16:14:23.868] Updated mining threads                   threads=0</span><br><span class="line">INFO [11-07|16:14:23.868] Transaction pool price threshold updated price=1</span><br><span class="line">INFO [11-07|16:14:23.868] Etherbase automatically configured       address=0xA9CB6DB62D6673ae5CD79D0d29796Dd9DF1d1A5e</span><br><span class="line">INFO [11-07|16:14:23.875] Commit new sealing work                  number=1 sealhash=6ca53b..19dc17 uncles=0 txs=0 gas=0 fees=0 elapsed=6.285ms</span><br><span class="line">INFO [11-07|16:14:23.877] Commit new sealing work                  number=1 sealhash=6ca53b..19dc17 uncles=0 txs=0 gas=0 fees=0 elapsed=8.056ms</span><br></pre></td></tr></table></figure>

<h3 id="networkid"><a href="#networkid" class="headerlink" title="networkid"></a>networkid</h3><p><code>--networkid</code>å‚æ•°éœ€è¦ä¸<code>genesis.json</code>é…ç½®æ–‡ä»¶ä¸­çš„<code>chainId</code>å€¼ä¸€è‡´ã€‚</p>
<h3 id="http-api"><a href="#http-api" class="headerlink" title="http.api"></a>http.api</h3><p>è‹¥<code>--http.api</code>è®¾ç½®é”™è¯¯ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR[11-07|16:13:36.346] Unavailable modules in HTTP API list     unavailable=[db] available=&quot;[admin debug web3 eth txpool personal ethash miner net]&quot;</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æŒ‰ç…§<code>available</code>ä¸­è§„å®šçš„å†…å®¹è¿›è¡Œé…ç½®<code>--http.api</code>å‚æ•°ã€‚</p>
<h2 id="attachäº¤äº’"><a href="#attachäº¤äº’" class="headerlink" title="attachäº¤äº’"></a>attachäº¤äº’</h2><p>æ¥ä¸‹æ¥éœ€è¦attachåˆ°ä»¥å¤ªåŠèŠ‚ç‚¹ï¼Œåœ¨gethèŠ‚ç‚¹å¯åŠ¨è¿‡ç¨‹ä¸­æœ‰è¿™æ ·ä¸€æ¡æ—¥å¿—</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO [11-07|16:14:23.848] IPC endpoint opened                      url=/root/eth-data/geth.ipc</span><br></pre></td></tr></table></figure>
<p>æ²¡é”™ï¼Œä½ çŒœå¯¹äº†ï¼Œå°±æ˜¯è¦ç”¨è¿™ä¸ªendpointè¿›è¡Œattach</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">geth attach ipc:/root/eth-data/geth.ipc</span></span><br><span class="line">Welcome to the Geth JavaScript console!</span><br><span class="line"></span><br><span class="line">instance: Geth/v1.10.26-stable-e5eb32ac/linux-amd64/go1.18.5</span><br><span class="line">coinbase: 0xa9cb6db62d6673ae5cd79d0d29796dd9df1d1a5e</span><br><span class="line">at block: 0 (Thu Jan 01 1970 08:00:00 GMT+0800 (CST))</span><br><span class="line"> datadir: /root/eth-data</span><br><span class="line"> modules: admin:1.0 debug:1.0 engine:1.0 eth:1.0 ethash:1.0 miner:1.0 net:1.0 personal:1.0 rpc:1.0 txpool:1.0 web3:1.0</span><br><span class="line"></span><br><span class="line">To exit, press ctrl-d or type exit</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥çš„<code>åˆ›å»ºç”¨æˆ·</code>ã€<code>æŒ–çŸ¿</code>ç­‰æ“ä½œéƒ½éœ€è¦åœ¨attachçŠ¶æ€ä¸‹è¿›è¡Œã€‚</p>
<h2 id="åˆ›å»ºç”¨æˆ·"><a href="#åˆ›å»ºç”¨æˆ·" class="headerlink" title="åˆ›å»ºç”¨æˆ·"></a>åˆ›å»ºç”¨æˆ·</h2><p>ä½¿ç”¨<code>personal.newAccout</code>åˆ›å»ºç”¨æˆ·ï¼Œç„¶åå¯ä»¥ä½¿ç”¨<code>eth.accounts</code>æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.accounts</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">[<span class="string">&quot;0xa9cb6db62d6673ae5cd79d0d29796dd9df1d1a5e&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">personal.newAccount()</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Passphrase:</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Repeat passphrase:</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="string">&quot;0x00e70f2bd5a644cdf4432f886bf25473cbe620ac&quot;</span></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.accounts</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">[<span class="string">&quot;0xa9cb6db62d6673ae5cd79d0d29796dd9df1d1a5e&quot;</span>, <span class="string">&quot;0x00e70f2bd5a644cdf4432f886bf25473cbe620ac&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>è‹¥ä¸è§£é”ç”¨æˆ·ï¼Œéƒ¨ç½²ä¼šæç¤ºé”™è¯¯<code>creation of HelloWorld errored: authentication needed: password or unlock</code>ã€‚è§£é”ç”¨æˆ·</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">personal.unlockAccount(eth.accounts[1])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Unlock account 0x00e70f2bd5a644cdf4432f886bf25473cbe620ac</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Passphrase:</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="literal">true</span></span></span><br></pre></td></tr></table></figure>

<h2 id="æŒ–çŸ¿"><a href="#æŒ–çŸ¿" class="headerlink" title="æŒ–çŸ¿"></a>æŒ–çŸ¿</h2><p>ä½¿ç”¨<code>miner.start()</code>å¼€å§‹æŒ–çŸ¿ï¼›ä½¿ç”¨<code>miner.stop()</code>åœæ­¢æŒ–çŸ¿ã€‚</p>
<p>å¼€å§‹æŒ–çŸ¿åï¼Œå½“å‡ºç°å¦‚ä¸‹æ—¥å¿—ä¿¡æ¯æ—¶ï¼Œè¯´æ˜æŒ–åˆ°äº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INFO [11-07|17:59:54.021] Successfully sealed new block            number=1 sealhash=84eaaa..f4d2c5 hash=925c9a..d8cb75 elapsed=1h30m51.894s</span><br><span class="line">INFO [11-07|17:59:54.022] ğŸ”¨ mined potential block                  number=1 hash=925c9a..d8cb75</span><br><span class="line">INFO [11-07|17:59:54.026] Commit new sealing work                  number=2 sealhash=865003..0e32da uncles=0 txs=0 gas=0 fees=0 elapsed=1.991ms</span><br><span class="line">INFO [11-07|17:59:54.027] Commit new sealing work                  number=2 sealhash=865003..0e32da uncles=0 txs=0 gas=0 fees=0 elapsed=3.070ms</span><br><span class="line">INFO [11-07|17:59:54.428] Generating DAG in progress               epoch=1 percentage=0  elapsed=3.563s</span><br><span class="line">INFO [11-07|17:59:56.581] Successfully sealed new block            number=2 sealhash=865003..0e32da hash=f1224d..9dc4b8 elapsed=2.554s</span><br><span class="line">INFO [11-07|17:59:56.582] ğŸ”¨ mined potential block                  number=2 hash=f1224d..9dc4b8</span><br><span class="line">INFO [11-07|17:59:56.584] Commit new sealing work                  number=3 sealhash=8de6d6..c8886e uncles=0 txs=0 gas=0 fees=0 elapsed=&quot;906.417Âµs&quot;</span><br><span class="line">INFO [11-07|17:59:56.585] Commit new sealing work                  number=3 sealhash=8de6d6..c8886e uncles=0 txs=0 gas=0 fees=0 elapsed=2.271ms</span><br><span class="line">INFO [11-07|17:59:57.730] Successfully sealed new block            number=3 sealhash=8de6d6..c8886e hash=42a018..4e7ef3 elapsed=1.146s</span><br><span class="line">INFO [11-07|17:59:57.731] ğŸ”¨ mined potential block                  number=3 hash=42a018..4e7ef3</span><br><span class="line">INFO [11-07|17:59:57.733] Commit new sealing work                  number=4 sealhash=26af07..609e57 uncles=0 txs=0 gas=0 fees=0 elapsed=1.165ms</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ä½¿ç”¨<code>eth.blockNumber</code>å¯ä»¥æŸ¥çœ‹åˆ°å½“å‰åŒºå—æ•°é‡ï¼Œä½¿ç”¨<code>eth.getBalance(eth.accounts[0])</code>æŸ¥çœ‹é»˜è®¤ç”¨æˆ·ä½™é¢ï¼ŒåŒç†ä½¿ç”¨<code>eth.getBalance(eth.accounts[1])</code>æŸ¥çœ‹æˆ‘ä»¬åˆ›å»ºçš„ç”¨æˆ·çš„ä½™é¢ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.getBalance(eth.accounts[0])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">25000000000000000000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.getBalance(eth.accounts[1])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">0</span></span><br></pre></td></tr></table></figure>

<p>æŒ–åˆ°çš„å¥–åŠ±éƒ½è¿›äº†é»˜è®¤è´¦æˆ·äº†ï¼Œæˆ‘ä»¬æ–°å»ºçš„è´¦æˆ·é‡Œæœ¨æœ‰å“¦ã€‚æ¥ç»™æˆ‘è½¬è´¦å§ï¼Œå˜¿å˜¿å˜¿â€¦.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.sendTransaction(&#123;from:eth.accounts[0],to:eth.accounts[1],value:web3.toWei(10,<span class="string">&#x27;ether&#x27;</span>)&#125;)</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="string">&quot;0x244da771baf2bd65e5e040c33ee3047b57a2492b85d271564bc90ccd7cb4fa46&quot;</span></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">eth.getBalance(eth.accounts[1])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">5000000000000000000</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">&gt; eth.getBalance(eth.accounts[0])</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">1.535e+21</span></span><br></pre></td></tr></table></figure>

<p>å“‡å“¦ï¼ŒåˆæŒ–åˆ°çŸ¿äº†ã€‚</p>
<h1 id="æ™ºèƒ½åˆçº¦"><a href="#æ™ºèƒ½åˆçº¦" class="headerlink" title="æ™ºèƒ½åˆçº¦"></a>æ™ºèƒ½åˆçº¦</h1><p>ç¯å¢ƒæ­å»ºå¥½äº†ï¼Œç°åœ¨å¼€å§‹ç¼–å†™æ™ºèƒ½åˆçº¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// compiler version must be greater than or equal to 0.8.13 and less than 0.9.0</span><br><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity 0.8.13;</span><br><span class="line">contract HelloWorld &#123;</span><br><span class="line">    function sayHelloWorld() public returns (string memory) &#123;</span><br><span class="line">        return &quot;Hello World&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Remix"><a href="#Remix" class="headerlink" title="Remix"></a>Remix</h2><p>åœ¨è¿™é‡Œè·<a target="_blank" rel="noopener" href="https://remix-project.org/">Remix</a></p>
<h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p><img src="/images/blockchain/solidity_remix_compile.jpg" alt="solidity_remix_compile"></p>
<h3 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h3><p>ç‚¹å‡»éƒ¨ç½²ï¼Œç„¶åé€‰æ‹©å¤–éƒ¨http providerï¼Œå¹¶é…ç½®æˆ‘ä»¬æ­å»ºå¥½çš„ethereumæœåŠ¡ã€‚</p>
<p><img src="/images/blockchain/solidity_remix_deploy_setting_1.jpg" alt="solidity_remix_deploy_setting_1.jpg"></p>
<p><img src="/images/blockchain/solidity_remix_deploy_setting_2.jpg" alt="solidity_remix_deploy_setting_2.jpg"></p>
<p>æ¥ä¸‹ä¸­ï¼Œé€‰æ‹©æˆ‘ä»¬åˆ›å»ºå¥½çš„è´¦æˆ·ï¼Œç„¶åè¿›è¡Œéƒ¨ç½²ã€‚</p>
<p><img src="/images/blockchain/solidity_remix_deploy.jpg" alt="solidity_remix_deploy.jpg"></p>
<p><img src="/images/blockchain/solidity_remix_deploy_log.jpg" alt="solidity_remix_deploy_log.jpg"></p>
<h2 id="æ‰§è¡Œæ™ºèƒ½åˆçº¦"><a href="#æ‰§è¡Œæ™ºèƒ½åˆçº¦" class="headerlink" title="æ‰§è¡Œæ™ºèƒ½åˆçº¦"></a>æ‰§è¡Œæ™ºèƒ½åˆçº¦</h2><p>æ‰§è¡Œæ™ºèƒ½åˆçº¦å¯ä»¥é€‰æ‹©åœ¨Remixä¸­æ‰§è¡Œï¼Œä¹Ÿå¯é€‰æ‹©attachåˆ°eth_serveræ§åˆ¶å°æ‰§è¡Œã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">abi =[&#123;<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;sayHelloWorld&quot;</span>,<span class="string">&quot;outputs&quot;</span>:[&#123;<span class="string">&quot;internalType&quot;</span>:<span class="string">&quot;string&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;string&quot;</span>&#125;],<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;function&quot;</span>&#125;]</span></span><br><span class="line">[&#123;</span><br><span class="line">    inputs: [],</span><br><span class="line">    name: &quot;sayHelloWorld&quot;,</span><br><span class="line">    outputs: [&#123;</span><br><span class="line">        internalType: &quot;string&quot;,</span><br><span class="line">        name: &quot;&quot;,</span><br><span class="line">        type: &quot;string&quot;</span><br><span class="line">    &#125;],</span><br><span class="line">    stateMutability: &quot;nonpayable&quot;,</span><br><span class="line">    type: &quot;function&quot;</span><br><span class="line">&#125;]</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">hello=eth.contract(abi).at(<span class="string">&#x27;0xCB1B01B40CD752F5d42f5b8dCeE4BE2A637CaAf2&#x27;</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  abi: [&#123;</span><br><span class="line">      inputs: [],</span><br><span class="line">      name: &quot;sayHelloWorld&quot;,</span><br><span class="line">      outputs: [&#123;...&#125;],</span><br><span class="line">      stateMutability: &quot;nonpayable&quot;,</span><br><span class="line">      type: &quot;function&quot;</span><br><span class="line">  &#125;],</span><br><span class="line">  address: &quot;0xCB1B01B40CD752F5d42f5b8dCeE4BE2A637CaAf2&quot;,</span><br><span class="line">  transactionHash: null,</span><br><span class="line">  allEvents: function bound(),</span><br><span class="line">  sayHelloWorld: function bound()</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">hello.sayHelloWorld.call()</span></span><br><span class="line">&quot;Hello World&quot;</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ-é¸£è°¢"><a href="#å‚è€ƒ-é¸£è°¢" class="headerlink" title="å‚è€ƒ&amp;é¸£è°¢"></a>å‚è€ƒ&amp;é¸£è°¢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6e739550a349">æ™ºèƒ½åˆçº¦ hello world</a></li>
<li><a target="_blank" rel="noopener" href="https://haofly.net/geth/">Geth æ­å»ºç§é“¾ private blockchain</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42822207/article/details/120620731">ã€gethã€‘Goè¯­è¨€è°ƒç”¨æ™ºèƒ½åˆçº¦ | ä¸€èµ·æ¥å­¦åŒºå—é“¾</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/12/18/storage/ceph/ceph-encode-decode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/18/storage/ceph/ceph-encode-decode/" class="post-title-link" itemprop="url">encodeå’Œdecode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-18 15:12:12" itemprop="dateCreated datePublished" datetime="2021-12-18T15:12:12+08:00">2021-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">object_t</span> &#123;</span><br><span class="line">  std::string name;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">encode</span><span class="params">(ceph::buffer::list &amp;bl)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ceph::encode;</span><br><span class="line">    <span class="built_in">encode</span>(name, bl);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">decode</span><span class="params">(ceph::buffer::list::const_iterator &amp;bl)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ceph::decode;</span><br><span class="line">    <span class="built_in">decode</span>(name, bl);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">WRITE_CLASS_ENCODER</span>(<span class="type">object_t</span>)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;object.h ***</p>
<p>å¯¹äºCephä¸­çš„æ¯ä¸€ç§éœ€è¦å­˜å‚¨çš„èµ„æºåœ¨è¿›è¡Œå­˜å‚¨å‰éƒ½è¦è¿›è¡Œ<code>encode</code>æ“ä½œï¼Œç„¶åå†å°†å…¶å†™å…¥ç¡¬ç›˜ã€‚å¯¹äºè¯»å–åŒæ ·ï¼Œåœ¨ä»ç¡¬ç›˜è·å–åˆ°æ•°æ®åéœ€è¦è¿›è¡Œ<code>decode</code>æ“ä½œã€‚è€Œæ¯ç§éœ€è¦å­˜å‚¨èµ„æºå¦‚ä½•<code>encode</code>å’Œ<code>decode</code>å½“ç„¶è¦ç”±èµ„æºè‡ªå·±æ¥å†³å®šã€‚æ‰€ä»¥åœ¨èµ„æºçš„<code>class</code>æˆ–<code>struct</code>ä¸­è¦å®ç°<code>encode</code>å’Œ<code>decode</code>æ–¹æ³•ã€‚</p>
<p><code>WRITE_CLASS_ENCODER(object_t)</code>å¹²äº†äº›å•¥å‘¢ã€‚ã€‚ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// see denc.h for ENCODE_DUMP_PATH discussion and definition.</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ENCODE_DUMP_PATH</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_PRE()                      \</span></span><br><span class="line"><span class="meta">  unsigned pre_off = bl.length()</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_POST(cl)                                           \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                  \</span></span><br><span class="line"><span class="meta">    static int i = 0;                                                   \</span></span><br><span class="line"><span class="meta">    i++;                                                                \</span></span><br><span class="line"><span class="meta">    int bits = 0;                                                       \</span></span><br><span class="line"><span class="meta">    for (unsigned t = i; t; bits++)                                     \</span></span><br><span class="line"><span class="meta">      t &amp;= t - 1;                                                       \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (bits &gt; 2)                                                       \</span></span><br><span class="line"><span class="meta">      break;                                                            \</span></span><br><span class="line"><span class="meta">    char fn[PATH_MAX];                                                  \</span></span><br><span class="line"><span class="meta">    snprintf(fn, sizeof(fn), ENCODE_STRINGIFY(ENCODE_DUMP_PATH) <span class="string">&quot;/%s__%d.%x&quot;</span>, #cl, getpid(), i++); \</span></span><br><span class="line"><span class="meta">    int fd = ::open(fn, O_WRONLY|O_TRUNC|O_CREAT|O_CLOEXEC|O_BINARY, 0644);             \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (fd &gt;= 0) &#123;                                                      \</span></span><br><span class="line"><span class="meta">      ::ceph::bufferlist sub;                                           \</span></span><br><span class="line"><span class="meta">      sub.substr_of(bl, pre_off, bl.length() - pre_off);                \</span></span><br><span class="line"><span class="meta">      sub.write_fd(fd);                                                 \</span></span><br><span class="line"><span class="meta">      ::close(fd);                                                      \</span></span><br><span class="line"><span class="meta">    &#125;                                                                   \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_PRE()</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> ENCODE_DUMP_POST(cl)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_CLASS_ENCODER(cl)                                         \</span></span><br><span class="line"><span class="meta">  inline void encode(const cl&amp; c, ::ceph::buffer::list &amp;bl, uint64_t features=0) &#123; \</span></span><br><span class="line"><span class="meta">    ENCODE_DUMP_PRE(); c.encode(bl); ENCODE_DUMP_POST(cl); &#125;            \</span></span><br><span class="line"><span class="meta">  inline void decode(cl &amp;c, ::ceph::bufferlist::const_iterator &amp;p) &#123; c.decode(p); &#125;</span></span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>çœ‹äº†ä¸Šé¢çš„ä»£ç åº”è¯¥èƒ½äº†è§£åˆ°<code>WRITE_CLASS_ENCODER(object_t)</code>æ˜¯å¯¹<code>encode</code>å’Œ<code>decode</code>å‡½æ•°çš„é‡è½½ã€‚è¿™æ˜¯å…¥å£ï¼Œç„¶åå†è°ƒç”¨å…¶èµ„æºè‡ªèº«<code>encode</code>æˆ–<code>decode</code>æ–¹æ³•ã€‚</p>
<p>é‚£ä¹ˆå¯¹äºä¸€äº›åŸºç¡€ç±»å‹ï¼ˆå¦‚ï¼šintã€stringç­‰ï¼‰æ˜¯å¦‚æœ<code>encode</code>å’Œ<code>decode</code>çš„å‘¢ï¼Ÿ</p>
<h3 id="intç±»å‹"><a href="#intç±»å‹" class="headerlink" title="intç±»å‹"></a>intç±»å‹</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// int types</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_INTTYPE_ENCODER(type, etype)                              \</span></span><br><span class="line"><span class="meta">  inline void encode(type v, ::ceph::bufferlist&amp; bl, uint64_t features=0) &#123; \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    e = v;                                                              \</span></span><br><span class="line"><span class="meta">    ::ceph::encode_raw(e, bl);                                          \</span></span><br><span class="line"><span class="meta">  &#125;                                                                     \</span></span><br><span class="line"><span class="meta">  inline void decode(type &amp;v, ::ceph::bufferlist::const_iterator&amp; p) &#123;  \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    ::ceph::decode_raw(e, p);                                           \</span></span><br><span class="line"><span class="meta">    v = e;                                                              \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">uint64_t</span>, le64)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">int64_t</span>, le64)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">uint32_t</span>, le32)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">int32_t</span>, le32)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">uint16_t</span>, le16)</span><br><span class="line"><span class="built_in">WRITE_INTTYPE_ENCODER</span>(<span class="type">int16_t</span>, le16)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>intç±»å‹çš„<code>encode</code>å’Œ<code>decode</code>åˆè°ƒç”¨äº†<code>encode_raw</code>å’Œ<code>decode_raw</code>ã€‚çœŸæ˜¯ä¸€å±‚å¥—ä¸€å±‚å•Šï½ï¼ˆä¿„ç½—æ–¯å¥—å¨ƒå˜›ï¼‰ï½</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// base types</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode_raw</span><span class="params">(<span class="type">const</span> T&amp; t, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  bl.<span class="built_in">append</span>((<span class="type">char</span>*)&amp;t, <span class="built_in">sizeof</span>(t));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">decode_raw</span><span class="params">(T&amp; t, bufferlist::const_iterator &amp;p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  p.<span class="built_in">copy</span>(<span class="built_in">sizeof</span>(t), (<span class="type">char</span>*)&amp;t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_RAW_ENCODER(type)                                         \</span></span><br><span class="line"><span class="meta">  inline void encode(const type &amp;v, ::ceph::bufferlist&amp; bl, uint64_t features=0) &#123; ::ceph::encode_raw(v, bl); &#125; \</span></span><br><span class="line"><span class="meta">  inline void decode(type &amp;v, ::ceph::bufferlist::const_iterator&amp; p) &#123; ::ceph::decode_raw(v, p); &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(__u8)</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CHAR_IS_SIGNED</span></span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(__s8)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(<span class="type">char</span>)</span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(ceph_le64)</span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(ceph_le32)</span><br><span class="line"><span class="built_in">WRITE_RAW_ENCODER</span>(ceph_le16)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>baseæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ— è®ºintå‡ ä¸ªå­—èŠ‚ï¼Œéƒ½æ˜¯ä»ä½åˆ°é«˜ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„å†™ä¸‹å»ï¼Œå†ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„è¯»å‡ºæ¥ã€‚ã€‚ã€‚</p>
<h3 id="floatç±»å‹"><a href="#floatç±»å‹" class="headerlink" title="floatç±»å‹"></a>floatç±»å‹</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_FLTTYPE_ENCODER(type, itype, etype)                       \</span></span><br><span class="line"><span class="meta">  static_assert(sizeof(type) == sizeof(itype));                         \</span></span><br><span class="line"><span class="meta">  static_assert(std::numeric_limits<span class="string">&lt;type&gt;</span>::is_iec559,                   \</span></span><br><span class="line"><span class="meta">              <span class="string">&quot;floating-point type not using IEEE754 format&quot;</span>);          \</span></span><br><span class="line"><span class="meta">  inline void encode(type v, ::ceph::bufferlist&amp; bl, uint64_t features=0) &#123; \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    e = *reinterpret_cast<span class="string">&lt;itype *&gt;</span>(&amp;v);                                 \</span></span><br><span class="line"><span class="meta">    ::ceph::encode_raw(e, bl);                                          \</span></span><br><span class="line"><span class="meta">  &#125;                                                                     \</span></span><br><span class="line"><span class="meta">  inline void decode(type &amp;v, ::ceph::bufferlist::const_iterator&amp; p) &#123;  \</span></span><br><span class="line"><span class="meta">    ceph_##etype e;                                                     \</span></span><br><span class="line"><span class="meta">    ::ceph::decode_raw(e, p);                                           \</span></span><br><span class="line"><span class="meta">    *reinterpret_cast<span class="string">&lt;itype *&gt;</span>(&amp;v) = e;                                 \</span></span><br><span class="line"><span class="meta">  &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">WRITE_FLTTYPE_ENCODER</span>(<span class="type">float</span>, <span class="type">uint32_t</span>, le32)</span><br><span class="line"><span class="built_in">WRITE_FLTTYPE_ENCODER</span>(<span class="type">double</span>, <span class="type">uint64_t</span>, le64)</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>floatç±»å‹å…³é”®åœ¨äº<code>reinterpret_cast</code>å°†ä¸€ä¸ªæµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´æ•°ã€‚<a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/language/reinterpret_cast">æ›´å¤šå…³äº<code>reinterpret_cast</code>çš„å†…å®¹</a></p>
<h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// string</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode</span><span class="params">(std::string_view s, bufferlist&amp; bl, <span class="type">uint64_t</span> features=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __u32 len = s.<span class="built_in">length</span>();</span><br><span class="line">  <span class="built_in">encode</span>(len, bl);</span><br><span class="line">  <span class="keyword">if</span> (len)</span><br><span class="line">    bl.<span class="built_in">append</span>(s.<span class="built_in">data</span>(), len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode</span><span class="params">(<span class="type">const</span> std::string&amp; s, bufferlist&amp; bl, <span class="type">uint64_t</span> features=<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">encode</span>(std::<span class="built_in">string_view</span>(s), bl, features);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">decode</span><span class="params">(std::string&amp; s, bufferlist::const_iterator&amp; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __u32 len;</span><br><span class="line">  <span class="built_in">decode</span>(len, p);</span><br><span class="line">  s.<span class="built_in">clear</span>();</span><br><span class="line">  p.<span class="built_in">copy</span>(len, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode_nohead</span><span class="params">(std::string_view s, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  bl.<span class="built_in">append</span>(s.<span class="built_in">data</span>(), s.<span class="built_in">length</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode_nohead</span><span class="params">(<span class="type">const</span> std::string&amp; s, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">encode_nohead</span>(std::<span class="built_in">string_view</span>(s), bl);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">decode_nohead</span><span class="params">(<span class="type">int</span> len, std::string&amp; s, bufferlist::const_iterator&amp; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  s.<span class="built_in">clear</span>();</span><br><span class="line">  p.<span class="built_in">copy</span>(len, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// const char* (encode only, string compatible)</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">encode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, bufferlist&amp; bl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">encode</span>(std::<span class="built_in">string_view</span>(s, <span class="built_in">strlen</span>(s)), bl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>*** From: src&#x2F;include&#x2F;encoding.h ***</p>
<p>stringçš„<code>encode</code>å’Œ<code>decode</code>åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯æœ‰â€œå®³çš„â€(head)ï¼Œä¸€ç§æ˜¯æ— â€œå®³çš„â€ã€‚æœ‰â€œå®³çš„â€éœ€è¦å…ˆè®°å½•stringçš„é•¿åº¦ï¼Œå†è®°å½•stringçš„å†…å®¹ï¼›æ— â€œå®³çš„â€ç›´æ¥è®°å½•å†…å®¹ï¼Œå•å†<code>decode</code>è¿‡ç¨‹ä¸­éœ€è¦åˆ¶å®šé•¿åº¦ã€‚æ€»ä¹‹è¿™ä¸ªé•¿åº¦æ€»è¦æœ‰ä¸ªäººæ¥è®°ã€‚å¥½é¸¡è‚‹ï¼</p>
<hr>
<p>æ•´ä¸ªçš„<code>encode</code>å’Œ<code>decode</code>çš„è¿‡ç¨‹ç”¨åˆ°äº†ä¸€ä¸ª<code>bufferlist</code>ç±»å‹ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>bufferlist</code>åˆæ˜¯ä¸ªä»€ä¹ˆç»“æ„å‘¢ï¼Œè¯¦ç»†è¯·è§<a href="">cephä¸­çš„buffer</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/28/language/cpp/stl-container/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/28/language/cpp/stl-container/" class="post-title-link" itemprop="url">STLå®¹å™¨ä»¬</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-28 17:03:31" itemprop="dateCreated datePublished" datetime="2021-09-28T17:03:31+08:00">2021-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>c++ä¸­stlæ¶‰åŠåˆ°çš„å®¹å™¨ç±»ï¼ˆæˆ–structï¼‰æœ‰å¾ˆå¤šï¼Œå…·ä½“éƒ½æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ</p>
<h2 id="std-array"><a href="#std-array" class="headerlink" title="std::array"></a>std::array</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, std::<span class="type">size_t</span> _Nm&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">__array_traits</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">typedef</span> _Tp _Type[_Nm];</span><br><span class="line">        <span class="keyword">typedef</span> __is_swappable&lt;_Tp&gt; _Is_swappable;</span><br><span class="line">        <span class="keyword">typedef</span> __is_nothrow_swappable&lt;_Tp&gt; _Is_nothrow_swappable;</span><br><span class="line"></span><br><span class="line">        <span class="type">static</span> <span class="keyword">constexpr</span> _Tp&amp;</span><br><span class="line">        _S_ref(<span class="type">const</span> _Type&amp; <span class="type">__t</span>, std::<span class="type">size_t</span> __n) <span class="keyword">noexcept</span></span><br><span class="line">        &#123; <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;_Tp&amp;&gt;(<span class="type">__t</span>[__n]); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">static</span> <span class="keyword">constexpr</span> _Tp*</span><br><span class="line">        _S_ptr(<span class="type">const</span> _Type&amp; <span class="type">__t</span>) <span class="keyword">noexcept</span></span><br><span class="line">        &#123; <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;_Tp*&gt;(<span class="type">__t</span>); &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">......</span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, std::<span class="type">size_t</span> _Nm&gt;</span><br><span class="line">      <span class="keyword">struct</span> <span class="title class_">array</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">typedef</span> _Tp                                     value_type;</span><br><span class="line">        <span class="keyword">typedef</span> value_type*                             pointer;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">const</span> value_type*                       const_pointer;</span><br><span class="line">        <span class="keyword">typedef</span> value_type&amp;                             reference;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">const</span> value_type&amp;                       const_reference;</span><br><span class="line">        <span class="keyword">typedef</span> value_type*                             iterator;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">const</span> value_type*                       const_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::<span class="type">size_t</span>                             size_type;</span><br><span class="line">        <span class="keyword">typedef</span> std::<span class="type">ptrdiff_t</span>                          difference_type;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;iterator&gt;         reverse_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;const_iterator&gt;   const_reverse_iterator;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Support for zero-sized arrays mandatory.</span></span><br><span class="line">        <span class="keyword">typedef</span> _GLIBCXX_STD_C::__array_traits&lt;_Tp, _Nm&gt; _AT_Type;</span><br><span class="line">        <span class="keyword">typename</span> _AT_Type::_Type                         _M_elems;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// No explicit construct/copy/destroy for aggregate type.</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>çœ‹è¿™é‡Œ<code>typename _AT_Type::_Type _M_elems;</code>å†çœ‹è¿™é‡Œ<code>typedef _Tp _Type[_Nm];</code>ã€‚æ‡‚äº†å—ï¼Œå°±æ˜¯åœ¨æ ˆä¸Šåˆ†é…ä¸€ä¸ªå¤§å°å›ºå®šçš„æ•°ç»„ã€‚</p>
<h2 id="std-vector"><a href="#std-vector" class="headerlink" title="std::vector"></a>std::vector</h2><p><code>vector</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåªæ˜¯ä¸æ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„ï¼Œè€Œæ˜¯åˆ†é…åœ¨å †ä¸Šçš„ã€‚</p>
<p>çœ‹è¿™é‡Œæœ‰ä¸€ä¸ª<code>_Alloc</code>é»˜è®¤ä½¿ç”¨çš„æ˜¯<code>std::allocator&lt;_Tp&gt;</code>ï¼Œè¿™å°±æ˜¯åœ¨å †ä¸Šåˆ†é…å†…å­˜ç”¨çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  @brief A standard container which offers fixed time access to</span></span><br><span class="line"><span class="comment">     *  individual elements in any order.</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  @ingroup sequences</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  @tparam _Tp  Type of element.</span></span><br><span class="line"><span class="comment">     *  @tparam _Alloc  Allocator type, defaults to allocator&lt;_Tp&gt;.</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  Meets the requirements of a &lt;a href=&quot;tables.html#65&quot;&gt;container&lt;/a&gt;, a</span></span><br><span class="line"><span class="comment">     *  &lt;a href=&quot;tables.html#66&quot;&gt;reversible container&lt;/a&gt;, and a</span></span><br><span class="line"><span class="comment">     *  &lt;a href=&quot;tables.html#67&quot;&gt;sequence&lt;/a&gt;, including the</span></span><br><span class="line"><span class="comment">     *  &lt;a href=&quot;tables.html#68&quot;&gt;optional sequence requirements&lt;/a&gt; with the</span></span><br><span class="line"><span class="comment">     *  %exception of @c push_front and @c pop_front.</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *  In some terminology a %vector can be described as a dynamic</span></span><br><span class="line"><span class="comment">     *  C-style array, it offers fast and efficient access to individual</span></span><br><span class="line"><span class="comment">     *  elements in any order and saves the user from worrying about</span></span><br><span class="line"><span class="comment">     *  memory and size allocation.  Subscripting ( @c [] ) access is</span></span><br><span class="line"><span class="comment">     *  also provided as with C-style arrays.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc = std::allocator&lt;_Tp&gt; &gt;</span><br><span class="line">  <span class="keyword">class</span> vector : <span class="keyword">protected</span> _Vector_base&lt;_Tp, _Alloc&gt;</span><br><span class="line">  &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _GLIBCXX_CONCEPT_CHECKS</span></span><br><span class="line">    <span class="comment">// Concept requirements.</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc::value_type               _Alloc_value_type;</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __cplusplus &lt; 201103L</span></span><br><span class="line">    __glibcxx_class_requires(_Tp, _SGIAssignableConcept)</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">    __glibcxx_class_requires2(_Tp, _Alloc_value_type, _SameTypeConcept)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus &gt;= 201103L</span></span><br><span class="line">    <span class="built_in">static_assert</span>(is_same&lt;<span class="keyword">typename</span> remove_cv&lt;_Tp&gt;::type, _Tp&gt;::value,</span><br><span class="line">        <span class="string">&quot;std::vector must have a non-const, non-volatile value_type&quot;</span>);</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __cplusplus &gt; 201703L || defined __STRICT_ANSI__</span></span><br><span class="line">    <span class="built_in">static_assert</span>(is_same&lt;<span class="keyword">typename</span> _Alloc::value_type, _Tp&gt;::value,</span><br><span class="line">        <span class="string">&quot;std::vector must have the same value_type as its allocator&quot;</span>);</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">typedef</span> _Vector_base&lt;_Tp, _Alloc&gt;                 _Base;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Base::_Tp_alloc_type            _Tp_alloc_type;</span><br><span class="line">    <span class="keyword">typedef</span> __gnu_cxx::__alloc_traits&lt;_Tp_alloc_type&gt; _Alloc_traits;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">typedef</span> _Tp                                       value_type;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Base::pointer                   pointer;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc_traits::const_pointer     const_pointer;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc_traits::reference         reference;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> _Alloc_traits::const_reference   const_reference;</span><br><span class="line">        <span class="keyword">typedef</span> __gnu_cxx::__normal_iterator&lt;pointer, vector&gt; iterator;</span><br><span class="line">        <span class="keyword">typedef</span> __gnu_cxx::__normal_iterator&lt;const_pointer, vector&gt;</span><br><span class="line">        const_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;const_iterator&gt;     const_reverse_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> std::reverse_iterator&lt;iterator&gt;           reverse_iterator;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">size_t</span>                                    size_type;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="type">ptrdiff_t</span>                                 difference_type;</span><br><span class="line">        <span class="keyword">typedef</span> _Alloc                                    allocator_type;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>å†çœ‹è¿™é‡Œå®šä¹‰äº†ä¸‰ä¸ªæŒ‡é’ˆï¼Œç”¨çš„æ˜¯<code>typedef typename _Base::pointer pointer;</code>ç±»å‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> std _GLIBCXX_VISIBILITY(<span class="keyword">default</span>)</span><br><span class="line">&#123;</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span><br><span class="line">_GLIBCXX_BEGIN_NAMESPACE_CONTAINER</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// See bits/stl_deque.h&#x27;s _Deque_base for an explanation.</span></span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Tp, <span class="keyword">typename</span> _Alloc&gt;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_Vector_base</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> __gnu_cxx::__alloc_traits&lt;_Alloc&gt;::<span class="keyword">template</span></span><br><span class="line">      rebind&lt;_Tp&gt;::other _Tp_alloc_type;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> __gnu_cxx::__alloc_traits&lt;_Tp_alloc_type&gt;::pointer</span><br><span class="line">      pointer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_Vector_impl_data</span></span><br><span class="line">    &#123;</span><br><span class="line">      pointer _M_start;</span><br><span class="line">      pointer _M_finish;</span><br><span class="line">      pointer _M_end_of_storage;</span><br><span class="line"></span><br><span class="line">      _Vector_impl_data() _GLIBCXX_NOEXCEPT</span><br><span class="line">      : _M_start(), _M_finish(), _M_end_of_storage()</span><br><span class="line">      &#123; &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>æŒ‡é’ˆåˆ†åˆ«å«ï¼š<code>pointer _M_start;</code>ã€<code>pointer _M_finish;</code>ã€<code>pointer _M_end_of_storage;</code> ä¹‹å‰ä¸å«è¿™ä¸ªçš„ï¼Œç°åœ¨éƒ½æ”¹äº†ã€‚ã€‚ã€‚æ— æ‰€è°“äº†ï¼Œå«ä¹‰æ²¡å˜ã€‚ã€‚ã€‚</p>
<p><code>vector</code>åœ¨å †ä¸Šç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œç”¨äºå­˜æ”¾æ•°ç»„å…ƒç´ ã€‚ç”¨<code>_M_start</code>è¡¨ç¤ºæ•°ç»„å¼€å§‹çš„ä½ç½®ï¼Œç”¨<code>_M_finish</code>æ•°æ®ç»“æŸçš„ä½ç½®ï¼Œç”¨<code>_M_end_of_storage</code> è¡¨ç¤ºè¿™å—å†…å­˜å®¹é‡ç»“æŸçš„ä½ç½®ã€‚</p>
<ul>
<li>å½“<code>vector</code>å®¹é‡ä¸è¶³æ—¶ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹ä¼šå¼•å‘å†…å­˜æ‹·è´ã€‚</li>
<li>å½“å‘<code>vector</code>æ’å…¥ã€åˆ é™¤æŸäº›å…ƒç´ æ—¶ï¼Œç”±äºé‡‡ç”¨è¿ç»­å­˜å‚¨æ–¹å¼ï¼Œä¹Ÿä¼šå¼•å‘å†…å­˜æ‹·è´ã€‚</li>
</ul>
<h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h3><p>åˆšåˆšæåˆ°äº†æ‰©å®¹ï¼Œå¦‚æœä¸€ä¸ª<code>vector</code>å®¹é‡ä¸è¶³äº†éœ€è¦æ‰©å®¹ï¼Œåº”è¯¥æ‰©å¤šå°‘å‘¢ï¼Ÿè¿™ä¸ªæ ¹æ®<code>reserve()</code>çš„å€¼æ¥å†³å®šã€‚å¦‚æœä½ æ²¡æœ‰è®¾ç½®çš„è¯ï¼ŒæŒ‰ä½ å­˜å…¥çš„æ•°æ®é‡è¿›è¡Œæ‰©å®¹ã€‚å¦‚æœä½ è®¾ç½®äº†è¿™ä¸ªå€¼ï¼Œé‚£ä¹ˆæ¯æ¬¡æ‰©<code>reserve()</code>ä¸ªã€‚</p>
<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>To be countinueâ€¦</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/27/language/cpp/variable-in-elf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/27/language/cpp/variable-in-elf/" class="post-title-link" itemprop="url">å˜é‡åŠå‡½æ•°åœ¨å†…å­˜ä¸­çš„ä½ç½®</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-27 15:50:26" itemprop="dateCreated datePublished" datetime="2021-09-27T15:50:26+08:00">2021-09-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä»ä¸€ä¸ªCPPæ–‡ä»¶ç¼–è¯‘æˆELFå¯æ‰§è¡Œæ–‡ä»¶è¿‡ç¨‹ä¸­ä¼šæŠŠä¸åŒçš„å˜é‡å’Œå‡½æ•°æ˜ å°„åˆ°ä¸åŒçš„å†…å­˜åŒºåŸŸã€‚è¿™äº›ä¸åŒçš„åŒºåŸŸå…·æœ‰ä¸åŒçš„è®¿é—®æƒé™ï¼Œæœ‰çš„æ˜¯åªè¯»çš„ï¼Œæœ‰çš„æ˜¯è¯»å†™çš„ï¼Œæœ‰çš„æ˜¯å¯æ‰§è¡Œçš„ã€‚è®©æˆ‘ä»¬ä¸¾ä¸ªç®€å•çš„ä¾‹å­æ¥äº†è§£ä¸€ä¸‹ã€‚</p>
<p>ç¤ºä¾‹ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> dst_type,<span class="keyword">typename</span> src_type&gt;</span></span><br><span class="line"><span class="function">dst_type <span class="title">pointer_cast</span><span class="params">(src_type src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="built_in">static_cast</span>&lt;dst_type*&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">void</span>*&gt;(&amp;src));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_uninit_var;</span><br><span class="line"><span class="type">int</span> global_init_var = <span class="number">255</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> const_global_int = <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Just a function\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">static_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">inline_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="type">pfunc_t</span>)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="type">main_func_t</span>)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="type">static_func_t</span>)</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;I am Show...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">localshow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;I am localshow...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var = <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> local_uninit_var;</span><br><span class="line">    <span class="type">int</span> local_init_var = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> const_local_int = <span class="number">127</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>* heap_int = <span class="keyword">new</span> <span class="built_in">int</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">pfunc_t</span> pf = func;</span><br><span class="line">    <span class="type">main_func_t</span> mf = main;</span><br><span class="line">    <span class="type">static_func_t</span> sf = static_func;</span><br><span class="line">    <span class="type">static_func_t</span> csf = Simple::Show;</span><br><span class="line">    <span class="type">void</span>* cpf = <span class="built_in">pointer_cast</span>&lt;<span class="type">void</span>*&gt;(&amp;Simple::localshow);</span><br><span class="line">    <span class="type">pfunc_t</span> ipf = inline_func;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;global_uninit_var: 0x%x\n&quot;</span>, &amp;global_uninit_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;global_init_var: 0x%x\n&quot;</span>, &amp;global_init_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;static_var: 0x%x\n&quot;</span>, &amp;static_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;const_global_int: 0x%x\n&quot;</span>, &amp;const_global_int);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;local_uninit_var: 0x%x\n&quot;</span>, &amp;local_uninit_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;local_init_var: 0x%x\n&quot;</span>, &amp;local_init_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;const_local_int: 0x%x\n&quot;</span>, &amp;const_local_int);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;heap_int: 0x%x, 0x%x\n&quot;</span>, &amp;heap_int, heap_int);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;point_func: 0x%x, 0x%x\n&quot;</span>, &amp;pf, pf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;point_main_func: 0x%x, 0x%x\n&quot;</span>, &amp;mf, mf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;static_func: 0x%x, 0x%x\n&quot;</span>, &amp;sf, sf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;class_static_func: 0x%x, 0x%x\n&quot;</span>, &amp;csf, csf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;class_local_func: 0x%x, 0x%x\n&quot;</span>, &amp;cpf, cpf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;inline_func: 0x%x, 0x%x\n&quot;</span>, &amp;ipf, ipf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºELFæ ¼å¼ä¸­æœ‰å¾ˆå¤šä¿¡æ¯ï¼Œæˆ‘ä»¬åªå–<code>readelf --sections</code>ç›¸å…³ä¿¡æ¯<br>ELFç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[Nr] Name              Type             Address           Offset       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">[ 0]                   NULL             0000000000000000  00000000       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">[ 1] .interp           PROGBITS         00000000004002a8  000002a8       000000000000001c  0000000000000000   A       0     0     1</span><br><span class="line">[ 2] .note.gnu.bu[...] NOTE             00000000004002c4  000002c4       0000000000000024  0000000000000000   A       0     0     4</span><br><span class="line">[ 3] .note.ABI-tag     NOTE             00000000004002e8  000002e8       0000000000000020  0000000000000000   A       0     0     4</span><br><span class="line">[ 4] .gnu.hash         GNU_HASH         0000000000400308  00000308       000000000000001c  0000000000000000   A       5     0     8</span><br><span class="line">[ 5] .dynsym           DYNSYM           0000000000400328  00000328       0000000000000090  0000000000000018   A       6     1     8</span><br><span class="line">[ 6] .dynstr           STRTAB           00000000004003b8  000003b8       000000000000007d  0000000000000000   A       0     0     1</span><br><span class="line">[ 7] .gnu.version      VERSYM           0000000000400436  00000436       000000000000000c  0000000000000002   A       5     0     2</span><br><span class="line">[ 8] .gnu.version_r    VERNEED          0000000000400448  00000448       0000000000000040  0000000000000000   A       6     2     8</span><br><span class="line">[ 9] .rela.dyn         RELA             0000000000400488  00000488       0000000000000018  0000000000000018   A       5     0     8</span><br><span class="line">[10] .rela.plt         RELA             00000000004004a0  000004a0       0000000000000078  0000000000000018  AI       5    22     8</span><br><span class="line">[11] .init             PROGBITS         0000000000401000  00001000       000000000000001a  0000000000000000  AX       0     0     4</span><br><span class="line">[12] .plt              PROGBITS         0000000000401020  00001020       0000000000000060  0000000000000010  AX       0     0     16</span><br><span class="line">[13] .text             PROGBITS         0000000000401080  00001080       0000000000000392  0000000000000000  AX       0     0     16</span><br><span class="line">[14] .fini             PROGBITS         0000000000401414  00001414       0000000000000009  0000000000000000  AX       0     0     4</span><br><span class="line">[15] .rodata           PROGBITS         0000000000402000  00002000       000000000000019e  0000000000000000   A       0     0     8</span><br><span class="line">[16] .eh_frame_hdr     PROGBITS         00000000004021a0  000021a0       0000000000000064  0000000000000000   A       0     0     4</span><br><span class="line">[17] .eh_frame         PROGBITS         0000000000402208  00002208       00000000000001b8  0000000000000000   A       0     0     8</span><br><span class="line">[18] .init_array       INIT_ARRAY       0000000000403de8  00002de8       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">[19] .fini_array       FINI_ARRAY       0000000000403df0  00002df0       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">[20] .dynamic          DYNAMIC          0000000000403df8  00002df8       0000000000000200  0000000000000010  WA       6     0     8</span><br><span class="line">[21] .got              PROGBITS         0000000000403ff8  00002ff8       0000000000000008  0000000000000008  WA       0     0     8</span><br><span class="line">[22] .got.plt          PROGBITS         0000000000404000  00003000       0000000000000040  0000000000000008  WA       0     0     8</span><br><span class="line">[23] .data             PROGBITS         0000000000404040  00003040       000000000000000c  0000000000000000  WA       0     0     4</span><br><span class="line">[24] .bss              NOBITS           000000000040404c  0000304c       000000000000000c  0000000000000000  WA       0     0     4</span><br><span class="line">[25] .comment          PROGBITS         0000000000000000  0000304c       000000000000005c  0000000000000001  MS       0     0     1</span><br><span class="line">[26] .debug_aranges    PROGBITS         0000000000000000  000030a8       0000000000000070  0000000000000000           0     0     1</span><br><span class="line">[27] .debug_info       PROGBITS         0000000000000000  00003118       000000000000031a  0000000000000000           0     0     1</span><br><span class="line">[28] .debug_abbrev     PROGBITS         0000000000000000  00003432       00000000000001d9  0000000000000000           0     0     1</span><br><span class="line">[29] .debug_line       PROGBITS         0000000000000000  0000360b       0000000000000114  0000000000000000           0     0     1</span><br><span class="line">[30] .debug_str        PROGBITS         0000000000000000  0000371f       0000000000000235  0000000000000001  MS       0     0     1</span><br><span class="line">[31] .debug_ranges     PROGBITS         0000000000000000  00003954       0000000000000060  0000000000000000           0     0     1</span><br><span class="line">[32] .symtab           SYMTAB           0000000000000000  000039b8       0000000000000750  0000000000000018          33    52     8</span><br><span class="line">[33] .strtab           STRTAB           0000000000000000  00004108       0000000000000298  0000000000000000           0     0     1</span><br><span class="line">[34] .shstrtab         STRTAB           0000000000000000  000043a0       0000000000000151  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure>

<p>å°†ä¸Šè¿°ä»£ç ç¼–è¯‘è¿è¡Œæ‰“å°å‡ºçš„ç»“æœå¯¹åº”åˆ°elfæ ¼å¼ä¸­ç›¸åº”çš„åŒºåŸŸå¦‚ä¸‹ï¼š</p>
<p><img src="/images/cpp/variable.png" alt="variable"></p>
<ul>
<li>æ‰€æœ‰ä»£ç æ— èŠä½œä½•æ ‡è®°å…¨éƒ¨å­˜å‚¨åœ¨<code>.text</code>æ®µï¼Œæ¢å¥è¯è¯´ä»æ±‡ç¼–çš„è§’åº¦å¯ä»¥è°ƒç”¨ä»»ä½•å‡½æ•°éƒ½å¯ä»¥è¢«è°ƒç”¨</li>
<li>å…¨å±€çš„<code>const</code>å¸¸é‡å­˜æ”¾åœ¨<code>.rodata</code>æ®µ</li>
<li>å±€éƒ¨çš„<code>const</code>å¸¸é‡åˆ™å­˜å‚¨åœ¨æ ˆç©ºé—´å†…ï¼Œè€Œå¸¸é‡çš„å³å€¼<code>127</code>åˆ™å­˜æ”¾åœ¨<code>.text</code>æ®µ</li>
<li>å·²ç»åˆå§‹åŒ–çš„å…¨å±€å˜é‡æˆ–<code>static</code>å˜é‡å­˜æ”¾åœ¨<code>.data</code>æ®µ</li>
<li>æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å­˜æ”¾åœ¨<code>bss</code>æ®µ</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/23/language/cpp/smart-pointers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/23/language/cpp/smart-pointers/" class="post-title-link" itemprop="url">C++æ™ºèƒ½æŒ‡é’ˆ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-23 14:54:21" itemprop="dateCreated datePublished" datetime="2021-09-23T14:54:21+08:00">2021-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ™ºèƒ½æŒ‡é’ˆï¼Œä»å…¶æœ¬è´¨ä¸Šè¯´ï¼Œå°±æ˜¯è¦æ§åˆ¶å¯¹è±¡çš„é”€æ¯æ—¶æœºã€‚æ¢å¥è¯è®²å°±æ˜¯ä½•æ—¶è°ƒç”¨å¯¹è±¡çš„ææ„å‡½æ•°ã€‚ä»C++11å¼€å§‹å¼•å…¥ä¸‰ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼ˆ<code>unique_ptr</code>,<code>shared_ptr</code>,<code>weak_ptr</code>ï¼‰ï¼Œå‡†ç¡®çš„è¯´æ˜¯å››ç§ï¼ˆè¿˜æœ‰<code>auto_ptr</code>ï¼‰ï¼Œä½†ä»C++17å¼€å§‹<code>auto_ptr</code>è¢«ç§»é™¤äº†ã€‚æ‰€ä»¥å°±å‰©ä¸‹ä¸Šè¿°ä¸‰ç§äº†ã€‚æ‰€æœ‰çš„æ™ºèƒ½æŒ‡é’ˆéƒ½åŒ…å«åœ¨<code>memory</code>å¤´æ–‡ä»¶ä¸­ã€‚</p>
<p>é¦–å…ˆï¼Œå¾ˆä¹…ä»¥å‰çš„C++æ˜¯æ²¡æœ‰æ™ºèƒ½æŒ‡é’ˆçš„ï¼Œç”¨æˆ·åˆ›å»ºåœ¨å †ä¸Šçš„å†…å­˜ï¼Œæ™ºèƒ½è‡ªå·±æ˜¾ç¤ºçš„é‡Šæ”¾ï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾å°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚è¿™ç§ç‰¹ç‚¹å¯¼è‡´C++çš„ä½¿ç”¨æˆæœ¬å¾ˆé«˜ï¼Œä¸ºäº†é™ä½æˆæœ¬ï¼Œå¼•å…¥äº†æ™ºèƒ½æŒ‡é’ˆ<code>unique_ptr</code>å’Œ<code>shared_ptr</code>ã€‚</p>
<h2 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h2><p><code>unique_ptr</code>é‡‡ç”¨çš„æ˜¯ä¼ é€’æ‰€æœ‰æƒçš„æ–¹å¼æ¥æ§åˆ¶å¯¹è±¡çš„é”€æ¯æ—¶æœºã€‚å¦‚å…¶åå­—æ‰€ç¤ºï¼Œå…¶å¯¹è±¡æ˜¯ç‹¬äº«çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m_a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple %d\n&quot;</span>, m_a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">showfunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple func \n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">            m_a = n;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">const</span> Simple&amp; p) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Copy Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Simple</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">unique_test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// unique ptr</span></span><br><span class="line">    <span class="keyword">auto</span> s_ptr = std::<span class="built_in">make_unique</span>&lt;Simple&gt;(<span class="number">1</span>);</span><br><span class="line">    s_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    std::unique_ptr&lt;Simple&gt; s_copy_ptr = std::<span class="built_in">move</span>(s_ptr);</span><br><span class="line">    s_copy_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    <span class="comment">//std::unique_ptr&lt;Simple&gt; s_ptr_2(s_ptr);   // æ— æ³•ç¼–è¯‘é€šè¿‡</span></span><br><span class="line">    <span class="comment">//std::unique_ptr&lt;Simple&gt; s_ptr_2 = s_ptr;  // æ— æ³•ç¼–è¯‘é€šè¿‡</span></span><br><span class="line">    s_ptr-&gt;<span class="built_in">showfunc</span>();</span><br><span class="line">    <span class="comment">//s_ptr-&gt;Show();    // å½“æ‰€æœ‰æƒå˜æ›´åå°±ä¸è¯¥å†ç”¨ä¹‹å‰çš„æŒ‡é’ˆè®¿é—®å¯¹è±¡èµ„æºã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>unique_ptr</code>ç¦ç”¨æ‹·è´æ„é€ <br>  ç”±äº<code>unique_ptr</code>ç¦ç”¨äº†æ‹·è´æ„é€ å‡½æ•°<code>unique_ptr(const unique_ptr&amp;) = delete;</code>ï¼Œæ‰€ä»¥ä¸€åˆ‡è¯•å›¾è§¦å‘æ‹·è´æ„é€ å‡½æ•°çš„æ“ä½œéƒ½ä¼šå¼•å‘ç¼–è¯‘é”™è¯¯ã€‚</li>
<li><code>unique_ptr</code>æ‰€æœ‰æƒä¸€æ—¦å˜æ›´å°±ä¸èƒ½ä½¿ç”¨åŸæŒ‡é’ˆè®¿é—®å¯¹è±¡èµ„æº<br>  ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸¤å¤„ä½¿ç”¨äº†åŸæŒ‡é’ˆè®¿é—®å¯¹è±¡èµ„æºï¼Œç¬¬ä¸€å¤„<code>s_ptr-&gt;showfunc();</code>æ²¡æœ‰æŠ¥é”™ï¼Œå¯ä»¥æ­£å¸¸æ‰“å°ï¼›<code>s_ptr-&gt;Show();</code>ä¸­ä½¿ç”¨åˆ°äº†æˆå‘˜å˜é‡<code>m_a</code>æ‰€ä»¥ä¼šå¯¼è‡´æŠ¥é”™â€œ<code>this</code>ç©ºæŒ‡é’ˆâ€ã€‚è¿™æ˜¯ç”±äº<code>std::move</code>çš„èµ‹å€¼æ“ä½œè§¦å‘äº†<code>unique_ptr</code>ä¸­çš„Moveæ„é€ å‡½æ•°(<code>unique_ptr(unique_ptr&amp;&amp;) = default;</code>)ï¼Œä»è€Œå°†<code>s_ptr</code>ä¸­çš„æˆå‘˜æ¸…ç©ºã€‚æ‰€ä»¥å†æ¬¡è®¿é—®åŸå¯¹è±¡æŒ‡é’ˆï¼Œå°±ä¼šå‡ºé”™ã€‚</li>
</ul>
<h2 id="shared-ptr"><a href="#shared-ptr" class="headerlink" title="shared_ptr"></a>shared_ptr</h2><p><img src="/images/cpp/shared_ptr.png" alt="shared_ptr"></p>
<p><code>shared_ptr</code>é‡‡ç”¨çš„æ˜¯å¼•ç”¨è®¡æ•°çš„æœºåˆ¶æ¥æ§åˆ¶å¯¹è±¡çš„é”€æ¯æ—¶æœºã€‚å¦‚å…¶åå­—æ‰€ç¤ºï¼Œå…¶å¯¹è±¡æ˜¯å…±äº«çš„ã€‚å½“è®¡æ•°å™¨ç­‰äº0æ˜¯ï¼Œè°ƒç”¨å¯¹è±¡çš„ææ„å‡½æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test_inner</span><span class="params">(std::shared_ptr&lt;Simple&gt; *steal_ptr)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// share ptr</span></span><br><span class="line">    <span class="keyword">auto</span> s_ptr = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">1</span>);</span><br><span class="line">    s_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    <span class="function">std::shared_ptr&lt;Simple&gt; <span class="title">s_copy_ptr</span><span class="params">(s_ptr)</span></span>;</span><br><span class="line">    s_copy_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    std::shared_ptr&lt;Simple&gt; s_ptr_2 = s_ptr;</span><br><span class="line">    s_ptr_2-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    <span class="comment">// try steal</span></span><br><span class="line">    *steal_ptr = s_ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">shared_test_leak</span>();</span><br><span class="line">    std::shared_ptr&lt;Simple&gt; s_ptr;</span><br><span class="line">    <span class="built_in">shared_test_inner</span>(&amp;s_ptr);</span><br><span class="line">    s_ptr-&gt;<span class="built_in">Show</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°½å¯èƒ½ä½¿ç”¨<code>make_shared</code>åˆ›å»º<code>shared_ptr</code>ï¼Œå¦‚æœä½¿ç”¨<code>std::shared_ptr&lt;Simple&gt; s_ptr(new Simple(1))</code>åˆ›å»º<code>shared_ptr</code>ï¼Œéœ€è¦åˆ†é…ä¸¤æ¬¡å†…å­˜ï¼Œä¸€æ¬¡æ˜¯<code>new Simple(1)</code>ï¼›å¦ä¸€æ¬¡æ˜¯<code>shared_ptr</code>çš„å¼•ç”¨è®¡æ•°ã€‚<code>make_shared</code>åªåˆ†é…ä¸€æ¬¡ã€‚</p>
<p>ç°åœ¨åˆ›å»ºä¸€ä¸ª<code>SimpleBack</code>ç±»ï¼Œç„¶åå†è®©<code>Simple</code>å’Œ<code>SimpleBack</code>å¾ªç¯å¼•ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m_a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple %d\n&quot;</span>, m_a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">showfunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple func \n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">            m_a = n;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">const</span> Simple&amp; p) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Copy Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Simple</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        std::shared_ptr&lt;SimpleBack&gt; m_sb;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        std::shared_ptr&lt;Simple&gt; m_s;</span><br><span class="line">        ~<span class="built_in">SimpleBack</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;SimpleBack Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> s = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">auto</span> sb = std::<span class="built_in">make_shared</span>&lt;SimpleBack&gt;();</span><br><span class="line"></span><br><span class="line">    s-&gt;m_sb = sb;</span><br><span class="line">    sb-&gt;m_s = s;</span><br><span class="line">    <span class="comment">// é€šè¿‡æ‰“å°è¯­å¥å¯ä»¥çœ‹åˆ° så’Œsbçš„ææ„å‡½æ•°å¹¶æ²¡æœ‰è°ƒç”¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ææ„å‡½æ•°å‡½æ•°çš„æ‰“å°è¯­å¥å¯ä»¥çœ‹å‡º<code>s</code>å’Œ<code>sb</code>å¹¶æ²¡æœ‰è¢«ææ„ï¼Œè¿™è¯´æ˜<code>s</code>å’Œ<code>sb</code>æ³„æ¼äº†ã€‚</p>
<p>ä¸ºäº†è§£å†³<code>shared_ptr</code>åœ¨å¾ªç¯ä¾èµ–ä¸­å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ¨å‡ºäº†<code>weak_ptr</code>ã€‚</p>
<h2 id="weak-ptr"><a href="#weak-ptr" class="headerlink" title="weak_ptr"></a>weak_ptr</h2><p><code>weak_ptr</code>ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¸èƒ½ç›´æ¥æ“ä½œå¯¹è±¡çš„å†…å­˜ï¼ˆéœ€è¦å…ˆè°ƒç”¨<code>lock</code>æ¥å£ï¼‰ï¼Œéœ€è¦å’Œ<code>shared_ptr</code>é…å¥—ä½¿ç”¨ã€‚</p>
<p>å°†ä¸Šè¿°ä»£ç æ”¹æˆè¿™æ ·ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m_a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple %d\n&quot;</span>, m_a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">showfunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hello Simple func \n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">            m_a = n;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Simple</span>(<span class="type">const</span> Simple&amp; p) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Copy Construct\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">Simple</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Simple Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        std::shared_ptr&lt;SimpleBack&gt; m_sb;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleBack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// å°†å¾ªç¯å¼•ç”¨çš„å…¶ä¸­ä¸€ä¸ªæ”¹æˆweak_ptr</span></span><br><span class="line">        std::weak_ptr&lt;Simple&gt; m_s;</span><br><span class="line">        ~<span class="built_in">SimpleBack</span>() &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;SimpleBack Destroy\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shared_test_leak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> s = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">auto</span> sb = std::<span class="built_in">make_shared</span>&lt;SimpleBack&gt;();</span><br><span class="line"></span><br><span class="line">    s-&gt;m_sb = sb;</span><br><span class="line">    sb-&gt;m_s = s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ææ„å‡½æ•°çš„æ‰“å°è¯­å¥å¯ä»¥çœ‹å‡ºï¼Œ<code>s</code>å’Œ<code>sb</code>çš„ææ„å‡½æ•°åœ¨<code>shared_test_lead()</code>è°ƒç”¨ç»“æŸåè¢«è°ƒç”¨ã€‚</p>
<p>é‚£ä¹ˆï¼Œ<code>weak_ptr</code>çš„ä½¿ç”¨æ˜¯ä¸æ˜¯ä¹Ÿåƒ<code>shared_ptr</code>ä¸€æ ·å‘¢ï¼Ÿä¸æ˜¯çš„ã€‚<code>weak_ptr</code>éœ€è¦ä¸<code>shared_ptr</code>é…åˆä½¿ç”¨ï¼Œçœ‹ä¸€ä¸ªä¾‹å­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">weak_test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::weak_ptr&lt;Simple&gt; w;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> s = std::<span class="built_in">make_shared</span>&lt;Simple&gt;(<span class="number">3</span>);</span><br><span class="line">        w = s;</span><br><span class="line">        <span class="keyword">auto</span> s2 = w.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">if</span>(s2 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            s2-&gt;<span class="built_in">Show</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(w.<span class="built_in">expired</span>()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;object &#x27;s&#x27; is destroied. \n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>lock</code><br>  è‹¥å¯¹è±¡å·²è¢«ææ„ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„<code>shared_ptr</code>ï¼›å¦åˆ™è¿”å›å®é™…çš„<code>shared_ptr</code>ã€‚</li>
<li><code>expired</code><br>  è‹¥å¯¹è±¡å·²è¢«ææ„ï¼Œåˆ™è¿”å›<code>true</code>ï¼›å¦åˆ™è¿”å›<code>false</code></li>
</ul>
<h1 id="å‚è€ƒ-é¸£è°¢"><a href="#å‚è€ƒ-é¸£è°¢" class="headerlink" title="å‚è€ƒ&amp;é¸£è°¢"></a>å‚è€ƒ&amp;é¸£è°¢</h1><ul>
<li><a target="_blank" rel="noopener" href="http://senlinzhan.github.io/2015/04/24/%E6%B7%B1%E5%85%A5shared-ptr/">è°ˆè°ˆ shared_ptr çš„é‚£äº›å‘</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cb3e574eee5f">æ™ºèƒ½æŒ‡é’ˆçš„çº¿ç¨‹å®‰å…¨</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qingdujun/article/details/74858071">C++14 æ™ºèƒ½æŒ‡é’ˆunique_ptrã€shared_ptrã€weak_ptr</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Solstice/archive/2013/01/28/2879366.html">ä¸ºä»€ä¹ˆå¤šçº¿ç¨‹è¯»å†™ shared_ptr è¦åŠ é”ï¼Ÿ</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/12/design/pattern/design-structural-patterns/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/12/design/pattern/design-structural-patterns/" class="post-title-link" itemprop="url">è®¾è®¡æ¨¡å¼â€”â€”ç»“æ„å‹æ¨¡å¼</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-12 14:28:28" itemprop="dateCreated datePublished" datetime="2021-09-12T14:28:28+08:00">2021-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/design/" itemprop="url" rel="index"><span itemprop="name">design</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä¹¦æ¥ä¸Šæ–‡â€œ<a href="https://zhoubofsy.github.io/2021/09/10/design/pattern/design-pattern-creating/">è®¾è®¡æ¨¡å¼â€”â€”åˆ›å»ºå‹æ¨¡å¼</a>â€ï¼Œä¸Šå›è¯´åˆ°å‰äººåˆ›é€ å‡ºäº†å¾ˆå¤šåˆ›å»ºå‹çš„æ¨¡å¼ï¼Œè¿™å›æˆ‘ä»¬è¯´è¯´ç»“æ„å‹æ¨¡å¼ã€‚å…ˆä»¥æ•™ç§‘ä¹¦å½¢å¼ä»‹ç»ä¸€ä¸‹ã€‚</p>
<p>ç»“æ„å‹æ¨¡å¼(Structural Pattern)æè¿°å¦‚ä½•å°†ç±»æˆ–è€…å¯¹ è±¡ç»“åˆåœ¨ä¸€èµ·å½¢æˆæ›´å¤§çš„ç»“æ„ï¼Œå°±åƒæ­ç§¯æœ¨ï¼Œå¯ä»¥é€šè¿‡ ç®€å•ç§¯æœ¨çš„ç»„åˆå½¢æˆå¤æ‚çš„ã€åŠŸèƒ½æ›´ä¸ºå¼ºå¤§çš„ç»“æ„ã€‚</p>
<ul>
<li>ç±»ç»“æ„å‹æ¨¡å¼<br>  ç±»ç»“æ„å‹æ¨¡å¼å…³å¿ƒç±»çš„ç»„åˆï¼Œç”±å¤šä¸ªç±»å¯ä»¥ç»„åˆæˆä¸€ä¸ªæ›´å¤§çš„ç³»ç»Ÿï¼Œåœ¨ç±»ç»“æ„å‹æ¨¡å¼ä¸­ä¸€èˆ¬åªå­˜åœ¨ç»§æ‰¿å…³ç³»å’Œå®ç°å…³ç³»ã€‚</li>
<li>å¯¹è±¡ç»“æ„å‹æ¨¡å¼<br>  ç±»ä¸å¯¹è±¡çš„ç»„åˆï¼Œé€šè¿‡å…³è”å…³ç³»ä½¿å¾—åœ¨ä¸€ ä¸ªç±»ä¸­å®šä¹‰å¦ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡ï¼Œç„¶åé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨å…¶æ–¹æ³•ã€‚</li>
</ul>
<p>æ ¹æ®â€œåˆæˆå¤ç”¨åŸåˆ™â€ï¼Œåœ¨ç³»ç»Ÿä¸­å°½é‡ä½¿ç”¨å…³è”å…³ç³»æ¥æ›¿ä»£ç»§ æ‰¿å…³ç³»ï¼Œå› æ­¤å¤§éƒ¨åˆ†ç»“æ„å‹æ¨¡å¼éƒ½æ˜¯å¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚</p>
<p>èƒ½çœ‹å¾—æ‡‚ï¼Œä½†æ˜¯ä¸å¤Ÿç”ŸåŠ¨ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è®©å®ƒç”ŸåŠ¨ã€æ´»æ³¼ä¸€ä¸‹ã€‚</p>
<p>åœ¨å…ƒç¥–ç‹æœèµ›åšå¦å¸å›½çš„ä¸€ä¸ªè¾¹è¿œçŸ¿ä¸šåŸºåœ°ï¼ŒçŸ¿åŒºæçº¯è¿è¾“è½¦å½¢æ€çš„çŸ¿å·¥é’¢é”è¢«å·¥ä½œè°ƒåŠ¨åˆ°äº†è¿™ä¸ªä½äºæŸä¸ªå«æ˜Ÿä¸Šçš„çŸ¿å‚ã€‚æœ¬æ¥ä¸ä¸–æ— äº‰çš„é’¢é”ï¼Œé‡åˆ°äº†ä¸€èµ·ææ€–äº‹ä»¶ï¼Œç”±æ­¤æ”¹å˜äº†ä»–çš„ç«ç§ï¼ˆå¿ƒçµï¼‰å˜å½¢å½¢æ€ï¼ˆè‚‰ä½“ï¼‰äººç”Ÿè½¨è¿¹ï¼ˆå‘½è¿ï¼‰ã€‚ä»–å°±æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’å˜å½¢é‡‘åˆšã€‚å˜å½¢é‡‘åˆšåˆ†ä¸ºä¸¤æ´¾ï¼Œä¸€ä¸ºåšæ´¾ï¼ˆAutobotsï¼‰ï¼Œä¸€ä¸ºç‹‚æ´¾ï¼ˆDecepticonsï¼‰ï¼ŒäºŒè€…éƒ½æœ‰å˜å½¢çš„èƒ½åŠ›ã€‚</p>
<p>è®©æˆ‘ä»¬æŠ½è±¡ä¸€ä¸‹ï¼Œæ˜¯å¦å¯ä»¥å°†<code>Transforms</code>çš„å˜å½¢èƒ½åŠ›æŠ½åŒ–å‡ºæ¥ï¼Œç„¶åå†è®©åšæ´¾å’Œç‹‚æ´¾åˆ†åˆ«å»å®ç°è‡ªå·±çš„å˜å½¢æ–¹æ³•ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Autobot</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">AutobotsTransform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Autobots Transform, Please...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerAdapter</span> : <span class="keyword">public</span> Transformer &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        Autobot *m_a;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">TransformerAdapter</span>(Autobot *a) &#123;</span><br><span class="line">            m_a = a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">transform</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯â€œé€‚é…å™¨æ¨¡å¼â€</p>
<hr>
<h2 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h2><p>å†æ•™ç§‘ä¹¦ä¸€ä¸‹ã€‚ã€‚ã€‚</p>
<p><img src="/images/patterns/adapter_1.jpg" alt="adapter_1"></p>
<p><img src="/images/patterns/adapter_2.jpg" alt="adapter_2"></p>
<hr>
<p>åˆšåˆšæ”¶åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œè¦ä¸ºæ¯ä¸€ä¸ªå˜å½¢é‡‘åˆšåšä¸€ä¸ªè‡ªå·±ç‹¬æœ‰çš„å˜å½¢ç‰¹æ•ˆï¼Œè€Œä¸”åœ¨å˜å½¢çš„è¿‡ç¨‹ä¸­è¦åŠ å…¥èƒŒæ™¯éŸ³ä¹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„â€œé€‚é…å™¨â€è®¾è®¡æ¨¡å¼ï¼Œå¢åŠ ä¸€å±‚èƒŒæ™¯æ•ˆæœå±‚ï¼Œç„¶åå°†èƒŒæ™¯æ•ˆæœä¼ é€’ç»™å˜å½¢é‡‘åˆšï¼Œå½“å˜å½¢é‡‘åˆšå˜å½¢çš„æ—¶å€™å°†æ•ˆæœæ’­æ”¾å‡ºæ¥å°±å¥½äº†ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Background</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Display</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransformBackground</span> : <span class="keyword">public</span> Background &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Display</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ki ka ka ka......\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        Background *bg;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Decepticon</span> : <span class="keyword">public</span> Transformer &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">Decepticon</span>(Background* b) &#123;</span><br><span class="line">            bg = b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            bg-&gt;<span class="built_in">Display</span>();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Decepticon Transform, Please...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯â€œæ¡¥æ¨¡å¼â€</p>
<hr>
<h2 id="æ¡¥æ¨¡å¼"><a href="#æ¡¥æ¨¡å¼" class="headerlink" title="æ¡¥æ¨¡å¼"></a>æ¡¥æ¨¡å¼</h2><p>å†æ•™ç§‘ä¹¦ä¸€ä¸‹ã€‚ã€‚ã€‚</p>
<p><img src="/images/patterns/bridge_1.jpg" alt="bridge_1"></p>
<p>** ä¼˜ç‚¹: **</p>
<ul>
<li>åˆ†ç¦»æŠ½è±¡æ¥å£åŠå…¶å®ç°éƒ¨åˆ†ã€‚</li>
<li>æ¡¥æ¥æ¨¡å¼æé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å……æ€§ï¼Œåœ¨ä¸¤ä¸ªå˜åŒ–ç»´åº¦ä¸­ä»»æ„æ‰©å±•ä¸€ä¸ªç»´åº¦ï¼Œéƒ½ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ç³»ç»Ÿã€‚</li>
<li>å®ç°ç»†èŠ‚å¯¹å®¢æˆ·é€æ˜ï¼Œå¯ä»¥å¯¹ç”¨æˆ·éšè—å®ç°ç»†èŠ‚ã€‚</li>
</ul>
<p><img src="/images/patterns/bridge_2.jpg" alt="bridge_2"></p>
<p>** ç¼ºç‚¹ï¼š**</p>
<ul>
<li>æ¡¥æ¥æ¨¡å¼çš„å¼•å…¥ä¼šå¢åŠ ç³»ç»Ÿçš„ç†è§£ä¸è®¾è®¡éš¾åº¦ï¼Œç”±äºèšåˆå…³è”å…³ç³»å»ºç«‹åœ¨æŠ½è±¡å±‚ï¼Œè¦æ±‚å¼€å‘è€…é’ˆå¯¹æŠ½è±¡è¿›è¡Œè®¾è®¡ä¸ç¼–ç¨‹</li>
<li>æ¡¥æ¥æ¨¡å¼è¦æ±‚æ­£ç¡®è¯†åˆ«å‡ºç³»ç»Ÿä¸­ä¸¤ä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œå› æ­¤å…¶ä½¿ç”¨èŒƒå›´å…·æœ‰ä¸€å®šçš„å±€é™æ€§ã€‚</li>
</ul>
<hr>
<p>åˆæ¥éœ€æ±‚äº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å˜å½¢é‡‘åˆšå¼€å£è¯´è¯ï¼Œä»¥åè¿˜éœ€è¦å˜å½¢é‡‘åˆšä¼šå¼€ç‚®ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œå˜å½¢æ˜¯ä¸€ä¸ªåŸºæœ¬çš„åŠŸèƒ½ï¼Œç„¶åå…ˆå¢åŠ ä¸€ä¸ªè¯´è¯çš„åŠŸèƒ½ï¼Œå¦‚æœæœ‰éœ€è¦ä»¥åè¿˜å¯ä»¥å¢åŠ å¼€ç‚®çš„åŠŸèƒ½ã€‚æ¯å¢åŠ ä¸€ä¸ªåŠŸèƒ½ä¸ä¿®æ”¹ä¹‹å‰çš„ä»£ç ï¼Œå› ä¸ºä¿®æ”¹å·²ç»æµ‹è¯•è¿‡çš„ä»£ç ä¼šç»™ç¨‹åºçš„ç¨³å®šæ€§å¸¦æ¥éšæ‚£ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        Background *bg;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bumblebee</span> : <span class="keyword">public</span> Transformer &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Bumblebee Transform, Please...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerDecorator</span> : <span class="keyword">public</span> Transformer &#123;</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        Transformer* tf;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            tf-&gt;<span class="built_in">transform</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BumblebeeSay</span> : <span class="keyword">public</span> TransformerDecorator &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">BumblebeeSay</span>(Transformer* t) &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;tf = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;wuwuwuwu...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            TransformerDecorator::<span class="built_in">transform</span>();</span><br><span class="line">            <span class="built_in">say</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯â€œè£…é¥°æ¨¡å¼â€</p>
<hr>
<h2 id="è£…é¥°æ¨¡å¼"><a href="#è£…é¥°æ¨¡å¼" class="headerlink" title="è£…é¥°æ¨¡å¼"></a>è£…é¥°æ¨¡å¼</h2><p>å†æ•™ç§‘ä¹¦ä¸€ä¸‹ã€‚ã€‚ã€‚</p>
<p>è£…é¥°æ¨¡å¼(Decorator Pattern) ï¼šåŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡å¢åŠ ä¸€äº›é¢å¤–çš„èŒè´£(Responsibility)ï¼Œå°±å¢åŠ å¯¹è±¡åŠŸèƒ½æ¥è¯´ï¼Œè£…é¥°æ¨¡å¼æ¯”ç”Ÿæˆå­ç±»å®ç°æ›´ä¸ºçµæ´»ã€‚</p>
<p><img src="/images/patterns/decorator_1.jpg" alt="decorator_1"></p>
<ul>
<li>è£…é¥°æ¨¡å¼ä¸ç»§æ‰¿å…³ç³»çš„ç›®çš„éƒ½æ˜¯è¦æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯è£…é¥°æ¨¡å¼å¯ä»¥æä¾›æ¯”ç»§æ‰¿æ›´å¤šçš„çµæ´»æ€§ã€‚</li>
<li>å¯ä»¥é€šè¿‡ä¸€ç§åŠ¨æ€çš„æ–¹å¼æ¥æ‰©å±•ä¸€ä¸ªå¯¹è±¡çš„åŠŸèƒ½ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶å¯ä»¥åœ¨è¿è¡Œæ—¶é€‰æ‹©ä¸åŒçš„è£…é¥°å™¨ï¼Œä»è€Œå®ç°ä¸åŒçš„è¡Œä¸ºã€‚</li>
<li>é€šè¿‡ä½¿ç”¨ä¸åŒçš„å…·ä½“è£…é¥°ç±»ä»¥åŠè¿™äº›è£…é¥°ç±»çš„æ’åˆ—ç»„åˆï¼Œå¯ä»¥åˆ›é€ å‡ºå¾ˆå¤šä¸åŒè¡Œä¸ºçš„ç»„åˆã€‚å¯ä»¥ä½¿ç”¨å¤šä¸ªå…·ä½“è£…é¥°ç±»æ¥è£…é¥°åŒä¸€å¯¹è±¡ï¼Œå¾—åˆ°åŠŸèƒ½æ›´ä¸ºå¼ºå¤§çš„å¯¹è±¡ã€‚</li>
<li>å…·ä½“æ„ä»¶ç±»ä¸å…·ä½“è£…é¥°ç±»å¯ä»¥ç‹¬ç«‹å˜åŒ–ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦å¢åŠ æ–°çš„å…·ä½“æ„ä»¶ç±»å’Œå…·ä½“è£…é¥°ç±»ï¼Œåœ¨ä½¿ç”¨æ—¶å†å¯¹å…¶è¿›è¡Œç»„åˆï¼ŒåŸæœ‰ä»£ç æ— é¡»æ”¹å˜ï¼Œç¬¦åˆâ€œå¼€é—­åŸåˆ™â€</li>
</ul>
<p><img src="/images/patterns/decorator_2.jpg" alt="decorator_2"></p>
<ul>
<li>è¿™ç§æ¯”ç»§æ‰¿æ›´åŠ çµæ´»æœºåŠ¨çš„ç‰¹æ€§ï¼Œä¹ŸåŒæ—¶æ„å‘³ç€è£…é¥°æ¨¡å¼æ¯”ç»§æ‰¿æ›´åŠ æ˜“äºå‡ºé”™ï¼Œæ’é”™ä¹Ÿå¾ˆå›°éš¾ï¼Œå¯¹äºå¤šæ¬¡è£…é¥°çš„å¯¹è±¡ï¼Œè°ƒè¯•æ—¶å¯»æ‰¾é”™è¯¯å¯èƒ½éœ€è¦é€çº§æ’æŸ¥ï¼Œè¾ƒä¸ºçƒ¦çã€‚</li>
</ul>
<hr>
<p>æˆ˜äº‰ä¸€è§¦å³å‘ï¼Œä¸ºäº†å–å¾—èƒœåˆ©ï¼Œæˆ‘ä»¬éœ€è¦å¿«é€Ÿçš„ç”Ÿäº§å˜å½¢é‡‘åˆšï¼Œéœ€è¦å¼„ä¸€ä¸ªmapï¼Œå­˜å‚¨å·²ç»åˆ›å»ºå¥½çš„ï¼Œå½“æœ‰æˆ˜äº‹å‘ç”Ÿæ—¶ï¼Œä»mapé‡Œç›´æ¥å–å‡ºè¿›è¡Œæˆ˜æ–—ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        Background *bg;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bumblebee</span> : <span class="keyword">public</span> Transformer &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Bumblebee Transform, Please...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerFlyweight</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        std::map&lt;std::string,Transformer*&gt; members;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Transformer* <span class="title">get</span><span class="params">(std::string key)</span></span>&#123;</span><br><span class="line">            Transformer* tf = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="keyword">auto</span> search = members.<span class="built_in">find</span>(key);</span><br><span class="line">            <span class="keyword">if</span>(search != members.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                tf = search-&gt;second;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// new</span></span><br><span class="line">                tf = <span class="keyword">new</span> <span class="built_in">Bumblebee</span>();</span><br><span class="line">                members.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(key, tf));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tf;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯â€œäº«å…ƒæ¨¡å¼â€</p>
<hr>
<h2 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h2><p>å†æ•™ç§‘ä¹¦ä¸€ä¸‹ã€‚ã€‚ã€‚</p>
<p>äº«å…ƒæ¨¡å¼æ˜¯ä¸€ä¸ªè€ƒè™‘ç³»ç»Ÿæ€§èƒ½çš„è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡ä½¿ç”¨äº«å…ƒæ¨¡å¼å¯ä»¥èŠ‚çº¦å†…å­˜ç©ºé—´ï¼Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚è¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚ç³»ç»Ÿåªä½¿ç”¨å°‘é‡çš„å¯¹è±¡ï¼Œè€Œè¿™äº›å¯¹è±¡éƒ½å¾ˆç›¸ä¼¼ï¼ŒçŠ¶æ€å˜åŒ–å¾ˆå°ï¼Œå¯ä»¥å®ç°å¯¹è±¡çš„å¤šæ¬¡å¤ç”¨ã€‚ç”±äºäº«å…ƒæ¨¡å¼è¦æ±‚èƒ½å¤Ÿå…±äº«çš„å¯¹è±¡å¿…é¡»æ˜¯ç»†ç²’åº¦å¯¹è±¡ï¼Œå› æ­¤å®ƒåˆç§°ä¸ºè½»é‡çº§æ¨¡å¼ï¼Œå®ƒæ˜¯ä¸€ç§å¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚</p>
<p><img src="/images/patterns/flyweight_1.jpg" alt="flyweight_1"></p>
<p>** ä¼˜ç‚¹ **</p>
<ul>
<li>äº«å…ƒæ¨¡å¼çš„ä¼˜ç‚¹åœ¨äºå®ƒå¯ä»¥æå¤§å‡å°‘å†…å­˜ä¸­å¯¹è±¡çš„æ•°é‡ï¼Œä½¿å¾—ç›¸åŒå¯¹è±¡æˆ–ç›¸ä¼¼å¯¹è±¡åœ¨å†…å­˜ä¸­åªä¿å­˜ä¸€ä»½ã€‚</li>
<li>äº«å…ƒæ¨¡å¼çš„å¤–éƒ¨çŠ¶æ€ç›¸å¯¹ç‹¬ç«‹ï¼Œè€Œä¸”ä¸ä¼šå½±å“å…¶å†…éƒ¨çŠ¶æ€ï¼Œä»è€Œä½¿å¾—äº«å…ƒå¯¹è±¡å¯ä»¥åœ¨ä¸åŒçš„ç¯å¢ƒä¸­è¢«å…±äº«ã€‚</li>
</ul>
<p><img src="/images/patterns/flyweight_2.jpg" alt="flyweight_2"></p>
<p>** ç¼ºç‚¹ **</p>
<ul>
<li>äº«å…ƒæ¨¡å¼ä½¿å¾—ç³»ç»Ÿæ›´åŠ å¤æ‚ï¼Œéœ€è¦åˆ†ç¦»å‡ºå†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€ï¼Œè¿™ä½¿å¾—ç¨‹åºçš„é€»è¾‘å¤æ‚åŒ–ã€‚</li>
</ul>
<hr>
<p>å˜å½¢é‡‘åˆšå‡ºäº†ä¸ªBugï¼Œè‹¥åœ¨æ¯æ¬¡å˜å½¢è¿‡ç¨‹ä¸­æ”¶åˆ°æ”»å‡»ï¼Œå˜å½¢é‡‘åˆšå°†æ¯«æ— é˜²å¾¡èƒ½åŠ›ã€‚æ‰€ä»¥éœ€è¦å¢åŠ ä¸€ä¸ªé˜²æŠ¤ç½©ï¼Œåœ¨å˜å½¢å‰å¼€å¯ï¼Œåœ¨å˜å½¢åå…³é—­ï¼Œè¿™æ ·å¢åŠ å˜å½¢é‡‘åˆšçš„å˜å½¢è¿‡ç¨‹ä¸­çš„é˜²å¾¡èƒ½åŠ›ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">        Background *bg;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bumblebee</span> : <span class="keyword">public</span> Transformer &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Bumblebee Transform, Please...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerProxy</span> : <span class="keyword">public</span> Transformer &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        Transformer *m_tf;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">save_on</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;saving...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">save_off</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;save done\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">TransformerProxy</span>(Transformer *tf) &#123;</span><br><span class="line">            m_tf = tf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">transform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="built_in">save_on</span>();</span><br><span class="line">            m_tf-&gt;<span class="built_in">transform</span>();</span><br><span class="line">            <span class="built_in">save_off</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯â€œä»£ç†æ¨¡å¼â€</p>
<hr>
<h2 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h2><p><img src="/images/patterns/proxy_1.jpg" alt="proxy_1"></p>
<p>** ä¼˜ç‚¹ **</p>
<ul>
<li>ä»£ç†æ¨¡å¼èƒ½å¤Ÿåè°ƒè°ƒç”¨è€…å’Œè¢«è°ƒç”¨è€…ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†ç³» ç»Ÿçš„è€¦åˆåº¦ã€‚</li>
<li>è¿œç¨‹ä»£ç†ä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥è®¿é—®åœ¨è¿œç¨‹æœºå™¨ä¸Šçš„å¯¹è±¡ï¼Œè¿œç¨‹æœºå™¨ å¯èƒ½å…·æœ‰æ›´å¥½çš„è®¡ç®—æ€§èƒ½ä¸å¤„ç†é€Ÿåº¦ï¼Œå¯ä»¥å¿«é€Ÿå“åº”å¹¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li>
<li>è™šæ‹Ÿä»£ç†é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå°å¯¹è±¡æ¥ä»£è¡¨ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œå¯ä»¥å‡å°‘ç³» ç»Ÿèµ„æºçš„æ¶ˆè€—ï¼Œå¯¹ç³»ç»Ÿè¿›è¡Œä¼˜åŒ–å¹¶æé«˜è¿è¡Œé€Ÿåº¦ã€‚</li>
<li>ä¿æŠ¤ä»£ç†å¯ä»¥æ§åˆ¶å¯¹çœŸå®å¯¹è±¡çš„ä½¿ç”¨æƒé™ã€‚</li>
</ul>
<p><img src="/images/patterns/proxy_2.jpg" alt="proxy_2"></p>
<p>** ç¼ºç‚¹ **</p>
<ul>
<li>ç”±äºåœ¨å®¢æˆ·ç«¯å’ŒçœŸå®ä¸»é¢˜ä¹‹é—´å¢åŠ äº†ä»£ç†å¯¹è±¡ï¼Œå› æ­¤ æœ‰äº›ç±»å‹çš„ä»£ç†æ¨¡å¼å¯èƒ½ä¼šé€ æˆè¯·æ±‚çš„å¤„ç†é€Ÿåº¦å˜æ…¢ã€‚</li>
<li>å®ç°ä»£ç†æ¨¡å¼éœ€è¦é¢å¤–çš„å·¥ä½œï¼Œæœ‰äº›ä»£ç†æ¨¡å¼çš„å®ç° éå¸¸å¤æ‚ã€‚</li>
</ul>
<hr>
<h1 id="å‚è€ƒ-é¸£è°¢"><a href="#å‚è€ƒ-é¸£è°¢" class="headerlink" title="å‚è€ƒ&amp;é¸£è°¢"></a>å‚è€ƒ&amp;é¸£è°¢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://design-patterns.readthedocs.io/zh_CN/latest/structural_patterns/structural.html">ç»“æ„å‹æ¨¡å¼</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2021/09/10/design/pattern/design-pattern-creating/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/10/design/pattern/design-pattern-creating/" class="post-title-link" itemprop="url">è®¾è®¡æ¨¡å¼â€”â€”åˆ›å»ºå‹æ¨¡å¼</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-10 11:01:23" itemprop="dateCreated datePublished" datetime="2021-09-10T11:01:23+08:00">2021-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/design/" itemprop="url" rel="index"><span itemprop="name">design</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è®¾è®¡æ¨¡å¼æ˜¯å‰äººåœ¨å·¥ä½œæ€»ç»“å‡ºæ¥çš„ä¸€äº›è®¾è®¡ç»éªŒã€‚åäººä½¿ç”¨è¿™äº›ç»éªŒè¿›è¡Œè®¾è®¡å¼€å‘ï¼Œå¯ä»¥å‡å°‘è®¾è®¡ç¼ºé™·ã€‚å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼æœ‰23ä¸ªï¼Œè¿™23ä¸ªè®¾è®¡æ¨¡å¼åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯â€œåˆ›å»ºå‹æ¨¡å¼â€ã€â€œ<a href="">è¡Œä¸ºå‹æ¨¡å¼</a>â€ã€â€œ<a href="">ç»“æ„å‹æ¨¡å¼</a>â€ã€‚</p>
<h1 id="åˆ›å»ºå‹æ¨¡å¼"><a href="#åˆ›å»ºå‹æ¨¡å¼" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼"></a>åˆ›å»ºå‹æ¨¡å¼</h1><p>é¡¾åæ€ä¹‰ï¼Œç”¨æ¥åˆ›å»ºç”Ÿæˆå¯¹è±¡çš„è®¾è®¡æ¨¡å¼ã€‚åˆ›å»ºå‹æ¨¡å¼åŒ…æ‹¬ï¼šâ€œå•ä¾‹æ¨¡å¼â€ã€â€œå·¥å‚æ¨¡å¼â€å’Œâ€œæ„å»ºè€…æ¨¡å¼â€ï¼Œå…¶ä¸­å·¥å‚æ¨¡å¼åˆåˆ†ä¸ºâ€œç®€å•å·¥å‚æ¨¡å¼â€ã€â€œå·¥å‚æ–¹æ³•æ¨¡å¼â€å’Œâ€œæŠ½è±¡å·¥å‚æ¨¡å¼â€ã€‚</p>
<p>æ•…äº‹æ˜¯è¿™æ ·å¼€å§‹çš„â€¦â€¦</p>
<p>åœ¨å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œæœ‰ä¸ª<code>Product</code>ä»–æ˜¯è¿™æ ·å®šä¹‰çš„</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ProductA</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é‚£æ—¶å€™è¿˜æ²¡æœ‰è®¾è®¡æ¨¡å¼ï¼Œäººä»¬åˆ›å»ºå¯¹è±¡ä¸€èˆ¬éƒ½æ˜¯ç”¨<code>new</code>åœ¨å †ä¸Šåˆ†é…æˆ–è€…ç›´æ¥åœ¨æ ˆä¸Šå®šä¹‰ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ProductA *p = <span class="keyword">new</span> <span class="built_in">ProductA</span>();</span><br><span class="line">    p-&gt;<span class="built_in">Show</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åæ¥ï¼Œä½¿ç”¨è¿™ä¸ª<code>Product</code>å¯¹è±¡çš„äººè¶Šæ¥è¶Šå¤šï¼Œæ¯ä¸ªäººéƒ½æƒ³newä¸€ä¸‹ï¼Œè€Œä¸”<code>Product</code>åˆä¸æƒ³è¢«é¢‘ç¹çš„newï¼Œäºæ˜¯å‰äººæƒ³äº†ä¸ªåŠæ³•å°†<code>Product</code>çš„å¯¹è±¡å®šä¹‰ä¸ºä¸€ä¸ª<code>static</code>çš„å˜é‡ï¼Œç„¶åæ¯æ¬¡åœ¨<code>new</code>ä¹‹å‰åˆ¤æ–­ä¸€ä¸‹ï¼Œçœ‹æ˜¯å¦éœ€è¦<code>new</code>ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SingleInstance</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">static</span> ProductA *m_p;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">static</span> ProductA* <span class="title">CreateProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(m_p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                m_p = <span class="keyword">new</span> <span class="built_in">ProductA</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> m_p;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯â€œå•ä¾‹æ¨¡å¼â€ã€‚</p>
<hr>
<h2 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h2><ul>
<li>æŸä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹</li>
<li>å®ƒå¿…é¡»è‡ªè¡Œåˆ›å»ºè¿™ä¸ªå®ä¾‹</li>
<li>å®ƒå¿…é¡»è‡ªè¡Œå‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹</li>
</ul>
<p><img src="/images/patterns/single_1.jpg" alt="single_1"></p>
<ul>
<li>å•ä¾‹ç±»çš„æ„é€ å‡½æ•°ä¸ºç§æœ‰</li>
<li>æä¾›ä¸€ä¸ªè‡ªèº«çš„é™æ€ç§æœ‰æˆå‘˜å˜é‡</li>
<li>æä¾›ä¸€ä¸ªå…¬æœ‰çš„é™æ€å·¥å‚æ–¹æ³•</li>
</ul>
<p><img src="/images/patterns/single_2.jpg" alt="single_2"></p>
<hr>
<p>åæ¥ï¼Œå‰äººåˆå¼€å‘äº†<code>ProductB</code>ï¼Œ<code>ProductA</code>å’Œ<code>ProductB</code>åŒå±äº<code>Product</code>ï¼Œäºæ˜¯æˆ‘ä»¬çš„productå˜æˆäº†è¿™æ ·</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Show</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductA</span> : <span class="keyword">public</span> Product &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductB</span> : <span class="keyword">public</span> Product &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ–¹ä¾¿åˆ›å»ºå¯¹è±¡ï¼Œå‰äººå†³å®šç”¨<code>&quot;PA&quot;</code>ä»£è¡¨<code>ProductA</code>ã€<code>&quot;PB&quot;</code>ä»£è¡¨<code>ProductB</code>ï¼Œå†åˆ›å»ºä¸€ä¸ªå·¥å‚ï¼Œç”¨æ¥åˆ›å»ºå¯¹è±¡ï¼Œåœ¨åˆ›å»ºå¯¹è±¡æ—¶å€™æŒ‡å®š<code>PA</code> æˆ–è€…<code>PB</code>ï¼Œå·¥å‚æ ¹æ®æŒ‡å®šçš„å†…å®¹æ¥å†³å®šæ˜¯åˆ›å»º<code>ProductA</code>è¿˜æ˜¯<code>ProductB</code>ã€‚</p>
<p>Exampleï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">PD_TYPE</span> &#123;</span><br><span class="line">    PA,</span><br><span class="line">    PB</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Product* <span class="title">CreateProduct</span><span class="params">(PD_TYPE pt)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">SimpleFactory::CreateProduct</span><span class="params">(PD_TYPE pt)</span></span>&#123;</span><br><span class="line">    Product *p = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">switch</span>(pt) &#123;</span><br><span class="line">        <span class="keyword">case</span> PA:</span><br><span class="line">        &#123;</span><br><span class="line">            p = <span class="keyword">new</span> <span class="built_in">ProductA</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> PB:</span><br><span class="line">        &#123;</span><br><span class="line">            p = <span class="keyword">new</span> <span class="built_in">ProductB</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯â€œç®€å•å·¥å‚æ¨¡å¼â€ã€‚</p>
<hr>
<h2 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h2><ul>
<li>æ ¹æ®å‚æ•°çš„ä¸åŒè¿”å›ä¸åŒç±»çš„å®ä¾‹</li>
<li>ç®€å•å·¥å‚æ¨¡å¼ä¸“é—¨å®šä¹‰ä¸€ä¸ªç±»æ¥è´Ÿè´£åˆ›å»ºå…¶ä»–ç±»çš„å®ä¾‹</li>
<li>è¢«åˆ›å»ºçš„å®ä¾‹é€šå¸¸éƒ½å…·æœ‰å…±åŒçš„çˆ¶ç±»</li>
</ul>
<p><img src="/images/patterns/simple_factory_1.jpg" alt="simple_factory_1"></p>
<p><img src="/images/patterns/simple_factory_2.jpg" alt="simple_factory_2"></p>
<hr>
<p>éšç€<code>Product</code>ç§ç±»çš„ä¸æ–­å¢åŠ ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­çš„ä¿®æ”¹<code>SimpleFactory::CreateProduct</code>æ–¹æ³•ï¼Œè¿™æ ·ä¼šå¢åŠ <code>SimpleFactory::CreateProduct</code>å‡ºé”™çš„é£é™©ï¼Œæ‰€ä»¥å‰äººæŒ‰ç…§ä¸åŒçš„äº§å“åˆ›å»ºäº†ä¸åŒçš„å·¥å‚ï¼Œè¿™æ ·ä»¥ååœ¨å¢åŠ æ–°çš„äº§å“åªéœ€è¦å¢åŠ å¯¹åº”çš„å·¥å‚å°±å¯ä»¥äº†ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MethodFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> Product* <span class="title">CreateProduct</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MethodFactoryPA</span> : <span class="keyword">public</span> MethodFactory &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Product* <span class="title">CreateProduct</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MethodFactoryPB</span> : <span class="keyword">public</span> MethodFactory &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Product* <span class="title">CreateProduct</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">MethodFactoryPA::CreateProduct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ProductA</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">MethodFactoryPB::CreateProduct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ProductB</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯â€œå·¥å‚æ–¹æ³•æ¨¡å¼â€</p>
<hr>
<h2 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h2><p><img src="/images/patterns/method_factory_1.jpg" alt="method_factory_1"></p>
<p>å·¥å‚çˆ¶ç±»è´Ÿè´£å®šä¹‰åˆ›å»ºäº§å“å¯¹è±¡çš„å…¬å…±æ¥å£ï¼Œè€Œå·¥å‚å­ç±»åˆ™è´Ÿè´£ç”Ÿæˆå…·ä½“çš„äº§å“å¯¹è±¡ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯å°†äº§å“ç±»çš„å®ä¾‹åŒ–æ“ä½œå»¶è¿Ÿåˆ°å·¥å‚å­ç±»ä¸­å®Œæˆã€‚</p>
<p><img src="/images/patterns/method_factory_2.jpg" alt="method_factory_2"></p>
<hr>
<p>ä»ç°åœ¨å¼€å§‹æˆ‘ä»¬è¦å°†äº§å“å˜å¤š<code>ProductA1</code>ã€<code>ProductA2</code>ã€<code>ProductB1</code>ã€<code>ProductB2</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ProductA1</span> : <span class="keyword">public</span> Product &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductA2</span> : <span class="keyword">public</span> Product &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductB1</span> : <span class="keyword">public</span> Product &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductB2</span> : <span class="keyword">public</span> Product &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¦æ±‚å·¥å‚ç”Ÿäº§<code>ProductA1</code>æ—¶ï¼Œä¹Ÿè¦ç”Ÿäº§<code>ProductB1</code>ï¼›ç”Ÿäº§<code>ProductA1</code>æ—¶ï¼Œä¹Ÿè¦ç”Ÿäº§<code>ProductB2</code>ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AbstractFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> Product* <span class="title">CreateProductA</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> Product* <span class="title">CreateProductB</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AbstractFactoryOne</span> : <span class="keyword">public</span> AbstractFactory &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Product* <span class="title">CreateProductA</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function">Product* <span class="title">CreateProductB</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AbstractFactoryTwo</span> : <span class="keyword">public</span> AbstractFactory &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Product* <span class="title">CreateProductA</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function">Product* <span class="title">CreateProductB</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">AbstractFactoryOne::CreateProductA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ProductA1</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">AbstractFactoryOne::CreateProductB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ProductB1</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">AbstractFactoryTwo::CreateProductA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ProductA2</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">AbstractFactoryTwo::CreateProductB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ProductB2</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯â€œæŠ½è±¡å·¥å‚æ¨¡å¼â€ã€‚</p>
<hr>
<h2 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h2><p><img src="/images/patterns/abstract_factory_1.jpg" alt="abstract_factory_1"></p>
<p>ä¸å·¥å‚æ–¹æ³•å¾ˆç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå·¥å‚æ–¹æ³•ç”¨äºä¸€ä¸ªäº§å“çš„æ„å»ºï¼ŒæŠ½è±¡å·¥å‚é€‚ç”¨äºå¤šä¸ªäº§å“æ„å»º</p>
<p><img src="/images/patterns/abstract_factory_2.jpg" alt="abstract_factory_2"></p>
<hr>
<p>æŠ½è±¡å·¥å‚æ¨¡å¼å¯ä»¥è®©æˆ‘ä»¬æ‰¹é‡ç”Ÿäº§äº§å“äº†ï¼Œä½†æ˜¯æŠ½è±¡å·¥å‚åªèƒ½ç”Ÿäº§å›ºå®šç§ç±»çš„äº§å“ï¼Œå¦‚æœæˆ‘ä»¬è¦è®©<code>ProductA1</code>ã€<code>ProductA2</code>ã€<code>ProductB1</code>ã€<code>ProductB2</code>éšæ„ç»„åˆï¼Œç”Ÿæˆä¸åŒçš„å¥—é¤ï¼Œç„¶åå†è¿›è¡Œç”Ÿäº§ã€‚å‰äººæƒ³äº†è¿™æ ·ä¸€ä¸ªåŠæ³•ã€‚ã€‚ã€‚</p>
<p>Example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> Product* <span class="title">BuildProduct</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductABuilder</span> : <span class="keyword">public</span> Builder&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Product* <span class="title">BuildProduct</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Director</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        Builder* builder;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">setBuilder</span><span class="params">(Builder* b)</span></span>;</span><br><span class="line">        <span class="function">Product* <span class="title">build</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">ProductABuilder::BuildProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ProductA</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Director::setBuilder</span><span class="params">(Builder* b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;builder = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Product* <span class="title">Director::build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;builder-&gt;<span class="built_in">BuildProduct</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯â€œå»ºé€ è€…æ¨¡å¼â€</p>
<hr>
<h2 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h2><p><img src="/images/patterns/builder_1.jpg" alt="builder_1"></p>
<p><img src="/images/patterns/builder_2.jpg" alt="builder_2"></p>
<p>** To be continue â€¦**</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2020/11/17/storage/spdk-introduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/17/storage/spdk-introduce/" class="post-title-link" itemprop="url">SPDKç®€ä»‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-17 10:17:29" itemprop="dateCreated datePublished" datetime="2020-11-17T10:17:29+08:00">2020-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SPDKï¼ˆStorage Performance Development Kitï¼‰æ˜¯Intelå‘å¸ƒçš„å­˜å‚¨æ€§èƒ½å¼€å‘å·¥å…·é›†</p>
<p>ç”¨æˆ·ä½¿ç”¨ç°åœ¨çš„å›ºæ€è®¾å¤‡ï¼Œæ¯”å¦‚IntelÂ® SSD DC P3700 Series Non-Volatile Memory Expressï¼ˆNVMeï¼‰é©±åŠ¨ï¼Œé¢ä¸´ä¸€ä¸ªä¸»è¦çš„æŒ‘æˆ˜ï¼šå› ä¸ºååé‡å’Œå»¶è¿Ÿæ€§èƒ½æ¯”ä¼ ç»Ÿçš„ç£ç›˜å¥½å¤ªå¤šï¼Œç°åœ¨æ€»çš„å¤„ç†æ—¶é—´ä¸­ï¼Œå­˜å‚¨è½¯ä»¶å ç”¨äº†æ›´å¤§çš„æ¯”ä¾‹ã€‚æ¢å¥è¯è¯´ï¼Œå­˜å‚¨è½¯ä»¶æ ˆçš„æ€§èƒ½å’Œæ•ˆç‡åœ¨æ•´ä¸ªå­˜å‚¨ç³»ç»Ÿä¸­è¶Šæ¥è¶Šé‡è¦ã€‚éšç€å­˜å‚¨è®¾å¤‡ç»§ç»­å‘å±•ï¼Œå®ƒå°†é¢ä¸´è¿œè¿œè¶…è¿‡æ­£åœ¨ä½¿ç”¨çš„è½¯ä»¶ä½“ç³»ç»“æ„çš„é£é™©ï¼ˆå³å­˜å‚¨è®¾å¤‡å—åˆ¶äºç›¸å…³è½¯ä»¶çš„ä¸è¶³è€Œä¸èƒ½å‘æŒ¥å…¨éƒ¨æ€§èƒ½ï¼‰</p>
<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><ul>
<li>ç”¨æˆ·æ€è¿è¡Œ<br>  é¿å…å†…æ ¸ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œä¸­æ–­å°†ä¼šèŠ‚çœå¤§é‡çš„å¤„ç†å¼€é”€ï¼Œå…è®¸æ›´å¤šçš„æ—¶é’Ÿå‘¨æœŸè¢«ç”¨æ¥åšå®é™…çš„æ•°æ®å­˜å‚¨ã€‚æ— è®ºå­˜å‚¨ç®—æ³•ï¼ˆå»å†—ï¼ŒåŠ å¯†ï¼Œå‹ç¼©ï¼Œç©ºç™½å—å­˜å‚¨ï¼‰å¤šä¹ˆå¤æ‚ï¼Œæµªè´¹æ›´å°‘çš„æ—¶é’Ÿå‘¨æœŸæ€»æ˜¯æ„å‘³ç€æ›´å¥½çš„æ€§èƒ½å’Œå»¶è¿Ÿã€‚è¿™å¹¶ä¸æ˜¯è¯´å†…æ ¸å¢åŠ äº†ä¸å¿…è¦çš„å¼€é”€ï¼›ç›¸åï¼Œå†…æ ¸å¢åŠ äº†é‚£äº›å¯èƒ½ä¸é€‚ç”¨äºä¸“ç”¨å­˜å‚¨å †æ ˆçš„é€šç”¨è®¡ç®—ç”¨ä¾‹çš„ç›¸å…³å¼€é”€ã€‚SPDKçš„æŒ‡å¯¼åŸåˆ™æ˜¯é€šè¿‡æ¶ˆé™¤æ¯ä¸€å¤„é¢å¤–çš„è½¯ä»¶å¼€é”€æ¥æä¾›æœ€å°‘çš„å»¶è¿Ÿå’Œæœ€é«˜çš„æ•ˆç‡ã€‚</li>
<li>è½®è¯¢æ¨¡å¼å–ä»£ä¸­æ–­æ¨¡å¼ï¼ˆPolled Mode Drivers, PMDsï¼‰<br>  åœ¨ä¼ ç»Ÿçš„I&#x2F;Oæ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºæäº¤è¯»å†™è¯·æ±‚åç¡çœ ï¼Œä¸€æ—¦I&#x2F;Oå®Œæˆï¼Œä¸­æ–­å°±ä¼šå°†å…¶å”¤é†’ã€‚PMDsçš„å·¥ä½œæ–¹å¼ä¸åŒï¼Œåº”ç”¨ç¨‹åºæäº¤è¯»å†™è¯·æ±‚åç»§ç»­æ‰§è¡Œå…¶ä»–å·¥ä½œï¼Œä»¥ä¸€å®šçš„æ—¶é—´é—´éš”å›å¤´æ£€æŸ¥I&#x2F;Oæ˜¯å¦å·²ç»å®Œæˆã€‚è¿™ç§æ–¹å¼é¿å…äº†ä¸­æ–­å¸¦æ¥çš„å»¶è¿Ÿå’Œå¼€é”€ï¼Œå¹¶ä½¿å¾—åº”ç”¨ç¨‹åºæé«˜äº†I&#x2F;Oçš„æ•ˆç‡ã€‚<br>  åœ¨æœºæ¢°ç›˜æ—¶ä»£ï¼Œä¸­æ–­å¼€é”€åªå æ•´ä¸ªI&#x2F;Oæ—¶é—´çš„ä¸€ä¸ªå¾ˆå°çš„ç™¾åˆ†æ¯”ï¼Œå› æ­¤ç»™ç³»ç»Ÿå¸¦æ¥äº†å·¨å¤§çš„æ•ˆç‡æå‡ã€‚ç„¶è€Œï¼Œåœ¨å›ºæ€è®¾å¤‡çš„æ—¶ä»£ï¼ŒæŒç»­å¼•å…¥æ›´ä½å»¶è¿Ÿçš„æŒä¹…åŒ–è®¾å¤‡ï¼Œä¸­æ–­å¼€é”€æˆä¸ºäº†æ•´ä¸ªI&#x2F;Oæ—¶é—´ä¸­ä¸èƒ½è¢«å¿½è§†çš„éƒ¨åˆ†ã€‚è¿™ä¸ªé—®é¢˜åœ¨æ›´ä½å»¶è¿Ÿçš„è®¾å¤‡ä¸Šåªä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚ç³»ç»Ÿå·²ç»èƒ½å¤Ÿæ¯ç§’å¤„ç†æ•°ç™¾ä¸‡ä¸ªI&#x2F;Oï¼Œæ‰€ä»¥æ¶ˆé™¤æ•°ç™¾ä¸‡ä¸ªäº‹åŠ¡çš„è¿™ç§å¼€é”€ï¼Œèƒ½å¤Ÿå¿«é€Ÿåœ°å¤åˆ¶åˆ°å¤šä¸ªå†…æ ¸ä¸­ã€‚æ•°æ®åŒ…å’Œæ•°æ®å—è¢«ç«‹å³åˆ†å‘ï¼Œç­‰å¾…æ—¶é—´å‡å°åˆ°æœ€å°‘ï¼Œä½¿å¾—å»¶è¿Ÿæ›´ä½ï¼Œä¸€è‡´æ€§å»¶è¿Ÿæ›´å¤šï¼ˆæŠ–åŠ¨æ›´å°‘ï¼‰ï¼Œååé‡ä¹Ÿå¾—åˆ°æé«˜ã€‚</li>
<li>æ— é”æœºåˆ¶<br>  åœ¨IOè·¯å¾„ä¸Šé¿å…é‡‡ç”¨ä»»ä½•é”æœºåˆ¶è¿›è¡ŒåŒæ­¥ï¼Œé™ä½æ—¶å»¶å¹¶æå‡ååé‡</li>
</ul>
<h1 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h1><p><img src="/images/spdk/introduction-to-the-storage-performance-development-kit-spdk-fig2.png" alt="introduction-to-the-storage-performance-development-kit-spdk-fig2"></p>
<h3 id="Hardware-Drivers"><a href="#Hardware-Drivers" class="headerlink" title="Hardware Drivers"></a>Hardware Drivers</h3><h4 id="NVMe-Driver"><a href="#NVMe-Driver" class="headerlink" title="NVMe Driver"></a>NVMe Driver</h4><p>SPDKçš„åŸºç¡€ç»„ä»¶ï¼Œè¿™ä¸ªé«˜ä¼˜åŒ–æ— é”çš„é©±åŠ¨æä¾›äº†é«˜æ‰©å±•æ€§ï¼Œé«˜æ•ˆæ€§å’Œé«˜æ€§èƒ½ã€‚</p>
<h4 id="Inter-QuickData-Technology"><a href="#Inter-QuickData-Technology" class="headerlink" title="Inter QuickData Technology"></a>Inter QuickData Technology</h4><p>Intel I&#x2F;O Acceleration Technologyï¼ˆInter IOATï¼Œè‹±ç‰¹å°”I&#x2F;OåŠ é€ŸæŠ€æœ¯ï¼‰ï¼Œè¿™æ˜¯ä¸€ç§åŸºäºXeonå¤„ç†å™¨å¹³å°ä¸Šçš„copy offloadå¼•æ“ã€‚é€šè¿‡æä¾›ç”¨æˆ·ç©ºé—´è®¿é—®ï¼Œå‡å°‘äº†DMAæ•°æ®ç§»åŠ¨çš„é˜ˆå€¼ï¼Œå…è®¸å¯¹å°å°ºå¯¸I&#x2F;Oæˆ–NTBçš„æ›´å¥½åˆ©ç”¨ã€‚</p>
<h3 id="Back-end-Block-Devices"><a href="#Back-end-Block-Devices" class="headerlink" title="Back-end Block Devices"></a>Back-end Block Devices</h3><h4 id="NVMe-oF-Initiator"><a href="#NVMe-oF-Initiator" class="headerlink" title="NVMe-oF Initiator"></a>NVMe-oF Initiator</h4><p>æœ¬åœ°SPDK NVMeé©±åŠ¨å’ŒNVMe-oFå¯åŠ¨å™¨å…±äº«ä¸€å¥—å…±åŒçš„APIå‘½ä»¤ã€‚è¿™æ„å‘³ç€ï¼Œæ¯”å¦‚æœ¬åœ°&#x2F;è¿œç¨‹å¤åˆ¶éå¸¸å®¹æ˜“å®ç°ã€‚</p>
<h4 id="Ceph-RADOS-Block-Device"><a href="#Ceph-RADOS-Block-Device" class="headerlink" title="Ceph RADOS Block Device"></a>Ceph RADOS Block Device</h4><p>Ceph RBD æˆä¸ºSPDKçš„åç«¯è®¾å¤‡</p>
<h4 id="Blobstore-Block-Device"><a href="#Blobstore-Block-Device" class="headerlink" title="Blobstore Block Device"></a>Blobstore Block Device</h4><p>ç”±SPDK Blobstoreåˆ†é…çš„å—è®¾å¤‡ï¼Œæ˜¯è™šæ‹Ÿæœºæˆ–æ•°æ®åº“å¯ä»¥ä¸ä¹‹äº¤äº’çš„è™šæ‹Ÿè®¾å¤‡ã€‚è¿™äº›è®¾å¤‡å¾—åˆ°SPDKåŸºç¡€æ¶æ„çš„ä¼˜åŠ¿ï¼Œæ„å‘³ç€é›¶æ‹·è´å’Œä»¤äººéš¾ä»¥ç½®ä¿¡çš„å¯æ‰©å±•æ€§ã€‚</p>
<h4 id="Linux-AIO"><a href="#Linux-AIO" class="headerlink" title="Linux AIO"></a>Linux AIO</h4><p>å…è®¸SPDKä¸å†…æ ¸è®¾å¤‡ï¼ˆæ¯”å¦‚æœºæ¢°ç¡¬ç›˜ï¼‰äº¤äº’ã€‚</p>
<h3 id="Storage-Services"><a href="#Storage-Services" class="headerlink" title="Storage Services"></a>Storage Services</h3><h4 id="Block-Device-Abstration-Layer"><a href="#Block-Device-Abstration-Layer" class="headerlink" title="Block Device Abstration Layer"></a>Block Device Abstration Layer</h4><p>è¿™ç§é€šç”¨çš„å—è®¾å¤‡æŠ½è±¡æ˜¯è¿æ¥åˆ°å„ç§ä¸åŒè®¾å¤‡é©±åŠ¨å’Œå—è®¾å¤‡çš„å­˜å‚¨åè®®çš„ç²˜åˆå‰‚ã€‚è¿˜åœ¨å—å±‚ä¸­æä¾›çµæ´»çš„APIç”¨äºé¢å¤–çš„ç”¨æˆ·åŠŸèƒ½ï¼ˆç£ç›˜é˜µåˆ—ï¼Œå‹ç¼©ï¼Œå»å†—ç­‰ç­‰ï¼‰ã€‚</p>
<h4 id="Blobstore"><a href="#Blobstore" class="headerlink" title="Blobstore"></a>Blobstore</h4><p>ä¸ºSPDKå®ç°ä¸€ä¸ªé«˜ç²¾ç®€çš„æ–‡ä»¶å¼è¯­ä¹‰ï¼ˆéPOSIXï¼‰ã€‚è¿™å¯ä»¥ä¸ºæ•°æ®åº“ï¼Œå®¹å™¨ï¼Œè™šæ‹Ÿæœºæˆ–å…¶ä»–ä¸ä¾èµ–äºå¤§éƒ¨åˆ†POSIXæ–‡ä»¶ç³»ç»ŸåŠŸèƒ½é›†ï¼ˆæ¯”å¦‚ç”¨æˆ·è®¿é—®æ§åˆ¶ï¼‰çš„å·¥ä½œè´Ÿè½½æä¾›é«˜æ€§èƒ½åŸºç¡€ã€‚</p>
<h3 id="Storage-Protocols"><a href="#Storage-Protocols" class="headerlink" title="Storage Protocols"></a>Storage Protocols</h3><h4 id="iSCSI-Target"><a href="#iSCSI-Target" class="headerlink" title="iSCSI Target"></a>iSCSI Target</h4><p>å»ºç«‹äº†é€šè¿‡ä»¥å¤ªç½‘çš„å—æµé‡è§„èŒƒï¼Œå¤§çº¦æ˜¯å†…æ ¸LIOæ•ˆç‡çš„ä¸¤å€ã€‚ç°åœ¨çš„ç‰ˆæœ¬é»˜è®¤ä½¿ç”¨å†…æ ¸TCP&#x2F;IPåè®®æ ˆã€‚</p>
<h4 id="vhost-scsi-target"><a href="#vhost-scsi-target" class="headerlink" title="vhost-scsi target"></a>vhost-scsi target</h4><p>KVM&#x2F;QEMUçš„åŠŸèƒ½åˆ©ç”¨äº†SPDK NVMeé©±åŠ¨ï¼Œä½¿å¾—è®¿å®¢è™šæ‹Ÿæœºè®¿é—®å­˜å‚¨è®¾å¤‡æ—¶å»¶è¿Ÿæ›´ä½ï¼Œä½¿å¾—I&#x2F;Oå¯†é›†å‹å·¥ä½œè´Ÿè½½çš„æ•´ä½“CPUè´Ÿè½½å‡ä½ã€‚</p>
<h4 id="NVMe-oF-Target"><a href="#NVMe-oF-Target" class="headerlink" title="NVMe-oF Target"></a>NVMe-oF Target</h4><p>å®ç°äº†NVMe-oFè§„èŒƒã€‚è™½ç„¶è¿™å–å†³äºRDMAç¡¬ä»¶ï¼ŒNVMe-oFçš„ç›®æ ‡å¯ä»¥ä¸ºæ¯ä¸ªCPUæ ¸æä¾›é«˜è¾¾40Gbpsçš„æµé‡ã€‚</p>
<h1 id="åº”ç”¨æ–¹æ¡ˆ"><a href="#åº”ç”¨æ–¹æ¡ˆ" class="headerlink" title="åº”ç”¨æ–¹æ¡ˆ"></a>åº”ç”¨æ–¹æ¡ˆ</h1><p><img src="/images/spdk/spdk_component.png" alt="spdk_component"></p>
<h3 id="ç½‘ç»œå‰ç«¯"><a href="#ç½‘ç»œå‰ç«¯" class="headerlink" title="ç½‘ç»œå‰ç«¯"></a>ç½‘ç»œå‰ç«¯</h3><p>ç½‘ç»œå‰ç«¯å­ç»„ä»¶åŒ…æ‹¬DPDKç½‘å¡é©±åŠ¨å’Œç”¨æˆ·æ€ç½‘ç»œæœåŠ¡UNSï¼ˆè¿™æ˜¯ä¸€ä¸ªLinuxå†…æ ¸TCP&#x2F;IPåè®®æ ˆçš„æ›¿ä»£å“ï¼Œèƒ½å¤Ÿçªç ´é€šç”¨TCP&#x2F;IPåè®®æ ˆçš„ç§ç§æ€§èƒ½é™åˆ¶ç“¶é¢ˆï¼‰ã€‚DPDKåœ¨ç½‘å¡ä¾§æä¾›äº†ä¸€ä¸ªé«˜æ€§èƒ½çš„å‘åŒ…æ”¶åŒ…å¤„ç†æ¡†æ¶ï¼Œåœ¨æ•°æ®ä»ç½‘å¡åˆ°æ“ä½œç³»ç»Ÿç”¨æˆ·æ€ä¹‹é—´æä¾›äº†ä¸€æ¡å¿«é€Ÿé€šé“ã€‚</p>
<h3 id="å¤„ç†æ¡†æ¶"><a href="#å¤„ç†æ¡†æ¶" class="headerlink" title="å¤„ç†æ¡†æ¶"></a>å¤„ç†æ¡†æ¶</h3><p>æ‹¿åˆ°äº†æ•°æ®åŒ…å†…å®¹ï¼Œå°†iSCSIå‘½ä»¤è½¬æ¢ä¸ºSCSIå—çº§å‘½ä»¤ã€‚ç„¶è€Œï¼Œåœ¨å®ƒå°†è¿™äº›å‘½ä»¤å‘åˆ°â€œåç«¯â€é©±åŠ¨ä¹‹å‰ï¼ŒSPDKæä¾›äº†ä¸€å¥—APIæ¡†æ¶ï¼Œè®©å‚å•†èƒ½å¤Ÿæ’å…¥è‡ªå·±å®šä¹‰çš„å¤„ç†é€»è¾‘(æ¶æ„å›¾ä¸­ç»¿è‰²çš„æ–¹æ¡†)ã€‚é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œå­˜å‚¨å‚å•†å¯åœ¨è¿™é‡Œå®ç°ä¾‹å¦‚ç¼“å­˜ã€å»é‡ã€å‹ç¼©ã€åŠ å¯†ã€RAIDè®¡ç®—ï¼Œæˆ–æ“¦é™¤ç (Erasure Coding)è®¡ç®—ç­‰åŠŸèƒ½ï¼Œä½¿è¿™äº›åŠŸèƒ½åŒ…å«åœ¨SPDKçš„å¤„ç†æµç¨‹ä¸­ã€‚</p>
<h3 id="åç«¯"><a href="#åç«¯" class="headerlink" title="åç«¯"></a>åç«¯</h3><p>SPDKå’Œç‰©ç†å—è®¾å¤‡äº¤äº’(è¯»å’Œå†™æ“ä½œ)ã€‚å¦‚å‰æ‰€è¿°ï¼ŒSPDKæä¾›äº†ç”¨æˆ·æ€çš„PMDï¼Œæ”¯æŒNVMeè®¾å¤‡ã€Linux AIOè®¾å¤‡(ä¼ ç»Ÿæœºæ¢°ç¡¬ç›˜)ã€RAMDISKè®¾å¤‡ï¼Œä»¥åŠåˆ©ç”¨åˆ°è‹±ç‰¹å°”I&#x2F;OåŠ é€ŸæŠ€æœ¯çš„æ–°è®¾å¤‡(CBDMA)ã€‚è¿™ä¸€ç³»åˆ—åç«¯è®¾å¤‡é©±åŠ¨æ¶µç›–äº†ä¸åŒæ€§èƒ½çš„å­˜å‚¨åˆ†å±‚ï¼Œä¿è¯SPDKå‡ ä¹ä¸æ¯ç§å­˜å‚¨åº”ç”¨å½¢æˆå…³è”ã€‚</p>
<h1 id="ä½¿ç”¨åŠç¼–è¯‘"><a href="#ä½¿ç”¨åŠç¼–è¯‘" class="headerlink" title="ä½¿ç”¨åŠç¼–è¯‘"></a>ä½¿ç”¨åŠç¼–è¯‘</h1><h2 id="ç¼–è¯‘å®‰è£…"><a href="#ç¼–è¯‘å®‰è£…" class="headerlink" title="ç¼–è¯‘å®‰è£…"></a>ç¼–è¯‘å®‰è£…</h2><p>SPDKä½¿ç”¨äº†DPDKä¸­çš„ä¸€äº›åŠŸèƒ½ï¼Œç¼–è¯‘SPDKéœ€è¦ä¾èµ–DPDKï¼Œæ‰€ä»¥éœ€è¦å…ˆç¼–è¯‘å®‰è£…DPDK</p>
<p>ç¼–è¯‘DPDK</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make config T=x86_64-native-linuxapp-gcc</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make install</span></span><br></pre></td></tr></table></figure>
<p>é»˜è®¤DPDKä¼šå®‰è£…åˆ°<code>/usr/local</code>ç›®å½•ä¸‹</p>
<p>ç¼–è¯‘SPDK</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./configure --with-dpdk=/usr/local</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make</span></span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>nvmeè®¾å¤‡æ’å…¥ä¸»æœºä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ã€‚è‹¥æƒ³ä½¿ç”¨spdkè®¿é—®è¯¥è®¾å¤‡å¿…é¡»ç°å°†nvme unbindã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lsblk</span></span><br><span class="line">NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda       8:0    0  7.3T  0 disk</span><br><span class="line">â””â”€sda1    8:1    0  7.3T  0 part /</span><br><span class="line">sdb       8:16   0  7.3T  0 disk</span><br><span class="line">sdc       8:32   0  7.3T  0 disk</span><br><span class="line">sdd       8:48   0  3.8G  0 disk</span><br><span class="line">â””â”€sdd1    8:49   0  3.8G  0 part /boot</span><br><span class="line">nvme0n1 259:0    0  1.5T  0 disk</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cd</span> &lt;spdk_dir&gt;/scripts</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sh setup.sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0  7.3T  0 disk</span><br><span class="line">â””â”€sda1   8:1    0  7.3T  0 part /</span><br><span class="line">sdb      8:16   0  7.3T  0 disk</span><br><span class="line">sdc      8:32   0  7.3T  0 disk</span><br><span class="line">sdd      8:48   0  3.8G  0 disk</span><br><span class="line">â””â”€sdd1   8:49   0  3.8G  0 part /boot</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ-é¸£è°¢"><a href="#å‚è€ƒ-é¸£è°¢" class="headerlink" title="å‚è€ƒ&amp;é¸£è°¢"></a>å‚è€ƒ&amp;é¸£è°¢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/whl320124/articles/9969395.html">SPDKç®€ä»‹</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6892df050b5a">ä½¿ç”¨fioæµ‹è¯•SPDK</a></li>
<li><a target="_blank" rel="noopener" href="https://rootw.github.io/2018/05/SPDK-all/">ã€SPDKã€‘ä¸€ã€æ¦‚è¿°</a></li>
<li><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/articles/introduction-to-the-storage-performance-development-kit-spdk.html">Introduction to the Storage Performance Development Kit (SPDK)</a></li>
<li><a target="_blank" rel="noopener" href="https://tonydeng.github.io/sdn-handbook/dpdk/spdk.html">SPDK</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2020/11/11/storage/ceph/async-messenger-introduce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/11/storage/ceph/async-messenger-introduce/" class="post-title-link" itemprop="url">AsyncMessengerä»‹ç»</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-11 15:05:40" itemprop="dateCreated datePublished" datetime="2020-11-11T15:05:40+08:00">2020-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/storage/" itemprop="url" rel="index"><span itemprop="name">storage</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¯´åˆ°Cephçš„é€šè®¯ä¸€å®šç»•ä¸å¼€Messengerï¼Œæ— è®ºæ˜¯å®¢æˆ·ç«¯åˆ°OSDï¼Œè¿˜æ˜¯OSDåˆ°MONï¼Œæˆ–è€…OSDåˆ°OSDï¼Œéƒ½éœ€è¦Messengeræ¥ååŠ©å®Œæˆå„ä¸ªæ¨¡å—é—´æ¶ˆæ¯çš„å‘é€ã€æ¥æ”¶ã€‚Messengeræœ‰ä¸‰ç§å®ç°ï¼Œåˆ†åˆ«æ˜¯SimpleMessengerã€AsyncMessengerã€XioMessengerï¼Œæœ¬æ–‡ä»¥AsyncMessengerä¸ºä¾‹ç®€å•ä»‹ç»ä¸€ä¸‹å…¶å·¥ä½œåŸç†ã€‚</p>
<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p><img src="/images/asyncmessenger/ceph-AsyncMessenger.png" alt="asyncmessenger"></p>
<ul>
<li><code>processors</code>çº¿ç¨‹æ•°é‡ç”±<code>cct-&gt;_conf-&gt;ms_async_op_threads</code>å†³å®š</li>
<li><code>NetworkStack</code>ä¸­<code>workers</code>ä¸<code>processors</code>ä¸€ä¸€å¯¹åº”ã€‚</li>
<li><code>processors</code>æ”¶åˆ°è¯·æ±‚ä¼šè°ƒåˆ›å»º<code>AsyncConnection</code>ï¼Œå¹¶å­˜å…¥è°ƒç”¨<code>AsyncConnection</code>å®ä¾‹çš„<code>accept</code>æ–¹æ³•ï¼Œ<code>accept</code>é€šè¿‡<code>EventCenter</code>å°†ç”±<code>NetworkStack</code>çš„<code>workers</code>è°ƒç”¨<code>AsyncConnection</code>å®ä¾‹çš„<code>process</code>æ–¹æ³•ã€‚(å“ˆå“ˆå“ˆï¼Œç»•å§ï¼Œæœ‰ç‚¹å„¿æ™•äº†å§ï½ï½ï½)</li>
<li><code>processors</code>å¤„ç†å®Œacceptè¯·æ±‚åï¼Œå°†<code>AsyncConnection</code>å®ä¾‹å­˜å…¥<code>accepting_conns</code>ï¼Œç­‰å¾…<code>NetworkStack</code>å¤„ç†å®Œæˆã€‚</li>
<li><code>AsyncConnection</code>çš„<code>process</code>è¢«<code>NetworkStack</code>çš„<code>workers</code>çº¿ç¨‹è°ƒç”¨ï¼Œå¹¶æ„å»º<code>Message</code>æ¶ˆæ¯é€šè¿‡<code>dispatch_queue</code>æˆ–<code>ms_fast_dispatch</code>å‘é€åˆ°<code>fast_dispatchers</code>ã€‚</li>
</ul>
<h1 id="Message-æ ¼å¼"><a href="#Message-æ ¼å¼" class="headerlink" title="Message æ ¼å¼"></a>Message æ ¼å¼</h1><h2 id="CEPH-MSGR-TAG-MSG"><a href="#CEPH-MSGR-TAG-MSG" class="headerlink" title="CEPH_MSGR_TAG_MSG"></a>CEPH_MSGR_TAG_MSG</h2><p><img src="/images/asyncmessenger/ceph-message_format.png" alt="message_format"></p>
<ul>
<li>tag  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_READY         1  <span class="comment">/* server-&gt;client: ready for messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_RESETSESSION  2  <span class="comment">/* server-&gt;client: reset, try again */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_WAIT          3  <span class="comment">/* server-&gt;client: wait for racing incoming connection */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_RETRY_SESSION 4  <span class="comment">/* server-&gt;client + cseq: try again with higher cseq */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_RETRY_GLOBAL  5  <span class="comment">/* server-&gt;client + gseq: try again with higher gseq */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_CLOSE         6  <span class="comment">/* closing pipe */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_MSG           7  <span class="comment">/* message */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_ACK           8  <span class="comment">/* message ack */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_KEEPALIVE     9  <span class="comment">/* just a keepalive byte! */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_BADPROTOVER  10  <span class="comment">/* bad protocol version */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_BADAUTHORIZER 11 <span class="comment">/* bad authorizer */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_FEATURES      12 <span class="comment">/* insufficient features */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_SEQ           13 <span class="comment">/* 64-bit int follows with seen seq number */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_KEEPALIVE2     14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_KEEPALIVE2_ACK 15  <span class="comment">/* keepalive reply */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CEPH_MSGR_TAG_CHALLENGE_AUTHORIZER 16  <span class="comment">/* ceph v2 doing server challenge */</span></span></span><br></pre></td></tr></table></figure>
  ** æˆ‘è§‰å¾—æ³¨é‡Šå¤„çš„è¯´æ˜å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œæ­¤å¤„ä¸åšè¿‡å¤šè¯´æ˜äº†ã€‚ **</li>
<li>header  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ceph_msg_header</span> &#123;</span><br><span class="line">    __le64 seq;       <span class="comment">/* message seq# for this session */</span></span><br><span class="line">    __le64 tid;       <span class="comment">/* transaction id */</span></span><br><span class="line">    __le16 type;      <span class="comment">/* message type */</span></span><br><span class="line">    __le16 priority;  <span class="comment">/* priority.  higher value == higher priority */</span></span><br><span class="line">    __le16 version;   <span class="comment">/* version of message encoding */</span></span><br><span class="line"></span><br><span class="line">    __le32 front_len; <span class="comment">/* bytes in main payload */</span></span><br><span class="line">    __le32 middle_len;<span class="comment">/* bytes in middle payload */</span></span><br><span class="line">    __le32 data_len;  <span class="comment">/* bytes of data payload */</span></span><br><span class="line">    __le16 data_off;  <span class="comment">/* sender: include full offset;</span></span><br><span class="line"><span class="comment">                 receiver: mask against ~PAGE_MASK */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ceph_entity_name</span> src;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* oldest code we think can decode this.  unknown if zero. */</span></span><br><span class="line">    __le16 compat_version;</span><br><span class="line">    __le16 reserved;</span><br><span class="line">    __le32 crc;       <span class="comment">/* header crc32c */</span></span><br><span class="line">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure></li>
<li>payload<br>  *** æœªçŸ¥ ***</li>
<li>middle<br>  *** æœªçŸ¥ ***</li>
<li>data<br>  å…·ä½“ä¼ é€’çš„æ•°æ®å†…å®¹ï¼Œæ•°æ®å¤§å°ç”±<code>header</code>ä¸­çš„<code>data_len</code>å†³å®šã€‚</li>
<li>footer&#x2F;old_footer  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * follows data payload</span></span><br><span class="line"><span class="comment"> * ceph_msg_footer_old does not support digital signatures on messages PLR</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ceph_msg_footer_old</span> &#123;</span><br><span class="line">    __le32 front_crc, middle_crc, data_crc;</span><br><span class="line">    __u8 flags;</span><br><span class="line">&#125; __attribute__ ((packed));</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ceph_msg_footer</span> &#123;</span><br><span class="line">    __le32 front_crc, middle_crc, data_crc;</span><br><span class="line">    <span class="comment">// sig holds the 64 bits of the digital signature for the message PLR</span></span><br><span class="line">    __le64  sig;</span><br><span class="line">    __u8 flags;</span><br><span class="line">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure>
  <code>footer</code>ä¸<code>old_footer</code>ä¹‹å·®ä¸€ä¸ªç­¾å<code>sig</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zhoubofsy.github.io/2020/11/08/algorithm/raft/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="åš">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bolog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/08/algorithm/raft/" class="post-title-link" itemprop="url">Raft</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-08 17:14:04" itemprop="dateCreated datePublished" datetime="2020-11-08T17:14:04+08:00">2020-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-09 15:57:18" itemprop="dateModified" datetime="2024-09-09T15:57:18+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/algorithm/" itemprop="url" rel="index"><span itemprop="name">algorithm</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨æå¤§æé«˜å¯ç”¨æ€§ã€å®¹é”™æ€§çš„åŒæ—¶ï¼Œå¸¦æ¥äº†ä¸€è‡´æ€§é—®é¢˜ï¼ˆCAPç†è®ºï¼‰ã€‚Raftç®—æ³•èƒ½å¤Ÿè§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§é—®é¢˜ã€‚ä¸€è‡´æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå®¹é”™çš„åŸºæœ¬é—®é¢˜ã€‚ä¸€è‡´æ€§æ¶‰åŠå¤šä¸ªæœåŠ¡å™¨çŠ¶æ€ï¼ˆValuesï¼‰è¾¾æˆä¸€è‡´ã€‚ ä¸€æ—¦ä»–ä»¬å°±çŠ¶æ€åšå‡ºå†³å®šï¼Œè¯¥å†³å®šå°±æ˜¯æœ€ç»ˆå†³å®šã€‚ å½“å¤§å¤šæ•°æœåŠ¡å™¨å¯ç”¨æ—¶ï¼Œå…¸å‹çš„ä¸€è‡´æ€§ç®—æ³•ä¼šå–å¾—è¿›å±•ã€‚</p>
<p>raftæ˜¯å·¥ç¨‹ä¸Šä½¿ç”¨è¾ƒä¸ºå¹¿æ³›çš„å¼ºä¸€è‡´æ€§ã€å»ä¸­å¿ƒåŒ–ã€é«˜å¯ç”¨çš„åˆ†å¸ƒå¼åè®®ã€‚åœ¨è¿™é‡Œå¼ºè°ƒäº†æ˜¯åœ¨å·¥ç¨‹ä¸Šï¼Œå› ä¸ºåœ¨å­¦æœ¯ç†è®ºç•Œï¼Œæœ€è€€çœ¼çš„è¿˜æ˜¯å¤§åé¼é¼çš„Paxosã€‚ä½†Paxosæ˜¯ï¼šå°‘æ•°çœŸæ­£ç†è§£çš„äººè§‰å¾—ç®€å•ï¼Œå°šæœªç†è§£çš„äººè§‰å¾—å¾ˆéš¾ï¼Œå¤§å¤šæ•°äººéƒ½æ˜¯ä¸€çŸ¥åŠè§£ã€‚æœ¬äººä¹ŸèŠ±äº†å¾ˆå¤šæ—¶é—´ã€çœ‹äº†å¾ˆå¤šææ–™ä¹Ÿæ²¡æœ‰çœŸæ­£ç†è§£ã€‚ç›´åˆ°çœ‹åˆ°raftçš„è®ºæ–‡ï¼Œä¸¤ä½ç ”ç©¶è€…ä¹Ÿæåˆ°ï¼Œä»–ä»¬ä¹ŸèŠ±äº†å¾ˆé•¿çš„æ—¶é—´æ¥ç†è§£Paxosï¼Œä»–ä»¬ä¹Ÿè§‰å¾—å¾ˆéš¾ç†è§£ï¼Œäºæ˜¯ç ”ç©¶å‡ºäº†raftç®—æ³•ã€‚</p>
<h1 id="Leaderé€‰ä¸¾"><a href="#Leaderé€‰ä¸¾" class="headerlink" title="Leaderé€‰ä¸¾"></a>Leaderé€‰ä¸¾</h1><p>raftåè®®ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä»»ä¸€æ—¶åˆ»å¤„äº<code>leader</code>, <code>follower</code>, <code>candidate</code>ä¸‰ä¸ªè§’è‰²ä¹‹ä¸€ã€‚</p>
<ul>
<li>leader æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶å‘FolloweråŒæ­¥è¯·æ±‚æ—¥å¿—ï¼Œå½“æ—¥å¿—åŒæ­¥åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šåå‘Šè¯‰Followeræäº¤æ—¥å¿—ã€‚</li>
<li>follower æ¥å—å¹¶æŒä¹…åŒ–LeaderåŒæ­¥çš„æ—¥å¿—ï¼Œåœ¨Leaderå‘Šä¹‹æ—¥å¿—å¯ä»¥æäº¤ä¹‹åï¼Œæäº¤æ—¥å¿—ã€‚</li>
<li>candidate Leaderé€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶è§’è‰²ã€‚</li>
</ul>
<p><img src="/images/raft/election_state.jpg" alt="election_state"></p>
<p>æ¯ä¸ªèŠ‚ç‚¹ä»¥<code>follower</code>è§’è‰²å¼€å§‹ï¼Œå¦‚æœ<code>follower</code>è¶…æ—¶æ²¡æœ‰æ”¶åˆ°<code>leader</code>çš„æ¶ˆæ¯ï¼Œå®ƒä¼šè¿›å…¥<code>candidate</code>è§’è‰²ï¼Œå¹¶å‘èµ·é€‰ä¸¾æŠ•ç¥¨ã€‚å¦‚æœ<code>candidate</code>æ”¶åˆ°çš„ç¥¨æ•°è¶…è¿‡åŠæ•°ä»¥ä¸Šï¼Œåˆ™åˆ‡æ¢ä¸º<code>leader</code>è§’è‰²ã€‚å¦‚æœå‘ç°å…¶ä»–èŠ‚ç‚¹æ¯”è‡ªå·±æ›´æ–°ï¼Œåˆ™ä¸»åŠ¨åˆ‡æ¢åˆ°<code>follower</code>ã€‚æ€»ä¹‹ï¼Œç³»ç»Ÿä¸­æœ€å¤šåªæœ‰ä¸€ä¸ª<code>leader</code>ï¼Œå¦‚æœåœ¨ä¸€æ®µæ—¶é—´é‡Œå‘ç°æ²¡æœ‰<code>leader</code>ï¼Œåˆ™å¤§å®¶é€šè¿‡é€‰ä¸¾-æŠ•ç¥¨é€‰å‡º<code>leader</code>ã€‚<code>leader</code>ä¼šä¸åœçš„ç»™<code>follower</code>å‘å¿ƒè·³æ¶ˆæ¯ï¼Œè¡¨æ˜è‡ªå·±çš„å­˜æ´»çŠ¶æ€ã€‚å¦‚æœ<code>leader</code>æ•…éšœï¼Œé‚£ä¹ˆ<code>follower</code>ä¼šè½¬æ¢æˆ<code>candidate</code>ï¼Œé‡æ–°é€‰å‡º<code>leader</code>ã€‚</p>
<p><img src="/images/raft/election_term.png" alt="election_term"></p>
<p>leaderæ˜¯å¤§å®¶æŠ•ç¥¨é€‰ä¸¾å‡ºæ¥çš„ï¼Œæ¯ä¸ªleaderå·¥ä½œä¸€æ®µæ—¶é—´ï¼Œç„¶åé€‰å‡ºæ–°çš„leaderç»§ç»­è´Ÿè´£ã€‚è¿™æ ¹æ°‘ä¸»ç¤¾ä¼šçš„é€‰ä¸¾å¾ˆåƒï¼Œæ¯ä¸€å±Šæ–°çš„å±¥èŒæœŸç§°ä¹‹ä¸ºä¸€å±Šä»»æœŸï¼Œåœ¨raftåè®®ä¸­ï¼Œä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œå¯¹åº”çš„æœ¯è¯­å«termã€‚termï¼ˆä»»æœŸï¼‰ä»¥é€‰ä¸¾ï¼ˆelectionï¼‰å¼€å§‹ï¼Œç„¶åå°±æ˜¯ä¸€æ®µæˆ–é•¿æˆ–çŸ­çš„ç¨³å®šå·¥ä½œæœŸï¼ˆnormal Operationï¼‰ã€‚ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œä»»æœŸæ˜¯é€’å¢çš„ï¼Œè¿™å°±å……å½“äº†é€»è¾‘æ—¶é’Ÿçš„ä½œç”¨ï¼›å¦å¤–ï¼Œterm 3å±•ç¤ºäº†ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯è¯´æ²¡æœ‰é€‰ä¸¾å‡ºleaderå°±ç»“æŸäº†ï¼Œç„¶åä¼šå‘èµ·æ–°çš„é€‰ä¸¾ã€‚</p>
<h2 id="é€‰ä¸¾è¿‡ç¨‹"><a href="#é€‰ä¸¾è¿‡ç¨‹" class="headerlink" title="é€‰ä¸¾è¿‡ç¨‹"></a>é€‰ä¸¾è¿‡ç¨‹</h2><h3 id="æ­£å¸¸æƒ…å†µä¸‹é€‰ä¸¾"><a href="#æ­£å¸¸æƒ…å†µä¸‹é€‰ä¸¾" class="headerlink" title="æ­£å¸¸æƒ…å†µä¸‹é€‰ä¸¾"></a>æ­£å¸¸æƒ…å†µä¸‹é€‰ä¸¾</h3><p>5ä¸ªèŠ‚ç‚¹ä¸€å¼€å§‹çš„çŠ¶æ€éƒ½æ˜¯<code>Follower</code>ã€‚<br><img src="/images/raft/election_flow_normal_1.png" alt="election_flow_normal_1"></p>
<p>åœ¨ä¸€ä¸ªèŠ‚ç‚¹å€’è®¡æ—¶ç»“æŸ(Timeout) åï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å˜æˆ<code>Candidate</code>å¼€å§‹é€‰ä¸¾ï¼Œå®ƒç»™å…¶ä»–å‡ ä¸ªèŠ‚ç‚¹å‘é€é€‰ä¸¾è¯·æ±‚(RequestVote)<br><img src="/images/raft/election_flow_normal_2.png" alt="election_flow_normal_2"></p>
<p>å…¶ä»–å››ä¸ªèŠ‚ç‚¹éƒ½è¿”å›æˆåŠŸï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ç”±<code>Candidate</code>å˜æˆäº†<code>Leader</code>ï¼Œå¹¶åœ¨æ¯ä¸ªä¸€å°æ®µæ—¶é—´åï¼Œå°±ç»™æ‰€æœ‰çš„<code>Follower</code>å‘é€ä¸€ä¸ª Heartbeat ä»¥ä¿æŒæ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œ<code>Follower</code>æ”¶åˆ°<code>Leader</code>çš„Heartbeatåé‡è®¾Timeoutã€‚<br><img src="/images/raft/election_flow_normal_3.png" alt="election_flow_normal_3"></p>
<p>åªè¦æœ‰è¶…è¿‡ä¸€åŠçš„èŠ‚ç‚¹æŠ•æ”¯æŒç¥¨äº†ï¼Œ<code>Candidate</code>æ‰ä¼šè¢«é€‰ä¸¾ä¸º<code>Leader</code>ï¼Œ5ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œ3ä¸ªèŠ‚ç‚¹ (åŒ…æ‹¬<code>Candidate</code>æœ¬èº«) æŠ•äº†æ”¯æŒå°±è¡Œã€‚</p>
<h3 id="Leader-å‡ºæ•…éšœæƒ…å†µä¸‹çš„é€‰ä¸¾"><a href="#Leader-å‡ºæ•…éšœæƒ…å†µä¸‹çš„é€‰ä¸¾" class="headerlink" title="Leader å‡ºæ•…éšœæƒ…å†µä¸‹çš„é€‰ä¸¾"></a>Leader å‡ºæ•…éšœæƒ…å†µä¸‹çš„é€‰ä¸¾</h3><p><img src="/images/raft/election_flow_error_leader_1.png" alt="election_flow_error_leader_1"></p>
<p><code>leader</code>å‡ºæ•…éšœæŒ‚æ‰äº†ï¼Œå…¶ä»–å››ä¸ª<code>follower</code>å°†è¿›è¡Œé‡æ–°é€‰ä¸»ã€‚<br><img src="/images/raft/election_flow_error_leader_2.png" alt="election_flow_error_leader_2"></p>
<p>4ä¸ªèŠ‚ç‚¹çš„é€‰ä¸»è¿‡ç¨‹å’Œ5ä¸ªèŠ‚ç‚¹çš„ç±»ä¼¼ï¼Œåœ¨é€‰å‡ºä¸€ä¸ªæ–°çš„<code>leader</code>åï¼ŒåŸæ¥çš„<code>Leader</code>æ¢å¤äº†åˆé‡æ–°åŠ å…¥äº†ï¼Œè¿™ä¸ªæ—¶å€™æ€ä¹ˆå¤„ç†ï¼Ÿåœ¨Rafté‡Œï¼Œç¬¬å‡ è½®é€‰ä¸¾æ˜¯æœ‰è®°å½•çš„ï¼Œé‡æ–°åŠ å…¥çš„<code>Leader</code>æ˜¯ç¬¬ä¸€è½®é€‰ä¸¾(Term 1)é€‰å‡ºæ¥çš„ï¼Œè€Œç°åœ¨çš„<code>Leader</code>åˆ™æ˜¯Term 2ï¼Œæ‰€æœ‰åŸæ¥çš„<code>Leader</code>ä¼šè‡ªè§‰é™çº§ä¸º<code>Follower</code><br><img src="/images/raft/election_flow_error_leader_3.png" alt="election_flow_error_leader_3"><br><img src="/images/raft/election_flow_error_leader_4.png" alt="election_flow_error_leader_4"><br><img src="/images/raft/election_flow_error_leader_5.png" alt="election_flow_error_leader_5"><br><img src="/images/raft/election_flow_error_leader_6.png" alt="election_flow_error_leader_6"></p>
<h3 id="å¤šä¸ªCandidateæƒ…å†µä¸‹çš„Leaderé€‰ä¸¾"><a href="#å¤šä¸ªCandidateæƒ…å†µä¸‹çš„Leaderé€‰ä¸¾" class="headerlink" title="å¤šä¸ªCandidateæƒ…å†µä¸‹çš„Leaderé€‰ä¸¾"></a>å¤šä¸ªCandidateæƒ…å†µä¸‹çš„Leaderé€‰ä¸¾</h3><p><img src="/images/raft/election_flow_mult_cand_1.png" alt="election_flow_mult_cand_1"></p>
<p>æœ‰ä¸¤ä¸ª<code>Follower</code>åŒæ—¶Timeoutï¼Œéƒ½å˜æˆäº†<code>Candidate</code>å¼€å§‹é€‰ä¸¾ï¼Œåˆ†åˆ«ç»™ä¸€ä¸ª<code>Follower</code>å‘é€äº†æŠ•ç¥¨è¯·æ±‚ã€‚<br><img src="/images/raft/election_flow_mult_cand_3.png" alt="election_flow_mult_cand_2"></p>
<p>ä¸¤ä¸ª<code>Follower</code>åˆ†åˆ«è¿”å›äº†okï¼Œè¿™æ—¶ä¸¤ä¸ª<code>Candidate</code>éƒ½åªæœ‰2ç¥¨ï¼Œè¦3ç¥¨æ‰èƒ½è¢«é€‰æˆ<code>Leader</code>ã€‚<br><img src="/images/raft/election_flow_mult_cand_3.png" alt="election_flow_mult_cand_3"></p>
<p>ä¸¤ä¸ª<code>Candidate</code>ä¼šåˆ†åˆ«ç»™å¦å¤–ä¸€ä¸ªè¿˜æ²¡æœ‰ç»™è‡ªå·±æŠ•ç¥¨çš„<code>Follower</code>å‘é€æŠ•ç¥¨è¯·æ±‚ã€‚<br><img src="/images/raft/election_flow_mult_cand_4.png" alt="election_flow_mult_cand_4"></p>
<p>ä½†æ˜¯å› ä¸º<code>Follower</code>åœ¨è¿™ä¸€è½®é€‰ä¸¾ä¸­ï¼Œéƒ½å·²ç»æŠ•å®Œç¥¨äº†ï¼Œæ‰€ä»¥éƒ½æ‹’ç»äº†ä»–ä»¬çš„è¯·æ±‚ã€‚æ‰€ä»¥åœ¨Term 2æ²¡æœ‰<code>Leader</code>è¢«é€‰å‡ºæ¥ã€‚<br><img src="/images/raft/election_flow_mult_cand_5.png" alt="election_flow_mult_cand_5"></p>
<p>è¿™æ—¶ï¼Œä¸¤ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€æ˜¯<code>Candidate</code>ï¼Œä¸¤ä¸ªæ˜¯<code>Follower</code>ï¼Œä½†æ˜¯ä»–ä»¬çš„å€’è®¡æ—¶å™¨ä»ç„¶åœ¨è¿è¡Œï¼Œæœ€å…ˆTimeoutçš„é‚£ä¸ªèŠ‚ç‚¹ä¼šè¿›è¡Œå‘èµ·æ–°ä¸€è½®Term 3çš„æŠ•ç¥¨ã€‚<br><img src="/images/raft/election_flow_mult_cand_6.png" alt="election_flow_mult_cand_6"></p>
<p>ä¸¤ä¸ª<code>Follower</code>åœ¨Term 3è¿˜æ²¡æŠ•è¿‡ç¥¨ï¼Œæ‰€ä»¥è¿”å›OKï¼Œè¿™æ—¶<code>Candidate</code>ä¸€å…±æœ‰ä¸‰ç¥¨ï¼Œè¢«é€‰ä¸ºäº†<code>Leader</code>ã€‚<br><img src="/images/raft/election_flow_mult_cand_7.png" alt="election_flow_mult_cand_7"></p>
<p>å¦‚æœ<code>Leader</code> Heartbeatçš„æ—¶é—´æ™šäºå¦å¤–ä¸€ä¸ª<code>Candidate</code> timeoutçš„æ—¶é—´ï¼Œå¦å¤–ä¸€ä¸ª<code>Candidate</code>ä»ç„¶ä¼šå‘é€é€‰ä¸¾è¯·æ±‚ã€‚<br><img src="/images/raft/election_flow_mult_cand_8.png" alt="election_flow_mult_cand_8"></p>
<p>ä¸¤ä¸ª<code>Follower</code>å·²ç»æŠ•å®Œç¥¨äº†ï¼Œæ‹’ç»äº†è¿™ä¸ª<code>Candidate</code>çš„æŠ•ç¥¨è¯·æ±‚ã€‚<br><img src="/images/raft/election_flow_mult_cand_9.png" alt="election_flow_mult_cand_9"></p>
<p><code>Leader</code>è¿›è¡ŒHeartbeatï¼Œ<code>Candidate</code>æ”¶åˆ°åçŠ¶æ€è‡ªåŠ¨è½¬ä¸º<code>Follower</code>ï¼Œå®Œæˆé€‰ä¸¾ã€‚<br><img src="/images/raft/election_flow_mult_cand_10.png" alt="election_flow_mult_cand_10"></p>
<h1 id="æ—¥å¿—å¤åˆ¶"><a href="#æ—¥å¿—å¤åˆ¶" class="headerlink" title="æ—¥å¿—å¤åˆ¶"></a>æ—¥å¿—å¤åˆ¶</h1><p>Raft åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­çš„ä¸€è‡´æ€§æ›´å¤šçš„æ˜¯ä½“ç°åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½èƒ½æ”¶åˆ°ä¸€è‡´çš„è¿”å›ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹å‡ºæ•…éšœåï¼Œå…¶ä»–èŠ‚ç‚¹ä»ç„¶èƒ½ä»¥å·²æœ‰çš„æ•°æ®æ­£å¸¸è¿›è¡Œã€‚åœ¨é€‰ä¸»ä¹‹åçš„å¤åˆ¶æ—¥å¿—å°±æ˜¯ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚</p>
<p><img src="/images/raft/log_replication_normal.jpg" alt="log_replication_normal"></p>
<h2 id="æ­£å¸¸æƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹"><a href="#æ­£å¸¸æƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹" class="headerlink" title="æ­£å¸¸æƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹"></a>æ­£å¸¸æƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹</h2><p><img src="/images/raft/log_replication_normal_step_1.png" alt="log_replication_normal_step_1"></p>
<p>å®¢æˆ·ç«¯å‘é€è¯·æ±‚ç»™<code>Leader</code>ï¼Œå‚¨å­˜æ•°æ® â€œsallyâ€ï¼Œ<code>Leader</code>å…ˆå°†æ•°æ®å†™åœ¨æœ¬åœ°æ—¥å¿—ï¼Œè¿™æ—¶å€™æ•°æ®è¿˜æ˜¯Uncommitted (è¿˜æ²¡æœ€ç»ˆç¡®è®¤ï¼Œçº¢è‰²è¡¨ç¤º)<br><img src="/images/raft/log_replication_normal_step_2.png" alt="log_replication_normal_step_2"></p>
<p><code>Leader</code>ç»™ä¸¤ä¸ª<code>Follower</code>å‘é€AppendEntriesè¯·æ±‚ï¼Œæ•°æ®åœ¨<code>Follower</code>ä¸Šæ²¡æœ‰å†²çªï¼Œåˆ™å°†æ•°æ®æš‚æ—¶å†™åœ¨æœ¬åœ°æ—¥å¿—ï¼Œ<code>Follower</code>çš„æ•°æ®ä¹Ÿè¿˜æ˜¯Uncommittedã€‚<br><img src="/images/raft/log_replication_normal_step_3.png" alt="log_replication_normal_step_3"></p>
<p><code>Follower</code>å°†æ•°æ®å†™åˆ°æœ¬åœ°åï¼Œè¿”å›OKã€‚<code>Leader</code>æ”¶åˆ°åæˆåŠŸè¿”å›ï¼Œåªè¦æ”¶åˆ°çš„æˆåŠŸçš„è¿”å›æ•°é‡è¶…è¿‡åŠæ•°(åŒ…å«<code>Leader</code>)ï¼Œ<code>Leader</code>å°†æ•°æ® â€œsallyâ€ çš„çŠ¶æ€æ”¹æˆCommittedã€‚( è¿™ä¸ªæ—¶å€™<code>Leader</code>å°±å¯ä»¥è¿”å›ç»™å®¢æˆ·ç«¯äº†)<br><img src="/images/raft/log_replication_normal_step_4.png" alt="log_replication_normal_step_4"></p>
<p><code>Leader</code>å†æ¬¡ç»™<code>Follower</code>å‘é€AppendEntriesè¯·æ±‚ï¼Œæ”¶åˆ°è¯·æ±‚åï¼Œ<code>Follower</code>å°†æœ¬åœ°æ—¥å¿—é‡ŒUncommittedæ•°æ®æ”¹æˆCommittedã€‚è¿™æ ·å°±å®Œæˆäº†ä¸€æ•´ä¸ªå¤åˆ¶æ—¥å¿—çš„è¿‡ç¨‹ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„æ•°æ®æ˜¯ä¸€è‡´çš„<br><img src="/images/raft/log_replication_normal_step_5.png" alt="log_replication_normal_step_5"></p>
<h2 id="Network-Partitionæƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹"><a href="#Network-Partitionæƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹" class="headerlink" title="Network Partitionæƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹"></a>Network Partitionæƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶è¿‡ç¨‹</h2><p>åœ¨Network Partitionçš„æƒ…å†µä¸‹ï¼Œéƒ¨åˆ†èŠ‚ç‚¹ä¹‹é—´æ²¡åŠæ³•äº’ç›¸é€šä¿¡ï¼ŒRaft ä¹Ÿèƒ½ä¿è¯åœ¨è¿™ç§æƒ…å†µä¸‹æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>
<p><img src="/images/raft/log_replication_np_1.png" alt="log_replication_np_1"></p>
<p>Network Partitionå°†èŠ‚ç‚¹åˆ†æˆä¸¤è¾¹ï¼Œä¸€è¾¹æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä¸€è¾¹ä¸‰ä¸ªèŠ‚ç‚¹ã€‚<br><img src="/images/raft/log_replication_np_2.png" alt="log_replication_np_2"></p>
<p>ä¸¤ä¸ªèŠ‚ç‚¹è¿™è¾¹å·²ç»æœ‰<code>Leader</code>äº†ï¼Œæ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®â€œbobâ€é€šè¿‡<code>Leader</code>åŒæ­¥åˆ°<code>Follower</code>ã€‚<br><img src="/images/raft/log_replication_np_3.png" alt="log_replication_np_3"></p>
<p>å› ä¸ºåªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå°‘äº3ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥â€œbobâ€çš„çŠ¶æ€ä»æ˜¯Uncommittedã€‚æ‰€ä»¥åœ¨è¿™é‡Œï¼ŒæœåŠ¡å™¨ä¼šè¿”å›é”™è¯¯ç»™å®¢æˆ·ç«¯<br><img src="/images/raft/log_replication_np_4.png" alt="log_replication_np_4"></p>
<p>å¦å¤–ä¸€ä¸ªPartitionæœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¿›è¡Œé‡æ–°é€‰ä¸»ã€‚å®¢æˆ·ç«¯æ•°æ®â€œtomâ€å‘åˆ°æ–°çš„<code>Leader</code>ï¼Œé€šè¿‡å’Œä¸ŠèŠ‚ç½‘ç»œçŠ¶æ€ä¸‹ç›¸ä¼¼çš„è¿‡ç¨‹ï¼ŒåŒæ­¥åˆ°å¦å¤–ä¸¤ä¸ª<code>Follower</code>ã€‚<br><img src="/images/raft/log_replication_np_5.png" alt="log_replication_np_5"></p>
<p>å› ä¸ºè¿™ä¸ªPartitionæœ‰3ä¸ªèŠ‚ç‚¹ï¼Œè¶…è¿‡åŠæ•°ï¼Œæ‰€ä»¥æ•°æ®â€œtomâ€éƒ½Commitäº†ã€‚<br><img src="/images/raft/log_replication_np_6.png" alt="log_replication_np_6"><br><img src="/images/raft/log_replication_np_7.png" alt="log_replication_np_7"><br><img src="/images/raft/log_replication_np_8.png" alt="log_replication_np_8"></p>
<p>ç½‘ç»œçŠ¶æ€æ¢å¤ï¼Œ5ä¸ªèŠ‚ç‚¹å†æ¬¡å¤„äºåŒä¸€ä¸ªç½‘ç»œçŠ¶æ€ä¸‹ã€‚ä½†æ˜¯è¿™é‡Œå‡ºç°äº†æ•°æ®å†²çªâ€œbobâ€å’Œâ€œtomâ€<br><img src="/images/raft/log_replication_np_9.png" alt="log_replication_np_9"></p>
<p>ä¸‰ä¸ªèŠ‚ç‚¹çš„<code>Leader</code>å¹¿æ’­AppendEntries<br><img src="/images/raft/log_replication_np_10.png" alt="log_replication_np_10"></p>
<p>ä¸¤ä¸ªèŠ‚ç‚¹Partitionçš„<code>Leader</code>è‡ªåŠ¨é™çº§ä¸º<code>Follower</code>ï¼Œå› ä¸ºè¿™ä¸ªPartitionçš„æ•°æ® â€œbobâ€ æ²¡æœ‰Commitï¼Œè¿”å›ç»™å®¢æˆ·ç«¯çš„æ˜¯é”™è¯¯ï¼Œå®¢æˆ·ç«¯çŸ¥é“è¯·æ±‚æ²¡æœ‰æˆåŠŸï¼Œæ‰€ä»¥<code>Follower</code>åœ¨æ”¶åˆ°AppendEntriesè¯·æ±‚æ—¶ï¼Œå¯ä»¥æŠŠâ€œbobâ€œåˆ é™¤ï¼Œç„¶ååŒæ­¥â€tomâ€ï¼Œé€šè¿‡è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹ï¼Œå°±å®Œæˆäº†åœ¨Network Partitionæƒ…å†µä¸‹çš„å¤åˆ¶æ—¥å¿—ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚<br><img src="/images/raft/log_replication_np_11.png" alt="log_replication_np_11"><br><img src="/images/raft/log_replication_np_12.png" alt="log_replication_np_12"></p>
<h1 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h1><h2 id="Election-safety"><a href="#Election-safety" class="headerlink" title="Election safety"></a>Election safety</h2><p>é€‰ä¸¾å®‰å…¨æ€§ï¼Œå³ä»»ä¸€ä»»æœŸå†…æœ€å¤šä¸€ä¸ª<code>leader</code>è¢«é€‰å‡ºã€‚è¿™ä¸€ç‚¹éå¸¸é‡è¦ï¼Œåœ¨ä¸€ä¸ªå¤åˆ¶é›†ä¸­ä»»ä½•æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ª<code>leader</code>ã€‚ç³»ç»Ÿä¸­åŒæ—¶æœ‰å¤šä½™ä¸€ä¸ª<code>leader</code>ï¼Œè¢«ç§°ä¹‹ä¸ºè„‘è£‚ï¼ˆbrain splitï¼‰ï¼Œè¿™æ˜¯éå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œä¼šå¯¼è‡´æ•°æ®çš„è¦†ç›–ä¸¢å¤±ã€‚</p>
<ul>
<li>ä¸€ä¸ªèŠ‚ç‚¹æŸä¸€ä»»æœŸå†…æœ€å¤šåªèƒ½æŠ•ä¸€ç¥¨</li>
<li>åªæœ‰è·å¾—å¤šæ•°ç¥¨çš„èŠ‚ç‚¹æ‰ä¼šæˆä¸º<code>leader</code></li>
</ul>
<h2 id="log-matching"><a href="#log-matching" class="headerlink" title="log matching"></a>log matching</h2><p>å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ä¸Šçš„æŸä¸ªlog entryçš„log indexç›¸åŒä¸”termç›¸åŒï¼Œé‚£ä¹ˆåœ¨è¯¥indexä¹‹å‰çš„æ‰€æœ‰log entryåº”è¯¥éƒ½æ˜¯ç›¸åŒçš„ã€‚åœ¨æ²¡æœ‰å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œlog matchingæ˜¯å¾ˆå®¹æ˜“æ»¡è¶³çš„ï¼Œä½†å¦‚æœå‡ºç°äº†node crashï¼Œæƒ…å†µå°±ä¼šå˜å¾—å¤æ‚äº†ã€‚</p>
<p><img src="/images/raft/safety_log_matching.png" alt="safety_log_matching"><br>*** ä¸Šå›¾çš„a-fä¸æ˜¯6ä¸ªfollowerï¼Œè€Œæ˜¯æŸä¸ªfollowerå¯èƒ½å­˜åœ¨çš„å…­ä¸ªçŠ¶æ€ ***</p>
<ul>
<li>æ¯”<code>leader</code>æ—¥å¿—å°‘: a,b</li>
<li>æ¯”<code>leader</code>æ—¥å¿—å¤šï¼šc,d</li>
<li>æŸäº›ä½ç½®æ¯”<code>leader</code>å¤šï¼ŒæŸäº›æ—¥å¿—æ¯”<code>leader</code>å°‘ï¼še,f</li>
</ul>
<p>å½“å‡ºç°äº†<code>leader</code>ä¸<code>follower</code>ä¸ä¸€è‡´çš„æƒ…å†µï¼Œ<code>leader</code>å¼ºåˆ¶<code>follower</code>å¤åˆ¶è‡ªå·±çš„logã€‚</p>
<h2 id="leader-completeness"><a href="#leader-completeness" class="headerlink" title="leader completeness"></a>leader completeness</h2><ul>
<li>ä¸€ä¸ªæ—¥å¿—è¢«å¤åˆ¶åˆ°å¤šæ•°èŠ‚ç‚¹æ‰ç®—committed</li>
<li>ä¸€ä¸ªèŠ‚ç‚¹å¾—åˆ°å¤šæ•°çš„æŠ•ç¥¨æ‰èƒ½æˆä¸º<code>leader</code>ï¼Œè€ŒèŠ‚ç‚¹Aç»™èŠ‚ç‚¹BæŠ•ç¥¨çš„å…¶ä¸­ä¸€ä¸ªå‰ææ˜¯ï¼ŒBçš„æ—¥å¿—ä¸èƒ½æ¯”Açš„æ—¥å¿—æ—§</li>
</ul>
<h2 id="State-Machine-Safety"><a href="#State-Machine-Safety" class="headerlink" title="State Machine Safety"></a>State Machine Safety</h2><p>å¦‚æœèŠ‚ç‚¹å°†æŸä¸€ä½ç½®çš„log entryåº”ç”¨åˆ°äº†çŠ¶æ€æœºï¼Œé‚£ä¹ˆå…¶ä»–èŠ‚ç‚¹åœ¨åŒä¸€ä½ç½®ä¸èƒ½åº”ç”¨ä¸åŒçš„æ—¥å¿—ã€‚ç®€å•ç‚¹æ¥è¯´ï¼Œæ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€ä½ç½®ï¼ˆindex in log entriesï¼‰åº”è¯¥åº”ç”¨åŒæ ·çš„æ—¥å¿—ã€‚</p>
<p><img src="/images/raft/safety_state_machine.png" alt="safety_state_machine"></p>
<ul>
<li>(a)æ—¶åˆ», s1æ˜¯leaderï¼Œåœ¨term2æäº¤çš„æ—¥å¿—åªèµ‹å€¼åˆ°äº†s1 s2ä¸¤ä¸ªèŠ‚ç‚¹å°±crashäº†ã€‚</li>
<li>(b)æ—¶åˆ», s5æˆä¸ºäº†term 3çš„<code>leader</code>ï¼Œæ—¥å¿—åªèµ‹å€¼åˆ°äº†s5ï¼Œç„¶åcrashã€‚</li>
<li>(c)æ—¶åˆ»ï¼Œs1åˆæˆä¸ºäº†term 4çš„<code>leader</code>ï¼Œå¼€å§‹èµ‹å€¼æ—¥å¿—ï¼Œäºæ˜¯æŠŠterm2çš„æ—¥å¿—å¤åˆ¶åˆ°äº†s3ï¼Œæ­¤åˆ»ï¼Œå¯ä»¥çœ‹å‡ºterm2å¯¹åº”çš„æ—¥å¿—å·²ç»è¢«å¤åˆ¶åˆ°äº†å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œå› æ­¤æ˜¯committedï¼Œå¯ä»¥è¢«çŠ¶æ€æœºåº”ç”¨ã€‚</li>
<li>(d)æ—¶åˆ»ï¼Œs1åˆcrashäº†ï¼Œs5é‡æ–°å½“é€‰ï¼Œç„¶åå°†term3çš„æ—¥å¿—å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¿™å°±å‡ºç°äº†ä¸€ç§å¥‡æ€ªçš„ç°è±¡ï¼šè¢«å¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ï¼ˆæˆ–è€…è¯´å¯èƒ½å·²ç»åº”ç”¨ï¼‰çš„æ—¥å¿—è¢«å›æ»šã€‚</li>
</ul>
<p>å› ä¸ºterm4æ—¶çš„<code>leader</code> s1åœ¨(c)æ—¶åˆ»æäº¤äº†ä¹‹å‰term2ä»»æœŸçš„æ—¥å¿—ã€‚æŸä¸ª<code>leader</code>é€‰ä¸¾æˆåŠŸä¹‹åï¼Œä¸ä¼šç›´æ¥æäº¤å‰ä»»<code>leader</code>æ—¶æœŸçš„æ—¥å¿—ï¼Œè€Œæ˜¯é€šè¿‡æäº¤å½“å‰ä»»æœŸçš„æ—¥å¿—çš„æ—¶å€™â€œé¡ºæ‰‹â€æŠŠä¹‹å‰çš„æ—¥å¿—ä¹Ÿæäº¤äº†ï¼Œå…·ä½“æ€ä¹ˆå®ç°äº†ï¼Œåœ¨log matchingéƒ¨åˆ†æœ‰è¯¦ç»†ä»‹ç»ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœ<code>leader</code>è¢«é€‰ä¸¾åæ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚å‘¢ï¼Œè®ºæ–‡ä¸­æœ‰æåˆ°ï¼Œåœ¨ä»»æœŸå¼€å§‹çš„æ—¶å€™å‘ç«‹å³å°è¯•å¤åˆ¶ã€æäº¤ä¸€æ¡ç©ºçš„logã€‚</p>
<p>å› æ­¤ï¼Œåœ¨ä¸Šå›¾ä¸­ï¼Œä¸ä¼šå‡ºç°ï¼ˆCï¼‰æ—¶åˆ»çš„æƒ…å†µï¼Œå³term4ä»»æœŸçš„<code>leader</code> s1ä¸ä¼šå¤åˆ¶term2çš„æ—¥å¿—åˆ°s3ã€‚è€Œæ˜¯å¦‚åŒ(e)æè¿°çš„æƒ…å†µï¼Œé€šè¿‡å¤åˆ¶-æäº¤term4çš„æ—¥å¿—é¡ºä¾¿æäº¤term2çš„æ—¥å¿—ã€‚å¦‚æœterm4çš„æ—¥å¿—æäº¤æˆåŠŸï¼Œé‚£ä¹ˆterm2çš„æ—¥å¿—ä¹Ÿä¸€å®šæäº¤æˆåŠŸï¼Œæ­¤æ—¶å³ä½¿s1 crashï¼Œs5ä¹Ÿä¸ä¼šé‡æ–°å½“é€‰ã€‚</p>
<h1 id="å‚è€ƒ-é¸£è°¢"><a href="#å‚è€ƒ-é¸£è°¢" class="headerlink" title="å‚è€ƒ&amp;é¸£è°¢"></a>å‚è€ƒ&amp;é¸£è°¢</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8e4bbe7e276c">å…±è¯†ç®—æ³•ï¼šRaft</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xybaby/p/10124083.html">ä¸€æ–‡ææ‡‚Raftç®—æ³•</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32052223">Raftç®—æ³•è¯¦è§£</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.itpub.net/31556438/viewspace-2637112/">10åˆ†é’Ÿå¼„æ‡‚Raftç®—æ³•</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">åš</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">122</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">åš</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
